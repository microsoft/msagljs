(()=>{var m_=Object.create;var y0=Object.defineProperty;var b_=Object.getOwnPropertyDescriptor;var P_=Object.getOwnPropertyNames;var y_=Object.getPrototypeOf,S_=Object.prototype.hasOwnProperty;var pn=(s,e)=>()=>(e||s((e={exports:{}}).exports,e),e.exports),E_=(s,e)=>{for(var t in e)y0(s,t,{get:e[t],enumerable:!0})},x_=(s,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of P_(e))!S_.call(s,n)&&n!==t&&y0(s,n,{get:()=>e[n],enumerable:!(i=b_(e,n))||i.enumerable});return s};var Ae=(s,e,t)=>(t=s!=null?m_(y_(s)):{},x_(e||!s||!s.__esModule?y0(t,"default",{value:s,enumerable:!0}):t,s));var x0=pn(Qp=>{"use strict";Object.defineProperty(Qp,"__esModule",{value:!0});var E0=class{constructor(...e){this._head=this._tail=null,this._length=0,e.length>0&&e.forEach(t=>{this.append(t)})}*iterator(){let e=this._head;for(;e;)yield e.value,e=e.next}[Symbol.iterator](){return this.iterator()}get head(){return this._head?this._head.value:null}get tail(){return this._tail?this._tail.value:null}get length(){return this._length}insert(e,t,i=!1){if(i&&this.isDuplicate(e))return!1;let n=new Cc(e),o=this._head;if(o)for(;;){if(o.value===t)return n.next=o.next,n.prev=o,o.next=n,n.next?n.next.prev=n:this._tail=n,this._length++,!0;if(o.next)o=o.next;else return!1}else return!1}append(e,t=!1){if(t&&this.isDuplicate(e))return!1;let i=new Cc(e);return this._tail?(this._tail.next=i,i.prev=this._tail,this._tail=i):this._head=this._tail=i,this._length++,!0}prepend(e,t=!1){if(t&&this.isDuplicate(e))return!1;let i=new Cc(e);return this._head?(i.next=this._head,this._head.prev=i,this._head=i):this._head=this._tail=i,this._length++,!0}remove(e){let t=this._head;if(!!t){if(t.value===e)return this._head=t.next,this._head.prev=null,t.next=t.prev=null,this._length--,t.value;for(;;){if(t.value===e)return t.next?(t.prev.next=t.next,t.next.prev=t.prev,t.next=t.prev=null):(t.prev.next=null,this._tail=t.prev,t.next=t.prev=null),this._length--,t.value;if(t.next)t=t.next;else return}}}removeHead(){let e=this._head;if(!!e)return this._head.next?(this._head.next.prev=null,this._head=this._head.next,e.next=e.prev=null):(this._head=null,this._tail=null),this._length--,e.value}removeTail(){let e=this._tail;if(!!e)return this._tail.prev?(this._tail.prev.next=null,this._tail=this._tail.prev,e.next=e.prev=null):(this._head=null,this._tail=null),this._length--,e.value}first(e){let t=this.iterator(),i=[],n=Math.min(e,this.length);for(let o=0;o<n;o++){let a=t.next();i.push(a.value)}return i}toArray(){return[...this]}isDuplicate(e){return new Set(this.toArray()).has(e)}};Qp.LinkedList=E0;var Cc=class{constructor(e){this.value=e,this.next=null,this.prev=null}};Qp.LinkedListItem=Cc});var yn=pn(C0=>{"use strict";Object.defineProperty(C0,"__esModule",{value:!0});var __=x0(),v0=class extends __.LinkedList{constructor(...e){super(...e)}get top(){return this.head}get size(){return this.length}push(e){this.prepend(e)}pop(){return this.removeHead()}};C0.Stack=v0});var zn=pn(L0=>{"use strict";Object.defineProperty(L0,"__esModule",{value:!0});var D_=x0(),w0=class extends D_.LinkedList{constructor(...e){super(...e)}get front(){return this.head}enqueue(e){this.append(e)}dequeue(){return this.removeHead()}};L0.Queue=w0});var sr=pn(ga=>{"use strict";var sm=ga&&ga.__spreadArrays||function(){for(var s=0,e=0,t=arguments.length;e<t;e++)s+=arguments[e].length;for(var i=Array(s),n=0,e=0;e<t;e++)for(var o=arguments[e],a=0,l=o.length;a<l;a++,n++)i[n]=o[a];return i};Object.defineProperty(ga,"__esModule",{value:!0});ga.StringBuilder=ga.String=void 0;var wc=function(){function s(){}return s.IsNullOrWhiteSpace=function(e){try{return e==null||e=="undefined"?!0:e.toString().replace(/\s/g,"").length<1}catch(t){return console.log(t),!1}},s.Join=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];try{var n=t[0];if(Array.isArray(n)||n instanceof Array){for(var o=s.Empty,a=0,l=0;l<n.length;l++){var u=n[l];l<n.length-1?o+=u+e:o+=u}return o}else if(typeof n=="object"){var c=s.Empty,h=n,d=Object.keys(n);return d.forEach(function(p){c+=h[p]+e}),c=c.slice(0,c.length-e.length),c}var f=t;return s.join.apply(s,sm([e],f))}catch(p){return console.log(p),s.Empty}},s.Format=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];try{return e.match(s.regexNumber)?s.format(s.regexNumber,e,t):e.match(s.regexObject)?s.format(s.regexObject,e,t,!0):e}catch(n){return console.log(n),s.Empty}},s.format=function(e,t,i,n){return n===void 0&&(n=!1),t.replace(e,function(o,a){var l=o.split(":");l.length>1&&(a=l[0].replace("{",""),o=l[1].replace("}",""));var u;return n?u=i[0][a]:u=i[a],u==null||u==null||o.match(/{\d+}/)?u:(u=s.parsePattern(o,u),typeof u<"u"&&u!=null?u:s.Empty)})},s.parsePattern=function(e,t){switch(e){case"L":return t=t.toLocaleLowerCase(),t;case"U":return t=t.toLocaleUpperCase(),t;case"d":{if(typeof t=="string")return s.getDisplayDateFromString(t);if(t instanceof Date)return s.Format("{0:00}.{1:00}.{2:0000}",t.getDate(),t.getMonth(),t.getFullYear());break}case"s":{if(typeof t=="string")return s.getSortableDateFromString(t);if(t instanceof Date)return s.Format("{0:0000}-{1:00}-{2:00}",t.getFullYear(),t.getMonth(),t.getDate());break}case"n":{typeof t!="string"&&(t=t.toString());var i=t.replace(/,/g,".");if(isNaN(parseFloat(i))||i.length<=3)break;var n=i.split(/[^0-9]+/g),o=n;n.length>1&&(o=[s.join.apply(s,sm([""],n.splice(0,n.length-1))),n[n.length-1]]);var a=o[0],l=a.length%3,u=l>0?a.substring(0,l):s.Empty,c=u,h=a.substring(l).match(/.{3}/g);return u=u+"."+s.Join(".",h),t=u+(o.length>1?","+o[1]:""),t}case"x":return this.decimalToHexString(t);case"X":return this.decimalToHexString(t,!0);default:break}return(typeof t=="number"||!isNaN(t))&&!isNaN(+e)&&!s.IsNullOrWhiteSpace(t)?s.formatNumber(t,e):t},s.decimalToHexString=function(e,t){t===void 0&&(t=!1);var i=parseFloat(e),n=i.toString(16);return t?n.toLocaleUpperCase():n},s.getDisplayDateFromString=function(e){var t;if(t=e.split("-"),t.length<=1)return e;var i=t[t.length-1],n=t[t.length-2],o=t[t.length-3];return i=i.split("T")[0],i=i.split(" ")[0],i+"."+n+"."+o},s.getSortableDateFromString=function(e){var t=e.replace(",","").split(".");if(t.length<=1)return e;var i=t[t.length-1].split(" "),n=s.Empty;i.length>1&&(n=i[i.length-1]);var o=t[t.length-1].split(" ")[0],a=t[t.length-2],l=t[t.length-3],u=o+"-"+a+"-"+l;return!s.IsNullOrWhiteSpace(n)&&n.length>1?u+="T"+n:u+="T00:00:00",u},s.formatNumber=function(e,t){var i=t.length,n=e.toString();if(i<=n.length)return n;var o=i-n.length;return o+=1,new Array(o).join("0")+n},s.join=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];for(var n=s.Empty,o=0;o<t.length;o++)if(!(typeof t[o]=="string"&&s.IsNullOrWhiteSpace(t[o])||typeof t[o]!="number"&&typeof t[o]!="string")){var a=""+t[o];n+=a;for(var l=o+1;l<t.length;l++)if(!s.IsNullOrWhiteSpace(t[l])){n+=e,o=l-1;break}}return n},s.regexNumber=/{(\d+(:\w*)?)}/g,s.regexObject=/{(\w+(:\w*)?)}/g,s.Empty="",s}();ga.String=wc;var V_=function(){function s(e){this.Values=[],wc.IsNullOrWhiteSpace(e)||(this.Values=new Array(e))}return s.prototype.ToString=function(){return this.Values.join("")},s.prototype.Append=function(e){this.Values.push(e)},s.prototype.AppendLine=function(e){this.Values.push(`\r
`+e)},s.prototype.AppendFormat=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];this.Values.push(wc.Format.apply(wc,sm([e],t)))},s.prototype.AppendLineFormat=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];this.Values.push(`\r
`+wc.Format.apply(wc,sm([e],t)))},s.prototype.Clear=function(){this.Values=[]},s}();ga.StringBuilder=V_});var qA=pn((ipe,jA)=>{"use strict";function uM(s,e){function t(){this.constructor=s}t.prototype=e.prototype,s.prototype=new t}function gu(s,e,t,i){this.message=s,this.expected=e,this.found=t,this.location=i,this.name="SyntaxError",typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(this,gu)}uM(gu,Error);gu.buildMessage=function(s,e){var t={literal:function(c){return'"'+n(c.text)+'"'},class:function(c){var h="",d;for(d=0;d<c.parts.length;d++)h+=c.parts[d]instanceof Array?o(c.parts[d][0])+"-"+o(c.parts[d][1]):o(c.parts[d]);return"["+(c.inverted?"^":"")+h+"]"},any:function(c){return"any character"},end:function(c){return"end of input"},other:function(c){return c.description}};function i(c){return c.charCodeAt(0).toString(16).toUpperCase()}function n(c){return c.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(h){return"\\x0"+i(h)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(h){return"\\x"+i(h)})}function o(c){return c.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(h){return"\\x0"+i(h)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(h){return"\\x"+i(h)})}function a(c){return t[c.type](c)}function l(c){var h=new Array(c.length),d,f;for(d=0;d<c.length;d++)h[d]=a(c[d]);if(h.sort(),h.length>0){for(d=1,f=1;d<h.length;d++)h[d-1]!==h[d]&&(h[f]=h[d],f++);h.length=f}switch(h.length){case 1:return h[0];case 2:return h[0]+" or "+h[1];default:return h.slice(0,-1).join(", ")+", or "+h[h.length-1]}}function u(c){return c?'"'+n(c)+'"':"end of input"}return"Expected "+l(s)+" but "+u(e)+" found."};function cM(s,e){e=e!==void 0?e:{};var t={},i={start:Zv},n=Zv,o="strict",a=we("strict",!0),l="graph",u=we("graph",!0),c="digraph",h=we("digraph",!0),d="{",f=we("{",!1),p="}",S=we("}",!1),E=function(P,T,F,G){G===null&&(G=[]);var q={type:T.toLowerCase(),children:G};return P&&(q.strict=!0),F&&(q.id=F),q},C=";",O=we(";",!1),B=function(P,T){return T},A=function(P,T){return[P].concat(T)},N="=",z=we("=",!1),Y=function(P,T){return{type:"attr_stmt",target:"graph",attr_list:[{type:"attr",id:P,eq:T}]}},ie="node",he=we("node",!0),ae="edge",D=we("edge",!0),_=function(P,T){return{type:"attr_stmt",target:P,attr_list:T}},W="[",H=we("[",!1),ee="]",oe=we("]",!1),ce=function(P,T){return(P||[]).concat(T||[])},Ee=function(P,T){return T},Oe=",",nt=we(",",!1),ui=function(P,T,F){return[{type:"attr",id:P,eq:T}].concat(F||[])},zr=function(P,T,F){var G=[P];return G=G.concat(T.map(function(q){return q.id})),{type:"edge_stmt",edge_list:G,attr_list:F||[]}},Tp="->",dd=we("->",!1),Ip="--",Xy=we("--",!1),Rr=function(P,T,F){return[{type:"edgeRHS",edgeop:P,id:T}].concat(F||[])},cs=function(P,T){return{type:"node_stmt",node_id:P,attr_list:T||[]}},_t=function(P,T){return T?{type:"node_id",id:P,port:T}:{type:"node_id",id:P}},Wr=vo("port"),na=":",hs=we(":",!1),Rl=function(P,T){return T},Ol=function(P,T){return{type:"port",id:P,compass_pt:T||null}},_l=function(P){return{type:"port",compass_pt:P||null}},hn="subgraph",ds=we("subgraph",!0),wp=function(P){return P?{type:"subgraph",id:P}:{type:"subgraph"}},Lp=function(P,T){return P=P||{type:"subgraph"},P.children=T||[],P},dc="n",xi=we("n",!1),Rp="ne",Yy=we("ne",!1),Ky="e",Zy=we("e",!1),Op="se",_p=we("se",!1),Np="s",Mp=we("s",!1),fd="sw",fc=we("sw",!1),gd="w",Qy=we("w",!1),Bp="nw",Jy=we("nw",!1),$y=vo("UNICODE_STRING"),e0=function(P,T){return P+T.join("")},gc=function(P,T){return P+T},t0="$",r0=we("$",!1),Dp="_",Gp=we("_",!1),pd=vo("NUMBER"),i0="-",n0=we("-",!1),Fp=".",md=we(".",!1),oa=/^[0-9]/,sa=Ui([["0","9"]],!1,!1),o0=function(P){return parseFloat(Xv())},pc=function(P){return{type:"id",value:P.slice(1,P.length-1),html:!0}},bd="<",Pd=we("<",!1),mc=">",Nl=we(">",!1),s0=function(P){return"<"+P.join("")+">"},Fi=H2(),aa=function(P){return P},kp=function(P){return P.join("")},bc='"',Pc=we('"',!1),yd=function(P){return P.join("")},Sd=function(){return Xv()},dn="\\",So=we("\\",!1),Ml=function(P){return P[1]==='"'?'"':P[0]+P[1]},Bl=function(){return""},Ed=/^[\n\r\u2028\u2029]/,a0=Ui([`
`,"\r","\u2028","\u2029"],!1,!1),l0=vo("end of line"),yc=`
`,vi=we(`
`,!1),fs=`\r
`,Eo=we(`\r
`,!1),Fn="\r",Dl=we("\r",!1),fn="\u2028",kn=we("\u2028",!1),Vp="\u2029",Up=we("\u2029",!1),Sc=/^[^"\\\0-\x1F\x7F]/,ki=Ui(['"',"\\",["\0",""],"\x7F"],!0,!1),Gl='\\"',xd=we('\\"',!1),vd=function(){return'"'},Cd=function(){return"\\"},Ad=vo("COMMENT"),Ec=vo("BLOCK_COMMENT"),gn="/*",u0=we("/*",!1),gs="*/",Fl=we("*/",!1),Td=function(P){return P},c0=function(P){return P.join("")},h0=vo("C_COMMENT"),v="//",w=we("//",!1),M=/^[\n]/,V=Ui([`
`],!1,!1),$=function(P){return P.join("")},le=vo("MACRO_COMMENT"),Be="#",Yt=we("#",!1),ir=vo("WHITESPACE"),mr=/^[\n\r]/,Vi=Ui([`
`,"\r"],!1,!1),jv=/^[ \t]/,qv=Ui([" ","	"],!1,!1),R2=/^[a-z\xB5\xDF-\xF6\xF8-\xFF\u0101\u0103\u0105\u0107\u0109\u010B\u010D\u010F\u0111\u0113\u0115\u0117\u0119\u011B\u011D\u011F\u0121\u0123\u0125\u0127\u0129\u012B\u012D\u012F\u0131\u0133\u0135\u0137-\u0138\u013A\u013C\u013E\u0140\u0142\u0144\u0146\u0148-\u0149\u014B\u014D\u014F\u0151\u0153\u0155\u0157\u0159\u015B\u015D\u015F\u0161\u0163\u0165\u0167\u0169\u016B\u016D\u016F\u0171\u0173\u0175\u0177\u017A\u017C\u017E-\u0180\u0183\u0185\u0188\u018C-\u018D\u0192\u0195\u0199-\u019B\u019E\u01A1\u01A3\u01A5\u01A8\u01AA-\u01AB\u01AD\u01B0\u01B4\u01B6\u01B9-\u01BA\u01BD-\u01BF\u01C6\u01C9\u01CC\u01CE\u01D0\u01D2\u01D4\u01D6\u01D8\u01DA\u01DC-\u01DD\u01DF\u01E1\u01E3\u01E5\u01E7\u01E9\u01EB\u01ED\u01EF-\u01F0\u01F3\u01F5\u01F9\u01FB\u01FD\u01FF\u0201\u0203\u0205\u0207\u0209\u020B\u020D\u020F\u0211\u0213\u0215\u0217\u0219\u021B\u021D\u021F\u0221\u0223\u0225\u0227\u0229\u022B\u022D\u022F\u0231\u0233-\u0239\u023C\u023F-\u0240\u0242\u0247\u0249\u024B\u024D\u024F-\u0293\u0295-\u02AF\u0371\u0373\u0377\u037B-\u037D\u0390\u03AC-\u03CE\u03D0-\u03D1\u03D5-\u03D7\u03D9\u03DB\u03DD\u03DF\u03E1\u03E3\u03E5\u03E7\u03E9\u03EB\u03ED\u03EF-\u03F3\u03F5\u03F8\u03FB-\u03FC\u0430-\u045F\u0461\u0463\u0465\u0467\u0469\u046B\u046D\u046F\u0471\u0473\u0475\u0477\u0479\u047B\u047D\u047F\u0481\u048B\u048D\u048F\u0491\u0493\u0495\u0497\u0499\u049B\u049D\u049F\u04A1\u04A3\u04A5\u04A7\u04A9\u04AB\u04AD\u04AF\u04B1\u04B3\u04B5\u04B7\u04B9\u04BB\u04BD\u04BF\u04C2\u04C4\u04C6\u04C8\u04CA\u04CC\u04CE-\u04CF\u04D1\u04D3\u04D5\u04D7\u04D9\u04DB\u04DD\u04DF\u04E1\u04E3\u04E5\u04E7\u04E9\u04EB\u04ED\u04EF\u04F1\u04F3\u04F5\u04F7\u04F9\u04FB\u04FD\u04FF\u0501\u0503\u0505\u0507\u0509\u050B\u050D\u050F\u0511\u0513\u0515\u0517\u0519\u051B\u051D\u051F\u0521\u0523\u0525\u0527\u0561-\u0587\u1D00-\u1D2B\u1D6B-\u1D77\u1D79-\u1D9A\u1E01\u1E03\u1E05\u1E07\u1E09\u1E0B\u1E0D\u1E0F\u1E11\u1E13\u1E15\u1E17\u1E19\u1E1B\u1E1D\u1E1F\u1E21\u1E23\u1E25\u1E27\u1E29\u1E2B\u1E2D\u1E2F\u1E31\u1E33\u1E35\u1E37\u1E39\u1E3B\u1E3D\u1E3F\u1E41\u1E43\u1E45\u1E47\u1E49\u1E4B\u1E4D\u1E4F\u1E51\u1E53\u1E55\u1E57\u1E59\u1E5B\u1E5D\u1E5F\u1E61\u1E63\u1E65\u1E67\u1E69\u1E6B\u1E6D\u1E6F\u1E71\u1E73\u1E75\u1E77\u1E79\u1E7B\u1E7D\u1E7F\u1E81\u1E83\u1E85\u1E87\u1E89\u1E8B\u1E8D\u1E8F\u1E91\u1E93\u1E95-\u1E9D\u1E9F\u1EA1\u1EA3\u1EA5\u1EA7\u1EA9\u1EAB\u1EAD\u1EAF\u1EB1\u1EB3\u1EB5\u1EB7\u1EB9\u1EBB\u1EBD\u1EBF\u1EC1\u1EC3\u1EC5\u1EC7\u1EC9\u1ECB\u1ECD\u1ECF\u1ED1\u1ED3\u1ED5\u1ED7\u1ED9\u1EDB\u1EDD\u1EDF\u1EE1\u1EE3\u1EE5\u1EE7\u1EE9\u1EEB\u1EED\u1EEF\u1EF1\u1EF3\u1EF5\u1EF7\u1EF9\u1EFB\u1EFD\u1EFF-\u1F07\u1F10-\u1F15\u1F20-\u1F27\u1F30-\u1F37\u1F40-\u1F45\u1F50-\u1F57\u1F60-\u1F67\u1F70-\u1F7D\u1F80-\u1F87\u1F90-\u1F97\u1FA0-\u1FA7\u1FB0-\u1FB4\u1FB6-\u1FB7\u1FBE\u1FC2-\u1FC4\u1FC6-\u1FC7\u1FD0-\u1FD3\u1FD6-\u1FD7\u1FE0-\u1FE7\u1FF2-\u1FF4\u1FF6-\u1FF7\u210A\u210E-\u210F\u2113\u212F\u2134\u2139\u213C-\u213D\u2146-\u2149\u214E\u2184\u2C30-\u2C5E\u2C61\u2C65-\u2C66\u2C68\u2C6A\u2C6C\u2C71\u2C73-\u2C74\u2C76-\u2C7B\u2C81\u2C83\u2C85\u2C87\u2C89\u2C8B\u2C8D\u2C8F\u2C91\u2C93\u2C95\u2C97\u2C99\u2C9B\u2C9D\u2C9F\u2CA1\u2CA3\u2CA5\u2CA7\u2CA9\u2CAB\u2CAD\u2CAF\u2CB1\u2CB3\u2CB5\u2CB7\u2CB9\u2CBB\u2CBD\u2CBF\u2CC1\u2CC3\u2CC5\u2CC7\u2CC9\u2CCB\u2CCD\u2CCF\u2CD1\u2CD3\u2CD5\u2CD7\u2CD9\u2CDB\u2CDD\u2CDF\u2CE1\u2CE3-\u2CE4\u2CEC\u2CEE\u2CF3\u2D00-\u2D25\u2D27\u2D2D\uA641\uA643\uA645\uA647\uA649\uA64B\uA64D\uA64F\uA651\uA653\uA655\uA657\uA659\uA65B\uA65D\uA65F\uA661\uA663\uA665\uA667\uA669\uA66B\uA66D\uA681\uA683\uA685\uA687\uA689\uA68B\uA68D\uA68F\uA691\uA693\uA695\uA697\uA723\uA725\uA727\uA729\uA72B\uA72D\uA72F-\uA731\uA733\uA735\uA737\uA739\uA73B\uA73D\uA73F\uA741\uA743\uA745\uA747\uA749\uA74B\uA74D\uA74F\uA751\uA753\uA755\uA757\uA759\uA75B\uA75D\uA75F\uA761\uA763\uA765\uA767\uA769\uA76B\uA76D\uA76F\uA771-\uA778\uA77A\uA77C\uA77F\uA781\uA783\uA785\uA787\uA78C\uA78E\uA791\uA793\uA7A1\uA7A3\uA7A5\uA7A7\uA7A9\uA7FA\uFB00-\uFB06\uFB13-\uFB17\uFF41-\uFF5A]/,O2=Ui([["a","z"],"\xB5",["\xDF","\xF6"],["\xF8","\xFF"],"\u0101","\u0103","\u0105","\u0107","\u0109","\u010B","\u010D","\u010F","\u0111","\u0113","\u0115","\u0117","\u0119","\u011B","\u011D","\u011F","\u0121","\u0123","\u0125","\u0127","\u0129","\u012B","\u012D","\u012F","\u0131","\u0133","\u0135",["\u0137","\u0138"],"\u013A","\u013C","\u013E","\u0140","\u0142","\u0144","\u0146",["\u0148","\u0149"],"\u014B","\u014D","\u014F","\u0151","\u0153","\u0155","\u0157","\u0159","\u015B","\u015D","\u015F","\u0161","\u0163","\u0165","\u0167","\u0169","\u016B","\u016D","\u016F","\u0171","\u0173","\u0175","\u0177","\u017A","\u017C",["\u017E","\u0180"],"\u0183","\u0185","\u0188",["\u018C","\u018D"],"\u0192","\u0195",["\u0199","\u019B"],"\u019E","\u01A1","\u01A3","\u01A5","\u01A8",["\u01AA","\u01AB"],"\u01AD","\u01B0","\u01B4","\u01B6",["\u01B9","\u01BA"],["\u01BD","\u01BF"],"\u01C6","\u01C9","\u01CC","\u01CE","\u01D0","\u01D2","\u01D4","\u01D6","\u01D8","\u01DA",["\u01DC","\u01DD"],"\u01DF","\u01E1","\u01E3","\u01E5","\u01E7","\u01E9","\u01EB","\u01ED",["\u01EF","\u01F0"],"\u01F3","\u01F5","\u01F9","\u01FB","\u01FD","\u01FF","\u0201","\u0203","\u0205","\u0207","\u0209","\u020B","\u020D","\u020F","\u0211","\u0213","\u0215","\u0217","\u0219","\u021B","\u021D","\u021F","\u0221","\u0223","\u0225","\u0227","\u0229","\u022B","\u022D","\u022F","\u0231",["\u0233","\u0239"],"\u023C",["\u023F","\u0240"],"\u0242","\u0247","\u0249","\u024B","\u024D",["\u024F","\u0293"],["\u0295","\u02AF"],"\u0371","\u0373","\u0377",["\u037B","\u037D"],"\u0390",["\u03AC","\u03CE"],["\u03D0","\u03D1"],["\u03D5","\u03D7"],"\u03D9","\u03DB","\u03DD","\u03DF","\u03E1","\u03E3","\u03E5","\u03E7","\u03E9","\u03EB","\u03ED",["\u03EF","\u03F3"],"\u03F5","\u03F8",["\u03FB","\u03FC"],["\u0430","\u045F"],"\u0461","\u0463","\u0465","\u0467","\u0469","\u046B","\u046D","\u046F","\u0471","\u0473","\u0475","\u0477","\u0479","\u047B","\u047D","\u047F","\u0481","\u048B","\u048D","\u048F","\u0491","\u0493","\u0495","\u0497","\u0499","\u049B","\u049D","\u049F","\u04A1","\u04A3","\u04A5","\u04A7","\u04A9","\u04AB","\u04AD","\u04AF","\u04B1","\u04B3","\u04B5","\u04B7","\u04B9","\u04BB","\u04BD","\u04BF","\u04C2","\u04C4","\u04C6","\u04C8","\u04CA","\u04CC",["\u04CE","\u04CF"],"\u04D1","\u04D3","\u04D5","\u04D7","\u04D9","\u04DB","\u04DD","\u04DF","\u04E1","\u04E3","\u04E5","\u04E7","\u04E9","\u04EB","\u04ED","\u04EF","\u04F1","\u04F3","\u04F5","\u04F7","\u04F9","\u04FB","\u04FD","\u04FF","\u0501","\u0503","\u0505","\u0507","\u0509","\u050B","\u050D","\u050F","\u0511","\u0513","\u0515","\u0517","\u0519","\u051B","\u051D","\u051F","\u0521","\u0523","\u0525","\u0527",["\u0561","\u0587"],["\u1D00","\u1D2B"],["\u1D6B","\u1D77"],["\u1D79","\u1D9A"],"\u1E01","\u1E03","\u1E05","\u1E07","\u1E09","\u1E0B","\u1E0D","\u1E0F","\u1E11","\u1E13","\u1E15","\u1E17","\u1E19","\u1E1B","\u1E1D","\u1E1F","\u1E21","\u1E23","\u1E25","\u1E27","\u1E29","\u1E2B","\u1E2D","\u1E2F","\u1E31","\u1E33","\u1E35","\u1E37","\u1E39","\u1E3B","\u1E3D","\u1E3F","\u1E41","\u1E43","\u1E45","\u1E47","\u1E49","\u1E4B","\u1E4D","\u1E4F","\u1E51","\u1E53","\u1E55","\u1E57","\u1E59","\u1E5B","\u1E5D","\u1E5F","\u1E61","\u1E63","\u1E65","\u1E67","\u1E69","\u1E6B","\u1E6D","\u1E6F","\u1E71","\u1E73","\u1E75","\u1E77","\u1E79","\u1E7B","\u1E7D","\u1E7F","\u1E81","\u1E83","\u1E85","\u1E87","\u1E89","\u1E8B","\u1E8D","\u1E8F","\u1E91","\u1E93",["\u1E95","\u1E9D"],"\u1E9F","\u1EA1","\u1EA3","\u1EA5","\u1EA7","\u1EA9","\u1EAB","\u1EAD","\u1EAF","\u1EB1","\u1EB3","\u1EB5","\u1EB7","\u1EB9","\u1EBB","\u1EBD","\u1EBF","\u1EC1","\u1EC3","\u1EC5","\u1EC7","\u1EC9","\u1ECB","\u1ECD","\u1ECF","\u1ED1","\u1ED3","\u1ED5","\u1ED7","\u1ED9","\u1EDB","\u1EDD","\u1EDF","\u1EE1","\u1EE3","\u1EE5","\u1EE7","\u1EE9","\u1EEB","\u1EED","\u1EEF","\u1EF1","\u1EF3","\u1EF5","\u1EF7","\u1EF9","\u1EFB","\u1EFD",["\u1EFF","\u1F07"],["\u1F10","\u1F15"],["\u1F20","\u1F27"],["\u1F30","\u1F37"],["\u1F40","\u1F45"],["\u1F50","\u1F57"],["\u1F60","\u1F67"],["\u1F70","\u1F7D"],["\u1F80","\u1F87"],["\u1F90","\u1F97"],["\u1FA0","\u1FA7"],["\u1FB0","\u1FB4"],["\u1FB6","\u1FB7"],"\u1FBE",["\u1FC2","\u1FC4"],["\u1FC6","\u1FC7"],["\u1FD0","\u1FD3"],["\u1FD6","\u1FD7"],["\u1FE0","\u1FE7"],["\u1FF2","\u1FF4"],["\u1FF6","\u1FF7"],"\u210A",["\u210E","\u210F"],"\u2113","\u212F","\u2134","\u2139",["\u213C","\u213D"],["\u2146","\u2149"],"\u214E","\u2184",["\u2C30","\u2C5E"],"\u2C61",["\u2C65","\u2C66"],"\u2C68","\u2C6A","\u2C6C","\u2C71",["\u2C73","\u2C74"],["\u2C76","\u2C7B"],"\u2C81","\u2C83","\u2C85","\u2C87","\u2C89","\u2C8B","\u2C8D","\u2C8F","\u2C91","\u2C93","\u2C95","\u2C97","\u2C99","\u2C9B","\u2C9D","\u2C9F","\u2CA1","\u2CA3","\u2CA5","\u2CA7","\u2CA9","\u2CAB","\u2CAD","\u2CAF","\u2CB1","\u2CB3","\u2CB5","\u2CB7","\u2CB9","\u2CBB","\u2CBD","\u2CBF","\u2CC1","\u2CC3","\u2CC5","\u2CC7","\u2CC9","\u2CCB","\u2CCD","\u2CCF","\u2CD1","\u2CD3","\u2CD5","\u2CD7","\u2CD9","\u2CDB","\u2CDD","\u2CDF","\u2CE1",["\u2CE3","\u2CE4"],"\u2CEC","\u2CEE","\u2CF3",["\u2D00","\u2D25"],"\u2D27","\u2D2D","\uA641","\uA643","\uA645","\uA647","\uA649","\uA64B","\uA64D","\uA64F","\uA651","\uA653","\uA655","\uA657","\uA659","\uA65B","\uA65D","\uA65F","\uA661","\uA663","\uA665","\uA667","\uA669","\uA66B","\uA66D","\uA681","\uA683","\uA685","\uA687","\uA689","\uA68B","\uA68D","\uA68F","\uA691","\uA693","\uA695","\uA697","\uA723","\uA725","\uA727","\uA729","\uA72B","\uA72D",["\uA72F","\uA731"],"\uA733","\uA735","\uA737","\uA739","\uA73B","\uA73D","\uA73F","\uA741","\uA743","\uA745","\uA747","\uA749","\uA74B","\uA74D","\uA74F","\uA751","\uA753","\uA755","\uA757","\uA759","\uA75B","\uA75D","\uA75F","\uA761","\uA763","\uA765","\uA767","\uA769","\uA76B","\uA76D","\uA76F",["\uA771","\uA778"],"\uA77A","\uA77C","\uA77F","\uA781","\uA783","\uA785","\uA787","\uA78C","\uA78E","\uA791","\uA793","\uA7A1","\uA7A3","\uA7A5","\uA7A7","\uA7A9","\uA7FA",["\uFB00","\uFB06"],["\uFB13","\uFB17"],["\uFF41","\uFF5A"]],!1,!1),_2=/^[\u02B0-\u02C1\u02C6-\u02D1\u02E0-\u02E4\u02EC\u02EE\u0374\u037A\u0559\u0640\u06E5-\u06E6\u07F4-\u07F5\u07FA\u081A\u0824\u0828\u0971\u0E46\u0EC6\u10FC\u17D7\u1843\u1AA7\u1C78-\u1C7D\u1D2C-\u1D6A\u1D78\u1D9B-\u1DBF\u2071\u207F\u2090-\u209C\u2C7C-\u2C7D\u2D6F\u2E2F\u3005\u3031-\u3035\u303B\u309D-\u309E\u30FC-\u30FE\uA015\uA4F8-\uA4FD\uA60C\uA67F\uA717-\uA71F\uA770\uA788\uA7F8-\uA7F9\uA9CF\uAA70\uAADD\uAAF3-\uAAF4\uFF70\uFF9E-\uFF9F]/,N2=Ui([["\u02B0","\u02C1"],["\u02C6","\u02D1"],["\u02E0","\u02E4"],"\u02EC","\u02EE","\u0374","\u037A","\u0559","\u0640",["\u06E5","\u06E6"],["\u07F4","\u07F5"],"\u07FA","\u081A","\u0824","\u0828","\u0971","\u0E46","\u0EC6","\u10FC","\u17D7","\u1843","\u1AA7",["\u1C78","\u1C7D"],["\u1D2C","\u1D6A"],"\u1D78",["\u1D9B","\u1DBF"],"\u2071","\u207F",["\u2090","\u209C"],["\u2C7C","\u2C7D"],"\u2D6F","\u2E2F","\u3005",["\u3031","\u3035"],"\u303B",["\u309D","\u309E"],["\u30FC","\u30FE"],"\uA015",["\uA4F8","\uA4FD"],"\uA60C","\uA67F",["\uA717","\uA71F"],"\uA770","\uA788",["\uA7F8","\uA7F9"],"\uA9CF","\uAA70","\uAADD",["\uAAF3","\uAAF4"],"\uFF70",["\uFF9E","\uFF9F"]],!1,!1),M2=/^[\xAA\xBA\u01BB\u01C0-\u01C3\u0294\u05D0-\u05EA\u05F0-\u05F2\u0620-\u063F\u0641-\u064A\u066E-\u066F\u0671-\u06D3\u06D5\u06EE-\u06EF\u06FA-\u06FC\u06FF\u0710\u0712-\u072F\u074D-\u07A5\u07B1\u07CA-\u07EA\u0800-\u0815\u0840-\u0858\u08A0\u08A2-\u08AC\u0904-\u0939\u093D\u0950\u0958-\u0961\u0972-\u0977\u0979-\u097F\u0985-\u098C\u098F-\u0990\u0993-\u09A8\u09AA-\u09B0\u09B2\u09B6-\u09B9\u09BD\u09CE\u09DC-\u09DD\u09DF-\u09E1\u09F0-\u09F1\u0A05-\u0A0A\u0A0F-\u0A10\u0A13-\u0A28\u0A2A-\u0A30\u0A32-\u0A33\u0A35-\u0A36\u0A38-\u0A39\u0A59-\u0A5C\u0A5E\u0A72-\u0A74\u0A85-\u0A8D\u0A8F-\u0A91\u0A93-\u0AA8\u0AAA-\u0AB0\u0AB2-\u0AB3\u0AB5-\u0AB9\u0ABD\u0AD0\u0AE0-\u0AE1\u0B05-\u0B0C\u0B0F-\u0B10\u0B13-\u0B28\u0B2A-\u0B30\u0B32-\u0B33\u0B35-\u0B39\u0B3D\u0B5C-\u0B5D\u0B5F-\u0B61\u0B71\u0B83\u0B85-\u0B8A\u0B8E-\u0B90\u0B92-\u0B95\u0B99-\u0B9A\u0B9C\u0B9E-\u0B9F\u0BA3-\u0BA4\u0BA8-\u0BAA\u0BAE-\u0BB9\u0BD0\u0C05-\u0C0C\u0C0E-\u0C10\u0C12-\u0C28\u0C2A-\u0C33\u0C35-\u0C39\u0C3D\u0C58-\u0C59\u0C60-\u0C61\u0C85-\u0C8C\u0C8E-\u0C90\u0C92-\u0CA8\u0CAA-\u0CB3\u0CB5-\u0CB9\u0CBD\u0CDE\u0CE0-\u0CE1\u0CF1-\u0CF2\u0D05-\u0D0C\u0D0E-\u0D10\u0D12-\u0D3A\u0D3D\u0D4E\u0D60-\u0D61\u0D7A-\u0D7F\u0D85-\u0D96\u0D9A-\u0DB1\u0DB3-\u0DBB\u0DBD\u0DC0-\u0DC6\u0E01-\u0E30\u0E32-\u0E33\u0E40-\u0E45\u0E81-\u0E82\u0E84\u0E87-\u0E88\u0E8A\u0E8D\u0E94-\u0E97\u0E99-\u0E9F\u0EA1-\u0EA3\u0EA5\u0EA7\u0EAA-\u0EAB\u0EAD-\u0EB0\u0EB2-\u0EB3\u0EBD\u0EC0-\u0EC4\u0EDC-\u0EDF\u0F00\u0F40-\u0F47\u0F49-\u0F6C\u0F88-\u0F8C\u1000-\u102A\u103F\u1050-\u1055\u105A-\u105D\u1061\u1065-\u1066\u106E-\u1070\u1075-\u1081\u108E\u10D0-\u10FA\u10FD-\u1248\u124A-\u124D\u1250-\u1256\u1258\u125A-\u125D\u1260-\u1288\u128A-\u128D\u1290-\u12B0\u12B2-\u12B5\u12B8-\u12BE\u12C0\u12C2-\u12C5\u12C8-\u12D6\u12D8-\u1310\u1312-\u1315\u1318-\u135A\u1380-\u138F\u13A0-\u13F4\u1401-\u166C\u166F-\u167F\u1681-\u169A\u16A0-\u16EA\u1700-\u170C\u170E-\u1711\u1720-\u1731\u1740-\u1751\u1760-\u176C\u176E-\u1770\u1780-\u17B3\u17DC\u1820-\u1842\u1844-\u1877\u1880-\u18A8\u18AA\u18B0-\u18F5\u1900-\u191C\u1950-\u196D\u1970-\u1974\u1980-\u19AB\u19C1-\u19C7\u1A00-\u1A16\u1A20-\u1A54\u1B05-\u1B33\u1B45-\u1B4B\u1B83-\u1BA0\u1BAE-\u1BAF\u1BBA-\u1BE5\u1C00-\u1C23\u1C4D-\u1C4F\u1C5A-\u1C77\u1CE9-\u1CEC\u1CEE-\u1CF1\u1CF5-\u1CF6\u2135-\u2138\u2D30-\u2D67\u2D80-\u2D96\u2DA0-\u2DA6\u2DA8-\u2DAE\u2DB0-\u2DB6\u2DB8-\u2DBE\u2DC0-\u2DC6\u2DC8-\u2DCE\u2DD0-\u2DD6\u2DD8-\u2DDE\u3006\u303C\u3041-\u3096\u309F\u30A1-\u30FA\u30FF\u3105-\u312D\u3131-\u318E\u31A0-\u31BA\u31F0-\u31FF\u3400-\u4DB5\u4E00-\u9FCC\uA000-\uA014\uA016-\uA48C\uA4D0-\uA4F7\uA500-\uA60B\uA610-\uA61F\uA62A-\uA62B\uA66E\uA6A0-\uA6E5\uA7FB-\uA801\uA803-\uA805\uA807-\uA80A\uA80C-\uA822\uA840-\uA873\uA882-\uA8B3\uA8F2-\uA8F7\uA8FB\uA90A-\uA925\uA930-\uA946\uA960-\uA97C\uA984-\uA9B2\uAA00-\uAA28\uAA40-\uAA42\uAA44-\uAA4B\uAA60-\uAA6F\uAA71-\uAA76\uAA7A\uAA80-\uAAAF\uAAB1\uAAB5-\uAAB6\uAAB9-\uAABD\uAAC0\uAAC2\uAADB-\uAADC\uAAE0-\uAAEA\uAAF2\uAB01-\uAB06\uAB09-\uAB0E\uAB11-\uAB16\uAB20-\uAB26\uAB28-\uAB2E\uABC0-\uABE2\uAC00-\uD7A3\uD7B0-\uD7C6\uD7CB-\uD7FB\uF900-\uFA6D\uFA70-\uFAD9\uFB1D\uFB1F-\uFB28\uFB2A-\uFB36\uFB38-\uFB3C\uFB3E\uFB40-\uFB41\uFB43-\uFB44\uFB46-\uFBB1\uFBD3-\uFD3D\uFD50-\uFD8F\uFD92-\uFDC7\uFDF0-\uFDFB\uFE70-\uFE74\uFE76-\uFEFC\uFF66-\uFF6F\uFF71-\uFF9D\uFFA0-\uFFBE\uFFC2-\uFFC7\uFFCA-\uFFCF\uFFD2-\uFFD7\uFFDA-\uFFDC]/,B2=Ui(["\xAA","\xBA","\u01BB",["\u01C0","\u01C3"],"\u0294",["\u05D0","\u05EA"],["\u05F0","\u05F2"],["\u0620","\u063F"],["\u0641","\u064A"],["\u066E","\u066F"],["\u0671","\u06D3"],"\u06D5",["\u06EE","\u06EF"],["\u06FA","\u06FC"],"\u06FF","\u0710",["\u0712","\u072F"],["\u074D","\u07A5"],"\u07B1",["\u07CA","\u07EA"],["\u0800","\u0815"],["\u0840","\u0858"],"\u08A0",["\u08A2","\u08AC"],["\u0904","\u0939"],"\u093D","\u0950",["\u0958","\u0961"],["\u0972","\u0977"],["\u0979","\u097F"],["\u0985","\u098C"],["\u098F","\u0990"],["\u0993","\u09A8"],["\u09AA","\u09B0"],"\u09B2",["\u09B6","\u09B9"],"\u09BD","\u09CE",["\u09DC","\u09DD"],["\u09DF","\u09E1"],["\u09F0","\u09F1"],["\u0A05","\u0A0A"],["\u0A0F","\u0A10"],["\u0A13","\u0A28"],["\u0A2A","\u0A30"],["\u0A32","\u0A33"],["\u0A35","\u0A36"],["\u0A38","\u0A39"],["\u0A59","\u0A5C"],"\u0A5E",["\u0A72","\u0A74"],["\u0A85","\u0A8D"],["\u0A8F","\u0A91"],["\u0A93","\u0AA8"],["\u0AAA","\u0AB0"],["\u0AB2","\u0AB3"],["\u0AB5","\u0AB9"],"\u0ABD","\u0AD0",["\u0AE0","\u0AE1"],["\u0B05","\u0B0C"],["\u0B0F","\u0B10"],["\u0B13","\u0B28"],["\u0B2A","\u0B30"],["\u0B32","\u0B33"],["\u0B35","\u0B39"],"\u0B3D",["\u0B5C","\u0B5D"],["\u0B5F","\u0B61"],"\u0B71","\u0B83",["\u0B85","\u0B8A"],["\u0B8E","\u0B90"],["\u0B92","\u0B95"],["\u0B99","\u0B9A"],"\u0B9C",["\u0B9E","\u0B9F"],["\u0BA3","\u0BA4"],["\u0BA8","\u0BAA"],["\u0BAE","\u0BB9"],"\u0BD0",["\u0C05","\u0C0C"],["\u0C0E","\u0C10"],["\u0C12","\u0C28"],["\u0C2A","\u0C33"],["\u0C35","\u0C39"],"\u0C3D",["\u0C58","\u0C59"],["\u0C60","\u0C61"],["\u0C85","\u0C8C"],["\u0C8E","\u0C90"],["\u0C92","\u0CA8"],["\u0CAA","\u0CB3"],["\u0CB5","\u0CB9"],"\u0CBD","\u0CDE",["\u0CE0","\u0CE1"],["\u0CF1","\u0CF2"],["\u0D05","\u0D0C"],["\u0D0E","\u0D10"],["\u0D12","\u0D3A"],"\u0D3D","\u0D4E",["\u0D60","\u0D61"],["\u0D7A","\u0D7F"],["\u0D85","\u0D96"],["\u0D9A","\u0DB1"],["\u0DB3","\u0DBB"],"\u0DBD",["\u0DC0","\u0DC6"],["\u0E01","\u0E30"],["\u0E32","\u0E33"],["\u0E40","\u0E45"],["\u0E81","\u0E82"],"\u0E84",["\u0E87","\u0E88"],"\u0E8A","\u0E8D",["\u0E94","\u0E97"],["\u0E99","\u0E9F"],["\u0EA1","\u0EA3"],"\u0EA5","\u0EA7",["\u0EAA","\u0EAB"],["\u0EAD","\u0EB0"],["\u0EB2","\u0EB3"],"\u0EBD",["\u0EC0","\u0EC4"],["\u0EDC","\u0EDF"],"\u0F00",["\u0F40","\u0F47"],["\u0F49","\u0F6C"],["\u0F88","\u0F8C"],["\u1000","\u102A"],"\u103F",["\u1050","\u1055"],["\u105A","\u105D"],"\u1061",["\u1065","\u1066"],["\u106E","\u1070"],["\u1075","\u1081"],"\u108E",["\u10D0","\u10FA"],["\u10FD","\u1248"],["\u124A","\u124D"],["\u1250","\u1256"],"\u1258",["\u125A","\u125D"],["\u1260","\u1288"],["\u128A","\u128D"],["\u1290","\u12B0"],["\u12B2","\u12B5"],["\u12B8","\u12BE"],"\u12C0",["\u12C2","\u12C5"],["\u12C8","\u12D6"],["\u12D8","\u1310"],["\u1312","\u1315"],["\u1318","\u135A"],["\u1380","\u138F"],["\u13A0","\u13F4"],["\u1401","\u166C"],["\u166F","\u167F"],["\u1681","\u169A"],["\u16A0","\u16EA"],["\u1700","\u170C"],["\u170E","\u1711"],["\u1720","\u1731"],["\u1740","\u1751"],["\u1760","\u176C"],["\u176E","\u1770"],["\u1780","\u17B3"],"\u17DC",["\u1820","\u1842"],["\u1844","\u1877"],["\u1880","\u18A8"],"\u18AA",["\u18B0","\u18F5"],["\u1900","\u191C"],["\u1950","\u196D"],["\u1970","\u1974"],["\u1980","\u19AB"],["\u19C1","\u19C7"],["\u1A00","\u1A16"],["\u1A20","\u1A54"],["\u1B05","\u1B33"],["\u1B45","\u1B4B"],["\u1B83","\u1BA0"],["\u1BAE","\u1BAF"],["\u1BBA","\u1BE5"],["\u1C00","\u1C23"],["\u1C4D","\u1C4F"],["\u1C5A","\u1C77"],["\u1CE9","\u1CEC"],["\u1CEE","\u1CF1"],["\u1CF5","\u1CF6"],["\u2135","\u2138"],["\u2D30","\u2D67"],["\u2D80","\u2D96"],["\u2DA0","\u2DA6"],["\u2DA8","\u2DAE"],["\u2DB0","\u2DB6"],["\u2DB8","\u2DBE"],["\u2DC0","\u2DC6"],["\u2DC8","\u2DCE"],["\u2DD0","\u2DD6"],["\u2DD8","\u2DDE"],"\u3006","\u303C",["\u3041","\u3096"],"\u309F",["\u30A1","\u30FA"],"\u30FF",["\u3105","\u312D"],["\u3131","\u318E"],["\u31A0","\u31BA"],["\u31F0","\u31FF"],["\u3400","\u4DB5"],["\u4E00","\u9FCC"],["\uA000","\uA014"],["\uA016","\uA48C"],["\uA4D0","\uA4F7"],["\uA500","\uA60B"],["\uA610","\uA61F"],["\uA62A","\uA62B"],"\uA66E",["\uA6A0","\uA6E5"],["\uA7FB","\uA801"],["\uA803","\uA805"],["\uA807","\uA80A"],["\uA80C","\uA822"],["\uA840","\uA873"],["\uA882","\uA8B3"],["\uA8F2","\uA8F7"],"\uA8FB",["\uA90A","\uA925"],["\uA930","\uA946"],["\uA960","\uA97C"],["\uA984","\uA9B2"],["\uAA00","\uAA28"],["\uAA40","\uAA42"],["\uAA44","\uAA4B"],["\uAA60","\uAA6F"],["\uAA71","\uAA76"],"\uAA7A",["\uAA80","\uAAAF"],"\uAAB1",["\uAAB5","\uAAB6"],["\uAAB9","\uAABD"],"\uAAC0","\uAAC2",["\uAADB","\uAADC"],["\uAAE0","\uAAEA"],"\uAAF2",["\uAB01","\uAB06"],["\uAB09","\uAB0E"],["\uAB11","\uAB16"],["\uAB20","\uAB26"],["\uAB28","\uAB2E"],["\uABC0","\uABE2"],["\uAC00","\uD7A3"],["\uD7B0","\uD7C6"],["\uD7CB","\uD7FB"],["\uF900","\uFA6D"],["\uFA70","\uFAD9"],"\uFB1D",["\uFB1F","\uFB28"],["\uFB2A","\uFB36"],["\uFB38","\uFB3C"],"\uFB3E",["\uFB40","\uFB41"],["\uFB43","\uFB44"],["\uFB46","\uFBB1"],["\uFBD3","\uFD3D"],["\uFD50","\uFD8F"],["\uFD92","\uFDC7"],["\uFDF0","\uFDFB"],["\uFE70","\uFE74"],["\uFE76","\uFEFC"],["\uFF66","\uFF6F"],["\uFF71","\uFF9D"],["\uFFA0","\uFFBE"],["\uFFC2","\uFFC7"],["\uFFCA","\uFFCF"],["\uFFD2","\uFFD7"],["\uFFDA","\uFFDC"]],!1,!1),D2=/^[\u01C5\u01C8\u01CB\u01F2\u1F88-\u1F8F\u1F98-\u1F9F\u1FA8-\u1FAF\u1FBC\u1FCC\u1FFC]/,G2=Ui(["\u01C5","\u01C8","\u01CB","\u01F2",["\u1F88","\u1F8F"],["\u1F98","\u1F9F"],["\u1FA8","\u1FAF"],"\u1FBC","\u1FCC","\u1FFC"],!1,!1),F2=/^[A-Z\xC0-\xD6\xD8-\xDE\u0100\u0102\u0104\u0106\u0108\u010A\u010C\u010E\u0110\u0112\u0114\u0116\u0118\u011A\u011C\u011E\u0120\u0122\u0124\u0126\u0128\u012A\u012C\u012E\u0130\u0132\u0134\u0136\u0139\u013B\u013D\u013F\u0141\u0143\u0145\u0147\u014A\u014C\u014E\u0150\u0152\u0154\u0156\u0158\u015A\u015C\u015E\u0160\u0162\u0164\u0166\u0168\u016A\u016C\u016E\u0170\u0172\u0174\u0176\u0178-\u0179\u017B\u017D\u0181-\u0182\u0184\u0186-\u0187\u0189-\u018B\u018E-\u0191\u0193-\u0194\u0196-\u0198\u019C-\u019D\u019F-\u01A0\u01A2\u01A4\u01A6-\u01A7\u01A9\u01AC\u01AE-\u01AF\u01B1-\u01B3\u01B5\u01B7-\u01B8\u01BC\u01C4\u01C7\u01CA\u01CD\u01CF\u01D1\u01D3\u01D5\u01D7\u01D9\u01DB\u01DE\u01E0\u01E2\u01E4\u01E6\u01E8\u01EA\u01EC\u01EE\u01F1\u01F4\u01F6-\u01F8\u01FA\u01FC\u01FE\u0200\u0202\u0204\u0206\u0208\u020A\u020C\u020E\u0210\u0212\u0214\u0216\u0218\u021A\u021C\u021E\u0220\u0222\u0224\u0226\u0228\u022A\u022C\u022E\u0230\u0232\u023A-\u023B\u023D-\u023E\u0241\u0243-\u0246\u0248\u024A\u024C\u024E\u0370\u0372\u0376\u0386\u0388-\u038A\u038C\u038E-\u038F\u0391-\u03A1\u03A3-\u03AB\u03CF\u03D2-\u03D4\u03D8\u03DA\u03DC\u03DE\u03E0\u03E2\u03E4\u03E6\u03E8\u03EA\u03EC\u03EE\u03F4\u03F7\u03F9-\u03FA\u03FD-\u042F\u0460\u0462\u0464\u0466\u0468\u046A\u046C\u046E\u0470\u0472\u0474\u0476\u0478\u047A\u047C\u047E\u0480\u048A\u048C\u048E\u0490\u0492\u0494\u0496\u0498\u049A\u049C\u049E\u04A0\u04A2\u04A4\u04A6\u04A8\u04AA\u04AC\u04AE\u04B0\u04B2\u04B4\u04B6\u04B8\u04BA\u04BC\u04BE\u04C0-\u04C1\u04C3\u04C5\u04C7\u04C9\u04CB\u04CD\u04D0\u04D2\u04D4\u04D6\u04D8\u04DA\u04DC\u04DE\u04E0\u04E2\u04E4\u04E6\u04E8\u04EA\u04EC\u04EE\u04F0\u04F2\u04F4\u04F6\u04F8\u04FA\u04FC\u04FE\u0500\u0502\u0504\u0506\u0508\u050A\u050C\u050E\u0510\u0512\u0514\u0516\u0518\u051A\u051C\u051E\u0520\u0522\u0524\u0526\u0531-\u0556\u10A0-\u10C5\u10C7\u10CD\u1E00\u1E02\u1E04\u1E06\u1E08\u1E0A\u1E0C\u1E0E\u1E10\u1E12\u1E14\u1E16\u1E18\u1E1A\u1E1C\u1E1E\u1E20\u1E22\u1E24\u1E26\u1E28\u1E2A\u1E2C\u1E2E\u1E30\u1E32\u1E34\u1E36\u1E38\u1E3A\u1E3C\u1E3E\u1E40\u1E42\u1E44\u1E46\u1E48\u1E4A\u1E4C\u1E4E\u1E50\u1E52\u1E54\u1E56\u1E58\u1E5A\u1E5C\u1E5E\u1E60\u1E62\u1E64\u1E66\u1E68\u1E6A\u1E6C\u1E6E\u1E70\u1E72\u1E74\u1E76\u1E78\u1E7A\u1E7C\u1E7E\u1E80\u1E82\u1E84\u1E86\u1E88\u1E8A\u1E8C\u1E8E\u1E90\u1E92\u1E94\u1E9E\u1EA0\u1EA2\u1EA4\u1EA6\u1EA8\u1EAA\u1EAC\u1EAE\u1EB0\u1EB2\u1EB4\u1EB6\u1EB8\u1EBA\u1EBC\u1EBE\u1EC0\u1EC2\u1EC4\u1EC6\u1EC8\u1ECA\u1ECC\u1ECE\u1ED0\u1ED2\u1ED4\u1ED6\u1ED8\u1EDA\u1EDC\u1EDE\u1EE0\u1EE2\u1EE4\u1EE6\u1EE8\u1EEA\u1EEC\u1EEE\u1EF0\u1EF2\u1EF4\u1EF6\u1EF8\u1EFA\u1EFC\u1EFE\u1F08-\u1F0F\u1F18-\u1F1D\u1F28-\u1F2F\u1F38-\u1F3F\u1F48-\u1F4D\u1F59\u1F5B\u1F5D\u1F5F\u1F68-\u1F6F\u1FB8-\u1FBB\u1FC8-\u1FCB\u1FD8-\u1FDB\u1FE8-\u1FEC\u1FF8-\u1FFB\u2102\u2107\u210B-\u210D\u2110-\u2112\u2115\u2119-\u211D\u2124\u2126\u2128\u212A-\u212D\u2130-\u2133\u213E-\u213F\u2145\u2183\u2C00-\u2C2E\u2C60\u2C62-\u2C64\u2C67\u2C69\u2C6B\u2C6D-\u2C70\u2C72\u2C75\u2C7E-\u2C80\u2C82\u2C84\u2C86\u2C88\u2C8A\u2C8C\u2C8E\u2C90\u2C92\u2C94\u2C96\u2C98\u2C9A\u2C9C\u2C9E\u2CA0\u2CA2\u2CA4\u2CA6\u2CA8\u2CAA\u2CAC\u2CAE\u2CB0\u2CB2\u2CB4\u2CB6\u2CB8\u2CBA\u2CBC\u2CBE\u2CC0\u2CC2\u2CC4\u2CC6\u2CC8\u2CCA\u2CCC\u2CCE\u2CD0\u2CD2\u2CD4\u2CD6\u2CD8\u2CDA\u2CDC\u2CDE\u2CE0\u2CE2\u2CEB\u2CED\u2CF2\uA640\uA642\uA644\uA646\uA648\uA64A\uA64C\uA64E\uA650\uA652\uA654\uA656\uA658\uA65A\uA65C\uA65E\uA660\uA662\uA664\uA666\uA668\uA66A\uA66C\uA680\uA682\uA684\uA686\uA688\uA68A\uA68C\uA68E\uA690\uA692\uA694\uA696\uA722\uA724\uA726\uA728\uA72A\uA72C\uA72E\uA732\uA734\uA736\uA738\uA73A\uA73C\uA73E\uA740\uA742\uA744\uA746\uA748\uA74A\uA74C\uA74E\uA750\uA752\uA754\uA756\uA758\uA75A\uA75C\uA75E\uA760\uA762\uA764\uA766\uA768\uA76A\uA76C\uA76E\uA779\uA77B\uA77D-\uA77E\uA780\uA782\uA784\uA786\uA78B\uA78D\uA790\uA792\uA7A0\uA7A2\uA7A4\uA7A6\uA7A8\uA7AA\uFF21-\uFF3A]/,k2=Ui([["A","Z"],["\xC0","\xD6"],["\xD8","\xDE"],"\u0100","\u0102","\u0104","\u0106","\u0108","\u010A","\u010C","\u010E","\u0110","\u0112","\u0114","\u0116","\u0118","\u011A","\u011C","\u011E","\u0120","\u0122","\u0124","\u0126","\u0128","\u012A","\u012C","\u012E","\u0130","\u0132","\u0134","\u0136","\u0139","\u013B","\u013D","\u013F","\u0141","\u0143","\u0145","\u0147","\u014A","\u014C","\u014E","\u0150","\u0152","\u0154","\u0156","\u0158","\u015A","\u015C","\u015E","\u0160","\u0162","\u0164","\u0166","\u0168","\u016A","\u016C","\u016E","\u0170","\u0172","\u0174","\u0176",["\u0178","\u0179"],"\u017B","\u017D",["\u0181","\u0182"],"\u0184",["\u0186","\u0187"],["\u0189","\u018B"],["\u018E","\u0191"],["\u0193","\u0194"],["\u0196","\u0198"],["\u019C","\u019D"],["\u019F","\u01A0"],"\u01A2","\u01A4",["\u01A6","\u01A7"],"\u01A9","\u01AC",["\u01AE","\u01AF"],["\u01B1","\u01B3"],"\u01B5",["\u01B7","\u01B8"],"\u01BC","\u01C4","\u01C7","\u01CA","\u01CD","\u01CF","\u01D1","\u01D3","\u01D5","\u01D7","\u01D9","\u01DB","\u01DE","\u01E0","\u01E2","\u01E4","\u01E6","\u01E8","\u01EA","\u01EC","\u01EE","\u01F1","\u01F4",["\u01F6","\u01F8"],"\u01FA","\u01FC","\u01FE","\u0200","\u0202","\u0204","\u0206","\u0208","\u020A","\u020C","\u020E","\u0210","\u0212","\u0214","\u0216","\u0218","\u021A","\u021C","\u021E","\u0220","\u0222","\u0224","\u0226","\u0228","\u022A","\u022C","\u022E","\u0230","\u0232",["\u023A","\u023B"],["\u023D","\u023E"],"\u0241",["\u0243","\u0246"],"\u0248","\u024A","\u024C","\u024E","\u0370","\u0372","\u0376","\u0386",["\u0388","\u038A"],"\u038C",["\u038E","\u038F"],["\u0391","\u03A1"],["\u03A3","\u03AB"],"\u03CF",["\u03D2","\u03D4"],"\u03D8","\u03DA","\u03DC","\u03DE","\u03E0","\u03E2","\u03E4","\u03E6","\u03E8","\u03EA","\u03EC","\u03EE","\u03F4","\u03F7",["\u03F9","\u03FA"],["\u03FD","\u042F"],"\u0460","\u0462","\u0464","\u0466","\u0468","\u046A","\u046C","\u046E","\u0470","\u0472","\u0474","\u0476","\u0478","\u047A","\u047C","\u047E","\u0480","\u048A","\u048C","\u048E","\u0490","\u0492","\u0494","\u0496","\u0498","\u049A","\u049C","\u049E","\u04A0","\u04A2","\u04A4","\u04A6","\u04A8","\u04AA","\u04AC","\u04AE","\u04B0","\u04B2","\u04B4","\u04B6","\u04B8","\u04BA","\u04BC","\u04BE",["\u04C0","\u04C1"],"\u04C3","\u04C5","\u04C7","\u04C9","\u04CB","\u04CD","\u04D0","\u04D2","\u04D4","\u04D6","\u04D8","\u04DA","\u04DC","\u04DE","\u04E0","\u04E2","\u04E4","\u04E6","\u04E8","\u04EA","\u04EC","\u04EE","\u04F0","\u04F2","\u04F4","\u04F6","\u04F8","\u04FA","\u04FC","\u04FE","\u0500","\u0502","\u0504","\u0506","\u0508","\u050A","\u050C","\u050E","\u0510","\u0512","\u0514","\u0516","\u0518","\u051A","\u051C","\u051E","\u0520","\u0522","\u0524","\u0526",["\u0531","\u0556"],["\u10A0","\u10C5"],"\u10C7","\u10CD","\u1E00","\u1E02","\u1E04","\u1E06","\u1E08","\u1E0A","\u1E0C","\u1E0E","\u1E10","\u1E12","\u1E14","\u1E16","\u1E18","\u1E1A","\u1E1C","\u1E1E","\u1E20","\u1E22","\u1E24","\u1E26","\u1E28","\u1E2A","\u1E2C","\u1E2E","\u1E30","\u1E32","\u1E34","\u1E36","\u1E38","\u1E3A","\u1E3C","\u1E3E","\u1E40","\u1E42","\u1E44","\u1E46","\u1E48","\u1E4A","\u1E4C","\u1E4E","\u1E50","\u1E52","\u1E54","\u1E56","\u1E58","\u1E5A","\u1E5C","\u1E5E","\u1E60","\u1E62","\u1E64","\u1E66","\u1E68","\u1E6A","\u1E6C","\u1E6E","\u1E70","\u1E72","\u1E74","\u1E76","\u1E78","\u1E7A","\u1E7C","\u1E7E","\u1E80","\u1E82","\u1E84","\u1E86","\u1E88","\u1E8A","\u1E8C","\u1E8E","\u1E90","\u1E92","\u1E94","\u1E9E","\u1EA0","\u1EA2","\u1EA4","\u1EA6","\u1EA8","\u1EAA","\u1EAC","\u1EAE","\u1EB0","\u1EB2","\u1EB4","\u1EB6","\u1EB8","\u1EBA","\u1EBC","\u1EBE","\u1EC0","\u1EC2","\u1EC4","\u1EC6","\u1EC8","\u1ECA","\u1ECC","\u1ECE","\u1ED0","\u1ED2","\u1ED4","\u1ED6","\u1ED8","\u1EDA","\u1EDC","\u1EDE","\u1EE0","\u1EE2","\u1EE4","\u1EE6","\u1EE8","\u1EEA","\u1EEC","\u1EEE","\u1EF0","\u1EF2","\u1EF4","\u1EF6","\u1EF8","\u1EFA","\u1EFC","\u1EFE",["\u1F08","\u1F0F"],["\u1F18","\u1F1D"],["\u1F28","\u1F2F"],["\u1F38","\u1F3F"],["\u1F48","\u1F4D"],"\u1F59","\u1F5B","\u1F5D","\u1F5F",["\u1F68","\u1F6F"],["\u1FB8","\u1FBB"],["\u1FC8","\u1FCB"],["\u1FD8","\u1FDB"],["\u1FE8","\u1FEC"],["\u1FF8","\u1FFB"],"\u2102","\u2107",["\u210B","\u210D"],["\u2110","\u2112"],"\u2115",["\u2119","\u211D"],"\u2124","\u2126","\u2128",["\u212A","\u212D"],["\u2130","\u2133"],["\u213E","\u213F"],"\u2145","\u2183",["\u2C00","\u2C2E"],"\u2C60",["\u2C62","\u2C64"],"\u2C67","\u2C69","\u2C6B",["\u2C6D","\u2C70"],"\u2C72","\u2C75",["\u2C7E","\u2C80"],"\u2C82","\u2C84","\u2C86","\u2C88","\u2C8A","\u2C8C","\u2C8E","\u2C90","\u2C92","\u2C94","\u2C96","\u2C98","\u2C9A","\u2C9C","\u2C9E","\u2CA0","\u2CA2","\u2CA4","\u2CA6","\u2CA8","\u2CAA","\u2CAC","\u2CAE","\u2CB0","\u2CB2","\u2CB4","\u2CB6","\u2CB8","\u2CBA","\u2CBC","\u2CBE","\u2CC0","\u2CC2","\u2CC4","\u2CC6","\u2CC8","\u2CCA","\u2CCC","\u2CCE","\u2CD0","\u2CD2","\u2CD4","\u2CD6","\u2CD8","\u2CDA","\u2CDC","\u2CDE","\u2CE0","\u2CE2","\u2CEB","\u2CED","\u2CF2","\uA640","\uA642","\uA644","\uA646","\uA648","\uA64A","\uA64C","\uA64E","\uA650","\uA652","\uA654","\uA656","\uA658","\uA65A","\uA65C","\uA65E","\uA660","\uA662","\uA664","\uA666","\uA668","\uA66A","\uA66C","\uA680","\uA682","\uA684","\uA686","\uA688","\uA68A","\uA68C","\uA68E","\uA690","\uA692","\uA694","\uA696","\uA722","\uA724","\uA726","\uA728","\uA72A","\uA72C","\uA72E","\uA732","\uA734","\uA736","\uA738","\uA73A","\uA73C","\uA73E","\uA740","\uA742","\uA744","\uA746","\uA748","\uA74A","\uA74C","\uA74E","\uA750","\uA752","\uA754","\uA756","\uA758","\uA75A","\uA75C","\uA75E","\uA760","\uA762","\uA764","\uA766","\uA768","\uA76A","\uA76C","\uA76E","\uA779","\uA77B",["\uA77D","\uA77E"],"\uA780","\uA782","\uA784","\uA786","\uA78B","\uA78D","\uA790","\uA792","\uA7A0","\uA7A2","\uA7A4","\uA7A6","\uA7A8","\uA7AA",["\uFF21","\uFF3A"]],!1,!1),V2=/^[\u16EE-\u16F0\u2160-\u2182\u2185-\u2188\u3007\u3021-\u3029\u3038-\u303A\uA6E6-\uA6EF]/,U2=Ui([["\u16EE","\u16F0"],["\u2160","\u2182"],["\u2185","\u2188"],"\u3007",["\u3021","\u3029"],["\u3038","\u303A"],["\uA6E6","\uA6EF"]],!1,!1),z2=/^[0-9\u0660-\u0669\u06F0-\u06F9\u07C0-\u07C9\u0966-\u096F\u09E6-\u09EF\u0A66-\u0A6F\u0AE6-\u0AEF\u0B66-\u0B6F\u0BE6-\u0BEF\u0C66-\u0C6F\u0CE6-\u0CEF\u0D66-\u0D6F\u0E50-\u0E59\u0ED0-\u0ED9\u0F20-\u0F29\u1040-\u1049\u1090-\u1099\u17E0-\u17E9\u1810-\u1819\u1946-\u194F\u19D0-\u19D9\u1A80-\u1A89\u1A90-\u1A99\u1B50-\u1B59\u1BB0-\u1BB9\u1C40-\u1C49\u1C50-\u1C59\uA620-\uA629\uA8D0-\uA8D9\uA900-\uA909\uA9D0-\uA9D9\uAA50-\uAA59\uABF0-\uABF9\uFF10-\uFF19]/,W2=Ui([["0","9"],["\u0660","\u0669"],["\u06F0","\u06F9"],["\u07C0","\u07C9"],["\u0966","\u096F"],["\u09E6","\u09EF"],["\u0A66","\u0A6F"],["\u0AE6","\u0AEF"],["\u0B66","\u0B6F"],["\u0BE6","\u0BEF"],["\u0C66","\u0C6F"],["\u0CE6","\u0CEF"],["\u0D66","\u0D6F"],["\u0E50","\u0E59"],["\u0ED0","\u0ED9"],["\u0F20","\u0F29"],["\u1040","\u1049"],["\u1090","\u1099"],["\u17E0","\u17E9"],["\u1810","\u1819"],["\u1946","\u194F"],["\u19D0","\u19D9"],["\u1A80","\u1A89"],["\u1A90","\u1A99"],["\u1B50","\u1B59"],["\u1BB0","\u1BB9"],["\u1C40","\u1C49"],["\u1C50","\u1C59"],["\uA620","\uA629"],["\uA8D0","\uA8D9"],["\uA900","\uA909"],["\uA9D0","\uA9D9"],["\uAA50","\uAA59"],["\uABF0","\uABF9"],["\uFF10","\uFF19"]],!1,!1),x=0,Se=0,zp=[{line:1,column:1}],xo=0,d0=[],j=0,Wp;if("startRule"in e){if(!(e.startRule in i))throw new Error(`Can't start parsing from rule "`+e.startRule+'".');n=i[e.startRule]}function Xv(){return s.substring(Se,x)}function _8(){return Id(Se,x)}function N8(P,T){throw T=T!==void 0?T:Id(Se,x),Kv([vo(P)],s.substring(Se,x),T)}function M8(P,T){throw T=T!==void 0?T:Id(Se,x),q2(P,T)}function we(P,T){return{type:"literal",text:P,ignoreCase:T}}function Ui(P,T,F){return{type:"class",parts:P,inverted:T,ignoreCase:F}}function H2(){return{type:"any"}}function j2(){return{type:"end"}}function vo(P){return{type:"other",description:P}}function Yv(P){var T=zp[P],F;if(T)return T;for(F=P-1;!zp[F];)F--;for(T=zp[F],T={line:T.line,column:T.column};F<P;)s.charCodeAt(F)===10?(T.line++,T.column=1):T.column++,F++;return zp[P]=T,T}function Id(P,T){var F=Yv(P),G=Yv(T);return{start:{offset:P,line:F.line,column:F.column},end:{offset:T,line:G.line,column:G.column}}}function Z(P){x<xo||(x>xo&&(xo=x,d0=[]),d0.push(P))}function q2(P,T){return new gu(P,null,null,T)}function Kv(P,T,F){return new gu(gu.buildMessage(P,T),P,T,F)}function Zv(){var P,T;if(P=[],T=Qv(),T!==t)for(;T!==t;)P.push(T),T=Qv();else P=t;return P}function Qv(){var P,T,F,G,q,Q,de,Tt,It,Ao,zi,P0,hC;return P=x,T=at(),T!==t?(s.substr(x,6).toLowerCase()===o?(F=s.substr(x,6),x+=6):(F=t,j===0&&Z(a)),F===t&&(F=null),F!==t?(G=at(),G!==t?(s.substr(x,5).toLowerCase()===l?(q=s.substr(x,5),x+=5):(q=t,j===0&&Z(u)),q===t&&(s.substr(x,7).toLowerCase()===c?(q=s.substr(x,7),x+=7):(q=t,j===0&&Z(h))),q!==t?(Q=at(),Q!==t?(de=Co(),de===t&&(de=null),de!==t?(Tt=at(),Tt!==t?(s.charCodeAt(x)===123?(It=d,x++):(It=t,j===0&&Z(f)),It!==t?(Ao=Jv(),Ao===t&&(Ao=null),Ao!==t?(zi=at(),zi!==t?(s.charCodeAt(x)===125?(P0=p,x++):(P0=t,j===0&&Z(S)),P0!==t?(hC=at(),hC!==t?(Se=P,T=E(F,q,de,Ao),P=T):(x=P,P=t)):(x=P,P=t)):(x=P,P=t)):(x=P,P=t)):(x=P,P=t)):(x=P,P=t)):(x=P,P=t)):(x=P,P=t)):(x=P,P=t)):(x=P,P=t)):(x=P,P=t)):(x=P,P=t),P}function Jv(){var P,T,F,G,q,Q,de,Tt,It,Ao,zi;if(P=x,T=at(),T!==t)if(F=f0(),F!==t)if(G=at(),G!==t)if(s.charCodeAt(x)===59?(q=C,x++):(q=t,j===0&&Z(O)),q===t&&(q=null),q!==t){for(Q=[],de=x,Tt=at(),Tt!==t?(It=f0(),It!==t?(Ao=at(),Ao!==t?(s.charCodeAt(x)===59?(zi=C,x++):(zi=t,j===0&&Z(O)),zi===t&&(zi=null),zi!==t?(Se=de,Tt=B(F,It),de=Tt):(x=de,de=t)):(x=de,de=t)):(x=de,de=t)):(x=de,de=t);de!==t;)Q.push(de),de=x,Tt=at(),Tt!==t?(It=f0(),It!==t?(Ao=at(),Ao!==t?(s.charCodeAt(x)===59?(zi=C,x++):(zi=t,j===0&&Z(O)),zi===t&&(zi=null),zi!==t?(Se=de,Tt=B(F,It),de=Tt):(x=de,de=t)):(x=de,de=t)):(x=de,de=t)):(x=de,de=t);Q!==t?(Se=P,T=A(F,Q),P=T):(x=P,P=t)}else x=P,P=t;else x=P,P=t;else x=P,P=t;else x=P,P=t;return P}function f0(){var P,T,F,G,q,Q;return P=x,T=Co(),T!==t?(F=at(),F!==t?(s.charCodeAt(x)===61?(G=N,x++):(G=t,j===0&&Z(z)),G!==t?(q=at(),q!==t?(Q=Co(),Q!==t?(Se=P,T=Y(T,Q),P=T):(x=P,P=t)):(x=P,P=t)):(x=P,P=t)):(x=P,P=t)):(x=P,P=t),P===t&&(P=X2(),P===t&&(P=Y2(),P===t&&(P=p0(),P===t&&(P=K2(),P===t&&(P=x,T=Co(),T!==t?(s.charCodeAt(x)===61?(F=N,x++):(F=t,j===0&&Z(z)),F!==t?(G=Co(),G!==t?(T=[T,F,G],P=T):(x=P,P=t)):(x=P,P=t)):(x=P,P=t)))))),P}function X2(){var P,T,F;return P=x,s.substr(x,5).toLowerCase()===l?(T=s.substr(x,5),x+=5):(T=t,j===0&&Z(u)),T===t&&(s.substr(x,4).toLowerCase()===ie?(T=s.substr(x,4),x+=4):(T=t,j===0&&Z(he)),T===t&&(s.substr(x,4).toLowerCase()===ae?(T=s.substr(x,4),x+=4):(T=t,j===0&&Z(D)))),T!==t?(F=Hp(),F!==t?(Se=P,T=_(T,F),P=T):(x=P,P=t)):(x=P,P=t),P}function Hp(){var P,T,F,G,q,Q,de,Tt,It;return P=x,T=at(),T!==t?(s.charCodeAt(x)===91?(F=W,x++):(F=t,j===0&&Z(H)),F!==t?(G=at(),G!==t?(q=$v(),q===t&&(q=null),q!==t?(Q=at(),Q!==t?(s.charCodeAt(x)===93?(de=ee,x++):(de=t,j===0&&Z(oe)),de!==t?(Tt=at(),Tt!==t?(It=Hp(),It===t&&(It=null),It!==t?(Se=P,T=ce(q,It),P=T):(x=P,P=t)):(x=P,P=t)):(x=P,P=t)):(x=P,P=t)):(x=P,P=t)):(x=P,P=t)):(x=P,P=t)):(x=P,P=t),P}function $v(){var P,T,F,G,q,Q,de,Tt;return P=x,T=at(),T!==t?(F=Co(),F!==t?(G=x,q=at(),q!==t?(s.charCodeAt(x)===61?(Q=N,x++):(Q=t,j===0&&Z(z)),Q!==t?(de=at(),de!==t?(Tt=Co(),Tt!==t?(Se=G,q=Ee(F,Tt),G=q):(x=G,G=t)):(x=G,G=t)):(x=G,G=t)):(x=G,G=t),G===t&&(G=null),G!==t?(q=at(),q!==t?(s.charCodeAt(x)===44?(Q=Oe,x++):(Q=t,j===0&&Z(nt)),Q===t&&(s.charCodeAt(x)===59?(Q=C,x++):(Q=t,j===0&&Z(O))),Q===t&&(Q=null),Q!==t?(de=$v(),de===t&&(de=null),de!==t?(Se=P,T=ui(F,G,de),P=T):(x=P,P=t)):(x=P,P=t)):(x=P,P=t)):(x=P,P=t)):(x=P,P=t)):(x=P,P=t),P}function Y2(){var P,T,F,G;return P=x,T=p0(),T===t&&(T=g0()),T!==t?(F=eC(),F!==t?(G=Hp(),G===t&&(G=null),G!==t?(Se=P,T=zr(T,F,G),P=T):(x=P,P=t)):(x=P,P=t)):(x=P,P=t),P}function eC(){var P,T,F,G,q,Q,de;return P=x,T=at(),T!==t?(s.substr(x,2)===Tp?(F=Tp,x+=2):(F=t,j===0&&Z(dd)),F===t&&(s.substr(x,2)===Ip?(F=Ip,x+=2):(F=t,j===0&&Z(Xy))),F!==t?(G=at(),G!==t?(q=p0(),q===t&&(q=g0()),q!==t?(Q=at(),Q!==t?(de=eC(),de===t&&(de=null),de!==t?(Se=P,T=Rr(F,q,de),P=T):(x=P,P=t)):(x=P,P=t)):(x=P,P=t)):(x=P,P=t)):(x=P,P=t)):(x=P,P=t),P}function K2(){var P,T,F;return P=x,T=g0(),T!==t?(F=Hp(),F===t&&(F=null),F!==t?(Se=P,T=cs(T,F),P=T):(x=P,P=t)):(x=P,P=t),P}function g0(){var P,T,F;return P=x,T=Co(),T!==t?(F=Z2(),F===t&&(F=null),F!==t?(Se=P,T=_t(T,F),P=T):(x=P,P=t)):(x=P,P=t),P}function Z2(){var P,T,F,G,q,Q;return j++,P=x,s.charCodeAt(x)===58?(T=na,x++):(T=t,j===0&&Z(hs)),T!==t?(F=Co(),F!==t?(G=x,s.charCodeAt(x)===58?(q=na,x++):(q=t,j===0&&Z(hs)),q!==t?(Q=tC(),Q!==t?(Se=G,q=Rl(F,Q),G=q):(x=G,G=t)):(x=G,G=t),G===t&&(G=null),G!==t?(Se=P,T=Ol(F,G),P=T):(x=P,P=t)):(x=P,P=t)):(x=P,P=t),P===t&&(P=x,s.charCodeAt(x)===58?(T=na,x++):(T=t,j===0&&Z(hs)),T!==t?(F=tC(),F!==t?(Se=P,T=_l(F),P=T):(x=P,P=t)):(x=P,P=t)),j--,P===t&&(T=t,j===0&&Z(Wr)),P}function p0(){var P,T,F,G,q,Q;return P=x,T=x,s.substr(x,8).toLowerCase()===hn?(F=s.substr(x,8),x+=8):(F=t,j===0&&Z(ds)),F!==t?(G=at(),G!==t?(q=Co(),q===t&&(q=null),q!==t?(Q=at(),Q!==t?(Se=T,F=wp(q),T=F):(x=T,T=t)):(x=T,T=t)):(x=T,T=t)):(x=T,T=t),T===t&&(T=null),T!==t?(s.charCodeAt(x)===123?(F=d,x++):(F=t,j===0&&Z(f)),F!==t?(G=Jv(),G===t&&(G=null),G!==t?(q=at(),q!==t?(s.charCodeAt(x)===125?(Q=p,x++):(Q=t,j===0&&Z(S)),Q!==t?(Se=P,T=Lp(T,G),P=T):(x=P,P=t)):(x=P,P=t)):(x=P,P=t)):(x=P,P=t)):(x=P,P=t),P}function tC(){var P;return s.charCodeAt(x)===110?(P=dc,x++):(P=t,j===0&&Z(xi)),P===t&&(s.substr(x,2)===Rp?(P=Rp,x+=2):(P=t,j===0&&Z(Yy)),P===t&&(s.charCodeAt(x)===101?(P=Ky,x++):(P=t,j===0&&Z(Zy)),P===t&&(s.substr(x,2)===Op?(P=Op,x+=2):(P=t,j===0&&Z(_p)),P===t&&(s.charCodeAt(x)===115?(P=Np,x++):(P=t,j===0&&Z(Mp)),P===t&&(s.substr(x,2)===fd?(P=fd,x+=2):(P=t,j===0&&Z(fc)),P===t&&(s.charCodeAt(x)===119?(P=gd,x++):(P=t,j===0&&Z(Qy)),P===t&&(s.substr(x,2)===Bp?(P=Bp,x+=2):(P=t,j===0&&Z(Jy))))))))),P}function Co(){var P;return P=rC(),P===t&&(P=Q2(),P===t&&(P=oC(),P===t&&(P=$2(),P===t&&(P=J2())))),P}function rC(){var P,T,F,G;if(j++,P=x,T=iC(),T!==t){for(F=[],G=nC();G!==t;)F.push(G),G=nC();F!==t?(Se=P,T=e0(T,F),P=T):(x=P,P=t)}else x=P,P=t;return j--,P===t&&(T=t,j===0&&Z($y)),P}function Q2(){var P,T,F;return P=x,T=oC(),T!==t?(F=rC(),F!==t?(Se=P,T=gc(T,F),P=T):(x=P,P=t)):(x=P,P=t),P}function iC(){var P;return P=l_(),P===t&&(s.charCodeAt(x)===36?(P=t0,x++):(P=t,j===0&&Z(r0)),P===t&&(s.charCodeAt(x)===95?(P=Dp,x++):(P=t,j===0&&Z(Gp)))),P}function nC(){var P;return P=iC(),P===t&&(P=p_()),P}function oC(){var P,T,F,G,q,Q,de,Tt,It;if(j++,P=x,T=x,s.charCodeAt(x)===45?(F=i0,x++):(F=t,j===0&&Z(n0)),F===t&&(F=null),F!==t){if(G=x,s.charCodeAt(x)===46?(q=Fp,x++):(q=t,j===0&&Z(md)),q!==t){if(Q=[],oa.test(s.charAt(x))?(de=s.charAt(x),x++):(de=t,j===0&&Z(sa)),de!==t)for(;de!==t;)Q.push(de),oa.test(s.charAt(x))?(de=s.charAt(x),x++):(de=t,j===0&&Z(sa));else Q=t;Q!==t?(q=[q,Q],G=q):(x=G,G=t)}else x=G,G=t;if(G===t){if(G=x,q=[],oa.test(s.charAt(x))?(Q=s.charAt(x),x++):(Q=t,j===0&&Z(sa)),Q!==t)for(;Q!==t;)q.push(Q),oa.test(s.charAt(x))?(Q=s.charAt(x),x++):(Q=t,j===0&&Z(sa));else q=t;if(q!==t){if(Q=x,s.charCodeAt(x)===46?(de=Fp,x++):(de=t,j===0&&Z(md)),de!==t){for(Tt=[],oa.test(s.charAt(x))?(It=s.charAt(x),x++):(It=t,j===0&&Z(sa));It!==t;)Tt.push(It),oa.test(s.charAt(x))?(It=s.charAt(x),x++):(It=t,j===0&&Z(sa));Tt!==t?(de=[de,Tt],Q=de):(x=Q,Q=t)}else x=Q,Q=t;Q===t&&(Q=null),Q!==t?(q=[q,Q],G=q):(x=G,G=t)}else x=G,G=t}G!==t?(F=[F,G],T=F):(x=T,T=t)}else x=T,T=t;return T!==t&&(Se=P,T=o0(T)),P=T,j--,P===t&&(T=t,j===0&&Z(pd)),P}function J2(){var P,T;return P=x,T=m0(),T!==t&&(Se=P,T=pc(T)),P=T,P}function m0(){var P,T,F,G;if(P=x,s.charCodeAt(x)===60?(T=bd,x++):(T=t,j===0&&Z(Pd)),T!==t){for(F=[],G=sC(),G===t&&(G=m0());G!==t;)F.push(G),G=sC(),G===t&&(G=m0());F!==t?(s.charCodeAt(x)===62?(G=mc,x++):(G=t,j===0&&Z(Nl)),G!==t?(Se=P,T=s0(F),P=T):(x=P,P=t)):(x=P,P=t)}else x=P,P=t;return P}function sC(){var P,T,F,G,q;if(P=x,T=[],F=x,G=x,j++,s.charCodeAt(x)===62?(q=mc,x++):(q=t,j===0&&Z(Nl)),q===t&&(s.charCodeAt(x)===60?(q=bd,x++):(q=t,j===0&&Z(Pd))),j--,q===t?G=void 0:(x=G,G=t),G!==t?(s.length>x?(q=s.charAt(x),x++):(q=t,j===0&&Z(Fi)),q!==t?(Se=F,G=aa(q),F=G):(x=F,F=t)):(x=F,F=t),F!==t)for(;F!==t;)T.push(F),F=x,G=x,j++,s.charCodeAt(x)===62?(q=mc,x++):(q=t,j===0&&Z(Nl)),q===t&&(s.charCodeAt(x)===60?(q=bd,x++):(q=t,j===0&&Z(Pd))),j--,q===t?G=void 0:(x=G,G=t),G!==t?(s.length>x?(q=s.charAt(x),x++):(q=t,j===0&&Z(Fi)),q!==t?(Se=F,G=aa(q),F=G):(x=F,F=t)):(x=F,F=t);else T=t;return T!==t&&(Se=P,T=kp(T)),P=T,P}function $2(){var P,T,F,G;if(P=x,s.charCodeAt(x)===34?(T=bc,x++):(T=t,j===0&&Z(Pc)),T!==t){for(F=[],G=aC();G!==t;)F.push(G),G=aC();F!==t?(s.charCodeAt(x)===34?(G=bc,x++):(G=t,j===0&&Z(Pc)),G!==t?(Se=P,T=yd(F),P=T):(x=P,P=t)):(x=P,P=t)}else x=P,P=t;return P}function aC(){var P,T,F;return P=e_(),P===t&&(P=x,T=x,j++,s.charCodeAt(x)===34?(F=bc,x++):(F=t,j===0&&Z(Pc)),F===t&&(F=r_()),j--,F===t?T=void 0:(x=T,T=t),T!==t?(F=n_(),F!==t?(Se=P,T=Sd(),P=T):(x=P,P=t)):(x=P,P=t),P===t&&(P=t_())),P}function e_(){var P,T,F,G;return P=x,T=x,s.charCodeAt(x)===92?(F=dn,x++):(F=t,j===0&&Z(So)),F!==t?(s.length>x?(G=s.charAt(x),x++):(G=t,j===0&&Z(Fi)),G!==t?(F=[F,G],T=F):(x=T,T=t)):(x=T,T=t),T!==t&&(Se=P,T=Ml(T)),P=T,P}function t_(){var P,T,F;return P=x,s.charCodeAt(x)===92?(T=dn,x++):(T=t,j===0&&Z(So)),T!==t?(F=i_(),F!==t?(Se=P,T=Bl(),P=T):(x=P,P=t)):(x=P,P=t),P}function r_(){var P;return Ed.test(s.charAt(x))?(P=s.charAt(x),x++):(P=t,j===0&&Z(a0)),P}function i_(){var P,T;return j++,s.charCodeAt(x)===10?(P=yc,x++):(P=t,j===0&&Z(vi)),P===t&&(s.substr(x,2)===fs?(P=fs,x+=2):(P=t,j===0&&Z(Eo)),P===t&&(s.charCodeAt(x)===13?(P=Fn,x++):(P=t,j===0&&Z(Dl)),P===t&&(s.charCodeAt(x)===8232?(P=fn,x++):(P=t,j===0&&Z(kn)),P===t&&(s.charCodeAt(x)===8233?(P=Vp,x++):(P=t,j===0&&Z(Up)))))),j--,P===t&&(T=t,j===0&&Z(l0)),P}function n_(){var P;return s.length>x?(P=s.charAt(x),x++):(P=t,j===0&&Z(Fi)),P}function B8(){var P,T,F;if(P=x,T=[],F=lC(),F!==t)for(;F!==t;)T.push(F),F=lC();else T=t;return T!==t&&(Se=P,T=yd(T)),P=T,P}function lC(){var P,T,F;return Sc.test(s.charAt(x))?(P=s.charAt(x),x++):(P=t,j===0&&Z(ki)),P===t&&(P=x,s.substr(x,2)===Gl?(T=Gl,x+=2):(T=t,j===0&&Z(xd)),T!==t&&(Se=P,T=vd()),P=T,P===t&&(P=x,s.charCodeAt(x)===92?(T=dn,x++):(T=t,j===0&&Z(So)),T!==t?(F=b0(),F!==t?(Se=P,T=Bl(),P=T):(x=P,P=t)):(x=P,P=t),P===t&&(P=x,s.charCodeAt(x)===92?(T=dn,x++):(T=t,j===0&&Z(So)),T!==t&&(Se=P,T=Cd()),P=T))),P}function uC(){var P,T;return j++,P=o_(),P===t&&(P=s_(),P===t&&(P=a_())),j--,P===t&&(T=t,j===0&&Z(Ad)),P}function o_(){var P,T,F,G,q,Q;if(j++,P=x,s.substr(x,2)===gn?(T=gn,x+=2):(T=t,j===0&&Z(u0)),T!==t){for(F=[],G=x,q=x,j++,s.substr(x,2)===gs?(Q=gs,x+=2):(Q=t,j===0&&Z(Fl)),j--,Q===t?q=void 0:(x=q,q=t),q!==t?(s.length>x?(Q=s.charAt(x),x++):(Q=t,j===0&&Z(Fi)),Q!==t?(Se=G,q=Td(Q),G=q):(x=G,G=t)):(x=G,G=t);G!==t;)F.push(G),G=x,q=x,j++,s.substr(x,2)===gs?(Q=gs,x+=2):(Q=t,j===0&&Z(Fl)),j--,Q===t?q=void 0:(x=q,q=t),q!==t?(s.length>x?(Q=s.charAt(x),x++):(Q=t,j===0&&Z(Fi)),Q!==t?(Se=G,q=Td(Q),G=q):(x=G,G=t)):(x=G,G=t);F!==t?(s.substr(x,2)===gs?(G=gs,x+=2):(G=t,j===0&&Z(Fl)),G!==t?(Se=P,T=c0(F),P=T):(x=P,P=t)):(x=P,P=t)}else x=P,P=t;return j--,P===t&&(T=t,j===0&&Z(Ec)),P}function s_(){var P,T,F,G,q,Q;if(j++,P=x,s.substr(x,2)===v?(T=v,x+=2):(T=t,j===0&&Z(w)),T!==t){for(F=[],G=x,q=x,j++,M.test(s.charAt(x))?(Q=s.charAt(x),x++):(Q=t,j===0&&Z(V)),j--,Q===t?q=void 0:(x=q,q=t),q!==t?(s.length>x?(Q=s.charAt(x),x++):(Q=t,j===0&&Z(Fi)),Q!==t?(Se=G,q=aa(Q),G=q):(x=G,G=t)):(x=G,G=t);G!==t;)F.push(G),G=x,q=x,j++,M.test(s.charAt(x))?(Q=s.charAt(x),x++):(Q=t,j===0&&Z(V)),j--,Q===t?q=void 0:(x=q,q=t),q!==t?(s.length>x?(Q=s.charAt(x),x++):(Q=t,j===0&&Z(Fi)),Q!==t?(Se=G,q=aa(Q),G=q):(x=G,G=t)):(x=G,G=t);F!==t?(M.test(s.charAt(x))?(G=s.charAt(x),x++):(G=t,j===0&&Z(V)),G===t&&(G=null),G!==t?(Se=P,T=$(F),P=T):(x=P,P=t)):(x=P,P=t)}else x=P,P=t;return j--,P===t&&(T=t,j===0&&Z(h0)),P}function a_(){var P,T,F,G,q,Q;if(j++,P=x,s.charCodeAt(x)===35?(T=Be,x++):(T=t,j===0&&Z(Yt)),T!==t){for(F=[],G=x,q=x,j++,M.test(s.charAt(x))?(Q=s.charAt(x),x++):(Q=t,j===0&&Z(V)),j--,Q===t?q=void 0:(x=q,q=t),q!==t?(s.length>x?(Q=s.charAt(x),x++):(Q=t,j===0&&Z(Fi)),Q!==t?(Se=G,q=aa(Q),G=q):(x=G,G=t)):(x=G,G=t);G!==t;)F.push(G),G=x,q=x,j++,M.test(s.charAt(x))?(Q=s.charAt(x),x++):(Q=t,j===0&&Z(V)),j--,Q===t?q=void 0:(x=q,q=t),q!==t?(s.length>x?(Q=s.charAt(x),x++):(Q=t,j===0&&Z(Fi)),Q!==t?(Se=G,q=aa(Q),G=q):(x=G,G=t)):(x=G,G=t);F!==t?(M.test(s.charAt(x))?(G=s.charAt(x),x++):(G=t,j===0&&Z(V)),G===t&&(G=null),G!==t?(Se=P,T=$(F),P=T):(x=P,P=t)):(x=P,P=t)}else x=P,P=t;return j--,P===t&&(T=t,j===0&&Z(le)),P}function at(){var P,T;for(j++,P=[],T=cC(),T===t&&(T=uC());T!==t;)P.push(T),T=cC(),T===t&&(T=uC());return j--,P===t&&(T=t,j===0&&Z(ir)),P}function b0(){var P,T;if(P=[],mr.test(s.charAt(x))?(T=s.charAt(x),x++):(T=t,j===0&&Z(Vi)),T!==t)for(;T!==t;)P.push(T),mr.test(s.charAt(x))?(T=s.charAt(x),x++):(T=t,j===0&&Z(Vi));else P=t;return P}function cC(){var P,T;if(P=[],jv.test(s.charAt(x))?(T=s.charAt(x),x++):(T=t,j===0&&Z(qv)),T===t&&(T=b0()),T!==t)for(;T!==t;)P.push(T),jv.test(s.charAt(x))?(T=s.charAt(x),x++):(T=t,j===0&&Z(qv)),T===t&&(T=b0());else P=t;return P}function l_(){var P;return P=f_(),P===t&&(P=u_(),P===t&&(P=d_(),P===t&&(P=c_(),P===t&&(P=h_(),P===t&&(P=g_()))))),P}function u_(){var P;return R2.test(s.charAt(x))?(P=s.charAt(x),x++):(P=t,j===0&&Z(O2)),P}function c_(){var P;return _2.test(s.charAt(x))?(P=s.charAt(x),x++):(P=t,j===0&&Z(N2)),P}function h_(){var P;return M2.test(s.charAt(x))?(P=s.charAt(x),x++):(P=t,j===0&&Z(B2)),P}function d_(){var P;return D2.test(s.charAt(x))?(P=s.charAt(x),x++):(P=t,j===0&&Z(G2)),P}function f_(){var P;return F2.test(s.charAt(x))?(P=s.charAt(x),x++):(P=t,j===0&&Z(k2)),P}function g_(){var P;return V2.test(s.charAt(x))?(P=s.charAt(x),x++):(P=t,j===0&&Z(U2)),P}function p_(){var P;return z2.test(s.charAt(x))?(P=s.charAt(x),x++):(P=t,j===0&&Z(W2)),P}if(Wp=n(),Wp!==t&&x===s.length)return Wp;throw Wp!==t&&x<s.length&&Z(j2()),Kv(d0,xo<s.length?s.charAt(xo):null,xo<s.length?Id(xo,xo+1):Id(xo,xo))}jA.exports={SyntaxError:gu,parse:cM}});var YA=pn((npe,XA)=>{var hM=qA();XA.exports=hM.parse});var e1=pn((gbe,$A)=>{$A.exports={rgb2hsl:Ef,rgb2hsv:Ib,rgb2hwb:xf,rgb2cmyk:vf,rgb2keyword:Cf,rgb2xyz:yS,rgb2lab:SS,rgb2lch:mM,hsl2rgb:wb,hsl2hsv:bM,hsl2hwb:PM,hsl2cmyk:yM,hsl2keyword:SM,hsv2rgb:Lb,hsv2hsl:EM,hsv2hwb:xM,hsv2cmyk:vM,hsv2keyword:CM,hwb2rgb:Af,hwb2hsl:AM,hwb2hsv:TM,hwb2cmyk:IM,hwb2keyword:wM,cmyk2rgb:Tf,cmyk2hsl:LM,cmyk2hsv:RM,cmyk2hwb:OM,cmyk2keyword:_M,keyword2rgb:pu,keyword2hsl:DM,keyword2hsv:GM,keyword2hwb:FM,keyword2cmyk:kM,keyword2lab:VM,keyword2xyz:UM,xyz2rgb:KA,xyz2lab:ZA,xyz2lch:NM,lab2xyz:ES,lab2rgb:QA,lab2lch:xS,lch2lab:vS,lch2xyz:MM,lch2rgb:BM};function Ef(s){var e=s[0]/255,t=s[1]/255,i=s[2]/255,n=Math.min(e,t,i),o=Math.max(e,t,i),a=o-n,l,u,c;return o==n?l=0:e==o?l=(t-i)/a:t==o?l=2+(i-e)/a:i==o&&(l=4+(e-t)/a),l=Math.min(l*60,360),l<0&&(l+=360),c=(n+o)/2,o==n?u=0:c<=.5?u=a/(o+n):u=a/(2-o-n),[l,u*100,c*100]}function Ib(s){var e=s[0],t=s[1],i=s[2],n=Math.min(e,t,i),o=Math.max(e,t,i),a=o-n,l,u,c;return o==0?u=0:u=a/o*1e3/10,o==n?l=0:e==o?l=(t-i)/a:t==o?l=2+(i-e)/a:i==o&&(l=4+(e-t)/a),l=Math.min(l*60,360),l<0&&(l+=360),c=o/255*1e3/10,[l,u,c]}function xf(s){var e=s[0],t=s[1],o=s[2],i=Ef(s)[0],n=1/255*Math.min(e,Math.min(t,o)),o=1-1/255*Math.max(e,Math.max(t,o));return[i,n*100,o*100]}function vf(s){var e=s[0]/255,t=s[1]/255,i=s[2]/255,n,o,a,l;return l=Math.min(1-e,1-t,1-i),n=(1-e-l)/(1-l)||0,o=(1-t-l)/(1-l)||0,a=(1-i-l)/(1-l)||0,[n*100,o*100,a*100,l*100]}function Cf(s){return JA[JSON.stringify(s)]}function yS(s){var e=s[0]/255,t=s[1]/255,i=s[2]/255;e=e>.04045?Math.pow((e+.055)/1.055,2.4):e/12.92,t=t>.04045?Math.pow((t+.055)/1.055,2.4):t/12.92,i=i>.04045?Math.pow((i+.055)/1.055,2.4):i/12.92;var n=e*.4124+t*.3576+i*.1805,o=e*.2126+t*.7152+i*.0722,a=e*.0193+t*.1192+i*.9505;return[n*100,o*100,a*100]}function SS(s){var e=yS(s),t=e[0],i=e[1],n=e[2],o,a,l;return t/=95.047,i/=100,n/=108.883,t=t>.008856?Math.pow(t,1/3):7.787*t+16/116,i=i>.008856?Math.pow(i,1/3):7.787*i+16/116,n=n>.008856?Math.pow(n,1/3):7.787*n+16/116,o=116*i-16,a=500*(t-i),l=200*(i-n),[o,a,l]}function mM(s){return xS(SS(s))}function wb(s){var e=s[0]/360,t=s[1]/100,i=s[2]/100,n,o,a,l,u;if(t==0)return u=i*255,[u,u,u];i<.5?o=i*(1+t):o=i+t-i*t,n=2*i-o,l=[0,0,0];for(var c=0;c<3;c++)a=e+1/3*-(c-1),a<0&&a++,a>1&&a--,6*a<1?u=n+(o-n)*6*a:2*a<1?u=o:3*a<2?u=n+(o-n)*(2/3-a)*6:u=n,l[c]=u*255;return l}function bM(s){var e=s[0],t=s[1]/100,i=s[2]/100,n,o;return i===0?[0,0,0]:(i*=2,t*=i<=1?i:2-i,o=(i+t)/2,n=2*t/(i+t),[e,n*100,o*100])}function PM(s){return xf(wb(s))}function yM(s){return vf(wb(s))}function SM(s){return Cf(wb(s))}function Lb(s){var e=s[0]/60,t=s[1]/100,u=s[2]/100,i=Math.floor(e)%6,n=e-Math.floor(e),o=255*u*(1-t),a=255*u*(1-t*n),l=255*u*(1-t*(1-n)),u=255*u;switch(i){case 0:return[u,l,o];case 1:return[a,u,o];case 2:return[o,u,l];case 3:return[o,a,u];case 4:return[l,o,u];case 5:return[u,o,a]}}function EM(s){var e=s[0],t=s[1]/100,i=s[2]/100,n,o;return o=(2-t)*i,n=t*i,n/=o<=1?o:2-o,n=n||0,o/=2,[e,n*100,o*100]}function xM(s){return xf(Lb(s))}function vM(s){return vf(Lb(s))}function CM(s){return Cf(Lb(s))}function Af(s){var e=s[0]/360,t=s[1]/100,i=s[2]/100,n=t+i,o,a,l,u;switch(n>1&&(t/=n,i/=n),o=Math.floor(6*e),a=1-i,l=6*e-o,(o&1)!=0&&(l=1-l),u=t+l*(a-t),o){default:case 6:case 0:r=a,g=u,b=t;break;case 1:r=u,g=a,b=t;break;case 2:r=t,g=a,b=u;break;case 3:r=t,g=u,b=a;break;case 4:r=u,g=t,b=a;break;case 5:r=a,g=t,b=u;break}return[r*255,g*255,b*255]}function AM(s){return Ef(Af(s))}function TM(s){return Ib(Af(s))}function IM(s){return vf(Af(s))}function wM(s){return Cf(Af(s))}function Tf(s){var e=s[0]/100,t=s[1]/100,i=s[2]/100,n=s[3]/100,o,a,l;return o=1-Math.min(1,e*(1-n)+n),a=1-Math.min(1,t*(1-n)+n),l=1-Math.min(1,i*(1-n)+n),[o*255,a*255,l*255]}function LM(s){return Ef(Tf(s))}function RM(s){return Ib(Tf(s))}function OM(s){return xf(Tf(s))}function _M(s){return Cf(Tf(s))}function KA(s){var e=s[0]/100,t=s[1]/100,i=s[2]/100,n,o,a;return n=e*3.2406+t*-1.5372+i*-.4986,o=e*-.9689+t*1.8758+i*.0415,a=e*.0557+t*-.204+i*1.057,n=n>.0031308?1.055*Math.pow(n,1/2.4)-.055:n=n*12.92,o=o>.0031308?1.055*Math.pow(o,1/2.4)-.055:o=o*12.92,a=a>.0031308?1.055*Math.pow(a,1/2.4)-.055:a=a*12.92,n=Math.min(Math.max(0,n),1),o=Math.min(Math.max(0,o),1),a=Math.min(Math.max(0,a),1),[n*255,o*255,a*255]}function ZA(s){var e=s[0],t=s[1],i=s[2],n,o,a;return e/=95.047,t/=100,i/=108.883,e=e>.008856?Math.pow(e,1/3):7.787*e+16/116,t=t>.008856?Math.pow(t,1/3):7.787*t+16/116,i=i>.008856?Math.pow(i,1/3):7.787*i+16/116,n=116*t-16,o=500*(e-t),a=200*(t-i),[n,o,a]}function NM(s){return xS(ZA(s))}function ES(s){var e=s[0],t=s[1],i=s[2],n,o,a,l;return e<=8?(o=e*100/903.3,l=7.787*(o/100)+16/116):(o=100*Math.pow((e+16)/116,3),l=Math.pow(o/100,1/3)),n=n/95.047<=.008856?n=95.047*(t/500+l-16/116)/7.787:95.047*Math.pow(t/500+l,3),a=a/108.883<=.008859?a=108.883*(l-i/200-16/116)/7.787:108.883*Math.pow(l-i/200,3),[n,o,a]}function xS(s){var e=s[0],t=s[1],i=s[2],n,o,a;return n=Math.atan2(i,t),o=n*360/2/Math.PI,o<0&&(o+=360),a=Math.sqrt(t*t+i*i),[e,a,o]}function QA(s){return KA(ES(s))}function vS(s){var e=s[0],t=s[1],i=s[2],n,o,a;return a=i/360*2*Math.PI,n=t*Math.cos(a),o=t*Math.sin(a),[e,n,o]}function MM(s){return ES(vS(s))}function BM(s){return QA(vS(s))}function pu(s){return PS[s]}function DM(s){return Ef(pu(s))}function GM(s){return Ib(pu(s))}function FM(s){return xf(pu(s))}function kM(s){return vf(pu(s))}function VM(s){return SS(pu(s))}function UM(s){return yS(pu(s))}var PS={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]},JA={};for(bS in PS)JA[JSON.stringify(PS[bS])]=bS;var bS});var i1=pn((pbe,r1)=>{var CS=e1(),mu=function(){return new If};for(sh in CS)mu[sh+"Raw"]=function(s){return function(e){return typeof e=="number"&&(e=Array.prototype.slice.call(arguments)),CS[s](e)}}(sh),AS=/(\w+)2(\w+)/.exec(sh),Rb=AS[1],t1=AS[2],mu[Rb]=mu[Rb]||{},mu[Rb][t1]=mu[sh]=function(s){return function(e){typeof e=="number"&&(e=Array.prototype.slice.call(arguments));var t=CS[s](e);if(typeof t=="string"||t===void 0)return t;for(var i=0;i<t.length;i++)t[i]=Math.round(t[i]);return t}}(sh);var AS,Rb,t1,sh,If=function(){this.convs={}};If.prototype.routeSpace=function(s,e){var t=e[0];return t===void 0?this.getValues(s):(typeof t=="number"&&(t=Array.prototype.slice.call(e)),this.setValues(s,t))};If.prototype.setValues=function(s,e){return this.space=s,this.convs={},this.convs[s]=e,this};If.prototype.getValues=function(s){var e=this.convs[s];if(!e){var t=this.space,i=this.convs[t];e=mu[t][s](i),this.convs[s]=e}return e};["rgb","hsl","hsv","cmyk","keyword"].forEach(function(s){If.prototype[s]=function(e){return this.routeSpace(s,arguments)}});r1.exports=mu});var o1=pn((mbe,n1)=>{var TS=i1();n1.exports=function(s){var e,t,i,n;if(e=/^((?:rgb|hs[lv]|cmyk|xyz|lab)a?)\s*\(([^\)]*)\)/.exec(s)){var o=e[1],a=o.replace(/a$/,""),l=a==="cmyk"?4:3;t=TS[a],i=e[2].replace(/^\s+|\s+$/g,"").split(/\s*,\s*/).map(function(c,h){return/%$/.test(c)&&h===l?parseFloat(c)/100:(/%$/.test(c),parseFloat(c))}),o===a&&i.push(1),n=i[l]===void 0?1:i[l],i=i.slice(0,l),t[a]=function(){return i}}else if(/^#[A-Fa-f0-9]+$/.test(s)){var a=s.replace(/^#/,""),l=a.length;t=TS.rgb,i=a.split(l===3?/(.)/:/(..)/),i=i.filter(Boolean).map(function(d){return parseInt(l===3?d+d:d,16)}),n=1,t.rgb=function(){return i},i[0]||(i[0]=0),i[1]||(i[1]=0),i[2]||(i[2]=0)}else t=TS.keyword,t.keyword=function(){return s},i=s,n=1;var u={rgb:void 0,hsl:void 0,hsv:void 0,cmyk:void 0,keyword:void 0,hex:void 0};try{u.rgb=t.rgb(i)}catch{}try{u.hsl=t.hsl(i)}catch{}try{u.hsv=t.hsv(i)}catch{}try{u.cmyk=t.cmyk(i)}catch{}try{u.keyword=t.keyword(i)}catch{}return u.rgb&&(u.hex="#"+u.rgb.map(function(c){var h=c.toString(16);return h.length===1?"0"+h:h}).join("")),u.rgb&&(u.rgba=u.rgb.concat(n)),u.hsl&&(u.hsla=u.hsl.concat(n)),u.hsv&&(u.hsva=u.hsv.concat(n)),u.cmyk&&(u.cmyka=u.cmyk.concat(n)),u}});var fL=pn((s_e,HP)=>{(function(s,e,t,i){"use strict";var n=["","webkit","Moz","MS","ms","o"],o=e.createElement("div"),a="function",l=Math.round,u=Math.abs,c=Date.now;function h(v,w,M){return setTimeout(B(v,M),w)}function d(v,w,M){return Array.isArray(v)?(f(v,M[w],M),!0):!1}function f(v,w,M){var V;if(!!v)if(v.forEach)v.forEach(w,M);else if(v.length!==i)for(V=0;V<v.length;)w.call(M,v[V],V,v),V++;else for(V in v)v.hasOwnProperty(V)&&w.call(M,v[V],V,v)}function p(v,w,M){var V="DEPRECATED METHOD: "+w+`
`+M+` AT 
`;return function(){var $=new Error("get-stack-trace"),le=$&&$.stack?$.stack.replace(/^[^\(]+?[\n$]/gm,"").replace(/^\s+at\s+/gm,"").replace(/^Object.<anonymous>\s*\(/gm,"{anonymous}()@"):"Unknown Stack Trace",Be=s.console&&(s.console.warn||s.console.log);return Be&&Be.call(s.console,V,le),v.apply(this,arguments)}}var S;typeof Object.assign!="function"?S=function(w){if(w===i||w===null)throw new TypeError("Cannot convert undefined or null to object");for(var M=Object(w),V=1;V<arguments.length;V++){var $=arguments[V];if($!==i&&$!==null)for(var le in $)$.hasOwnProperty(le)&&(M[le]=$[le])}return M}:S=Object.assign;var E=p(function(w,M,V){for(var $=Object.keys(M),le=0;le<$.length;)(!V||V&&w[$[le]]===i)&&(w[$[le]]=M[$[le]]),le++;return w},"extend","Use `assign`."),C=p(function(w,M){return E(w,M,!0)},"merge","Use `assign`.");function O(v,w,M){var V=w.prototype,$;$=v.prototype=Object.create(V),$.constructor=v,$._super=V,M&&S($,M)}function B(v,w){return function(){return v.apply(w,arguments)}}function A(v,w){return typeof v==a?v.apply(w&&w[0]||i,w):v}function N(v,w){return v===i?w:v}function z(v,w,M){f(ae(w),function(V){v.addEventListener(V,M,!1)})}function Y(v,w,M){f(ae(w),function(V){v.removeEventListener(V,M,!1)})}function ie(v,w){for(;v;){if(v==w)return!0;v=v.parentNode}return!1}function he(v,w){return v.indexOf(w)>-1}function ae(v){return v.trim().split(/\s+/g)}function D(v,w,M){if(v.indexOf&&!M)return v.indexOf(w);for(var V=0;V<v.length;){if(M&&v[V][M]==w||!M&&v[V]===w)return V;V++}return-1}function _(v){return Array.prototype.slice.call(v,0)}function W(v,w,M){for(var V=[],$=[],le=0;le<v.length;){var Be=w?v[le][w]:v[le];D($,Be)<0&&V.push(v[le]),$[le]=Be,le++}return M&&(w?V=V.sort(function(ir,mr){return ir[w]>mr[w]}):V=V.sort()),V}function H(v,w){for(var M,V,$=w[0].toUpperCase()+w.slice(1),le=0;le<n.length;){if(M=n[le],V=M?M+$:w,V in v)return V;le++}return i}var ee=1;function oe(){return ee++}function ce(v){var w=v.ownerDocument||v;return w.defaultView||w.parentWindow||s}var Ee=/mobile|tablet|ip(ad|hone|od)|android/i,Oe="ontouchstart"in s,nt=H(s,"PointerEvent")!==i,ui=Oe&&Ee.test(navigator.userAgent),zr="touch",Tp="pen",dd="mouse",Ip="kinect",Xy=25,Rr=1,cs=2,_t=4,Wr=8,na=1,hs=2,Rl=4,Ol=8,_l=16,hn=hs|Rl,ds=Ol|_l,wp=hn|ds,Lp=["x","y"],dc=["clientX","clientY"];function xi(v,w){var M=this;this.manager=v,this.callback=w,this.element=v.element,this.target=v.options.inputTarget,this.domHandler=function(V){A(v.options.enable,[v])&&M.handler(V)},this.init()}xi.prototype={handler:function(){},init:function(){this.evEl&&z(this.element,this.evEl,this.domHandler),this.evTarget&&z(this.target,this.evTarget,this.domHandler),this.evWin&&z(ce(this.element),this.evWin,this.domHandler)},destroy:function(){this.evEl&&Y(this.element,this.evEl,this.domHandler),this.evTarget&&Y(this.target,this.evTarget,this.domHandler),this.evWin&&Y(ce(this.element),this.evWin,this.domHandler)}};function Rp(v){var w,M=v.options.inputClass;return M?w=M:nt?w=pd:ui?w=pc:Oe?w=Nl:w=gc,new w(v,Yy)}function Yy(v,w,M){var V=M.pointers.length,$=M.changedPointers.length,le=w&Rr&&V-$===0,Be=w&(_t|Wr)&&V-$===0;M.isFirst=!!le,M.isFinal=!!Be,le&&(v.session={}),M.eventType=w,Ky(v,M),v.emit("hammer.input",M),v.recognize(M),v.session.prevInput=M}function Ky(v,w){var M=v.session,V=w.pointers,$=V.length;M.firstInput||(M.firstInput=_p(w)),$>1&&!M.firstMultiple?M.firstMultiple=_p(w):$===1&&(M.firstMultiple=!1);var le=M.firstInput,Be=M.firstMultiple,Yt=Be?Be.center:le.center,ir=w.center=Np(V);w.timeStamp=c(),w.deltaTime=w.timeStamp-le.timeStamp,w.angle=gd(Yt,ir),w.distance=fc(Yt,ir),Zy(M,w),w.offsetDirection=fd(w.deltaX,w.deltaY);var mr=Mp(w.deltaTime,w.deltaX,w.deltaY);w.overallVelocityX=mr.x,w.overallVelocityY=mr.y,w.overallVelocity=u(mr.x)>u(mr.y)?mr.x:mr.y,w.scale=Be?Bp(Be.pointers,V):1,w.rotation=Be?Qy(Be.pointers,V):0,w.maxPointers=M.prevInput?w.pointers.length>M.prevInput.maxPointers?w.pointers.length:M.prevInput.maxPointers:w.pointers.length,Op(M,w);var Vi=v.element;ie(w.srcEvent.target,Vi)&&(Vi=w.srcEvent.target),w.target=Vi}function Zy(v,w){var M=w.center,V=v.offsetDelta||{},$=v.prevDelta||{},le=v.prevInput||{};(w.eventType===Rr||le.eventType===_t)&&($=v.prevDelta={x:le.deltaX||0,y:le.deltaY||0},V=v.offsetDelta={x:M.x,y:M.y}),w.deltaX=$.x+(M.x-V.x),w.deltaY=$.y+(M.y-V.y)}function Op(v,w){var M=v.lastInterval||w,V=w.timeStamp-M.timeStamp,$,le,Be,Yt;if(w.eventType!=Wr&&(V>Xy||M.velocity===i)){var ir=w.deltaX-M.deltaX,mr=w.deltaY-M.deltaY,Vi=Mp(V,ir,mr);le=Vi.x,Be=Vi.y,$=u(Vi.x)>u(Vi.y)?Vi.x:Vi.y,Yt=fd(ir,mr),v.lastInterval=w}else $=M.velocity,le=M.velocityX,Be=M.velocityY,Yt=M.direction;w.velocity=$,w.velocityX=le,w.velocityY=Be,w.direction=Yt}function _p(v){for(var w=[],M=0;M<v.pointers.length;)w[M]={clientX:l(v.pointers[M].clientX),clientY:l(v.pointers[M].clientY)},M++;return{timeStamp:c(),pointers:w,center:Np(w),deltaX:v.deltaX,deltaY:v.deltaY}}function Np(v){var w=v.length;if(w===1)return{x:l(v[0].clientX),y:l(v[0].clientY)};for(var M=0,V=0,$=0;$<w;)M+=v[$].clientX,V+=v[$].clientY,$++;return{x:l(M/w),y:l(V/w)}}function Mp(v,w,M){return{x:w/v||0,y:M/v||0}}function fd(v,w){return v===w?na:u(v)>=u(w)?v<0?hs:Rl:w<0?Ol:_l}function fc(v,w,M){M||(M=Lp);var V=w[M[0]]-v[M[0]],$=w[M[1]]-v[M[1]];return Math.sqrt(V*V+$*$)}function gd(v,w,M){M||(M=Lp);var V=w[M[0]]-v[M[0]],$=w[M[1]]-v[M[1]];return Math.atan2($,V)*180/Math.PI}function Qy(v,w){return gd(w[1],w[0],dc)+gd(v[1],v[0],dc)}function Bp(v,w){return fc(w[0],w[1],dc)/fc(v[0],v[1],dc)}var Jy={mousedown:Rr,mousemove:cs,mouseup:_t},$y="mousedown",e0="mousemove mouseup";function gc(){this.evEl=$y,this.evWin=e0,this.pressed=!1,xi.apply(this,arguments)}O(gc,xi,{handler:function(w){var M=Jy[w.type];M&Rr&&w.button===0&&(this.pressed=!0),M&cs&&w.which!==1&&(M=_t),this.pressed&&(M&_t&&(this.pressed=!1),this.callback(this.manager,M,{pointers:[w],changedPointers:[w],pointerType:dd,srcEvent:w}))}});var t0={pointerdown:Rr,pointermove:cs,pointerup:_t,pointercancel:Wr,pointerout:Wr},r0={2:zr,3:Tp,4:dd,5:Ip},Dp="pointerdown",Gp="pointermove pointerup pointercancel";s.MSPointerEvent&&!s.PointerEvent&&(Dp="MSPointerDown",Gp="MSPointerMove MSPointerUp MSPointerCancel");function pd(){this.evEl=Dp,this.evWin=Gp,xi.apply(this,arguments),this.store=this.manager.session.pointerEvents=[]}O(pd,xi,{handler:function(w){var M=this.store,V=!1,$=w.type.toLowerCase().replace("ms",""),le=t0[$],Be=r0[w.pointerType]||w.pointerType,Yt=Be==zr,ir=D(M,w.pointerId,"pointerId");le&Rr&&(w.button===0||Yt)?ir<0&&(M.push(w),ir=M.length-1):le&(_t|Wr)&&(V=!0),!(ir<0)&&(M[ir]=w,this.callback(this.manager,le,{pointers:M,changedPointers:[w],pointerType:Be,srcEvent:w}),V&&M.splice(ir,1))}});var i0={touchstart:Rr,touchmove:cs,touchend:_t,touchcancel:Wr},n0="touchstart",Fp="touchstart touchmove touchend touchcancel";function md(){this.evTarget=n0,this.evWin=Fp,this.started=!1,xi.apply(this,arguments)}O(md,xi,{handler:function(w){var M=i0[w.type];if(M===Rr&&(this.started=!0),!!this.started){var V=oa.call(this,w,M);M&(_t|Wr)&&V[0].length-V[1].length===0&&(this.started=!1),this.callback(this.manager,M,{pointers:V[0],changedPointers:V[1],pointerType:zr,srcEvent:w})}}});function oa(v,w){var M=_(v.touches),V=_(v.changedTouches);return w&(_t|Wr)&&(M=W(M.concat(V),"identifier",!0)),[M,V]}var sa={touchstart:Rr,touchmove:cs,touchend:_t,touchcancel:Wr},o0="touchstart touchmove touchend touchcancel";function pc(){this.evTarget=o0,this.targetIds={},xi.apply(this,arguments)}O(pc,xi,{handler:function(w){var M=sa[w.type],V=bd.call(this,w,M);!V||this.callback(this.manager,M,{pointers:V[0],changedPointers:V[1],pointerType:zr,srcEvent:w})}});function bd(v,w){var M=_(v.touches),V=this.targetIds;if(w&(Rr|cs)&&M.length===1)return V[M[0].identifier]=!0,[M,M];var $,le,Be=_(v.changedTouches),Yt=[],ir=this.target;if(le=M.filter(function(mr){return ie(mr.target,ir)}),w===Rr)for($=0;$<le.length;)V[le[$].identifier]=!0,$++;for($=0;$<Be.length;)V[Be[$].identifier]&&Yt.push(Be[$]),w&(_t|Wr)&&delete V[Be[$].identifier],$++;if(!!Yt.length)return[W(le.concat(Yt),"identifier",!0),Yt]}var Pd=2500,mc=25;function Nl(){xi.apply(this,arguments);var v=B(this.handler,this);this.touch=new pc(this.manager,v),this.mouse=new gc(this.manager,v),this.primaryTouch=null,this.lastTouches=[]}O(Nl,xi,{handler:function(w,M,V){var $=V.pointerType==zr,le=V.pointerType==dd;if(!(le&&V.sourceCapabilities&&V.sourceCapabilities.firesTouchEvents)){if($)s0.call(this,M,V);else if(le&&aa.call(this,V))return;this.callback(w,M,V)}},destroy:function(){this.touch.destroy(),this.mouse.destroy()}});function s0(v,w){v&Rr?(this.primaryTouch=w.changedPointers[0].identifier,Fi.call(this,w)):v&(_t|Wr)&&Fi.call(this,w)}function Fi(v){var w=v.changedPointers[0];if(w.identifier===this.primaryTouch){var M={x:w.clientX,y:w.clientY};this.lastTouches.push(M);var V=this.lastTouches,$=function(){var le=V.indexOf(M);le>-1&&V.splice(le,1)};setTimeout($,Pd)}}function aa(v){for(var w=v.srcEvent.clientX,M=v.srcEvent.clientY,V=0;V<this.lastTouches.length;V++){var $=this.lastTouches[V],le=Math.abs(w-$.x),Be=Math.abs(M-$.y);if(le<=mc&&Be<=mc)return!0}return!1}var kp=H(o.style,"touchAction"),bc=kp!==i,Pc="compute",yd="auto",Sd="manipulation",dn="none",So="pan-x",Ml="pan-y",Bl=l0();function Ed(v,w){this.manager=v,this.set(w)}Ed.prototype={set:function(v){v==Pc&&(v=this.compute()),bc&&this.manager.element.style&&Bl[v]&&(this.manager.element.style[kp]=v),this.actions=v.toLowerCase().trim()},update:function(){this.set(this.manager.options.touchAction)},compute:function(){var v=[];return f(this.manager.recognizers,function(w){A(w.options.enable,[w])&&(v=v.concat(w.getTouchAction()))}),a0(v.join(" "))},preventDefaults:function(v){var w=v.srcEvent,M=v.offsetDirection;if(this.manager.session.prevented){w.preventDefault();return}var V=this.actions,$=he(V,dn)&&!Bl[dn],le=he(V,Ml)&&!Bl[Ml],Be=he(V,So)&&!Bl[So];if($){var Yt=v.pointers.length===1,ir=v.distance<2,mr=v.deltaTime<250;if(Yt&&ir&&mr)return}if(!(Be&&le)&&($||le&&M&hn||Be&&M&ds))return this.preventSrc(w)},preventSrc:function(v){this.manager.session.prevented=!0,v.preventDefault()}};function a0(v){if(he(v,dn))return dn;var w=he(v,So),M=he(v,Ml);return w&&M?dn:w||M?w?So:Ml:he(v,Sd)?Sd:yd}function l0(){if(!bc)return!1;var v={},w=s.CSS&&s.CSS.supports;return["auto","manipulation","pan-y","pan-x","pan-x pan-y","none"].forEach(function(M){v[M]=w?s.CSS.supports("touch-action",M):!0}),v}var yc=1,vi=2,fs=4,Eo=8,Fn=Eo,Dl=16,fn=32;function kn(v){this.options=S({},this.defaults,v||{}),this.id=oe(),this.manager=null,this.options.enable=N(this.options.enable,!0),this.state=yc,this.simultaneous={},this.requireFail=[]}kn.prototype={defaults:{},set:function(v){return S(this.options,v),this.manager&&this.manager.touchAction.update(),this},recognizeWith:function(v){if(d(v,"recognizeWith",this))return this;var w=this.simultaneous;return v=Sc(v,this),w[v.id]||(w[v.id]=v,v.recognizeWith(this)),this},dropRecognizeWith:function(v){return d(v,"dropRecognizeWith",this)?this:(v=Sc(v,this),delete this.simultaneous[v.id],this)},requireFailure:function(v){if(d(v,"requireFailure",this))return this;var w=this.requireFail;return v=Sc(v,this),D(w,v)===-1&&(w.push(v),v.requireFailure(this)),this},dropRequireFailure:function(v){if(d(v,"dropRequireFailure",this))return this;v=Sc(v,this);var w=D(this.requireFail,v);return w>-1&&this.requireFail.splice(w,1),this},hasRequireFailures:function(){return this.requireFail.length>0},canRecognizeWith:function(v){return!!this.simultaneous[v.id]},emit:function(v){var w=this,M=this.state;function V($){w.manager.emit($,v)}M<Eo&&V(w.options.event+Vp(M)),V(w.options.event),v.additionalEvent&&V(v.additionalEvent),M>=Eo&&V(w.options.event+Vp(M))},tryEmit:function(v){if(this.canEmit())return this.emit(v);this.state=fn},canEmit:function(){for(var v=0;v<this.requireFail.length;){if(!(this.requireFail[v].state&(fn|yc)))return!1;v++}return!0},recognize:function(v){var w=S({},v);if(!A(this.options.enable,[this,w])){this.reset(),this.state=fn;return}this.state&(Fn|Dl|fn)&&(this.state=yc),this.state=this.process(w),this.state&(vi|fs|Eo|Dl)&&this.tryEmit(w)},process:function(v){},getTouchAction:function(){},reset:function(){}};function Vp(v){return v&Dl?"cancel":v&Eo?"end":v&fs?"move":v&vi?"start":""}function Up(v){return v==_l?"down":v==Ol?"up":v==hs?"left":v==Rl?"right":""}function Sc(v,w){var M=w.manager;return M?M.get(v):v}function ki(){kn.apply(this,arguments)}O(ki,kn,{defaults:{pointers:1},attrTest:function(v){var w=this.options.pointers;return w===0||v.pointers.length===w},process:function(v){var w=this.state,M=v.eventType,V=w&(vi|fs),$=this.attrTest(v);return V&&(M&Wr||!$)?w|Dl:V||$?M&_t?w|Eo:w&vi?w|fs:vi:fn}});function Gl(){ki.apply(this,arguments),this.pX=null,this.pY=null}O(Gl,ki,{defaults:{event:"pan",threshold:10,pointers:1,direction:wp},getTouchAction:function(){var v=this.options.direction,w=[];return v&hn&&w.push(Ml),v&ds&&w.push(So),w},directionTest:function(v){var w=this.options,M=!0,V=v.distance,$=v.direction,le=v.deltaX,Be=v.deltaY;return $&w.direction||(w.direction&hn?($=le===0?na:le<0?hs:Rl,M=le!=this.pX,V=Math.abs(v.deltaX)):($=Be===0?na:Be<0?Ol:_l,M=Be!=this.pY,V=Math.abs(v.deltaY))),v.direction=$,M&&V>w.threshold&&$&w.direction},attrTest:function(v){return ki.prototype.attrTest.call(this,v)&&(this.state&vi||!(this.state&vi)&&this.directionTest(v))},emit:function(v){this.pX=v.deltaX,this.pY=v.deltaY;var w=Up(v.direction);w&&(v.additionalEvent=this.options.event+w),this._super.emit.call(this,v)}});function xd(){ki.apply(this,arguments)}O(xd,ki,{defaults:{event:"pinch",threshold:0,pointers:2},getTouchAction:function(){return[dn]},attrTest:function(v){return this._super.attrTest.call(this,v)&&(Math.abs(v.scale-1)>this.options.threshold||this.state&vi)},emit:function(v){if(v.scale!==1){var w=v.scale<1?"in":"out";v.additionalEvent=this.options.event+w}this._super.emit.call(this,v)}});function vd(){kn.apply(this,arguments),this._timer=null,this._input=null}O(vd,kn,{defaults:{event:"press",pointers:1,time:251,threshold:9},getTouchAction:function(){return[yd]},process:function(v){var w=this.options,M=v.pointers.length===w.pointers,V=v.distance<w.threshold,$=v.deltaTime>w.time;if(this._input=v,!V||!M||v.eventType&(_t|Wr)&&!$)this.reset();else if(v.eventType&Rr)this.reset(),this._timer=h(function(){this.state=Fn,this.tryEmit()},w.time,this);else if(v.eventType&_t)return Fn;return fn},reset:function(){clearTimeout(this._timer)},emit:function(v){this.state===Fn&&(v&&v.eventType&_t?this.manager.emit(this.options.event+"up",v):(this._input.timeStamp=c(),this.manager.emit(this.options.event,this._input)))}});function Cd(){ki.apply(this,arguments)}O(Cd,ki,{defaults:{event:"rotate",threshold:0,pointers:2},getTouchAction:function(){return[dn]},attrTest:function(v){return this._super.attrTest.call(this,v)&&(Math.abs(v.rotation)>this.options.threshold||this.state&vi)}});function Ad(){ki.apply(this,arguments)}O(Ad,ki,{defaults:{event:"swipe",threshold:10,velocity:.3,direction:hn|ds,pointers:1},getTouchAction:function(){return Gl.prototype.getTouchAction.call(this)},attrTest:function(v){var w=this.options.direction,M;return w&(hn|ds)?M=v.overallVelocity:w&hn?M=v.overallVelocityX:w&ds&&(M=v.overallVelocityY),this._super.attrTest.call(this,v)&&w&v.offsetDirection&&v.distance>this.options.threshold&&v.maxPointers==this.options.pointers&&u(M)>this.options.velocity&&v.eventType&_t},emit:function(v){var w=Up(v.offsetDirection);w&&this.manager.emit(this.options.event+w,v),this.manager.emit(this.options.event,v)}});function Ec(){kn.apply(this,arguments),this.pTime=!1,this.pCenter=!1,this._timer=null,this._input=null,this.count=0}O(Ec,kn,{defaults:{event:"tap",pointers:1,taps:1,interval:300,time:250,threshold:9,posThreshold:10},getTouchAction:function(){return[Sd]},process:function(v){var w=this.options,M=v.pointers.length===w.pointers,V=v.distance<w.threshold,$=v.deltaTime<w.time;if(this.reset(),v.eventType&Rr&&this.count===0)return this.failTimeout();if(V&&$&&M){if(v.eventType!=_t)return this.failTimeout();var le=this.pTime?v.timeStamp-this.pTime<w.interval:!0,Be=!this.pCenter||fc(this.pCenter,v.center)<w.posThreshold;this.pTime=v.timeStamp,this.pCenter=v.center,!Be||!le?this.count=1:this.count+=1,this._input=v;var Yt=this.count%w.taps;if(Yt===0)return this.hasRequireFailures()?(this._timer=h(function(){this.state=Fn,this.tryEmit()},w.interval,this),vi):Fn}return fn},failTimeout:function(){return this._timer=h(function(){this.state=fn},this.options.interval,this),fn},reset:function(){clearTimeout(this._timer)},emit:function(){this.state==Fn&&(this._input.tapCount=this.count,this.manager.emit(this.options.event,this._input))}});function gn(v,w){return w=w||{},w.recognizers=N(w.recognizers,gn.defaults.preset),new Fl(v,w)}gn.VERSION="2.0.7",gn.defaults={domEvents:!1,touchAction:Pc,enable:!0,inputTarget:null,inputClass:null,preset:[[Cd,{enable:!1}],[xd,{enable:!1},["rotate"]],[Ad,{direction:hn}],[Gl,{direction:hn},["swipe"]],[Ec],[Ec,{event:"doubletap",taps:2},["tap"]],[vd]],cssProps:{userSelect:"none",touchSelect:"none",touchCallout:"none",contentZooming:"none",userDrag:"none",tapHighlightColor:"rgba(0,0,0,0)"}};var u0=1,gs=2;function Fl(v,w){this.options=S({},gn.defaults,w||{}),this.options.inputTarget=this.options.inputTarget||v,this.handlers={},this.session={},this.recognizers=[],this.oldCssProps={},this.element=v,this.input=Rp(this),this.touchAction=new Ed(this,this.options.touchAction),Td(this,!0),f(this.options.recognizers,function(M){var V=this.add(new M[0](M[1]));M[2]&&V.recognizeWith(M[2]),M[3]&&V.requireFailure(M[3])},this)}Fl.prototype={set:function(v){return S(this.options,v),v.touchAction&&this.touchAction.update(),v.inputTarget&&(this.input.destroy(),this.input.target=v.inputTarget,this.input.init()),this},stop:function(v){this.session.stopped=v?gs:u0},recognize:function(v){var w=this.session;if(!w.stopped){this.touchAction.preventDefaults(v);var M,V=this.recognizers,$=w.curRecognizer;(!$||$&&$.state&Fn)&&($=w.curRecognizer=null);for(var le=0;le<V.length;)M=V[le],w.stopped!==gs&&(!$||M==$||M.canRecognizeWith($))?M.recognize(v):M.reset(),!$&&M.state&(vi|fs|Eo)&&($=w.curRecognizer=M),le++}},get:function(v){if(v instanceof kn)return v;for(var w=this.recognizers,M=0;M<w.length;M++)if(w[M].options.event==v)return w[M];return null},add:function(v){if(d(v,"add",this))return this;var w=this.get(v.options.event);return w&&this.remove(w),this.recognizers.push(v),v.manager=this,this.touchAction.update(),v},remove:function(v){if(d(v,"remove",this))return this;if(v=this.get(v),v){var w=this.recognizers,M=D(w,v);M!==-1&&(w.splice(M,1),this.touchAction.update())}return this},on:function(v,w){if(v!==i&&w!==i){var M=this.handlers;return f(ae(v),function(V){M[V]=M[V]||[],M[V].push(w)}),this}},off:function(v,w){if(v!==i){var M=this.handlers;return f(ae(v),function(V){w?M[V]&&M[V].splice(D(M[V],w),1):delete M[V]}),this}},emit:function(v,w){this.options.domEvents&&c0(v,w);var M=this.handlers[v]&&this.handlers[v].slice();if(!(!M||!M.length)){w.type=v,w.preventDefault=function(){w.srcEvent.preventDefault()};for(var V=0;V<M.length;)M[V](w),V++}},destroy:function(){this.element&&Td(this,!1),this.handlers={},this.session={},this.input.destroy(),this.element=null}};function Td(v,w){var M=v.element;if(!!M.style){var V;f(v.options.cssProps,function($,le){V=H(M.style,le),w?(v.oldCssProps[V]=M.style[V],M.style[V]=$):M.style[V]=v.oldCssProps[V]||""}),w||(v.oldCssProps={})}}function c0(v,w){var M=e.createEvent("Event");M.initEvent(v,!0,!0),M.gesture=w,w.target.dispatchEvent(M)}S(gn,{INPUT_START:Rr,INPUT_MOVE:cs,INPUT_END:_t,INPUT_CANCEL:Wr,STATE_POSSIBLE:yc,STATE_BEGAN:vi,STATE_CHANGED:fs,STATE_ENDED:Eo,STATE_RECOGNIZED:Fn,STATE_CANCELLED:Dl,STATE_FAILED:fn,DIRECTION_NONE:na,DIRECTION_LEFT:hs,DIRECTION_RIGHT:Rl,DIRECTION_UP:Ol,DIRECTION_DOWN:_l,DIRECTION_HORIZONTAL:hn,DIRECTION_VERTICAL:ds,DIRECTION_ALL:wp,Manager:Fl,Input:xi,TouchAction:Ed,TouchInput:pc,MouseInput:gc,PointerEventInput:pd,TouchMouseInput:Nl,SingleTouchInput:md,Recognizer:kn,AttrRecognizer:ki,Tap:Ec,Pan:Gl,Swipe:Ad,Pinch:xd,Rotate:Cd,Press:vd,on:z,off:Y,each:f,merge:C,extend:E,assign:S,inherit:O,bindFn:B,prefixed:H});var h0=typeof s<"u"?s:typeof self<"u"?self:{};h0.Hammer=gn,typeof define=="function"&&define.amd?define(function(){return gn}):typeof HP<"u"&&HP.exports?HP.exports=gn:s[t]=gn})(window,document,"Hammer")});var RR=pn((jDe,Zx)=>{"use strict";Zx.exports=cy;Zx.exports.default=cy;function cy(s,e,t){t=t||2;var i=e&&e.length,n=i?e[0]*t:s.length,o=IR(s,0,n,t,!0),a=[];if(!o||o.next===o.prev)return a;var l,u,c,h,d,f,p;if(i&&(o=c4(s,e,o,t)),s.length>80*t){l=c=s[0],u=h=s[1];for(var S=t;S<n;S+=t)d=s[S],f=s[S+1],d<l&&(l=d),f<u&&(u=f),d>c&&(c=d),f>h&&(h=f);p=Math.max(c-l,h-u),p=p!==0?32767/p:0}return sp(o,a,t,l,u,p,0),a}function IR(s,e,t,i,n){var o,a;if(n===Kx(s,e,t,i)>0)for(o=e;o<t;o+=i)a=TR(o,s[o],s[o+1],a);else for(o=t-i;o>=e;o-=i)a=TR(o,s[o],s[o+1],a);return a&&hy(a,a.next)&&(lp(a),a=a.next),a}function ec(s,e){if(!s)return s;e||(e=s);var t=s,i;do if(i=!1,!t.steiner&&(hy(t,t.next)||Ot(t.prev,t,t.next)===0)){if(lp(t),t=e=t.prev,t===t.next)break;i=!0}else t=t.next;while(i||t!==e);return e}function sp(s,e,t,i,n,o,a){if(!!s){!a&&o&&p4(s,i,n,o);for(var l=s,u,c;s.prev!==s.next;){if(u=s.prev,c=s.next,o?a4(s,i,n,o):s4(s)){e.push(u.i/t|0),e.push(s.i/t|0),e.push(c.i/t|0),lp(s),s=c.next,l=c.next;continue}if(s=c,s===l){a?a===1?(s=l4(ec(s),e,t),sp(s,e,t,i,n,o,2)):a===2&&u4(s,e,t,i,n,o):sp(ec(s),e,t,i,n,o,1);break}}}}function s4(s){var e=s.prev,t=s,i=s.next;if(Ot(e,t,i)>=0)return!1;for(var n=e.x,o=t.x,a=i.x,l=e.y,u=t.y,c=i.y,h=n<o?n<a?n:a:o<a?o:a,d=l<u?l<c?l:c:u<c?u:c,f=n>o?n>a?n:a:o>a?o:a,p=l>u?l>c?l:c:u>c?u:c,S=i.next;S!==e;){if(S.x>=h&&S.x<=f&&S.y>=d&&S.y<=p&&Qh(n,l,o,u,a,c,S.x,S.y)&&Ot(S.prev,S,S.next)>=0)return!1;S=S.next}return!0}function a4(s,e,t,i){var n=s.prev,o=s,a=s.next;if(Ot(n,o,a)>=0)return!1;for(var l=n.x,u=o.x,c=a.x,h=n.y,d=o.y,f=a.y,p=l<u?l<c?l:c:u<c?u:c,S=h<d?h<f?h:f:d<f?d:f,E=l>u?l>c?l:c:u>c?u:c,C=h>d?h>f?h:f:d>f?d:f,O=Xx(p,S,e,t,i),B=Xx(E,C,e,t,i),A=s.prevZ,N=s.nextZ;A&&A.z>=O&&N&&N.z<=B;){if(A.x>=p&&A.x<=E&&A.y>=S&&A.y<=C&&A!==n&&A!==a&&Qh(l,h,u,d,c,f,A.x,A.y)&&Ot(A.prev,A,A.next)>=0||(A=A.prevZ,N.x>=p&&N.x<=E&&N.y>=S&&N.y<=C&&N!==n&&N!==a&&Qh(l,h,u,d,c,f,N.x,N.y)&&Ot(N.prev,N,N.next)>=0))return!1;N=N.nextZ}for(;A&&A.z>=O;){if(A.x>=p&&A.x<=E&&A.y>=S&&A.y<=C&&A!==n&&A!==a&&Qh(l,h,u,d,c,f,A.x,A.y)&&Ot(A.prev,A,A.next)>=0)return!1;A=A.prevZ}for(;N&&N.z<=B;){if(N.x>=p&&N.x<=E&&N.y>=S&&N.y<=C&&N!==n&&N!==a&&Qh(l,h,u,d,c,f,N.x,N.y)&&Ot(N.prev,N,N.next)>=0)return!1;N=N.nextZ}return!0}function l4(s,e,t){var i=s;do{var n=i.prev,o=i.next.next;!hy(n,o)&&wR(n,i,i.next,o)&&ap(n,o)&&ap(o,n)&&(e.push(n.i/t|0),e.push(i.i/t|0),e.push(o.i/t|0),lp(i),lp(i.next),i=s=o),i=i.next}while(i!==s);return ec(i)}function u4(s,e,t,i,n,o){var a=s;do{for(var l=a.next.next;l!==a.prev;){if(a.i!==l.i&&P4(a,l)){var u=LR(a,l);a=ec(a,a.next),u=ec(u,u.next),sp(a,e,t,i,n,o,0),sp(u,e,t,i,n,o,0);return}l=l.next}a=a.next}while(a!==s)}function c4(s,e,t,i){var n=[],o,a,l,u,c;for(o=0,a=e.length;o<a;o++)l=e[o]*i,u=o<a-1?e[o+1]*i:s.length,c=IR(s,l,u,i,!1),c===c.next&&(c.steiner=!0),n.push(b4(c));for(n.sort(h4),o=0;o<n.length;o++)t=d4(n[o],t);return t}function h4(s,e){return s.x-e.x}function d4(s,e){var t=f4(s,e);if(!t)return e;var i=LR(t,s);return ec(i,i.next),ec(t,t.next)}function f4(s,e){var t=e,i=s.x,n=s.y,o=-1/0,a;do{if(n<=t.y&&n>=t.next.y&&t.next.y!==t.y){var l=t.x+(n-t.y)*(t.next.x-t.x)/(t.next.y-t.y);if(l<=i&&l>o&&(o=l,a=t.x<t.next.x?t:t.next,l===i))return a}t=t.next}while(t!==e);if(!a)return null;var u=a,c=a.x,h=a.y,d=1/0,f;t=a;do i>=t.x&&t.x>=c&&i!==t.x&&Qh(n<h?i:o,n,c,h,n<h?o:i,n,t.x,t.y)&&(f=Math.abs(n-t.y)/(i-t.x),ap(t,s)&&(f<d||f===d&&(t.x>a.x||t.x===a.x&&g4(a,t)))&&(a=t,d=f)),t=t.next;while(t!==u);return a}function g4(s,e){return Ot(s.prev,s,e.prev)<0&&Ot(e.next,s,s.next)<0}function p4(s,e,t,i){var n=s;do n.z===0&&(n.z=Xx(n.x,n.y,e,t,i)),n.prevZ=n.prev,n.nextZ=n.next,n=n.next;while(n!==s);n.prevZ.nextZ=null,n.prevZ=null,m4(n)}function m4(s){var e,t,i,n,o,a,l,u,c=1;do{for(t=s,s=null,o=null,a=0;t;){for(a++,i=t,l=0,e=0;e<c&&(l++,i=i.nextZ,!!i);e++);for(u=c;l>0||u>0&&i;)l!==0&&(u===0||!i||t.z<=i.z)?(n=t,t=t.nextZ,l--):(n=i,i=i.nextZ,u--),o?o.nextZ=n:s=n,n.prevZ=o,o=n;t=i}o.nextZ=null,c*=2}while(a>1);return s}function Xx(s,e,t,i,n){return s=(s-t)*n|0,e=(e-i)*n|0,s=(s|s<<8)&16711935,s=(s|s<<4)&252645135,s=(s|s<<2)&858993459,s=(s|s<<1)&1431655765,e=(e|e<<8)&16711935,e=(e|e<<4)&252645135,e=(e|e<<2)&858993459,e=(e|e<<1)&1431655765,s|e<<1}function b4(s){var e=s,t=s;do(e.x<t.x||e.x===t.x&&e.y<t.y)&&(t=e),e=e.next;while(e!==s);return t}function Qh(s,e,t,i,n,o,a,l){return(n-a)*(e-l)>=(s-a)*(o-l)&&(s-a)*(i-l)>=(t-a)*(e-l)&&(t-a)*(o-l)>=(n-a)*(i-l)}function P4(s,e){return s.next.i!==e.i&&s.prev.i!==e.i&&!y4(s,e)&&(ap(s,e)&&ap(e,s)&&S4(s,e)&&(Ot(s.prev,s,e.prev)||Ot(s,e.prev,e))||hy(s,e)&&Ot(s.prev,s,s.next)>0&&Ot(e.prev,e,e.next)>0)}function Ot(s,e,t){return(e.y-s.y)*(t.x-e.x)-(e.x-s.x)*(t.y-e.y)}function hy(s,e){return s.x===e.x&&s.y===e.y}function wR(s,e,t,i){var n=uy(Ot(s,e,t)),o=uy(Ot(s,e,i)),a=uy(Ot(t,i,s)),l=uy(Ot(t,i,e));return!!(n!==o&&a!==l||n===0&&ly(s,t,e)||o===0&&ly(s,i,e)||a===0&&ly(t,s,i)||l===0&&ly(t,e,i))}function ly(s,e,t){return e.x<=Math.max(s.x,t.x)&&e.x>=Math.min(s.x,t.x)&&e.y<=Math.max(s.y,t.y)&&e.y>=Math.min(s.y,t.y)}function uy(s){return s>0?1:s<0?-1:0}function y4(s,e){var t=s;do{if(t.i!==s.i&&t.next.i!==s.i&&t.i!==e.i&&t.next.i!==e.i&&wR(t,t.next,s,e))return!0;t=t.next}while(t!==s);return!1}function ap(s,e){return Ot(s.prev,s,s.next)<0?Ot(s,e,s.next)>=0&&Ot(s,s.prev,e)>=0:Ot(s,e,s.prev)<0||Ot(s,s.next,e)<0}function S4(s,e){var t=s,i=!1,n=(s.x+e.x)/2,o=(s.y+e.y)/2;do t.y>o!=t.next.y>o&&t.next.y!==t.y&&n<(t.next.x-t.x)*(o-t.y)/(t.next.y-t.y)+t.x&&(i=!i),t=t.next;while(t!==s);return i}function LR(s,e){var t=new Yx(s.i,s.x,s.y),i=new Yx(e.i,e.x,e.y),n=s.next,o=e.prev;return s.next=e,e.prev=s,t.next=n,n.prev=t,i.next=t,t.prev=i,o.next=i,i.prev=o,i}function TR(s,e,t,i){var n=new Yx(s,e,t);return i?(n.next=i.next,n.prev=i,i.next.prev=n,i.next=n):(n.prev=n,n.next=n),n}function lp(s){s.next.prev=s.prev,s.prev.next=s.next,s.prevZ&&(s.prevZ.nextZ=s.nextZ),s.nextZ&&(s.nextZ.prevZ=s.prevZ)}function Yx(s,e,t){this.i=s,this.x=e,this.y=t,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}cy.deviation=function(s,e,t,i){var n=e&&e.length,o=n?e[0]*t:s.length,a=Math.abs(Kx(s,0,o,t));if(n)for(var l=0,u=e.length;l<u;l++){var c=e[l]*t,h=l<u-1?e[l+1]*t:s.length;a-=Math.abs(Kx(s,c,h,t))}var d=0;for(l=0;l<i.length;l+=3){var f=i[l]*t,p=i[l+1]*t,S=i[l+2]*t;d+=Math.abs((s[f]-s[S])*(s[p+1]-s[f+1])-(s[f]-s[p])*(s[S+1]-s[f+1]))}return a===0&&d===0?0:Math.abs((d-a)/a)};function Kx(s,e,t,i){for(var n=0,o=e,a=t-i;o<t;o+=i)n+=(s[a]-s[o])*(s[o+1]+s[a+1]),a=o;return n}cy.flatten=function(s){for(var e=s[0][0].length,t={vertices:[],holes:[],dimensions:e},i=0,n=0;n<s.length;n++){for(var o=0;o<s[n].length;o++)for(var a=0;a<e;a++)t.vertices.push(s[n][o][a]);n>0&&(i+=s[n-1].length,t.holes.push(i))}return t}});var KR=pn((PGe,Qx)=>{"use strict";Qx.exports=hp;Qx.exports.default=hp;var $h=1e20;function hp(s,e,t,i,n,o){this.fontSize=s||24,this.buffer=e===void 0?3:e,this.cutoff=i||.25,this.fontFamily=n||"sans-serif",this.fontWeight=o||"normal",this.radius=t||8;var a=this.size=this.fontSize+this.buffer*2,l=a+this.buffer*2;this.canvas=document.createElement("canvas"),this.canvas.width=this.canvas.height=a,this.ctx=this.canvas.getContext("2d"),this.ctx.font=this.fontWeight+" "+this.fontSize+"px "+this.fontFamily,this.ctx.textAlign="left",this.ctx.fillStyle="black",this.gridOuter=new Float64Array(l*l),this.gridInner=new Float64Array(l*l),this.f=new Float64Array(l),this.z=new Float64Array(l+1),this.v=new Uint16Array(l),this.useMetrics=this.ctx.measureText("A").actualBoundingBoxLeft!==void 0,this.middle=Math.round(a/2*(navigator.userAgent.indexOf("Gecko/")>=0?1.2:1))}function R4(s,e,t,i,n,o,a){o.fill($h,0,e*t),a.fill(0,0,e*t);for(var l=(e-i)/2,u=0;u<n;u++)for(var c=0;c<i;c++){var h=(u+l)*e+c+l,d=s.data[4*(u*i+c)+3]/255;if(d===1)o[h]=0,a[h]=$h;else if(d===0)o[h]=$h,a[h]=0;else{var f=Math.max(0,.5-d),p=Math.max(0,d-.5);o[h]=f*f,a[h]=p*p}}}function O4(s,e,t,i,n,o,a){for(var l=0;l<e*t;l++){var u=Math.sqrt(i[l])-Math.sqrt(n[l]);s[l]=Math.round(255-255*(u/o+a))}}hp.prototype._draw=function(s,e){var t=this.ctx.measureText(s),i=t.width,n=2*this.buffer,o,a,l,u,c,h,d,f;e&&this.useMetrics?(c=Math.floor(t.actualBoundingBoxAscent),f=this.buffer+Math.ceil(t.actualBoundingBoxAscent),h=this.buffer,d=this.buffer,a=Math.min(this.size,Math.ceil(t.actualBoundingBoxRight-t.actualBoundingBoxLeft)),u=Math.min(this.size-h,Math.ceil(t.actualBoundingBoxAscent+t.actualBoundingBoxDescent)),o=a+n,l=u+n,this.ctx.textBaseline="alphabetic"):(o=a=this.size,l=u=this.size,c=19*this.fontSize/24,h=d=0,f=this.middle,this.ctx.textBaseline="middle");var p;a&&u&&(this.ctx.clearRect(d,h,a,u),this.ctx.fillText(s,this.buffer,f),p=this.ctx.getImageData(d,h,a,u));var S=new Uint8ClampedArray(o*l);return R4(p,o,l,a,u,this.gridOuter,this.gridInner),XR(this.gridOuter,o,l,this.f,this.v,this.z),XR(this.gridInner,o,l,this.f,this.v,this.z),O4(S,o,l,this.gridOuter,this.gridInner,this.radius,this.cutoff),{data:S,metrics:{width:a,height:u,sdfWidth:o,sdfHeight:l,top:c,left:0,advance:i}}};hp.prototype.draw=function(s){return this._draw(s,!1).data};hp.prototype.drawWithMetrics=function(s){return this._draw(s,!0)};function XR(s,e,t,i,n,o){for(var a=0;a<e;a++)YR(s,a,e,t,i,n,o);for(var l=0;l<t;l++)YR(s,l*e,1,e,i,n,o)}function YR(s,e,t,i,n,o,a){var l,u,c,h;for(o[0]=0,a[0]=-$h,a[1]=$h,l=0;l<i;l++)n[l]=s[e+l*t];for(l=1,u=0,c=0;l<i;l++){do h=o[u],c=(n[l]-n[h]+l*l-h*h)/(l-h)/2;while(c<=a[u]&&--u>-1);u++,o[u]=l,a[u]=c,a[u+1]=$h}for(l=0,u=0;l<i;l++){for(;a[u+1]<l;)u++;h=o[u],s[e+l*t]=n[h]+(l-h)*(l-h)}}});function dC(s,e){let t=document.getElementById(s);t.ondragover=i=>{i.preventDefault(),t.classList.add("active")},t.ondragleave=()=>{t.classList.remove("active")},t.ondrop=i=>{i.preventDefault(),t.classList.remove("active");let n=i.dataTransfer.items[0];n.kind==="file"&&e(n.getAsFile())},t.onclick=()=>{let i=document.createElement("input");i.type="file",i.onchange=()=>i.files.length&&e(i.files[0]),i.click()}}var ps=class{bind(e){this.entity&&this.entity.setAttr(e,this)}constructor(e,t){this.entity=e,this.bind(t)}};var Xe=class{};Xe.GeomObjectIndex=0,Xe.DrawingObjectIndex=1,Xe.AlgorithmDataIndex=2,Xe.ViewerIndex=3;var xe=class extends ps{constructor(t){super(t,Xe.GeomObjectIndex)}static getGeom(t){return t.getAttr(Xe.GeomObjectIndex)}get parent(){let t=this.entity.parent;return t?xe.getGeom(t):null}rebind(t){this.entity=t,this.bind(Xe.GeomObjectIndex)}*getAncestors(){let t=this.parent;for(;t!=null;)yield t,t=t.parent}};var S0=class{static solve(e,t,i,n,o,a){let l=e*o-n*t;if(!(Math.abs(l)<S0.eps))return{x:(i*o-a*t)/l,y:(e*a-n*i)/l}}},mn=S0;mn.eps=1e-8;var jp=class{},R=jp;R.distanceEpsilonPrecision=6,R.mult=Math.pow(10,6),R.defaultLeafBoxesOffset=.5,R.lineSegmentThreshold=.05,R.intersectionEpsilon=1e-4,R.distanceEpsilon=Math.pow(10,-jp.distanceEpsilonPrecision),R.squareOfDistanceEpsilon=Math.pow(10,-jp.distanceEpsilonPrecision*2),R.tolerance=1e-8;function fC(s,e){return(s?1:0)-(e?1:0)}function _e(s,e){let t=s-e;return t<0?-1:t===0?0:1}function xc(s,e){let t=_e(s.y,e.y);return t||_e(s.x,e.x)}function ue(s,e){let t=s-e;return-R.distanceEpsilon<=t&&t<=R.distanceEpsilon}function qp(s,e){return wd(s,e)>0}function wd(s,e){let t=s-e;return t<=-R.distanceEpsilon?-1:t>=R.distanceEpsilon?1:0}function ze(s,e){return s.sub(e).length}var m=class{static RoundPoint(e){return new m(m.RoundDouble(e.x),m.RoundDouble(e.y))}static RoundDouble(e){return Math.round(e*R.mult)/R.mult}toJSON(){return{x:this.x,y:this.y}}static fromJSON(e){return new m(e.x,e.y)}static ProjectionToLine(e,t,i){let n=t.sub(e),o=n.length;if(o<R.distanceEpsilon)return e;n=n.div(o);let a=i.sub(e).dot(n);return e.add(n.mul(a))}static RayIntersectsRayInteriors(e,t,i,n){let o=m.lineLineIntersection(e,e.add(t),i,i.add(n));if(!!o&&o.sub(e).dot(t.div(t.l1))>R.distanceEpsilon&&o.sub(i).dot(n.div(n.l1))>R.distanceEpsilon)return o}static IntervalIntersectsRay(e,t,i,n){let o=m.lineLineIntersection(e,t,i,i.add(n));if(!o)return;let a=e.sub(o),l=o.sub(t);if(!(a.dot(l)<=0)&&!(o.sub(i).dot(n)<0)&&a.dot(a)>R.squareOfDistanceEpsilon&&l.dot(l)>=R.squareOfDistanceEpsilon)return o}static PointToTheLeftOfLineOrOnLine(e,t,i){return m.signedDoubledTriangleArea(e,t,i)>=0}static PointToTheLeftOfLine(e,t,i){return m.signedDoubledTriangleArea(e,t,i)>0}static PointIsInsideCone(e,t,i,n){return m.PointToTheRightOfLineOrOnLine(e,t,i)&&m.PointToTheLeftOfLineOrOnLine(e,t,n)}static PointToTheRightOfLineOrOnLine(e,t,i){return m.signedDoubledTriangleArea(t,i,e)<=0}static PointToTheRightOfLine(e,t,i){return m.signedDoubledTriangleArea(t,i,e)<0}static closeIntersections(e,t){return m.close(e,t,R.intersectionEpsilon)}get l1(){return Math.abs(this.x_)+Math.abs(this.y_)}dot(e){return this.x*e.x+this.y*e.y}get x(){return this.x_}get y(){return this.y_}compareTo(e){let t=_e(this.x,e.x);return t!==0?t:_e(this.y,e.y)}toString(){return"("+this.x+","+this.y+")"}static close(e,t,i){return e.sub(t).length<=i}static closeSquare(e,t,i){let n=t.sub(e);return n.dot(n)<=i}static closeDistEps(e,t,i=R.distanceEpsilon){return e.sub(t).length<=i}normalize(){let e=this.length;return new m(this.x/e,this.y/e)}get length(){return Math.sqrt(this.x*this.x+this.y*this.y)}get lengthSquared(){return this.x*this.x+this.y*this.y}constructor(e,t){this.x_=e,this.y_=t}static middle(e,t){return e.add(t).div(2)}scale(e,t){return new m(this.x*e,this.y*t)}add(e){return new m(this.x+e.x,this.y+e.y)}sub(e){return new m(this.x-e.x,this.y-e.y)}mul(e){return new m(this.x*e,this.y*e)}div(e){return new m(this.x/e,this.y/e)}equal(e){return e.x===this.x&&e.y===this.y}neg(){return new m(-this.x,-this.y)}static lineLineIntersection(e,t,i,n){let o=t.sub(e),a=i.sub(n),l=i.sub(e),u=mn.solve(o.x,a.x,l.x,o.y,a.y,l.y);if(u!==void 0)return e.add(o.mul(u.x))}static segSegIntersection(e,t,i,n){let o=t.sub(e),a=i.sub(n),l=i.sub(e),u=R.tolerance,c=mn.solve(o.x,a.x,l.x,o.y,a.y,l.y);if(c!==void 0&&c.x>-u&&c.x<1+u&&c.y>-u&&c.y<1+u)return e.add(o.mul(c.x))}static parallelWithinEpsilon(e,t,i){let n=e.length,o=t.length;return n<i||o<i?!0:(e=e.div(n),t=t.div(o),Math.abs(-e.x*t.y+e.y*t.x)<i)}static crossProduct(e,t){return e.x*t.y-e.y*t.x}static dot(e,t){return e.x*t.x+e.y*t.y}static add(e,t){return e.add(t)}rotate90Ccw(){return new m(-this.y,this.x)}rotate90Cw(){return new m(this.y,-this.x)}clone(){return new m(this.x,this.y)}rotate(e){let t=Math.cos(e),i=Math.sin(e);return new m(t*this.x-i*this.y,i*this.x+t*this.y)}static mkPoint(e,t,i,n){return t.mul(e).add(n.mul(i))}static convSum(e,t,i){return t.add(i.sub(t).mul(e))}static anglePCP(e,t,i){return m.angle(e.sub(t),i.sub(t))}static angle(e,t){let i=e.x,n=e.y,o=t.x,a=t.y,l=i*a-n*o,u=i*o+n*a;if(Math.abs(u)<R.tolerance)return Math.abs(l)<R.tolerance?0:l<-R.tolerance?3*Math.PI/2:Math.PI/2;if(Math.abs(l)<R.tolerance)return u<-R.tolerance?Math.PI:0;let c=Math.atan2(l,u);return l>=-R.tolerance?c:Math.PI*2+c}static signedDoubledTriangleArea(e,t,i){return(t.x-e.x)*(i.y-e.y)-(i.x-e.x)*(t.y-e.y)}static getTriangleOrientation(e,t,i){let n=m.signedDoubledTriangleArea(e,t,i);return n>R.distanceEpsilon?1:n<-R.distanceEpsilon?0:2}static getTriangleOrientationWithIntersectionEpsilon(e,t,i){let n=m.signedDoubledTriangleArea(e,t,i);return n>R.intersectionEpsilon?1:n<-R.intersectionEpsilon?0:2}static ClosestPointAtLineSegment(e,t,i){let n=i.sub(t),o=e.sub(t),a=n.dot(o),l=n.dot(n);return a<=0+R.tolerance?t:l<=a+R.tolerance?i:t.add(n.mul(a/l))}static pointToTheLeftOfLineOrOnLine(e,t,i){return m.signedDoubledTriangleArea(e,t,i)>=0}static pointToTheLeftOfLine(e,t,i){return m.signedDoubledTriangleArea(e,t,i)>0}static pointToTheRightOfLineOrOnLine(e,t,i){return m.signedDoubledTriangleArea(t,i,e)<=0}static pointToTheRightOfLine(e,t,i){return m.signedDoubledTriangleArea(t,i,e)<0}static canProject(e,t,i){let n=i.sub(t);return!(e.sub(t).dot(n)<0||e.sub(i).dot(n)>0)}static distToLineSegment(e,t,i){let n=i.sub(t),o=e.sub(t),a,l;if((a=n.dot(o))<=R.tolerance)return{par:0,dist:o.length};if((l=n.dot(n))<=a+R.tolerance)return{par:1,dist:e.sub(i).length};let u=a/l;return{par:u,dist:t.add(n.mul(u)).length}}};var Kt=class{constructor(){this._next=null;this.prev=null}get point(){return this._point}set point(e){this._point=e}get next(){return this._next}set next(e){this._next=e}get nextOnPolyline(){return this.polyline.next(this)}get prevOnPolyline(){return this.polyline.prev(this)}getNext(){return this.next}setNext(e){this.next=e,this.polyline!=null&&this.polyline.setInitIsRequired()}getPrev(){return this.prev}setPrev(e){this.prev=e,this.polyline!=null&&this.polyline.setInitIsRequired()}static mkFromPoint(e){let t=new Kt;return t.point=e,t}};var Le=class{contains(e){let t=e.sub(this.corner),i=R.distanceEpsilon,n=t.dot(this.bRot);if(n>this.abRot+i||n<-i)return!1;let o=t.dot(this.aRot);return o<=this.baRot+i&&o>=-i}get area(){return Math.abs(this.a.x*this.b.y-this.a.y*this.b.x)}vertex(e){switch(e){case 0:return this.corner;case 1:return this.aPlusCorner;case 2:return this.otherCorner;case 3:return this.bPlusCorner;default:return}}static parallelogramOfTwo(e,t){let i=new Le,n=e.corner,o={minx:n.x,maxx:n.x,miny:n.y,maxy:n.y};return Le.pumpMinMax(o,e.aPlusCorner),Le.pumpMinMax(o,e.otherCorner),Le.pumpMinMax(o,e.bPlusCorner),Le.pumpMinMax(o,t.corner),Le.pumpMinMax(o,t.aPlusCorner),Le.pumpMinMax(o,t.otherCorner),Le.pumpMinMax(o,t.bPlusCorner),i.corner=new m(o.minx,o.miny),i.a=new m(0,o.maxy-o.miny),i.b=new m(o.maxx-o.minx,0),i.aPlusCorner=i.a.add(i.corner),i.otherCorner=i.b.add(i.aPlusCorner),i.bPlusCorner=i.b.add(i.corner),i.aRot=new m(-i.a.y,i.a.x),i.aRot.length>.5&&(i.aRot=i.aRot.normalize()),i.bRot=new m(-i.b.y,i.b.x),i.bRot.length>.5&&(i.bRot=i.bRot.normalize()),i.abRot=i.a.dot(i.bRot),i.baRot=i.b.dot(i.aRot),i.abRot<0&&(i.abRot=-i.abRot,i.bRot=i.bRot.neg()),i.baRot<0&&(i.baRot=-i.baRot,i.aRot=i.aRot.neg()),i.isSeg=i.a.sub(i.b).length<R.distanceEpsilon,i}static pumpMinMax(e,t){t.x<e.minx?e.minx=t.x:t.x>e.maxx&&(e.maxx=t.x),t.y<e.miny?e.miny=t.y:t.y>e.maxy&&(e.maxy=t.y)}static intersect(e,t){return!(Le.separByA(e,t)||Le.separByA(t,e)||Le.separByB(e,t)||Le.separByB(t,e))===!1?!1:!(e.isSeg&&t.isSeg)||!m.parallelWithinEpsilon(e.otherCorner.sub(e.corner),t.otherCorner.sub(t.corner),1e-5)?!0:Le.ParallelSegsIntersect(t,e)}static ParallelSegsIntersect(e,t){let i=e.corner,n=e.otherCorner,o=t.corner,a=t.otherCorner,l=n.sub(i),u=0,c=l.dot(l),h=o.sub(i).dot(l),d=a.sub(i).dot(l);if(h>d){let f=h;h=d,d=f}return!(d<u-R.distanceEpsilon||h>c+R.distanceEpsilon)}static separByB(e,t){let i=R.distanceEpsilon,n=t.vertex(0).sub(e.corner).dot(e.bRot),o=[1,2,3];if(n>e.abRot+i){for(let a of o)if(t.vertex(a).sub(e.corner).dot(e.bRot)<=e.abRot+i)return!1;return!0}else if(n<-i){for(let a of o)if(t.vertex(a).sub(e.corner).dot(e.bRot)>=-i)return!1;return!0}return!1}static separByA(e,t){let i=R.distanceEpsilon,n=t.corner.sub(e.corner),o=m.dot(n,e.aRot);return o>e.baRot+i?(n=t.aPlusCorner.sub(e.corner),!(m.dot(n,e.aRot)<=e.baRot+i||(n=t.bPlusCorner.sub(e.corner),m.dot(n,e.aRot)<=e.baRot+i)||(n=t.otherCorner.sub(e.corner),m.dot(n,e.aRot)<=e.baRot+i))):o<-i?(n=t.aPlusCorner.sub(e.corner),!(m.dot(n,e.aRot)>=-i||(n=t.bPlusCorner.sub(e.corner),m.dot(n,e.aRot)>=-i)||(n=t.otherCorner.sub(e.corner),m.dot(n,e.aRot)>=-i))):!1}static parallelogramByCornerSideSide(e,t,i){let n=new Le;return n.corner=e,n.a=t,n.b=i,n.aRot=new m(-t.y,t.x),n.aRot.length>.5&&(n.aRot=n.aRot.normalize()),n.bRot=new m(-i.y,i.x),n.bRot.length>.5&&(n.bRot=n.bRot.normalize()),n.abRot=n.bRot.dot(t),n.baRot=i.dot(n.aRot),n.abRot<0&&(n.abRot=-n.abRot,n.bRot=n.bRot.neg()),n.baRot<0&&(n.baRot=-n.baRot,n.aRot=n.aRot.neg()),n.isSeg=t.sub(i).length<R.distanceEpsilon,n.aPlusCorner=t.add(e),n.otherCorner=i.add(n.aPlusCorner),n.bPlusCorner=i.add(e),n}static getParallelogramOfAGroup(e){let t=0,i=0,n=0,o=0,a=!0;for(let l of e){let u=v_(l);for(let c of u){let h=c.x,d=c.y;a?(a=!1,t=i=h,n=o=d):(h<t?t=h:h>i&&(i=h),d<n?n=d:d>o&&(o=d))}}return Le.parallelogramByCornerSideSide(new m(t,n),new m(0,o-n),new m(i-t,0))}};function*v_(s){yield s.corner,yield s.aPlusCorner,yield s.otherCorner,yield s.bPlusCorner}var k=class{constructor(e,t,i,n){this.parStart=0;this.parEnd=1;this.start=new m(e,t),this.end=new m(i,n)}static fromJSON(e){return k.mkPP(m.fromJSON(e.start),m.fromJSON(e.end))}toJSON(){return{start:this.start.toJSON(),end:this.end.toJSON()}}offsetCurve(e,t){return null}trim(e,t){if(e=Math.max(this.parStart,e),t=Math.min(this.parEnd,t),e>t)throw"wrong params in trimming";let i=this.value(e),n=this.value(t);return m.close(i,n,R.distanceEpsilon)?null:k.mkPP(i,n)}value(e){return this.start.add(this.end.sub(this.start).mul(e))}trimWithWrap(e,t){return null}pNodeOverICurve(){let e=this.end.sub(this.start).mul(.5);return{parallelogram:Le.parallelogramByCornerSideSide(this.start,e,e),seg:this,leafBoxesOffset:0,node:{low:0,high:1,chord:this}}}normal(){let e=this.start.sub(this.end);return e=e.div(e.length),new m(-e.y,e.x)}static mkPP(e,t){return new k(e.x,e.y,t.x,t.y)}static mkLinePXY(e,t,i){return new k(e.x,e.y,t,i)}derivative(e){return this.end.sub(this.start)}secondDerivative(e){return new m(0,0)}thirdDerivative(e){return new m(0,0)}reverse(){return k.mkPP(this.end,this.start)}translate(e){this.start=this.start.add(e),this.end=this.end.add(e)}scaleFromOrigin(e,t){return k.mkPP(this.start.scale(e,t),this.end.scale(e,t))}getParameterAtLength(e){let t=this.end.sub(this.start).length;if(t<R.tolerance)return 0;let i=e/t;return i>1?1:i<0?0:i}transform(e){return k.mkPP(e.multiplyPoint(this.start),e.multiplyPoint(this.end))}closestParameterWithinBounds(e,t,i){let n=this.closestParameter(e);return n<t&&(n=t),n>i&&(n=i),n}lengthPartial(e,t){return this.value(t).sub(this.value(e)).length}get length(){return this.start.sub(this.end).length}get boundingBox(){return X.mkPP(this.start,this.end)}clone(){return k.mkPP(this.start.clone(),this.end.clone())}static closestParameterOnLineSegment(e,t,i){let n=i.sub(t),o=e.sub(t),a=n.dot(o);if(a<=0+R.tolerance)return 0;let l=n.dot(n);return l<=a+R.tolerance?1:a/l}closestParameter(e){return k.closestParameterOnLineSegment(e,this.start,this.end)}leftDerivative(e){return this.derivative(e)}rightDerivative(e){return this.derivative(e)}static IntersectPPPP(e,t,i,n){let o=m.lineLineIntersection(e,t,i,n);if(o!=null&&vc(o,e,t)&&vc(o,i,n))return o}curvature(e){return 0}curvatureDerivative(e){return 0}curvatureSecondDerivative(e){return 0}static minDistBetweenLineSegments(e,t,i,n){let o=t.sub(e),a=n.sub(i),l=e.sub(i),u=m.crossProduct(o,a),c=o.dot(o),h=o.dot(a),d=a.dot(a),f=o.dot(l),p=a.dot(l),S,E,C=Math.abs(u),O=C,B=C;C<R.tolerance?(S=0,O=1,E=p,B=d):(S=m.crossProduct(a,l),E=m.crossProduct(o,l),u<0&&(S=-S,E=-E),S<0?(S=0,E=p,B=d):S>O&&(S=O=1,E=p+h,B=d)),E<0?(E=0,-f<0?S=0:-f>c?S=O:(S=-f,O=c)):E>B&&(E=B=1,-f+h<0?S=0:-f+h>c?S=O:(S=-f+h,O=c));let A=Math.abs(S)<R.tolerance?0:S/O,N=Math.abs(E)<R.tolerance?0:E/B;return{parab:A,parcd:N,dist:l.add(o.mul(A).sub(a.mul(N))).length}}};function vc(s,e,t){return s.x>=Math.min(e.x,t.x)-R.distanceEpsilon&&s.y>=Math.min(e.y,t.y)-R.distanceEpsilon&&s.x<=Math.max(e.x,t.x)+R.distanceEpsilon&&s.y<=Math.max(e.y,t.y)+R.distanceEpsilon}function Xp(s,e,t,i){let n=m.getTriangleOrientation(s,e,t),o=m.getTriangleOrientation(s,e,i),a=m.getTriangleOrientation(t,i,s),l=m.getTriangleOrientation(t,i,e);return!!(n!=o&&a!=l||n==2&&vc(t,s,e)||o==2&&vc(i,s,e)||a==2&&vc(s,t,i)||l==2&&vc(e,t,i))}function C_(s,e,t,i,n){return{parallelogram:t,seg:i,leafBoxesOffset:n,node:{low:s,high:e,chord:null}}}var ht=class{static distToSegm(e,t,i){let n=i.sub(t);if(n.length<R.intersectionEpsilon)return e.sub(t.add(i).div(2)).length;let o=new m(-n.y,n.x);return o=o.mul(1/o.length),Math.abs(e.sub(t).dot(o))}static createParallelogramOnSubSeg(e,t,i){let n=i.derivative(e),o=i.derivative(t),a=new m(-o.y,o.x),l=i.value(e),u=i.value(t),h=u.sub(l).dot(a),d=n.dot(a),f=Math.abs(h)<R.distanceEpsilon;if(!f&&Math.abs(d)<R.distanceEpsilon)return;let p=f?0:h/d;return n=n.mul(p),Le.parallelogramByCornerSideSide(l,n,u.sub(l).sub(n))}static createParallelogramNodeForCurveSeg(e,t,i,n){if(e===i.parStart&&t===i.parEnd&&m.close(i.start,i.end,R.distanceEpsilon))return ht.createNodeWithSegmentSplit(e,t,i,n);let a=i.value(e),l=i.value(t),u=l.sub(a),c=i.value((e+t)/2);if(ht.distToSegm(c,a,l)<=R.intersectionEpsilon&&u.dot(u)<R.lineSegmentThreshold*R.lineSegmentThreshold&&t-e<R.lineSegmentThreshold){let h=k.mkPP(a,l),d=h.pNodeOverICurve();d.seg=i;let f=d.node;return f.low=e,f.high=t,f.chord=h,d}if(ht.WithinEpsilon(i,e,t,n)){let h=ht.createParallelogramOnSubSeg(e,t,i);if(h!==void 0)return C_(e,t,h,i,n)}return ht.createNodeWithSegmentSplit(e,t,i,n)}static WithinEpsilon(e,t,i,n){let a=(i-t)/3,l=e.value(t),u=e.value(i);return ht.distToSegm(e.value(t+a),l,u)>n?!1:ht.distToSegm(e.value(t+a*(3-1)),l,u)<=n}static createParallelogramNodeForCurveSegDefaultOffset(e){return ht.createParallelogramNodeForCurveSeg(e.parStart,e.parEnd,e,R.defaultLeafBoxesOffset)}static createNodeWithSegmentSplit(e,t,i,n){let o={parallelogram:null,seg:i,leafBoxesOffset:1,node:{children:[]}},a=o.node;return a.children.push(ht.createParallelogramNodeForCurveSeg(e,.5*(e+t),i,n)),a.children.push(ht.createParallelogramNodeForCurveSeg(.5*(e+t),t,i,n)),o.parallelogram=Le.parallelogramOfTwo(a.children[0].parallelogram,a.children[1].parallelogram),o}};var bn=class{constructor(e,t,i,n,o){this.par0=e,this.par1=t,this.x=i,this.seg0=n,this.seg1=o}};var la=class{static closestPoint(e,t,i,n,o){let u=i,c=0,h=0,d,f=!1;do{let p=e.value(u),S=e.derivative(u),E=e.secondDerivative(u),C=S.dot(S)+p.sub(t).dot(E);if(Math.abs(C)<R.tolerance)return u;d=p.sub(t).dot(S.div(C)),u-=d,u>o+R.tolerance?(u=o,h++):u<n-R.tolerance&&(u=n,h++),c++}while(Math.abs(d)>R.tolerance&&!(f=c>=5||h>=5));return f&&e.value(i).sub(t).length<R.distanceEpsilon&&(u=i),u}};var pe=class{isFullEllipse(){return this.parEnd===Math.PI*2&&this.parStart===0}static fromJSON(e){return new pe(e.parStart,e.parEnd,m.fromJSON(e.axis0),m.fromJSON(e.axis1),m.fromJSON(e.center))}toJSON(){return{parStart:this.parStart,parEnd:this.parEnd,axis0:this.aAxis.toJSON(),axis1:this.bAxis.toJSON(),center:this.center.toJSON()}}offsetCurve(e,t){let i=t.sub(this.center),n=m.angle(this.aAxis,i);if(this.aAxis.mul(Math.cos(n)).add(this.bAxis.mul(Math.sin(n))).length<i.length){let a=this.aAxis.length,l=this.bAxis.length;return pe.mkEllipsePPP(this.aAxis.normalize().mul(a+e),this.bAxis.normalize().mul(l+e),this.center)}{let a=this.aAxis.length,l=this.bAxis.length;return pe.mkEllipsePPP(this.aAxis.normalize().mul(a-e),this.bAxis.normalize().mul(l-e),this.center)}}reverse(){return null}static mkEllipsePPP(e,t,i){return new pe(0,Math.PI*2,e,t,i)}constructor(e,t,i,n,o){for(this.parStart=e,this.parEnd=t,this.aAxis=i,this.bAxis=n,this.center=o,this.pNode=null,this.setBoundingBox();this.parStart<0;)this.parStart+=Math.PI*2,this.parEnd+=Math.PI*2}get start(){return this.value(this.parStart)}get end(){return this.value(this.parEnd)}trim(e,t){return new pe(Math.max(e,this.parStart),Math.min(t,this.parEnd),this.aAxis,this.bAxis,this.center)}trimWithWrap(e,t){return null}get boundingBox(){return this.box}value(e){return this.center.add(m.mkPoint(Math.cos(e),this.aAxis,Math.sin(e),this.bAxis))}derivative(e){return m.mkPoint(-Math.sin(e),this.aAxis,Math.cos(e),this.bAxis)}secondDerivative(e){return m.mkPoint(-Math.cos(e),this.aAxis,-Math.sin(e),this.bAxis)}thirdDerivative(e){return m.mkPoint(Math.sin(e),this.aAxis,-Math.cos(e),this.bAxis)}pNodeOverICurve(){return this.pNode!=null?this.pNode:this.pNode=ht.createParallelogramNodeForCurveSegDefaultOffset(this)}setBoundingBox(){if(ue(this.parStart,0)&&ue(this.parEnd,Math.PI*2))this.box=this.fullBox();else{this.box=X.mkPP(this.start,this.end);let e;for(let t=Math.ceil(this.parStart/(Math.PI/2));(e=t*Math.PI/2)<this.parEnd;t++)e>this.parStart&&this.box.add(this.value(e))}}static mkEllipse(e,t,i,n,o,a){return new pe(e,t,i,n,new m(o,a))}static mkFullEllipsePPP(e,t,i){return new pe(0,Math.PI*2,e,t,i)}static mkFullEllipseNNP(e,t,i){return new pe(0,Math.PI*2,new m(e,0),new m(0,t),i)}static mkCircle(e,t){return pe.mkFullEllipseNNP(e,e,t)}translate(e){this.center=this.center.add(e),this.box.center=this.box.center.add(e),this.pNode=null}scaleFromOrigin(e,t){return new pe(this.parStart,this.parEnd,this.aAxis.mul(e),this.bAxis.mul(t),this.center.scale(e,t))}getParameterAtLength(e){let i=this.parStart,n=this.parEnd,o=e+.001,a=e-.001;for(;n-i>R.distanceEpsilon;){let l=.5*(n+i),u=this.lengthPartial(this.parStart,l);if(u>o)n=l;else if(u<a)i=l;else return l}return(n+i)/2}transform(e){if(e!=null){let t=e.multiplyPoint(this.aAxis).sub(e.offset()),i=e.multiplyPoint(this.bAxis).sub(e.offset());return new pe(this.parStart,this.parEnd,t,i,e.multiplyPoint(this.center))}return this.clone()}closestParameterWithinBounds(e,t,i){let o=(i-t)/9,a=t,l=Number.MAX_VALUE;for(let c=0;c<=8;c++){let h=t+c*o,d=e.sub(this.value(h)),f=d.dot(d);f<l&&(l=f,a=h)}a===0&&i===Math.PI*2&&(t=-Math.PI);let u=la.closestPoint(this,e,a,t,i);return u<0&&(u+=2*Math.PI),u}lengthPartial(e,t){return I.lengthWithInterpolationAndThreshold(this.trim(e,t),R.lineSegmentThreshold/100)}get length(){return(this.aAxis.length+this.bAxis.length)*Math.abs(this.parEnd-this.parStart)/2}clone(){return new pe(this.parStart,this.parEnd,this.aAxis.clone(),this.bAxis.clone(),this.center.clone())}closestParameter(e){let t=0,i=8,n=(this.parEnd-this.parStart)/(i+1),o=this.parStart,a=Number.MAX_VALUE;for(let c=0;c<=i;c++){let h=this.parStart+c*n,d=e.sub(this.value(h)),f=d.dot(d);f<a&&(a=f,o=h)}let l=!1;o===0&&this.parEnd===Math.PI*2&&(l=!0,t=this.parStart,this.parStart=-Math.PI);let u=la.closestPoint(this,e,o,this.parStart,this.parEnd);return u<0&&(u+=2*Math.PI),l&&(this.parStart=t),u}leftDerivative(e){return this.derivative(e)}rightDerivative(e){return this.derivative(e)}curvature(e){throw"NotImplementedException()"}curvatureDerivative(e){throw"NotImplementedException();"}curvatureSecondDerivative(e){throw"NotImplementedException()"}orientedCounterclockwise(){return m.crossProduct(this.aAxis,this.bAxis)>0}fullBox(){let e=this.aAxis.add(this.bAxis);return X.mkPP(this.center.add(e),this.center.sub(e))}isArc(){return Math.abs(this.aAxis.dot(this.bAxis))<R.tolerance&&Math.abs(this.aAxis.length-this.bAxis.length)<R.tolerance&&m.closeDistEps(this.aAxis.rotate90Ccw(),this.bAxis)}};var Yp=class{initValues(){this.a=this.curveA.value(this.si),this.b=this.curveB.value(this.ti),this.a_b=this.a.sub(this.b),this.ad=this.curveA.derivative(this.si),this.add=this.curveA.secondDerivative(this.si),this.bd=this.curveB.derivative(this.ti),this.bdd=this.curveB.secondDerivative(this.ti)}constructor(e,t,i,n,o,a,l,u){this.curveA=e,this.curveB=t,this.aMin=i,this.bMin=o,this.aMax=n,this.bMax=a,this.aGuess=l,this.bGuess=u,this.si=l,this.ti=u}Fs(){return this.a_b.dot(this.ad)}Fss(){return this.a_b.dot(this.add)+this.ad.dot(this.ad)}Fst(){return-this.bd.dot(this.ad)}Ftt(){return-this.a_b.dot(this.bdd)+this.bd.dot(this.bd)}Ft(){return-this.a_b.dot(this.bd)}delta(e,t,i,n){return e*n-i*t}solve(){let e=0,t=10,i=0,n=100,o=!1;if(this.initValues(),this.curveA instanceof k&&this.curveB instanceof k){let l=this.curveB.derivative(0);l=l.div(l.length);let u=this.curveA.normal(),c=Math.abs(u.dot(l));if(Math.abs(c)<R.distanceEpsilon||this.delta(this.Fss(),this.Fst(),this.Fst(),this.Ftt())<R.tolerance){this.success=!0,this.parallelLineSegLineSegMinDist();return}}let a;do{let l=this.delta(this.Fss(),this.Fst(),this.Fst(),this.Ftt());if(Math.abs(l)<R.tolerance){this.success=!1,o=!0;break}a={s:this.delta(-this.Fs(),this.Fst(),-this.Ft(),this.Ftt())/l,t:this.delta(this.Fss(),-this.Fs(),this.Fst(),-this.Ft())/l};let u=this.si+a.s,c=this.ti+a.t,h;u>this.aMax+R.distanceEpsilon||u<this.aMin-R.distanceEpsilon||c>this.bMax+R.distanceEpsilon||c<this.bMin-R.distanceEpsilon?(e++,this.chopDsDt(a),this.si+=a.s,this.ti+=a.t,h=!0):(h=!1,this.si=u,this.ti=c,this.si>this.aMax?this.si=this.aMax:this.si<this.aMin&&(this.si=this.aMin),this.ti>this.bMax?this.ti=this.bMax:this.ti<this.bMin&&(this.ti=this.bMin)),this.initValues(),i++,o=e>=t||i>=n||a.s===0&&a.t===0&&h}while((Math.abs(a.s)>=R.tolerance||Math.abs(a.t)>=R.tolerance)&&!o);if(o){let l=this.curveA.value(this.aGuess).sub(this.curveB.value(this.bGuess));if(l.dot(l)<R.distanceEpsilon*R.distanceEpsilon){this.aSolution=this.aGuess,this.bSolution=this.bGuess,this.aPoint=this.curveA.value(this.aGuess),this.bPoint=this.curveB.value(this.bGuess),this.success=!0;return}}this.aSolution=this.si,this.bSolution=this.ti,this.aPoint=this.a,this.bPoint=this.b,this.success=!o}chopDsDt(e){if(e.s!==0&&e.t!==0){let t=1;this.si+e.s>this.aMax?t=(this.aMax-this.si)/e.s:this.si+e.s<this.aMin&&(t=(this.aMin-this.si)/e.s);let i=1;this.ti+e.t>this.bMax?i=(this.bMax-this.ti)/e.t:this.ti+e.t<this.bMin&&(i=(this.bMin-this.ti)/e.t);let n=Math.min(t,i);e.s*=n,e.t*=n}else e.s===0?this.ti+e.t>this.bMax?e.t=this.bMax-this.ti:this.ti+e.t<this.bMin&&(e.t=this.bMin-this.ti):this.si+e.s>this.aMax?e.s=this.aMax-this.si:this.si+e.s<this.aMin&&(e.s=this.aMin-this.si)}parallelLineSegLineSegMinDist(){let e=this.curveA,t=this.curveB,i=e.start,n=e.end,o=t.start,a=t.end,l=n.sub(i),u=l.length,c=0,h,d,f;if(u>R.distanceEpsilon){l=l.div(u),h=l.dot(n.sub(i)),d=l.dot(o.sub(i)),f=l.dot(a.sub(i));let p=!1;if(d>f){p=!0;let S=d;d=f,f=S}if(f<c)this.aSolution=0,this.bSolution=p?0:1;else if(d>h)this.aSolution=1,this.bSolution=p?1:0;else{let S=Math.min(h,f);this.aSolution=S/(h-c),this.bSolution=(S-d)/(f-d),p&&(this.bSolution=1-this.bSolution)}}else{let p=a.sub(o),S=p.length;if(S>R.distanceEpsilon)if(p=p.div(S),c=0,h=p.dot(a.sub(o)),d=p.dot(i.sub(o)),d<c)this.bSolution=0,this.aSolution=1;else if(d>h)this.bSolution=1,this.aSolution=0;else{let E=Math.min(h,d);this.bSolution=E/(h-c),this.aSolution=0}else this.aSolution=0,this.bSolution=0}this.aPoint=this.curveA.value(this.aSolution),this.bPoint=this.curveB.value(this.bSolution)}};var Me=class{constructor(e,t,i,n){this.b=new Array(4);this.parStart=0;this.parEnd=1;this.b[0]=e,this.b[1]=t,this.b[2]=i,this.b[3]=n,this.c=this.b[1].sub(this.b[0]).mul(3),this.e=this.b[2].sub(this.b[1]).mul(3).sub(this.c),this.l=this.b[3].sub(this.b[0]).sub(this.c).sub(this.e)}toJSON(){return{b:this.b.map(e=>e.toJSON())}}static fromJSON(e){return Me.mkBezier(e.b.map(m.fromJSON))}leftDerivative(e){return this.derivative(e)}rightDerivative(e){return this.derivative(e)}B(e){return this.b[e]}pNodeOverICurve(){return this.pBoxNode!=null?this.pBoxNode:this.pBoxNode=ht.createParallelogramNodeForCurveSegDefaultOffset(this)}value(e){let t=e*e,i=t*e;return this.l.mul(i).add(this.e.mul(t).add(this.c.mul(e)).add(this.b[0]))}static adjustParamTo01(e){return e>1?1:e<0?0:e}trim(e,t){if(e=Me.adjustParamTo01(e),t=Me.adjustParamTo01(t),e>t)return this.trim(t,e);if(e>1-R.tolerance)return new Me(this.b[3],this.b[3],this.b[3],this.b[3]);let i=new Array(3),n=new Array(2),o=this.casteljau(e,i,n),a=new Me(o,n[1],i[2],this.b[3]),l=a.casteljau((t-e)/(1-e),i,n);return new Me(a.b[0],i[0],n[0],l)}trimWithWrap(e,t){throw"NotImplementedException()"}casteljau(e,t,i){let n=1-e;for(let o=0;o<3;o++)t[o]=m.mkPoint(n,this.b[o],e,this.b[o+1]);for(let o=0;o<2;o++)i[o]=m.mkPoint(n,t[o],e,t[o+1]);return m.mkPoint(n,i[0],e,i[1])}derivative(e){return this.l.mul(3*e*e).add(this.e.mul(2*e)).add(this.c)}secondDerivative(e){return m.mkPoint(6*e,this.l,2,this.e)}thirdDerivative(e){return this.l.mul(6)}get start(){return this.b[0]}get end(){return this.b[3]}reverse(){return new Me(this.b[3],this.b[2],this.b[1],this.b[0])}translate(e){this.b[0]=this.b[0].add(e),this.b[1]=this.b[1].add(e),this.b[2]=this.b[2].add(e),this.b[3]=this.b[3].add(e),this.c=this.b[1].sub(this.b[0]).mul(3),this.e=this.b[2].sub(this.b[1]).mul(3).sub(this.c),this.l=this.b[3].sub(this.b[0]).sub(this.c).sub(this.e),this.bbox&&(this.bbox=X.translate(this.bbox,e)),this.pBoxNode=null}scaleFromOrigin(e,t){return new Me(this.b[0].scale(e,t),this.b[1].scale(e,t),this.b[2].scale(e,t),this.b[3].scale(e,t))}offsetCurve(e,t){return null}lengthPartial(e,t){return this.trim(e,t).length}get length(){return Me.lengthOnControlPolygon(this.b[0],this.b[1],this.b[2],this.b[3])}static lengthOnControlPolygon(e,t,i,n){let o=n.sub(e).length,a=t.sub(e).length+i.sub(t).length+n.sub(i).length;if(a-o>R.lineSegmentThreshold){let l=m.middle(e,t),u=m.middle(t,i),c=m.middle(i,n),h=m.middle(l,u),d=m.middle(c,u),f=m.middle(h,d);return Me.lengthOnControlPolygon(e,l,h,f)+Me.lengthOnControlPolygon(f,d,c,n)}return(a+o)/2}get boundingBox(){return this.bbox?this.bbox:this.bbox=X.mkOnPoints(this.b)}transform(e){return new Me(e.multiplyPoint(this.b[0]),e.multiplyPoint(this.b[1]),e.multiplyPoint(this.b[2]),e.multiplyPoint(this.b[3]))}closestParameterWithinBounds(e,t,i){let n=(i-t)/8,o=0,a=Number.MAX_VALUE;for(let l=0;l<9;l++){let u=e.sub(this.value(l*n+t)),c=u.dot(u);c<a&&(a=c,o=l*n+t)}return la.closestPoint(this,e,o,t,i)}clone(){return new Me(this.b[0],this.b[1],this.b[2],this.b[3])}static mkBezier(e){return new Me(e[0],e[1],e[2],e[3])}curvature(e){let t=this.G(e);return this.F(e)/t}F(e){return this.Xp(e)*this.Ypp(e)-this.Yp(e)*this.Xpp(e)}G(e){let t=this.Xp(e),i=this.Yp(e),n=t*t+i*i;return Math.sqrt(n*n*n)}Xp(e){return 3*this.l.x*e*e+2*this.e.x*e+this.c.x}Ypp(e){return 6*this.l.y*e+2*this.e.y}Yp(e){return 3*this.l.y*e*e+2*this.e.y*e+this.c.y}Xpp(e){return 6*this.l.x*e+2*this.e.x}Xppp(e){return 6*this.l.x}Yppp(e){return 6*this.l.y}curvatureDerivative(e){let t=this.G(e);return(this.Fp(e)*t-this.Gp(e)*this.F(e))/(t*t)}Fp(e){return this.Xp(e)*this.Yppp(e)-this.Yp(e)*this.Xppp(e)}Fpp(e){return this.Xpp(e)*this.Yppp(e)-this.Ypp(e)*this.Xppp(e)}closestParameter(e){let i=0,n=Number.MAX_VALUE;for(let o=0;o<9;o++){let a=e.sub(this.value(o*.125)),l=a.dot(a);l<n&&(n=l,i=o*.125)}return la.closestPoint(this,e,i,0,1)}curvatureSecondDerivative(e){let t=this.G(e);return(this.Qp(e)*t-2*this.Q(e)*this.Gp(e))/(t*t*t)}Q(e){return this.Fp(e)*this.G(e)-this.Gp(e)*this.F(e)}Qp(e){return this.Fpp(e)*this.G(e)-this.Gpp(e)*this.F(e)}Gpp(e){let t=this.Xp(e),i=this.Yp(e),n=this.Xpp(e),o=this.Ypp(e),a=this.Xppp(e),l=this.Yppp(e),u=Math.sqrt(t*t+i*i),c=t*n+i*o;return 3*(c*c/u+u*(n*n+t*a+o*o+i*l))}Gp(e){let t=this.Xp(e),i=this.Yp(e),n=this.Xpp(e),o=this.Ypp(e);return 3*Math.sqrt(t*t+i*i)*(t*n+i*o)}getParameterAtLength(e){let t=0,i=1;for(;i-t>R.tolerance;){let n=(i+t)/2,o=this.evaluateError(e,n);if(o>0)i=n;else if(o<0)t=n;else return n}return(t+i)/2}evaluateError(e,t){let i=1-t,n=m.mkPoint(i,this.b[0],t,this.b[1]),o=m.mkPoint(i,this.b[1],t,this.b[2]),a=m.mkPoint(i,this.b[2],t,this.b[3]),l=m.mkPoint(i,n,t,o),u=m.mkPoint(i,o,t,a),c=m.mkPoint(i,l,t,u),h=Me.lengthOnControlPolygon(this.b[0],n,l,c);return h>e+R.distanceEpsilon?1:h<e-R.distanceEpsilon?-1:0}};function A_(s){return s.seg.value(s.par)}function T_(s){return s.seg.derivative(s.par)}function I_(s){return s.seg.secondDerivative(s.par)}function w_(s){return s.seg.thirdDerivative(s.par)}function L_(s){if(s instanceof pe)return{tag:"ellipse",segData:s.toJSON()};if(s instanceof k)return{tag:"lineSegment",segData:s.toJSON()};if(s instanceof Me)return{tag:"bezier",segData:s.toJSON()};throw new Error("not implemented")}var I=class{static fromJSON(e){let t=new I;for(let i of e.segs)switch(i.tag){case"bezier":t.addSegment(Me.fromJSON(i.segData));break;case"ellipse":t.addSegment(pe.fromJSON(i.segData));break;case"lineSegment":t.addSegment(k.fromJSON(i.segData));break;default:throw new Error("not implemented")}return t}toJSON(){return{segs:this.segs.map(e=>L_(e))}}static CurvesIntersect(e,t){return e===t||I.intersectionOne(e,t,!1)!=null}static lengthWithInterpolationAndThreshold(e,t){throw new Error("not implemented")}static lengthWithInterpolation(e){throw"not implemented"}get parStart(){return 0}get parEnd(){return this.parEnd_}lengthPartial(e,t){let i={start:e,end:t};this.adjustStartEndEndParametersToDomain(i);let n=this.getSegIndexParam(e),o=this.getSegIndexParam(t);if(n.segIndex<o.segIndex){let a=this.segs[n.segIndex],l=a.lengthPartial(n.par,a.parEnd);for(let u=n.segIndex+1;u<o.segIndex;u++)l+=this.segs[u].length;return a=this.segs[o.segIndex],l+a.lengthPartial(a.parStart,o.par)}else throw new Error("not implemented.")}reverse(){let e=new I;for(let t=this.segs.length-1;t>=0;t--)e.addSegment(this.segs[t].reverse());return e}constructor(){this.segs=[],this.parEnd_=0}mkCurveWithSegs(e){this.segs=e;for(let t of e)this.parEnd_+=I.paramSpan(t)}get start(){return this.segs[0].start}get end(){return this.segs[this.segs.length-1].end}scaleFromOrigin(e,t){let i=new I;for(let n of this.segs)i.addSegment(n.scaleFromOrigin(e,t));return i}trim(e,t){let i={start:e,end:t};this.adjustStartEndEndParametersToDomain(i);let n=this.getSegIndexParam(i.start),o=this.getSegIndexParam(i.end);if(n.segIndex===o.segIndex)return this.segs[n.segIndex].trim(n.par,o.par);let a=new I;n.par<this.segs[n.segIndex].parEnd&&(a=a.addSegment(this.segs[n.segIndex].trim(n.par,this.segs[n.segIndex].parEnd)));for(let l=n.segIndex+1;l<o.segIndex;l++)a=a.addSegment(this.segs[l]);return this.segs[o.segIndex].parStart<o.par&&(a=a.addSegment(this.segs[o.segIndex].trim(this.segs[o.segIndex].parStart,o.par))),a}translate(e){for(let t of this.segs)t.translate(e);this.boundingBox_&&(this.boundingBox_=X.translate(this.boundingBox_,e)),this.pBNode=null}adjustStartEndEndParametersToDomain(e){if(e.start>e.end){let t=e.start;e.start=e.end,e.end=t}e.start<this.parStart&&(e.start=this.parStart),e.end>this.parEnd&&(e.end=this.parEnd)}trimWithWrap(e,t){if(e<t)return this.trim(e,t);let i=new I;return i.addSegment(this.trim(e,this.parEnd)),i.addSegment(this.trim(this.parStart,t)),i}addSegs(e){for(let t of e)this.addSegment(t);return this}addSegment(e){if(e==null)return this;if(this.boundingBox_=null,!(e instanceof I))this.segs.push(e),this.parEnd_+=I.paramSpan(e);else for(let t of e.segs)this.segs.push(t),this.parEnd_+=I.paramSpan(t);return this}pNodeOverICurve(){if(this.pBNode!=null)return this.pBNode;let e=[],t=[];for(let i of this.segs){let n=i.pNodeOverICurve();e.push(n.parallelogram),t.push(n)}return this.pBNode={parallelogram:Le.getParallelogramOfAGroup(e),seg:this,leafBoxesOffset:R.defaultLeafBoxesOffset,node:{children:t}},this.pBNode}static intersectionOne(e,t,i){let n=I.curveCurveXWithParallelogramNodesOne(e.pNodeOverICurve(),t.pNodeOverICurve());return i&&n!=null&&(n=I.liftIntersectionToCurves(e,t,n)),n}static getAllIntersections(e,t,i){return e instanceof k?I.getAllIntersectionsOfLineAndICurve(e,t,i):I.getAllIntersectionsInternal(e,t,i)}static getAllIntersectionsInternal(e,t,i){let n=[];if(I.curveCurveXWithParallelogramNodes(e.pNodeOverICurve(),t.pNodeOverICurve(),n),i)for(let o=0;o<n.length;o++)n[o]=I.liftIntersectionToCurves(e,t,n[o]);return n}static getAllIntersectionsOfLineAndICurve(e,t,i){return t instanceof ne?I.getAllIntersectionsOfLineAndPolyline(e,t):t instanceof I?I.getAllIntersectionsOfLineAndCurve(e,t,i):t instanceof pe&&t.isArc()?I.getAllIntersectionsOfLineAndArc(e,t):I.getAllIntersectionsInternal(e,t,i)}static getAllIntersectionsOfLineAndCurve(e,t,i){let n=[],o=e.pNodeOverICurve(),a=t.pNodeOverICurve();if(Le.intersect(o.parallelogram,a.parallelogram)===!1)return n;let l=0;for(let u of t.segs){let c=I.getAllIntersections(e,u,!1);if(i){for(let h of c)h.par1+=l-u.parStart,h.seg1=t;l+=u.parEnd-u.parStart}for(let h of c)I.alreadyInside(n,h)||n.push(h)}return n}static closeIntersections(e,t){return m.close(e.x,t.x,R.intersectionEpsilon)}static closeIntersectionPoints(e,t){return m.close(e,t,R.intersectionEpsilon)}static alreadyInside(e,t){for(let i=0;i<e.length;i++){let n=e[i];if(I.closeIntersections(n,t))return!0}return!1}static getAllIntersectionsOfLineAndArc(e,t){let i=e.end.sub(e.start),n=[],o=i.length;if(o<R.distanceEpsilon){let d=e.start.sub(t.center);if(ue(d.length,t.aAxis.length)){let f=m.angle(t.aAxis,d);t.parStart-R.tolerance<=f&&(f=Math.max(f,t.parStart),f<=t.parEnd+R.tolerance&&(f=Math.min(t.parEnd,f),n.push(new bn(0,f,e.start,e,t))))}return n}let a=i.rotate90Ccw().div(o),l=e.start.sub(t.center).dot(a),u=t.center.add(a.mul(l)),c=t.aAxis.length,h=Math.abs(l);if(c<h-R.distanceEpsilon)return n;if(i=a.rotate90Cw(),ue(c,h))I.tryToAddPointToLineCircleCrossing(e,t,n,u,o,i);else{let d=Math.sqrt(c*c-l*l),f=i.mul(d);I.tryToAddPointToLineCircleCrossing(e,t,n,u.add(f),o,i),I.tryToAddPointToLineCircleCrossing(e,t,n,u.sub(f),o,i)}return n}static tryToAddPointToLineCircleCrossing(e,t,i,n,o,a){let u=n.sub(e.start).dot(a);if(u<-R.distanceEpsilon||(u=Math.max(u,0),u>o+R.distanceEpsilon))return;u=Math.min(u,o),u/=o;let c=m.angle(t.aAxis,n.sub(t.center));t.parStart-R.tolerance<=c&&(c=Math.max(c,t.parStart),c<=t.parEnd+R.tolerance&&(c=Math.min(t.parEnd,c),i.push(new bn(u,c,n,e,t))))}static getAllIntersectionsOfLineAndPolyline(e,t){let i=[],n=0,o=t.startPoint;for(;o!=null&&o.getNext()!=null;o=o.getNext()){let a=I.crossTwoLineSegs(e.start,e.end,o.point,o.getNext().point,0,1,0,1);a&&(I.adjustSolution(e.start,e.end,o.point,o.getNext().point,a),I.oldIntersection(i,a.x)||i.push(new bn(a.aSol,n+a.bSol,a.x,e,t))),n++}if(t.closed){let a=I.crossTwoLineSegs(e.start,e.end,o.point,t.start,0,1,0,1);a&&(I.adjustSolution(e.start,e.end,o.point,t.start,a),I.oldIntersection(i,a.x)||i.push(new bn(a.aSol,n+a.bSol,a.x,e,t)))}return i}static adjustSolution(e,t,i,n,o){I.closeIntersectionPoints(o.x,e)?(o.x=e,o.aSol=0):I.closeIntersectionPoints(o.x,t)&&(o.x=t,o.aSol=1),I.closeIntersectionPoints(o.x,i)?(o.x=i,o.bSol=Math.floor(o.bSol)):I.closeIntersectionPoints(o.x,n)&&(o.x=n,o.bSol=Math.ceil(o.bSol))}static curveCurveXWithParallelogramNodesOne(e,t){if(!Le.intersect(e.parallelogram,t.parallelogram))return null;let i=e.node,n=t.node,o=i.hasOwnProperty("children"),a=n.hasOwnProperty("children");if(o&&a)for(let l of i.children)for(let u of n.children){let c=I.curveCurveXWithParallelogramNodesOne(l,u);if(c!=null)return c}else if(a)for(let l of n.children){let u=I.curveCurveXWithParallelogramNodesOne(e,l);if(u!=null)return u}else if(o)for(let l of i.children){let u=I.curveCurveXWithParallelogramNodesOne(l,t);if(u!=null)return u}else return I.crossOverIntervalsOne(e,t);return null}static curveCurveXWithParallelogramNodes(e,t,i){if(!Le.intersect(e.parallelogram,t.parallelogram))return;let n=e.node.hasOwnProperty("children"),o=t.node.hasOwnProperty("children");if(n&&o)for(let a of e.node.children)for(let l of t.node.children)I.curveCurveXWithParallelogramNodes(a,l,i);else if(o)for(let a of t.node.children)I.curveCurveXWithParallelogramNodes(e,a,i);else if(n)for(let a of e.node.children)I.curveCurveXWithParallelogramNodes(a,t,i);else i=I.crossOverLeaves(e,t,i)}static crossOverIntervalsOne(e,t){let i=e.node,n=t.node,o=(i.high-i.low)/2,a=(n.high-n.low)/2;for(let l=1;l<2;l++){let u=l*o+i.low;for(let c=1;c<2;c++){let h=c*a+n.low,d;if(i.chord==null&&n.chord==null?d=I.crossWithinIntervalsWithGuess(e.seg,t.seg,i.low,i.high,n.low,n.high,u,h):i.chord!=null&&n.chord==null?d=I.crossWithinIntervalsWithGuess(i.chord,t.seg,0,1,n.low,n.high,.5*l,h):i.chord==null?(d=I.crossWithinIntervalsWithGuess(e.seg,n.chord,i.low,i.high,0,1,u,.5*c),d&&(d.bSol=n.low+d.bSol*(n.high-n.low))):(d=I.crossWithinIntervalsWithGuess(i.chord,n.chord,0,1,0,1,.5*l,.5*c),d&&(d.aSol=i.low+d.aSol*(i.high-i.low),d.bSol=n.low+d.bSol*(n.high-n.low))),d)return I.createIntersectionOne(e,t,d.aSol,d.bSol,d.x)}}return I.goDeeperOne(e,t)}static crossOverLeaves(e,t,i){let n=e.node,o=t.node,a=!1,l=(n.high-n.low)/2+n.low,u=(o.high-o.low)/2+o.low,c;return n.chord==null&&o.chord==null?c=I.crossWithinIntervalsWithGuess(e.seg,t.seg,n.low,n.high,o.low,o.high,l,u):n.chord!=null&&o.chord==null?(c=I.crossWithinIntervalsWithGuess(n.chord,t.seg,0,1,o.low,o.high,.5,u),c&&(c.aSol=n.low+c.aSol*(n.high-n.low))):n.chord==null?(c=I.crossWithinIntervalsWithGuess(e.seg,o.chord,n.low,n.high,0,1,l,.5),c&&(c.bSol=o.low+c.bSol*(o.high-o.low))):(c=I.crossWithinIntervalsWithGuess(n.chord,o.chord,0,1,0,1,.5,.5),c&&(c.bSol=o.low+c.bSol*(o.high-o.low),c.aSol=n.low+c.aSol*(n.high-n.low))),c&&(I.addIntersection(e,t,i,c),a=!0),a||I.goDeeper(i,e,t),i}static addIntersection(e,t,i,n){let o=e.node;I.closeIntersectionPoints(n.x,e.seg.value(o.low))?(n.x=e.seg.value(o.low),n.aSol=o.low):I.closeIntersectionPoints(n.x,e.seg.value(o.high))&&(n.x=e.seg.value(o.high),n.aSol=o.high);let a=t.node;if(I.closeIntersectionPoints(n.x,t.seg.value(a.low))?(n.x=t.seg.value(a.low),n.bSol=a.low):I.closeIntersectionPoints(n.x,t.seg.value(a.high))&&(n.x=t.seg.value(a.high),n.bSol=a.high),!I.oldIntersection(i,n.x)){let u=new bn(n.aSol,n.bSol,n.x,e.seg,t.seg);i.push(u)}}static oldIntersection(e,t){for(let i of e)if(t.sub(i.x).length<R.distanceEpsilon*100)return!0;return!1}static createIntersectionOne(e,t,i,n,o){let a=e.node,l=t.node;return I.closeIntersectionPoints(o,e.seg.value(a.low))?(o=e.seg.value(a.low),i=a.low):I.closeIntersectionPoints(o,e.seg.value(a.high))&&(o=e.seg.value(a.high),i=a.high),I.closeIntersectionPoints(o,t.seg.value(l.low))?(o=t.seg.value(l.low),n=l.low):I.closeIntersectionPoints(o,t.seg.value(l.high))&&(o=t.seg.value(l.high),n=l.high),new bn(i,n,o,e.seg,t.seg)}static liftIntersectionToCurves_(e,t,i,n,o,a,l){let u=e instanceof I?I.liftParameterToCurve(e,i-a.parStart,a):i,c=t instanceof I?I.liftParameterToCurve(t,n-l.parStart,l):n;return new bn(u,c,o,e,t)}static DropIntersectionToSegs(e){let t,i;if(e.seg0 instanceof I){let a=e.seg0.getSegParam(e.par0);t=a.seg,i=a.par}else i=e.par0,t=e.seg0;let n,o;if(e.seg1 instanceof I){let a=e.seg1.getSegParam(e.par1);o=a.par,n=a.seg}else o=e.par1,n=e.seg1;return new bn(i,o,e.x,t,n)}static liftIntersectionToCurves(e,t,i){return I.liftIntersectionToCurves_(e,t,i.par0,i.par1,i.x,i.seg0,i.seg1)}static liftParameterToCurve(e,t,i){if(e===i)return t;if(!e.hasOwnProperty("segs"))return;let n=e,o=0;for(let a of n.segs){if(a===i)return t+o;o+=I.paramSpan(a)}throw"bug in liftParameterToCurve"}static paramSpan(e){return e.parEnd-e.parStart}static goDeeperOne(e,t){let i=e.node,n=t.node;if(e.leafBoxesOffset>R.distanceEpsilon&&t.leafBoxesOffset>R.distanceEpsilon){let l=ht.createParallelogramNodeForCurveSeg(i.low,i.high,e.seg,e.leafBoxesOffset/2),u=ht.createParallelogramNodeForCurveSeg(n.low,n.high,t.seg,t.leafBoxesOffset/2);return I.curveCurveXWithParallelogramNodesOne(l,u)}if(e.leafBoxesOffset>R.distanceEpsilon){let l=ht.createParallelogramNodeForCurveSeg(i.low,i.high,e.seg,e.leafBoxesOffset/2);return I.curveCurveXWithParallelogramNodesOne(l,t)}if(t.leafBoxesOffset>R.distanceEpsilon){let l=ht.createParallelogramNodeForCurveSeg(n.low,n.high,t.seg,t.leafBoxesOffset/2);return I.curveCurveXWithParallelogramNodesOne(e,l)}let o=e.seg.value(i.low),a=e.seg.value(i.high);if(!m.closeDistEps(o,a)){let l=t.seg.value(n.low),u=t.seg.value(n.high);if(!m.closeDistEps(l,u)){let c=e.seg instanceof k?e.seg:k.mkPP(o,a),h=t.seg instanceof k?t.seg:k.mkPP(l,u),d=I.crossWithinIntervalsWithGuess(c,h,0,1,0,1,.5,.5);if(d)return I.adjustParameters(e,c,t,h,d),I.createIntersectionOne(e,t,d.aSol,d.bSol,d.x)}}return null}static goDeeper(e,t,i){let n=t.node,o=i.node,a=t.leafBoxesOffset>R.distanceEpsilon,l=i.leafBoxesOffset>R.distanceEpsilon;if(a&&l){let u=ht.createParallelogramNodeForCurveSeg(n.low,n.high,t.seg,t.leafBoxesOffset/2),c=ht.createParallelogramNodeForCurveSeg(o.low,o.high,i.seg,i.leafBoxesOffset/2);I.curveCurveXWithParallelogramNodes(u,c,e)}else if(a){let u=ht.createParallelogramNodeForCurveSeg(n.low,n.high,t.seg,t.leafBoxesOffset/2);I.curveCurveXWithParallelogramNodes(u,i,e)}else if(l){let u=ht.createParallelogramNodeForCurveSeg(o.low,o.high,i.seg,i.leafBoxesOffset/2);I.curveCurveXWithParallelogramNodes(t,u,e)}else{let u=t.seg.value(n.low),c=t.seg.value(n.high);if(!m.closeDistEps(u,c)){let h=i.seg.value(o.low),d=i.seg.value(o.high);if(!m.closeDistEps(h,d)){let f=t.seg instanceof k?t.seg:k.mkPP(u,c),p=i.seg instanceof k?i.seg:k.mkPP(h,d),S=I.crossWithinIntervalsWithGuess(f,p,0,1,0,1,.5,.5);S&&(I.adjustParameters(t,f,i,p,S),I.addIntersection(t,i,e,S))}}}}static adjustParameters(e,t,i,n,o){if(t!==e.seg&&!(e.seg instanceof ne))o.aSol=e.seg.closestParameter(o.x);else{let a=e.node;o.aSol=a.low+o.aSol*(a.high-a.low)}if(n!==i.seg&&!(i.seg instanceof ne))o.bSol=i.seg.closestParameter(o.x);else{let a=i.node;o.bSol=a.low+o.bSol*(a.high-a.low)}}getSegParam(e){let t=this.parStart;for(let n of this.segs){let o=t+n.parEnd-n.parStart;if(e>=t&&e<=o)return{par:e-t+n.parStart,seg:n};t=o}let i=this.segs[this.segs.length-1];return{seg:i,par:i.parEnd}}getSegIndexParam(e){let t=0,i=this.segs.length;for(let o=0;o<i;o++){let a=this.segs[o],l=t+a.parEnd-a.parStart;if(e>=t&&e<=l)return{segIndex:o,par:e-t+a.parStart};t=l}let n=this.segs[i-1];return{segIndex:i-1,par:n.parEnd}}value(e){return A_(this.getSegParam(e))}derivative(e){return T_(this.getSegParam(e))}secondDerivative(e){return I_(this.getSegParam(e))}thirdDerivative(e){return w_(this.getSegParam(e))}static crossWithinIntervalsWithGuess(e,t,i,n,o,a,l,u){if(e instanceof k&&t instanceof k){let d=I.crossTwoLineSegs(e.start,e.end,t.start,t.end,i,n,o,a);if(d!==void 0)return d}let c=I.minDistWithinIntervals(e,t,i,n,o,a,l,u);if(c==null)return;let h=c.aX.sub(c.bX);return h.dot(h)>=R.distanceEpsilon?void 0:{aSol:c.aSol,bSol:c.bSol,x:m.middle(c.aX,c.bX)}}static crossTwoLineSegs(e,t,i,n,o,a,l,u){let c=t.sub(e),h=i.sub(n),d=i.sub(e),f=mn.solve(c.x,h.x,d.x,c.y,h.y,d.y);if(f==null)return;let p=f.x,S=f.y,E=e.add(c.mul(p));if(!(p<o-R.tolerance)&&(p=Math.max(p,o),!(p>a+R.tolerance)&&(p=Math.min(p,a),!(S<l-R.tolerance)&&(S=Math.max(S,l),!(S>u+R.tolerance)))))return S=Math.min(S,u),{aSol:p,bSol:S,x:E}}static PointRelativeToCurveLocation(e,t){if(!t.boundingBox.contains(e))return 0;let i=2*t.boundingBox.diagonal,n=Math.PI/180,o=0;for(let a=13;a<360;a+=13){let l=new m(Math.cos(a*n),Math.sin(a*n)),u=k.mkPP(e,e.add(l.mul(i))),c=this.getAllIntersectionsOfLineAndICurve(u,t,!0);if(I.AllIntersectionsAreGood(c,t)){for(let d of c)if(m.closeDistEps(d.x,e))return 1;if(c.length%2===1?o++:o--,o>=2)return 2;if(o<=-2)return 0}}return 1}static AllIntersectionsAreGood(e,t){let i=t.hasOwnProperty("segs"),n=null;if(i||t instanceof ne&&(n=t.toCurve()),n){for(let o of e)if(!I.RealCut(I.DropIntersectionToSegs(o),n,!1))return!1}return!0}static RealCut(e,t,i){let n=e.seg0,o=e.seg1,a=e.par0,l=e.par1,u=e.x,c=n.derivative(a).normalize(),h=o.derivative(l).normalize().rotate(Math.PI/2);if(m.closeDistEps(u,o.end)){let f=null;for(let E=0;E<t.segs.length-1;E++)if(t.segs[E]===o){f=t.segs[E+1];break}if(f==null)return!1;let p=c.rotate(Math.PI/2);return!(p.dot(o.derivative(o.parEnd))*p.dot(f.derivative(f.parStart))<R.tolerance)}if(m.closeDistEps(u,o.start)){let f=null;for(let E=t.segs.length-1;E>0;E--)if(t.segs[E]===o){f=t.segs[E-1];break}if(f==null)return!1;let p=c.rotate(Math.PI/2);return!(p.dot(o.derivative(o.parStart))*p.dot(f.derivative(f.parEnd))<R.tolerance)}let d=c.dot(h);return i?d>R.distanceEpsilon:Math.abs(d)>R.distanceEpsilon}static realCutWithClosedCurve(e,t,i){let n=e.seg0,o=e.seg1,a=e.par0,l=e.par1,u=e.x,c=n.derivative(a).normalize(),h=o.derivative(l).normalize().rotate(Math.PI/2);if(m.closeDistEps(u,o.end)){let f=null;for(let E=0;E<t.segs.length;E++)if(t.segs[E]===o){f=t.segs[(E+1)%t.segs.length];break}if(f==null)throw new Error;let p=c.rotate(Math.PI/2);return!(p.dot(o.derivative(o.parEnd))*p.dot(f.derivative(f.parStart))<R.tolerance)}if(m.closeDistEps(u,o.start)){let f=null;for(let E=0;E<t.segs.length;E++)if(t.segs[E]===o){f=t.segs[E>0?E-1:t.segs.length-1];break}let p=c.rotate(Math.PI/2);return!(p.dot(o.derivative(o.parStart))*p.dot(f.derivative(f.parEnd))<R.tolerance)}let d=c.dot(h);return i?d>R.distanceEpsilon:Math.abs(d)>R.distanceEpsilon}static minDistWithinIntervals(e,t,i,n,o,a,l,u){let c=new Yp(e,t,i,n,o,a,l,u);return c.solve(),c.success?{aSol:c.aSolution,bSol:c.bSolution,aX:c.aPoint,bX:c.bPoint}:void 0}offsetCurve(e,t){throw new Error("Method not implemented.")}get boundingBox(){if(this.boundingBox_)return this.boundingBox_;if(this.segs.length===0)this.boundingBox_=X.mkEmpty();else{let e=this.segs[0].boundingBox.clone();for(let t=1;t<this.segs.length;t++)e.addRecSelf(this.segs[t].boundingBox);return this.boundingBox_=e}}clone(){let e=new I;for(let t of this.segs)e.addSegment(t.clone());return this.boundingBox_!=null&&(e.boundingBox_=this.boundingBox_.clone()),e}getParameterAtLength(e){let t=0;for(let i of this.segs){let n=i.length;if(n>=e)return t+i.getParameterAtLength(e);e-=n,t+=i.parEnd-i.parStart}return this.parEnd}get length(){let e=0;for(let t of this.segs)e+=t.length;return e}transform(e){let t=new I;for(let i of this.segs)t.addSegment(i.transform(e));return this.boundingBox_&&(t.boundingBox_=this.boundingBox_.transform(e)),t}closestParameterWithinBounds(e,t,i){let n=0,o=Number.MAX_VALUE,a=0;for(let l of this.segs){if(a>i)break;let u=I.paramSpan(l);if(a+u>=t){let h=Math.max(l.parStart,l.parStart+(t-a)),d=Math.min(l.parEnd,l.parStart+(i-a)),f=l.closestParameterWithinBounds(e,h,d),p=e.sub(l.value(f)),S=p.dot(p);S<o&&(n=a+f-l.parStart,o=S)}a+=u}return n}closestParameter(e){let t=0,i=Number.MAX_VALUE,n=0;for(let o of this.segs){let a=o.closestParameter(e),l=e.sub(o.value(a)),u=l.dot(l);if(u<i){if(t=n+a-o.parStart,u===0)break;i=u}n+=I.paramSpan(o)}return t}static addLineSegment(e,t,i){return e.addSegment(k.mkPP(t,i))}static addLineSegmentCNNP(e,t,i,n){return I.addLineSegment(e,new m(t,i),n)}static addLineSegmentCNNNN(e,t,i,n,o){I.addLineSegment(e,new m(t,i),new m(n,o))}static continueWithLineSegmentNN(e,t,i){I.addLineSegment(e,e.end,new m(t,i))}static continueWithLineSegmentP(e,t){I.addLineSegment(e,e.end,t)}static closeCurve(e){return I.continueWithLineSegmentP(e,e.start),e}leftDerivative(e){let t=this.tryToGetLeftSegment(e);return t!=null?t.derivative(t.parEnd):this.derivative(e)}rightDerivative(e){let t=this.tryToGetRightSegment(e);return t!=null?t.derivative(t.parStart):this.derivative(e)}tryToGetLeftSegment(e){if(Math.abs(e-this.parStart)<R.tolerance)return this.start.equal(this.end)?this.segs[this.segs.length-1]:null;for(let t of this.segs)if(e-=I.paramSpan(t),Math.abs(e)<R.tolerance)return t;return null}tryToGetRightSegment(e){if(Math.abs(e-this.parEnd)<R.tolerance)return this.start===this.end?this.segs[0]:null;for(let t of this.segs){if(Math.abs(e)<R.tolerance)return t;e-=I.paramSpan(t)}return null}static ClosestPoint(e,t){return e.value(e.closestParameter(t))}static CurveIsInsideOther(e,t){if(!t.boundingBox.containsRect(e.boundingBox))return!1;let i=I.getAllIntersections(e,t,!0);if(i.length===0)return I.NonIntersectingCurveIsInsideOther(e,t);if(i.length===1)return e.start.equal(i[0].x)?I.PointRelativeToCurveLocation(e.value((e.parStart+e.parEnd)/2),t)==2:I.PointRelativeToCurveLocation(e.start,t)===2;for(let n of I.PointsBetweenIntersections(e,i))if(I.PointRelativeToCurveLocation(n,t)===0)return!1;return!0}static*PointsBetweenIntersections(e,t){t.sort((l,u)=>l.par0-u.par0);for(let l=0;l<t.length-1;l++)yield e.value((t[l].par0+t[l+1].par0)/2);let i=t[t.length-1].par0,n=t[0].par0,o=e.parEnd-i+(n-e.parStart),a=i+o/2;a>e.parEnd&&(a=e.parStart+(a-e.parEnd)),yield e.value(a)}static NonIntersectingCurveIsInsideOther(e,t){for(let i=e.parStart;i<e.parEnd;i+=.5){let n=I.PointRelativeToCurveLocation(e.value(i),t);if(n!==1)return n===2}return I.PointRelativeToCurveLocation(e.end,t)!==0}static ClosedCurveInteriorsIntersect(e,t){if(!t.boundingBox.intersects(e.boundingBox))return!1;let i=I.getAllIntersections(e,t,!0);if(i.length===0)return I.NonIntersectingCurveIsInsideOther(e,t)||I.NonIntersectingCurveIsInsideOther(t,e);if(i.length===1)return e.start.equal(i[0].x)?I.PointRelativeToCurveLocation(e.value((e.parStart+e.parEnd)/2),t)===2||!t.start.equal(i[0].x)?I.PointRelativeToCurveLocation(t.start,e)===2:I.PointRelativeToCurveLocation(t.value((t.parStart+t.parEnd)/2),e)===2:I.PointRelativeToCurveLocation(e.start,t)===2;for(let n of I.PointsBetweenIntersections(e,i))if(I.PointRelativeToCurveLocation(n,t)===2)return!0;return!0}curvature(e){let t=this.getSegParam(e);return t.seg.curvature(t.par)}curvatureDerivative(e){throw new Error("Not implemente")}curvatureSecondDerivative(e){throw new Error("Not implemented")}static createBezierSeg(e,t,i,n,o){let a=m.mkPoint(e,i.point,1-e,n.point),l=m.mkPoint(t,o.point,1-t,n.point),u=n.point.mul(2/3);return new Me(a,a.div(3).add(u),u.add(l.div(3)),l)}static createBezierSegN(e,t,i,n){let o=i.mul(n);return new Me(e,e.add(o),t.add(o),t)}static findCorner(e){let t=e.next;if(t.next==null)return;let i=t.next;if(i!=null)return{b:t,c:i}}static trimEdgeSplineWithNodeBoundaries(e,t,i,n){let o=i.parStart,a=i.parEnd;e!=null&&(o=I.findNewStart(i,o,e,n)),t!=null&&(a=I.findNewEnd(i,t,n,a));let l=Math.min(o,a),u=Math.max(o,a);return l<u?i.trim(l,u):i}static findNewEnd(e,t,i,n){let o=I.getAllIntersections(e,t,!0);if(o.length===0)return n=e.parEnd,n;if(i){n=e.parEnd;for(let a of o)a.par0<n&&(n=a.par0)}else{n=e.parStart;for(let a of o)a.par0>n&&(n=a.par0)}return n}static findNewStart(e,t,i,n){let o=I.getAllIntersections(e,i,!0);if(o.length===0){t=e.parStart;return}if(n){t=e.parStart;for(let a of o)a.par0>t&&(t=a.par0)}else{t=e.parEnd;for(let a of o)a.par0<t&&(t=a.par0)}return t}static polylineAroundClosedCurve(e){if(e instanceof pe)return I.refineEllipse(e);if(e instanceof ne)return e;if(e instanceof I&&I.allSegsAreLines(e)){let t=new ne;for(let i of e.segs)t.addPoint(i.start);if(t.closed=!0,!t.isClockwise())return t.reverse()}return e.boundingBox.perimeter()}static allSegsAreLines(e){for(let t of e.segs)if(!(t instanceof k))return!1;return!0}static refineEllipse(e){let t=e.boundingBox.perimeter(),i=Math.PI/4,n=e.boundingBox.width,o=e.boundingBox.height,a=Math.sqrt(n*n+o*o),l=[];for(let c=0;c<4;c++){let h=i+c*Math.PI/2,d=e.value(h),f=e.derivative(h).normalize().mul(a),p=k.mkPP(d.sub(f),d.add(f));for(let S of I.getAllIntersections(t,p,!0))l.push(S)}l.sort((c,h)=>c.par0<h.par0?-1:c.par0>h.par0?1:0);let u=new ne;return l.forEach(c=>u.addPoint(c.x)),u.closed=!0,u}static polyFromBox(e){let t=new ne;return t.addPoint(e.leftTop),t.addPoint(e.rightTop),t.addPoint(e.rightBottom),t.addPoint(e.leftBottom),t.closed=!0,t}};var ne=class{constructor(){this.initIsRequired=!0;this.isClosed_=!1}toJSON(){return{points:Array.from(this).map(e=>e.toJSON())}}static fromJSON(e){return ne.mkFromPoints(e.points.map(t=>m.fromJSON(t)))}RemoveStartPoint(){let e=this.startPoint.next;e.prev=null,this.startPoint=e,this.setInitIsRequired()}RemoveEndPoint(){let e=this.endPoint.prev;e.next=null,this.endPoint=e,this.setInitIsRequired()}setInitIsRequired(){this.initIsRequired=!0}addPointXY(e,t){this.addPoint(new m(e,t))}isClockwise(){return m.getTriangleOrientation(this.startPoint.point,this.startPoint.next.point,this.startPoint.next.next.point)==0}addPoint(e){let t=new Kt;t.polyline=this,t.point=e.clone(),this.endPoint!=null?(this.endPoint.next=t,t.prev=this.endPoint,this.endPoint=t):this.startPoint=this.endPoint=t,this.setInitIsRequired()}PrependPoint(e){let t=Kt.mkFromPoint(e);t.polyline=this,this.startPoint!=null?m.closeDistEps(e,this.startPoint.point)||(this.startPoint.prev=t,t.next=this.startPoint,this.startPoint=t):(this.endPoint=t,this.startPoint=t),this.setInitIsRequired()}*[Symbol.iterator](){for(let e=this.startPoint;e!=null;e=e.next)yield e.point}*polylinePoints(){for(let e=this.startPoint;e!=null;e=e.next)yield e}*skip(e){for(let t=this.startPoint;t!=null;t=t.next)e>0?e--:yield t}static parallelogramOfLineSeg(e,t){let i=t.sub(e).div(2);return Le.parallelogramByCornerSideSide(e,i,i)}static mkFromPoints(e){let t=new ne;for(let i of e)t.addPoint(i);return t}static mkClosedFromPoints(e){let t=ne.mkFromPoints(e);return t.closed=!0,t}calculatePbNode(){let e=[],t=[],i=this.startPoint,n=0;for(;i.next!=null;){let o=ne.parallelogramOfLineSeg(i.point,i.next.point);e.push(o),t.push({parallelogram:o,seg:this,leafBoxesOffset:0,node:{low:n,high:n+1,chord:k.mkPP(i.point,i.next.point)}}),i=i.next,n++}if(this.isClosed_){let o=ne.parallelogramOfLineSeg(this.endPoint.point,this.startPoint.point);e.push(o),t.push({parallelogram:o,seg:this,leafBoxesOffset:0,node:{low:n,high:n+1,chord:k.mkPP(this.endPoint.point,this.startPoint.point)}})}this.pBNode={parallelogram:Le.getParallelogramOfAGroup(e),seg:this,leafBoxesOffset:0,node:{children:t}}}init(){this.bBox=X.rectangleOnPoint(this.startPoint.point);for(let e of this.skip(1))this.bBox.add(e.point);this.updateCount(),this.calculatePbNode(),this.initIsRequired=!1}updateCount(){this.count_=0;for(let e=this.startPoint;e!=null;e=e.next)this.count_++}get count(){return this.initIsRequired&&this.init(),this.count_}get closed(){return this.isClosed_}set closed(e){this.isClosed_=e}value(e){this.initIsRequired&&this.init();let t=this.getAdjustedParamAndStartEndPoints(e);return m.convSum(t.t,t.a,t.b)}getAdjustedParamAndStartEndPoints(e){let t=this.startPoint;for(;t.next!=null;){if(e<=1)return{a:t.point,b:t.next.point,t:e};t=t.next,e-=1}if(this.closed&&e<=1)return{a:this.endPoint.point,b:this.startPoint.point,t:e};throw new Error("out of the parameter domain")}derivative(e){let t=this.getAdjustedParamAndStartEndPoints(e);return t.b.sub(t.a)}secondDerivative(e){return new m(0,0)}thirdDerivative(e){return new m(0,0)}pNodeOverICurve(){return this.initIsRequired&&this.init(),this.pBNode}get boundingBox(){return this.initIsRequired&&this.init(),this.bBox}get parStart(){return 0}get parEnd(){return this.initIsRequired&&this.init(),this.closed?this.count_:this.count_-1}static polylineFromCurve(e){let t=new ne;t.addPoint(e.start);for(let i of e.segs)t.addPoint(i.end);return t.closed=e.start===e.end,t}trim(e,t){let i=this.toCurve();return i=i.trim(e,t),i instanceof I?ne.polylineFromCurve(i):ne.mkFromPoints([i.start,i.end])}trimWithWrap(e,t){throw new Error("Method not implemented.")}translate(e){let t=this.startPoint;do{if(t.point=t.point.add(e),t===this.endPoint)break;t=t.getNext()}while(!0);this.setInitIsRequired()}scaleFromOrigin(e,t){throw new Error("Method not implemented.")}get start(){return this.startPoint.point}get end(){return this.endPoint.point}reverse(){let e=new ne;e.closed=this.closed;let t=this.endPoint;do{if(e.addPoint(t.point),t===this.startPoint)break;t=t.getPrev()}while(!0);return e}offsetCurve(e,t){throw new Error("Method not implemented.")}lengthPartial(e,t){throw new Error("Method not implemented.")}get length(){throw new Error("Method not implemented.")}getParameterAtLength(e){throw new Error("Method not implemented.")}transform(e){let t=new ne;for(let i of this.polylinePoints())t.addPoint(e.multiplyPoint(i.point));return t.closed=this.closed,t}closestParameterWithinBounds(e,t,i){throw new Error("Method not implemented.")}closestParameter(e){let t=0,i=Number.MAX_VALUE,n=0,o=this.startPoint;for(;o.next!=null;){let a=k.mkPP(o.point,o.next.point),l=a.closestParameter(e),u=a.value(l).sub(e),c=u.dot(u);c<i&&(i=c,t=l+n),o=o.next,n++}if(this.closed){let a=k.mkPP(this.endPoint.point,this.startPoint.point),l=a.closestParameter(e),u=a.value(l).sub(e);u.dot(u)<i&&(t=l+n)}return t}clone(){let e=new ne;e.closed=this.closed;let t=this.startPoint;do{if(e.addPoint(t.point),t===this.endPoint)break;t=t.getNext()}while(!0);return e}leftDerivative(e){throw new Error("Method not implemented.")}rightDerivative(e){throw new Error("Method not implemented.")}curvature(e){throw new Error("Method not implemented.")}curvatureDerivative(e){throw new Error("Method not implemented.")}curvatureSecondDerivative(e){throw new Error("Method not implemented.")}next(e){var t;return(t=e.next)!=null?t:this.closed?this.startPoint:null}prev(e){var t;return(t=e.prev)!=null?t:this.closed?this.endPoint:null}toCurve(){let e=new I;I.addLineSegment(e,this.startPoint.point,this.startPoint.next.point);let t=this.startPoint.next;for(;(t=t.next)!=null;)I.continueWithLineSegmentP(e,t.point);return this.closed&&I.continueWithLineSegmentP(e,this.startPoint.point),e}RemoveCollinearVertices(){for(let e=this.startPoint.next;e.next!=null;e=e.next)m.getTriangleOrientation(e.prev.point,e.point,e.next.point)===2&&(e.prev.next=e.next,e.next.prev=e.prev);return this.setInitIsRequired(),this}};var wt=class{pad(e){this.width+=e*2}constructor(e,t=e){this.width=e,this.height=t}},X=class{transform(e){return X.mkPP(e.multiplyPoint(this.leftTop),e.multiplyPoint(this.rightBottom))}translate(e){return X.mkSizeCenter(this.size,this.center.add(e))}equal(e){return this.left_===e.left&&this.right_===e.right&&this.top_===e.top&&this.bottom_===e.bottom}equalEps(e){return ue(this.left_,e.left)&&ue(this.right_,e.right)&&ue(this.top_,e.top)&&ue(this.bottom_,e.bottom)}static mkSizeCenter(e,t){let i=e.width/2,n=e.height/2;return new X({left:t.x-i,right:t.x+i,bottom:t.y-n,top:t.y+n})}constructor(e){this.left_=e.left,this.right_=e.right,this.top_=e.top,this.bottom=e.bottom}add_rect(e){return this.addRec(e)}contains_point(e){return this.contains(e)}contains_rect(e){return this.containsRect(e)}intersection_rect(e){return this.intersection(e)}intersects_rect(e){return this.intersects(e)}unite(e){return X.rectangleOfTwo(this,e)}contains_point_radius(e,t){return this.containsWithPadding(e,t)}intersects(e){return this.intersectsOnX(e)&&this.intersectsOnY(e)}intersection(e){if(!this.intersects(e)){let a=X.mkEmpty();return a.setToEmpty(),a}let t=Math.max(this.left,e.left),i=Math.min(this.right,e.right),n=Math.max(this.bottom,e.bottom),o=Math.min(this.top,e.top);return new X({left:t,bottom:n,right:i,top:o})}get center(){return this.leftTop.add(this.rightBottom).mul(.5)}set center(e){let t=this.leftTop.add(this.rightBottom).mul(.5),i=e.sub(t);this.leftTop=this.leftTop.add(i),this.rightBottom=this.rightBottom.add(i)}intersectsOnY(e){return!(e.bottom_>this.top_+R.distanceEpsilon||e.top_<this.bottom_-R.distanceEpsilon)}intersectsOnX(e){return!(e.left>this.right_+R.distanceEpsilon||e.right<this.left_-R.distanceEpsilon)}static mkEmpty(){return new X({left:0,right:-1,bottom:0,top:-1})}get left(){return this.left_}set left(e){this.left_=e,this.onUpdated()}get right(){return this.right_}set right(e){this.right_=e,this.onUpdated()}get top(){return this.top_}set top(e){this.top_=e,this.onUpdated()}get bottom(){return this.bottom_}set bottom(e){this.bottom_=e,this.onUpdated()}get leftBottom(){return new m(this.left_,this.bottom_)}set leftBottom(e){this.left_=e.x,this.bottom=e.y}get rightTop(){return new m(this.right_,this.top_)}set rightTop(e){this.right_=e.x,this.top_=e.y}get leftTop(){return new m(this.left_,this.top_)}set leftTop(e){this.left_=e.x,this.top_=e.y}get rightBottom(){return new m(this.right_,this.bottom_)}set rightBottom(e){this.right_=e.x,this.bottom=e.y}onUpdated(){}static mkPP(e,t){let i=new X({left:e.x,right:e.x,top:e.y,bottom:e.y});return i.add(t),i}static rectangleOnPoint(e){return new X({left:e.x,right:e.x,top:e.y,bottom:e.y})}static mkLeftBottomSize(e,t,i){let n=e+i.width,o=t+i.height;return new X({left:e,right:n,top:o,bottom:t})}static getRectangleOnCoords(e,t,i,n){let o=new X({left:e,bottom:t,right:e,top:t});return o.add(new m(i,n)),o}static mkOnPoints(e){let t=X.mkEmpty();for(let i of e)t.add(i);return t}static mkOnRectangles(e){let t=X.mkEmpty();for(let i of e)t.addRecSelf(i);return t}get width(){return this.right_-this.left_}set width(e){let t=e/2,i=(this.left_+this.right_)/2;this.left_=i-t,this.right_=i+t}isEmpty(){return this.right<this.left}setToEmpty(){this.left=0,this.right=-1}get height(){return this.top_-this.bottom_}set height(e){let t=e/2,i=(this.top_+this.bottom_)/2;this.top_=i+t,this.bottom=i-t}static rectangleOfTwo(e,t){let i=new X({left:e.left_,right:e.right_,top:e.top_,bottom:e.bottom_});return i.addRecSelf(t),i}containsWithPadding(e,t){return this.left_-t-R.distanceEpsilon<=e.x&&e.x<=this.right_+t+R.distanceEpsilon&&this.bottom_-t-R.distanceEpsilon<=e.y&&e.y<=this.top_+t+R.distanceEpsilon}get area(){return(this.right_-this.left_)*(this.top_-this.bottom_)}add(e){this.isEmpty()?(this.left_=this.right_=e.x,this.top_=this.bottom=e.y):(this.left_>e.x&&(this.left_=e.x),this.top_<e.y&&(this.top_=e.y),this.right_<e.x&&(this.right_=e.x),this.bottom_>e.y&&(this.bottom=e.y))}addRecSelf(e){this.add(e.leftTop),this.add(e.rightBottom)}addRec(e){let t=this.clone();return t.add(e.leftTop),t.add(e.rightBottom),t}static translate(e,t){let i=e.clone();return i.center=e.center.add(t),i}static transform(e,t){return X.mkPP(t.multiplyPoint(e.leftTop),t.multiplyPoint(e.rightBottom))}contains(e){return this.containsWithPadding(e,0)}containsRect(e){return this.contains(e.leftTop)&&this.contains(e.rightBottom)}containsRectWithPadding(e,t){return this.containsWithPadding(e.leftTop,t)&&this.containsWithPadding(e.rightBottom,t)}get diagonal(){return Math.sqrt(this.width*this.width+this.height*this.height)}padWidth(e){this.left-=e,this.right+=e}padHeight(e){this.top+=e,this.bottom-=e}pad(e){e<-this.width/2&&(e=-this.width/2),e<-this.height/2&&(e=-this.height/2),this.padWidth(e),this.padHeight(e)}padEverywhere(e){this.left-=e.left,this.right+=e.right,this.bottom-=e.bottom,this.top+=e.top}static intersect(e,t){return e.intersects(t)?X.mkPP(new m(Math.max(e.left,t.left),Math.max(e.bottom,t.bottom)),new m(Math.min(e.right,t.right),Math.min(e.top,t.top))):X.mkEmpty()}perimeter(){let e=new ne;return e.addPoint(this.leftTop),e.addPoint(this.rightTop),e.addPoint(this.rightBottom),e.addPoint(this.leftBottom),e.closed=!0,e}scaleAroundCenter(e){this.width=this.width*e,this.height=this.height*e}clone(){return new X({left:this.left,right:this.right,top:this.top,bottom:this.bottom})}get size(){return new wt(this.width,this.height)}set size(e){this.width=e.width,this.height=e.height}static creatRectangleWithSize(e,t){let i=e.width/2,n=t.x-i,o=t.x+i,a=e.height/2,l=t.y-a,u=t.y+a;return new X({left:n,right:o,top:u,bottom:l})}addPointWithSize(e,t){let i=e.width/2,n=e.height/2;this.add(new m(t.x-i,t.y-n)),this.add(new m(t.x+i,t.y-n)),this.add(new m(t.x-i,t.y+n)),this.add(new m(t.x+i,t.y+n))}};var We=class{constructor(){this.previouisBezierCoefficient=.5;this.nextBezierCoefficient=.5;this.previousTangentCoefficient=1/3;this.nextTangentCoefficient=1/3}static mkSiteP(e){let t=new We;return t.point=e,t}static mkSiteSP(e,t){let i=new We;return i.point=t,i.prev=e,e.next=i,i}static mkSiteSPS(e,t,i){let n=new We;return n.prev=e,n.point=t,n.next=i,e.next=n,i.prev=n,n}get turn(){return this.next==null||this.prev==null?0:m.getTriangleOrientation(this.prev.point,this.point,this.next.point)}clone(){let e=new We;return e.previouisBezierCoefficient=this.previouisBezierCoefficient,e.point=this.point,e}};var ot=class{static mkFromPoints(e){let t=null,i=null;for(let n of e)if(i==null)i=We.mkSiteP(n),t=new ot(i);else{let o=We.mkSiteP(n);o.prev=i,i.next=o,i=o}return t}clone(){let e=this.headSite,t=null,i,n=null;for(;e!=null;)i=e.clone(),i.prev=t,t!=null?t.next=i:n=i,e=e.next,t=i;return new ot(n)}constructor(e){this.headSite=e}get lastSite(){let e=this.headSite;for(;e.next!=null;)e=e.next;return e}*[Symbol.iterator](){let e=this.headSite;for(;e!=null;)yield e.point,e=e.next}createCurve(){let e=new I,t=this.headSite,i;do{let n=I.findCorner(t);if(n==null)break;let o=ot.createBezierSegOnSite(n.b);e.segs.length===0?m.closeDistEps(t.point,o.start)||I.addLineSegment(e,t.point,o.start):m.closeDistEps(e.end,o.start)||I.continueWithLineSegmentP(e,o.start),e.addSegment(o),t=n.b}while(!0);return e.segs.length===0?m.closeDistEps(t.point,t.next.point)?e.segs.push(new Me(t.point,t.point.add(new m(5,5)),t.point.add(new m(-5,5)),i.point)):I.addLineSegment(e,t.point,t.next.point):m.closeDistEps(e.end,t.next.point)||I.continueWithLineSegmentP(e,t.next.point),e}static createBezierSegOnSite(e){let t=e.previouisBezierCoefficient,i=e.nextBezierCoefficient,n=e.prev,o=e.next,a=n.point.mul(t).add(e.point.mul(1-t)),l=o.point.mul(i).add(e.point.mul(1-i)),u=a.mul(e.previousTangentCoefficient).add(e.point.mul(1-e.previousTangentCoefficient)),c=l.mul(e.nextTangentCoefficient).add(e.point.mul(1-e.nextTangentCoefficient));return Me.mkBezier([a,u,c,l])}};var Et=class{get Elements(){return this.elements}getElem(e,t){return this.elements[e][t]}setElem(e,t,i){this.elements[e][t]=i}static Divide(e,t){return e.multiply(t.inverse())}isIdentity(){return ue(this.elements[0][0],1)&&ue(this.elements[0][1],0)&&ue(this.elements[0][2],0)&&ue(this.elements[1][0],0)&&ue(this.elements[1][1],1)&&ue(this.elements[1][2],0)}offset(){return new m(this.getElem(0,2),this.getElem(1,2))}static getIdentity(){return new Et(1,0,0,0,1,0)}constructor(e,t,i,n,o,a){this.elements=[[e,t,i],[n,o,a]]}static rotation(e){let t=Math.cos(e),i=Math.sin(e);return new Et(t,-i,0,i,t,0)}static scaleAroundCenterTransformation(e,t,i){let n=1-e,o=1-t;return new Et(e,0,n*i.x,0,t,o*i.y)}multiplyPoint(e){return new m(this.getElem(0,0)*e.x+this.getElem(0,1)*e.y+this.getElem(0,2),this.getElem(1,0)*e.x+this.getElem(1,1)*e.y+this.getElem(1,2))}multiply(e){return e!=null?new Et(this.getElem(0,0)*e.getElem(0,0)+this.getElem(0,1)*e.getElem(1,0),this.getElem(0,0)*e.getElem(0,1)+this.getElem(0,1)*e.getElem(1,1),this.getElem(0,0)*e.getElem(0,2)+this.getElem(0,1)*e.getElem(1,2)+this.getElem(0,2),this.getElem(1,0)*e.getElem(0,0)+this.getElem(1,1)*e.getElem(1,0),this.getElem(1,0)*e.getElem(0,1)+this.getElem(1,1)*e.getElem(1,1),this.getElem(1,0)*e.getElem(0,2)+this.getElem(1,1)*e.getElem(1,2)+this.getElem(1,2)):null}inverse(){let e=this.getElem(0,0)*this.getElem(1,1)-this.getElem(1,0)*this.getElem(0,1),t=this.getElem(1,1)/e,i=-this.getElem(0,1)/e,n=-this.getElem(1,0)/e,o=this.getElem(0,0)/e,a=-t*this.getElem(0,2)-i*this.getElem(1,2),l=-n*this.getElem(0,2)-o*this.getElem(1,2);return new Et(t,i,a,n,o,l)}};var To=class{static mkEllipse(e,t,i){return pe.mkFullEllipseNNP(e,t,i)}static createParallelogram(e,t,i){let n=t/2,o=e/2,a=i.x,l=i.y,u=80*Math.PI/180,c=n/Math.tan(u);return ne.mkClosedFromPoints([new m(-o-c+a,-n+l),new m(o+a,-n+l),new m(o+a+c,n+l),new m(-o+a,n+l)])}static createHexagon(e,t,i){let n=t/2,o=e/2,a=i.x,l=i.y;return ne.mkClosedFromPoints([new m(-o+a,-n+l),new m(o+a,-n+l),new m(o+(n+a),0+l),new m(o+a,n+l),new m(-o+a,n+l),new m(-(o-n)+a,0+l)])}static createOctagon(e,t,i){let n=e/2,o=t/2,a=new Array(8);a[0]=new m(n+To.octagonPad*n,o-o*To.octagonPad),a[3]=new m(a[0].x*-1,a[0].y),a[4]=new m(a[3].x,a[3].y*-1),a[7]=new m(a[0].x,a[0].y*-1),a[1]=new m(n-n*To.octagonPad,o+o*To.octagonPad),a[2]=new m(a[1].x*-1,a[1].y),a[6]=new m(a[1].x,a[1].y*-1),a[5]=new m(a[2].x,a[2].y*-1);for(let l=0;l<8;l++)a[l]=a[l].add(i);return ne.mkClosedFromPoints(a)}static createInvertedHouse(e,t,i){let n=To.createHouse(e,t,i);return To.rotateCurveAroundCenterByDegree(n,i,180)}static createHouse(e,t,i){let n=e/2,o=t/2,a=i.x,l=i.y,u=new I;return I.addLineSegmentCNNNN(u,a-n,l-o,a+n,l-o),I.continueWithLineSegmentNN(u,a+n,l+o),I.continueWithLineSegmentNN(u,a,l+2*o),I.continueWithLineSegmentNN(u,a-n,l+o),I.closeCurve(u)}static mkDiamond(e,t,i){let n=e,o=t,a=i.x,l=i.y,u=new I,c=[new m(a,l-o),new m(a+n,l),new m(a,l+o),new m(a-n,l)];return u.addSegs([k.mkPP(c[0],c[1]),k.mkPP(c[1],c[2]),k.mkPP(c[2],c[3]),k.mkPP(c[3],c[0])]),u}static rotateCurveAroundCenterByDegree(e,t,i){return To.rotateCurveAroundCenterByRadian(e,t,i*Math.PI/180)}static rotateCurveAroundCenterByRadian(e,t,i){let n=Math.cos(i),o=Math.sin(i),a=new Et(1,0,t.x,0,1,t.y).multiply(new Et(n,-o,0,o,n,0)).multiply(new Et(1,0,-t.x,0,1,-t.y));return e.transform(a)}static mkCircle(e,t){return pe.mkCircle(e,t)}static createRectangle(e,t,i){let n=e/2,o=t/2,a=i.x,l=i.y,u=new I,c=[new m(a-n,l-o),new m(a+n,l-o),new m(a+n,l+o),new m(a-n,l+o)];return u.addSegs([k.mkPP(c[0],c[1]),k.mkPP(c[1],c[2]),k.mkPP(c[2],c[3]),k.mkPP(c[3],c[0])]),u}static isRoundedRect(e){if(!(e instanceof I))return;let t=e.segs;if(t.length!==8&&t.length!==4)return;let i=t.length===8,n,o;for(let a=0;a<4;a++){let l=i?2*a+1:a;if(a===0){if(!(t[l]instanceof pe))return;let u=t[l];n=u.aAxis.length,o=u.bAxis.length}else{if(!(t[l]instanceof pe))return;let u=t[l];if(n!==u.aAxis.length||o!==u.bAxis.length)return}}return{radX:n,radY:o}}static mkRectangleWithRoundedCorners(e,t,i,n,o=new m(0,0)){if(i===0||n===0)return To.createRectangle(e,t,o);let a=new I,l=e/2;i>l/2&&(i=l/2);let u=t/2;n>u/2&&(n=u/2);let c=o.x,h=o.y,d=l-i,f=u-n,p=h+u,S=h-u,E=c-l,C=c+l,O=new m(i,0),B=new m(0,n);return d>0&&a.addSegment(k.mkPP(new m(c-d,S),new m(c+d,S))),a.addSegment(pe.mkEllipse(1.5*Math.PI,2*Math.PI,O,B,c+d,h-f)),f>0&&a.addSegment(k.mkPP(new m(C,h-f),new m(C,h+f))),a.addSegment(pe.mkEllipse(0,.5*Math.PI,O,B,c+d,h+f)),d>0&&a.addSegment(k.mkPP(new m(c+d,p),new m(c-d,p))),a.addSegment(pe.mkEllipse(.5*Math.PI,Math.PI,O,B,c-d,h+f)),f>0&&a.addSegment(k.mkPP(new m(E,h+f),new m(E,h-f))),a.addSegment(pe.mkEllipse(Math.PI,1.5*Math.PI,O,B,c-d,h-f)),a}},Fe=To;Fe.octagonPad=1/4;function Pn(s){return s.parEnd-s.parStart}function Kp(s){switch(s.type){case"ellipse":return pe.fromJSON(s.data);case"curve":return I.fromJSON(s.data);case"lineSegment":return k.fromJSON(s.data);case"bezier":return Me.fromJSON(s.data);case"polyline":return ne.fromJSON(s.data)}}function R_(s){if(s instanceof pe)return"ellipse";if(s instanceof I)return"curve";if(s instanceof k)return"lineSegment";if(s instanceof Me)return"bezier";if(s instanceof ne)return"polyline";throw new Error("not implemented")}function Zp(s){return{type:R_(s),data:s.toJSON()}}var ci=class{static get DifferenceEpsilon(){return ci.differenceEpsilon}static EqualPP(e,t){return ci.Equal(e.x,t.x)&&ci.Equal(e.y,t.y)}static Equal(e,t){return ci.Compare(e,t)===0}static Compare(e,t){let i=0;return e+ci.DifferenceEpsilon<t?i=-1:t+ci.DifferenceEpsilon<e&&(i=1),i}static ComparePP(e,t){let i=ci.Compare(e.x,t.x);return i===0&&(i=ci.Compare(e.y,t.y)),i}static LessOrEqual(e,t){let i=ci.Compare(e,t);return i<0||i===0}static Less(e,t){return ci.Compare(e,t)<0}static GetDirections(e,t){return K.DirectionFromPointToPoint(e,t)}static IsPureDirection(e,t){return K.IsPureDirection(ci.GetDirections(e,t))}static IsPureDirectionD(e){return K.IsPureDirection(e)}static IsPureLower(e,t){let i=ci.GetDirections(e,t);return 2===i||1===i}static GetPureDirectionVV(e,t){return ci.GetDirections(e.point,t.point)}},U=ci;U.differenceEpsilon=R.distanceEpsilon/2;var K=class{constructor(e){this.Dir=e}get Right(){return new K(K.RotateRight(this.Dir))}static RotateRight(e){switch(e){case 1:return 2;case 2:return 4;case 4:return 8;case 8:return 1;default:throw new Error}}static RotateLeft(e){switch(e){case 1:return 8;case 8:return 4;case 4:return 2;case 2:return 1;default:throw new Error}}static ToIndex(e){switch(e){case 1:return 0;case 2:return 1;case 4:return 2;case 8:return 3;default:throw new Error}}static VectorDirection(e){let t=0;return e.x>U.DifferenceEpsilon?t=2:e.x<-U.DifferenceEpsilon&&(t=8),e.y>U.DifferenceEpsilon?t=t|1:e.y<-U.DifferenceEpsilon&&(t=t|4),t}static VectorDirectionPP(e,t){let i=0,n=t.x-e.x,o=t.y-e.y;return n>U.DifferenceEpsilon?i=2:-n>U.DifferenceEpsilon&&(i=8),o>U.DifferenceEpsilon?i|=1:-o>U.DifferenceEpsilon&&(i|=4),i}static DirectionFromPointToPoint(e,t){return K.VectorDirectionPP(e,t)}static OppositeDir(e){switch(e){case 1:return 4;case 8:return 2;case 4:return 1;case 2:return 8;default:return 0}}static IsPureDirection(e){switch(e){case 1:return!0;case 2:return!0;case 4:return!0;case 8:return!0;default:return!1}}static IsPureDirectionPP(e,t){return K.IsPureDirection(K.DirectionFromPointToPoint(e,t))}static DirectionsAreParallel(e,t){return e===t||e===K.OppositeDir(t)}ToPoint(){let e=0,t=0;return(this.Dir&2)===2&&e++,(this.Dir&1)===1&&t++,(this.Dir&8)===8&&e--,(this.Dir&4)===4&&t--,new m(e,t)}static toPoint(e){return new K(e).ToPoint()}static negate(e){return new K(K.OppositeDir(e.Dir))}};var Wi=class extends xe{constructor(t,i){super(t);this._isPositioned=!1;i&&(this.boundingBox=X.mkPP(new m(0,0),new m(i.width,i.height)))}clone(){let t=new Wi(null,null);return t.isPositioned=this.isPositioned,t._boundingBox=this._boundingBox.clone(),t.attachmentSegmentEnd=this.attachmentSegmentEnd,t.attachmentSegmentStart=this.attachmentSegmentStart,t}get isPositioned(){return this._isPositioned}set isPositioned(t){this._isPositioned=t}get boundingBox(){return this._boundingBox}set boundingBox(t){this._boundingBox=t}setBoundingBox(t){this.isPositioned=!0,this._boundingBox=t}get width(){return this.boundingBox.width}set width(t){this.boundingBox.width=t}get height(){return this.boundingBox.height}set height(t){this.boundingBox.height=t}get center(){return this.boundingBox.center}set center(t){this.boundingBox.center=t}translate(t){this.isPositioned&&(this.center=this.center.add(t))}transform(t){this.isPositioned&&(this.center=t.multiplyPoint(this.center))}positionCenter(t){this.boundingBox.center=t,this.isPositioned=!0}};var Ye=class extends xe{constructor(t){super(t);this.lineWidth=1}*getSmoothPolyPoints(){yield this.source.center,this.curve instanceof I?yield*this.getCurvePoints(this.curve):this.curve instanceof k?(yield this.curve.start,yield this.curve.end):this.curve instanceof pe?(yield this.curve.start,yield this.curve.value((this.curve.parStart+this.curve.parEnd)/.5),yield this.curve.end):this.curve instanceof Me&&(yield this.curve.start,yield this.curve.value(.25),yield this.curve.value(.75),yield this.curve.end),yield this.target.center}*getCurvePoints(t){for(let i of t.segs)if(yield i.start,i instanceof Me){let n=O_(i);n&&(yield n)}yield t.end}static getGeom(t){return xe.getGeom(t)}clone(){let t=new Ye(null);return this.smoothedPolyline&&(t.smoothedPolyline=this.smoothedPolyline.clone()),t.curve=this.curve.clone(),this.sourceArrowhead!=null&&(t.sourceArrowhead=this.sourceArrowhead.clone()),this.targetArrowhead!=null&&(t.targetArrowhead=this.targetArrowhead.clone()),t}get label(){return this.edge!=null&&this.edge.label!=null?xe.getGeom(this.edge.label):null}set label(t){this.edge.label.setAttr(Xe.GeomObjectIndex,t)}RaiseLayoutChangeEvent(t){this.edge.raiseEvents(t)}requireRouting(){this.curve=null,this.smoothedPolyline=null}translate(t){if(!(t.x===0&&t.y===0)){if(this.curve!=null&&this.curve.translate(t),this.smoothedPolyline!=null)for(let i=this.smoothedPolyline.headSite,n=this.smoothedPolyline.headSite;i!=null;i=i.next,n=n.next)i.point=n.point.add(t);if(this.sourceArrowhead!=null&&this.sourceArrowhead.tipPosition&&(this.sourceArrowhead.tipPosition=this.sourceArrowhead.tipPosition.add(t)),this.targetArrowhead!=null&&this.targetArrowhead.tipPosition&&(this.targetArrowhead.tipPosition=this.targetArrowhead.tipPosition.add(t)),this.edge.label){let i=Wi.getGeom(this.edge.label);i&&i.translate(t)}}}GetMaxArrowheadLength(){let t=0;return this.sourceArrowhead!=null&&(t=this.sourceArrowhead.length),this.targetArrowhead!=null&&this.targetArrowhead.length>t?this.targetArrowhead.length:t}transform(t){if(this.curve!=null){if(this.curve=this.curve.transform(t),this.smoothedPolyline!=null)for(let i=this.smoothedPolyline.headSite,n=this.smoothedPolyline.headSite;i!=null;i=i.next,n=n.next)i.point=t.multiplyPoint(i.point);this.sourceArrowhead!=null&&(this.sourceArrowhead.tipPosition=t.multiplyPoint(this.sourceArrowhead.tipPosition)),this.targetArrowhead!=null&&(this.targetArrowhead.tipPosition=t.multiplyPoint(this.targetArrowhead.tipPosition))}}get edge(){return this.entity}get source(){return xe.getGeom(this.edge.source)}*sourceArrowheadPoints(t){if(this.sourceArrowhead==null)return;yield this.sourceArrowhead.tipPosition;let i=this.sourceArrowhead.tipPosition.sub(this.curve.start);i=i.rotate90Cw().mul(Math.tan(t*.5*(Math.PI/180))),yield i.add(this.curve.start),yield this.curve.start.sub(i)}*targetArrowheadPoints(t){if(this.targetArrowhead==null)return;yield this.targetArrowhead.tipPosition;let i=this.targetArrowhead.tipPosition.sub(this.curve.end);i=i.rotate90Cw().mul(Math.tan(t*.5*(Math.PI/180))),yield i.add(this.curve.end),yield this.curve.end.sub(i)}get boundingBox(){let t=X.mkEmpty();if(this.smoothedPolyline!=null)for(let n of this.smoothedPolyline)t.add(n);this.curve!=null&&t.addRecSelf(this.curve.boundingBox);for(let n of this.sourceArrowheadPoints(25))t.add(n);for(let n of this.targetArrowheadPoints(25))t.add(n);this.label&&t.addRecSelf(this.label.boundingBox);let i=this.lineWidth;return t.left-=i,t.top+=i,t.right+=i,t.bottom-=i,t}isInterGraphEdge(){return this.edge.isInterGraphEdge()}get target(){return xe.getGeom(this.edge.target)}toString(){return this.source.toString()+"->"+this.target}static RouteSelfEdge(t,i,n){let o=t.boundingBox.width,a=t.boundingBox.height,l=t.boundingBox.center,u=new m(l.x-o/4,l.y),c=new m(l.x-o/4,l.y-a/2-i),h=new m(l.x+o/4,l.y-a/2-i),d=new m(l.x+o/4,l.y);return n.smoothedPolyline=ot.mkFromPoints([u,c,h,d]),n.smoothedPolyline.createCurve()}underCollapsedGraph(){return this.source.underCollapsedGraph()||this.target.underCollapsedGraph()}EdgeToAncestor(){return this.edge.EdgeToAncestor()}};function O_(s){return m.lineLineIntersection(s.b[0],s.b[1],s.b[2],s.b[3])}var Ld=Ae(yn(),1);function N_(s,e,t,i,n,o){for(let l=0;l<s.length;l++){if(l===e||l===t)continue;let u=o.box0.add_rect(s[l].irect),c=u.area-o.box0.area,h=o.box1.add_rect(s[l].irect),d=h.area-o.box1.area;i.length*2<n.length?(i.push(s[l]),o.box0=u):n.length*2<i.length?(n.push(s[l]),o.box1=h):c<d?(i.push(s[l]),o.box0=u):d<c?(n.push(s[l]),o.box1=h):o.box0.area<o.box1.area?(i.push(s[l]),o.box0=u):(n.push(s[l]),o.box1=h)}}function tt(s){if(s.length===0)return null;if(s.length===1)return s[0];let e={b0:s[0].irect,seed0:1},t=M_(s,e),i=[],n=[];i.push(s[e.seed0]),n.push(s[t]);let o={box0:s[e.seed0].irect,box1:s[t].irect};N_(s,e.seed0,t,i,n,o);let a=mC(s.length);return a.irect=o.box0.add_rect(o.box1),a.Left=tt(i),a.Right=tt(n),a}function pC(s,e){return s.add_rect(e).area}function M_(s,e){let t=pC(e.b0,s[e.seed0].irect);for(let n=2;n<s.length;n++){let o=pC(e.b0,s[n].irect);o>t&&(e.seed0=n,t=o)}let i;for(let n=0;n<s.length;n++)if(n!==e.seed0){i=n;break}t=s[e.seed0].irect.add_rect(s[i].irect).area;for(let n=0;n<s.length;n++){if(n===e.seed0)continue;let o=s[e.seed0].irect.add_rect(s[n].irect).area;o>t&&(i=n,t=o)}return i}function ms(s,e){if(s==null||e==null)return null;let t=Array.from(s).map(i=>ct(i,e(i)));return tt(t)}function mC(s){let e=new kl;return e.Count=s,e}function ct(s,e){let t=new kl;return t.UserData=s,t.irect=e,t.Count=1,t}function A0(s,e,t){return s.irect.intersects_rect(t)?e(s.UserData)===0?s.Left!=null?A0(s.Left,e,t)===0&&A0(s.Right,e,t)===0?0:1:0:1:0}var kl=class{toString(){return this.IsLeaf?this.Count.toString()+" "+this.UserData:this.Count.toString()}get IsLeaf(){return this.left==null}get Left(){return this.left}set Left(e){this.left!=null&&this.left.Parent===this&&(this.left.Parent=null),this.left=e,this.left!=null&&(this.left.Parent=this)}get Right(){return this.right}set Right(e){this.right!=null&&this.right.Parent===this&&(this.right.Parent=null),this.right=e,this.right!=null&&(this.right.Parent=this)}get IsLeftChild(){return this===this.Parent.Left}FirstIntersectedNode(e){var t;return e.intersects_rect(this.irect)?this.IsLeaf?this:(t=this.Left.FirstIntersectedNode(e))!=null?t:this.Right.FirstIntersectedNode(e):null}FirstHitNodeWithPredicate(e,t){var i;return this.irect.contains_point(e)?this.IsLeaf?t(e,this.UserData)===1?this:null:(i=this.Left.FirstHitNodeWithPredicate(e,t))!=null?i:this.Right.FirstHitNodeWithPredicate(e,t):null}FirstHitByRectWithPredicate(e,t){var i;return this.irect.intersects_rect(e)?this.IsLeaf?t(this.UserData)===1?this:null:(i=this.Left.FirstHitByRectWithPredicate(e,t))!=null?i:this.Right.FirstHitByRectWithPredicate(e,t):null}FirstHitNode(e){var t;return this.irect.contains_point(e)?this.IsLeaf?this:(t=this.Left.FirstHitNode(e))!=null?t:this.Right.FirstHitNode(e):null}*AllHitItems(e,t=null){let i=new Ld.Stack;for(i.push(this);i.size>0;){let n=i.pop();n.irect.intersects_rect(e)&&(n.IsLeaf?(t==null||t(n.UserData))&&(yield n.UserData):(i.push(n.left),i.push(n.right)))}}*AllHitItems_(e){let t=new Ld.Stack;for(t.push(this);t.size>0;){let i=t.pop();i.irect.contains_point(e)&&(i.IsLeaf?yield i.UserData:(t.push(i.left),t.push(i.right)))}}VisitTree(e,t){A0(this,e,t)}Clone(){let e=mC(this.Count);return e.UserData=this.UserData,e.irect=this.irect,this.Left!=null&&(e.Left=this.Left.Clone()),this.Right!=null&&(e.Right=this.Right.Clone()),e}*GetNodeItemsIntersectingRectangle(e){for(let t of this.GetLeafRectangleNodesIntersectingRectangle(e))yield t.UserData}*GetLeafRectangleNodesIntersectingRectangle(e){let t=new Ld.Stack;for(t.push(this);t.size>0;){let i=t.pop();i.irect.intersects_rect(e)&&(i.IsLeaf?yield i:(t.push(i.left),t.push(i.right)))}}*GetAllLeaves(){for(let e of this.GetAllLeafNodes())yield e.UserData}*GetAllLeafNodes(){for(let e of this.EnumRectangleNodes(!0))yield e}*EnumRectangleNodes(e){let t=new Ld.Stack;for(t.push(this);t.size>0;){let i=t.pop();(i.IsLeaf||!e)&&(yield i),i.IsLeaf||(t.push(i.left),t.push(i.right))}}TraverseHierarchy(e,t){t(e),e.Left!=null&&this.TraverseHierarchy(e.Left,t),e.Right!=null&&this.TraverseHierarchy(e.Right,t)}};var xt=class{constructor(e,t){xc(e,t)<0?(this._first=e,this._second=t):(this._first=t,this._second=e)}get first(){return this._first}get second(){return this._second}get Length(){return ze(this._first,this._second)}CompareTo(e){let t=xc(this._first,e._first);return t!==0?t:xc(this._second,e._second)}static equal(e,t){return e._first.equal(t._first)&&e._second.equal(t._second)}toString(){return this._first+(" "+this._second)}};var He=class{constructor(){this.size_=0;this.mapOfSets=new Map}delete(e){return this.deletexy(e.x,e.y)}clear(){this.mapOfSets.clear(),this.size_=0}get size(){return this.size_}static mk(e){let t=new He;for(let i of e)t.add(i);return t}addxy(e,t){let i=this.mapOfSets.get(e);i==null&&this.mapOfSets.set(e,i=new Set),i.has(t)||this.size_++,i.add(t)}add(e){return this.addxy(e.x,e.y),this}deletexy(e,t){let i=this.mapOfSets.get(e);return i!=null&&i.delete(t)?(this.size_--,!0):!1}hasxy(e,t){return this.mapOfSets.has(e)&&this.mapOfSets.get(e).has(t)}has(e){return this.hasxy(e.x,e.y)}forEach(e,t){for(let i of this)e(i,i,t)}*entries(){for(let e of this)yield[e,e]}keys(){return this.values()}*values(){for(let e of this.mapOfSets)for(let t of e[1])yield new m(e[0],t)}[(Symbol.toStringTag,Symbol.iterator)](){return this.values()}};function bs(s,e){let t=new Set;for(let i of s)e.has(i)||t.add(i);return t}function bC(s,e){let t=new He;for(let i of s)e.has(i)||t.add(i);return t}function Vn(s,e){let t=new Set(s);for(let i of e)t.add(i);return t}function Io(s,e){for(let t of e)s.push(t)}function Un(s,e){let t=new Set;if(s.size<e.size)for(let i of s)e.has(i)&&t.add(i);else for(let i of e)s.has(i)&&t.add(i);return t}function PC(s){if(s.length===0)return new Set;let e=s[0];for(let t=1;t<s.length;t++)e=Un(e,s[t]);return e}function ua(s,e){for(let t of e)s.add(t)}function Vl(s,e){if(s.size!==e.size)return!1;for(let t of s)if(!e.has(t))return!1;return!0}function wo(s,e){let t=[];for(let i of s)for(let n of e(i))t.push(n);return t}function Ul(s,e,t){let i=s.get(e);i||(i=new Set,s.set(e,i)),i.add(t)}function zl(s,e,t){let i=s.get(e);i||(i=new Array,s.set(e,i)),i.push(t)}function T0(s,e,t){let i=s.get(e);i||(i=new Set,s.set(e,i)),i.add(t)}function yC(s,e,t){T0(s,new xt(e[0],e[1]),t)}function B_(s,e,t){let i=s.get(e);i&&i.delete(t)}function I0(s,e,t){B_(s,new xt(e[0],e[1]),t)}var R0=Ae(zn(),1);var Ce=class{static assert(e,t=null){if(!e)throw t!=null?(console.log(t),new Error(t)):new Error("condition does not hold")}};var Ps=class{constructor(){this.attrs=[];this._parent=null}addEvent(e){this.events.push(e)}removeEvent(e){let t=this.events.indexOf(e);t>=0&&(this.events=this.events.splice(t,1))}raiseEvents(e){this.events.forEach(t=>t(e))}clearAttr(){this.attrs=[]}setAttr(e,t){this.attrs[e]=t}getAttr(e){return this.attrs[e]}get parent(){return this._parent}set parent(e){this._parent=e}*getAncestors(){let e=this.parent;for(;e!=null;)yield e,e=e.parent}isDescendantOf(e){for(let t of this.getAncestors())if(t===e)return!0;return!1}};var hi=class extends Ps{constructor(t,i){super();this.source=t,this.target=i,t!==i?(t.outEdges.add(this),i.inEdges.add(this)):t.selfEdges.add(this)}add(){this.source!==this.target?(this.source.outEdges.add(this),this.target.inEdges.add(this)):this.source.selfEdges.add(this)}remove(){this.source!==this.target?(this.source.outEdges.delete(this),this.target.inEdges.delete(this)):this.source.selfEdges.delete(this)}toString(){return"("+this.source.toString()+"->"+this.target.toString()+")"}isInterGraphEdge(){return this.source.parent!==this.target.parent}EdgeToAncestor(){return this.source instanceof Te&&this.target.isDescendantOf(this.source)?1:this.target instanceof Te&&this.source.isDescendantOf(this.target)?2:0}};var Hi=class extends Ps{constructor(t){super();this.inEdges=new Set;this.outEdges=new Set;this.selfEdges=new Set;this.id=t}removeOutEdge(t){this.outEdges.delete(t)}removeInEdge(t){this.inEdges.delete(t)}get id(){return this._id}set id(t){this._id=t}toString(){return this.id}*_edges(){for(let t of this.inEdges)yield t;for(let t of this.outEdges)yield t;for(let t of this.selfEdges)yield t}get edges(){return this._edges()}get outDegree(){return this.outEdges.size}get inDegree(){return this.inEdges.size}get selfDegree(){return this.selfEdges.size}get degree(){return this.outDegree+this.inDegree+this.selfDegree}};var Jp=class{constructor(){this.nodeMap=new Map}remove(e){this.nodeMap.delete(e.id)}get size(){return this.nodeMap.size}*nodes_(){for(let e of this.nodeMap.values())yield e}*graphs_(){for(let e of this.nodes_())e instanceof Te&&(yield e)}findShallow(e){return this.nodeMap.get(e)}get nodesShallow(){return this.nodes_()}get graphs(){return this.graphs_()}*_edges(){for(let e of this.nodeMap.values()){for(let t of e.outEdges)yield t;for(let t of e.selfEdges)yield t}}interGraphEdges(){throw new Error("not implemented")}get nodeShallowCount(){return this.nodeMap.size}get edgeCount(){let e=0;for(let t of this.nodeMap.values())e+=t.outDegree+t.selfDegree;return e}get edges(){return this._edges()}addNode(e){this.nodeMap.set(e.id,e)}nodeIsConsistent(e){for(let t of e.outEdges)if(t.source!==e||t.source===t.target)return!1;for(let t of e.inEdges)if(t.target!==e||t.source===t.target)return!1;for(let t of e.selfEdges)if(t.target!==t.source||t.source!==e)return!1;return!0}isConsistent(){for(let e of this.nodeMap.values())if(!this.nodeIsConsistent(e))return!1;return!0}};var Te=class extends Hi{constructor(t="__graph__"){super(t);this.nodeCollection=new Jp}remove(t){this.nodeCollection.remove(t)}removeSubgraph(){let t=this.parent;t&&t.removeNode(this);for(let i of this.outGoingEdges())i.attachedAtSource?i.node.removeOutEdge(i.edge):i.node.removeInEdge(i.edge)}*outGoingEdges(){for(let t of this.outEdges){let i=t.target;this.isAncestor(i)||(yield{edge:t,node:i,attachedAtSource:!1})}for(let t of this.inEdges){let i=t.source;this.isAncestor(i)||(yield{edge:t,node:i,attachedAtSource:!0})}for(let t of this.nodesBreadthFirst){for(let i of t.outEdges){let n=i.target;n!==this&&(this.isAncestor(n)||(yield{edge:i,node:n,attachedAtSource:!1}))}for(let i of t.inEdges){let n=i.source;n!==this&&(this.isAncestor(n)||(yield{edge:i,node:n,attachedAtSource:!0}))}}}isAncestor(t){for(let i of t.getAncestors())if(i===this)return!0;return!1}*getClusteredConnectedComponents(){let t=new Set,i=new R0.Queue;for(let n of this.nodesBreadthFirst){if(t.has(n))continue;t.add(n),i.enqueue(n);let o=new Set;do{let a=i.dequeue();a.parent===this&&o.add(a);for(let l of this.reachableFrom(a))t.has(l)||(t.add(l),i.enqueue(l))}while(i.length>0);yield Array.from(o)}}*reachableFrom(t){for(let i of t.outEdges)yield i.target;for(let i of t.inEdges)yield i.source;t instanceof Te&&(yield*t.shallowNodes),t.parent!=this&&(yield t.parent)}hasSomeAttrOnIndex(t){for(let i of this.nodesBreadthFirst)if(i.getAttr(t))return!0;for(let i of this.deepEdges)if(i.getAttr(t))return!0;return!1}*graphs(){for(let t of this.nodeCollection.graphs)yield t}noEmptySubgraphs(){for(let t of this.subgraphsBreadthFirst())if(t.shallowNodeCount===0)return!1;return!0}hasSubgraphs(){for(let t of this.shallowNodes)if(t instanceof Te)return!0;return!1}*subgraphsBreadthFirst(){for(let t of this.nodesBreadthFirst)t instanceof Te&&(yield t)}isEmpty(){return this.shallowNodeCount===0}setEdge(t,i){let n=this.nodeCollection.findShallow(t);if(n==null)return;let o=this.nodeCollection.findShallow(i);if(o!=null)return new hi(n,o)}get shallowNodes(){return this.nodeCollection.nodesShallow}get nodesBreadthFirst(){return this.nodesBreadthFirst_()}*nodesBreadthFirst_(){for(let t of this.nodeCollection.nodesShallow)yield t,t instanceof Te&&(yield*t.nodesBreadthFirst)}findNodeRecursive(t){let i=this.nodeCollection.findShallow(t);if(i)return i;for(let n of this.shallowNodes)if(n instanceof Te){let o=n.findNodeRecursive(t);if(o)return o}return null}findNode(t){return this.nodeCollection.findShallow(t)}get shallowEdges(){return this.nodeCollection.edges}get deepEdges(){return this.deepEdgesIt()}*deepEdgesIt(){for(let t of this.nodesBreadthFirst){for(let i of t.outEdges)yield i;for(let i of t.selfEdges)yield i;for(let i of t.inEdges)this.isAncestor(i.source)||(yield i)}}isConsistent(){return this.parent?this.parent.isConsistent():this.eachNodeIdIsUnique()&&this.nodeCollection.isConsistent()}nodeIsConsistent(t){return this.nodeCollection.nodeIsConsistent(t)}removeNode(t){for(let i of t.outEdges)i.target.inEdges.delete(i);for(let i of t.inEdges)i.source.outEdges.delete(i);this.nodeCollection.remove(t);for(let i of this.subgraphsBreadthFirst())i.removeNode(t)}addNode(t){return Ce.assert(this.findNodeRecursive(t.id)==null),t.parent=this,this.nodeCollection.addNode(t),t}get shallowNodeCount(){return this.nodeCollection.nodeShallowCount}get nodeCountDeep(){let t=this.nodeCollection.size;for(let i of this.shallowNodes)i instanceof Te&&(t+=i.nodeCountDeep);return t}get edgeCount(){return this.nodeCollection.edgeCount}liftNode(t){for(;t!=null&&t.parent!==this;)t=t.parent;return t}get deepEdgesCount(){let t=0;for(let i of this.nodesBreadthFirst)t+=i.outDegree+i.selfDegree;return t}eachNodeIdIsUnique(){let t=new Set;for(let i of this.nodesBreadthFirst){if(t.has(i.id))return!1;t.add(i.id)}return!0}*allElements(){for(let t of this.allSuccessorsWidthFirst()){yield t;for(let i of t.selfEdges)yield i;for(let i of t.outEdges)yield i;for(let i of t.inEdges)this.isAncestor(i.source)||(yield i)}yield*this.edges}*allSuccessorsWidthFirst(){for(let t of this.shallowNodes)yield t;for(let t of this.shallowNodes)t instanceof Te&&(yield*t.allSuccessorsWidthFirst())}*allSuccessorsDepthFirst(){for(let t of this.shallowNodes)t instanceof Te&&(yield*t.allSuccessorsDepthFirst()),yield t}};function*SC(s){let e=new Set,t=new R0.Queue;for(let o of s.shallowNodes){if(e.has(o))continue;let a=new Array;for(n(o,t,e);t.length>0;){let l=t.dequeue();a.push(l);for(let u of i(l))n(u,t,e)}yield a}function*i(o){for(let a of o.outEdges)yield a.target;for(let a of o.inEdges)yield a.source}function n(o,a,l){l.has(o)||(a.enqueue(o),l.add(o))}}function O0(s,e){e.parent&&e.parent.remove(e),s.addNode(e)}function _0(s,e){let t=new Map,i=s.nodeCountDeep,n=1/i;for(let o of s.nodesBreadthFirst)t.set(o,n);for(let o=0;o<50;o++){n=(1-e)/i;let a=new Map;for(let l of s.nodesBreadthFirst)a.set(l,n);for(let l of s.nodesBreadthFirst){let u=a.get(l);for(let c of l.inEdges){let h=c.source;u+=e*(t.get(h)/h.outDegree)}a.set(l,u)}t=a}return t}function Ac(s,e){return e.has(s.source)&&e.has(s.target)}var Wl=class extends xe{constructor(){super(...arguments);this.padding=1}clone(){let t=new Wl(null);return this.boundaryCurve&&(t.boundaryCurve=this.boundaryCurve.clone()),t}translate(t){t.x===0&&t.y===0||this.boundaryCurve.translate(t)}toJSON(){return{boundaryCurve:this.boundaryCurve,padding:this.padding}}get node(){return this.entity}get boundaryCurve(){return this._boundaryCurve}set boundaryCurve(t){t!=null&&t.boundingBox&&(t.boundingBox.height<Wl.minHeight||t.boundingBox.width<Wl.minWidth)&&(t=Fe.mkCircle(Wl.minWidth,t.boundingBox.center)),this._boundaryCurve=t}get id(){return this.node.id}toString(){return this.id}static mkNode(t,i){let n=new Wl(i);return n.boundaryCurve=t,n}get center(){return this.boundaryCurve.boundingBox.center}set center(t){let i=t.sub(this.center);this.boundaryCurve.translate(i)}fitBoundaryCurveToTarget(t){if(this.boundaryCurve!=null){let i=Fe.isRoundedRect(this.boundaryCurve);if(i==null){let n=t.width/this.boundaryCurve.boundingBox.width,o=t.height/this.boundaryCurve.boundingBox.height;this.boundaryCurve=this.boundaryCurve.scaleFromOrigin(n,o),this.boundaryCurve.translate(t.center.sub(this.boundaryCurve.boundingBox.center))}else this.boundaryCurve=Fe.mkRectangleWithRoundedCorners(t.width,t.height,i.radX,i.radY,t.center)}}static getGeom(t){return t.getAttr(Xe.GeomObjectIndex)}*inEdges(){for(let t of this.node.inEdges)yield xe.getGeom(t)}*outEdges(){for(let t of this.node.outEdges)yield xe.getGeom(t)}*selfEdges(){for(let t of this.node.selfEdges)yield xe.getGeom(t)}get boundingBoxWithPadding(){let t=this.boundingBox.clone();return t.pad(this.padding),t}get boundingBox(){return this.boundaryCurve?this.boundaryCurve.boundingBox:null}set boundingBox(t){!this.boundaryCurve||(Math.abs(t.width-this.width)<1e-4&&Math.abs(t.height-this.height)<1e-4?this.center=t.center:this.fitBoundaryCurveToTarget(t))}get width(){return this.boundaryCurve.boundingBox.width}get height(){return this.boundaryCurve.boundingBox.height}transform(t){this.boundaryCurve!=null&&(this.boundaryCurve=this.boundaryCurve.transform(t))}underCollapsedGraph(){let t=this.node.parent;if(t==null)return!1;let i=xe.getGeom(t);return i==null?!1:i.isCollapsed?!0:i.underCollapsedGraph()}*getAncestors(){for(let t of this.node.getAncestors())yield xe.getGeom(t)}},lt=Wl;lt.minHeight=2,lt.minWidth=3;var Pe=class{ProgressStep(){}constructor(e){this.cancelToken=e}};var N0=class{},ca=N0;ca.GoldenRatio=(1+Math.sqrt(5))/2,ca.GoldenRatioRemainder=2-N0.GoldenRatio;var ha=class extends Pe{constructor(t,i){super(null);this.desiredAspectRatio=1.2;this.bestPacking=null;this.cachedCosts=new Map;this.rectangles=t,this.desiredAspectRatio=i}get PackedWidth(){return this.bestPacking!=null?this.bestPacking.PackedWidth:0}get PackedHeight(){return this.bestPacking!=null?this.bestPacking.PackedHeight:0}Pack(t,i,n){let o=ha.GetGoldenSectionStep(t,i),a=Math.max(n/10,(i-t)/ha.MaxSteps);i+=a,this.bestPackingCost=Number.MAX_VALUE,this.rectangles.length===1?this.PackLimit(t):this.rectangles.length===2?(this.PackLimit(t),this.PackLimit(i)):this.rectangles.length>2&&ha.GoldenSectionSearch(u=>this.PackLimit(u),t,o,i,a);let l=this.bestPacking.getRects();for(let u=0;u<this.rectangles.length;u++)this.rectangles[u]=l[u]}PackLimit(t){let i=this.cachedCosts.get(t);if(i==null){let n=this.createPacking(this.rectangles,t);n.run(),this.cachedCosts.set(t,i=Math.abs(n.PackedAspectRatio-this.desiredAspectRatio)),i<this.bestPackingCost&&(this.bestPackingCost=i,this.bestPacking=n)}return i}static GoldenSectionSearch(t,i,n,o,a){if(Math.abs(i-o)<a)return t(i)<t(o)?i:o;let l=ha.GetGoldenSectionStep(n,o),u=t(n),c=t(l),h=()=>ha.GoldenSectionSearch(t,l,n,i,a),d=()=>ha.GoldenSectionSearch(t,n,l,o,a);if(c<u)return d();if(c>u)return h();let f=d(),p=h();return t(p)<t(f)?p:f}static GetGoldenSectionStep(t,i){return t<i?t+ca.GoldenRatioRemainder*(i-t):t-ca.GoldenRatioRemainder*(t-i)}},Od=ha;Od.MaxSteps=1e3;var EC=Ae(yn(),1);var $p=class extends Pe{get PackedWidth(){return this.packedWidth}set PackedWidth(t){this.packedWidth=t}get PackedHeight(){return this.packedHeight}set PackedHeight(t){this.packedHeight=t}get PackedAspectRatio(){return this.PackedWidth/this.PackedHeight}getRects(){let t=[];for(let[i,n]of this.rectsToCenters)i.center=n,t.push(i);return t}};var da=class extends $p{constructor(t,i,n=!1){super(null);this.rectsToCenters=new Map,this.rectanglesByDescendingHeight=n?t:da.SortRectangles(t),this.wrapWidth=i}static SortRectangles(t){return t.sort((i,n)=>n.height-i.height),t}run(){this.Pack()}Pack(){this.PackedWidth=0,this.PackedHeight=0;let t=new EC.Stack,i=!1,n=0,o=0,a=0,l=this.rectanglesByDescendingHeight;for(let u=0;i||u<l.length;){let c=l[u],h=t.length>0?t.top:null;if(h==null||h.right+c.width<=this.wrapWidth&&n+c.height<=h.top){let f=new m(h?h.right:0,n).add(new m(c.width/2,c.height/2));c.center=f,this.rectsToCenters.set(c,f),o=Math.max(o,c.right),a=Math.max(a,c.top),t.push(c),i=!1}else n=h.top,t.pop(),i=!0;i||u++}this.PackedWidth=o,this.PackedHeight=a}};var Hl=class extends Od{constructor(e,t){super(da.SortRectangles(e),t),this.createPacking=(i,n)=>new da(i,n,!0)}run(){let e=Number.MAX_VALUE,t=0,i=0;for(let n of this.rectangles){let o=n.width;i+=o,e=Math.min(e,o),t=Math.max(t,o)}this.Pack(t,i,e)}};function ys(s){return new Lo(tt(s.map(([e,t])=>ct(t,e))))}function G_(s,e){s.UserData=e.UserData,s.Left=e.Left,s.Right=e.Right,s.Count--,s.irect=e.irect}function xC(s){for(let e=s.Parent;e!=null;e=e.Parent)e.Count--,e.irect=e.Left.irect.add_rect(e.Right.irect)}function F_(s,e){let t=new Array;for(let n of s.GetAllLeafNodes())n!==e&&t.push(n);let i=tt(t);s.Count=i.Count,s.Left=i.Left,s.Right=i.Right,s.irect=i.Left.irect.add_rect(i.Right.irect)}function k_(s){for(let e=s.Parent;e!=null;e=e.Parent)if(!vC(e))return e;return null}function vC(s){return 2*s.Left.Count>=s.Right.Count&&2*s.Right.Count>=s.Left.Count}function M0(s,e,t,i){return s.irect.intersects_rect(e)?s.IsLeaf?i(s.UserData)?--t.bound!==0:!0:M0(s.Left,e,t,i)&&M0(s.Right,e,t,i):!0}var Lo=class{clear(){this.RootNode=null}NumberOfIntersectedIsLessThanBound(e,t,i){return M0(this._rootNode,e,{bound:t},i)}get RootNode(){return this._rootNode}set RootNode(e){this._rootNode=e}constructor(e){this._rootNode=e}*GetAllLeaves(){if(this._rootNode!=null&&this.Count>0)for(let e of this._rootNode.GetAllLeaves())yield e}get Count(){return this._rootNode==null?0:this._rootNode.Count}Add(e,t){this.AddNode(ct(t,e))}AddNode(e){this._rootNode==null?this._rootNode=e:this.Count<=2?this._rootNode=tt(Array.from(this._rootNode.GetAllLeafNodes()).concat([e])):this.AddNodeToTreeRecursive(e,this._rootNode)}Rebuild(){this._rootNode=tt(Array.from(this._rootNode.GetAllLeafNodes()))}AddNodeToTreeRecursive(e,t){if(t.IsLeaf)t.Left=ct(t.UserData,t.irect),t.Right=e,t.Count=2;else{t.Count++;let i,n;if(2*t.Left.Count<t.Right.Count)this.AddNodeToTreeRecursive(e,t.Left),t.Left.irect=t.Left.irect.add_rect(e.irect);else if(2*t.Right.Count<t.Left.Count)this.AddNodeToTreeRecursive(e,t.Right),t.Right.irect=t.Right.irect.add_rect(e.irect);else{i=t.Left.irect.add_rect(e.irect);let o=i.area-t.Left.irect.area;n=t.Right.irect.add_rect(e.irect);let a=n.area-t.Right.irect.area;o<a?(this.AddNodeToTreeRecursive(e,t.Left),t.Left.irect=i):o>a?(this.AddNodeToTreeRecursive(e,t.Right),t.Right.irect=n):i.area<n.area?(this.AddNodeToTreeRecursive(e,t.Left),t.Left.irect=i):(this.AddNodeToTreeRecursive(e,t.Right),t.Right.irect=n)}}t.irect=t.Left.irect.add_rect(t.Right.irect)}GetAllIntersecting(e){return this._rootNode==null||this.Count===0?[]:Array.from(this._rootNode.GetNodeItemsIntersectingRectangle(e))}OneIntersecting(e){if(this._rootNode==null||this.Count===0)return;let t=this._rootNode.FirstIntersectedNode(e);if(t!=null)return{intersectedLeaf:t.UserData}}GetAllLeavesIntersectingRectangle(e){return this._rootNode==null||this.Count===0?[]:this._rootNode.GetLeafRectangleNodesIntersectingRectangle(e)}IsIntersecting(e){if(this._rootNode==null||this.Count===0)return!1;for(let t of this._rootNode.GetNodeItemsIntersectingRectangle(e))return!0;return!1}Contains(e,t){if(this._rootNode==null)return!1;for(let i of this._rootNode.GetLeafRectangleNodesIntersectingRectangle(e))if(i.UserData===t)return!0;return!1}Remove(e,t){if(this._rootNode==null)return;let i;for(let n of this._rootNode.GetLeafRectangleNodesIntersectingRectangle(e))n.UserData===t&&(i=n);if(i!=null)return this.RootNode.Count===1?this.RootNode=null:this.RemoveLeaf(i),i.UserData}RemoveLeaf(e){let t=k_(e);if(t!=null)F_(t,e),xC(t);else{let i=e.Parent;i==null?this._rootNode=new kl:(G_(i,e.IsLeftChild?i.Right:i.Left),xC(i))}}UnbalancedNode(e){for(let t=e.Parent;t!=null;t=t.Parent)if(!vC(t))return t;return null}};var em=class extends X{constructor(t){super(t);this.radX=t.radX,this.radY=t.radY,this.roundedRect_=Fe.mkRectangleWithRoundedCorners(this.width,this.height,t.radX,t.radY,this.center)}onUpdated(){this.isEmpty||(this.roundedRect_=Fe.mkRectangleWithRoundedCorners(this.width,this.height,this.radX,this.radY,this.center))}isOk(){return this.isEmpty()?!0:this.roundedRect_.boundingBox.equalEps(this)}setRect(t){this.left=t.left,this.right=t.right,this.top=t.top,this.bottom=t.bottom,this.isEmpty()||(this.roundedRect_=Fe.mkRectangleWithRoundedCorners(t.width,t.height,this.radX,this.radY,this.center))}};function tm(s,e){let t=e.map(o=>[o,o.boundingBox]),i=t.map(o=>o[1]),n=new Hl(i,1.5);n.run();for(let[o,a]of t){let l=a.leftBottom.sub(o.boundingBox.leftBottom);o.translate(l)}s.boundingBox=new X({left:0,bottom:0,right:n.PackedWidth,top:n.PackedHeight})}var be=class extends lt{constructor(t){super(t);this.margins={left:10,top:10,bottom:10,right:10};this.radX=10;this.radY=10;this.rrect=new em({left:0,right:-1,top:20,bottom:0,radX:this.radX,radY:this.radY})}isAncestor(t){return this.graph.isAncestor(t.node)}deepTranslate(t){for(let i of this.nodesBreadthFirst){i instanceof be?i.boundingBox=i.boundingBox.translate(t):i.translate(t);for(let n of i.selfEdges())n.translate(t);for(let n of i.outEdges())this.graph.isAncestor(n.target.node)&&n.translate(t)}this.boundingBox=this.boundingBox.translate(t)}clone(){let t=new be(null);return t.boundingBox=this.boundingBox.clone(),t.layoutSettings=this.layoutSettings,t.margins=this.margins,t.radX=this.radX,t.radY=this.radY,t}calculateBoundsFromChildren(){let t=X.mkEmpty();for(let i of this.shallowNodes)t.addRecSelf(i.boundingBoxWithPadding);return t.padEverywhere(this.margins),t}*allSuccessorsWidthFirst(){for(let t of this.graph.allSuccessorsWidthFirst())yield lt.getGeom(t)}static getGeom(t){return xe.getGeom(t)}edgeCurveOrArrowheadsIntersectRect(t,i){for(let a of t.sourceArrowheadPoints(25))if(i.contains(a))return!0;for(let a of t.targetArrowheadPoints(25))if(i.contains(a))return!0;let n=t.curve,o=i.perimeter();return I.intersectionOne(n,o,!1)!=null||I.PointRelativeToCurveLocation(n.start,o)===2}isEmpty(){return this.graph.isEmpty()}setSettingsRecursively(t){this.layoutSettings=t;for(let i of this.nodesBreadthFirst){let n=i;n.layoutSettings=t}}get layoutSettings(){return this._layoutSettings}set layoutSettings(t){this._layoutSettings=t}get labelSize(){return this._labelSize}set labelSize(t){this._labelSize=t}get boundingBox(){return this.rrect?this.rrect.clone():null}set boundingBox(t){t?this.rrect.setRect(t):this.rrect.roundedRect_=null}transform(t){if(!t.isIdentity()){for(let i of this.shallowNodes)i.transform(t);for(let i of this.shallowEdges)i.transform(t),i.label&&i.label.transform(t);this.boundingBox=this.rrect==null||this.rrect.isEmpty()?this.pumpTheBoxToTheGraphWithMargins():this.boundingBox.transform(t)}}translate(t){t.x===0&&t.y===0||this.deepTranslate(t)}get nodesBreadthFirst(){return this.nodesBreadthFirstIter()}*nodesBreadthFirstIter(){for(let t of this.graph.nodesBreadthFirst)yield xe.getGeom(t)}setEdge(t,i){let n=this.graph.setEdge(t,i);return new Ye(n)}getPumpedGraphWithMarginsBox(){let t={b:X.mkEmpty()};return rm(this,t),t.b.padEverywhere(this.margins),t.b}pumpTheBoxToTheGraphWithMargins(){return this.boundingBox=this.getPumpedGraphWithMarginsBox()}get center(){return this.boundingBox||this.boundingBox.isEmpty?this.boundingBox.center:new m(0,0)}set center(t){let i=t.sub(this.center),n=new Et(1,0,i.x,0,1,i.y);this.transform(n)}get left(){return this.boundingBox.left}get right(){return this.boundingBox.right}get top(){return this.boundingBox.top}get bottom(){return this.boundingBox.bottom}CheckClusterConsistency(){throw new Error("Method not implemented.")}get edgeCount(){return this.graph.edgeCount}get boundaryCurve(){return this.rrect.roundedRect_}set boundaryCurve(t){throw new Error}get shallowNodes(){return this.shallowNodes_()}*shallowNodes_(){for(let t of this.graph.shallowNodes)yield xe.getGeom(t)}get deepEdges(){return this.deepEdgesIt()}*deepEdgesIt(){for(let t of this.graph.deepEdges)yield xe.getGeom(t)}get shallowEdges(){return this.shallowEdgesIt()}*shallowEdgesIt(){for(let t of this.graph.shallowEdges)yield xe.getGeom(t)}static mk(t,i=new wt(0,0)){let n=new be(new Te(t));return n.labelSize=i,n}get Clusters(){return this.subgraphs()}*subgraphs(){for(let t of this.graph.subgraphsBreadthFirst())yield xe.getGeom(t)}static mkWithGraphAndLabel(t,i){let n=new be(t);return n.labelSize=i,n}get deepNodeCount(){let t=0;for(let i of this.graph.nodesBreadthFirst)t++;return t}get subgraphsDepthFirst(){return this.getSubgraphsDepthFirst()}*getSubgraphsDepthFirst(){for(let t of this.graph.allSuccessorsDepthFirst())t instanceof Te&&(yield be.getGeom(t))}get uniformMargins(){return Math.max(this.margins.left,this.margins.right,this.margins.right,this.margins.bottom)}set uniformMargins(t){this.margins.left=this.margins.right=this.margins.right=this.margins.bottom=t}get height(){return this.boundingBox.height}get width(){return this.boundingBox.width}get shallowNodeCount(){return this.graph.shallowNodeCount}get graph(){return this.entity}liftNode(t){let i=this.graph.liftNode(t.node);return i?xe.getGeom(i):null}findNode(t){let i=this.graph.findNode(t);return i?xe.getGeom(i):null}addNode(t){return this.graph.addNode(t.node),t}addLabelToGraphBB(t){this.labelSize&&(t.top+=this.labelSize.height+2,t.width<this.labelSize.width&&(t.width=this.labelSize.width))}};function rm(s,e){for(let i of s.shallowEdges){if(!t(i))continue;let n=i.curve.boundingBox;if(e.b.addRecSelf(n),i.edge.label!=null){let o=xe.getGeom(i.edge.label);o&&e.b.addRecSelf(o.boundingBox)}}for(let i of s.shallowNodes)"shallowEdges"in i&&rm(i,e),!(i.underCollapsedGraph()||!i.boundingBox)&&e.b.addRecSelf(i.boundingBox);s instanceof be&&s.addLabelToGraphBB(e.b);function t(i){if(i==null||i.curve==null||i.underCollapsedGraph())return!1;if(s instanceof be){let n=s.entity;return n.isAncestor(i.source.entity)&&n.isAncestor(i.target.entity)}else return!0}}var me=class{constructor(e,t){this.x=e,this.y=t}get source(){return this.x}get target(){return this.y}isDiagonal(){return this.x===this.y}};var jr=class{isEmpty(){if(this.arrayOfMaps.length===0)return!0;for(let e of this.arrayOfMaps)if(e.size>0)return!1;return!0}set(e,t,i){let n=this.arrayOfMaps[e];n===void 0&&(this.arrayOfMaps[e]=n=new Map),n.set(t,i)}setPair(e,t){this.set(e.x,e.y,t)}delete(e,t){if(e<0||e>=this.arrayOfMaps.length)return;let i=this.arrayOfMaps[e];i!==void 0&&(i.delete(t),i.size===0&&(this.arrayOfMaps[e]=void 0))}has(e,t){if(e<0||e>=this.arrayOfMaps.length)return!1;let i=this.arrayOfMaps[e];return i===void 0?!1:i.has(t)}get(e,t){if(e<0||e>=this.arrayOfMaps.length)return null;let i=this.arrayOfMaps[e];return i===void 0?null:i.get(t)}getI(e){return this.get(e.x,e.y)}constructor(){this.arrayOfMaps=new Array}*keys(){for(let e=0;e<this.arrayOfMaps.length;e++){let t=this.arrayOfMaps[e];if(t!==void 0)for(let i of t)yield new me(e,i[0])}}*keyValues(){for(let e=0;e<this.arrayOfMaps.length;e++){let t=this.arrayOfMaps[e];if(t!==void 0)for(let i of t)yield[new me(e,i[0]),i[1]]}}*values(){for(let e=0;e<this.arrayOfMaps.length;e++){let t=this.arrayOfMaps[e];if(t!==void 0)for(let i of t)yield i[1]}}get size(){let e=0;for(let t=0;t<this.arrayOfMaps.length;t++){let i=this.arrayOfMaps[t];i!==void 0&&(e+=i.size)}return e}};var Ro=class{constructor(e){this._curveClips=[];this.arrowheads=[],this.nodes=[],this.labels=[],this.rect=e,this._curveClips=[]}get curveClips(){return this._curveClips}set curveClips(e){this._curveClips=e}addCurveClip(e){Ce.assert(!(e.curve instanceof I),"CurveClip.curve should not be a Curve!"),this._curveClips.push(e)}isEmpty(){return this._curveClips.length==0&&this.arrowheads.length==0&&this.nodes.length==0&&this.labels.length==0}initCurveClips(){this._curveClips=[]}clear(){this.arrowheads=[],this.nodes=[],this.labels=[],this._curveClips=[]}get entityCount(){return this._curveClips.length+this.arrowheads.length+this.labels.length+this.nodes.length}addElement(e){if(e instanceof lt)this.nodes.push(e);else if(e instanceof Wi)this.labels.push(e);else if("curve"in e)if(e.curve instanceof I)for(let t of e.curve.segs)this.addCurveClip({edge:e.edge,curve:t,startPar:t.parStart,endPar:t.parEnd});else this.addCurveClip(e);else this.arrowheads.push(e)}};var B0=Ae(zn(),1);var Wn=class{constructor(e=null){this.parents=new Set;this.children=new Set;this.ports=new Set;this.BoundaryCurve=e}get Parents(){return Array.from(this.parents.values())}get Children(){return Array.from(this.children.values())}get BoundaryCurve(){return this.boundaryCurve}set BoundaryCurve(e){this.boundaryCurve=e}get BoundingBox(){return this.BoundaryCurve.boundingBox}get Ports(){return this.ports}static mkShape(){return new Wn(null)}get IsGroup(){return this.children.size>0}*Descendants(){let e=new B0.Queue;for(let t of this.Children)e.enqueue(t);for(;e.length>0;){let t=e.dequeue();yield t;for(let i of t.Children)e.enqueue(i)}}*Ancestors(){let e=new B0.Queue;for(let t of this.Parents)e.enqueue(t);for(;e.length>0;){let t=e.dequeue();yield t;for(let i of t.Parents)e.enqueue(i)}}AddParent(e){this.parents.add(e),e.children.add(this)}AddChild(e){e.parents.add(this),this.children.add(e)}RemoveChild(e){this.children.delete(e),e.parents.delete(this)}RemoveParent(e){this.parents.delete(e),e.children.delete(this)}ToString(){return this.UserData?this.UserData.toString():"null"}};var Ss=class{};var or=class extends Ss{constructor(t,i){super();this.curve=this.curve,this.location=i.clone()}get Location(){return this.location}set Location(t){this.location=t}Translate(t){this.location=this.location.add(t)}get Curve(){return this.curve}set Curve(t){this.curve=t}};var Or=class extends or{constructor(t,i,n){super(null,i().add(n));this.LocationOffset=n,this.CurveDelegate=t,this.CenterDelegate=i}static mk(t,i){return new Or(t,i,new m(0,0))}get CenterDelegate(){return this.centerDelegate}set CenterDelegate(t){this.centerDelegate=t}get CurveDelegate(){return this.curveDelegate}set CurveDelegate(t){this.curveDelegate=t}get LocationOffset(){return this.locationOffset}set LocationOffset(t){this.locationOffset=t}get Location(){return this.CenterDelegate().add(this.LocationOffset)}get Curve(){return this.CurveDelegate()}};var Tc=class{constructor(e,t,i,n,o){this.color=e,t!==void 0&&(this.item=t),i!==void 0&&(this.parent=i),n!==void 0&&(this.left=n),o!==void 0&&(this.right=o)}toString(){return this.item.toString()}};var dt=class{[Symbol.iterator](){return this.allNodes()}constructor(e){this.comparer=e,this.count=0,this.root=this.nil=new Tc(1)}clear(){this.root=this.nil=new Tc(1)}toNull(e){return e!==this.nil?e:null}isEmpty(){return this.root===this.nil}getComparer(){return this.comparer}getRoot(){return this.root}find(e,t=this.root){let i;for(;t!==this.nil&&(i=this.comparer(e,t.item))!==0;)t=i<0?t.left:t.right;return this.toNull(t)}findFirst(e,t=this.root){if(t===this.nil)return null;let i=null;for(;t!==this.nil;)t=e(t.item)?(i=t).left:t.right;return i}findLast(e,t=this.root){if(t===this.nil)return null;let i=null;for(;t!==this.nil;)t=e(t.item)?(i=t).right:t.left;return i}treeMinimum(e=this.root){for(;e.left!==this.nil;)e=e.left;return this.toNull(e)}treeMaximum(e=this.root){for(;e.right!==this.nil;)e=e.right;return this.toNull(e)}next(e){if(e.right!==this.nil)return this.treeMinimum(e.right);let t=e.parent;for(;t!==this.nil&&e===t.right;)e=t,t=t.parent;return this.toNull(t)}previous(e){if(e.left!==this.nil)return this.treeMaximum(e.left);let t=e.parent;for(;t!==this.nil&&e===t.left;)e=t,t=t.parent;return this.toNull(t)}leftRotate(e){let t=e.right;e.right=t.left,t.left!==this.nil&&(t.left.parent=e),t.parent=e.parent,e.parent===this.nil?this.root=t:e===e.parent.left?e.parent.left=t:e.parent.right=t,t.left=e,e.parent=t}rightRotate(e){let t=e.left;e.left=t.right,t.right!==this.nil&&(t.right.parent=e),t.parent=e.parent,e.parent===this.nil?this.root=t:e===e.parent.right?e.parent.right=t:e.parent.left=t,t.right=e,e.parent=t}deleteFixup(e){for(;e!==this.root&&e.color===1;)if(e===e.parent.left){let t=e.parent.right;t.color===0&&(t.color=1,e.parent.color=0,this.leftRotate(e.parent),t=e.parent.right),t.left.color===1&&t.right.color===1?(t.color=0,e=e.parent):(t.right.color===1&&(t.left.color=1,t.color=0,this.rightRotate(t),t=e.parent.right),t.color=e.parent.color,e.parent.color=1,t.right.color=1,this.leftRotate(e.parent),e=this.root)}else{let t=e.parent.left;t.color===0&&(t.color=1,e.parent.color=0,this.rightRotate(e.parent),t=e.parent.left),t.right.color===1&&t.left.color===1?(t.color=0,e=e.parent):(t.left.color===1&&(t.right.color=1,t.color=0,this.leftRotate(t),t=e.parent.left),t.color=e.parent.color,e.parent.color=1,t.left.color=1,this.rightRotate(e.parent),e=this.root)}e.color=1}deleteSubTree(e){let t;if(e.left===this.nil||e.right===this.nil)t=e;else for(t=e.right;t.left!==this.nil;)t=t.left;let i=t.left!==this.nil?t.left:t.right;return i.parent=t.parent,t.parent===this.nil?this.root=i:t===t.parent.left?t.parent.left=i:t.parent.right=i,t!==e&&(e.item=t.item),t.color===1&&this.deleteFixup(i),this.toNull(e)}deleteNodeInternal(e){this.count--,this.deleteSubTree(e)}remove(e){let t=this.find(e);return t!=null?(this.count--,this.deleteSubTree(t)):null}insert(e){let t=this.treeInsert(e);return this.insertPrivate(t),this.toNull(t)}treeInsert(e){let t=this.nil,i=this.root,n=0;for(;i!==this.nil;)t=i,n=this.comparer(e,i.item),i=n<0?i.left:i.right;let o=new Tc(1,e,t,this.nil,this.nil);return t===this.nil?this.root=o:n<0?t.left=o:t.right=o,this.toNull(o)}insertPrivate(e){for(this.count++,e.color=0;e!==this.root&&e.parent.color===0;)if(e.parent===e.parent.parent.left){let t=e.parent.parent.right;t.color===0?(e.parent.color=1,t.color=1,e.parent.parent.color=0,e=e.parent.parent):(e===e.parent.right&&(e=e.parent,this.leftRotate(e)),e.parent.color=1,e.parent.parent.color=0,this.rightRotate(e.parent.parent))}else{let t=e.parent.parent.left;t.color===0?(e.parent.color=1,t.color=1,e.parent.parent.color=0,e=e.parent.parent):(e===e.parent.left&&(e=e.parent,this.rightRotate(e)),e.parent.color=1,e.parent.parent.color=0,this.leftRotate(e.parent.parent))}this.root.color=1}*allNodes(){if(this.isEmpty())return;let e=this.treeMinimum();for(;e!=null;)yield e.item,e=this.next(e)}toString(){let e="{",t=0;for(let i of this.allNodes())e+=i.toString(),t!==this.count-1&&(e+=`
`),t++;return e+"}"}};var fa=class{constructor(e){this.heapSize=0;this.A=[],this.compare=e}*[Symbol.iterator](){for(let e=1;e<=this.heapSize;e++)yield this.A[e]}Enqueue(e){let t=this.heapSize+1;this.A[t]=e,this.heapSize++;let i=t>>1,n,o;for(;t>1&&this.Less(n=this.A[t],o=this.A[i]);)this.A[i]=n,this.A[t]=o,t=i,i=t>>1}Dequeue(){if(this.heapSize<1)throw new Error;let e=this.A[1],t=this.A[this.heapSize];return this.heapSize--,this.ChangeMinimum(t),e}ChangeMinimum(e){this.A[1]=e;let t=1,i=2,n=!1;for(;i<this.heapSize&&!n;){n=!0;let o=this.A[i],a=this.A[i+1];this.compare(o,a)<0?this.compare(o,e)<0&&(this.A[t]=o,this.A[i]=e,n=!1,t=i,i=t<<1):this.compare(a,e)<0&&(this.A[t]=a,this.A[i+1]=e,n=!1,t=i+1,i=t<<1)}if(i===this.heapSize){let o=this.A[i];this.compare(o,e)<0&&(this.A[t]=o,this.A[i]=e)}}get Count(){return this.heapSize}Less(e,t){return this.compare(e,t)<0}GetMinimum(){return this.A[1]}};var Zt=class{};var Ci=class extends Zt{constructor(t){super();this.Vertex=t}get Site(){return this.Vertex.point}get Polyline(){return this.Vertex.polyline}};var im=class extends Ci{constructor(e){super(e)}};var nm=class{constructor(e){this.lineSweeper=e}Compare(e,t){switch(m.getTriangleOrientation(t.Start,t.End,this.x)){case 2:return 0;case 0:return 1;default:return-1}}SetOperand(e){this.x=this.IntersectionOfSideAndSweepLine(e)}IntersectionOfSideAndSweepLine(e){let t=e.Direction.dot(this.lineSweeper.SweepDirection),i=(this.lineSweeper.Z-e.Start.dot(this.lineSweeper.SweepDirection))/t;return e.Start.add(e.Direction.mul(i))}};var om=class extends Zt{constructor(t){super();this.site=t}get Site(){return this.site}};var Ic=class{constructor(e,t){this.PreviousZ=Number.NEGATIVE_INFINITY;this.z=Number.NEGATIVE_INFINITY;this.Obstacles=e!=null?e:[],this.SweepDirection=t,this.DirectionPerp=t.rotate(-Math.PI/2),this.EventQueue=new fa((i,n)=>this.Compare(i,n)),this.ObstacleSideComparer=new nm(this),this.LeftObstacleSideTree=new dt((i,n)=>this.ObstacleSideComparer.Compare(i,n)),this.RightObstacleSideTree=new dt((i,n)=>this.ObstacleSideComparer.Compare(i,n))}get EventQueue(){return this.eventQueue}set EventQueue(e){this.eventQueue=e}get DirectionPerp(){return this.directionPerp}set DirectionPerp(e){this.directionPerp=e}get Z(){return this.z}set Z(e){e>this.z+R.tolerance&&(this.PreviousZ=this.z),this.z=e}GetZS(e){return this.SweepDirection.dot(e.Site)}GetZP(e){return this.SweepDirection.dot(e)}SegmentIsNotHorizontal(e,t){return Math.abs(e.sub(t).dot(this.SweepDirection))>R.distanceEpsilon}RemoveLeftSide(e){this.ObstacleSideComparer.SetOperand(e),this.LeftObstacleSideTree.remove(e)}RemoveRightSide(e){this.ObstacleSideComparer.SetOperand(e),this.RightObstacleSideTree.remove(e)}InsertLeftSide(e){this.ObstacleSideComparer.SetOperand(e),this.LeftObstacleSideTree.insert(e)}InsertRightSide(e){this.ObstacleSideComparer.SetOperand(e),this.RightObstacleSideTree.insert(e)}FindFirstObstacleSideToTheLeftOfPoint(e){let t=this.RightObstacleSideTree.findLast(i=>m.pointToTheRightOfLineOrOnLine(e,i.Start,i.End));return t==null?null:t.item}FindFirstObstacleSideToToTheRightOfPoint(e){let t=this.LeftObstacleSideTree.findFirst(i=>!m.pointToTheRightOfLineOrOnLine(e,i.Start,i.End));return t==null?null:t.item}EnqueueEvent(e){this.eventQueue.Enqueue(e)}InitQueueOfEvents(){for(let e of this.Obstacles)this.EnqueueLowestPointsOnObstacles(e);if(this.Ports!=null)for(let e of this.Ports.values())this.EnqueueEvent(new om(e))}EnqueueLowestPointsOnObstacles(e){let t=this.GetLowestPoint(e);this.EnqueueEvent(new im(t))}GetLowestPoint(e){let t=e.startPoint,i=e.startPoint.next;for(;i!=null;i=i.next)this.Less(i.point,t.point)&&(t=i);return t}Compare(e,t){let i=e.Site,n=t.Site;return this.ComparePoints(i,n)}Less(e,t){return this.ComparePoints(e,t)<0}ComparePoints(e,t){let i=this.SweepDirection.dot(e),n=this.SweepDirection.dot(t);return i<n?-1:i>n?1:(i=this.directionPerp.dot(e),n=this.directionPerp.dot(t),i<n?-1:i>n?1:0)}};var CC=Ae(sr(),1),Lc=class{constructor(e,t,i=1){this.LengthMultiplier=1;this.Source=e,this.Target=t,this.Weight=i}static closeuv(e,t){return m.closeDistEps(e.point,Lc.u,.1)&&m.closeDistEps(t.point,Lc.v,.1)}get SourcePoint(){return this.Source.point}get TargetPoint(){return this.Target.point}get Length(){return this.SourcePoint.sub(this.TargetPoint).length*this.LengthMultiplier}toString(){return CC.String.Format("{0}->{1} ({2})",this.Source,this.Target,this.Weight)}ReversedClone(){return new Lc(this.Target,this.Source)}Clone(){return new Lc(this.Source,this.Target)}},di=Lc;di.u=new m(545.833,840.458),di.v=new m(606.1667261889578,786.2917261889578),di.DefaultWeight=1;var ar=class extends di{static constructorVV(e,t){return new ar(e,t,0)}constructor(e,t,i=0){super(e,t,i)}};var Nt=class{deleteP(e){return this.delete(e.x,e.y)}clear(){this.m.clear()}get size(){return this.m.size}setxy(e,t,i){this.m.set(am(e,t),i)}set(e,t){this.setxy(e.x,e.y,t)}delete(e,t){return this.m.delete(am(e,t))}hasxy(e,t){return this.m.has(am(e,t))}has(e){return this.hasxy(e.x,e.y)}getxy(e,t){return this.m.get(am(e,t))}get(e){return this.getxy(e.x,e.y)}constructor(){this.m=new Map}*keys(){for(let e of this.m.keys()){let t=e.split(",");yield new m(Number(t[0]),Number(t[1]))}}*[Symbol.iterator](){for(let[e,t]of this.m){let i=e.split(",");yield[new m(Number(i[0]),Number(i[1])),t]}}*values(){yield*this.m.values()}};function am(s,e){return s.toString()+","+e.toString()}var Oo=class{constructor(e){this._inEdges=new Array;this._outEdges=new dt((t,i)=>this.Compare(t,i)),this.point=e}get InEdges(){return this._inEdges}get OutEdges(){return this._outEdges}get Degree(){return this._inEdges.length+this.OutEdges.count}InEdgesLength(){return this._inEdges.length}addInEdge(e){this._inEdges.push(e)}get IsTerminal(){return this._isTerminal}set IsTerminal(e){this._isTerminal=e}get IsShortestPathTerminal(){return this._isShortestPathTerminal}set IsShortestPathTerminal(e){this._isShortestPathTerminal=e}toString(){return this.point.toString()}RemoveOutEdge(e){this.OutEdges.remove(e)}RemoveInEdge(e){let t=this._inEdges.indexOf(e);if(t===-1)return;let i=this._inEdges.length-1;t!==i&&(this._inEdges[t]=this._inEdges[i]),this._inEdges.pop()}static FindFirst(e,t){return Oo.FindFirst_t(e.root,e,t)}static FindFirst_t(e,t,i){if(e===t.nil)return null;let n=null;for(;e!==t.nil;)e=e.item.TargetPoint.compareTo(i)>=0?(n=e).left:e.right;return n}get(e){let t=Oo.FindFirst(this.OutEdges,e.point);return t!=null&&t.item.Target===e||(t=Oo.FindFirst(e.OutEdges,this.point),t!=null&&t.item.Target===this)?t.item:null}Compare(e,t){return e.TargetPoint.compareTo(t.TargetPoint)}ClearEdges(){this._outEdges.clear(),this._inEdges=[]}};var Ke=class{constructor(){this.activeVertices=new Set;this.VertexFactory=e=>new Oo(e);this.pointToVertexMap=new Nt}*edges_(){for(let e of this.pointToVertexMap.values())for(let t of e.OutEdges)yield t}get Edges(){return this.edges_()}ClearPrevEdgesTable(){for(let e of this.activeVertices)e.prevEdge=null;this.activeVertices.clear()}ShrinkLengthOfPrevEdge(e,t){e.prevEdge.LengthMultiplier=t}PreviosVertex(e){let t=e.prevEdge;return t?t.Source===e?t.Target:t.Source:null}SetPreviousEdge(e,t){this.activeVertices.add(e),e.prevEdge=t}AddHole(e){let t=e.startPoint;for(;t!==e.endPoint;)this.AddEdgePlPl(t,t.next),t=t.next;this.AddEdgePlPl(e.endPoint,e.startPoint)}static*OrientHolesClockwise(e){for(let t of e)for(let i=t.startPoint;;i=i.next){let n=m.getTriangleOrientation(i.point,i.next.point,i.next.next.point);if(n!==2){yield n===0?t:t.reverse();break}}}AddVertexP(e){let t=this.pointToVertexMap.get(e);if(t)return t;let i=this.VertexFactory(e);return this.pointToVertexMap.set(e,i),i}AddVertexV(e){this.pointToVertexMap.set(e.point,e)}ContainsVertex(e){return this.pointToVertexMap.has(e)}static AddEdgeVV(e,t){let i;if(i=e.get(t))return i;if(e===t)throw new Error("Self-edges are not allowed");let n=new di(e,t);return e.OutEdges.insert(n),t.InEdges.push(n),n}AddEdgePlPl(e,t){this.AddEdgePP(e.point,t.point)}static AddEdge(e){e.Source.OutEdges.insert(e),e.Target.addInEdge(e)}AddEdgeF(e,t,i){let n=this.FindVertex(e),o=null;if(n!=null&&(o=this.FindVertex(t),o!=null)){let l=n.get(o);if(l)return l}n==null?(n=this.AddVertexP(e),o=this.AddVertexP(t)):o==null&&(o=this.AddVertexP(t));let a=i(n,o);return n.OutEdges.insert(a),o.addInEdge(a),a}AddEdgePP(e,t){return this.AddEdgeF(e,t,(i,n)=>new di(i,n))}FindVertex(e){return this.pointToVertexMap.get(e)}Vertices(){return this.pointToVertexMap.values()}RemoveVertex(e){for(let t of e.OutEdges)t.Target.RemoveInEdge(t);for(let t of e.InEdges)t.Source.RemoveOutEdge(t);this.pointToVertexMap.deleteP(e.point)}FindEdgePP(e,t){let i=this.FindVertex(e);if(i==null)return null;let n=this.FindVertex(t);return n==null?null:i.get(n)}static RemoveEdge(e){e.Source.RemoveOutEdge(e),e.Target.RemoveInEdge(e)}ClearEdges(){for(let e of this.Vertices())e.ClearEdges()}};var pa=class{constructor(){this.Removed=!1}};var _o=class extends pa{constructor(t,i,n){super();this.start=t,this.EndVertex=i,this.ConeSide=n}get Start(){return this.start}get End(){return this.EndVertex.point}get Direction(){return this.End.sub(this.Start)}toString(){return"BrokenConeSide: "+(this.Start+(","+this.End))}};var Rc=class{get Removed(){return this.removed}set Removed(e){this.removed=e}constructor(e,t){this.apex=e,this.coneSweeper=t}get Apex(){return this.apex}set Apex(e){this.apex=e}get RightSideDirection(){return this.coneSweeper.ConeRightSideDirection}get LeftSideDirection(){return this.coneSweeper.ConeLeftSideDirection}get RightSide(){return this.rightSide}set RightSide(e){this.rightSide=e,this.rightSide.Cone=this}get LeftSide(){return this.leftSide}set LeftSide(e){this.leftSide=e,this.leftSide.Cone=this}};var _d=class extends Zt{constructor(t,i){super();this.site=t,this.coneToClose=i}get ConeToClose(){return this.coneToClose}get Site(){return this.site}toString(){return"ConeClosureEvent "+this.site}};var Ai=class extends pa{constructor(e){super(),this.Cone=e}get Start(){return this.Cone.Apex}get Direction(){return this.Cone.LeftSideDirection}toString(){return"ConeLeftSide "+this.Start+(" "+this.Direction)}};var Hn=class extends pa{constructor(e){super(),this.Cone=e}get Start(){return this.Cone.Apex}get Direction(){return this.Cone.RightSideDirection}toString(){return"ConeRightSide "+this.Start+" "+this.Direction}};var jl=class{SetOperand(e){this.x=this.IntersectionOfSegmentAndSweepLine(e)}constructor(e){this.coneSweeper=e}Compare(e,t){let i=e instanceof _o,n=t instanceof _o;return i?n?this.CompareBrokenSides(e,t):this.CompareObstacleSideAndConeSide(t):n?this.CompareConeSideAndObstacleSide(e,t):jl.CompareNotIntersectingSegs(e,t)}static CompareNotIntersectingSegs(e,t){switch(m.getTriangleOrientation(e.Start,t.Start,t.Start.add(t.Direction))){case 1:return-1;case 0:return 1;default:return 0}}CompareObstacleSideAndConeSide(e){let t=m.getTriangleOrientation(this.x,e.Start,e.Start.add(e.Direction));return t===1?-1:t===0?1:e instanceof Ai?-1:1}CompareConeSideAndObstacleSide(e,t){let i=m.getTriangleOrientation(this.x,t.start,t.End);return i===1?-1:i===0||e instanceof Ai?1:-1}IntersectionOfSegmentAndSweepLine(e){let t=e.Direction.dot(this.coneSweeper.SweepDirection),i=(this.coneSweeper.Z-e.Start.dot(this.coneSweeper.SweepDirection))/t;return e.Start.add(e.Direction.mul(i))}CompareBrokenSides(e,t){return e.EndVertex===t.EndVertex?jl.CompareNotIntersectingSegs(e.ConeSide,t.ConeSide):m.getTriangleOrientation(this.x,t.start,t.EndVertex.point)===1?-1:1}};var ma=class extends Zt{constructor(t,i,n){super();this.coneLeftSide=t,this.intersectionPoint=i,this.endVertex=n}get EndVertex(){return this.endVertex}get Site(){return this.intersectionPoint}toString(){return"LeftIntersectionEvent "+this.intersectionPoint}};var ba=class{get Direction(){return this.End.sub(this.Start)}toString(){return this.Start+" "+this.End}};var Pa=class extends ba{constructor(t){super();this.Init(t)}Init(t){this.StartVertex=t}get Polyline(){return this.StartVertex.polyline}get Start(){return this.StartVertex.point}get End(){return this.EndVertex.point}};var No=class extends Pa{constructor(t){super(t);this.end=t.nextOnPolyline.point}get End(){return this.end}get EndVertex(){return this.StartVertex.nextOnPolyline}};var jn=class extends Ci{constructor(e){super(e)}};var Nd=class extends Zt{constructor(t,i,n){super();this.coneRightSide=t,this.intersectionPoint=i,this.endVertex=n}get EndVertex(){return this.endVertex}set EndVertex(t){this.endVertex=t}get Site(){return this.intersectionPoint}toString(){return"RightIntersectionEvent "+this.intersectionPoint}};var Mo=class extends Pa{constructor(t){super(t);this.end=t.prevOnPolyline.point}get End(){return this.end}get EndVertex(){return this.StartVertex.prevOnPolyline}};var qn=class extends Ci{constructor(e){super(e)}};var Qt=class extends Ic{constructor(t,i,n,o,a,l,u){super(t,i);this.visibilityGraph=a,this.ConeRightSideDirection=n,this.ConeLeftSideDirection=o,this.coneSideComparer=new jl(this),this.leftConeSides=new dt((c,h)=>this.coneSideComparer.Compare(c,h)),this.rightConeSides=new dt((c,h)=>this.coneSideComparer.Compare(c,h)),this.Ports=l,this.BorderPolyline=u,this.PortEdgesCreator=(c,h)=>new ar(c,h,0)}static Sweep(t,i,n,o,a,l){new Qt(t,i,i.rotate(-n/2),i.rotate(n/2),o,a,l).Calculate()}Calculate(){for(this.InitQueueOfEvents();this.EventQueue.Count>0;)this.ProcessEvent(this.EventQueue.Dequeue());this.BorderPolyline!=null&&this.CloseRemainingCones(),this.CreatePortEdges()}CreatePortEdges(){if(this.portEdgesGraph!=null)for(let t of this.portEdgesGraph.Edges)this.visibilityGraph.AddEdgeF(t.SourcePoint,t.TargetPoint,this.PortEdgesCreator)}CloseRemainingCones(){if(this.leftConeSides.count===0)return;let t=this.BorderPolyline.startPoint,i=this.leftConeSides.count;do{let n=this.leftConeSides.treeMinimum().item.Cone;t=this.FindPolylineSideIntersectingConeRightSide(t,n),t=this.GetPolylinePointInsideOfConeAndRemoveCones(t,n),i--}while(this.leftConeSides.count>0&&i>0)}GetPolylinePointInsideOfConeAndRemoveCones(t,i){let n=t.nextOnPolyline,o=Qt.FindInsidePoint(t.point,n.point,i);return m.closeDistEps(o,t.point)?(this.AddEdgeAndRemoveCone(i,t.point),this.AddEdgesAndRemoveRemainingConesByPoint(t.point)):m.closeDistEps(o,n.point)?(this.AddEdgeAndRemoveCone(i,n.point),this.AddEdgesAndRemoveRemainingConesByPoint(n.point),t=n):(t=Qt.InsertPointIntoPolylineAfter(this.BorderPolyline,t,o),this.AddEdgeAndRemoveCone(i,t.point),this.AddEdgesAndRemoveRemainingConesByPoint(t.point)),t}static FindInsidePoint(t,i,n){return Qt.FindInsidePointBool(t,i,n.Apex,n.Apex.add(n.LeftSideDirection),n.Apex.add(n.RightSideDirection))}static FindInsidePointBool(t,i,n,o,a){if(m.closeDistEps(t,i)||m.PointIsInsideCone(t,n,o,a))return t;if(m.PointIsInsideCone(i,n,o,a))return i;let l=m.middle(t,i);return m.pointToTheLeftOfLine(l,n,o)?Qt.FindInsidePointBool(l,i,n,o,a):Qt.FindInsidePointBool(t,l,n,o,a)}AddEdgesAndRemoveRemainingConesByPoint(t){let i=new Array;for(let n of this.leftConeSides)if(m.PointToTheRightOfLineOrOnLine(t,n.Start,n.Start.add(n.Direction)))i.push(n.Cone);else break;for(let n of i)this.AddEdgeAndRemoveCone(n,t)}FindPolylineSideIntersectingConeRightSide(t,i){let n=t,o=i.Apex,a=i.Apex.add(this.ConeRightSideDirection),l=Qt.GetSign(t,o,a);for(;;){let u=t.nextOnPolyline,c=Qt.GetSign(u,o,a);if(c-l>0)return t;if(t=u,l=c,t===n)throw new Error("cannod decide if the polyline intersects the cone!")}}static GetSign(t,i,n){let o=m.signedDoubledTriangleArea(i,n,t.point);return o<0?1:o>0?-1:0}AddEdgeAndRemoveCone(t,i){this.Ports!=null&&this.Ports.has(t.Apex)?this.CreatePortEdge(t,i):this.visibilityGraph.AddEdgePP(t.Apex,i),this.RemoveCone(t)}CreatePortEdge(t,i){this.portEdgesGraph==null&&(this.portEdgesGraph=new Ke);let n=this.portEdgesGraph.FindVertex(t.Apex),o=n!=null?Array.from(n.InEdges).concat(Array.from(n.OutEdges.allNodes())):null;if(o)for(let a of o){let l=(a.Target===n?a.Source:a.Target).point;Ke.RemoveEdge(a),this.portEdgesGraph.AddEdgePP(l,i)}this.portEdgesGraph.AddEdgePP(t.Apex,i)}static InsertPointIntoPolylineAfter(t,i,n){let o;return i.next!=null?(o=Kt.mkFromPoint(n),o.prev=i,o.next=i.next,i.next.prev=o,i.next=o):(o=Kt.mkFromPoint(n),o.prev=i,i.next=o,t.endPoint=o),o.polyline=t,t.setInitIsRequired(),o}ProcessEvent(t){t instanceof Ci?this.ProcessVertexEvent(t):t instanceof Nd?this.ProcessRightIntersectionEvent(t):t instanceof ma?this.ProcessLeftIntersectionEvent(t):(t instanceof _d?t.ConeToClose.Removed||this.RemoveCone(t.ConeToClose):this.ProcessPortObstacleEvent(t),this.Z=this.GetZS(t))}ProcessPortObstacleEvent(t){this.Z=this.GetZS(t),this.GoOverConesSeeingVertexEvent(t),this.CreateConeOnVertex(t)}ProcessLeftIntersectionEvent(t){if(t.coneLeftSide.Removed===!1)if(Math.abs(t.EndVertex.point.sub(t.Site).dot(this.SweepDirection))<R.distanceEpsilon)this.RemoveCone(t.coneLeftSide.Cone);else{this.RemoveSegFromLeftTree(t.coneLeftSide),this.Z=this.GetZP(t.Site);let i=new _o(t.Site,t.EndVertex,t.coneLeftSide);this.InsertToTree(this.leftConeSides,i),t.coneLeftSide.Cone.LeftSide=i,this.LookForIntersectionOfObstacleSideAndLeftConeSide(t.Site,t.EndVertex),this.TryCreateConeClosureForLeftSide(i)}else this.Z=this.GetZP(t.Site)}TryCreateConeClosureForLeftSide(t){if(t.Cone.RightSide instanceof Hn){let i=t.Cone.RightSide;m.getTriangleOrientation(i.Start,i.Start.add(i.Direction),t.EndVertex.point)==0&&this.CreateConeClosureEvent(t,i)}}CreateConeClosureEvent(t,i){let n=m.RayIntersectsRayInteriors(t.start,t.Direction,i.Start,i.Direction);if(n){let o=new _d(n,t.Cone);this.EnqueueEvent(o)}}ProcessRightIntersectionEvent(t){if(t.coneRightSide.Removed)this.Z=this.GetZP(t.Site);else{this.RemoveSegFromRightTree(t.coneRightSide),this.Z=this.GetZP(t.Site);let i=new _o(t.Site,t.EndVertex,t.coneRightSide);this.InsertToTree(this.rightConeSides,i),t.coneRightSide.Cone.RightSide=i,this.LookForIntersectionOfObstacleSideAndRightConeSide(t.Site,t.EndVertex),this.TryCreateConeClosureForRightSide(i)}}TryCreateConeClosureForRightSide(t){if(t.Cone.LeftSide instanceof Ai){let i=t.Cone.LeftSide;m.getTriangleOrientation(i.Start,i.Start.add(i.Direction),t.EndVertex.point)==1&&this.CreateConeClosureEvent(t,i)}}RemoveConesClosedBySegment(t,i){this.CloseConesCoveredBySegment(t,i,this.GetZP(t)>this.GetZP(i)?this.leftConeSides:this.rightConeSides)}CloseConesCoveredBySegment(t,i,n){let o=n.findFirst(u=>m.getTriangleOrientation(u.Start,u.Start.add(u.Direction),t)===1);if(o==null||!m.IntervalIntersectsRay(t,i,o.item.Start,o.item.Direction))return;let l=new Array;do l.push(o.item.Cone),o=n.next(o);while(o!=null&&m.IntervalIntersectsRay(t,i,o.item.Start,o.item.Direction)!==void 0);for(let u of l)this.RemoveCone(u)}ProcessVertexEvent(t){this.Z=this.GetZS(t),this.GoOverConesSeeingVertexEvent(t),this.AddConeAndEnqueueEvents(t)}static Diamond(t){return Fe.mkDiamond(2,2,t)}AddConeAndEnqueueEvents(t){if(t instanceof jn){let i=t.Vertex.nextOnPolyline;this.CloseConesAddConeAtLeftVertex(t,i)}else if(t instanceof qn){let i=t.Vertex.prevOnPolyline;this.CloseConesAddConeAtRightVertex(t,i)}else this.CloseConesAddConeAtLeftVertex(t,t.Vertex.nextOnPolyline),this.CloseConesAddConeAtRightVertex(t,t.Vertex.prevOnPolyline)}CloseConesAddConeAtRightVertex(t,i){let n=t.Vertex.nextOnPolyline.point;this.directionPerp.dot(t.Site.sub(n))>R.distanceEpsilon&&this.RemoveConesClosedBySegment(n,t.Vertex.point),this.directionPerp.dot(i.point.sub(t.Site))>R.distanceEpsilon&&this.RemoveConesClosedBySegment(t.Site,i.point);let o=t.Site,a=o.add(this.ConeLeftSideDirection),l=o.add(this.ConeRightSideDirection),u=i.point;this.GetZP(o.sub(n))>R.distanceEpsilon&&this.RemoveRightSide(new Mo(t.Vertex.nextOnPolyline)),this.GetZP(o.sub(i.point))>R.distanceEpsilon&&this.RemoveLeftSide(new No(i)),this.GetZP(u)+R.distanceEpsilon<this.GetZS(t)&&this.CreateConeOnVertex(t),m.PointToTheRightOfLineOrOnLine(u,o,a)?m.PointToTheLeftOfLineOrOnLine(u,o,l)?this.CaseToTheLeftOfLineOrOnLineConeRp(t,i):(this.GetZP(u.sub(o))>R.distanceEpsilon&&(this.LookForIntersectionOfObstacleSideAndLeftConeSide(t.Site,i),this.InsertRightSide(new Mo(t.Vertex))),this.EnqueueRightVertexEvent(new qn(i))):(this.CreateConeOnVertex(t),m.PointToTheLeftOfLineOrOnLine(u.add(this.DirectionPerp),u,o)&&this.EnqueueRightVertexEvent(new qn(i)))}CaseToTheLeftOfLineOrOnLineConeRp(t,i){this.EnqueueRightVertexEvent(new qn(i));let n=new Rc(t.Vertex.point,this),o=new _o(n.Apex,i,new Ai(n));n.LeftSide=o,n.RightSide=new Hn(n);let a=this.InsertToTree(this.rightConeSides,n.RightSide);this.LookForIntersectionWithConeRightSide(a);let l=this.InsertToTree(this.leftConeSides,n.LeftSide);this.FixConeLeftSideIntersections(o,l),this.GetZP(i.point.sub(t.Site))>R.distanceEpsilon&&this.InsertRightSide(new Mo(t.Vertex))}LookForIntersectionOfObstacleSideAndRightConeSide(t,i){let n=this.GetLastNodeToTheLeftOfPointInRightSegmentTree(t);if(n!=null&&n.item instanceof Hn){let o=m.IntervalIntersectsRay(t,i.point,n.item.Start,this.ConeRightSideDirection);o&&this.SegmentIsNotHorizontal(o,i.point)&&this.EnqueueEvent(this.CreateRightIntersectionEvent(n.item,o,i))}}CreateRightIntersectionEvent(t,i,n){return new Nd(t,i,n)}GetLastNodeToTheLeftOfPointInRightSegmentTree(t){return this.rightConeSides.findLast(i=>Qt.PointIsToTheRightOfSegment(t,i))}LookForIntersectionOfObstacleSideAndLeftConeSide(t,i){let n=this.GetFirstNodeToTheRightOfPoint(t);if(n==null||!(n.item instanceof Ai))return;let o=n.item,a=m.IntervalIntersectsRay(t,i.point,o.Start,this.ConeLeftSideDirection);a&&this.EnqueueEvent(new ma(o,a,i))}GetFirstNodeToTheRightOfPoint(t){return this.leftConeSides.findFirst(i=>Qt.PointIsToTheLeftOfSegment(t,i))}static PointIsToTheLeftOfSegment(t,i){return m.getTriangleOrientation(i.Start,i.Start.add(i.Direction),t)===1}static PointIsToTheRightOfSegment(t,i){return m.getTriangleOrientation(i.Start,i.Start.add(i.Direction),t)===0}FixConeLeftSideIntersections(t,i){do i=this.leftConeSides.next(i);while(i!=null&&m.PointToTheRightOfLineOrOnLine(t.Start,i.item.Start,i.item.Start.add(i.item.Direction)));if(i!=null&&i.item instanceof Ai){let n=i.item,o=m.IntervalIntersectsRay(t.start,t.End,n.Start,n.Direction);o&&this.EnqueueEvent(new ma(n,o,t.EndVertex))}}InsertToTree(t,i){return this.coneSideComparer.SetOperand(i),t.insert(i)}CloseConesAddConeAtLeftVertex(t,i){let n=t.Vertex.prevOnPolyline.point;t.Site.sub(n).dot(this.directionPerp)<-R.distanceEpsilon&&this.RemoveConesClosedBySegment(t.Site,n),i.point.sub(t.Site).dot(this.directionPerp)<-R.distanceEpsilon&&this.RemoveConesClosedBySegment(i.point,t.Site);let o=t.Site,a=o.add(this.ConeLeftSideDirection),l=o.add(this.ConeRightSideDirection),u=i.point;this.GetZP(o.sub(n))>R.distanceEpsilon&&this.RemoveLeftSide(new No(t.Vertex.prevOnPolyline));let c=this.GetZP(u)-this.Z;c<-R.distanceEpsilon&&this.RemoveRightSide(new Mo(i));let h=u.sub(t.Site);if(c<-R.distanceEpsilon||ue(c,0)&&this.GetZP(h)>0&&h.dot(this.directionPerp)>-R.distanceEpsilon)this.CreateConeOnVertex(t);else if(!m.PointToTheLeftOfLineOrOnLine(u,o,l))this.CreateConeOnVertex(t),this.EnqueueEvent(new jn(i));else if(m.PointToTheLeftOfLineOrOnLine(u,o,a))this.EnqueueEvent(new jn(i)),this.GetZP(h)>R.distanceEpsilon&&(this.LookForIntersectionOfObstacleSideAndRightConeSide(t.Site,i),this.InsertLeftSide(new No(t.Vertex)));else{this.EnqueueEvent(new jn(i));let d=new Rc(t.Vertex.point,this),f=new _o(t.Vertex.point,i,new Hn(d));d.RightSide=f,d.LeftSide=new Ai(d),this.LookForIntersectionWithConeLeftSide(this.InsertToTree(this.leftConeSides,d.LeftSide));let p=this.InsertToTree(this.rightConeSides,f);this.FixConeRightSideIntersections(f,p),this.GetZP(h)>R.distanceEpsilon&&this.InsertLeftSide(new No(t.Vertex))}}RemoveCone(t){t.Removed=!0,this.RemoveSegFromLeftTree(t.LeftSide),this.RemoveSegFromRightTree(t.RightSide)}RemoveSegFromRightTree(t){this.coneSideComparer.SetOperand(t);let i=this.rightConeSides.remove(t);if(t.Removed=!0,i==null){let n=this.Z;this.Z=Math.max(this.GetZP(t.Start),this.Z-.01),this.coneSideComparer.SetOperand(t),i=this.rightConeSides.remove(t),this.Z=n}}RemoveSegFromLeftTree(t){if(t.Removed=!0,this.coneSideComparer.SetOperand(t),this.leftConeSides.remove(t)==null){let n=this.Z;this.Z=Math.max(this.GetZP(t.Start),this.Z-.01),this.coneSideComparer.SetOperand(t),this.leftConeSides.remove(t),this.Z=n}}FixConeRightSideIntersections(t,i){do i=this.rightConeSides.previous(i);while(i!=null&&m.PointToTheLeftOfLineOrOnLine(t.start,i.item.Start,i.item.Start.add(i.item.Direction)));if(i!=null){let n;if(i.item instanceof Hn){let o=i.item;(n=m.IntervalIntersectsRay(t.start,t.End,o.Start,o.Direction))&&this.EnqueueEvent(this.CreateRightIntersectionEvent(o,n,t.EndVertex))}}}CreateConeOnVertex(t){let i=new Rc(t.Site,this);i.LeftSide=new Ai(i),i.RightSide=new Hn(i);let n=this.InsertToTree(this.leftConeSides,i.LeftSide),o=this.InsertToTree(this.rightConeSides,i.RightSide);this.LookForIntersectionWithConeRightSide(o),this.LookForIntersectionWithConeLeftSide(n)}LookForIntersectionWithConeLeftSide(t){if(t.item instanceof Ai){let i=t.item,n=this.FindFirstObstacleSideToTheLeftOfPoint(i.Start);n!=null&&this.TryIntersectionOfConeLeftSideAndObstacleSide(i,n)}else{let i=t.item;t=this.leftConeSides.next(t),t!=null&&t.item instanceof Ai&&this.TryIntersectionOfConeLeftSideAndObstacleConeSide(t.item,i)}}LookForIntersectionWithConeRightSide(t){if(t.item instanceof Hn){let i=t.item,n=this.FindFirstObstacleSideToToTheRightOfPoint(i.Start);n!=null&&this.TryIntersectionOfConeRightSideAndObstacleSide(i,n)}else{let i=t.item;t=this.rightConeSides.previous(t),t!=null&&t.item instanceof Hn&&this.TryIntersectionOfConeRightSideAndObstacleConeSide(t.item,i)}}TryIntersectionOfConeRightSideAndObstacleConeSide(t,i){let n=m.IntervalIntersectsRay(i.start,i.End,t.Start,t.Direction);n&&this.EnqueueEvent(this.CreateRightIntersectionEvent(t,n,i.EndVertex))}TryIntersectionOfConeRightSideAndObstacleSide(t,i){let n=m.IntervalIntersectsRay(i.Start,i.End,t.Start,t.Direction);n&&this.EnqueueEvent(this.CreateRightIntersectionEvent(t,n,i.EndVertex))}TryIntersectionOfConeLeftSideAndObstacleConeSide(t,i){let n=m.IntervalIntersectsRay(i.start,i.End,t.Start,t.Direction);n&&this.EnqueueEvent(new ma(t,n,i.EndVertex))}TryIntersectionOfConeLeftSideAndObstacleSide(t,i){let n=m.IntervalIntersectsRay(i.Start,i.End,t.Start,t.Direction);n&&this.EnqueueEvent(new ma(t,n,i.EndVertex))}ExtendSegmentToZ(t){let i=t.Direction.dot(this.SweepDirection),n=(this.Z+40-t.Start.dot(this.SweepDirection))/i;return k.mkPP(t.Start,t.Start.add(t.Direction.mul(n)))}GoOverConesSeeingVertexEvent(t){let i=this.FindFirstSegmentInTheRightTreeNotToTheLeftOfVertex(t);if(i==null)return;let o=i.item.Cone,a=o.LeftSide;if(Qt.VertexIsToTheLeftOfSegment(t,a))return;let l=[o];if(this.coneSideComparer.SetOperand(a),i=this.leftConeSides.find(a),i==null){let u=this.Z;this.Z=Math.max(this.GetZP(a.Start),this.PreviousZ),this.coneSideComparer.SetOperand(a),i=this.leftConeSides.find(a),this.Z=u}if(!(i==null&&(i=this.GetRbNodeEmergency(a),i==null))){for(i=this.leftConeSides.next(i);i!=null&&!Qt.VertexIsToTheLeftOfSegment(t,i.item);)l.push(i.item.Cone),i=this.leftConeSides.next(i);for(let u of l)this.AddEdgeAndRemoveCone(u,t.Site)}}GetRbNodeEmergency(t){if(this.leftConeSides.count===0)return null;for(let i=this.leftConeSides.treeMinimum();i!=null;i=this.leftConeSides.next(i))if(i.item===t)return i;return null}static VertexIsToTheLeftOfSegment(t,i){return m.getTriangleOrientation(i.Start,i.Start.add(i.Direction),t.Site)===1}static VertexIsToTheRightOfSegment(t,i){return m.getTriangleOrientation(i.Start,i.Start.add(i.Direction),t.Site)===0}FindFirstSegmentInTheRightTreeNotToTheLeftOfVertex(t){return this.rightConeSides.findFirst(i=>!Qt.VertexIsToTheRightOfSegment(t,i))}EnqueueRightVertexEvent(t){this.GetZP(t.Site.sub(t.Vertex.prevOnPolyline.point))>R.tolerance||this.EnqueueEvent(t)}invariant(){for(let t of this.leftConeSides)if(t.Removed)return!1;for(let t of this.rightConeSides)if(t.Removed)return!1;return!0}};var Bo=class extends Pe{constructor(t,i){super(null);this.coneAngle=Math.PI/6;this.ports=new He;this._obstacles=Array.from(Ke.OrientHolesClockwise(t)),this._visibilityGraph=i}static mk(t,i,n,o,a){let l=new Bo(t,i);return l.Ports=o,l.BorderPolyline=a,l.ConeAngle=n,l}get ConeAngle(){return this.coneAngle}set ConeAngle(t){this.coneAngle=t}get Ports(){return this.ports}set Ports(t){this.ports=t}get BorderPolyline(){return this.borderPolyline}set BorderPolyline(t){this.borderPolyline=t}get Bidirectional(){return this._bidirectional}set Bidirectional(t){this._bidirectional=t}static GetTotalSteps(t){return Math.floor((2*Math.PI-t/2)/t)+1}run(){let t=2*Math.PI-this.coneAngle/2;if(this.Bidirectional)this.HandleBideractionalCase();else{let i;for(let n=0;(i=this.coneAngle*n)<=t;n++)super.ProgressStep(),this.AddDirection(new m(Math.cos(i),Math.sin(i)),this.BorderPolyline,this._visibilityGraph)}}HandleBideractionalCase(){let t=Math.PI/this.coneAngle;for(let i=0;i<t;i++){let n=i*this.coneAngle,o=new Ke;this.AddDirection(new m(Math.cos(n),Math.sin(n)),this.BorderPolyline,o);let a=new Ke;this.AddDirection(new m(Math.cos(n)*-1,Math.sin(n)*-1),this.BorderPolyline,a),this.AddIntersectionOfBothDirectionSweepsToTheResult(o,a)}}AddIntersectionOfBothDirectionSweepsToTheResult(t,i){for(let n of t.Edges)i.FindEdgePP(n.SourcePoint,n.TargetPoint)!=null&&this._visibilityGraph.AddEdgePP(n.SourcePoint,n.TargetPoint)}AddDirection(t,i,n){Qt.Sweep(this._obstacles,t,this.coneAngle,n,this.Ports,i)}};var Mt=class extends Ss{constructor(t){super();this.adjustmentAngle=Math.PI/10;this.hookSize=9;this.curve=t,this.location=this.curve().start}mk(t,i){let n=new Mt(t);return n.HookSize=i,n}get Location(){return this.location}get Curve(){return this.curve()}SetLocation(t){this.location=t}get AdjustmentAngle(){return this.adjustmentAngle}set AdjustmentAngle(t){this.adjustmentAngle=t}get HookSize(){return this.hookSize}set HookSize(t){this.hookSize=t}};var br=class extends Or{constructor(t,i,n=new m(0,0)){super(t,i,n)}get LoosePolyline(){return this.loosePolyline}set LoosePolyline(t){this.loosePolyline=t}static mk(t,i){return new br(t,i)}};var Pr=class extends Ss{get Location(){return this.curve.value(this.parameter)}set Location(t){throw new Error("Method should not be called.")}static mk(t,i){let n=new Pr;return n.curve=t,n.parameter=i,n}get Parameter(){return this.parameter}set Parameter(t){this.parameter=t}get Curve(){return this.curve}set Curve(t){this.curve=t}};var Xn=class{constructor(){this.capacityOverflowCoefficient=Xn.DefaultCapacityOverflowCoefficientMultiplier;this.RotateBundles=!1;this.MaxHubRadius=50;this.MinHubRadius=.1;this.CreateUnderlyingPolyline=!1;this.pathLengthImportance=Xn.DefaultPathLengthImportance;this.inkImportance=Xn.DefaultInkImportance;this.edgeSeparation=Xn.DefaultEdgeSeparation;this._edgeWidthShrinkCoeff=1;this.useCubicBezierSegmentsInsideOfHubs=!1;this.angleThreshold=Math.PI/180*45;this.hubRepulsionImportance=100;this.bundleRepulsionImportance=100;this.minimalRatioOfGoodCdtEdges=.9;this.highestQuality=!0;this.KeepOverlaps=!1;this.StopAfterShortestPaths=!1}toJSON(){let e={};return this.capacityOverflowCoefficient!=Xn.DefaultCapacityOverflowCoefficientMultiplier&&(e.capacityOverflowCoefficient=this.capacityOverflowCoefficient),this.RotateBundles&&(e.RotateBundles=this.RotateBundles),this.MaxHubRadius!=50&&(e.MaxHubRadius=this.MaxHubRadius),this.MinHubRadius!=.1&&(e.MinHubRadius=this.MinHubRadius),this.CreateUnderlyingPolyline&&(e.CreateUnderlyingPolyline=this.CreateUnderlyingPolyline),this.pathLengthImportance!=Xn.DefaultPathLengthImportance&&(e.pathLengthImportance=this.pathLengthImportance),this.inkImportance!=Xn.DefaultInkImportance&&(e.inkImportance=this.inkImportance),this.edgeSeparation!=Xn.DefaultEdgeSeparation&&(e.edgeSeparation=this.edgeSeparation),this._edgeWidthShrinkCoeff!=1&&(e._edgeWidthShrinkCoeff=this._edgeWidthShrinkCoeff),this.useCubicBezierSegmentsInsideOfHubs&&(e.useCubicBezierSegmentsInsideOfHubs=this.useCubicBezierSegmentsInsideOfHubs),this.angleThreshold!=Math.PI/180*45&&(e.angleThreshold=this.angleThreshold),this.hubRepulsionImportance!=100&&(e.hubRepulsionImportance=this.hubRepulsionImportance),this.bundleRepulsionImportance!=100&&(e.bundleRepulsionImportance=this.bundleRepulsionImportance),this.minimalRatioOfGoodCdtEdges!=.9&&(e.minimalRatioOfGoodCdtEdges=this.minimalRatioOfGoodCdtEdges),this.highestQuality||(e.highestQuality=this.highestQuality),this.KeepOverlaps&&(e.KeepOverlaps=this.KeepOverlaps),this.StopAfterShortestPaths&&(e.StopAfterShortestPaths=this.StopAfterShortestPaths),e}static createFromJSON(e){let t=new Xn;return e.capacityOverflowCoefficient&&(t.capacityOverflowCoefficient=e.capacityOverflowCoefficient),e.RotateBundles&&(t.RotateBundles=e.RotateBundles),e.MaxHubRadius&&(t.MaxHubRadius=e.MaxHubRadius),e.MinHubRadius&&(t.MinHubRadius=e.MinHubRadius),e.CreateUnderlyingPolyline&&(t.CreateUnderlyingPolyline=e.CreateUnderlyingPolyline),e.pathLengthImportance&&(t.pathLengthImportance=e.pathLengthImportance),e.inkImportance&&(t.inkImportance=e.inkImportance),e.edgeSeparation&&(t.edgeSeparation=e.edgeSeparation),e._edgeWidthShrinkCoeff&&(t._edgeWidthShrinkCoeff=e._edgeWidthShrinkCoeff),e.useCubicBezierSegmentsInsideOfHubs&&(t.useCubicBezierSegmentsInsideOfHubs=e.useCubicBezierSegmentsInsideOfHubs),e.angleThreshold&&(t.angleThreshold=e.angleThreshold),e.hubRepulsionImportance&&(t.hubRepulsionImportance=e.hubRepulsionImportance),e.bundleRepulsionImportance&&(t.bundleRepulsionImportance=e.bundleRepulsionImportance),e.minimalRatioOfGoodCdtEdges&&(t.minimalRatioOfGoodCdtEdges=e.minimalRatioOfGoodCdtEdges),e.highestQuality&&(t.HighestQuality=e.highestQuality),e.KeepOverlaps&&(t.KeepOverlaps=e.KeepOverlaps),e.StopAfterShortestPaths&&(t.StopAfterShortestPaths=e.StopAfterShortestPaths),t}get CapacityOverflowCoefficient(){return this.capacityOverflowCoefficient}set CapacityOverflowCoefficient(e){this.capacityOverflowCoefficient=e}get PathLengthImportance(){return this.pathLengthImportance}set PathLengthImportance(e){this.pathLengthImportance=e}get InkImportance(){return this.inkImportance}set InkImportance(e){this.inkImportance=e}get EdgeSeparation(){return this.edgeSeparation}set EdgeSeparation(e){this.edgeSeparation=e}get edgeWidthShrinkCoeff(){return this._edgeWidthShrinkCoeff}set edgeWidthShrinkCoeff(e){this._edgeWidthShrinkCoeff=e}ActualEdgeWidth(e,t=this.edgeWidthShrinkCoeff){return t*(this.edgeSeparation+e.lineWidth)}get UseCubicBezierSegmentsInsideOfHubs(){return this.useCubicBezierSegmentsInsideOfHubs}set UseCubicBezierSegmentsInsideOfHubs(e){this.useCubicBezierSegmentsInsideOfHubs=e}get AngleThreshold(){return this.angleThreshold}set AngleThreshold(e){this.angleThreshold=e}get HubRepulsionImportance(){return this.hubRepulsionImportance}set HubRepulsionImportance(e){this.hubRepulsionImportance=e}get BundleRepulsionImportance(){return this.bundleRepulsionImportance}set BundleRepulsionImportance(e){this.bundleRepulsionImportance=e}get MinimalRatioOfGoodCdtEdges(){return this.minimalRatioOfGoodCdtEdges}set MinimalRatioOfGoodCdtEdges(e){this.minimalRatioOfGoodCdtEdges=e}get HighestQuality(){return this.highestQuality}set HighestQuality(e){this.highestQuality=e}},Sn=Xn;Sn.DefaultCapacityOverflowCoefficientMultiplier=1e3,Sn.DefaultPathLengthImportance=500,Sn.DefaultInkImportance=.01,Sn.DefaultEdgeSeparation=.5;var Do=class extends Wn{constructor(t){super(null);this.node=t}get BoundaryCurve(){return this.node.boundaryCurve}set BoundaryCurve(t){if(t)throw new Error("Cannot set BoundaryCurve directly for RelativeShape")}};var Ti=class{static GetShapes(e,t){let i=new Map;for(let n of e)Ti.ProcessAncestorDescendantCouple(n.target,n.source,i),Ti.InsertEdgePortsToShapes(i,n);for(let n of t)Ti.ProcessAncestorDescendantCouple(n.source,n.target,i),Ti.InsertEdgePortsToShapes(i,n);return Ti.BindShapes(i),Array.from(i.values())}static InsertEdgePortsToShapes(e,t){e.get(t.target).Ports.add(t.targetPort),e.get(t.source).Ports.add(t.sourcePort)}static BindShapes(e){for(let[t,i]of e){if(!(t instanceof be))continue;let n=t;for(let o of D0(n)){let a=e.get(o);a&&i.AddChild(a)}}}static ProcessAncestorDescendantCouple(e,t,i){let n=lm(t);do{for(let o of D0(n))Ti.CreateShapeIfNeeeded(o,i);if(n===e)break;n=lm(n)}while(!0);Ti.CreateShapeIfNeeeded(n,i)}static CreateShapeIfNeeeded(e,t){t.has(e)||t.set(e,new Do(e))}static NumberOfActiveNodesIsUnderThreshold(e,t,i){let n=new Set;for(let o of e)if(Ti.SetOfActiveNodesIsLargerThanThreshold(o.target,o.source,n,i))return!1;for(let o of t)if(Ti.SetOfActiveNodesIsLargerThanThreshold(o.source,o.target,n,i))return!1;return!0}static SetOfActiveNodesIsLargerThanThreshold(e,t,i,n){let o=lm(t);for(;;){for(let a of D0(o))if(i.add(a),i.size>n)return!0;if(o===e)break;o=lm(o)}return i.add(o),i.size>n}};function lm(s){let e=s.node.parent;return xe.getGeom(e)}function*D0(s){for(let e of s.graph.shallowNodes)yield xe.getGeom(e)}var qr=class{constructor(e){this.stamp=0;this.SetPivotAndAllocateHullPointsArray(e)}SetPivotAndAllocateHullPointsArray(e){this.pivot=new m(0,Number.MAX_SAFE_INTEGER);let t=-1,i=0;for(let n of e)n.y<this.pivot.y?(this.pivot=n,t=i):n.y===this.pivot.y&&n.x>this.pivot.x&&(this.pivot=n,t=i),i++;if(i>=1){this.hullPoints=new Array(i-1),i=0;for(let n of e)i!==t?this.hullPoints[i++]={point:n,deleted:!1,stamp:this.stamp++}:t=-1}}get StackTopPoint(){return this.stack.point}get StackSecondPoint(){return this.stack.next.point}static*CalculateConvexHull(e){let t=new qr(e);for(let i of t.Calculate())yield i}*Calculate(){if(this.pivot.y!==Number.MAX_SAFE_INTEGER){if(this.hullPoints.length===0){yield this.pivot;return}this.SortAllPointsWithoutPivot(),this.Scan();for(let e of this.EnumerateStack())yield e}}*EnumerateStack(){let e=this.stack;for(;e!=null;)yield e.point,e=e.next}Scan(){let e=0;for(;this.hullPoints[e].deleted;)e++;for(this.stack={point:this.pivot,next:null},this.Push(e++),e<this.hullPoints.length&&(this.hullPoints[e].deleted?e++:this.Push(e++));e<this.hullPoints.length;)this.hullPoints[e].deleted?e++:this.LeftTurn(e)?this.Push(e++):this.Pop();for(;this.StackHasMoreThanTwoPoints()&&!this.LeftTurnToPivot();)this.Pop()}LeftTurnToPivot(){return m.getTriangleOrientation(this.StackSecondPoint,this.StackTopPoint,this.pivot)===1}StackHasMoreThanTwoPoints(){return this.stack.next!=null&&this.stack.next.next!=null}Pop(){this.stack=this.stack.next}LeftTurn(e){if(this.stack.next==null)return!0;let t=m.getTriangleOrientationWithIntersectionEpsilon(this.StackSecondPoint,this.StackTopPoint,this.hullPoints[e].point);return t===1?!0:t===0?!1:this.BackSwitchOverPivot(this.hullPoints[e].point)}BackSwitchOverPivot(e){return this.stack.next.next!=null?!1:this.StackTopPoint.x>this.pivot.x+R.distanceEpsilon&&e.x<this.pivot.x-R.distanceEpsilon}Push(e){this.stack={point:this.hullPoints[e].point,next:this.stack}}SortAllPointsWithoutPivot(){this.hullPoints.sort(U_(this.pivot))}static createConvexHullAsClosedPolyline(e){return ne.mkClosedFromPoints(Array.from(qr.CalculateConvexHull(e)))}};function U_(s){return(e,t)=>{if(e===t)return 0;if(e==null)return-1;if(t==null)return 1;switch(m.getTriangleOrientationWithIntersectionEpsilon(s,e.point,t.point)){case 1:return-1;case 0:return 1;case 2:let i=e.point.x-s.x,n=t.point.x-s.x;if(i>R.distanceEpsilon&&n<-R.distanceEpsilon)return-1;if(i<-R.distanceEpsilon&&n>R.distanceEpsilon)return 1;let o=e.point.sub(s),a=t.point.sub(s),l=o.l1-a.l1;return l<0?(e.deleted=!0,-1):l>0?(t.deleted=!0,1):(e.stamp>t.stamp?e.deleted=!0:t.deleted=!0,0)}throw new Error}}function yr(s,e,t){!s.irect.intersects_rect(e.irect)||(s.Left==null?e.Left==null?t(s.UserData,e.UserData):(yr(s,e.Left,t),yr(s,e.Right,t)):e.Left!=null?(yr(s.Left,e.Left,t),yr(s.Left,e.Right,t),yr(s.Right,e.Left,t),yr(s.Right,e.Right,t)):(yr(s.Left,e,t),yr(s.Right,e,t)))}function Vt(s,e,t){!s.irect.intersects_rect(e.irect)||(s===e?W_(s,t):s.Left==null?e.Left==null?t(s.UserData,e.UserData):(Vt(s,e.Left,t),Vt(s,e.Right,t)):e.Left!=null?(Vt(s.Left,e.Left,t),Vt(s.Left,e.Right,t),Vt(s.Right,e.Left,t),Vt(s.Right,e.Right,t)):(Vt(s.Left,e,t),Vt(s.Right,e,t)))}function ji(s,e,t){if(!s.irect.intersects_rect(e.irect))return!1;if(s===e)return z_(s,t);if(s.Left==null){if(e.Left==null)return t(s.UserData,e.UserData);if(ji(s,e.Left,t)||ji(s,e.Right,t))return!0}else if(e.Left!=null){if(ji(s.Left,e.Left,t)||ji(s.Left,e.Right,t)||ji(s.Right,e.Left,t)||ji(s.Right,e.Right,t))return!0}else if(ji(s.Left,e,t)||ji(s.Right,e,t))return!0;return!1}function z_(s,e){return s.Left==null?!1:ji(s.Left,s.Left,e)||ji(s.Left,s.Right,e)||ji(s.Right,s.Right,e)}function W_(s,e){s.Left!=null&&(Vt(s.Left,s.Left,e),Vt(s.Left,s.Right,e),Vt(s.Right,s.Right,e))}var AC=BigInt("6364136223846793005"),G0=(BigInt(1)<<BigInt(32))-BigInt(1),Es=(BigInt(1)<<BigInt(64))-BigInt(1),ya=class{constructor(e,t){this._state=BigInt(0),this._inc=(BigInt(t)<<BigInt(1)|BigInt(1))&Es,this._random_b(),this._state=this._state+BigInt(e)&Es,this._random_b()}_random_b(){let e=this._state;this._state=e*AC+this._inc&Es;let t=(e>>BigInt(18)^e)>>BigInt(27),i=e>>BigInt(59),n=i^BigInt(31);return(t>>i|t<<n)&G0}_advance(e){e&=Es;let t=BigInt(1),i=AC,n=BigInt(0),o=this._inc;for(;e>0;)e&BigInt(1)&&(t=t*i&Es,n=n*i+o&Es),o=(i+BigInt(1))*o&Es,i=i*i&Es,e>>=BigInt(1);this._state=t*this._state+n&Es}randint(e){if(e>G0)throw new TypeError(`Bound too large: ${e}`);if(e<=0)throw new TypeError(`Empty sample space for r: 0 \u2264 r < ${e}`);let t=BigInt(e),i=(G0^t)%t;for(;;){let n=this._random_b();if(n>=i)return Number(n%t)}}random(){return Number(this._random_b())/Math.pow(2,32)}};var ql;function Sa(s){return ql==null&&(ql=new ya(0,0)),ql.randint(s)}function Ea(s){ql=new ya(s,0)}function Go(){return ql==null&&(ql=new ya(0,0)),ql.random()}var IC=Ae(zn(),1);function*Yn(s){let e=new Array(s.nodeCount).fill(!1),t=new IC.Queue;for(let i=0;i<s.nodeCount;i++)if(!e[i]){let n=new Array;for(TC(i,t,e);t.length>0;){let o=t.dequeue();n.push(o);for(let a of H_(s,o))TC(a,t,e)}yield n}}function*H_(s,e){for(let t of s.outEdges[e])yield t.target;for(let t of s.inEdges[e])yield t.source}function TC(s,e,t){t[s]===!1&&(e.enqueue(s),t[s]=!0)}var wC=Ae(zn(),1);function Oc(s){let e=new lr;return e.SetEdges(s,lr.vertexCount(s)),e}function um(s){let e=new lr;return e.SetEdges(s,lr.vertexCount(s)),e}function Sr(s,e){let t=new lr;return t.SetEdges(s,e),t}var lr=class{constructor(){this.nodeCount=0}*incidentEdges(e){for(let t of this.outEdges[e])yield t;for(let t of this.inEdges[e])yield t}static deleteFromArray(e,t){let i=e.indexOf(t,0);i>-1&&e.splice(i,1)}removeEdge(e){lr.deleteFromArray(this.edges,e),e.source!==e.target?(lr.deleteFromArray(this.outEdges[e.source],e),lr.deleteFromArray(this.inEdges[e.target],e)):lr.deleteFromArray(this.selfEdges[e.source],e)}static vertexCount(e){let t=0;for(let i of e)i.source>=t&&(t=i.source),i.target>=t&&(t=i.target);return++t}SetEdges(e,t){this.edges=e,this.nodeCount=t;let i=new Array(this.nodeCount).fill(0),n=new Array(this.nodeCount).fill(0),o=new Array(this.nodeCount).fill(0);this.outEdges=new Array(this.nodeCount),this.inEdges=new Array(this.nodeCount),this.selfEdges=new Array(this.nodeCount);for(let a of this.edges)a.source!==a.target?(i[a.source]++,n[a.target]++):o[a.source]++;for(let a=0;a<this.nodeCount;a++)this.outEdges[a]=new Array(i[a]),i[a]=0,this.inEdges[a]=new Array(n[a]),n[a]=0,this.selfEdges[a]=new Array(o[a]),o[a]=0;for(let a of this.edges){let l=a.source,u=a.target;l!==u?(this.outEdges[l][i[l]++]=a,this.inEdges[u][n[u]++]=a):this.selfEdges[l][o[l]++]=a}}inEdgesCount(e){return this.inEdges[e].length}outEdgesCount(e){return this.outEdges[e].length}selfEdgesCount(e){return this.selfEdges[e].length}addEdge(e){this.edges.push(e),e.source!==e.target?(this.outEdges[e.source].push(e),this.inEdges[e.target].push(e)):this.selfEdges[e.source].push(e)}*nodesOfConnectedGraph(){if(this.edges.length===0)return;let e=new Set,t=new wC.Queue,i=this.edges[0].source;for(lr.enqueue(e,t,i),yield i;t.length>0;){i=t.dequeue();for(let n of this.outEdges[i]){let o=n.target;e.has(o)||(lr.enqueue(e,t,o),yield o)}for(let n of this.inEdges[i]){let o=n.source;e.has(o)||(lr.enqueue(e,t,o),yield o)}}}*pred(e){for(let t of this.inEdges[e])yield t.source}*succ(e){for(let t of this.outEdges[e])yield t.target}static enqueue(e,t,i){t.enqueue(i),e.add(i)}};var Xl=class{get Sequence(){return this.f}set Sequence(e){this.f=e}get Length(){return this.length}set Length(e){this.length=e}constructor(e,t){this.f=e,this.length=t}FindMinimum(){let e=0,t=this.length-1,i=e+Math.floor((t-e)/2),n=this.f(i);if(n>=this.f(0)&&n>=this.f(this.length-1))return this.f(0)<this.f(this.length-1)?0:this.length-1;for(;t-e>1;)switch(i=e+Math.floor((t-e)/2),this.BehaviourAtIndex(i)){case 1:e=i;break;case 0:t=i;break;case 2:return i}return e===t||this.f(e)<=this.f(t)?e:t}BehaviourAtIndex(e){let t=this.f(e);if(e===0){let o=this.f(1);return o===t?2:o>t?0:1}if(e===this.length-1){let o=this.f(this.length-2);return o===t?2:o>t?1:0}let i=t-this.f(e-1),n=this.f(e+1)-t;return i*n<=0?2:i>0?0:1}FindMaximum(){let e=0,t=this.length-1,i=e+Math.floor((t-e)/2),n=this.f(i);if(n<=this.f(0)&&n<=this.f(this.length-1))return this.f(0)>this.f(this.length-1)?0:this.length-1;for(;t-e>1;)switch(i=e+Math.floor((t-e)/2),this.BehaviourAtIndex(i)){case 1:t=i;break;case 0:e=i;break;case 2:return i}return e===t||this.f(e)>=this.f(t)?e:t}};var cm=class{toArray(){let e=[];for(let t=0;t<this.length;t++)e.push(this.f(t));return e}constructor(e,t){this.f=e,this.length=t}GetAdjustedSequenceForMinimum(){let e=this.f(0),i=(this.f(this.length-1)-e)/(this.length-1);return n=>Math.min(this.f(n),e+i*n)}GetAdjustedSequenceForMaximum(){let e=this.f(0),i=(this.f(this.length-1)-e)/(this.length-1);return n=>Math.max(this.f(n),e+i*n)}FindMinimum(){return this.f(0)===this.f(this.length-1)?new Xl(this.f,this.length).FindMinimum():new Xl(this.GetAdjustedSequenceForMinimum(),this.length).FindMinimum()}FindMaximum(){return this.f(0)===this.f(this.length-1)?new Xl(this.f,this.length).FindMaximum():new Xl(this.GetAdjustedSequenceForMaximum(),this.length).FindMaximum()}};var xa=class{constructor(e,t){this.P=e,this.Q=t}LeftFromLineOnP(e,t,i){let n=this.P.pnt(e);return this.upperBranchOnP?m.pointToTheLeftOfLineOrOnLine(i,n,t):m.pointToTheRightOfLineOrOnLine(i,n,t)}LeftFromLineOnQ(e,t,i){let n=this.Q.pnt(e);return this.lowerBranchOnQ?m.pointToTheLeftOfLineOrOnLine(i,n,t):m.pointToTheRightOfLineOrOnLine(i,n,t)}PrevOnP(e){return this.upperBranchOnP?this.P.Prev(e):this.P.Next(e)}PrevOnQ(e){return this.lowerBranchOnQ?this.Q.Prev(e):this.Q.Next(e)}NextOnP(e){return this.upperBranchOnP?this.P.Next(e):this.P.Prev(e)}NextOnQ(e){return this.lowerBranchOnQ?this.Q.Next(e):this.Q.Prev(e)}MedianOnP(e,t){return this.upperBranchOnP?this.P.Median(e,t):this.P.Median(t,e)}MedianOnQ(e,t){return this.lowerBranchOnQ?this.Q.Median(e,t):this.Q.Median(t,e)}ModuleP(e,t){return this.upperBranchOnP?this.P.Module(t-e):this.P.Module(e-t)}ModuleQ(e,t){return this.lowerBranchOnQ?this.Q.Module(t-e):this.Q.Module(e-t)}TangentBetweenBranches(e,t,i,n){for(;t!==e||n!==i;){let o=t!==e?this.MedianOnP(e,t):e,a=n!==i?this.MedianOnQ(i,n):i,l=this.P.pnt(o),u=this.Q.pnt(a),c=!0;this.ModuleP(e,t)>1?this.LeftFromLineOnP(this.NextOnP(o),l,u)?e=o:this.LeftFromLineOnP(this.PrevOnP(o),l,u)?t=o:c=!1:t!==e?this.LeftFromLineOnP(t,this.P.pnt(e),u)?e=t:this.LeftFromLineOnP(e,this.P.pnt(t),u)?t=e:c=!1:c=!1;let h=!0;this.ModuleQ(i,n)>1?this.LeftFromLineOnQ(this.NextOnQ(a),u,l)?i=a:this.LeftFromLineOnQ(this.PrevOnQ(a),u,l)?n=a:h=!1:n!==i?this.LeftFromLineOnQ(n,this.Q.pnt(i),l)?i=n:this.LeftFromLineOnQ(i,this.Q.pnt(n),l)?n=i:h=!1:h=!1,!c&&!h&&(e=o,t=o,i=a,n=a)}return[e,n]}FindDividingBisector(e){let t={pClosest:void 0,qClosest:void 0,p1:void 0,p2:void 0,q1:void 0,q2:void 0};this.FindClosestFeatures(t),e.bisectorPivot=m.middle(t.pClosest,t.qClosest),e.bisectorRay=t.pClosest.sub(t.qClosest).rotate(Math.PI/2),e.p1=t.p1,e.p2=t.p2,e.q1=t.q1,e.q2=t.q2}FindClosestPoints(){let e={q2:void 0,p1:void 0,p2:void 0,q1:void 0,pClosest:void 0,qClosest:void 0};return this.FindClosestFeatures(e),{pClosest:e.pClosest,qClosest:e.qClosest}}FindClosestFeatures(e){let t={leftTangentPoint:void 0,rightTangentPoint:void 0};this.P.GetTangentPoints(t,this.Q.pp(0).point),e.p2=t.leftTangentPoint,e.p1=t.rightTangentPoint,e.p2===e.p1&&(e.p2+=this.P.count),this.Q.GetTangentPoints(t,this.P.pp(0).point),e.q1=t.leftTangentPoint,e.q2=t.rightTangentPoint,e.q2===e.q1&&(e.q2+=this.Q.count),this.FindClosestPoints_(e)}FindClosestPoints_(e){for(;this.ChunksAreLong(e.p2,e.p1,e.q2,e.q1);)this.ShrinkChunks(e);e.p1===e.p2?(e.pClosest=this.P.pp(e.p2).point,e.q1===e.q2?e.qClosest=this.Q.pp(e.q1).point:(e.qClosest=m.ClosestPointAtLineSegment(e.pClosest,this.Q.pp(e.q1).point,this.Q.pp(e.q2).point),m.closeDistEps(e.qClosest,this.Q.pnt(e.q1))?e.q2=e.q1:m.closeDistEps(e.qClosest,this.Q.pnt(e.q2))&&(e.q1=e.q2))):(e.qClosest=this.Q.pp(e.q1).point,e.pClosest=m.ClosestPointAtLineSegment(e.qClosest,this.P.pp(e.p1).point,this.P.pp(e.p2).point),m.closeDistEps(e.pClosest,this.P.pnt(e.p1))?e.p2=e.p1:m.closeDistEps(e.qClosest,this.P.pnt(e.p2))&&(e.p1=e.p2))}ChunksAreLong(e,t,i,n){let o=this.P.Module(e-t)+1;if(o>2)return!0;let a=this.Q.Module(n-i)+1;return a>2||o===2&&a===2}ShrinkChunks(e){let t=e.p1===e.p2?e.p1:this.P.Median(e.p1,e.p2),i=e.q1===e.q2?e.q1:this.Q.Median(e.q2,e.q1),n=this.P.pp(t).point,o=this.Q.pp(i).point,a={a1:void 0,a2:void 0,b1:void 0,b2:void 0};if(this.GetAnglesAtTheMedian(t,i,n,o,a),!this.InternalCut(e,t,i,a.a1,a.a2,a.b1,a.b2)&&!xa.OneOfChunksContainsOnlyOneVertex(e,t,i,a.a1,a.b1)&&!this.OnlyOneChunkContainsExactlyTwoVertices(e,{mp:t,mq:i},a)){if(e.p2===this.P.Next(e.p1)&&e.q1===this.Q.Next(e.q2)){let l=k.minDistBetweenLineSegments(this.P.pnt(e.p1),this.P.pnt(e.p2),this.Q.pnt(e.q1),this.Q.pnt(e.q2));l.parab===0?e.p2=e.p1:l.parab===1?e.p1=e.p2:l.parcd===0?e.q2=e.q1:l.parcd===1&&(e.q1=e.q2);return}a.a1<=Math.PI&&a.a2<=Math.PI&&a.b1<=Math.PI&&a.b2<=Math.PI?a.a1+a.b1>Math.PI?a.a1>=Math.PI/2?e.p1=t:e.q1=i:a.a2>=Math.PI/2?e.p2=t:e.q2=i:a.a1>Math.PI?e.p1=t:a.a2>Math.PI?e.p2=t:a.b1>Math.PI?e.q1=i:e.q2=i}}InternalCut(e,t,i,n,o,a,l){let u=!1;if(n>=Math.PI&&o>=Math.PI){let c=this.P.pp(t).point,h=this.Q.pp(i).point,d=this.P.pp(this.P.Next(t)).point,f=m.getTriangleOrientation(c,h,this.Q.pp(0).point),p=m.getTriangleOrientation(c,h,d);f===p?e.p1=this.P.Next(t):e.p2=this.P.Prev(t),u=!0}if(a>=Math.PI&&l>=Math.PI){let c=this.P.pp(t).point,h=this.Q.pp(i).point,d=this.Q.pp(this.Q.Next(i)).point,f=m.getTriangleOrientation(c,h,this.P.pp(0).point),p=m.getTriangleOrientation(c,h,d);f===p?e.q2=this.Q.Next(i):e.q1=this.Q.Prev(i),u=!0}return u}GetAnglesAtTheMedian(e,t,i,n,o){o.a1=m.anglePCP(n,i,this.P.pnt(this.P.Prev(e))),o.a2=m.anglePCP(this.P.pnt(this.P.Next(e)),i,n),o.b1=m.anglePCP(this.Q.pnt(this.Q.Next(t)),n,i),o.b2=m.anglePCP(i,n,this.Q.pnt(this.Q.Prev(t)))}OnlyOneChunkContainsExactlyTwoVertices(e,t,i){let n=e.p2===this.P.Next(e.p1),o=e.q1===this.Q.Next(e.q2);return n&&!o?(this.ProcessShortSide(e,t.mp,t.mq,i.a1,i.b1,i.a2,i.b2),!0):o&&!n?(this.SwapEverything(e,t,i),this.ProcessShortSide(e,t.mp,t.mq,i.a1,i.b1,i.a2,i.b2),this.SwapEverything(e,t,i),!0):!1}SwapEverything(e,t,i){this.SwapPq();let n=e.p2;e.p2=e.q1,e.q1=n,n=e.q2,e.q2=e.p1,e.p1=n,n=t.mq,t.mq=t.mp,t.mp=n,n=i.a2,i.a2=i.b1,i.b1=n,n=i.b2,i.b2=i.a1,i.a1=n}ProcessShortSide(e,t,i,n,o,a,l){t===e.p2?this.ProcessSide(e,i,n,o,l):a<=Math.PI?a+l>=Math.PI?a>=Math.PI/2?e.p2=e.p1:e.q2=i:o>=Math.PI/2?e.q1=i:a<l&&(m.canProject(this.Q.pnt(i),this.P.pp(e.p1).point,this.P.pp(e.p2).point)?e.q1=i:e.p1=e.p2):n+o<=Math.PI?e.p1=e.p2:e.p2=e.p1}SwapPq(){let e=this.P;this.P=this.Q,this.Q=e}ProcessSide(e,t,i,n,o){let a=this.Q.pnt(t);i<=Math.PI?i+n>=Math.PI?i>=Math.PI/2?e.p1=e.p2:e.q1=t:o>=Math.PI/2?e.q2=t:i<o&&(m.canProject(a,this.P.pp(e.p1).point,this.P.pp(e.p2).point)?e.q2=t:e.p2=e.p1):(e.p2=e.p1,n>=Math.PI?e.q1=t:o>=Math.PI&&(e.q2=t))}static OneOfChunksContainsOnlyOneVertex(e,t,i,n,o){return e.p1===e.p2?(o>=Math.PI/2?e.q1=i:e.q2=i,!0):e.q1===e.q2?(n>=Math.PI/2?e.p1=t:e.p2=t,!0):!1}CalculateLeftTangents(){let e={bisectorPivot:null,bisectorRay:null,p1:0,p2:0,q1:0,q2:0};this.FindDividingBisector(e);let t=this.P.FindTheFurthestVertexFromBisector(e.p1,e.p2,e.bisectorPivot,e.bisectorRay),i=this.Q.FindTheFurthestVertexFromBisector(e.q2,e.q1,e.bisectorPivot,e.bisectorRay);this.upperBranchOnP=!1,this.lowerBranchOnQ=!0,this.leftPLeftQ=this.TangentBetweenBranches(t,e.p1,i,e.q1),this.lowerBranchOnQ=!1,this.leftPRightQ=this.TangentBetweenBranches(t,e.p1,i,e.q2)}CalculateRightTangents(){let e={bisectorPivot:null,bisectorRay:null,p1:0,p2:0,q1:0,q2:0};this.FindDividingBisector(e);let t=this.P.FindTheFurthestVertexFromBisector(e.p1,e.p2,e.bisectorPivot,e.bisectorRay),i=this.Q.FindTheFurthestVertexFromBisector(e.q2,e.q1,e.bisectorPivot,e.bisectorRay);this.upperBranchOnP=!0,this.lowerBranchOnQ=!0,this.rightPLeftQ=this.TangentBetweenBranches(t,e.p2,i,e.q1),this.lowerBranchOnQ=!1,this.rightPRightQ=this.TangentBetweenBranches(t,e.p2,i,e.q2)}};var Jt=class{static mkFromPoints(e){return new Jt(ne.mkClosedFromPoints(e))}get Polyline(){return this.polyline}constructor(e){this.polyline=e,this.points=new Array;for(let t=this.polyline.startPoint;t;t=t.next)this.points.push(t)}Next(e){return this.Module(e+1)}Prev(e){return this.Module(e-1)}get count(){return this.Polyline.count}Module(e){return e<0?e+this.count:e<this.count?e:e-this.count}pp(e){return this.points[this.Module(e)]}pnt(e){return this.pp(e).point}toString(){return this.polyline.toString()}Median(e,t){return t>e?Math.floor((t+e)/2):this.Module(t+Math.floor((this.count+e)/2))}FindTheFurthestVertexFromBisector(e,t,i,n){let o=n.rotate(Math.PI/2);this.polyline.startPoint.point.sub(i).dot(o)<0&&(o=o.mul(-1)),e===t&&(t=this.Next(e));do{let a=this.Median(t,e),l=this.pnt(a);this.pnt(this.Next(a)).sub(l).dot(o)>=0?t=this.Next(a):this.pnt(this.Prev(a)).sub(l).dot(o)>=0?e=this.Prev(a):t=a,e=a}while(e!==t);return e}static TestPolygonDist(e,t){let i=Number.MAX_SAFE_INTEGER;for(let n=0;n<e.count;n++)for(let o=0;o<t.count;o++){let a=k.minDistBetweenLineSegments(e.pnt(n),e.pnt(n+1),t.pnt(o),t.pnt(o+1));i=Math.min(i,a.dist)}return i}static Distance(e,t){let n=new xa(e,t).FindClosestPoints();return{p:n.pClosest,q:n.qClosest,dist:n.pClosest.sub(n.qClosest).length}}static DistanceOnly(e,t){return Jt.Distance(e,t).dist}static PolygonIsLegalDebug(e){let t=e.Polyline;for(let i=t.startPoint;i.next!=null&&i.next.next!=null;i=i.next)if(m.getTriangleOrientation(i.point,i.next.point,i.next.next.point)===2)return!1;return!0}static DistancePoint(e,t){let i=Number.MAX_VALUE;for(let n=0;n<e.count;n++){let o=m.distToLineSegment(t,e.points[n].point,e.points[(n+1)%e.count].point).dist;i=Math.min(i,o)}return i}GetTangentPoints(e,t){let i=new cm(this.GetSequenceDelegate(t),this.count);e.leftTangentPoint=i.FindMaximum(),e.rightTangentPoint=i.FindMinimum()}GetSequenceDelegate(e){let t=this.pnt(0);return i=>{let n=m.anglePCP(t,e,this.pnt(i));return n<Math.PI?n:n-2*Math.PI}}};var Re=class{constructor(e,t,i,n){this.randomizationShift=.01;this.TightObstacles=new Set;this.Obstacles=e,this.TightPadding=t,this.LoosePadding=i,this.IgnoreTightPadding=n}ObstaclesIntersectLine(e,t){return this.ObstaclesIntersectICurve(k.mkPP(e,t))}static PadCorner(e,t,i,n,o){let a=Re.GetPaddedCorner(t,i,n,o);return a.numberOfPoints===-1?!1:(e.addPoint(a.a),a.numberOfPoints===2&&e.addPoint(a.b),!0)}static CurveIsClockwise(e,t){return m.getTriangleOrientation(t,e.start,e.start.add(e.derivative(e.parStart)))==0}static PaddedPolylineBoundaryOfNode(e,t,i=!1){return Re.CreatePaddedPolyline(I.polylineAroundClosedCurve(e),t,i)}static LoosePolylineWithFewCorners(e,t,i){return t<R.distanceEpsilon?e:Re.CreateLoosePolylineOnBisectors(e,t,i)}static CreateLoosePolylineOnBisectors(e,t,i){let n=Array.from(Re.BisectorPoints(e,t));i&&a();let o=qr.CalculateConvexHull(n);return ne.mkClosedFromPoints(o);function a(){for(let l=0;l<n.length;l++){let u=n[l];n[l]=new m(u.x+(2*Go()-1)*i,u.y+(2*Go()-1)*i)}}}static CreateRectNodeOfPolyline(e){return ct(e,e.boundingBox)}CreateLooseObstacles(){this.tightPolylinesToLooseDistances=new Map,this.LooseObstacles=new Array;for(let e of this.TightObstacles){let t=Re.FindMaxPaddingForTightPolyline(this.RootOfTightHierarchy,e,this.LoosePadding);this.tightPolylinesToLooseDistances.set(e,t),this.LooseObstacles.push(Re.LoosePolylineWithFewCorners(e,t,this.randomizationShift))}this.RootOfLooseHierarchy=Re.CalculateHierarchy(this.LooseObstacles)}CreateTightObstacles(){this.RootOfTightHierarchy=this.CreateTightObstacles_(),this.OverlapsDetected=this.TightObstacles.size<this.Obstacles.length}Calculate(){this.IgnoreTightPadding?this.CreateTightObstaclesIgnoringTightPadding():this.CreateTightObstacles(),this.IsEmpty()||this.CreateLooseObstacles()}IsEmpty(){return this.TightObstacles==null||this.TightObstacles.size===0}ObstaclesIntersectICurve(e){let t=e.boundingBox;return Re.CurveIntersectsRectangleNode(e,t,this.RootOfTightHierarchy)}static CurveIntersectsRectangleNode(e,t,i){if(!i.irect.intersects(t))return!1;if(i.UserData!=null){let n=i.UserData;return I.intersectionOne(n,e,!1)!=null||Re.PointIsInside(n.start,e)}return Re.CurveIntersectsRectangleNode(e,t,i.Left)||Re.CurveIntersectsRectangleNode(e,t,i.Right)}static PointIsInside(e,t){return I.PointRelativeToCurveLocation(e,t)===2}CreateTightObstaclesIgnoringTightPadding(){let e=this.Obstacles.map(n=>I.polylineAroundClosedCurve(n)),t=Re.CalculateHierarchy(e),i=Re.GetOverlappedPairSet(t);if(this.TightObstacles=new Set,i.size===0){for(let n of e){let o=Re.FindMaxPaddingForTightPolyline(t,n,this.TightPadding);this.TightObstacles.add(Re.LoosePolylineWithFewCorners(n,o,this.randomizationShift))}this.RootOfTightHierarchy=Re.CalculateHierarchy(Array.from(this.TightObstacles))}else{for(let n of e)this.TightObstacles.add(Re.CreatePaddedPolyline(n,this.TightPadding));if(!this.IsEmpty())for(this.RootOfTightHierarchy=Re.CalculateHierarchy(Array.from(this.TightObstacles)),this.OverlapsDetected=!1;Re.GetOverlappedPairSet(this.RootOfTightHierarchy).size>0;)this.RootOfTightHierarchy=Re.ReplaceTightObstaclesWithConvexHulls(this.TightObstacles,Array.from(i)),this.OverlapsDetected=!0}}CreateTightObstacles_(){if(this.Obstacles.length===0)return null;for(let e of this.Obstacles)Re.CalculateTightPolyline(this.TightObstacles,this.TightPadding,e);return Re.RemovePossibleOverlapsInTightPolylinesAndCalculateHierarchy(this.TightObstacles)}static CalculateTightPolyline(e,t,i){let n=Re.PaddedPolylineBoundaryOfNode(i,t);e.add(n)}static CalculateHierarchy(e){let t=e.map(i=>Re.CreateRectNodeOfPolyline(i));return tt(t)}static RemovePossibleOverlapsInTightPolylinesAndCalculateHierarchy(e){let t=Re.CalculateHierarchy(Array.from(e)),i;for(;(i=Re.GetOverlappedPairSet(t)).size>0;)t=Re.ReplaceTightObstaclesWithConvexHulls(e,Array.from(i));return t}static MapToInt(e){let t=new Map;for(let i=0;i<e.length;i++)t.set(e[i],i);return t}static ReplaceTightObstaclesWithConvexHulls(e,t){let i=new Set;for(let u of t)i.add(u[0]),i.add(u[1]);let n=Array.from(i),o=Re.MapToInt(n),a=um(Array.from(t).map(u=>new me(o.get(u[0]),o.get(u[1])))),l=Yn(a);for(let u of l){let c=u.map(f=>n[f]),h=wo(c,f=>f),d=qr.createConvexHullAsClosedPolyline(h);for(let f of c)e.delete(f);e.add(d)}return Re.CalculateHierarchy(Array.from(e))}static OneCurveLiesInsideOfOther(e,t){return I.PointRelativeToCurveLocation(e.start,t)!==0||I.PointRelativeToCurveLocation(t.start,e)!==0}static PolylinesIntersect(e,t){return I.CurvesIntersect(e,t)||Re.OneCurveLiesInsideOfOther(e,t)}static GetOverlappedPairSet(e){let t=new Set;return Vt(e,e,(i,n)=>{Re.PolylinesIntersect(i,n)&&t.add([i,n])}),t}static*BisectorPoints(e,t){for(let i=e.startPoint;i!=null;i=i.next){let n={skip:!1},o=Re.GetStickingVertexOnBisector(i,t,n);n.skip||(yield o)}}static GetStickingVertexOnBisector(e,t,i){let n=e.polyline.prev(e).point,o=e.point,a=e.polyline.next(e).point,l=o.sub(n).normalize().add(o.sub(a).normalize()),u=l.length;return u<R.tolerance?i.skip=!0:(i.skip=!1,l=l.div(u)),l.mul(t).add(o)}static FindMaxPaddingForTightPolyline(e,t,i){let n=i,o=new Jt(t),a=t.boundingBox.clone();a.pad(2*i);for(let l of Array.from(e.GetNodeItemsIntersectingRectangle(a)).filter(u=>u!==t)){let u=Jt.Distance(o,new Jt(l)).dist;n=Math.min(n,u/Re.LooseDistCoefficient)}return n}static GetPaddedCorner(e,t,i,n){let o=e.point,a=t.point,l=i.point;if(m.getTriangleOrientation(o,a,l)===1)return{a:void 0,b:void 0,numberOfPoints:-1};let u=a.sub(o).rotate(Math.PI/2).normalize();if(Re.CornerIsNotTooSharp(o,a,l)){u=u.mul(n);let S=l.sub(a).normalize().mul(n).rotate(Math.PI/2),E=m.lineLineIntersection(o.add(u),a.add(u),a.add(S),l.add(S));return{a:E,b:E,numberOfPoints:1}}let c=a.sub(o).normalize().add(a.sub(l).normalize());if(c.length<R.intersectionEpsilon){let S=a.add(u.mul(n));return{a:S,b:S,numberOfPoints:1}}let h=c.normalize().mul(n),d=h.rotate(Math.PI/2),f=(n-h.dot(u))/d.dot(u),p=d.mul(f);return{a:h.add(p).add(a),b:h.sub(p).add(a),numberOfPoints:2}}static CornerIsNotTooSharp(e,t,i){let n=e.sub(t).rotate(Math.PI/4).add(t);return m.getTriangleOrientation(t,n,i)===1}static CreatePaddedPolyline(e,t,i=!1){let n=new ne,o=i?j_(e):e;if(!Re.PadCorner(n,o.endPoint.prev,o.endPoint,o.startPoint,t))return Re.CreatePaddedPolyline(ne.mkClosedFromPoints(Array.from(qr.CalculateConvexHull(o))),t);if(!Re.PadCorner(n,o.endPoint,o.startPoint,o.startPoint.next,t))return Re.CreatePaddedPolyline(ne.mkClosedFromPoints(Array.from(qr.CalculateConvexHull(o))),t);for(let a=o.startPoint;a.next.next!=null;a=a.next)if(!Re.PadCorner(n,a,a.next,a.next.next,t))return Re.CreatePaddedPolyline(ne.mkClosedFromPoints(Array.from(qr.CalculateConvexHull(o))),t);return n.closed=!0,n}},$t=Re;$t.LooseDistCoefficient=2.1;function j_(s){let e=new ne,t=.01;for(let i=s.startPoint;i;i=i.next){let n=i.point.x+t*Go(),o=i.point.y+t*Go();e.addPointXY(n,o)}return e.closed=s.closed,e}var _c=class{get TightPolyline(){return this.tightPoly}set TightPolyline(e){this.tightPoly=e}static mk(e,t,i){let n=new _c;return n.TightPolyline=e,n.LooseShape=t,n.Distance=i,n}toString(){return(this.TightPolyline==null?"null":this.TightPolyline.toString().substring(0,5))+","+(this.LooseShape==null?"null":this.LooseShape.toString().substring(0,5))}};var Nc=class{constructor(e,t,i,n){this.loosePolylinesToNodes=new Map;this.MainShape=e,this.TightPadding=t,this.LoosePadding=i,this.ShapesToTightLooseCouples=n}Calculate(e,t=Number.MAX_VALUE){Ea(3),this.MainShape.Children.length!==0&&(this.CreateTightObstacles(),this.CreateTigthLooseCouples(e),this.OverlapsDetected&&this.FillTheMapOfShapeToTightLooseCouples())}FillTheMapOfShapeToTightLooseCouples(){let e=tt(this.MainShape.Children.map(t=>ct(t,t.BoundingBox)));yr(e,this.coupleHierarchy,this.TryMapShapeToTightLooseCouple.bind(this))}TryMapShapeToTightLooseCouple(e,t){Nc.ShapeIsInsideOfPoly(e,t.TightPolyline)&&this.ShapesToTightLooseCouples.set(e,t)}static ShapeIsInsideOfPoly(e,t){return I.PointRelativeToCurveLocation(e.BoundaryCurve.start,t)===2}CreateTigthLooseCouples(e){let t=new Array;for(let i of this.tightHierarchy.GetAllLeaves()){let n=$t.FindMaxPaddingForTightPolyline(this.tightHierarchy,i,this.LoosePadding),o=$t.LoosePolylineWithFewCorners(i,n,e),a=new Wn(o),l=_c.mk(i,a,n);this.ShapesToTightLooseCouples.set(this.tightToShape.get(i),l),t.push(l)}this.coupleHierarchy=tt(t.map(i=>ct(i,i.TightPolyline.boundingBox)))}CreateTightObstacles(){this.tightToShape=new Map;let e=new Set(this.MainShape.Children.map(this.InitialTightPolyline.bind(this))),t=e.size;this.tightHierarchy=$t.RemovePossibleOverlapsInTightPolylinesAndCalculateHierarchy(e),this.OverlapsDetected=t>e.size}InitialTightPolyline(e){let t=$t.PaddedPolylineBoundaryOfNode(e.BoundaryCurve,this.TightPadding),i=wo(this.LoosePolylinesUnderShape(e),o=>o).filter(o=>I.PointRelativeToCurveLocation(o,t)===0);if(i.length==0)return this.tightToShape&&this.tightToShape.set(t,e),t;let n=Array.from(t).concat(i);return t=ne.mkClosedFromPoints(qr.CalculateConvexHull(n)),this.tightToShape&&this.tightToShape.set(t,e),t}LoosePolylinesUnderShape(e){return e.Children.map(t=>this.ShapesToTightLooseCouples.get(t).LooseShape.BoundaryCurve)}};var LC=Ae(sr(),1);var hm=class{constructor(e,t,i){this.indexToA=e,this.priority=t,this.v=i}};var Er=class{constructor(e=_e){this.heapSize=0;this.compare=e,this.cache=new Map,this.A=[]}get count(){return this.heapSize}ContainsElement(e){return this.cache.has(e)}SwapWithParent(e){let t=this.A[e>>1];this.PutAtI(e>>1,this.A[e]),this.PutAtI(e,t)}Enqueue(e,t){let i=++this.heapSize,n=new hm(i,t,e);for(this.cache.set(e,n),this.A[i]=n;i>1&&this.compare(this.A[i>>1].priority,t)>0;)this.SwapWithParent(i),i>>=1}IsEmpty(){return this.heapSize===0}PutAtI(e,t){this.A[e]=t,t.indexToA=e}Dequeue(){if(this.heapSize===0)throw new Error("dequeue on an empty queue");let e=this.A[1].v;return this.MoveQueueOneStepForward(e),e}DequeueAndGetPriority(e){if(this.heapSize===0)throw new Error("dequeue on an empty queue");let t=this.A[1].v;return e.priority=this.A[1].priority,this.MoveQueueOneStepForward(t),t}MoveQueueOneStepForward(e){this.cache.delete(e),this.PutAtI(1,this.A[this.heapSize]);let t=1;for(;;){let i=t,n=t<<1;n<=this.heapSize&&this.compare(this.A[n].priority,this.A[t].priority)<0&&(i=n);let o=n+1;if(o<=this.heapSize&&this.compare(this.A[o].priority,this.A[i].priority)<0&&(i=o),i!==t)this.SwapWithParent(i);else break;t=i}this.heapSize--}DecreasePriority(e,t){let i=this.cache.get(e);if(!i)return;i.priority=t;let n=i.indexToA;for(;n>1&&this.compare(this.A[n].priority,this.A[n>>1].priority)<0;){this.SwapWithParent(n);n>>=1}}*GetEnumerator(){for(let e=1;e<=this.heapSize;e++)yield this.A[e].v}Peek(e){if(this.count===0){e.priority=0;return}return e.priority=this.A[1].priority,this.A[1].v}toString(){let e=new LC.StringBuilder;for(let t of this.A)e.Append(t+",");return e.ToString()}};var xs=class{constructor(e,t,i){this.upperBound=Number.POSITIVE_INFINITY;this._visGraph=i,this._visGraph.ClearPrevEdgesTable();for(let n of i.Vertices())n.Distance=Number.POSITIVE_INFINITY;this.source=e,this.targets=new Set(t),this.source.Distance=0}GetPath(){let e=new Er(_e);for(this.source.Distance=0,e.Enqueue(this.source,0);!e.IsEmpty()&&(this.current=e.Dequeue(),!this.targets.has(this.current));){for(let t of this.current.OutEdges)this.PassableOutEdge(t)&&this.ProcessNeighbor(e,t,t.Target);for(let t of this.current.InEdges)this.PassableInEdge(t)&&this.ProcessNeighbor(e,t,t.Source)}return this._visGraph.PreviosVertex(this.current)==null?null:this.CalculatePath()}PassableOutEdge(e){return e.Source===this.source||this.targets.has(e.Target)||!xs.IsForbidden(e)}PassableInEdge(e){return this.targets.has(e.Source)||e.Target===this.source||!xs.IsForbidden(e)}static IsForbidden(e){return e.IsPassable!=null&&!e.IsPassable()||e instanceof ar}ProcessNeighbor(e,t,i){let n=t.Length,o=this.current.Distance+n;o>=this.upperBound||(this.targets.has(i)&&(this.upperBound=o,this.closestTarget=i),i!==this.source&&this._visGraph.PreviosVertex(i)==null?(i.Distance=o,this._visGraph.SetPreviousEdge(i,t),e.Enqueue(i,o)):o<i.Distance&&(i.Distance=o,this._visGraph.SetPreviousEdge(i,t),e.DecreasePriority(i,o)))}CalculatePath(){if(this.closestTarget==null)return null;let e=new Array,t=this.closestTarget;do e.push(t),t=this._visGraph.PreviosVertex(t);while(t!==this.source);return e.push(this.source),e.reverse()}};var Yl=class{constructor(e,t,i){this._lengthMultiplier=1;this._lengthMultiplierForAStar=1;this._visGraph=e,this._source=t,this._target=i,this._source.Distance=0}get LengthMultiplier(){return this._lengthMultiplier}set LengthMultiplier(e){this._lengthMultiplier=e}get LengthMultiplierForAStar(){return this._lengthMultiplierForAStar}set LengthMultiplierForAStar(e){this._lengthMultiplierForAStar=e}GetPath(e){let t=new Er(_e);for(this._source.Distance=0,this._target.Distance=Number.POSITIVE_INFINITY,t.Enqueue(this._source,this.H(this._source));!t.IsEmpty();){let i={priority:0},n=t.DequeueAndGetPriority(i);if(i.priority>=this._target.Distance)break;for(let o of n.OutEdges)if(this.PassableOutEdge(o)){let a=o.Target;this.ProcessNeighbor(t,n,o,a)}for(let o of n.InEdges)if(this.PassableInEdge(o)){let a=o.Source;this.ProcessNeighbor(t,n,o,a)}}return this._visGraph.PreviosVertex(this._target)==null?null:this.CalculatePath(e)}PassableOutEdge(e){return e.Source===this._source||e.Target===this._target||!Yl.IsForbidden(e)}PassableInEdge(e){return e.Source===this._target||e.Target===this._source||!Yl.IsForbidden(e)}static IsForbidden(e){return e.IsPassable!=null&&!e.IsPassable()||e instanceof ar}ProcessNeighborN(e,t,i,n,o){let a=i.Length+o,l=t.Distance+a;n!==this._source&&this._visGraph.PreviosVertex(n)==null?(n.Distance=l,this._visGraph.SetPreviousEdge(n,i),n!==this._target&&e.Enqueue(n,this.H(n))):n!==this._source&&l<n.Distance&&(n.Distance=l,this._visGraph.SetPreviousEdge(n,i),n!==this._target&&e.DecreasePriority(n,this.H(n)))}ProcessNeighbor(e,t,i,n){let o=i.Length,a=t.Distance+o;n!==this._source&&this._visGraph.PreviosVertex(n)==null?(n.Distance=a,this._visGraph.SetPreviousEdge(n,i),n!==this._target&&e.Enqueue(n,this.H(n))):n!==this._source&&a<n.Distance&&(n.Distance=a,this._visGraph.SetPreviousEdge(n,i),n!==this._target&&e.DecreasePriority(n,this.H(n)))}H(e){return e.Distance+e.point.sub(this._target.point).length*this.LengthMultiplierForAStar}CalculatePath(e){let t=new Array,i=this._target;do t.push(i),e&&this._visGraph.ShrinkLengthOfPrevEdge(i,this.LengthMultiplier),i=this._visGraph.PreviosVertex(i);while(i!==this._source);return t.push(this._source),t.reverse()}};var RC=Ae(sr(),1),Md=class{toString(){return RC.String.Format("{0},{1}",this.Start,this.End)}get Start(){return this.leftTangent.End.point}get End(){return this.rightTangent.End.point}constructor(e,t){this.LeftTangent=e,this.RightTangent=t}get LeftTangent(){return this.leftTangent}set LeftTangent(e){this.leftTangent=e}get RightTangent(){return this.rightTangent}set RightTangent(e){this.rightTangent=e}get RbNode(){return this.rbNode}set RbNode(e){this.rbNode=e}};var OC=Ae(sr(),1),Bd=class{get Comp(){return this.comp}set Comp(e){this.comp=e}get IsHigh(){return!this.IsLow}get IsLow(){return this.lowTangent}set IsLow(e){this.lowTangent=e}get SeparatingPolygons(){return this.separatingPolygons}set SeparatingPolygons(e){this.separatingPolygons=e}get Diagonal(){return this.diagonal}set Diagonal(e){this.diagonal=e}get Start(){return this.start}set Start(e){this.start=e}get End(){return this.end}set End(e){this.end=e}constructor(e,t){this.start=e,this.End=t}toString(){return OC.String.Format("{0},{1}",this.Start,this.End)}};var Dd=class{get PointOnTangentAndInsertedDiagonal(){return this.pointOnTheRay}set PointOnTangentAndInsertedDiagonal(e){this.pointOnTheRay=e}Compare(e,t){if(e.Start.equal(t.Start))return 0;switch(m.getTriangleOrientation(this.PointOnTangentAndInsertedDiagonal,t.Start,t.End)){case 1:return-1;default:return 1}}static BelongsToTheDiagonal(e,t,i){return m.closeDistEps(e,m.ClosestPointAtLineSegment(e,t,i))}static IntersectDiagonalWithRay(e,t,i){let n=t.sub(e),o=i.Start,a=i.End,l=mn.solve(a.x-o.x,n.x*-1,e.x-o.x,a.y-o.y,n.y*-1,e.y-o.y);return e.add(n.mul(l.y))}};var Fo=class{constructor(e){this.pivot=e}IComparer(e,t){if(e===t)return 0;if(e==null)return-1;if(t==null)return 1;let i=e.Start.point.sub(this.pivot),n=t.Start.point.sub(this.pivot);return Fo.CompareVectorsByAngleToXAxis(i,n)}static CompareVectorsByAngleToXAxis(e,t){return e.y>=0?t.y<0?-1:Fo.CompareVectorsPointingToTheSameYHalfPlane(e,t):t.y>=0?1:Fo.CompareVectorsPointingToTheSameYHalfPlane(e,t)}static CompareVectorsPointingToTheSameYHalfPlane(e,t){let i=e.x*t.y-e.y*t.x;if(i>R.tolerance)return-1;if(i<-R.tolerance)return 1;if(e.x>=0){if(t.x<0)return-1}else if(t.x>=0)return 1;let n=Math.abs(e.x)-Math.abs(t.x);return n<0?-1:n>0?1:(n=Math.abs(e.y)-Math.abs(t.y),n<0?-1:n>0?1:0)}};var Kn=class extends Pe{constructor(t,i,n){super(null);this.polygons=[];this.activeDiagonalComparer=new Dd;this.polygons=t,this.visibilityGraph=n,this.addedPolygons=i}run(){this.useLeftPTangents=!0,this.CalculateAndAddEdges(),this.useLeftPTangents=!1,this.CalculateAndAddEdges()}CalculateAndAddEdges(){for(let t of this.addedPolygons)this.CalculateVisibleTangentsFromPolygon(t);this.ProgressStep()}CalculateVisibleTangentsFromPolygon(t){this.currentPolygon=t,this.AllocateDataStructures(),this.OrganizeTangents(),this.InitActiveDiagonals(),this.Sweep()}AllocateDataStructures(){this.tangents=new Array,this.diagonals=new Array,this.activeDiagonalTree=new dt(this.activeDiagonalComparer.Compare.bind(this.activeDiagonalComparer))}Sweep(){if(!(this.tangents.length<2))for(let t=1;t<this.tangents.length;t++){let i=this.tangents[t];i.Diagonal!=null?(i.Diagonal.RbNode===this.activeDiagonalTree.treeMinimum()&&this.AddVisibleEdge(i),i.IsHigh&&this.RemoveDiagonalFromActiveNodes(i.Diagonal)):i.IsLow&&(this.activeDiagonalComparer.PointOnTangentAndInsertedDiagonal=i.End.point,this.InsertActiveDiagonal(new Md(i,i.Comp)),i.Diagonal.RbNode===this.activeDiagonalTree.treeMinimum()&&this.AddVisibleEdge(i))}}AddVisibleEdge(t){Ke.AddEdgeVV(_C(this.visibilityGraph,t.start),_C(this.visibilityGraph,t.End))}InitActiveDiagonals(){if(this.tangents.length===0)return;let t=this.tangents[0],i=t.start.point,n=t.End.point;for(let o of this.diagonals)Kn.RayIntersectDiagonal(i,n,o)&&(this.activeDiagonalComparer.PointOnTangentAndInsertedDiagonal=Dd.IntersectDiagonalWithRay(i,n,o),this.InsertActiveDiagonal(o));if(t.Diagonal.RbNode===this.activeDiagonalTree.treeMinimum()&&this.AddVisibleEdge(t),t.IsLow===!1){let o=t.Diagonal;this.RemoveDiagonalFromActiveNodes(o)}}RemoveDiagonalFromActiveNodes(t){let i=this.activeDiagonalTree.deleteSubTree(t.RbNode);i!=null&&i.item!=null&&(i.item.RbNode=i),t.LeftTangent.Diagonal=null,t.RightTangent.Diagonal=null}InsertActiveDiagonal(t){t.RbNode=this.activeDiagonalTree.insert(t),Kn.MarkDiagonalAsActiveInTangents(t)}static MarkDiagonalAsActiveInTangents(t){t.LeftTangent.Diagonal=t,t.RightTangent.Diagonal=t}static RayIntersectDiagonal(t,i,n){let o=n.Start,a=n.End;return m.getTriangleOrientation(t,o,a)===1&&m.getTriangleOrientation(t,i,o)!==1&&m.getTriangleOrientation(t,i,a)!==0}static TangentComparison(t,i){return Fo.CompareVectorsByAngleToXAxis(t.End.point.sub(t.start.point),i.End.point.sub(i.start.point))}*AllObstacles(){for(let t of this.addedPolygons)yield t;if(this.polygons)for(let t of this.polygons)yield t}OrganizeTangents(){for(let t of this.AllObstacles())t!==this.currentPolygon&&this.ProcessPolygonQ(t);this.tangents.sort(Kn.TangentComparison)}ProcessPolygonQ(t){let i=new xa(this.currentPolygon,t);this.useLeftPTangents?i.CalculateLeftTangents():i.CalculateRightTangents();let n=this.useLeftPTangents?i.leftPLeftQ:i.rightPLeftQ,o=new Bd(this.currentPolygon.pp(n[0]),t.pp(n[1]));o.IsLow=!0,o.SeparatingPolygons=!this.useLeftPTangents,n=this.useLeftPTangents?i.leftPRightQ:i.rightPRightQ;let a=new Bd(this.currentPolygon.pp(n[0]),t.pp(n[1]));a.IsLow=!1,a.SeparatingPolygons=this.useLeftPTangents,o.Comp=a,a.Comp=o,this.tangents.push(o),this.tangents.push(a),this.diagonals.push(new Md(o,a))}};function _C(s,e){return s.FindVertex(e.point)}var Mc=class{get Pivot(){return this.pivot}set Pivot(e){this.pivot=e}get IntersectionOfTheRayAndInsertedEdge(){return this.pointOnTheRay}set IntersectionOfTheRayAndInsertedEdge(e){this.pointOnTheRay=e}Compare(e,t){switch(m.getTriangleOrientation(this.IntersectionOfTheRayAndInsertedEdge,t.point,t.nextOnPolyline.point)){case 1:return-1;default:return 1}}IntersectionPointBelongsToTheInsertedEdge(e){let t=e.point.sub(this.IntersectionOfTheRayAndInsertedEdge),i=e.nextOnPolyline.point.sub(this.IntersectionOfTheRayAndInsertedEdge);return Math.abs(t.x*i.y-i.x*t.y)<R.distanceEpsilon}IntersectEdgeWithRayPPP(e,t,i){let n=mn.solve(t.x-e.x,-i.x,this.Pivot.x-e.x,t.y-e.y,-i.y,this.Pivot.y-e.y);if(!(-R.tolerance<=n.x&&n.x<=1+R.tolerance))throw new Error;if(!n)throw new Error;return this.Pivot.add(i.mul(n.y))}IntersectEdgeWithRay(e,t){return this.IntersectEdgeWithRayPPP(e.point,e.nextOnPolyline.point,t)}static constructorPP(e,t){let i=new Mc;return i.pivot=e,i.pointOnTheRay=t,i}};var NC=Ae(sr(),1),va=class{get Start(){return this.start}set Start(e){this.start=e}get End(){return this.end}set End(e){this.end=e}constructor(e,t){this.start=e,this.end=t}*Sides(){let e=this.start;for(;e!==this.end;){let t=e;yield t,e=t.nextOnPolyline}}MoveStartClockwise(){return this.Start!==this.End?(this.Start=this.Start.nextOnPolyline,!0):!1}toString(){return NC.String.Format("Stem({0},{1})",this.Start,this.End)}};var En=class{constructor(e,t,i,n){this.sideNodes=new Map;this.visibleBoundaries=new Map;this.sortedListOfPolypoints=new Array;this.holes=Array.from(e),this.visibilityGraph=t,this.q=i,this.qPolylinePoint=Kt.mkFromPoint(this.q),this.QVertex=this.visibilityGraph.AddVertexP(this.qPolylinePoint.point),this.visibilityKind=n;let o=new Fo(this.q);this.heapForSorting=new fa(o.IComparer.bind(o))}get QVertex(){return this.qV}set QVertex(e){this.qV=e}static CalculatePointVisibilityGraph(e,t,i,n){let o=t.FindVertex(i);if(o!=null)return o;let a=new En(e,t,i,n);return a.FillGraph(),a.QVertex}FillGraph(){this.ComputeHoleBoundariesPossiblyVisibleFromQ(),this.visibleBoundaries.size>0&&(this.SortSAndInitActiveSides(),this.Sweep())}SortSAndInitActiveSides(){this.InitHeapAndInsertActiveSides();for(let e=this.heapForSorting.GetMinimum();this.sortedListOfPolypoints.push(e.Start),e.MoveStartClockwise()?this.heapForSorting.ChangeMinimum(e):this.heapForSorting.Dequeue(),this.heapForSorting.Count!==0;e=this.heapForSorting.GetMinimum());}InitHeapAndInsertActiveSides(){for(let e of this.GetInitialVisibleBoundaryStemsAndInsertActiveSides())this.heapForSorting.Enqueue(e)}*GetInitialVisibleBoundaryStemsAndInsertActiveSides(){for(let[e,t]of this.visibleBoundaries){let i=!1;for(let n of t.Sides()){let o=n;if(o.point.y<this.q.y){if(n.nextOnPolyline.point.y>=this.q.y){let a=m.getTriangleOrientation(this.q,o.point,n.nextOnPolyline.point);if(a===1||a===2){i=!0,yield new va(t.Start,n),yield new va(n.nextOnPolyline,t.End),this.RegisterActiveSide(n);break}}}else{if(o.point.y>this.q.y)break;if(n.point.x>=this.q.x){i=!0,yield new va(n,t.End),n!==t.Start&&(yield new va(t.Start,e.prev(o))),this.RegisterActiveSide(n);break}}}i||(yield t)}}RegisterActiveSide(e){this.activeEdgeComparer.IntersectionOfTheRayAndInsertedEdge=this.activeEdgeComparer.IntersectEdgeWithRay(e,new m(1,0)),this.sideNodes.set(e,this.activeSidesTree.insert(e))}Sweep(){for(let e of this.sortedListOfPolypoints)this.SweepPolylinePoint(e)}SweepPolylinePoint(e){let t=En.GetIncomingSide(e),i=this.GetOutgoingSide(e);this.activeEdgeComparer.IntersectionOfTheRayAndInsertedEdge=e.point;let n;if(n=this.sideNodes.get(t)){if(n===this.activeSidesTree.treeMinimum()&&this.AddEdge(e),i!=null)n.item=i,this.sideNodes.set(i,n);else{let o=this.activeSidesTree.deleteSubTree(n);o!=null&&o.item!=null&&this.sideNodes.set(o.item,o)}this.sideNodes.delete(t)}else if(i!=null){let o;(o=this.sideNodes.get(i))||(o=this.activeSidesTree.insert(i),this.sideNodes.set(i,o),o===this.activeSidesTree.treeMinimum()&&this.AddEdge(e))}else throw new Error}AddEdge(e){(this.visibilityKind===0||this.visibilityKind===1&&En.LineTouchesPolygon(this.QVertex.point,e))&&this.visibilityGraph.AddEdgeF(this.QVertex.point,e.point,(t,i)=>new ar(t,i))}static LineTouchesPolygon(e,t){let i=t.polyline.prev(t).point,n=t.polyline.next(t).point,o=t.point;return m.signedDoubledTriangleArea(e,o,i)*m.signedDoubledTriangleArea(e,o,n)>=0}GetOutgoingSide(e){let t=this.visibleBoundaries.get(e.polyline);return e===t.End?null:e}static GetIncomingSide(e){return e.prevOnPolyline}ComputeHoleBoundariesPossiblyVisibleFromQ(){this.InitActiveEdgesAndActiveEdgesComparer();for(let e of this.holes)this.ComputeVisiblePartOfTheHole(e)}InitActiveEdgesAndActiveEdgesComparer(){this.activeEdgeComparer=new Mc,this.activeEdgeComparer.pivot=this.q,this.activeSidesTree=new dt(this.activeEdgeComparer.Compare.bind(this.activeEdgeComparer))}ComputeVisiblePartOfTheHole(e){let t,i=!0;for(t=e.startPoint;!this.HoleSideIsVisibleFromQ(e,t);t=e.next(t))i=!1;let n=e.next(t);if(i)for(;this.HoleSideIsVisibleFromQ(e,e.prev(t));)t=e.prev(t);for(;this.HoleSideIsVisibleFromQ(e,n);n=e.next(n));this.visibleBoundaries.set(e,new va(t,n))}HoleSideIsVisibleFromQ(e,t){return m.signedDoubledTriangleArea(this.q,t.point,e.next(t).point)>=-R.squareOfDistanceEpsilon}};var je=class extends Pe{constructor(){super(...arguments);this.IgnoreTightPadding=!0;this.activeRectangle=X.mkEmpty();this.activePolygons=new Array;this.alreadyAddedOrExcludedPolylines=new Set;this.UseEdgeLengthMultiplier=!1;this.UseInnerPolylingShortcutting=!0;this.UsePolylineEndShortcutting=!0;this.AllowedShootingStraightLines=!0;this.LookForRoundedVertices=!1}rerouteEdge(t){let i=t.smoothedPolyline?ne.mkFromPoints(t.smoothedPolyline):ne.mkFromPoints(t.getSmoothPolyPoints());this.pathOptimizer.run(i),t.curve=this.pathOptimizer.poly.toCurve()}static constructorANNN(t,i,n,o){return je.constructorANNNB(t,i,n,o,!1)}get Obstacles(){return this.obstacles_}set Obstacles(t){this.obstacles_=t}get EnteringAngleBound(){return this.enteringAngleBound_}set EnteringAngleBound(t){this.enteringAngleBound_=t}get SourceTightPolyline(){return this._sourceTightPolyline}set SourceTightPolyline(t){this._sourceTightPolyline=t}get TargetTightPolyline(){return this.targetTightPolyline}set TargetTightPolyline(t){this.targetTightPolyline=t}get TargetLoosePolyline(){return this.targetLoosePolyline}set TargetLoosePolyline(t){this.targetLoosePolyline=t}get VisibilityGraph(){return this.visibilityGraph}set VisibilityGraph(t){this.visibilityGraph=t}get SourcePort(){return this.sourcePort}set SourcePort(t){if(this.sourcePort=t,this.sourcePort!=null)if(this.SourceTightPolyline=je.GetFirstHitPolyline(this.sourcePort.Location,this.ObstacleCalculator.RootOfTightHierarchy),this.sourcePort instanceof or)this.alreadyAddedOrExcludedPolylines.add(this.SourceLoosePolyline),this.StartPointOfEdgeRouting=this.SourcePort.Location;else{let i=this.sourcePort;this.StartPointOfEdgeRouting=this.TakeBoundaryPortOutsideOfItsLoosePolyline(i.Curve,i.Parameter,this.SourceLoosePolyline)}}get TargetPort(){return this.targetPort}set TargetPort(t){this.targetPort=t}get LoosePadding(){return this.loosePadding}set LoosePadding(t){this.loosePadding=t,this.ObstacleCalculator!=null&&(this.ObstacleCalculator.LoosePadding=t)}get OffsetForPolylineRelaxing(){return this.TightPadding*.75}get StartPointOfEdgeRouting(){return this.startPointOfRouting_}set StartPointOfEdgeRouting(t){this.startPointOfRouting_=t}ExtendVisibilityGraphToLocation(t){this.VisibilityGraph==null&&(this.VisibilityGraph=new Ke);let i=null;if(!this.activeRectangle.contains(t)){this.activeRectangle.isEmpty?this.activeRectangle=X.mkPP(this.SourcePort.Location,t):this.activeRectangle.add(t),i=this.GetAddedPolygonesAndMaybeExtendActiveRectangle();for(let n of i)this.VisibilityGraph.AddHole(n.Polyline)}i==null||i.length===0?(this.targetVV!=null&&this.VisibilityGraph.RemoveVertex(this.targetVV),this.CalculateEdgeTargetVisibilityGraph(t)):(this.RemovePointVisibilityGraphs(),new Kn(i,this.activePolygons,this.VisibilityGraph).run(),Io(this.activePolygons,i),this.CalculateEdgeTargetVisibilityGraph(t),this.CalculateSourcePortVisibilityGraph())}RemovePointVisibilityGraphs(){this.targetVV!=null&&this.VisibilityGraph.RemoveVertex(this.targetVV),this.sourceVV!=null&&this.VisibilityGraph.RemoveVertex(this.sourceVV)}CalculateEdgeTargetVisibilityGraph(t){this.targetVV=En.CalculatePointVisibilityGraph(Array.from(this.GetActivePolylines()),this.VisibilityGraph,t,1)}CalculateSourcePortVisibilityGraph(){this.sourceVV=En.CalculatePointVisibilityGraph(Array.from(this.GetActivePolylines()),this.VisibilityGraph,this.StartPointOfEdgeRouting,1)}TakeBoundaryPortOutsideOfItsLoosePolyline(t,i,n){let o=t.value(i),a=t.leftDerivative(i).normalize().add(t.rightDerivative(i).normalize()).normalize();m.getTriangleOrientation(je.PointInsideOfConvexCurve(t),o,o.add(a))==1&&(a=a.mul(-1)),a=a.rotate(Math.PI/2);let l=n.boundingBox.diagonal,u=k.mkPP(o,o.add(a.mul(l))),c=I.intersectionOne(u,n,!1).x,h=a.mul(c.sub(o).length/2);for(;;){u=k.mkPP(o,c.add(h));let d=!1;for(let f of je.IntersectionsOfLineAndRectangleNodeOverPolylineLR(u,this.ObstacleCalculator.RootOfLooseHierarchy))if(f.seg1!==n){h=h.div(1.5),d=!0;break}if(!d)break}return u.end}static PointInsideOfConvexCurve(t){return t.value(0).add(t.value(1.5)).div(2)}*GetActivePolylines(){for(let t of this.activePolygons)yield t.Polyline}GetAddedPolygonesAndMaybeExtendActiveRectangle(){let t=this.activeRectangle,i=new Array,n;do{n=!1;for(let o of this.ObstacleCalculator.RootOfLooseHierarchy.GetNodeItemsIntersectingRectangle(this.activeRectangle))this.alreadyAddedOrExcludedPolylines.has(o)||(t.addRec(o.boundingBox),i.push(new Jt(o)),this.alreadyAddedOrExcludedPolylines.add(o),n=!0);n&&(this.activeRectangle=t)}while(n);return i}PolylineSegmentIntersectsTightHierarchy(t,i){return this.PolylineIntersectsPolyRectangleNodeOfTightHierarchyPPR(t,i,this.ObstacleCalculator.RootOfTightHierarchy)}PolylineIntersectsPolyRectangleNodeOfTightHierarchyPPR(t,i,n){return this.PolylineIntersectsPolyRectangleNodeOfTightHierarchy(k.mkPP(t,i),n)}PolylineIntersectsPolyRectangleNodeOfTightHierarchy(t,i){if(!t.boundingBox.intersects(i.irect))return!1;if(i.UserData!=null){for(let n of I.getAllIntersections(t,i.UserData,!1))if(n.seg1!==this.SourceTightPolyline&&n.seg1!==this.TargetTightPolyline||(n.seg1===this.SourceTightPolyline&&this.SourcePort)instanceof Pr||(n.seg1===this.TargetTightPolyline&&this.TargetPort)instanceof Pr)return!0;return!1}return this.PolylineIntersectsPolyRectangleNodeOfTightHierarchy(t,i.Left)||this.PolylineIntersectsPolyRectangleNodeOfTightHierarchy(t,i.Right)}static IntersectionsOfLineAndRectangleNodeOverPolylineLR(t,i){let n=new Array;return je.IntersectionsOfLineAndRectangleNodeOverPolyline(t,i,n),n}static IntersectionsOfLineAndRectangleNodeOverPolyline(t,i,n){if(i!=null&&!!t.boundingBox.intersects(i.irect)){if(i.UserData!=null){Io(n,I.getAllIntersections(t,i.UserData,!0));return}je.IntersectionsOfLineAndRectangleNodeOverPolyline(t,i.Left,n),je.IntersectionsOfLineAndRectangleNodeOverPolyline(t,i.Right,n)}}LineCanBeAcceptedForRouting(t){let i=this.SourcePort instanceof or,n=this.TargetPort instanceof or;if(!i&&!this.targetIsInsideOfSourceTightPolyline&&!this.InsideOfTheAllowedConeOfBoundaryPort(t.end,this.SourcePort)||!n&&this.TargetPort!=null&&!this.sourceIsInsideOfTargetTightPolyline&&!this.InsideOfTheAllowedConeOfBoundaryPort(t.start,this.TargetPort))return!1;let o=je.IntersectionsOfLineAndRectangleNodeOverPolylineLR(t,this.ObstacleCalculator.RootOfTightHierarchy);for(let a of o)if(a.seg1!==this.SourceTightPolyline&&a.seg1!==this.targetTightPolyline)return!1;return!0}InsideOfTheAllowedConeOfBoundaryPort(t,i){let n=i.Curve,o=$t.CurveIsClockwise(n,je.PointInsideOfConvexCurve(n)),a=i.Location,l=this.GetPointOnTheRightBoundaryPortConeSide(a,n,o,i.Parameter),u=this.GetPointOnTheLeftBoundaryPortConeSide(a,n,o,i.Parameter);return m.getTriangleOrientation(a,l,t)!==0&&m.getTriangleOrientation(a,t,u)!==0}GetPointOnTheRightBoundaryPortConeSide(t,i,n,o){let a=n?i.rightDerivative(o):i.leftDerivative(o).neg();return t.add(a.rotate(this.EnteringAngleBound))}GetPointOnTheLeftBoundaryPortConeSide(t,i,n,o){let a=n?i.leftDerivative(o).neg():i.rightDerivative(o);return t.add(a.rotate(-this.EnteringAngleBound))}SmoothenCorners(t){let i=t.headSite,n={b:null,c:null};for(;n=I.findCorner(i);)i=this.SmoothOneCorner(i,n.c,n.b)}SmoothOneCorner(t,i,n){let l=.5,u,c,h;t.prev==null?(h=2,c=1):i.next==null?(h=1,c=2):h=c=1;do u=I.createBezierSeg(l*h,l*c,t,n,i),n.previouisBezierCoefficient=l*h,n.nextBezierCoefficient=l*c,l/=1.5;while(d()>this.loosePadding&&l>.01);return l*=1.5,l<.5&&l>.01&&(l=.5*(l+l*1.5),u=I.createBezierSeg(l*h,l*c,t,n,i),d()>this.loosePadding&&(n.previouisBezierCoefficient=l*h,n.nextBezierCoefficient=l*c)),n;function d(){let f=u.closestParameter(n.point);return n.point.sub(u.value(f)).length}}TryToRemoveInflectionsAndCollinearSegments(t){let i=!0,n={s:null};for(;i;)for(i=!1,n.s=t.headSite;n.s!=null&&n.s.next!=null;n.s=n.s.next)n.s.turn*n.s.next.turn<0&&(i=this.TryToRemoveInflectionEdge(n)||i)}TryToRemoveInflectionEdge(t){if(!this.ObstacleCalculator.ObstaclesIntersectLine(t.s.prev.point,t.s.next.point)){let i=t.s.prev,n=t.s.next;return i.next=n,n.prev=i,t.s=i,!0}if(!this.ObstacleCalculator.ObstaclesIntersectLine(t.s.prev.point,t.s.next.next.point)){let i=t.s.prev,n=t.s.next.next;return i.next=n,n.prev=i,t.s=i,!0}if(!this.ObstacleCalculator.ObstaclesIntersectLine(t.s.point,t.s.next.next.point)){let i=t.s.next.next;return t.s.next=i,i.prev=t.s,!0}return!1}GetShortestPolyline(t,i){this.CleanTheGraphForShortestPath();let o=new Yl(this.visibilityGraph,t,i).GetPath(this.UseEdgeLengthMultiplier);if(o==null)return null;let a=ne.mkFromPoints(Array.from(o).map(l=>l.point)).RemoveCollinearVertices();return this.pathOptimizer&&(this.pathOptimizer.run(a),a=this.pathOptimizer.poly),a}CleanTheGraphForShortestPath(){this.visibilityGraph.ClearPrevEdgesTable()}get OverlapsDetected(){return this.ObstacleCalculator.OverlapsDetected}get TightHierarchy(){return this.ObstacleCalculator.RootOfTightHierarchy}set TightHierarchy(t){this.ObstacleCalculator.RootOfTightHierarchy=t}get LooseHierarchy(){return this.ObstacleCalculator.RootOfLooseHierarchy}set LooseHierarchy(t){this.ObstacleCalculator.RootOfLooseHierarchy=t}CalculateObstacles(){this.ObstacleCalculator=new $t(this.Obstacles,this.TightPadding,this.LoosePadding,this.IgnoreTightPadding),this.ObstacleCalculator.Calculate()}static constructorANNNB(t,i,n,o,a){let l=new je(null);return l.IgnoreTightPadding=a,l.EnteringAngleBound=80*(Math.PI/180),l.TightPadding=i,l.LoosePadding=n,o>0?(Ce.assert(o>Math.PI/180),Ce.assert(o<=90*(Math.PI/180)),l.UseSpanner=!0,l.ExpectedProgressSteps=Bo.GetTotalSteps(o)):l.ExpectedProgressSteps=t.length,l.ConeSpannerAngle=o,l.Obstacles=t,l.CalculateObstacles(),l}RouteEdgeToLocation(t){this.TargetPort=new or(null,t),this.TargetTightPolyline=null,this.TargetLoosePolyline=null;let i=new Ye(null),n=k.mkPP(this.SourcePort.Location,t);if(this.LineCanBeAcceptedForRouting(n)){this._polyline=new ne,this._polyline.addPoint(n.start),this._polyline.addPoint(n.end);let o=ot.mkFromPoints(this._polyline);return i.curve=o.createCurve(),i}return this.SourcePort instanceof Pr&&(n=k.mkPP(this.StartPointOfEdgeRouting,t),je.IntersectionsOfLineAndRectangleNodeOverPolylineLR(n,this.ObstacleCalculator.RootOfTightHierarchy).length==0)?(this._polyline=new ne,this._polyline.addPoint(this.SourcePort.Location),this._polyline.addPoint(n.start),this._polyline.addPoint(n.end),i.curve=ot.mkFromPoints(this._polyline).createCurve(),i):(this.ExtendVisibilityGraphToLocation(t),this._polyline=this.GetShortestPolyline(this.sourceVV,this.targetVV),this.SourcePort instanceof Pr&&this._polyline.PrependPoint(this.SourcePort.Location),i.curve=ot.mkFromPoints(this._polyline).createCurve(),i)}RouteEdgeToPort(t,i,n,o){return this.ObstacleCalculator.IsEmpty()?this.sourcePort!=null&&this.targetPort!=null?(o.smoothedPolyline=this.SmoothedPolylineFromTwoPoints(this.sourcePort.Location,this.targetPort.Location),k.mkPP(this.sourcePort.Location,this.targetPort.Location)):null:(this.TargetPort=t,this.TargetTightPolyline=je.GetFirstHitPolyline(t.Location,this.ObstacleCalculator.RootOfTightHierarchy),t instanceof Pr?this.RouteEdgeToBoundaryPort(i,n,o):this.RouteEdgeToFloatingPortOfNode(i,n,o))}SmoothedPolylineFromTwoPoints(t,i){return this._polyline=new ne,this._polyline.addPoint(t),this._polyline.addPoint(i),ot.mkFromPoints(this._polyline)}RouteEdgeToFloatingPortOfNode(t,i,n){return this.sourcePort instanceof or?this.RouteFromFloatingPortToFloatingPort(t,i,n):this.RouteFromBoundaryPortToFloatingPort(t,i,n)}RouteFromBoundaryPortToFloatingPort(t,i,n){let o=this.SourcePort.Location,a=this.targetPort.Location,l=k.mkPP(o,a);if(this.LineCanBeAcceptedForRouting(l))return n.smoothedPolyline=this.SmoothedPolylineFromTwoPoints(l.start,l.end),l;if(!this.targetIsInsideOfSourceTightPolyline){let c=this.TakeBoundaryPortOutsideOfItsLoosePolyline(this.SourcePort.Curve,this.SourcePort.Parameter,this.SourceLoosePolyline);if(l=k.mkPP(c,a),this.LineAvoidsTightHierarchyLP(l,t))return n.smoothedPolyline=this.SmoothedPolylineFromTwoPoints(l.start,l.end),l}this.ExtendVisibilityGraphToLocationOfTargetFloatingPort(t),this._polyline=this.GetShortestPolyline(this.sourceVV,this.targetVV);let u=this.SourceTightPolyline;return this.targetIsInsideOfSourceTightPolyline||(this.SourceTightPolyline=null),this.SourceTightPolyline=u,this._polyline.PrependPoint(o),this.SmoothCornersAndReturnCurve(i,n)}SmoothCornersAndReturnCurve(t,i){return i.smoothedPolyline=ot.mkFromPoints(this._polyline),t&&this.SmoothenCorners(i.smoothedPolyline),i.smoothedPolyline.createCurve()}RouteFromFloatingPortToFloatingPort(t,i,n){return this.ExtendVisibilityGraphToLocationOfTargetFloatingPort(t),this._polyline=this.GetShortestPolyline(this.sourceVV,this.targetVV),this._polyline==null?null:(n.smoothedPolyline=ot.mkFromPoints(this._polyline),this.SmoothCornersAndReturnCurve(i,n))}TryShortcutPolyPoint(t){return this.LineAvoidsTightHierarchyLPP(k.mkPP(t.point,t.next.next.point),this.SourceTightPolyline,this.targetTightPolyline)?(t.next=t.next.next,t.next.prev=t,!0):!1}ExtendVisibilityGraphToLocationOfTargetFloatingPort(t){this.VisibilityGraph==null&&(this.VisibilityGraph=new Ke);let i=null,n=this.targetPort.Location;if(!this.activeRectangle.contains(n)){this.activeRectangle.isEmpty?this.activeRectangle=X.mkPP(this.SourcePort.Location,n):this.activeRectangle.add(n),i=this.GetAddedPolygonesAndMaybeExtendActiveRectangle();for(let o of i)this.VisibilityGraph.AddHole(o.Polyline)}i==null?(this.targetVV!=null&&this.VisibilityGraph.RemoveVertex(this.targetVV),this.CalculateEdgeTargetVisibilityGraphForFloatingPort(n,t),this.sourceVV==null&&this.CalculateSourcePortVisibilityGraph()):(this.RemovePointVisibilityGraphs(),new Kn(i,this.activePolygons,this.VisibilityGraph).run(),Io(this.activePolygons,i),this.CalculateEdgeTargetVisibilityGraphForFloatingPort(n,t),this.CalculateSourcePortVisibilityGraph())}CalculateEdgeTargetVisibilityGraphForFloatingPort(t,i){this.UseSpanner?this.targetVV=this.AddTransientVisibilityEdgesForPort(t,i):this.targetVV=En.CalculatePointVisibilityGraph(this.GetActivePolylinesWithException(i),this.VisibilityGraph,t,1)}AddTransientVisibilityEdgesForPort(t,i){let n=this.GetVertex(t);if(n!=null)return n;if(n=this.visibilityGraph.AddVertexP(t),i!=null)for(let o of i)this.visibilityGraph.AddEdgeF(t,o,(a,l)=>new ar(a,l));else n=En.CalculatePointVisibilityGraph(this.GetActivePolylines(),this.VisibilityGraph,t,1);return n}GetVertex(t){let i=this.visibilityGraph.FindVertex(t);return i==null&&this.LookForRoundedVertices&&(i=this.visibilityGraph.FindVertex(m.RoundPoint(t))),i}*GetActivePolylinesWithException(t){for(let i of this.activePolygons)i.Polyline!==t&&(yield i.Polyline)}RouteEdgeToBoundaryPort(t,i,n){return this.TargetLoosePolyline=t,this.sourcePort instanceof or?this.RouteFromFloatingPortToBoundaryPort(i,n):this.RouteFromBoundaryPortToBoundaryPort(i,n)}RouteFromBoundaryPortToBoundaryPort(t,i){let n=this.SourcePort.Location,o,a=this.targetPort.Location,l=k.mkPP(n,a);if(this.LineCanBeAcceptedForRouting(l))this._polyline=new ne,this._polyline.addPoint(l.start),this._polyline.addPoint(l.end),i.smoothedPolyline=this.SmoothedPolylineFromTwoPoints(l.start,l.end),o=ot.mkFromPoints(this._polyline).createCurve();else{let u=this.TakeBoundaryPortOutsideOfItsLoosePolyline(this.targetPort.Curve,this.targetPort.Parameter,this.TargetLoosePolyline);if(l=k.mkPP(n,u),this.InsideOfTheAllowedConeOfBoundaryPort(u,this.SourcePort)&&this.LineAvoidsTightHierarchyLP(l,this._sourceTightPolyline))this._polyline=new ne,this._polyline.addPoint(l.start),this._polyline.addPoint(l.end),this._polyline.addPoint(a),o=this.SmoothCornersAndReturnCurve(t,i);else if(l=k.mkPP(this.StartPointOfEdgeRouting,a),this.InsideOfTheAllowedConeOfBoundaryPort(this.StartPointOfEdgeRouting,this.TargetPort)&&this.LineAvoidsTightHierarchy(l))this._polyline=new ne,this._polyline.addPoint(n),this._polyline.addPoint(l.start),this._polyline.addPoint(l.end),o=this.SmoothCornersAndReturnCurve(t,i);else{let c;if(c=k.IntersectPPPP(n,this.StartPointOfEdgeRouting,a,u))this._polyline=new ne,this._polyline.addPoint(n),this._polyline.addPoint(c),this._polyline.addPoint(a),o=this.SmoothCornersAndReturnCurve(t,i);else if(m.closeDistEps(this.StartPointOfEdgeRouting,u))this._polyline=new ne,this._polyline.addPoint(n),this._polyline.addPoint(u),this._polyline.addPoint(a),o=this.SmoothCornersAndReturnCurve(t,i);else if(this.LineAvoidsTightHierarchy(k.mkPP(this.StartPointOfEdgeRouting,u)))this._polyline=new ne,this._polyline.addPoint(n),this._polyline.addPoint(this.StartPointOfEdgeRouting),this._polyline.addPoint(u),this._polyline.addPoint(a),o=this.SmoothCornersAndReturnCurve(t,i);else{this.ExtendVisibilityGraphToTargetBoundaryPort(u),this._polyline=this.GetShortestPolyline(this.sourceVV,this.targetVV);let h={tmpTargetTight:null},d=this.HideSourceTargetTightsIfNeeded(h);this.RecoverSourceTargetTights(d,h.tmpTargetTight),this._polyline.PrependPoint(n),this._polyline.addPoint(a),o=this.SmoothCornersAndReturnCurve(t,i)}}}return o}RecoverSourceTargetTights(t,i){this.SourceTightPolyline=t,this.TargetTightPolyline=i}HideSourceTargetTightsIfNeeded(t){let i=this.SourceTightPolyline;return t.tmpTargetTight=this.TargetTightPolyline,this.TargetTightPolyline=null,this.SourceTightPolyline=null,i}LineAvoidsTightHierarchy(t){return je.IntersectionsOfLineAndRectangleNodeOverPolylineLR(t,this.ObstacleCalculator.RootOfTightHierarchy).length===0}RouteFromFloatingPortToBoundaryPort(t,i){let n=this.targetPort.Location,o;if(this.InsideOfTheAllowedConeOfBoundaryPort(this.sourcePort.Location,this.targetPort)&&(o=k.mkPP(this.SourcePort.Location,n),this.LineCanBeAcceptedForRouting(o)))return i.smoothedPolyline=this.SmoothedPolylineFromTwoPoints(o.start,o.end),o;let a=this.TakeBoundaryPortOutsideOfItsLoosePolyline(this.TargetPort.Curve,this.TargetPort.Parameter,this.TargetLoosePolyline);if(o=k.mkPP(this.SourcePort.Location,a),this.LineAvoidsTightHierarchyLP(o,this._sourceTightPolyline))return this._polyline=ne.mkFromPoints([o.start,o.end,n]),i.smoothedPolyline=ot.mkFromPoints(this._polyline),i.smoothedPolyline.createCurve();this.ExtendVisibilityGraphToTargetBoundaryPort(a),this._polyline=this.GetShortestPolyline(this.sourceVV,this.targetVV),this._polyline.addPoint(n);let l={smoothedPolyline:null};return this.SmoothCornersAndReturnCurve(t,l)}LineAvoidsTightHierarchyLP(t,i){let n=!0;for(let o of je.IntersectionsOfLineAndRectangleNodeOverPolylineLR(t,this.ObstacleCalculator.RootOfTightHierarchy))if(o.seg1!==i){n=!1;break}return n}LineAvoidsTightHierarchyLPP(t,i,n){let o=!0;for(let a of je.IntersectionsOfLineAndRectangleNodeOverPolylineLR(t,this.ObstacleCalculator.RootOfTightHierarchy))if(!(a.seg1===i||a.seg1===n)){o=!1;break}return o}LineAvoidsTightHierarchyPPPP(t,i,n,o){return this.LineAvoidsTightHierarchyLPP(k.mkPP(t,i),n,o)}ExtendVisibilityGraphToTargetBoundaryPort(t){let i=null;if(this.VisibilityGraph==null&&(this.VisibilityGraph=new Ke),!this.activeRectangle.contains(t)||!this.activeRectangle.containsRect(this.TargetLoosePolyline.boundingBox)){this.activeRectangle.isEmpty?(this.activeRectangle=this.TargetLoosePolyline.boundingBox.clone(),this.activeRectangle.add(this.SourcePort.Location),this.activeRectangle.add(this.StartPointOfEdgeRouting),this.activeRectangle.add(t)):(this.activeRectangle.add(t),this.activeRectangle.addRec(this.TargetLoosePolyline.boundingBox)),i=this.GetAddedPolygonesAndMaybeExtendActiveRectangle();for(let n of i)this.VisibilityGraph.AddHole(n.Polyline)}i==null?(this.targetVV!=null&&this.VisibilityGraph.RemoveVertex(this.targetVV),this.CalculateEdgeTargetVisibilityGraph(t)):(this.RemovePointVisibilityGraphs(),new Kn(i,this.activePolygons,this.VisibilityGraph).run(),Io(this.activePolygons,i),this.CalculateEdgeTargetVisibilityGraph(t),this.CalculateSourcePortVisibilityGraph())}GetHitLoosePolyline(t){return this.ObstacleCalculator.IsEmpty()||this.ObstacleCalculator.RootOfLooseHierarchy==null?null:je.GetFirstHitPolyline(t,this.ObstacleCalculator.RootOfLooseHierarchy)}static GetFirstHitPolyline(t,i){let n=je.GetFirstHitRectangleNode(t,i);return n?n.UserData:null}static GetFirstHitRectangleNode(t,i){return i==null?null:i.FirstHitNodeWithPredicate(t,(n,o)=>I.PointRelativeToCurveLocation(n,o)!==0?1:0)}Clean(){this.TargetPort=null,this.SourcePort=null,this.SourceTightPolyline=null,this.SourceLoosePolyline=null,this.TargetLoosePolyline=null,this.targetTightPolyline=null,this.VisibilityGraph=null,this.targetVV=null,this.sourceVV=null,this.activePolygons=[],this.alreadyAddedOrExcludedPolylines.clear(),this.activeRectangle.setToEmpty()}SetSourcePortAndSourceLoosePolyline(t,i){this.SourceLoosePolyline=i,this.sourcePort=t,this.sourcePort!=null&&(this.SourceTightPolyline=je.GetFirstHitPolyline(this.sourcePort.Location,this.ObstacleCalculator.RootOfTightHierarchy),this.sourcePort instanceof or?(this.alreadyAddedOrExcludedPolylines.add(this.SourceLoosePolyline),this.StartPointOfEdgeRouting=this.SourcePort.Location):this.StartPointOfEdgeRouting=this.TakeBoundaryPortOutsideOfItsLoosePolyline(this.SourcePort.Curve,this.sourcePort.Parameter,this.SourceLoosePolyline))}run(){this.CalculateWholeTangentVisibilityGraph()}CalculateWholeTangentVisibilityGraph(){this.VisibilityGraph=new Ke,this.CalculateWholeVisibilityGraphOnExistingGraph()}CalculateWholeVisibilityGraphOnExistingGraph(){this.activePolygons=Array.from(this.AllPolygons());for(let i of this.ObstacleCalculator.LooseObstacles)this.VisibilityGraph.AddHole(i);let t;this.UseSpanner?t=new Bo(this.ObstacleCalculator.LooseObstacles,this.VisibilityGraph):t=new Kn(new Array,this.activePolygons,this.visibilityGraph),t.run()}RouteSplineFromPortToPortWhenTheWholeGraphIsReady(t,i,n,o){let a=t instanceof or&&i instanceof Pr||t instanceof Mt;if(a){let u=t;t=i,i=u}this.sourcePort=t,this.targetPort=i,this.FigureOutSourceTargetPolylinesAndActiveRectangle();let l=this.GetEdgeGeomByRouting(n,o);return l==null?null:(this.targetVV=null,this.sourceVV=null,a&&(l=l.reverse()),l)}GetEdgeGeomByRouting(t,i){this.sourceIsInsideOfTargetTightPolyline=this.TargetTightPolyline==null||I.PointRelativeToCurveLocation(this.sourcePort.Location,this.TargetTightPolyline)===2;let n;if(this.sourcePort instanceof Pr){let o=this.sourcePort;this.StartPointOfEdgeRouting=this.targetIsInsideOfSourceTightPolyline?o.Location:this.TakeBoundaryPortOutsideOfItsLoosePolyline(o.Curve,o.Parameter,this.SourceLoosePolyline),this.CalculateSourcePortVisibilityGraph();let a={smoothedPolyline:null};this.targetPort instanceof Pr?n=this.RouteFromBoundaryPortToBoundaryPort(t,a):n=this.RouteFromBoundaryPortToFloatingPort(this.targetLoosePolyline,t,a)}else this.targetPort instanceof or?(this.ExtendVisibilityGraphFromFloatingSourcePort(),n=this.RouteFromFloatingPortToFloatingPort(this.targetLoosePolyline,t,i)):n=this.RouteFromFloatingPortToAnywherePort(this.targetPort.LoosePolyline,t,i,this.targetPort);return n}RouteFromFloatingPortToAnywherePort(t,i,n,o){return o.Curve.boundingBox.contains(this.sourcePort.Location)?(this.sourceVV=this.GetVertex(this.sourcePort.Location),this._polyline=this.GetShortestPolylineToMulitpleTargets(this.sourceVV,Array.from(this.Targets(t))),this._polyline==null?null:(this.FixLastPolylinePointForAnywherePort(o),o.HookSize>0&&this.BuildHook(o),this.SmoothCornersAndReturnCurve(i,n))):(n.smoothedPolyline=null,null)}BuildHook(t){let i=t.Curve,n=pe.mkFullEllipseNNP(t.HookSize,t.HookSize,this._polyline.end),o=I.getAllIntersections(i,n,!0);m.getTriangleOrientation(o[0].x,this._polyline.end,this._polyline.endPoint.prev.point)==1&&o.reverse();let a=this._polyline.end.sub(this._polyline.endPoint.prev.point).normalize(),l=i.derivative(o[0].par0).normalize(),u=l.dot(a);if(Math.abs(u)<.2)this.ExtendPolyline(l,o[0],a,t);else{let c=i.derivative(o[1].par0).normalize();c.dot(a)<u?this.ExtendPolyline(c,o[1],a,t):this.ExtendPolyline(l,o[0],a,t)}}ExtendPolyline(t,i,n,o){let a=t.rotate(Math.PI/2);a.dot(n)<0&&(a=a.neg());let l=i.x.add(a.mul(o.HookSize)),u;!(u=m.lineLineIntersection(l,l.add(t),this._polyline.end,this._polyline.end.add(n)))||(this._polyline.addPoint(u),this._polyline.addPoint(l),this._polyline.addPoint(i.x))}FixLastPolylinePointForAnywherePort(t){for(;;){let i=this.GetLastPointInsideOfCurveOnPolyline(t.Curve);i.next.next=null,this._polyline.endPoint=i.next;let n=i.next.point.sub(i.point);n=n.normalize().mul(t.Curve.boundingBox.diagonal);let o=n.rotate(t.AdjustmentAngle*-1),a=n.rotate(t.AdjustmentAngle),l=I.intersectionOne(t.Curve,k.mkPP(i.point,i.point.add(o)),!0),u=I.intersectionOne(t.Curve,k.mkPP(i.point,i.point.add(a)),!0);if(l==null||u==null)return;let c=je.GetTrimmedCurveForHookingUpAnywhere(t.Curve,i,l,u),h=c.value(c.closestParameter(i.point));if(!this.LineAvoidsTightHierarchyLPP(k.mkPP(i.point,h),this.SourceTightPolyline,null)){let d=I.intersectionOne(t.Curve,k.mkPP(i.point,i.next.point),!1);if(d==null)return;this._polyline.endPoint.point=d.x;break}if(this._polyline.endPoint.point=h,i.prev==null||!this.TryShortcutPolyPoint(i.prev))break}}static GetTrimmedCurveForHookingUpAnywhere(t,i,n,o){let a=m.getTriangleOrientation(o.x,n.x,i.point)===0,l=n.par0,u=o.par0,c,h,d;return a?l<u?t.trim(l,u):(h=t.trim(l,t.parEnd),c=t.trim(t.parStart,u),d=new I,d.addSegs([h,c])):u<l?t.trim(u,l):(h=t.trim(u,t.parEnd),c=t.trim(t.parStart,l),d=new I,d.addSegs([h,c]))}GetLastPointInsideOfCurveOnPolyline(t){for(let i=this._polyline.endPoint.prev;i!=null;i=i.prev)if(i.prev==null||I.PointRelativeToCurveLocation(i.point,t)===2)return i;throw new Error}GetShortestPolylineToMulitpleTargets(t,i){this.CleanTheGraphForShortestPath();let o=new xs(t,i,this.VisibilityGraph).GetPath();if(o==null)return null;let a=new ne;for(let l of o)a.addPoint(l.point);return a.RemoveCollinearVertices()}Targets(t){return Array.from(t).map(i=>this.visibilityGraph.FindVertex(i))}ExtendVisibilityGraphFromFloatingSourcePort(){let t=this.sourcePort;this.StartPointOfEdgeRouting=t.Location,this.UseSpanner?this.sourceVV=this.AddTransientVisibilityEdgesForPort(this.sourcePort.Location,this.SourceLoosePolyline):this.sourceVV=En.CalculatePointVisibilityGraph(Array.from(this.GetActivePolylines()).filter(i=>i!==this.SourceLoosePolyline),this.VisibilityGraph,this.StartPointOfEdgeRouting,1)}FigureOutSourceTargetPolylinesAndActiveRectangle(){let t=this.sourcePort.Curve.value(this.sourcePort.Curve.parStart);this._sourceTightPolyline=je.GetFirstHitPolyline(t,this.ObstacleCalculator.RootOfTightHierarchy),this.SourceLoosePolyline=je.GetFirstHitPolyline(t,this.ObstacleCalculator.RootOfLooseHierarchy),t=this.targetPort.Curve.value(this.targetPort.Curve.parStart),this.targetTightPolyline=je.GetFirstHitPolyline(t,this.ObstacleCalculator.RootOfTightHierarchy),this.targetLoosePolyline=je.GetFirstHitPolyline(t,this.ObstacleCalculator.RootOfLooseHierarchy),this.activeRectangle=X.mkPP(new m(Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY),new m(Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY))}*AllPolygons(){for(let t of this.ObstacleCalculator.LooseObstacles)yield new Jt(t)}GetVisibilityGraph(){return this.VisibilityGraph}AddActivePolygons(t){Io(this.activePolygons,t)}ClearActivePolygons(){this.activePolygons=[]}};var _A=Ae(zn(),1);var qi=class{constructor(){this.length=qi.defaultArrowheadLength;this.width=0;this.length=qi.defaultArrowheadLength}toJSON(){let e="{";return this.tipPosition&&(e+='"tipPosition": '+this.tipPosition.toJSON()),e+="}",e}clone(){let e=new qi;return e.length=this.length,e.width=this.width,e.tipPosition=this.tipPosition,e}static calculateArrowheads(e){if(e.sourceArrowhead==null&&e.targetArrowhead==null)return!0;let t=qi.findTrimStartForArrowheadAtSource(e);if(t==null)return!1;let i=qi.findTrimEndForArrowheadAtTarget(e);if(i==null||t>i-R.intersectionEpsilon||I.closeIntersectionPoints(e.curve.value(t),e.curve.value(i)))return!1;let n=e.curve.trim(t,i);return n==null?!1:(e.sourceArrowhead!=null&&(e.sourceArrowhead.tipPosition=e.curve.start),e.targetArrowhead!=null&&(e.targetArrowhead.tipPosition=e.curve.end),e.curve=n,!0)}static getIntersectionsWithArrowheadCircle(e,t,i){let n=pe.mkFullEllipseNNP(t,t,i);return I.getAllIntersections(n,e,!0)}static findTrimEndForArrowheadAtTarget(e){let t=R.distanceEpsilon*R.distanceEpsilon,i=e.curve.parEnd;if(e.targetArrowhead==null||e.targetArrowhead.length<=R.distanceEpsilon)return i;let n=e.curve,o=e.targetArrowhead.length,a,l,u=10;do{if(u--,u===0)return;l=qi.getIntersectionsWithArrowheadCircle(n,o,n.end),i=l.length!==0?Math.max(...l.map(c=>c.par1)):n.parEnd,a=e.curve.value(i),o/=2}while(a.sub(n.start).lengthSquared<t||l.length===0);return i}static findTrimStartForArrowheadAtSource(e){if(e.sourceArrowhead==null||e.sourceArrowhead.length<=R.distanceEpsilon)return e.curve.parStart;let t=R.distanceEpsilon*R.distanceEpsilon,i=e.sourceArrowhead.length,n,o=e.curve,a,l=10,u;for(;--l>0;){if(a=qi.getIntersectionsWithArrowheadCircle(o,i,o.start),a.length===0)return o.parStart;if(u=Math.min(...a.map(c=>c.par1)),n=a.filter(c=>c.par1===u)[0].x,n.sub(o.end).lengthSquared>=t)return u;i/=2}}static trimSplineAndCalculateArrowheads(e,t,i){return qi.trimSplineAndCalculateArrowheadsII(e,e.source.boundaryCurve,e.target.boundaryCurve,t,i)}static trimSplineAndCalculateArrowheadsII(e,t,i,n,o){if(e.curve=I.trimEdgeSplineWithNodeBoundaries(t,i,n,o),e.curve==null)return!1;if((e.sourceArrowhead==null||e.sourceArrowhead.length<R.distanceEpsilon)&&(e.targetArrowhead==null||e.targetArrowhead.length<R.distanceEpsilon))return!0;let a=!1,l=e.sourceArrowhead!=null?e.sourceArrowhead.length:0,u=e.targetArrowhead!=null?e.targetArrowhead.length:0,c=e.curve.end.sub(e.curve.start).length;e.sourceArrowhead!=null&&(e.sourceArrowhead.length=Math.min(c,l)),e.targetArrowhead!=null&&(e.targetArrowhead.length=Math.min(c,u));let h=10;for(;(e.sourceArrowhead!=null&&e.sourceArrowhead.length>R.intersectionEpsilon||e.targetArrowhead!=null&&e.targetArrowhead.length>R.intersectionEpsilon)&&!a&&(a=qi.calculateArrowheads(e),a||(e.sourceArrowhead!=null&&(e.sourceArrowhead.length*=.5),e.targetArrowhead!=null&&(e.targetArrowhead.length*=.5)),h--,h!==0););return a||(e.sourceArrowhead!=null&&(e.sourceArrowhead.tipPosition=n.start),e.targetArrowhead!=null&&(e.targetArrowhead.tipPosition=n.end)),e.sourceArrowhead!=null&&(e.sourceArrowhead.length=l),e.targetArrowhead!=null&&(e.targetArrowhead.length=u),a}static createBigEnoughSpline(e){let t=e.source.center,i=e.target.center,n=i.sub(t),o=n.length,a;o<.001?(a=new m(1,0),i=t.add(a.rotate(Math.PI/2))):a=n.rotate(Math.PI/2);let l=1;e.sourceArrowhead!=null&&(l+=e.sourceArrowhead.length),e.targetArrowhead!=null&&(l+=e.targetArrowhead.length),a=a.normalize().mul(1.5*l);for(let u=1;u<1e4;u=u*2){let c=I.createBezierSegN(t,i,a,u);if(qi.trimSplineAndCalculateArrowheadsII(e,e.source.boundaryCurve,e.target.boundaryCurve,c,!1))return}qi.createEdgeCurveWithNoTrimming(e,t,i)}static createEdgeCurveWithNoTrimming(e,t,i){let n=i.sub(t).normalize(),o=t,a=i,l=e.targetArrowhead;l!=null&&(l.tipPosition=i,a=i.sub(n.mul(l.length)));let u=e.sourceArrowhead;u!=null&&(u.tipPosition=t,o=t.add(n.mul(u.length))),e.curve=k.mkPP(o,a)}},ut=qi;ut.defaultArrowheadLength=5;var Zn=class{constructor(){this.m=new Map}clear(){this.m.clear()}get size(){return this.m.size}set(e,t){this.m.set(dm(e),t)}delete(e){this.m.delete(dm(e))}has(e){return this.m.has(dm(e))}getPP(e,t){return this.get(new xt(e,t))}get(e){return this.m.get(dm(e))}*keys(){for(let e of this.m.keys())yield MC(e)}*[Symbol.iterator](){for(let[e,t]of this.m)yield[MC(e),t]}*values(){yield*this.m.values()}};function MC(s){let e=s.split(" "),t=e[0],i=e[1],n=t.split(","),o=new m(Number(n[0]),Number(n[1]));n=i.split(",");let a=new m(Number(n[0]),Number(n[1]));return new xt(o,a)}function X_(s,e){return[BC(s),BC(e)].sort().join(" ")}function dm(s){return X_(s.first,s.second)}function BC(s){return s.x.toString()+","+s.y.toString()}var xr=class{static GetShapes(e,t=Array.from(e.shallowEdges)){let i=new Map;DC(e,i);for(let n of t){let o=i.get(n.source);o&&n.sourcePort!=null&&o.Ports.add(n.sourcePort),o=i.get(n.target),o&&n.targetPort!=null&&o.Ports.add(n.targetPort)}return Array.from(i.values())}static CreateShapeWithCenterPort(e){let t=new Do(e),i=Or.mk(()=>e.boundaryCurve,()=>e.center);t.Ports.add(i);for(let n of e.inEdges())xr.FixPortAtTarget(i,n);for(let n of e.outEdges())xr.FixPortAtSource(i,n);for(let n of e.selfEdges())xr.FixPortAtSource(i,n),xr.FixPortAtTarget(i,n);return t}static CreateShapeWithClusterBoundaryPort(e){let t=new Do(e),i=br.mk(()=>e.boundaryCurve,()=>e.center);t.Ports.add(i);let n;for(let o of e.inEdges())o.EdgeToAncestor()===2?(n==null&&(n=new Mt(()=>e.boundaryCurve)),o.targetPort=n):xr.FixPortAtTarget(i,o);for(let o of e.outEdges())o.EdgeToAncestor()===1?(n==null&&(n=new Mt(()=>e.boundaryCurve)),o.sourcePort=n):xr.FixPortAtSource(i,o);for(let o of e.selfEdges())xr.FixPortAtSource(i,o),xr.FixPortAtTarget(i,o);return t}static FixPortAtSource(e,t){t!=null&&t.sourcePort==null&&(t.sourcePort=e)}static FixPortAtTarget(e,t){t!=null&&t.targetPort==null&&(t.targetPort=e)}};function DC(s,e){for(let t of s.shallowNodes)if(t instanceof be){let i=xr.CreateShapeWithClusterBoundaryPort(t);e.set(t,i);let n=t;if(!n.isCollapsed){DC(n,e);for(let o of n.shallowNodes)i.AddChild(e.get(o))}}else e.set(t,xr.CreateShapeWithCenterPort(t))}var GC=Ae(yn(),1);var F0=class{constructor(e,t){this.v=e,this.i=t}},Ii=class{static getFeedbackSetWithConstraints(e,t){throw new Error("Method not implemented.")}static push(e,t,i,n){t[i]=1,e.push(new F0(i,n))}static getFeedbackSet(e){let t=new jr;if(e==null||e.nodeCount===0)return[];let i=new Array(e.nodeCount).fill(0);for(let n=0;n<e.nodeCount;n++){if(i[n]===2)continue;let o=new GC.Stack,a=0;for(Ii.push(o,i,n,a);o.size>0;){let l=o.pop();n=l.v,i[n]=2,a=l.i;let u=e.outEdges[n];for(;a<u.length;a++){let c=u[a];if(c.source===c.target)continue;let h=i[c.target];h===1?t.set(c.source,c.target,c):h===0&&(Ii.push(o,i,n,a+1),n=c.target,i[c.target]=2,u=e.outEdges[n],a=-1)}}}return Array.from(t.values())}};var Xi=class{constructor(){this.isEmpty=!0}AddValue(e){this.isEmpty?(this.max=e,this.min=e,this.isEmpty=!1):e<this.min?this.min=e:e>this.max&&(this.max=e)}get length(){return this.max-this.min}static sign(e){return e>R.distanceEpsilon?1:e<-R.distanceEpsilon?-1:0}};var k0=Ae(yn(),1),VC=Ae(sr(),1);var FC=Ae(sr(),1);var vs=class{SetActiveState(e,t){this.IsActive=e,this.VectorIndex=t,this.IsActive?(this.Left.ActiveConstraintCount++,this.Right.ActiveConstraintCount++):(this.Left.ActiveConstraintCount--,this.Right.ActiveConstraintCount--)}SetVectorIndex(e){this.VectorIndex=e}Reinitialize(){this.IsActive=!1,this.IsUnsatisfiable=!1,this.ClearDfDv()}UpdateGap(e){this.Gap=e}static constructorVVNB(e,t,i,n){let o=new vs(e);return o.Left=e,o.Right=t,o.Gap=i,o.IsEquality=n,o.Lagrangian=0,o.IsActive=!1,o}constructor(e){this.Right=e,this.Left=e}ToString(){return FC.String.Format("  Cst: [{0}] [{1}] {2} {3:F5} vio {4:F5} Lm {5:F5}/{6:F5} {7}actv",this.Left,this.Right,this.IsEquality?"==":">=",this.Gap,this.Violation,this.Lagrangian,this.Lagrangian*2,this.IsActive?"+":this.IsUnsatisfiable?"!":"-")}get Violation(){return this.Left.ActualPos*this.Left.Scale+(this.Gap-this.Right.ActualPos*this.Right.Scale)}ClearDfDv(){this.Lagrangian=0}CompareTo(e){let t=this.Left.CompareTo(e.Left);return t===0&&(t=this.Right.CompareTo(e.Right)),t===0&&(t=_e(this.Gap,e.Gap)),t}};var kC=Ae(sr(),1),Ca=class{static constructorDCVV(e,t,i,n){let o=new Ca(t);return o.Set(e,t,i,n),o}constructor(e){this.ConstraintToEval=e,this.Depth=-1}Set(e,t,i,n){return this.Parent=e,this.ConstraintToEval=t,this.VariableToEval=i,this.VariableDoneEval=n,this.Depth=0,this.ChildrenHaveBeenPushed=!1,t.Lagrangian=0,this}get IsLeftToRight(){return this.VariableToEval===this.ConstraintToEval.Right}toString(){return kC.String.Format("{0} {1}{2} - {3}{4} ({5})","",this.IsLeftToRight?"":"*",this.ConstraintToEval.Left.Name,this.IsLeftToRight?"*":"",this.ConstraintToEval.Right.Name,this.Depth)}};var V0=class{constructor(e,t){this.Constraint=e,this.IsForward=t}},Kl=class{constructor(e,t){this.Variables=new Array,e!=null&&this.AddVariable(e),this.allConstraints=t}toString(){return VC.String.Format("[Block: nvars = {0} refpos = {1:F5} scale = {2:F5}]",this.Variables.length,this.ReferencePos,this.Scale)}ComputeDfDv(e){this.allConstraints.DfDvStack=new k0.Stack;let t=new vs(e);this.dfDvDummyParentNode=new Ca(t);let i=this.GetDfDvNode(this.dfDvDummyParentNode,t,e,null);for(this.allConstraints.DfDvStack.push(i);;){let n=this.allConstraints.DfDvStack.top,o=this.allConstraints.DfDvStack.length;if(!n.ChildrenHaveBeenPushed){n.ChildrenHaveBeenPushed=!0;for(let a of n.VariableToEval.LeftConstraints)if(a.IsActive&&a.Right!==n.VariableDoneEval){let l=this.GetDfDvNode(n,a,a.Right,n.VariableToEval);a.Right.ActiveConstraintCount===1?this.ProcessDfDvLeafNodeDirectly(l):this.PushDfDvNode(l)}for(let a of n.VariableToEval.RightConstraints)if(a.IsActive&&a.Left!==n.VariableDoneEval){let l=this.GetDfDvNode(n,a,a.Left,n.VariableToEval);a.Left.ActiveConstraintCount===1?this.ProcessDfDvLeafNodeDirectly(l):this.PushDfDvNode(l)}if(this.allConstraints.DfDvStack.length>o)continue}if(this.allConstraints.DfDvStack.pop(),this.ProcessDfDvLeafNode(n),n===i)break}}ProcessDfDvLeafNode(e){let t=e.VariableToEval.DfDv;e.IsLeftToRight?(e.ConstraintToEval.Lagrangian=e.ConstraintToEval.Lagrangian+t,e.Parent.ConstraintToEval.Lagrangian=e.Parent.ConstraintToEval.Lagrangian+e.ConstraintToEval.Lagrangian):(e.ConstraintToEval.Lagrangian=(e.ConstraintToEval.Lagrangian+t)*-1,e.Parent.ConstraintToEval.Lagrangian=e.Parent.ConstraintToEval.Lagrangian-e.ConstraintToEval.Lagrangian),this.CheckForConstraintPathTarget(e),this.Debug_CheckForViolatedActiveConstraint(e.ConstraintToEval),this.allConstraints.RecycleDfDvNode(e)}Debug_CheckForViolatedActiveConstraint(e){e.Violation>this.allConstraints.SolverParameters.GapTolerance}ProcessDfDvLeafNodeDirectly(e){this.ProcessDfDvLeafNode(e)}GetDfDvNode(e,t,i,n){let o=this.allConstraints.DfDvRecycleStack.size>0?this.allConstraints.DfDvRecycleStack.pop().Set(e,t,i,n):Ca.constructorDCVV(e,t,i,n);return o.Depth=o.Parent.Depth+1,this.allConstraints.MaxConstraintTreeDepth<o.Depth&&(this.allConstraints.MaxConstraintTreeDepth=o.Depth),o}PushDfDvNode(e){this.PushOnDfDvStack(e)}AddVariableAndPushDfDvNode(e,t){e.push(t.VariableToEval),this.PushOnDfDvStack(t)}PushOnDfDvStack(e){this.allConstraints.DfDvStack.push(e)}CheckForConstraintPathTarget(e){if(this.pathTargetVariable===e.VariableToEval){for(;e.Parent!==this.dfDvDummyParentNode;)this.constraintPath.push(new V0(e.ConstraintToEval,e.IsLeftToRight)),e=e.Parent;this.pathTargetVariable=null}}Expand(e){this.constraintPath==null&&(this.constraintPath=new Array),this.constraintPath=[],this.pathTargetVariable=e.Right,this.ComputeDfDv(e.Left);let t=null;if(this.constraintPath.length>0){for(let a of this.constraintPath)a.IsForward&&(t==null||a.Constraint.Lagrangian<t.Lagrangian)&&(a.Constraint.IsEquality||(t=a.Constraint));t!=null&&this.allConstraints.DeactivateConstraint(t)}if(this.constraintPath=[],this.pathTargetVariable=null,t==null){e.IsUnsatisfiable=!0,this.allConstraints.NumberOfUnsatisfiableConstraints++;return}let i=new Array;this.GetConnectedVariables(i,e.Right,e.Left);let n=e.Violation,o=i.length;for(let a=0;a<o;a++)i[a].OffsetInBlock=i[a].OffsetInBlock+n;this.allConstraints.ActivateConstraint(e),e.ClearDfDv(),this.UpdateReferencePos()}Split(e){if(e&&this.UpdateReferencePos(),this.Variables.length<2)return null;let t=null;this.ComputeDfDv(this.Variables[0]);let i=this.allConstraints.SolverParameters.Advanced.MinSplitLagrangianThreshold,n=this.Variables.length;for(let o=0;o<n;o++)for(let a of this.Variables[o].LeftConstraints)a.IsActive&&!a.IsEquality&&a.Lagrangian<i&&(t=a,i=a.Lagrangian);return t==null?null:this.SplitOnConstraint(t)}SplitOnConstraint(e){this.allConstraints.DeactivateConstraint(e);let t=new Kl(null,this.allConstraints);return this.TransferConnectedVariables(t,e.Right,e.Left),t.Variables.length>0?(this.UpdateReferencePos(),t.UpdateReferencePos()):t=null,t}AddVariable(e){this.Variables.push(e),e.Block=this,this.Variables.length===1?(this.Scale=e.Scale,this.ReferencePos=e.ActualPos,this.sumAd=e.ActualPos*e.Weight,this.sumAb=0,this.sumA2=e.Weight,e.OffsetInBlock=0):this.AddVariableToBlockSums(e)}UpdateReferencePos(){this.Scale=this.Variables[0].Scale,this.sumAd=0,this.sumAb=0,this.sumA2=0;let e=this.Variables.length;for(let t=0;t<e;t++)this.AddVariableToBlockSums(this.Variables[t]);this.UpdateReferencePosFromSums()}AddVariableToBlockSums(e){let t=this.Scale/e.Scale,i=e.OffsetInBlock/e.Scale,n=t*e.Weight;this.sumAd+=n*e.DesiredPos,this.sumAb+=n*i,this.sumA2+=n*t}UpdateReferencePosFromSums(){if(!(Number.isFinite(this.sumAd)&&Number.isFinite(this.sumAb)&&Number.isFinite(this.sumA2)))throw new Error("infinite numbers");this.ReferencePos=(this.sumAd-this.sumAb)/this.sumA2,this.UpdateVariablePositions()}UpdateVariablePositions(){let e=this.Scale*this.ReferencePos,t=this.Variables.length;for(let i=0;i<t;i++){let n=this.Variables[i];n.ActualPos=(e+n.OffsetInBlock)/n.Scale}}GetConnectedVariables(e,t,i){this.RecurseGetConnectedVariables(e,t,i)}RecurseGetConnectedVariables(e,t,i){this.allConstraints.DfDvStack=new k0.Stack;let n=new vs(t);for(this.dfDvDummyParentNode=new Ca(n),this.allConstraints.DfDvStack.push(this.GetDfDvNode(this.dfDvDummyParentNode,n,t,i)),e.push(t);this.allConstraints.DfDvStack.length>0;){let o=this.allConstraints.DfDvStack.top,a=this.allConstraints.DfDvStack.length;if(!o.ChildrenHaveBeenPushed){o.ChildrenHaveBeenPushed=!0;for(let l of o.VariableToEval.LeftConstraints)l.IsActive&&l.Right!==o.VariableDoneEval&&(l.Right.ActiveConstraintCount===1?e.push(l.Right):this.AddVariableAndPushDfDvNode(e,this.GetDfDvNode(o,l,l.Right,o.VariableToEval)));for(let l of o.VariableToEval.RightConstraints)l.IsActive&&l.Left!==o.VariableDoneEval&&(l.Left.ActiveConstraintCount===1?e.push(l.Left):this.AddVariableAndPushDfDvNode(e,this.GetDfDvNode(o,l,l.Left,o.VariableToEval)))}this.allConstraints.DfDvStack.length>a||this.allConstraints.RecycleDfDvNode(this.allConstraints.DfDvStack.pop())}}TransferConnectedVariables(e,t,i){this.GetConnectedVariables(e.Variables,t,i);let n=e.Variables.length;for(let a=0;a<n;a++)e.Variables[a].Block=e;let o=this.Variables.length-1;for(let a=this.Variables.length-1;a>=0;a--)this.Variables[a].Block===e&&(a<o&&(this.Variables[a]=this.Variables[o]),o--);if(this.Variables=this.Variables.slice(0,o+1),this.Variables.length===0){for(let a=0;a<n;a++){let l=e.Variables[a];this.Variables.push(l),l.Block=this}e.Variables=[]}}};var fm=class{get Count(){return this.Vector.length}item(e){return this.Vector[e]}constructor(){this.Vector=new Array}Add(e){e.VectorIndex=this.Vector.length,this.Vector.push(e)}Remove(e){let t=this.Vector[this.Vector.length-1];this.Vector[e.VectorIndex]=t,t.VectorIndex=e.VectorIndex,this.Vector.pop()}toString(){return this.Vector.toString()}};var U0=Ae(yn(),1),gm=class{constructor(){this.nextConstraintIndex=0;this.DfDvStack=new U0.Stack;this.DfDvRecycleStack=new U0.Stack}get IsEmpty(){return this.Vector==null}Create(e){this.Vector=new Array(e),this.firstActiveConstraintIndex=e}Add(e){e.SetVectorIndex(this.nextConstraintIndex),this.Vector[this.nextConstraintIndex++]=e}ActivateConstraint(e){this.firstActiveConstraintIndex--,this.SwapConstraint(e)}DeactivateConstraint(e){this.SwapConstraint(e),this.firstActiveConstraintIndex++}SwapConstraint(e){let t=this.Vector[this.firstActiveConstraintIndex];t.SetVectorIndex(e.VectorIndex),this.Vector[e.VectorIndex]=t,this.Vector[this.firstActiveConstraintIndex]=e,e.SetActiveState(!e.IsActive,this.firstActiveConstraintIndex)}Reinitialize(){if(this.Vector!=null){for(let e of this.Vector)e.Reinitialize();this.firstActiveConstraintIndex=this.Vector.length}}RecycleDfDvNode(e){this.DfDvRecycleStack.length<1024&&this.DfDvRecycleStack.push(e)}toString(){return this.Vector.toString()}};var Bc=class{constructor(){this.GapTolerance=1e-4,this.QpscConvergenceEpsilon=1e-5,this.QpscConvergenceQuotient=1e-6,this.OuterProjectIterationsLimit=-1,this.InnerProjectIterationsLimit=-1,this.TimeLimit=-1,this.Advanced=new Gd}Clone(){let e=this.MemberwiseClone();return e.Advanced=this.Advanced.Clone(),e}MemberwiseClone(){let e=new Bc;return e.GapTolerance=this.GapTolerance,e.QpscConvergenceEpsilon=this.QpscConvergenceEpsilon,e.QpscConvergenceQuotient=this.QpscConvergenceQuotient,e.OuterProjectIterationsLimit=this.OuterProjectIterationsLimit,e.InnerProjectIterationsLimit=this.InnerProjectIterationsLimit,e.TimeLimit=this.TimeLimit,e}},Gd=class{constructor(){this.ForceQpsc=!1,this.ScaleInQpsc=!0,this.MinSplitLagrangianThreshold=-1e-7,this.UseViolationCache=!0,this.ViolationCacheMinBlocksDivisor=10,this.ViolationCacheMinBlocksCount=100}Clone(){let e=new Gd;return e.ForceQpsc=this.ForceQpsc,e.ScaleInQpsc=this.ScaleInQpsc,e.MinSplitLagrangianThreshold=this.MinSplitLagrangianThreshold,e.UseViolationCache=this.UseViolationCache,e.ViolationCacheMinBlocksDivisor=this.ViolationCacheMinBlocksDivisor,e.ViolationCacheMinBlocksCount=this.ViolationCacheMinBlocksCount,e}};var z0=class{constructor(e){this.Variable=e,this.OrigWeight=e.Weight,this.OrigScale=e.Scale,this.OrigDesiredPos=this.Variable.DesiredPos}},W0=class{constructor(e,t){this.Value=e,this.Column=t}},Xr=class{constructor(e,t){this.newMatrixRow=new Array;this.previousFunctionValue=Number.MAX_VALUE;this.solverParameters=e,this.matrixQ=new Array(t).fill(0),this.vectorWiDi=new Array(t).fill(0),this.vectorQpscVars=new Array(t).fill(0),this.gradientVector=new Array(t).fill(0),this.vectorQg=new Array(t).fill(0),this.vectorPrevY=new Array(t).fill(0),this.vectorCurY=new Array(t).fill(0)}AddVariable(e){if(this.isFirstProjectCall=!0,this.vectorWiDi[e.Ordinal]=2*(e.Weight*e.DesiredPos)*-1,this.vectorPrevY[e.Ordinal]=e.Weight,e.Neighbors!=null)for(let t of e.Neighbors)this.vectorPrevY[e.Ordinal]=this.vectorPrevY[e.Ordinal]+t.Weight,this.vectorPrevY[t.Neighbor.Ordinal]=this.vectorPrevY[t.Neighbor.Ordinal]-t.Weight;for(let t=0;t<this.vectorPrevY.length;t++)this.vectorPrevY[t]!==0&&(this.newMatrixRow.push(new W0(this.vectorPrevY[t]*2,t)),this.vectorPrevY[t]=0);this.matrixQ[e.Ordinal]=Array.from(this.newMatrixRow),this.newMatrixRow=[],this.vectorQpscVars[e.Ordinal]=new z0(e),e.Weight=1}VariablesComplete(){for(let e of this.vectorQpscVars){let t=e.Variable;for(let i of this.matrixQ[t.Ordinal])i.Column===t.Ordinal&&(this.solverParameters.Advanced.ScaleInQpsc&&(t.Scale=1/Math.sqrt(Math.abs(i.Value)),Number.isFinite(t.Scale)||(t.Scale=1),t.Scale,this.vectorWiDi[t.Ordinal]=this.vectorWiDi[t.Ordinal]*t.Scale),this.vectorCurY[t.Ordinal]=t.ActualPos,t.DesiredPos=t.ActualPos)}if(!!this.solverParameters.Advanced.ScaleInQpsc)for(let e=0;e<this.matrixQ.length;e++){let t=this.matrixQ[e];for(let i=0;i<t.length;i++)t[i].Column===e?t[i].Value=1:t[i].Value=t[i].Value*(this.vectorQpscVars[e].Variable.Scale*this.vectorQpscVars[t[i].Column].Variable.Scale)}}PreProject(){if(this.isFirstProjectCall)for(let n of this.vectorQpscVars)this.vectorCurY[n.Variable.Ordinal]=n.Variable.ActualPos;if(this.MatrixVectorMultiply(this.vectorCurY,this.gradientVector),this.HasConverged())return!1;Xr.VectorVectorAdd(this.gradientVector,this.vectorWiDi,this.gradientVector);let e=Xr.VectorVectorMultiply(this.gradientVector,this.gradientVector),t=0;if(e!==0&&(this.MatrixVectorMultiply(this.gradientVector,this.vectorQg),t=Xr.VectorVectorMultiply(this.vectorQg,this.gradientVector)),t===0)return!1;let i=e/t;Xr.VectorCopy(this.vectorPrevY,this.vectorCurY),Xr.VectorScaledVectorSubtract(this.vectorPrevY,i,this.gradientVector,this.vectorCurY);for(let n=0;n<this.vectorCurY.length;n++)this.vectorQpscVars[n].Variable.DesiredPos=this.vectorCurY[n];return!0}PostProject(){for(let i of this.vectorQpscVars)this.vectorCurY[i.Variable.Ordinal]=i.Variable.ActualPos;Xr.VectorVectorSubtract(this.vectorPrevY,this.vectorCurY,this.vectorCurY);let e=Xr.VectorVectorMultiply(this.gradientVector,this.vectorCurY),t=0;if(e!==0){this.MatrixVectorMultiply(this.vectorCurY,this.vectorQg);let i=Xr.VectorVectorMultiply(this.vectorQg,this.vectorCurY);t=i===0?1:e/i,t>1?t=1:t<0&&(t=0)}return Xr.VectorScaledVectorSubtract(this.vectorPrevY,t,this.vectorCurY,this.vectorCurY),this.isFirstProjectCall=!1,t>0}QpscComplete(){for(let e of this.vectorQpscVars)e.Variable.Weight=e.OrigWeight,e.Variable.DesiredPos=e.OrigDesiredPos,this.solverParameters.Advanced.ScaleInQpsc&&(e.Variable.ActualPos=e.Variable.ActualPos*e.Variable.Scale,e.Variable.Scale=e.OrigScale);return this.previousFunctionValue}HasConverged(){let e=this.GetFunctionValue(this.vectorCurY),t=!1;if(!this.isFirstProjectCall){let i=this.previousFunctionValue-e,n=0;if(i!==0){let o=this.previousFunctionValue!==0?this.previousFunctionValue:e;n=Math.abs(i/o)}(Math.abs(i)<this.solverParameters.QpscConvergenceEpsilon||Math.abs(n)<this.solverParameters.QpscConvergenceQuotient)&&(t=!0)}return this.previousFunctionValue=e,t}GetFunctionValue(e){return Xr.VectorVectorMultiply(this.gradientVector,e)/2+Xr.VectorVectorMultiply(this.vectorWiDi,e)}static VectorVectorMultiply(e,t){let i=0;for(let n=0;n<e.length;n++)i=i+e[n]*t[n];return i}MatrixVectorMultiply(e,t){let i=0;for(let n of this.matrixQ){let o=0;for(let a of n)o=o+a.Value*e[a.Column];t[i++]=o}}static VectorVectorAdd(e,t,i){for(let n=0;n<e.length;n++)i[n]=e[n]+t[n]}static VectorVectorSubtract(e,t,i){for(let n=0;n<e.length;n++)i[n]=e[n]-t[n]}static VectorScaledVectorSubtract(e,t,i,n){for(let o=0;o<e.length;o++)n[o]=e[o]-t*i[o]}static VectorCopy(e,t){for(let i=0;i<t.length;i++)e[i]=t[i]}};var Zl=class{constructor(){this.NumberOfUnsatisfiableConstraints=0;this.OuterProjectIterations=0;this.InnerProjectIterationsTotal=0;this.MinInnerProjectIterations=0;this.MaxInnerProjectIterations=0;this.MaxConstraintTreeDepth=0;this.GoalFunctionValue=0;this.TimeLimitExceeded=!1;this.OuterProjectIterationsLimitExceeded=!1;this.InnerProjectIterationsLimitExceeded=!1}get ExecutionLimitExceeded(){return this.TimeLimitExceeded||this.OuterProjectIterationsLimitExceeded||this.InnerProjectIterationsLimitExceeded}Clone(){let e=new Zl;return e.GoalFunctionValue=this.GoalFunctionValue,e.InnerProjectIterationsLimitExceeded=this.InnerProjectIterationsLimitExceeded,e.InnerProjectIterationsTotal=this.InnerProjectIterationsTotal,e.MaxConstraintTreeDepth=this.MaxConstraintTreeDepth,e.OuterProjectIterations=this.OuterProjectIterations,e.OuterProjectIterationsLimitExceeded=this.OuterProjectIterationsLimitExceeded,e.AlgorithmUsed=this.AlgorithmUsed,e.NumberOfUnsatisfiableConstraints=this.NumberOfUnsatisfiableConstraints,e.MaxInnerProjectIterations=this.MaxInnerProjectIterations,e}};var UC=Ae(sr(),1);var H0=class{constructor(e,t){this.Neighbor=e,this.Weight=t}},pm=class{constructor(e,t,i,n,o){this.ActiveConstraintCount=0;if(n<=0)throw new Error("weight");if(o<=0)throw new Error("scale");let a=i*n;if(!Number.isFinite(a)||Number.isNaN(a))throw new Error("desiredPos");if(a=i*o,!Number.isFinite(a)||Number.isNaN(a))throw new Error("desiredPos");this.Ordinal=e,this.UserData=t,this.DesiredPos=i,this.Weight=n,this.Scale=o,this.OffsetInBlock=0,this.ActualPos=this.DesiredPos}get DfDv(){return 2*(this.Weight*(this.ActualPos-this.DesiredPos))/this.Scale}Reinitialize(){this.ActiveConstraintCount=0,this.OffsetInBlock=0,this.ActualPos=this.DesiredPos}AddNeighbor(e,t){this.Neighbors==null&&(this.Neighbors=new Array),this.Neighbors.push(new H0(e,t))}toString(){return UC.String.Format("{0} {1:F5} ({2:F5}) {3:F5} {4:F5}",this.Name,this.ActualPos,this.DesiredPos,this.Weight,this.Scale)}get Name(){return this.UserData==null?"-0-":this.UserData.toString()}SetConstraints(e,t){this.LeftConstraints=e,this.RightConstraints=t}CompareTo(e){return _e(this.Ordinal,e.Ordinal)}};var mm=class{get IsFull(){return this.numConstraints===mm.MaxConstraints}Clear(){this.LowViolation=0,this.numConstraints=0,this.constraints||(this.constraints=new Array(mm.MaxConstraints))}FilterBlock(e){this.LowViolation=Number.MAX_VALUE;let t=this.numConstraints>0;for(let i=this.numConstraints-1;i>=0;i--){let n=this.constraints[i];if(n.Left.Block===e||n.Right.Block===e||n.IsActive||n.IsUnsatisfiable)i<this.numConstraints-1&&(this.constraints[i]=this.constraints[this.numConstraints-1]),this.numConstraints--;else{let o=n.Left.ActualPos*n.Left.Scale+(n.Gap-n.Right.ActualPos*n.Right.Scale);o<this.LowViolation&&(this.LowViolation=o)}}return this.numConstraints===0&&(this.LowViolation=0),t}FindIfGreater(e){let t=null;for(let i=0;i<this.numConstraints;i++){let n=this.constraints[i],o=n.Left.ActualPos*n.Left.Scale+(n.Gap-n.Right.ActualPos*n.Right.Scale);o>e&&(e=o,t=n)}return t}Insert(e,t){let i=0,n=t,o=t;for(let a=0;a<this.numConstraints;a++){let l=this.constraints[a],u=l.Left.ActualPos*l.Left.Scale+(l.Gap-l.Right.ActualPos*l.Right.Scale);u<n?(o=n,i=a,n=u):u<o&&(o=u)}this.IsFull?(this.constraints[i]=e,this.LowViolation=o):(this.constraints[this.numConstraints++]=e,this.IsFull&&(this.LowViolation=n))}},Fd=mm;Fd.MaxConstraints=20;var bm=class{constructor(e,t){this.NumberOfLeftConstraints=0;this.Constraints=e,this.NumberOfLeftConstraints=t}},Pm=class{constructor(){this.allBlocks=new fm;this.allConstraints=new gm;this.numberOfConstraints=0;this.numberOfVariables=0;this.equalityConstraints=new Array;this.loadedVariablesAndConstraintLists=new Map;this.emptyConstraintList=new Array(0);this.updatedConstraints=new Array;this.violationCache=new Fd;this.violationCacheMinBlockCutoff=0;this.nextVariableOrdinal=0;this.solverParams=new Bc;this.solverSolution=new Zl}get IsQpsc(){return this.hasNeighbourPairs||this.solverParams.Advanced.ForceQpsc}AddVariableAN(e,t){return this.AddVariableANNN(e,t,1,1)}AddVariableANN(e,t,i){return this.AddVariableANNN(e,t,i,1)}AddVariableANNN(e,t,i,n){if(!this.allConstraints.IsEmpty)throw new Error("Cannot add Variables or Constraints once Solve() has been called");let o=new pm(this.nextVariableOrdinal++,e,t,i,n),a=new Kl(o,this.allConstraints);return o.Block=a,this.allBlocks.Add(a),this.numberOfVariables++,this.loadedVariablesAndConstraintLists.set(o,new bm(new Array,0)),o}UpdateVariables(){for(let e of this.allBlocks.Vector)e.UpdateReferencePos()}get Variables(){return wo(this.allBlocks.Vector,e=>e.Variables)}get VariableCount(){return this.numberOfVariables}*Constraints(){if(this.allConstraints.IsEmpty)for(let e of this.loadedVariablesAndConstraintLists.keys()){let t=this.loadedVariablesAndConstraintLists.get(e);if(t.Constraints!=null){let i=t.Constraints.length;for(let n=0;n<i;n++){let o=t.Constraints[n];if(e===o.Left)return yield,o}}}else for(let e of this.allConstraints.Vector)yield e}get ConstraintCount(){return this.numberOfConstraints}AddEqualityConstraint(e,t,i){return this.AddConstraintVVNB(e,t,i,!0)}AddConstraintVVNB(e,t,i,n){if(!this.allConstraints.IsEmpty)throw new Error("Cannot add Variables or Constraints once Solve() has been called");if(e===t)throw new Error("Cannot add a constraint between a variable and itself");let o=this.loadedVariablesAndConstraintLists.get(e),a=this.loadedVariablesAndConstraintLists.get(t),l=vs.constructorVVNB(e,t,i,n);return this.loadedVariablesAndConstraintLists.set(e,new bm(o.Constraints,o.NumberOfLeftConstraints+1)),o.Constraints.push(l),a.Constraints.push(l),this.numberOfConstraints++,n&&this.equalityConstraints.push(l),l}AddConstraint(e,t,i){return this.AddConstraintVVNB(e,t,i,!1)}SetConstraintUpdate(e,t){t!==e.Gap&&this.updatedConstraints.push([e,t])}AddNeighborPair(e,t,i){if(i<=0||Number.isNaN(i)||!Number.isFinite(i))throw new Error("relationshipWeight");if(e===t)throw new Error;e.AddNeighbor(t,i),t.AddNeighbor(e,i),this.hasNeighbourPairs=!0}Solve(){return this.SolvePar(null)}SolvePar(e){e&&(this.solverParams=e.Clone()),this.solverParams.OuterProjectIterationsLimit<0&&(this.solverParams.OuterProjectIterationsLimit=100*(Math.floor(Math.log2(this.numberOfVariables))+1)),this.solverParams.InnerProjectIterationsLimit<0&&(this.solverParams.InnerProjectIterationsLimit=this.numberOfConstraints*2+100*(Math.max(0,Math.floor(Math.log2(this.numberOfConstraints)))+1));let t=!this.allConstraints.IsEmpty;if(this.CheckForUpdatedConstraints(),this.solverSolution=new Zl,this.solverSolution.MinInnerProjectIterations=Number.MAX_VALUE,this.allConstraints.MaxConstraintTreeDepth=0,this.allConstraints.SolverParameters=this.solverParams,this.numberOfConstraints===0){if(!this.IsQpsc)return this.solverSolution.Clone()}else t||this.SetupConstraints();return this.allConstraints.NumberOfUnsatisfiableConstraints=0,this.MergeEqualityConstraints(),this.IsQpsc?this.SolveQpsc():(this.SolveByStandaloneProject(),this.CalculateStandaloneProjectGoalFunctionValue()),this.solverSolution.MinInnerProjectIterations>this.solverSolution.MaxInnerProjectIterations&&(this.solverSolution.MinInnerProjectIterations=this.solverSolution.MaxInnerProjectIterations),this.solverSolution.NumberOfUnsatisfiableConstraints=this.allConstraints.NumberOfUnsatisfiableConstraints,this.solverSolution.MaxConstraintTreeDepth=this.allConstraints.MaxConstraintTreeDepth,this.solverSolution.Clone()}CheckForUpdatedConstraints(){if(this.updatedConstraints.length===0)return;let e=this.IsQpsc;for(let[t,i]of this.updatedConstraints){let n=t;if(n.UpdateGap(i),!e&&!n.IsEquality){this.SplitOnConstraintIfActive(n);continue}e=!0}this.updatedConstraints=[],e&&this.ReinitializeBlocks()}SplitOnConstraintIfActive(e){if(e.IsActive){let t=e.Left.Block.SplitOnConstraint(e);t!=null&&this.allBlocks.Add(t)}}SetupConstraints(){this.allConstraints.Create(this.numberOfConstraints);for(let e of this.loadedVariablesAndConstraintLists.keys()){let t=this.loadedVariablesAndConstraintLists.get(e),i=t.Constraints,n=0,o=0,a=0;i!=null&&(n=i.length,o=t.NumberOfLeftConstraints,a=n-o);let l=this.emptyConstraintList;o!==0&&(l=new Array(o));let u=this.emptyConstraintList;a!==0&&(u=new Array(a)),e.SetConstraints(l,u);let c=0,h=0;for(let d=0;d<n;d++){let f=i[d];e===f.Left?l[c++]=f:u[h++]=f}for(let d of e.LeftConstraints)this.allConstraints.Add(d)}this.loadedVariablesAndConstraintLists.clear(),this.violationCacheMinBlockCutoff=Number.MAX_VALUE,this.solverParams.Advanced.UseViolationCache&&this.solverParams.Advanced.ViolationCacheMinBlocksDivisor>0&&(this.violationCacheMinBlockCutoff=Math.min(this.allBlocks.Count/this.solverParams.Advanced.ViolationCacheMinBlocksDivisor,this.solverParams.Advanced.ViolationCacheMinBlocksCount))}SolveByStandaloneProject(){for(;;){if(!this.RunProject())return;if(!this.SplitBlocks())break}}RunProject(){return this.solverSolution.OuterProjectIterations++,this.Project(),!this.CheckForLimitsExceeded()}CheckForLimitsExceeded(){return this.solverParams.OuterProjectIterationsLimit>0&&this.solverSolution.OuterProjectIterations>=this.solverParams.OuterProjectIterationsLimit?(this.solverSolution.OuterProjectIterationsLimitExceeded=!0,!0):!!this.solverSolution.InnerProjectIterationsLimitExceeded}CalculateStandaloneProjectGoalFunctionValue(){this.solverSolution.GoalFunctionValue=0;let e=this.allBlocks.Count;for(let t=0;t<e;t++){let i=this.allBlocks.item(t),n=i.Variables.length;for(let o=0;o<n;o++){let a=i.Variables[o];this.solverSolution.GoalFunctionValue+=a.Weight*(a.ActualPos*a.ActualPos),this.solverSolution.GoalFunctionValue-=2*(a.Weight*(a.DesiredPos*a.ActualPos))}}}SolveQpsc(){if(this.solverSolution.AlgorithmUsed=this.solverParams.Advanced.ScaleInQpsc?1:2,!this.QpscMakeFeasible())return;let e=new Xr(this.solverParams,this.numberOfVariables);for(let i of this.allBlocks.Vector)for(let n of i.Variables)e.AddVariable(n);e.VariablesComplete(),this.ReinitializeBlocks(),this.MergeEqualityConstraints();let t=!1;for(;!(!e.PreProject()&&!t||(t=this.SplitBlocks(),!this.RunProject())||!e.PostProject()&&!t););this.solverSolution.GoalFunctionValue=e.QpscComplete()}QpscMakeFeasible(){return this.RunProject()}ReinitializeBlocks(){let e=Array.from(this.allBlocks.Vector);this.allBlocks.Vector=[];for(let t of e)for(let i of t.Variables){i.Reinitialize();let n=new Kl(i,this.allConstraints);this.allBlocks.Add(n)}this.allConstraints.Reinitialize(),this.violationCache.Clear()}MergeEqualityConstraints(){for(let e of this.equalityConstraints){if(e.Left.Block===e.Right.Block){Math.abs(e.Violation)>this.solverParams.GapTolerance&&(e.IsUnsatisfiable=!0,this.allConstraints.NumberOfUnsatisfiableConstraints++);continue}this.MergeBlocks(e)}}Project(){if(this.numberOfConstraints===0)return!1;this.violationCache.Clear(),this.lastModifiedBlock=null;let e=this.allBlocks.Count>this.violationCacheMinBlockCutoff,t=1,i={maxViolation:0},n=this.GetMaxViolatedConstraint(i,e);if(!n)return!1;for(;n;){if(n.Left.Block===n.Right.Block?(n.Left.Block.Expand(n),n.IsUnsatisfiable&&this.violationCache.Clear(),this.lastModifiedBlock=n.Left.Block):this.lastModifiedBlock=this.MergeBlocks(n),this.solverParams.InnerProjectIterationsLimit>0&&t>=this.solverParams.InnerProjectIterationsLimit){this.solverSolution.InnerProjectIterationsLimitExceeded=!0;break}e=this.allBlocks.Count>this.violationCacheMinBlockCutoff,e||this.violationCache.Clear(),t++;let o={maxViolation:0};n=this.GetMaxViolatedConstraint(o,e)}return this.solverSolution.InnerProjectIterationsTotal=this.solverSolution.InnerProjectIterationsTotal+t,this.solverSolution.MaxInnerProjectIterations<t&&(this.solverSolution.MaxInnerProjectIterations=t),this.solverSolution.MinInnerProjectIterations>t&&(this.solverSolution.MinInnerProjectIterations=t),!0}MergeBlocks(e){let t=e.Left.Block,i=e.Right.Block,n=e.Left.OffsetInBlock+(e.Gap-e.Right.OffsetInBlock);i.Variables.length>t.Variables.length&&(t=e.Right.Block,i=e.Left.Block,n=-n);let o=i.Variables.length;for(let a=0;a<o;a++){let l=i.Variables[a];l.OffsetInBlock+=n,t.AddVariable(l)}return t.UpdateReferencePosFromSums(),this.allConstraints.ActivateConstraint(e),this.allBlocks.Remove(i),t}SplitBlocks(){let e=new Array,t=this.allBlocks.Count;for(let n=0;n<t;n++){let a=this.allBlocks.item(n).Split(this.IsQpsc);a!=null&&e.push(a)}let i=e.length;for(let n=0;n<i;n++){let o=e[n];this.allBlocks.Add(o)}return e.length!==0}GetMaxViolatedConstraint(e,t){e.maxViolation=this.solverParams.GapTolerance;let i=this.SearchViolationCache(e.maxViolation);return i!=null?i:this.SearchAllConstraints(e.maxViolation,t)}SearchViolationCache(e){let t=null;if(this.lastModifiedBlock==null)return;this.lastModifiedBlock.Variables.length<this.numberOfVariables+1&&this.violationCache.FilterBlock(this.lastModifiedBlock);let i=this.lastModifiedBlock.Variables.length;for(let o=0;o<i;o++){let a=this.lastModifiedBlock.Variables[o];for(let l of a.LeftConstraints)if(!l.IsActive&&!l.IsUnsatisfiable){let u=l.Left.ActualPos*l.Left.Scale+(l.Gap-l.Right.ActualPos*l.Right.Scale);qp(u,e)&&(t!=null&&e>this.violationCache.LowViolation&&this.violationCache.Insert(t,e),e=l.Violation,t=l)}for(let l of a.RightConstraints)if(!l.IsActive&&!l.IsUnsatisfiable&&l.Left.Block!==this.lastModifiedBlock){let u=l.Left.ActualPos*l.Left.Scale+(l.Gap-l.Right.ActualPos*l.Right.Scale);qp(u,e)&&(t!=null&&e>this.violationCache.LowViolation&&this.violationCache.Insert(t,e),e=u,t=l)}}let n=this.violationCache.FindIfGreater(e);return n!=null&&(t!=null&&e>this.violationCache.LowViolation&&this.violationCache.Insert(t,e),t=n),t}SearchAllConstraints(e,t){let i=null;this.violationCache.Clear();for(let n of this.allConstraints.Vector){if(n.IsActive)break;if(n.IsUnsatisfiable)continue;let o=n.Left.ActualPos*n.Left.Scale+(n.Gap-n.Right.ActualPos*n.Right.Scale),a=null,l=0;qp(o,e)&&(e>this.violationCache.LowViolation&&(a=i,l=e),e=o,i=n),t&&(a==null&&n!==i&&(!this.violationCache.IsFull||o>this.violationCache.LowViolation)&&(a=n,l=o),a!=null&&l>this.violationCache.LowViolation&&this.violationCache.Insert(a,l))}return i}};var ym=class{constructor(){this.variables=new Map;this.fixedVars=new Map;this.FailToAdjustEpsilon=.001;this.InitSolver()}AddVariableWithIdealPositionNNN(e,t,i){this.variables.set(e,this.solver.AddVariableANN(e,t,i))}AddVariableWithIdealPositionNN(e,t){this.AddVariableWithIdealPositionNNN(e,t,1)}AddLeftRightSeparationConstraintNNNB(e,t,i,n){let o=this.GetVariable(e);if(o==null)return;let a=this.GetVariable(t);a!=null&&this.solver.AddConstraintVVNB(o,a,i,n)}AddLeftRightSeparationConstraintNNN(e,t,i){this.AddLeftRightSeparationConstraintNNNB(e,t,i,!1)}AddGoalTwoVariablesAreCloseNNN(e,t,i){let n=this.GetVariable(e);if(n==null)return;let o=this.GetVariable(t);o!=null&&this.solver.AddNeighborPair(n,o,i)}AddGoalTwoVariablesAreClose(e,t){this.AddGoalTwoVariablesAreCloseNNN(e,t,1)}GetVariable(e){return this.variables.get(e)}Solve(){this.SolveP(null)}SolveP(e){let t={executionLimitExceeded:!1};this.SolvePNS(e,t)}SolvePNS(e,t){let i;do{this.solution=null;let n=null;if(e!=null&&(n=e,n==null))throw new Error("parameters");this.solution=this.solver.SolvePar(n),t.executionLimitExceeded=this.solution.ExecutionLimitExceeded,i=this.AdjustConstraintsForMovedFixedVars()}while(i&&this.solution.ExecutionLimitExceeded===!1);return this.solution.ExecutionLimitExceeded===!1}AdjustConstraintsForMovedFixedVars(){let e=new Set;for(let[t,i]of this.fixedVars.entries())ym.Close(i,this.GetVariableResolvedPosition(t))||e.add(t);return e.size===0?!1:this.AdjustConstraintsForMovedFixedVarSet(e)}static Close(e,t){return Math.abs(e-t)<5e-4}AdjustConstraintsForMovedFixedVarSet(e){for(;e.size>0;){let t;for(let i of e){t=i;break}if(!this.AdjustSubtreeOfFixedVar(t,e))return!1}return!0}AdjustSubtreeOfFixedVar(e,t){let i={successInAdjusting:!1},n=this.AdjustConstraintsOfNeighborsOfFixedVariable(e,i);if(!i.successInAdjusting||n.length===0)return!1;for(let o of n)t.delete(o);return!0}AdjustConstraintsOfNeighborsOfFixedVariable(e,t){let i=this.variables.get(e).Block.Variables,n=new Xi,o=new Xi,a=1;for(let l of i)!this.fixedVars.has(l.UserData)||(n.AddValue(l.ActualPos),o.AddValue(l.DesiredPos),o.length>0&&(a=Math.max(a,n.length/o.length)));return a===1&&(a=2),t.successInAdjusting=this.FixActiveConstraints(i,a),i.map(l=>l.UserData)}FixActiveConstraints(e,t){let i=!1;for(let n of e)for(let o of n.LeftConstraints)o.IsActive&&(o.Gap>this.FailToAdjustEpsilon&&(i=!0),this.solver.SetConstraintUpdate(o,o.Gap/t));return i}GetVariableResolvedPosition(e){let t=this.GetVariable(e);return t==null?0:t.ActualPos}InitSolver(){this.solver=new Pm,this.variables.clear()}AddFixedVariable(e,t){this.AddVariableWithIdealPositionNNN(e,t,ym.FixedVarWeight),this.fixedVars.set(e,t)}ContainsVariable(e){return this.variables.has(e)}GetVariableIdealPosition(e){return this.variables.get(e).DesiredPos}get Solution(){return this.solution}},kd=ym;kd.FixedVarWeight=1e9;var Sm=class{constructor(){this.lowBound=Number.NEGATIVE_INFINITY;this.upperBound=Number.POSITIVE_INFINITY}get Position(){return this.position}set Position(e){e<this.lowBound?this.position=this.lowBound:e>this.upperBound?this.position=this.upperBound:this.position=e}get LowBound(){return this.lowBound}set LowBound(e){this.lowBound=e}get UpperBound(){return this.upperBound}set UpperBound(e){this.upperBound=e}toString(){return this.lowBound+(" "+(this.Position+(" "+this.upperBound)))}};var Em=class{constructor(e){this.idealPositions=new Map;this.varList=new Array;this.constraints=new Set;this.solverShell=new kd;this.boundsToInt=new Map;this.varSepartion=e}SetLowBound(e,t){let i=this.Var(t);i.LowBound=Math.max(e,i.LowBound)}Var(e){return this.varList[e]}SetUpperBound(e,t){let i=this.Var(e);i.UpperBound=Math.min(t,i.UpperBound)}Solve(){this.SolveByRegularSolver()}SolveByRegularSolver(){this.CreateVariablesForBounds();for(let e=0;e<this.varList.length;e++){let t=this.varList[e];t.IsFixed?this.solverShell.AddFixedVariable(e,t.Position):(this.solverShell.AddVariableWithIdealPositionNN(e,this.idealPositions.get(e)),t.LowBound!==Number.NEGATIVE_INFINITY&&this.constraints.add(new me(this.GetBoundId(t.LowBound),e)),t.UpperBound!==Number.POSITIVE_INFINITY&&this.constraints.add(new me(e,this.GetBoundId(t.UpperBound))))}this.CreateGraphAndRemoveCycles();for(let e of this.graph.edges){let t=0;e.x<this.varList.length&&(t+=this.varList[e.x].Width),e.y<this.varList.length&&(t+=this.varList[e.y].Width),t/=2,this.solverShell.AddLeftRightSeparationConstraintNNN(e.x,e.y,this.varSepartion+t)}this.solverShell.Solve();for(let e=0;e<this.varList.length;e++)this.varList[e].Position=this.solverShell.GetVariableResolvedPosition(e)}GetBoundId(e){return this.boundsToInt.get(e)}CreateVariablesForBounds(){for(let e of this.varList)e.IsFixed||(e.LowBound!==Number.NEGATIVE_INFINITY&&this.RegisterBoundVar(e.LowBound),e.UpperBound!==Number.POSITIVE_INFINITY&&this.RegisterBoundVar(e.UpperBound))}RegisterBoundVar(e){if(!this.boundsToInt.has(e)){let t=this.varList.length+this.boundsToInt.size;this.boundsToInt.set(e,t),this.solverShell.AddFixedVariable(t,e)}}CreateGraphAndRemoveCycles(){this.graph=Sr(Array.from(this.constraints),this.varList.length+this.boundsToInt.size);let e=Ii.getFeedbackSet(this.graph);if(e!=null)for(let t of e)this.graph.removeEdge(t)}GetVariablePosition(e){return this.varList[e].Position}AddConstraint(e,t){this.constraints.add(new me(e,t))}AddVariableNNNN(e,t,i,n){this.idealPositions.set(e,i),this.AddVariableNNBN(e,t,!1,n)}AddFixedVariable(e,t){this.AddVariableNNBN(e,t,!0,0)}AddVariableNNBN(e,t,i,n){let o=new Sm;o.Position=t,o.IsFixed=i,o.Width=n,this.varList.push(o)}};var Aa=class{clone(){let e=new Aa;return e.transparency=this.transparency,e.width=this.width,e.color=this.color,e.icurve=this.icurve.clone(),e.label=this.label,e.dashArray=this.dashArray,e.drawPN=this.drawPN,e}static mkDebugCurveTWCILD(e,t,i,n,o,a,l=!1){let u=new Aa;return u.transparency=e,u.width=t,u.color=i,u.icurve=n,u.label=o,u.dashArray=a,u.drawPN=l,u}static mkDebugCurveTWCI(e,t,i,n){return Aa.mkDebugCurveTWCILD(e,t,i,n,null,null)}static mkDebugCurveWCI(e,t,i){return Aa.mkDebugCurveTWCI(255,e,t,i)}static mkDebugCurveCI(e,t){return Aa.mkDebugCurveWCI(1,e,t)}static mkDebugCurveI(e){return Aa.mkDebugCurveCI("Black",e)}},Ie=Aa;Ie.colors=["DeepSkyBlue","IndianRed","Orange","Gold","DarkRed","Plum","Red","Violet","Indigo","Yellow","OrangeRed","Tomato","Purple","SaddleBrown","Green","Navy","Aqua","Pink","Bisque","Black","BlanchedAlmond","Blue","BlueViolet","Brown","Lime","BurlyWood","Chocolate","Coral","CornflowerBlue","Cornsilk","Crimson","Cyan","CadetBlue","Chartreuse","DarkBlue","DarkCyan","DarkGoldenrod","DarkGray","DarkGreen","DarkKhaki","DarkMagenta","DarkOliveGreen","DarkOrange","DarkOrchid","DarkSalmon","DarkSeaGreen","DarkSlateBlue","DarkSlateGray","DarkTurquoise","DarkViolet","DeepPink","DimGray","DodgerBlue","Firebrick","FloralWhite","ForestGreen","Fuchsia","CodeAnalysis","Gainsboro","GhostWhite","Goldenrod","Gray","GreenYellow","Honeydew","HotPink","Ivory","Lavender","LavenderBlush","LawnGreen","LemonChiffon","LightBlue","LightCoral","LightCyan","LightGoldenrodYellow","LightGray","LightGreen","LightPink","LightSalmon","LightSeaGreen","LightSkyBlue","LightSlateGray","LightSteelBlue","LightYellow","LimeGreen","Linen","Magenta","Maroon","MediumAquamarine","MediumBlue","MediumOrchid","MediumPurple","MediumSeaGreen","MediumSlateBlue","MediumSpringGreen","MediumTurquoise","MediumVioletRed","MidnightBlue","MintCream","MistyRose","Moccasin","NavajoWhite","OldLace","Olive","OliveDrab","Orchid","PaleGoldenrod","PaleGreen","PaleTurquoise","PaleVioletRed","PapayaWhip","PeachPuff","Peru","PowderBlue","RosyBrown","RoyalBlue","Salmon","SandyBrown","SeaGreen","CodeAnalysis","SeaShell","Sienna","Silver","SkyBlue","SlateBlue","SlateGray","Snow","SpringGreen","SteelBlue","Tan","Teal","Thistle","Transparent","Turquoise","Aquamarine","Azure","Beige","Wheat","White","WhiteSmoke","YellowGreen","Khaki","AntiqueWhite"];var zC=Ae(zn(),1);var xm=class extends di{constructor(t,i){super(t,i);this.RightNeighbors=new Set;this.setOfLongestSegs=new Set;this.RightBound=Number.POSITIVE_INFINITY,this.LeftBound=Number.NEGATIVE_INFINITY,this.Direction=K.DirectionFromPointToPoint(t.point,i.point)}AddRightNeighbor(t){this.RightNeighbors.add(t)}get LongestNudgedSegments(){return this.setOfLongestSegs}AddLongestNudgedSegment(t){this.setOfLongestSegs.add(t)}BoundFromRight(t){t=Math.max(t,this.LeftBound),this.RightBound=Math.min(t,this.RightBound)}BoundFromLeft(t){t=Math.min(t,this.RightBound),this.LeftBound=Math.max(t,this.LeftBound)}};var fi=class{constructor(e){this.Point=e}*GetEnumerator(){let e;for(e=this;e!=null;e=e.Next)yield e.Point}get X(){return this.Point.x}get Y(){return this.Point.y}InsertVerts(e,t,i){for(t--;e<t;t--)this.SetNewNext(i[t])}InsertVertsInReverse(e,t,i){for(e++;e<t;e++)this.SetNewNext(i[e])}SetNewNext(e){let t=new fi(e),i=this.Next;this.Next=t,t.Next=i}};var Ql=class{constructor(e,t){this.IsFixed=!1;this.Reversed=!1;this.index=-1;this.AxisEdge=e,this.Width=t}toString(){return this.Source+(" "+this.Target)}get LongestNudgedSegment(){return this.longestNudgedSegment}set LongestNudgedSegment(e){this.longestNudgedSegment=e,this.longestNudgedSegment!=null&&(this.longestNudgedSegment.AddEdge(this),this.AxisEdge.AddLongestNudgedSegment(this.longestNudgedSegment))}get Source(){return this.Reversed?this.AxisEdge.TargetPoint:this.AxisEdge.SourcePoint}get Target(){return this.Reversed?this.AxisEdge.SourcePoint:this.AxisEdge.TargetPoint}static VectorsAreParallel(e,t){return ue(e.x*t.y-e.y*t.x,0)}static EdgesAreParallel(e,t){return Ql.VectorsAreParallel(e.AxisEdge.TargetPoint.sub(e.AxisEdge.SourcePoint),t.AxisEdge.TargetPoint.sub(t.AxisEdge.SourcePoint))}get Direction(){return this.Reversed?K.OppositeDir(this.AxisEdge.Direction):this.AxisEdge.Direction}get Index(){return this.index}set Index(e){this.index=e}};var Yr=class{constructor(e){this.pathVisibilityGraph=new Ke;this.axisEdgesToPathOrders=new Map;this.OriginalPaths=e}get PathVisibilityGraph(){return this.pathVisibilityGraph}GetOrder(){return this.FillTheVisibilityGraphByWalkingThePaths(),this.InitPathOrder(),this.OrderPaths(),this.axisEdgesToPathOrders}FillTheVisibilityGraphByWalkingThePaths(){for(let e of this.OriginalPaths)this.FillTheVisibilityGraphByWalkingPath(e)}FillTheVisibilityGraphByWalkingPath(e){let t=this.CreatePathEdgesFromPoints(n(),e.Width),i=t.next();for(i.done||e.SetFirstEdge(i.value);(i=t.next()).done===!1;)e.AddEdge(i.value);function*n(){if(e.PathPoints instanceof fi)for(let o=e.PathPoints;o!=null;o=o.Next)yield o.Point;else for(let o of e.PathPoints)yield o}}*CreatePathEdgesFromPoints(e,t){let i=e.next(),n=i.value;for(;!(i=e.next()).done;)yield this.CreatePathEdge(n,i.value,t),n=i.value}CreatePathEdge(e,t,i){switch(K.DirectionFromPointToPoint(e,t)){case 2:case 1:return new Ql(this.GetAxisEdge(e,t),i);case 4:case 8:{let o=new Ql(this.GetAxisEdge(t,e),i);return o.Reversed=!0,o}default:throw new Error("Not a rectilinear path")}}GetAxisEdge(e,t){return this.PathVisibilityGraph.AddEdgeF(e,t,(i,n)=>new xm(i,n))}InitPathOrder(){for(let e of this.PathVisibilityGraph.Edges)this.axisEdgesToPathOrders.set(e,new Array);for(let e of this.OriginalPaths)for(let t of e.PathEdges())this.axisEdgesToPathOrders.get(t.AxisEdge).push(t)}OrderPaths(){for(let e of Yr.WalkGraphEdgesInTopologicalOrderIfPossible(this.PathVisibilityGraph))this.OrderPathEdgesSharingEdge(e)}OrderPathEdgesSharingEdge(e){let t=this.PathOrderOfVisEdge(e);t.sort(Yr.CompareTwoPathEdges);let i=0;for(let n of t)n.Index=i++}static CompareTwoPathEdges(e,t){if(e===t)return 0;let i=Yr.CompareInDirectionStartingFromAxisEdge(e,t,e.AxisEdge,e.AxisEdge.Direction);return i!==0?i:-Yr.CompareInDirectionStartingFromAxisEdge(e,t,e.AxisEdge,K.OppositeDir(e.AxisEdge.Direction))}static CompareInDirectionStartingFromAxisEdge(e,t,i,n){for(;;){if(e=Yr.GetNextPathEdgeInDirection(e,i,n),e==null||(t=Yr.GetNextPathEdgeInDirection(t,i,n),t==null))return 0;if(e.AxisEdge===t.AxisEdge){n=Yr.FindContinuedDirection(i,n,e.AxisEdge),i=e.AxisEdge;let c=Yr.GetExistingOrder(e,t);if(c===Yr.NotOrdered)continue;return n===i.Direction?c:-c}let o=n===i.Direction?i.Target:i.Source,a=Yr.OtherVertex(e.AxisEdge,o),l=Yr.OtherVertex(t.AxisEdge,o),u=Yr.ProjectionForCompare(i,n!==i.Direction);return _e(u(a.point),u(l.point))}}static FindContinuedDirection(e,t,i){return e.Direction===t?i.Source===e.Target?i.Direction:K.OppositeDir(i.Direction):i.Source===e.Source?i.Direction:K.OppositeDir(i.Direction)}static OtherVertex(e,t){return e.Source===t?e.Target:e.Source}static ProjectionForCompare(e,t){return e.Direction===1?t?i=>-i.x:i=>i.x:t?i=>i.y:i=>-i.y}static GetNextPathEdgeInDirection(e,t,i){return t.Direction===i?e.Reversed?e.Prev:e.Next:e.Reversed?e.Next:e.Prev}static GetExistingOrder(e,t){let i=e.Index;if(i===-1)return Yr.NotOrdered;let n=t.Index;return _e(i,n)}PathOrderOfVisEdge(e){return this.axisEdgesToPathOrders.get(e)}static InitQueueOfSources(e,t,i){for(let n of i.Vertices()){let o=n.InEdgesLength();t.set(n,o),o===0&&e.enqueue(n)}}static*WalkGraphEdgesInTopologicalOrderIfPossible(e){let t=new zC.Queue,i=new Map;for(Yr.InitQueueOfSources(t,i,e);t.length>0;){let n=t.dequeue();for(let o of n.OutEdges){let a=i.get(o.Target);i.set(o.Target,a-1),a===1&&t.enqueue(o.Target),yield o}}}},Vd=Yr;Vd.NotOrdered=Number.MAX_VALUE;var vm=class extends Zt{constructor(t,i){super();this.site=i,this.AxisEdge=t}get Site(){return this.site}};var Ud=class extends Zt{constructor(t,i){super();this.site=i,this.AxisEdge=t}get Site(){return this.site}};var Cm=class{constructor(e){this.edges=new Set;this.Source=e}get Edges(){return this.edges}AddEdge(e){this.UpPoint=e.TargetPoint,this.edges.add(e)}RemoveAxis(e){this.edges.delete(e)}IsEmpty(){return this.edges.size===0}};var Ta=class extends Ic{constructor(t,i,n,o,a){super(i,new K(t).ToPoint());this.DirectionPerp=new K(t).Right.ToPoint(),this.PathOrders=o,this.xProjection=t===1?l=>l.x:l=>-l.y,this.edgeContainersTree=new dt((l,u)=>this.CompareAA(l,u)),this.SweepPole=K.VectorDirection(this.SweepDirection),this.AxisEdges=a,this.AxisEdgesToObstaclesTheyOriginatedFrom=n}FindFreeSpace(){this.InitTheQueueOfEvents(),this.ProcessEvents()}ProcessEvents(){for(;this.EventQueue.Count>0;)this.ProcessEvent(this.EventQueue.Dequeue())}ProcessEvent(t){t instanceof Ci?this.ProcessVertexEvent(t):(this.Z=this.GetZP(t.Site),t instanceof Ud?this.ProcessLowEdgeEvent(t):this.ProcessHighEdgeEvent(t))}ProcessHighEdgeEvent(t){let i=t.AxisEdge;this.RemoveEdge(i),this.ConstraintEdgeWithObstaclesAtZ(i,i.Target.point)}ProcessLowEdgeEvent(t){let i=t.AxisEdge,n=this.GetOrCreateAxisEdgesContainer(i);n.item.AddEdge(i);let o=this.edgeContainersTree.previous(n);if(o!=null)for(let l of o.item.edges)for(let u of n.item.edges)this.TryToAddRightNeighbor(l,u);let a=this.edgeContainersTree.next(n);if(a!=null)for(let l of n.item.Edges)for(let u of a.item.edges)this.TryToAddRightNeighbor(l,u);this.ConstraintEdgeWithObstaclesAtZ(i,i.Source.point)}TryToAddRightNeighbor(t,i){this.ProjectionsOfEdgesOverlap(t,i)&&t.AddRightNeighbor(i)}ProjectionsOfEdgesOverlap(t,i){return this.SweepPole===1?!(t.TargetPoint.y<i.SourcePoint.y-R.distanceEpsilon||i.TargetPoint.y<t.SourcePoint.y-R.distanceEpsilon):!(t.TargetPoint.x<i.SourcePoint.x-R.distanceEpsilon||i.TargetPoint.x<t.SourcePoint.x-R.distanceEpsilon)}GetObstacleBoundaries(t){return this.Obstacles.map(i=>Ie.mkDebugCurveWCI(1,t,i))}ConstraintEdgeWithObstaclesAtZ(t,i){this.ConstraintEdgeWithObstaclesAtZFromLeft(t,i),this.ConstraintEdgeWithObstaclesAtZFromRight(t,i)}ConstraintEdgeWithObstaclesAtZFromRight(t,i){let n=this.GetActiveSideFromRight(i);if(n==null||this.NotRestricting(t,n.item.Polyline))return;let o=this.ObstacleSideComparer.IntersectionOfSideAndSweepLine(n.item);t.BoundFromRight(o.dot(this.DirectionPerp))}GetActiveSideFromRight(t){return this.LeftObstacleSideTree.findFirst(i=>Ta.PointToTheLeftOfLineOrOnLineLocal(t,i.Start,i.End))}ConstraintEdgeWithObstaclesAtZFromLeft(t,i){let n=this.GetActiveSideFromLeft(i);if(n==null||this.NotRestricting(t,n.item.Polyline))return;let o=this.ObstacleSideComparer.IntersectionOfSideAndSweepLine(n.item);t.BoundFromLeft(o.dot(this.DirectionPerp))}static PointToTheLeftOfLineOrOnLineLocal(t,i,n){return m.signedDoubledTriangleArea(t,i,n)>-Ta.AreaComparisonEpsilon}static PointToTheRightOfLineOrOnLineLocal(t,i,n){return m.signedDoubledTriangleArea(i,n,t)<Ta.AreaComparisonEpsilon}GetActiveSideFromLeft(t){return this.RightObstacleSideTree.findLast(i=>Ta.PointToTheRightOfLineOrOnLineLocal(t,i.Start,i.End))}static EdgeMidPoint(t){return m.middle(t.SourcePoint,t.TargetPoint)}GetOrCreateAxisEdgesContainer(t){let i=t.Source.point,n=this.GetAxisEdgesContainerNode(i);return n!=null?n:this.edgeContainersTree.insert(new Cm(i))}GetAxisEdgesContainerNode(t){let i=this.xProjection(t),n=this.edgeContainersTree.findFirst(o=>this.xProjection(o.Source)>=i-R.distanceEpsilon/2);return n!=null&&this.xProjection(n.item.Source)<=i+R.distanceEpsilon/2?n:null}ProcessVertexEvent(t){this.Z=this.GetZS(t),t instanceof jn?this.ProcessLeftVertex(t,t.Vertex.nextOnPolyline):t instanceof qn?this.ProcessRightVertex(t,t.Vertex.prevOnPolyline):(this.ProcessLeftVertex(t,t.Vertex.nextOnPolyline),this.ProcessRightVertex(t,t.Vertex.prevOnPolyline))}ProcessRightVertex(t,i){let n=t.Site;this.ProcessPrevSegmentForRightVertex(t,n);let o=i.point.sub(t.Site),a=o.dot(this.DirectionPerp),l=o.dot(this.SweepDirection);l<=R.distanceEpsilon?a>0&&l>=0?this.EnqueueEvent(new qn(i)):this.RestrictEdgeContainerToTheRightOfEvent(t.Vertex):(this.InsertRightSide(new Mo(t.Vertex)),this.EnqueueEvent(new qn(i)),this.RestrictEdgeContainerToTheRightOfEvent(t.Vertex))}RestrictEdgeContainerToTheRightOfEvent(t){let i=t.point,n=this.xProjection(i),o=this.edgeContainersTree.findFirst(a=>n<=this.xProjection(a.Source));if(o!=null)for(let a of o.item.Edges)this.NotRestricting(a,t.polyline)||a.BoundFromLeft(this.DirectionPerp.dot(i))}NotRestricting(t,i){return this.AxisEdgesToObstaclesTheyOriginatedFrom.get(t)===i}ProcessPrevSegmentForRightVertex(t,i){let n=t.Vertex.nextOnPolyline.point;i.sub(n).dot(this.SweepDirection)>R.distanceEpsilon&&this.RemoveRightSide(new Mo(t.Vertex.nextOnPolyline))}RemoveEdge(t){let i=this.GetAxisEdgesContainerNode(t.Source.point);i.item.RemoveAxis(t),i.item.IsEmpty()&&this.edgeContainersTree.deleteNodeInternal(i)}ProcessLeftVertex(t,i){let n=t.Site;this.ProcessPrevSegmentForLeftVertex(t,n);let o=i.point.sub(t.Site),a=o.dot(this.DirectionPerp),l=o.dot(this.SweepDirection);l<=R.distanceEpsilon?a<0&&l>=0&&this.EnqueueEvent(new jn(i)):(this.InsertLeftSide(new No(t.Vertex)),this.EnqueueEvent(new jn(i))),this.RestrictEdgeFromTheLeftOfEvent(t.Vertex)}RestrictEdgeFromTheLeftOfEvent(t){let i=t.point,n=this.GetContainerNodeToTheLeftOfEvent(i);if(n!=null)for(let o of n.item.Edges)this.NotRestricting(o,t.polyline)||o.BoundFromRight(i.dot(this.DirectionPerp))}GetContainerNodeToTheLeftOfEvent(t){let i=this.xProjection(t);return this.edgeContainersTree.findLast(n=>this.xProjection(n.Source)<=i)}ProcessPrevSegmentForLeftVertex(t,i){let n=t.Vertex.prevOnPolyline.point;i.sub(n).dot(this.SweepDirection)>R.distanceEpsilon&&this.RemoveLeftSide(new No(t.Vertex.prevOnPolyline))}InitTheQueueOfEvents(){this.InitQueueOfEvents();for(let t of this.AxisEdges)this.EnqueueEventsForEdge(t)}EnqueueEventsForEdge(t){this.EdgeIsParallelToSweepDir(t)&&(this.EnqueueEvent(Ta.EdgeLowPointEvent(t,t.Source.point)),this.EnqueueEvent(Ta.EdgeHighPointEvent(t,t.Target.point)))}EdgeIsParallelToSweepDir(t){return t.Direction===this.SweepPole||t.Direction===K.OppositeDir(this.SweepPole)}static EdgeHighPointEvent(t,i){return new vm(t,i)}static EdgeLowPointEvent(t,i){return new Ud(t,i)}CompareAA(t,i){return _e(t.Source.dot(this.DirectionPerp),i.Source.dot(this.DirectionPerp))}},zd=Ta;zd.AreaComparisonEpsilon=R.intersectionEpsilon;var Am=class extends ba{constructor(t){super();this.CompassDirection=0;this.edges=new Array;this._isFixed=!1;this.Id=-1;this.IdealPosition=0;this.Id=t}get Start(){return this.start}get End(){return this.end}get Edges(){return this.edges}AddEdge(t){if(this.Edges.length===0){let i=K.VectorDirectionPP(t.Source,t.Target);switch(i){case 4:i=1;break;case 8:i=2;break}this.CompassDirection=i,this.start=t.Source,this.end=t.Source}switch(this.CompassDirection){case 1:this.TryPointForStartAndEndNorth(t.Source),this.TryPointForStartAndEndNorth(t.Target);break;case 2:this.TryPointForStartAndEndEast(t.Source),this.TryPointForStartAndEndEast(t.Target);break}this.Edges.push(t)}TryPointForStartAndEndNorth(t){t.y<this.start.y?this.start=t:t.y>this.end.y&&(this.end=t)}TryPointForStartAndEndEast(t){t.x<this.start.x?this.start=t:t.x>this.end.x&&(this.end=t)}get IsFixed(){return this._isFixed}set IsFixed(t){this._isFixed=t}get Width(){let t=0;for(let i of this.edges)t=Math.max(t,i.Width);return t}GetLeftBound(){if(!this.IsFixed){let t=Number.NEGATIVE_INFINITY;for(let i of this.edges)t=Math.max(t,i.AxisEdge.LeftBound);return t}return this.CompassDirection===1?this.Edges[0].Source.x:-this.Edges[0].Source.y}GetRightBound(){if(!this.IsFixed){let t=Number.POSITIVE_INFINITY;for(let i of this.edges)t=Math.min(t,i.AxisEdge.RightBound);return t}return this.Position()}Position(){return this.CompassDirection===1?this.Edges[0].Source.x:-this.Edges[0].Source.y}};var Yi=class{constructor(e,t){this.tree=new dt((e,t)=>_e(e.Point.x,t.Point.x));this.VerticalPoints=t,this.HorizontalPoints=e}SplitPoints(){this.VerticalPoints.length===0||this.HorizontalPoints.length===0||(this.InitEventQueue(),this.ProcessEvents())}ProcessEvents(){for(;!this.Queue.IsEmpty();){let e={priority:0},t=this.Queue.DequeueAndGetPriority(e);this.ProcessEvent(t,e.priority)}}ProcessEvent(e,t){ue(e.Next.Point.x,e.Point.x)?t===Yi.Low(e)?this.ProcessLowLinkedPointEvent(e):this.ProcessHighLinkedPointEvent(e):this.IntersectWithTree(e)}IntersectWithTree(e){let t,i,n,o=e.Y;if(e.Point.x<e.Next.Point.x?(i=e.Point.x,t=e.Next.Point.x,n=!0):(t=e.Point.x,i=e.Next.Point.x,n=!1),n)for(let a=this.tree.findFirst(l=>i<=l.Point.x);a!=null&&a.item.Point.x<=t;a=this.tree.next(a)){let l=new m(a.item.Point.x,o);e=Yi.TrySplitHorizontalPoint(e,l,!0),Yi.TrySplitVerticalPoint(a.item,l)}else for(let a=this.tree.findLast(l=>l.Point.x<=t);a!=null&&a.item.Point.x>=i;a=this.tree.previous(a)){let l=new m(a.item.Point.x,o);e=Yi.TrySplitHorizontalPoint(e,l,!1),Yi.TrySplitVerticalPoint(a.item,l)}}static TrySplitVerticalPoint(e,t){Yi.Low(e)+R.distanceEpsilon<t.y&&t.y+R.distanceEpsilon<Yi.High(e)&&e.SetNewNext(t)}static TrySplitHorizontalPoint(e,t,i){return i&&e.X+R.distanceEpsilon<t.x&&t.x+R.distanceEpsilon<e.Next.X||!i&&e.Next.X+R.distanceEpsilon<t.x&&t.x+R.distanceEpsilon<e.X?(e.SetNewNext(t),e.Next):e}ProcessHighLinkedPointEvent(e){this.tree.remove(e)}ProcessLowLinkedPointEvent(e){this.tree.insert(e)}InitEventQueue(){this.Queue=new Er(_e);for(let e of this.VerticalPoints)this.Queue.Enqueue(e,Yi.Low(e));for(let e of this.HorizontalPoints)this.Queue.Enqueue(e,e.Point.y)}static Low(e){return Math.min(e.Point.y,e.Next.Point.y)}static High(e){return Math.max(e.Point.y,e.Next.Point.y)}};var Cs=class{constructor(e){this.verticesToPathOffsets=new Nt;this.Paths=e}MergePaths(){this.InitVerticesToPathOffsetsAndRemoveSelfCycles();for(let e of this.Paths)this.ProcessPath(e)}ProcessPath(e){let t=new Map,i=null;for(let n=e.PathPoints;n!=null;n=n.Next){let o=this.verticesToPathOffsets.get(n.Point);if(i!=null){if(t.size>0)for(let[a,l]of o){let u=t.get(a);u&&(this.CollapseLoopingPath(a,u,l,e,n),t.delete(a))}for(let[a,l]of i)o.has(a)||t.set(a,l)}i=o}}CollapseLoopingPath(e,t,i,n,o){let a=Cs.FindLinkedPointInPath(n,t.Point),l=Array.from(Cs.GetPointsInBetween(a,o));Cs.Before(t,i)?(this.CleanDisappearedPiece(t,i,e),this.ReplacePiece(t,i,l,e)):(this.CleanDisappearedPiece(i,t,e),this.ReplacePiece(i,t,l.reverse(),e))}static*GetPointsInBetween(e,t){for(let i=e.Next;i!==t;i=i.Next)yield i.Point}ReplacePiece(e,t,i,n){let o=e;for(let a of i){let l=new fi(a);o.Next=l,o=l,this.verticesToPathOffsets.get(a).set(n,o)}o.Next=t}CleanDisappearedPiece(e,t,i){for(let n of Cs.GetPointsInBetween(e,t))this.verticesToPathOffsets.get(n).delete(i)}static Before(e,t){for(e=e.Next;e!=null;e=e.Next)if(e===t)return!0;return!1}static FindLinkedPointInPath(e,t){for(let i=e.PathPoints;;i=i.Next)if(i.Point.equal(t))return i}InitVerticesToPathOffsetsAndRemoveSelfCycles(){for(let e of this.Paths)for(let t=e.PathPoints;t!=null;t=t.Next){let i=this.verticesToPathOffsets.get(t.Point);i||this.verticesToPathOffsets.set(t.Point,i=new Map);let n=i.get(e);n?(this.CleanDisappearedPiece(n,t,e),n.Next=t.Next):i.set(e,t)}}};var Tm=class{constructor(e){this.projection=e}compare(e,t){return _e(this.projection(e),this.projection(t))}};var Dc;(function(s){s.has=Symbol.for("@esfx/collection-core!ReadonlyCollection.has"),s.name="ReadonlyContainer";function e(t){return(typeof t=="object"&&t!==null||typeof t=="function")&&s.has in t}s.hasInstance=e})(Dc||(Dc={}));var Wd;(function(s){s.has=Dc.has,s.add=Symbol.for("@esfx/collection-core!Collection.add"),s.delete=Symbol.for("@esfx/collection-core!Collection.delete"),s.name="Container";function e(t){return Dc.hasInstance(t)&&s.add in t&&s.delete in t}s.hasInstance=e})(Wd||(Wd={}));var gi;(function(s){s.has=Dc.has,s.size=Symbol.for("@esfx/collection-core!ReadonlyCollection.size"),s.name="ReadonlyCollection";function e(t){return Dc.hasInstance(t)&&(typeof t=="object"&&t!==null||typeof t=="function")&&Symbol.iterator in t&&s.size in t}s.hasInstance=e})(gi||(gi={}));var Ut;(function(s){s.size=gi.size,s.has=gi.has,s.add=Wd.add,s.delete=Wd.delete,s.clear=Symbol.for("@esfx/collection-core!Collection.clear"),s.name="Collection";function e(t){return gi.hasInstance(t)&&Wd.hasInstance(t)&&s.clear in t}s.hasInstance=e})(Ut||(Ut={}));var Jl;(function(s){s.size=gi.size,s.has=gi.has,s.indexOf=Symbol.for("@esfx/collection-core!ReadonlyIndexedCollection.indexOf"),s.getAt=Symbol.for("@esfx/collection-core!ReadonlyIndexedCollection.getAt"),s.name="ReadonlyIndexedCollection";function e(t){return gi.hasInstance(t)&&s.indexOf in t&&s.getAt in t}s.hasInstance=e})(Jl||(Jl={}));var Im;(function(s){s.size=gi.size,s.has=gi.has,s.indexOf=Jl.indexOf,s.getAt=Jl.getAt,s.setAt=Symbol.for("@esfx/collection-core!FixedSizeIndexedCollection.setAt"),s.name="FixedSizeIndexedCollection";function e(t){return Jl.hasInstance(t)&&s.setAt in t}s.hasInstance=e})(Im||(Im={}));var WC;(function(s){s.size=gi.size,s.has=gi.has,s.indexOf=Jl.indexOf,s.getAt=Jl.getAt,s.setAt=Im.setAt,s.add=Ut.add,s.delete=Ut.delete,s.clear=Ut.clear,s.insertAt=Symbol.for("@esfx/collection-core!IndexedCollection.insertAt"),s.removeAt=Symbol.for("@esfx/collection-core!IndexedCollection.removeAt"),s.name="IndexedCollection";function e(t){return Im.hasInstance(t)&&s.insertAt in t&&s.removeAt in t}s.hasInstance=e})(WC||(WC={}));var Ia;(function(s){s.has=Symbol.for("@esfx/collection-core!ReadonlyKeyedContainer.has"),s.get=Symbol.for("@esfx/collection-core!ReadonlyKeyedContainer.get"),s.name="ReadonlyKeyedContainer";function e(t){return(typeof t=="object"&&t!==null||typeof t=="function")&&s.has in t&&s.get in t}s.hasInstance=e})(Ia||(Ia={}));var Hd;(function(s){s.has=Ia.has,s.get=Ia.get,s.set=Symbol.for("@esfx/collection-core!KeyedCollection.set"),s.delete=Symbol.for("@esfx/collection-core!KeyedCollection.delete"),s.name="KeyedContainer";function e(t){return Ia.hasInstance(t)&&s.set in t&&s.delete in t}s.hasInstance=e})(Hd||(Hd={}));var wi;(function(s){s.has=Ia.has,s.get=Ia.get,s.size=Symbol.for("@esfx/collection-core!ReadonlyKeyedCollection.size"),s.keys=Symbol.for("@esfx/collection-core!ReadonlyKeyedCollection.keys"),s.values=Symbol.for("@esfx/collection-core!ReadonlyKeyedCollection.values"),s.name="ReadonlyKeyedCollection";function e(t){return(typeof t=="object"&&t!==null||typeof t=="function")&&Symbol.iterator in t&&Ia.hasInstance(t)&&s.size in t&&s.keys in t&&s.values in t}s.hasInstance=e})(wi||(wi={}));var pi;(function(s){s.size=wi.size,s.has=wi.has,s.get=wi.get,s.keys=wi.keys,s.values=wi.values,s.set=Hd.set,s.delete=Hd.delete,s.clear=Symbol.for("@esfx/collection-core!KeyedCollection.clear"),s.name="KeyedCollection";function e(t){return wi.hasInstance(t)&&Hd.hasInstance(t)&&s.clear in t}s.hasInstance=e})(pi||(pi={}));var Kr;(function(s){s.size=Symbol.for("@esfx/collection-core!ReadonlyKeyedMultiCollection.size"),s.has=Symbol.for("@esfx/collection-core!ReadonlyKeyedMultiCollection.has"),s.hasValue=Symbol.for("@esfx/collection-core!ReadonlyKeyedMultiCollection.hasValue"),s.get=Symbol.for("@esfx/collection-core!ReadonlyKeyedMultiCollection.get"),s.keys=Symbol.for("@esfx/collection-core!ReadonlyKeyedMultiCollection.keys"),s.values=Symbol.for("@esfx/collection-core!ReadonlyKeyedMultiCollection.values"),s.name="ReadonlyKeyedMultiCollection";function e(t){return(typeof t=="object"&&t!==null||typeof t=="function")&&Symbol.iterator in t&&s.size in t&&s.has in t&&s.hasValue in t&&s.get in t&&s.keys in t&&s.values in t}s.hasInstance=e})(Kr||(Kr={}));var $l;(function(s){s.size=Kr.size,s.has=Kr.has,s.hasValue=Kr.hasValue,s.get=Kr.get,s.keys=Kr.keys,s.values=Kr.values,s.add=Symbol.for("@esfx/collection-core!KeyedMultiCollection.add"),s.delete=Symbol.for("@esfx/collection-core!KeyedMultiCollection.delete"),s.deleteValue=Symbol.for("@esfx/collection-core!KeyedMultiCollection.deleteValue"),s.clear=Symbol.for("@esfx/collection-core!KeyedMultiCollection.clear"),s.name="KeyedMultiCollection";function e(t){return Kr.hasInstance(t)&&s.add in t&&s.delete in t&&s.deleteValue in t&&s.clear in t}s.hasInstance=e})($l||($l={}));function HC(s,e,t,i){if(e%4)throw new TypeError("Pointer not aligned");let n=new Uint32Array(s),o,a,l,u,c,h,d;if(a=e+t,e>>=2,t>=16){l=a-16>>2,u=(i+2654435761|0)+2246822519|0,c=i+2246822519|0,h=i+0|0,d=i+2654435761|0;do u=u+n[e++]*2246822519|0|0,u=(u<<13|u>>>19)*2654435761|0,c=c+n[e++]*2246822519|0|0,c=(c<<13|c>>>19)*2654435761|0,h=h+n[e++]*2246822519|0|0,h=(h<<13|h>>>19)*2654435761|0,d=d+n[e++]*2246822519|0|0,d=(d<<13|d>>>19)*2654435761|0;while(e<=l);o=(u<<1|u>>>31)+(c<<7|c>>>25)|(h<<12|h>>>20)|(d<<18|d>>>14)}else o=i+374761393|0;for(o=o+t|0,l=a-4>>2;e<=l;)o=o+n[e++]*3266489917|0|0,o=(o<<17|o>>>15)*668265263|0;if(e=e<<2,e<a){let f=new Uint8Array(n.buffer);do o=o+f[e++]*374761393|0|0,o=(o<<11|o>>>21)*2654435761|0;while(e<a)}return o=(o^o>>>15)*2246822519|0,o=(o^o>>>13)*3266489917|0,o=o^o>>>16,o>>>0}var K_=typeof WebAssembly<"u"&&typeof WebAssembly.Module=="function"&&typeof WebAssembly.Instance=="function",Z_=new Uint8Array([0,97,115,109,1,0,0,0,1,8,1,96,3,127,127,126,1,126,3,2,1,0,5,3,1,0,1,7,15,2,3,109,101,109,2,0,5,120,120,104,54,52,0,0,10,130,6,1,255,5,2,3,126,1,127,32,0,32,1,106,33,6,32,1,65,32,79,4,126,32,6,65,32,107,33,6,32,2,66,214,235,130,238,234,253,137,245,224,0,124,33,3,32,2,66,177,169,172,193,173,184,212,166,61,125,33,4,32,2,66,249,234,208,208,231,201,161,228,225,0,124,33,5,3,64,32,3,32,0,41,3,0,66,207,214,211,190,210,199,171,217,66,126,124,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,33,3,32,4,32,0,65,8,106,34,0,41,3,0,66,207,214,211,190,210,199,171,217,66,126,124,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,33,4,32,2,32,0,65,8,106,34,0,41,3,0,66,207,214,211,190,210,199,171,217,66,126,124,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,33,2,32,5,32,0,65,8,106,34,0,41,3,0,66,207,214,211,190,210,199,171,217,66,126,124,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,33,5,32,6,32,0,65,8,106,34,0,79,13,0,11,32,2,66,12,137,32,5,66,18,137,124,32,4,66,7,137,124,32,3,66,1,137,124,32,3,66,207,214,211,190,210,199,171,217,66,126,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,133,66,135,149,175,175,152,182,222,155,158,127,126,66,157,163,181,234,131,177,141,138,250,0,125,32,4,66,207,214,211,190,210,199,171,217,66,126,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,133,66,135,149,175,175,152,182,222,155,158,127,126,66,157,163,181,234,131,177,141,138,250,0,125,32,2,66,207,214,211,190,210,199,171,217,66,126,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,133,66,135,149,175,175,152,182,222,155,158,127,126,66,157,163,181,234,131,177,141,138,250,0,125,32,5,66,207,214,211,190,210,199,171,217,66,126,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,133,66,135,149,175,175,152,182,222,155,158,127,126,66,157,163,181,234,131,177,141,138,250,0,125,5,32,2,66,197,207,217,178,241,229,186,234,39,124,11,32,1,173,124,33,2,32,0,32,1,65,31,113,106,33,1,3,64,32,1,32,0,65,8,106,79,4,64,32,0,41,3,0,66,207,214,211,190,210,199,171,217,66,126,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,32,2,133,66,27,137,66,135,149,175,175,152,182,222,155,158,127,126,66,157,163,181,234,131,177,141,138,250,0,125,33,2,32,0,65,8,106,33,0,12,1,11,11,32,0,65,4,106,32,1,77,4,64,32,2,32,0,53,2,0,66,135,149,175,175,152,182,222,155,158,127,126,133,66,23,137,66,207,214,211,190,210,199,171,217,66,126,66,249,243,221,241,153,246,153,171,22,124,33,2,32,0,65,4,106,33,0,11,3,64,32,0,32,1,73,4,64,32,2,32,0,49,0,0,66,197,207,217,178,241,229,186,234,39,126,133,66,11,137,66,135,149,175,175,152,182,222,155,158,127,126,33,2,32,0,65,1,106,33,0,12,1,11,11,32,2,32,2,66,33,136,133,66,207,214,211,190,210,199,171,217,66,126,34,2,66,29,136,32,2,133,66,249,243,221,241,153,246,153,171,22,126,34,2,66,32,136,32,2,133,11]),eu=K_?new WebAssembly.Instance(new WebAssembly.Module(Z_)).exports:void 0;var tu=eu===null||eu===void 0?void 0:eu.mem,j0=eu===null||eu===void 0?void 0:eu.xxh64;var $_=typeof TextEncoder=="function",jC=(s,e)=>(jC=eN())(s,e),q0=(s,e)=>jC(s,e);function eN(){function s(){let t=new TextEncoder;function i(n,o){let{written:a=0}=t.encodeInto(n,o);return a}return i}function e(){function t(i,n){let o=i.length,a=0;for(let l=0;l<o;l++){let u=i.charCodeAt(l);if((u&55296)!==0&&(u&4294910976)===0&&l<o-1){let c=i.charCodeAt(l+1);(c&64512)===56320&&(u=((u&1023)<<10)+(c&1023)+65536,l++)}if((u&4294967168)===0)n[a++]=u;else if((u&4294965248)===0)n[a++]=u>>6|192,n[a++]=u&63|128;else if((u&268431360)===0)n[a++]=u>>12|224,n[a++]=u>>6&63|128,n[a++]=u&63|128;else if((u&4292870144)===0)n[a++]=u>>18|240,n[a++]=u>>12&63|128,n[a++]=u>>6&63|128,n[a++]=u&63|128;else throw new RangeError("Unsupported charCode.")}return a}return t}return $_?s():e()}var X0=typeof BigInt=="function"&&typeof BigInt(0)=="bigint",qC=typeof BigUint64Array=="function",rN=typeof tu=="object"&&typeof j0=="function",Y0=new ArrayBuffer(8),iN=new Float64Array(Y0),As=new Uint32Array(Y0),Fc=()=>(Fc=nN())(),XC=s=>(XC=oN())(s),YC=s=>(YC=sN())(s),KC=s=>(KC=Fc())(s),ZC=s=>(ZC=aN())(s),QC=s=>(QC=lN())(s),JC=s=>XC(s),$C=s=>YC(s),eA=s=>KC(s),tA=s=>ZC(s),K0=s=>QC(s);function nN(){function s(){let t=new BigUint64Array(As.buffer),i=new Uint8Array(tu.buffer);function n(c){tu.buffer.byteLength<c&&(tu.grow(Math.ceil((c-tu.buffer.byteLength)/65536)),i=new Uint8Array(tu.buffer))}function o(c){t[0]=c;let h=As[0],d=As[1];return(h<<7|h>>>25)^d}function a(){return As[0]=wm(),As[1]=wm(),t[0]}function l(c,h){n(c.length*3);let d=q0(c,i);return o(j0(0,d,h))}function u(){let c=a();function h(d){return l(d,c)}return h}return u}function e(){let t=new Uint8Array(65536);function i(a){t.byteLength<a&&(t=new Uint8Array(a+(65536-a%65536)))}function n(a,l){i(a.length*3);let u=q0(a,t);return HC(t.buffer,0,u,l)>>0}function o(){let a=wm();function l(u){return n(u,a)}return l}return o}return X0&&qC&&rN?s():e()}function oN(){function s(t){iN[0]=t;let i=As[0],n=As[1];return(i<<7|i>>>25)^n|0}function e(t){return t>>0===t?t|0:s(t)}return e}function sN(){function s(){let i=new BigUint64Array(Y0),n=BigInt(0),o=BigInt(1),a=BigInt(2),l=BigInt(2)**BigInt(31)-BigInt(1),u=~l,c=BigInt(64);function h(d){if(d===n)return 0;if(d>=u&&d<=l)return Number(d);d=d<n?~d*a+o:d*a;let f=0;for(;d;)i[0]=d,f=(f<<7|f>>>25)^As[0],f=(f<<7|f>>>25)^As[1],d=d>>c;return f|0}return h}function e(){let i=BigInt(0),n=BigInt(1),o=BigInt(2),a=BigInt(2)**BigInt(31)-BigInt(1),l=~a,u=BigInt(32),c=BigInt("0xFFFFFFFF");function h(d){if(d===i)return 0;if(d>=l&&d<=a)return Number(d);d=d<i?~d*o+n:d*o;let f=0;for(;d!==i;)f=(f<<7|f>>>25)^Number(d&c),d>>=u,f=(f<<7|f>>>25)^Number(d&c),d>>=u;return f|0}return h}function t(){let i=Fc();function n(o){return i(o.toString())}return n}return X0&&qC?s():X0?e():t()}function aN(){let s="description"in Symbol.prototype?p=>p.description:p=>{let S=p.toString();return S.length>=8&&S.slice(0,7)==="Symbol("&&S.slice(-1)===")"?S.slice(7,-1):S},e=Fc(),t,i;try{new WeakMap().set(Symbol.iterator,null),t=new WeakMap,i=new WeakMap}catch{t=new Map,i=new Map}for(let p of Object.getOwnPropertyNames(Symbol))if(typeof p=="string"){let S=Symbol[p];typeof S=="symbol"&&i.set(S,`Symbol.${p}`)}let n=Fc(),o;try{new WeakMap().set(Symbol.for("@esfx/equatable!~globalSymbolTest"),null),o=new WeakMap}catch{o=new Map}let a=Fc(),l,u=1;try{new WeakMap().set(Symbol(),null),l=new WeakMap}catch{l=new Map}function c(p,S){let E=o.get(p);return E===void 0&&(E=n(S),o.set(p,E)),E}function h(p,S){let E=t.get(p);return E===void 0&&(E=e(S),t.set(p,E)),E}function d(p){let S=l.get(p);return S===void 0&&(S=a(`${u++}#${s(p)}`),l.set(p,S)),S}function f(p){let S=i.get(p);if(S!==void 0)return h(p,S);let E=Symbol.keyFor(p);return E!==void 0?c(p,E):d(p)}return f}function lN(){let s=new WeakMap,e=wm(),t=1;function i(o){return o=~o+(o<<15),o=o^o>>12,o=o+(o<<2),o=o^o>>4,o=o*2057,o=o^o>>16,o>>>0}function n(o){let a=s.get(o);return a===void 0&&(a=i(t++^e)^e,s.set(o,a)),a}return n}function wm(){return Math.floor(Math.random()*4294967295)>>>0}var Lm=typeof globalThis=="object"?globalThis:typeof global=="object"?global:typeof self=="object"?self:void 0,Z0=Symbol.for("@esfx/equatable!~hashUnknown"),Rm;Lm&&typeof Lm[Z0]=="function"?Rm=Lm[Z0]:(Rm=function(e){switch(typeof e){case"boolean":return e?1:0;case"number":return JC(e);case"bigint":return $C(e);case"string":return eA(e);case"symbol":return tA(e);case"function":return K0(e);case"object":return e===null?0:K0(e);case"undefined":return 0;default:throw new TypeError(`Unsupported type: ${typeof e}`)}},Object.defineProperty(Lm,Z0,{value:Rm}));function rA(s){return Rm(s)}var wa;(function(s){s.equals=Symbol.for("@esfx/equatable:Equatable.equals"),s.hash=Symbol.for("@esfx/equatable:Equatable.hash"),s.name="Equatable";function e(t){let i;return t!=null&&s.equals in(i=Object(t))&&s.hash in i}s.hasInstance=e,Object.defineProperty(s,Symbol.hasInstance,{configurable:!0,writable:!0,value:e})})(wa||(wa={}));var kc;(function(s){s.compareTo=Symbol.for("@esfx/equatable:Comparable.compareTo"),s.name="Comparable";function e(t){return t!=null&&s.compareTo in Object(t)}s.hasInstance=e,Object.defineProperty(s,Symbol.hasInstance,{configurable:!0,writable:!0,value:e})})(kc||(kc={}));var La;(function(s){s.structuralEquals=Symbol.for("@esfx/equatable:StructualEquatable.structuralEquals"),s.structuralHash=Symbol.for("@esfx/equatable:StructuralEquatable.structuralHash"),s.name="StructuralEquatable";function e(t){let i;return t!=null&&s.structuralEquals in(i=Object(t))&&s.structuralHash in i}s.hasInstance=e,Object.defineProperty(s,Symbol.hasInstance,{configurable:!0,writable:!0,value:e})})(La||(La={}));var Vc;(function(s){s.structuralCompareTo=Symbol.for("@esfx/equatable:StructuralComparable.structuralCompareTo"),s.name="StructuralComparable";function e(t){return t!=null&&s.structuralCompareTo in Object(t)}s.hasInstance=e,Object.defineProperty(s,Symbol.hasInstance,{configurable:!0,writable:!0,value:e})})(Vc||(Vc={}));var _r;(function(s){let e=Object.defineProperty({},Symbol.toStringTag,{configurable:!0,value:"Equaler"});s.defaultEqualer=t((o,a)=>wa.hasInstance(o)?o[wa.equals](a):wa.hasInstance(a)?a[wa.equals](o):Object.is(o,a),o=>wa.hasInstance(o)?o[wa.hash]():cN(o)),s.structuralEqualer=t((o,a)=>La.hasInstance(o)?o[La.structuralEquals](a,s.structuralEqualer):La.hasInstance(a)?a[La.structuralEquals](o,s.structuralEqualer):s.defaultEqualer.equals(o,a),o=>La.hasInstance(o)?o[La.structuralHash](s.structuralEqualer):s.defaultEqualer.hash(o)),s.tupleEqualer=t((o,a)=>{if(o!=null&&!Array.isArray(o)||a!=null&&!Array.isArray(a))throw new TypeError("Array expected");if(o===a)return!0;if(!o||!a||o.length!==a.length)return!1;for(let l=0;l<o.length;l++)if(!s.defaultEqualer.equals(o[l],a[l]))return!1;return!0},o=>{if(o==null)return 0;if(!Array.isArray(o))throw new TypeError("Array expected");let a=0;for(let l of o)a=i(a,s.defaultEqualer.hash(l));return a}),s.tupleStructuralEqualer=t((o,a)=>{if(o!=null&&!Array.isArray(o)||a!=null&&!Array.isArray(a))throw new TypeError("Array expected");if(o===a)return!0;if(!o||!a||o.length!==a.length)return!1;for(let l=0;l<o.length;l++)if(!s.structuralEqualer.equals(o[l],a[l]))return!1;return!0},o=>{if(o==null)return 0;if(!Array.isArray(o))throw new TypeError("Array expected");let a=0;for(let l of o)a=i(a,s.structuralEqualer.hash(l));return a});function t(o,a=s.defaultEqualer.hash){return Object.setPrototypeOf({equals:o,hash:a},e)}s.create=t;function i(o,a,l=7){if(typeof o!="number")throw new TypeError("Integer expected: x");if(typeof a!="number")throw new TypeError("Integer expected: y");if(typeof l!="number")throw new TypeError("Integer expected: rotate");if(isNaN(o)||!isFinite(o))throw new RangeError("Argument must be a finite number value: x");if(isNaN(a)||!isFinite(a))throw new RangeError("Argument must be a finite number value: y");if(isNaN(l)||!isFinite(l))throw new RangeError("Argument must be a finite number value: rotate");for(;l<0;)l+=32;for(;l>=32;)l-=32;return(o<<l|o>>>32-l)^a}s.combineHashes=i;function n(o){return typeof o=="object"&&o!==null&&typeof o.equals=="function"&&typeof o.hash=="function"}s.hasInstance=n,Object.defineProperty(s,Symbol.hasInstance,{configurable:!0,writable:!0,value:n})})(_r||(_r={}));var _K=_r.defaultEqualer,NK=_r.structuralEqualer,MK=_r.tupleEqualer,BK=_r.tupleEqualer,DK=_r.combineHashes,xn;(function(s){let e=Object.defineProperty({},Symbol.toStringTag,{configurable:!0,value:"Comparer"});s.defaultComparer=t((n,o)=>kc.hasInstance(n)?n[kc.compareTo](o):kc.hasInstance(o)?-o[kc.compareTo](n):n<o?-1:n>o?1:0),s.structuralComparer=t((n,o)=>Vc.hasInstance(n)?n[Vc.structuralCompareTo](o,s.structuralComparer):Vc.hasInstance(o)?-o[Vc.structuralCompareTo](n,s.structuralComparer):s.defaultComparer.compare(n,o)),s.tupleComparer=t((n,o)=>{if(n!=null&&!Array.isArray(n)||o!=null&&!Array.isArray(o))throw new TypeError("Array expected");let a;if(a=s.defaultComparer.compare(n.length,o.length))return a;for(let l=0;l<n.length;l++)if(a=s.defaultComparer.compare(n[l],o[l]))return a;return 0}),s.tupleStructuralComparer=t((n,o)=>{if(n!=null&&!Array.isArray(n)||o!=null&&!Array.isArray(o))throw new TypeError("Array expected");let a;if(a=s.defaultComparer.compare(n.length,o.length))return a;for(let l=0;l<n.length;l++)if(a=s.structuralComparer.compare(n[l],o[l]))return a;return 0});function t(n){return Object.setPrototypeOf({compare:n},e)}s.create=t;function i(n){return typeof n=="object"&&n!==null&&typeof n.compare=="function"}s.hasInstance=i,Object.defineProperty(s,Symbol.hasInstance,{configurable:!0,writable:!0,value:i})})(xn||(xn={}));var GK=xn.defaultComparer,FK=xn.structuralComparer,kK=xn.tupleComparer,VK=xn.tupleStructuralComparer;function cN(s){return rA(s)}var iA,Om=function(){var s={exports:{}};return function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});function n(o,a,l){if(o.length===0)return-1;let u=0,c=o.length-1;for(;u<=c;){let h=u+(c-u>>1),d=o[h];switch(Math.sign(l.compare(d,a))){case-1:u=h+1;break;case 0:return h;case 1:c=h-1;break}}return~u}t.binarySearch=n}(s,s.exports,null),s.exports}(),ko=class{constructor(...e){this._keys=[],this._values=[];let t,i;if(e.length>0){let n=e[0];n===void 0||n!=null&&Symbol.iterator in Object(n)?(t=n,e.length>1&&(i=e[1])):i=n}if(i??(i=xn.defaultComparer),this._comparer=typeof i=="function"?xn.create(i):i,t)for(let[n,o]of t)this.set(n,o)}get comparer(){return this._comparer}get size(){return this._keys.length}has(e){return(0,Om.binarySearch)(this._keys,e,this._comparer)>=0}get(e){let t=(0,Om.binarySearch)(this._keys,e,this._comparer);return t>=0?this._values[t]:void 0}set(e,t){let i=(0,Om.binarySearch)(this._keys,e,this._comparer);return i>=0?this._values[i]=t:(this._keys.splice(~i,0,e),this._values.splice(~i,0,t)),this}delete(e){let t=(0,Om.binarySearch)(this._keys,e,this._comparer);return t>=0?(this._keys.splice(t,1),this._values.splice(t,1),!0):!1}clear(){this._keys.length=0,this._values.length=0}keys(){return this._keys.values()}values(){return this._values.values()}*entries(){for(let e=0;e<this._keys.length;e++)yield[this._keys[e],this._values[e]]}[Symbol.iterator](){return this.entries()}forEach(e,t){if(typeof e!="function")throw new TypeError("Function expected: callback");for(let[i,n]of this)e.call(t,n,i,this)}get[pi.size](){return this.size}[pi.has](e){return this.has(e)}[pi.get](e){return this.get(e)}[pi.set](e,t){this.set(e,t)}[pi.delete](e){return this.delete(e)}[pi.clear](){this.clear()}[pi.keys](){return this.keys()}[pi.values](){return this.values()}};iA=ko;Object.defineProperty(iA.prototype,Symbol.toStringTag,{configurable:!0,writable:!0,value:"SortedMap"});var ur=class{static RefinePaths(e,t){ur.AdjustPaths(e);let i=ur.CreatePathsToFirstLinkedVerticesMap(e);ur.Refine(Array.from(i.values())),ur.CrossVerticalAndHorizontalSegs(i.values()),ur.ReconstructPathsFromLinkedVertices(i),t&&new Cs(e).MergePaths()}static AdjustPaths(e){for(let t of e)t.PathPoints=ur.AdjustPathPoints(t.PathPoints)}static AdjustPathPoints(e){if(!e||e.length===0)return;let t=[],i=m.RoundPoint(e[0]);t.push(i);for(let n=1;n<e.length;n++){let o=m.RoundPoint(e[n]);i.equal(o)||(i=o,t.push(i))}return t}static CrossVerticalAndHorizontalSegs(e){let t=new Array,i=new Array;for(let n of e)for(let o=n;o.Next!=null;o=o.Next)ue(o.Point.x,o.Next.Point.x)?i.push(o):t.push(o);new Yi(t,i).SplitPoints()}static ReconstructPathsFromLinkedVertices(e){for(let[t,i]of e)t.PathPoints=i}static Refine(e){ur.RefineInDirection(1,e),ur.RefineInDirection(2,e)}static*groupByProj(e,t){let i=new Map;for(let n of t){let o=e(n.Point),a=i.get(o);a||(a=new Array,i.set(o,a)),a.push(n)}for(let n of i.values())yield n}static RefineInDirection(e,t){let i={projectionToPerp:void 0,projectionToDirection:void 0};ur.GetProjectionsDelegates(e,i);let n=Array.from(ur.GetAllLinkedVertsInDirection(i.projectionToPerp,t)),o=ur.groupByProj(i.projectionToPerp,n);for(let a of o)ur.RefineCollinearBucket(a,i.projectionToDirection)}static GetProjectionsDelegates(e,t){e===2?(t.projectionToDirection=i=>i.x,t.projectionToPerp=i=>i.y):(t.projectionToPerp=i=>i.x,t.projectionToDirection=i=>i.y)}static*GetAllLinkedVertsInDirection(e,t){for(let i of t)for(let n=i;n.Next!=null;n=n.Next)ue(e(n.Point),e(n.Next.Point))&&(yield n)}static RefineCollinearBucket(e,t){let i=new ko(new Tm(t));for(let a of e)i.has(a.Point)||i.set(a.Point,0),i.has(a.Next.Point)||i.set(a.Next.Point,0);let n=new Array(i.size),o=0;for(let a of i.keys())n[o++]=a;for(o=0;o<n.length;o++)i.set(n[o],o);for(let a of e){o=i.get(a.Point);let l=i.get(a.Next.Point);Math.abs(l-o)>1&&ur.InsertPoints(a,n,o,l)}}static InsertPoints(e,t,i,n){i<n?e.InsertVerts(i,n,t):e.InsertVertsInReverse(n,i,t)}static CreatePathsToFirstLinkedVerticesMap(e){let t=new Map;for(let i of e)t.set(i,ur.CreateLinkedVertexOfEdgePath(i));return t}static CreateLinkedVertexOfEdgePath(e){let t=e.PathPoints,i=new fi(t[0]),n=i;for(let o=1;o<t.length;o++)i.Next=new fi(t[o]),i=i.Next;return n}};var Vo=class{constructor(e,t){this.Points=e,this.I=t}static equal(e,t){return e.I===t.I&&e.Points===t.Points}get Start(){return this.Points[this.I]}get End(){return this.Points[this.I+1]}};var Uo=class{constructor(e,t){this.segTree=new Lo(null);this.crossedOutPaths=new Set;this.HierarchyOfObstacles=new Lo(t),this.Paths=e}static RemoveStaircases(e,t){new Uo(e,t).Calculate()}Calculate(){this.InitHierarchies();let e;do{e=!1;for(let t of this.Paths.filter(i=>!this.crossedOutPaths.has(i)))this.ProcessPath(t)&&(e=!0)}while(e)}ProcessPath(e){let t={pts:e.PathPoints,canHaveStaircase:!1};return this.ProcessPoints(t)?(e.PathPoints=t.pts,!0):(t.canHaveStaircase||this.crossedOutPaths.add(e),!1)}ProcessPoints(e){let t=this.FindStaircaseStart(e);return t<0?!1:(e.pts=this.RemoveStaircasePN(e.pts,t),!0)}FindStaircaseStart(e){if(e.canHaveStaircase=!1,e.pts.length<5)return-1;let t=[new Vo(e.pts,0),new Vo(e.pts,1),new Vo(e.pts,2),new Vo(e.pts,3)],i=0;for(let n=0;;){let o={canHaveStaircaseAtI:!1};if(this.IsStaircase(e.pts,n,t,o))return e.canHaveStaircase=!0,n;if(e.canHaveStaircase=e.canHaveStaircase||o.canHaveStaircaseAtI,n++,e.pts.length<n+5)return-1;t[i]=new Vo(e.pts,n+3),i++,i%=4}}static GetFlippedPoint(e,t){return ue(e[t].y,e[t+1].y)?new m(e[t+4].x,e[t].y):new m(e[t].x,e[t+4].y)}Crossing(e,t,i){return Uo.IsCrossing(k.mkPP(e,t),this.segTree,i)}static IsCrossing(e,t,i){for(let n of t.GetAllIntersecting(e.boundingBox))if(i.findIndex(o=>o===n)===-1)return!0;return!1}IntersectObstacleHierarchyPPP(e,t,i){return this.IntersectObstacleHierarchyL(k.mkPP(e,t))||this.IntersectObstacleHierarchyL(k.mkPP(t,i))}IntersectObstacleHierarchyL(e){return this.HierarchyOfObstacles.GetAllIntersecting(e.boundingBox).some(t=>I.intersectionOne(e,t,!1)!=null)}IsStaircase(e,t,i,n){let o=e[t],a=e[t+1],l=e[t+2],u=e[t+3],c=e[t+4];return n.canHaveStaircaseAtI=!1,K.DirectionFromPointToPoint(o,a)!==K.DirectionFromPointToPoint(l,u)||K.DirectionFromPointToPoint(a,l)!==K.DirectionFromPointToPoint(u,c)||(l=Uo.GetFlippedPoint(e,t),this.IntersectObstacleHierarchyPPP(a,l,u))?!1:(n.canHaveStaircaseAtI=!0,!this.Crossing(a,l,i))}RemoveStaircasePN(e,t){let i=e[t],n=e[t+1],o=Math.abs(i.y-n.y)<R.distanceEpsilon/2;return this.RemoveStaircasePNB(e,t,o)}RemoveStaircasePNB(e,t,i){this.RemoveSegs(e);let n=new Array(e.length-2);dN(e,n,t+1);let o=e[t+1],a=e[t+3];return n[t+1]=i?new m(a.x,o.y):new m(o.x,a.y),hN(e,t+4,n,t+2,n.length-t-2),this.InsertNewSegs(n,t),n}RemoveSegs(e){for(let t=0;t<e.length-1;t++)this.RemoveSeg(new Vo(e,t))}RemoveSeg(e){this.segTree.Remove(Uo.Rect(e),e)}InsertNewSegs(e,t){this.InsSeg(e,t),this.InsSeg(e,t+1)}InitHierarchies(){for(let e of this.Paths)this.InsertPathSegs(e)}InsertPathSegs(e){this.InsertSegs(e.PathPoints)}InsertSegs(e){for(let t=0;t<e.length-1;t++)this.InsSeg(e,t)}InsSeg(e,t){let i=new Vo(e,t);this.segTree.Add(Uo.Rect(i),i)}static Rect(e){return X.mkPP(e.Start,e.End)}};function hN(s,e,t,i,n){for(;n-- >0;)t[i++]=s[e++]}function dN(s,e,t){let i=0;for(;t-- >0;)e[i++]=s[i++]}var st=class{get HasGroups(){return this.HierarchyOfGroups!=null&&this.HierarchyOfGroups.Count>0}constructor(e,t,i,n){this.AncestorsSets=n,this.HierarchyOfGroups=tt(Array.from(n.keys()).filter(o=>o.IsGroup).map(o=>ct(o,o.BoundingBox))),this.Obstacles=i,this.EdgeSeparation=2*t,this.Paths=e,this.HierarchyOfObstacles=tt(i.map(o=>ct(o,o.boundingBox))),this.MapPathsToTheirObstacles()}MapPathsToTheirObstacles(){this.PathToObstacles=new Map;for(let e of this.Paths)this.MapPathToItsObstacles(e)}MapPathToItsObstacles(e){if(!e.PathPoints||e.PathPoints.length===0)return;let t=e.PathPoints,i=this.HierarchyOfObstacles.FirstHitNodeWithPredicate(t[0],st.ObstacleTest),n=this.HierarchyOfObstacles.FirstHitNodeWithPredicate(t[t.length-1],st.ObstacleTest);i!=null&&n!=null&&this.PathToObstacles.set(e,[i.UserData,n.UserData])}static ObstacleTest(e,t){return I.PointRelativeToCurveLocation(e,t)!==0?1:0}Calculate(e,t){this.NudgingDirection=e,ur.RefinePaths(this.Paths,t),this.GetPathOrdersAndPathGraph(),this.MapAxisEdgesToTheirObstacles(),this.DrawPaths()}MapAxisEdgesToTheirObstacles(){this.axisEdgesToObstaclesTheyOriginatedFrom=new Map;for(let e of this.Paths)this.MapPathEndAxisEdgesToTheirObstacles(e);for(let e of this.Paths)this.UmmapPathInteriourFromStrangerObstacles(e)}UmmapPathInteriourFromStrangerObstacles(e){let t=this.FindFirstUnmappedEdge(e);if(t==null)return;let i=this.FindLastUnmappedEdge(e);for(let n=t;n!=null&&n!==i;n=n.Next)this.axisEdgesToObstaclesTheyOriginatedFrom.delete(n.AxisEdge)}FindLastUnmappedEdge(e){for(let t=e.LastEdge;t!=null;t=t.Prev)if(t.AxisEdge.Direction!==this.NudgingDirection)return t;return null}FindFirstUnmappedEdge(e){for(let t=e.FirstEdge;t!=null;t=t.Next)if(t.AxisEdge.Direction!==this.NudgingDirection)return t;return null}MapPathEndAxisEdgesToTheirObstacles(e){let t=this.PathToObstacles.get(e);t&&(this.ProcessThePathStartToMapAxisEdgesToTheirObstacles(e,t[0]),this.ProcessThePathEndToMapAxisEdgesToTheirObstacles(e,t[1]))}ProcessThePathEndToMapAxisEdgesToTheirObstacles(e,t){for(let i=e.LastEdge;i!=null&&K.DirectionsAreParallel(i.Direction,this.NudgingDirection);i=i.Prev)this.axisEdgesToObstaclesTheyOriginatedFrom.set(i.AxisEdge,t)}ProcessThePathStartToMapAxisEdgesToTheirObstacles(e,t){for(let i=e.FirstEdge;i!=null&&K.DirectionsAreParallel(i.Direction,this.NudgingDirection);i=i.Next)this.axisEdgesToObstaclesTheyOriginatedFrom.set(i.AxisEdge,t)}GetPathOrdersAndPathGraph(){let e=new Vd(this.Paths);this.PathOrders=e.GetOrder(),this.PathVisibilityGraph=e.PathVisibilityGraph}static GetCurvesForShow(e,t){let i=new Array;for(let n of e){let o=new ne;for(let a of n.PathPoints)o.addPoint(a);i.push(o)}return i.concat(Array.from(t))}DrawPaths(){this.SetWidthsOfArrowheads(),this.CreateLongestNudgedSegments(),this.FindFreeSpaceInDirection(Array.from(this.PathVisibilityGraph.Edges)),this.MoveLongestSegsIdealPositionsInsideFeasibleIntervals(),this.PositionShiftedEdqges()}SetWidthsOfArrowheads(){for(let e of this.Paths)st.SetWidthsOfArrowheadsForEdge(e)}static SetWidthsOfArrowheadsForEdge(e){let t=e.GeomEdge;if(t.targetArrowhead!=null){let i=e.LastEdge;i.Width=Math.max(t.targetArrowhead.width,i.Width)}if(t.sourceArrowhead!=null){let i=e.FirstEdge;i.Width=Math.max(t.sourceArrowhead.width,i.Width)}}PositionShiftedEdqges(){this.Solver=new Em(this.EdgeSeparation);for(let e=0;e<this.LongestNudgedSegs.length;e++)this.CreateVariablesOfLongestSegment(this.LongestNudgedSegs[e]);this.CreateConstraintsOfTheOrder(),this.CreateConstraintsBetweenLongestSegments(),this.Solver.SolveByRegularSolver(),this.ShiftPathEdges()}MoveLongestSegsIdealPositionsInsideFeasibleIntervals(){for(let e=0;e<this.LongestNudgedSegs.length;e++){let t=this.LongestNudgedSegs[e];st.MoveLongestSegIdealPositionsInsideFeasibleInterval(t)}}static MoveLongestSegIdealPositionsInsideFeasibleInterval(e){if(e.IsFixed)return;let t=e.GetLeftBound(),i=e.GetRightBound();e.IdealPosition<t?e.IdealPosition=t:e.IdealPosition>i&&(e.IdealPosition=i)}ShiftPathEdges(){for(let e of this.Paths)e.PathPoints=this.GetShiftedPoints(e)}GetShiftedPoints(e){return st.RemoveSwitchbacksAndMiddlePoints(this.GetShiftedPointsSimple(e))}static Rectilinearise(e,t){if(e.x===t.x||e.y===t.y)return t;let i=Math.abs(e.x-t.x),n=Math.abs(e.y-t.y);return i<n?new m(e.x,t.y):new m(t.x,e.y)}GetShiftedPointsSimple(e){let t=[],i=e.FirstEdge;t.push(this.ShiftedPoint(i.Source,i.LongestNudgedSegment));for(let n of e.PathEdges())t.push(this.ShiftedEdgePositionOfTarget(n));return t}ShiftedEdgePositionOfTarget(e){return e.LongestNudgedSegment!=null||e.Next==null?this.ShiftedPoint(e.Target,e.LongestNudgedSegment):this.ShiftedPoint(e.Next.Source,e.Next.LongestNudgedSegment)}ShiftedPoint(e,t){if(t==null)return e;let i=this.Solver.GetVariablePosition(t.Id);return this.NudgingDirection===1?new m(i,e.y):new m(e.x,-i)}static LineSegOfLongestSeg(e,t){let i=t===2?o=>o.x:o=>o.y,n={min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY};for(let o of e.Edges)st.UpdateMinMaxWithPoint(n,i,o.Source),st.UpdateMinMaxWithPoint(n,i,o.Target);return t===2?new k(n.min,-e.IdealPosition,n.max,-e.IdealPosition):new k(e.IdealPosition,n.min,e.IdealPosition,n.max)}static UpdateMinMaxWithPoint(e,t,i){let n=t(i);e.min>n&&(e.min=n),e.max<n&&(e.max=n)}CreateConstraintsBetweenLongestSegments(){for(let e of this.LongestNudgedSegs)this.CreateConstraintsBetweenLongestSegmentsForSegment(e)}CreateConstraintsBetweenLongestSegmentsForSegment(e){let t=new Set;for(let i of e.Edges){let n=i.AxisEdge;if(n!=null)for(let o of n.RightNeighbors)for(let a of o.LongestNudgedSegments)t.add(a)}for(let i of t)this.ConstraintTwoLongestSegs(e,i)}CreateConstraintsOfTheOrder(){for(let e of this.PathOrders)st.ParallelToDirection(e[0],this.NudgingDirection)&&this.CreateConstraintsOfThePathOrder(e[1])}static ParallelToDirection(e,t){switch(t){case 1:case 4:return ue(e.SourcePoint.x,e.TargetPoint.x);default:return ue(e.SourcePoint.y,e.TargetPoint.y)}}CreateConstraintsOfThePathOrder(e){let t=null;for(let i of e.filter(n=>n.LongestNudgedSegment!=null))t!=null&&this.ConstraintTwoLongestSegs(t.LongestNudgedSegment,i.LongestNudgedSegment),t=i}ConstraintTwoLongestSegs(e,t){(!e.IsFixed||!t.IsFixed)&&this.Solver.AddConstraint(e.Id,t.Id)}CreateVariablesOfLongestSegment(e){if(e.IsFixed)this.Solver.AddFixedVariable(e.Id,st.SegmentPosition(e,this.NudgingDirection));else{let t=e.GetLeftBound(),i=e.GetRightBound();t>=i?(this.Solver.AddFixedVariable(e.Id,st.SegmentPosition(e,this.NudgingDirection)),e.IsFixed=!0):(this.Solver.AddVariableNNNN(e.Id,st.SegmentPosition(e,this.NudgingDirection),e.IdealPosition,e.Width),t!==Number.NEGATIVE_INFINITY&&this.Solver.SetLowBound(t,e.Id),i!==Number.POSITIVE_INFINITY&&this.Solver.SetUpperBound(e.Id,i))}}static SegmentPosition(e,t){return t===1?e.Start.x:-e.Start.y}FindFreeSpaceInDirection(e){this.BoundAxisEdgesByRectsKnownInAdvance(),new zd(this.NudgingDirection,this.Obstacles,this.axisEdgesToObstaclesTheyOriginatedFrom,this.PathOrders,e).FindFreeSpace()}BoundAxisEdgesByRectsKnownInAdvance(){for(let e of this.Paths)this.HasGroups&&this.BoundPathByMinCommonAncestors(e),this.BoundAxisEdgesAdjacentToSourceAndTargetOnEdge(e)}BoundPathByMinCommonAncestors(e){for(let t of this.GetMinCommonAncestors(e.GeomEdge)){let i=t.BoundingBox;for(let n of e.PathEdges()){let o=n.AxisEdge;o.Direction===this.NudgingDirection&&this.BoundAxisEdgeByRect(i,o)}}}GetMinCommonAncestors(e){this.PortToShapes==null&&(this.PortToShapes=st.MapPortsToShapes(this.AncestorsSets.keys()));let t=fN(this.AncestorsForPort(e.sourcePort),this.AncestorsForPort(e.targetPort));return Array.from(t).filter(i=>!i.Children.some(n=>t.has(n)))}AncestorsForPort(e){let t=this.PortToShapes.get(e);return t?this.AncestorsSets.get(t):new Set(this.HierarchyOfGroups.AllHitItems(X.mkPP(e.Location,e.Location),null))}BoundAxisEdgeAdjacentToObstaclePort(e,t){e.Curve==null?this.BoundAxisByPoint(e.Location,t):e.Curve.boundingBox.contains(e.Location)&&this.BoundAxisEdgeByRect(e.Curve.boundingBox,t)}BoundAxisByPoint(e,t){t!=null&&t.Direction===this.NudgingDirection&&(this.NudgingDirection===1?(t.BoundFromLeft(e.x),t.BoundFromRight(e.x)):(t.BoundFromLeft(-e.y),t.BoundFromRight(-e.y)))}BoundAxisEdgesAdjacentToSourceAndTargetOnEdge(e){this.BoundAxisEdgeAdjacentToObstaclePort(e.GeomEdge.sourcePort,e.FirstEdge.AxisEdge),this.BoundAxisEdgeAdjacentToObstaclePort(e.GeomEdge.targetPort,e.LastEdge.AxisEdge)}BoundAxisEdgeByRect(e,t){t!=null&&t.Direction===this.NudgingDirection&&(this.NudgingDirection===1?(t.BoundFromLeft(e.left),t.BoundFromRight(e.right)):(t.BoundFromLeft(e.top*-1),t.BoundFromRight(e.bottom*-1)))}CreateLongestNudgedSegments(){let e=this.NudgingDirection===2?t=>-t.y:t=>t.x;this.LongestNudgedSegs=new Array;for(let t=0;t<this.Paths.length;t++)this.CreateLongestNudgedSegmentsForPath(this.Paths[t],e)}CreateLongestNudgedSegmentsForPath(e,t){this.GoOverPathAndCreateLongSegs(e),st.CalculateIdealPositionsForLongestSegs(e,t)}static CalculateIdealPositionsForLongestSegs(e,t){let i=null,n=null,o=t(e.Start);for(let a of e.PathEdges())if(a.LongestNudgedSegment!=null){if(i=a.LongestNudgedSegment,n!=null){let l;st.SetIdealPositionForSeg(n,l=t(n.start),o,t(i.Start)),o=l,n=null}}else i!=null&&(n=i,i=null);n!=null?st.SetIdealPositionForSeg(n,t(n.Start),o,t(e.End)):i!=null&&(i.IdealPosition=t(i.Start))}static SetIdealPositionForSeg(e,t,i,n){let o=Math.max(i,n),a=Math.min(i,n);a+R.distanceEpsilon<t?t<o?e.IdealPosition=.5*(o+a):e.IdealPosition=o:e.IdealPosition=a}GoOverPathAndCreateLongSegs(e){let t=null,i=K.OppositeDir(this.NudgingDirection);for(let n of e.PathEdges()){let o=n.Direction;o===this.NudgingDirection||o===i?(t==null?(n.LongestNudgedSegment=t=new Am(this.LongestNudgedSegs.length),this.LongestNudgedSegs.push(t)):n.LongestNudgedSegment=t,n.IsFixed&&(t.IsFixed=!0)):(n.LongestNudgedSegment=null,t=null)}}static BuildPolylineForPath(e){let t={points:e.PathPoints.map(i=>i.clone())};return st.ExtendPolylineToPorts(t,e),t.points}static ExtendPolylineToPorts(e,t){st.ExtendPolylineToSourcePort(e,t.GeomEdge.sourcePort.Location),st.ExtendPolylineToTargetPort(e,t.GeomEdge.targetPort.Location),e.points.length<2&&(e.points=new Array(2),e.points[0]=t.GeomEdge.sourcePort.Location,e.points[1]=t.GeomEdge.targetPort.Location)}static ExtendPolylineToTargetPort(e,t){let i=e.points.length-1,n=K.VectorDirectionPP(e.points[i-1],e.points[i]);if(st.ProjectionsAreClose(e.points[i-1],n,t)){e.points=e.points.slice(0,i);return}let o=e.points[i];n===2||n===8?e.points[i]=new m(t.x,o.y):e.points[i]=new m(o.x,t.y)}static ProjectionsAreClose(e,t,i){return t===2||t===8?ue(e.x,i.x):ue(e.y,i.y)}static ExtendPolylineToSourcePort(e,t){let i=K.VectorDirectionPP(e.points[0],e.points[1]);if(st.ProjectionsAreClose(e.points[1],i,t)){e.points=e.points.slice(1);return}let n=e.points[0];i===2||i===8?e.points[0]=new m(t.x,n.y):e.points[0]=new m(n.x,t.y)}static RemoveSwitchbacksAndMiddlePoints(e){let t=[],i=e[0];t.push(i);let n=e[1],o=K.VectorDirectionPP(i,n),a=1;for(;++a<e.length;){let l=K.VectorDirectionPP(n,e[a]);l===o||K.OppositeDir(l)===o||l===0||(m.closeDistEps(i,n)||t.push(i=st.Rectilinearise(i,n)),o=l),n=e[a]}return m.closeDistEps(i,n)||t.push(st.Rectilinearise(i,n)),t}static NudgePaths(e,t,i,n,o){if(e.length===0)return;let a=new st(e,t,i,n);a.Calculate(1,!0),a.Calculate(2,!1),a.Calculate(1,!1),o&&a.RemoveStaircases();for(let l of e)l.GeomEdge.curve=ne.mkFromPoints(st.BuildPolylineForPath(l))}RemoveStaircases(){Uo.RemoveStaircases(this.Paths,this.HierarchyOfObstacles)}static MapPortsToShapes(e){let t=new Map;for(let i of e)for(let n of i.Ports)t.set(n,i);return t}static*GetEdgePathFromPathEdgesAsDebugCurves(e,t,i,n){let o=n.ArrayOfPathPoints(),a=o.length,l=a>1?(t-e)/(a-1):1;for(let u=0;u<o.length-1;u++)yield Ie.mkDebugCurveTWCI(200,e+l*u,i,k.mkPP(o[u],o[u+1]))}};function fN(s,e){let t=new Set;if(s.size<e.size)for(let i of s)e.has(i)&&t.add(i);else for(let i of e)s.has(i)&&t.add(i);return t}var nA=Ae(sr(),1);var _m=class{constructor(e,t){this.Crossings=[];this.Location=e,this.Crossings=t}};var zo=class{constructor(){this.ListOfPointsAndCrossings=[];this.index=0;this.ListOfPointsAndCrossings=new Array}Count(){return this.ListOfPointsAndCrossings.length}Add(e,t){this.ListOfPointsAndCrossings.push(new _m(e,t))}Pop(){return this.ListOfPointsAndCrossings[this.index++]}CurrentIsBeforeOrAt(e){return this.index>=this.ListOfPointsAndCrossings.length?!1:U.ComparePP(this.ListOfPointsAndCrossings[this.index].Location,e)<=0}get First(){return this.ListOfPointsAndCrossings[0]}get Last(){return this.ListOfPointsAndCrossings[this.ListOfPointsAndCrossings.length-1]}Reset(){this.index=0}MergeFrom(e){if(this.Reset(),e==null)return;let t=this.ListOfPointsAndCrossings.length,i=0,n=e.ListOfPointsAndCrossings.length,o=0,a=new Array(this.ListOfPointsAndCrossings.length);for(;i<t||o<n;){if(i>=t){a.push(e.ListOfPointsAndCrossings[o++]);continue}if(o>=n){a.push(this.ListOfPointsAndCrossings[i++]);continue}let l=this.ListOfPointsAndCrossings[i],u=e.ListOfPointsAndCrossings[o],c=U.ComparePP(l.Location,u.Location);c===0?(a.push(l),++i,++o):c===-1?(a.push(l),++i):(a.push(u),++o)}this.ListOfPointsAndCrossings=a}Trim(e,t){this.Reset(),!(this.ListOfPointsAndCrossings==null||this.ListOfPointsAndCrossings.length===0)&&(this.ListOfPointsAndCrossings=this.ListOfPointsAndCrossings.filter(i=>U.ComparePP(i.Location,e)>=0&&U.ComparePP(i.Location,t)<=0))}static ToCrossingArray(e,t){let i=0,n=e.length;for(let l=0;l<n;l++)e[l].DirectionToInside===t&&i++;if(i===0)return null;let o=new Array(i),a=0;for(let l=0;l<n;l++)e[l].DirectionToInside===t&&(o[a++]=e[l]);return o}ToString(){return nA.String.Format("{0} [{1}]",this.ListOfPointsAndCrossings.length,this.index)}};var te=class{static EdgeDirectionVE(e){return te.EdgeDirectionVV(e.Source,e.Target)}static EdgeDirectionVV(e,t){return U.GetDirections(e.point,t.point)}static GetEdgeEnd(e,t){let i=te.EdgeDirectionVE(e);return t===i?e.Target:e.Source}static FindAdjacentVertex(e,t){for(let i of e.InEdges)if(U.GetDirections(e.point,i.SourcePoint)===t)return i.Source;for(let i of e.OutEdges)if(U.GetDirections(e.point,i.TargetPoint)===t)return i.Target;return null}static FindAdjacentEdge(e,t){for(let i of e.InEdges)if(U.GetDirections(i.SourcePoint,e.point)===t)return i;for(let i of e.OutEdges)if(U.GetDirections(e.point,i.TargetPoint)===t)return i;return null}static FindBendPointBetween(e,t,i){return te.IsVerticalD(i)?new m(t.x,e.y):new m(e.x,t.y)}static SegmentIntersectionPPP(e,t,i){let n=U.GetDirections(e,t);return te.IsVerticalD(n)?new m(e.x,i.y):new m(i.x,e.y)}static SegmentIntersectionSP(e,t){return te.SegmentIntersectionPPP(e.Start,e.End,t)}static SegmentsIntersection(e,t){return te.IntervalsIntersect(e.Start,e.End,t.Start,t.End)}static SegmentsIntersectLL(e,t){return te.IntervalsIntersect(e.start,e.end,t.start,t.end)}static IntervalsOverlapSS(e,t){return te.IntervalsOverlapPPPP(e.Start,e.End,t.Start,t.End)}static IntervalsOverlapPPPP(e,t,i,n){return te.IntervalsAreCollinear(e,t,i,n)&&U.ComparePP(e,n)!==U.ComparePP(t,i)}static IntervalsAreCollinear(e,t,i,n){let o=te.IsVerticalPP(e,t);return te.IsVerticalPP(i,n)===o?o?U.Equal(e.x,i.x):U.Equal(e.y,i.y):!1}static IntervalsAreSame(e,t,i,n){return U.EqualPP(e,i)&&U.EqualPP(t,n)}static IntervalsIntersect(e,t,i,n){let o=te.SegmentIntersectionPPP(e,t,i);return te.PointIsOnSegmentPPP(e,t,o)&&te.PointIsOnSegmentPPP(i,n,o)?o:void 0}static SegmentIntersectionEP(e,t){return te.SegmentIntersectionPPP(e.SourcePoint,e.TargetPoint,t)}static PointIsOnSegmentPPP(e,t,i){return U.EqualPP(e,i)||U.EqualPP(t,i)||U.GetDirections(e,i)===U.GetDirections(i,t)}static PointIsOnSegmentSP(e,t){return te.PointIsOnSegmentPPP(e.Start,e.End,t)}static IsVerticalD(e){return(e&5)!==0}static IsVerticalE(e){return te.IsVerticalD(U.GetDirections(e.SourcePoint,e.TargetPoint))}static IsVerticalPP(e,t){return te.IsVerticalD(U.GetDirections(e,t))}static IsVertical(e){return te.IsVerticalD(U.GetDirections(e.start,e.end))}static IsAscending(e){return(e&3)!==0}static Slope(e,t,i){let n=t.sub(e);return n.dot(i.PerpDirectionAsPoint)/n.dot(i.DirectionAsPoint)}static SortAscending(e,t){let i=U.GetDirections(e,t);return 0===i||te.IsAscending(i)?[e,t]:[t,e]}static RectangleBorderIntersect(e,t,i){switch(i){case 1:case 4:return new m(t.x,te.GetRectangleBound(e,i));case 2:case 8:return new m(te.GetRectangleBound(e,i),t.y);default:throw new Error}}static GetRectangleBound(e,t){switch(t){case 1:return e.top;case 4:return e.bottom;case 2:return e.right;case 8:return e.left;default:throw new Error}}static RectangleInteriorsIntersect(e,t){return U.Compare(e.bottom,t.top)<0&&U.Compare(t.bottom,e.top)<0&&U.Compare(e.left,t.right)<0&&U.Compare(t.left,e.right)<0}static PointIsInRectangleInterior(e,t){return U.Compare(e.y,t.top)<0&&U.Compare(t.bottom,e.y)<0&&U.Compare(e.x,t.right)<0&&U.Compare(t.left,e.x)<0}};var Ra=class{get Dir(){return this.dir}set Dir(e){this.dir=e}constructor(e){this.Dir=e,this.DirectionAsPoint=K.toPoint(this.Dir),this.PerpDirection=1===e?2:1,this.PerpDirectionAsPoint=K.toPoint(this.PerpDirection),this.OppositeDirection=K.OppositeDir(e)}get IsHorizontal(){return 2===this.Dir}get IsVertical(){return 1===this.Dir}Compare(e,t){let i=this.ComparePerpCoord(e,t);return i!==0?i:this.CompareScanCoord(e,t)}CompareScanCoord(e,t){return U.Compare(e.sub(t).dot(this.DirectionAsPoint),0)}ComparePerpCoord(e,t){return U.Compare(e.sub(t).dot(this.PerpDirectionAsPoint),0)}IsFlatS(e){return this.IsFlatPP(e.Start,e.End)}IsFlatPP(e,t){return U.Equal(t.sub(e).dot(this.PerpDirectionAsPoint),0)}IsPerpendicularS(e){return this.IsPerpendicularPP(e.Start,e.End)}IsPerpendicularPP(e,t){return U.Equal(t.sub(e).dot(this.DirectionAsPoint),0)}Coord(e){return e.dot(this.DirectionAsPoint)}Min(e,t){return this.Compare(e,t)<=0?e:t}Max(e,t){return this.Compare(e,t)>=0?e:t}get PerpendicularInstance(){return this.IsHorizontal?Ra.VerticalInstance:Ra.HorizontalInstance}static GetInstance(e){return te.IsVerticalD(e)?Ra.VerticalInstance:Ra.HorizontalInstance}ToString(){return this.Dir.toString()}},vt=Ra;vt.HorizontalInstance=new Ra(2),vt.VerticalInstance=new Ra(1);var Ts=class extends ba{constructor(t,i,n,o){super();this.Update(t,i),this.Weight=n,this.GroupBoundaryPointAndCrossingsList=o}static mk(t,i){return new Ts(t,i,Ts.NormalWeight,null)}get Start(){return this.startPoint}get End(){return this.endPoint}get IsVertical(){return Ts.IsVerticalSegment(this.Start,this.End)}get ScanDirection(){return this.IsVertical?vt.VerticalInstance:vt.HorizontalInstance}get IsOverlapped(){return Ts.OverlappedWeight===this.Weight}get IsReflection(){return Ts.ReflectionWeight===this.Weight}static IsVerticalSegment(t,i){return t.x===i.x}MergeGroupBoundaryCrossingList(t){t!=null&&(this.GroupBoundaryPointAndCrossingsList==null&&(this.GroupBoundaryPointAndCrossingsList=new zo),this.GroupBoundaryPointAndCrossingsList.MergeFrom(t))}TrimGroupBoundaryCrossingList(){this.GroupBoundaryPointAndCrossingsList!=null&&this.GroupBoundaryPointAndCrossingsList.Trim(this.Start,this.End)}Update(t,i){this.startPoint=t,this.endPoint=i}SetInitialVisibilityVertex(t){this.LowestVisibilityVertex=t,this.HighestVisibilityVertex=t}AppendVisibilityVertex(t,i){if(this.HighestVisibilityVertex==null)this.AddGroupCrossingsBeforeHighestVisibilityVertex(t,i)||this.SetInitialVisibilityVertex(i);else{if(U.IsPureLower(i.point,this.HighestVisibilityVertex.point))return;this.AddGroupCrossingsBeforeHighestVisibilityVertex(t,i)||this.AppendHighestVisibilityVertex(i)}}AddVisibilityEdge(t,i){let n=new di(t,i,this.Weight);return Ke.AddEdge(n),n}AppendHighestVisibilityVertex(t){U.EqualPP(this.HighestVisibilityVertex.point,t.point)||(this.AddVisibilityEdge(this.HighestVisibilityVertex,t),this.HighestVisibilityVertex=t)}LoadStartOverlapVertexIfNeeded(t){if(this.NeedStartOverlapVertex){let i=t.FindVertex(this.Start);this.AppendVisibilityVertex(t,i!=null?i:t.AddVertexP(this.Start))}}LoadEndOverlapVertexIfNeeded(t){if(this.NeedEndOverlapVertex){let i=t.FindVertex(this.End);this.AppendVisibilityVertex(t,i!=null?i:t.AddVertexP(this.End))}}OnSegmentIntersectorBegin(t){this.AppendGroupCrossingsThroughPoint(t,this.Start)||this.LoadStartOverlapVertexIfNeeded(t)}OnSegmentIntersectorEnd(t){this.AppendGroupCrossingsThroughPoint(t,this.End),this.GroupBoundaryPointAndCrossingsList=null,(this.HighestVisibilityVertex==null||U.IsPureLower(this.HighestVisibilityVertex.point,this.End))&&this.LoadEndOverlapVertexIfNeeded(t)}static Subsume(t,i,n,o,a,l,u,c){return c.extendStart=!0,c.extendEnd=!0,t.seg==null||!te.IntervalsOverlapPPPP(t.seg.Start,t.seg.End,i,n)?!1:t.seg.Weight!==o?t.seg.Start===i&&t.seg.End===n?(t.seg.Weight=Math.min(t.seg.Weight,o),!0):!1:(c.extendStart=l.CompareScanCoord(i,t.seg.Start)===-1,c.extendEnd=l.CompareScanCoord(n,t.seg.End)===1,(c.extendStart||c.extendEnd)&&(u.Remove(t.seg),t.seg.startPoint=l.Min(t.seg.Start,i),t.seg.endPoint=l.Max(t.seg.End,n),t.seg=u.InsertUnique(t.seg).item,t.seg.MergeGroupBoundaryCrossingList(a)),!0)}IntersectsSegment(t){return te.SegmentsIntersection(this,t)!==void 0}toString(){return"["+this.Start+" -> "+this.End+(this.IsOverlapped?" olap":" free")+"]"}ContainsPoint(t){return U.EqualPP(this.Start,t)||U.EqualPP(this.End,t)||U.GetDirections(this.Start,t)===U.GetDirections(t,this.End)}get HasSparsePerpendicularCoords(){return this.sparsePerpendicularCoords==null?!1:this.sparsePerpendicularCoords.size>0}CreatePointFromPerpCoord(t){return this.IsVertical?new m(this.Start.x,t):new m(t,this.Start.y)}AddSparseVertexCoord(t){this.sparsePerpendicularCoords==null&&(this.sparsePerpendicularCoords=new Set),this.sparsePerpendicularCoords.add(t)}AddSparseEndpoint(t){return this.sparsePerpendicularCoords.has(t)?!1:(this.sparsePerpendicularCoords.add(t),!0)}CreateSparseVerticesAndEdges(t){var i;if(this.sparsePerpendicularCoords!=null){this.AppendGroupCrossingsThroughPoint(t,this.Start);for(let n of Array.from(this.sparsePerpendicularCoords.values()).sort(_e)){let o=this.CreatePointFromPerpCoord(n);this.AppendVisibilityVertex(t,(i=t.FindVertex(o))!=null?i:t.AddVertexP(o))}this.AppendGroupCrossingsThroughPoint(t,this.End),this.GroupBoundaryPointAndCrossingsList=null,this.sparsePerpendicularCoords.clear(),this.sparsePerpendicularCoords=null}}HasVisibility(){return this.LowestVisibilityVertex!=null}AddGroupCrossingsBeforeHighestVisibilityVertex(t,i){return this.AppendGroupCrossingsThroughPoint(t,i.point)?(U.IsPureLower(this.HighestVisibilityVertex.point,i.point)&&(this.AddVisibilityEdge(this.HighestVisibilityVertex,i),this.HighestVisibilityVertex=i),!0):!1}AppendGroupCrossingsThroughPoint(t,i){var o;if(this.GroupBoundaryPointAndCrossingsList==null)return!1;let n=!1;for(;this.GroupBoundaryPointAndCrossingsList.CurrentIsBeforeOrAt(i);){let a=this.GroupBoundaryPointAndCrossingsList.Pop(),l=null,u=null;U.ComparePP(a.Location,this.Start)>0&&(l=zo.ToCrossingArray(a.Crossings,this.ScanDirection.OppositeDirection)),U.ComparePP(a.Location,this.End)<0&&(u=zo.ToCrossingArray(a.Crossings,this.ScanDirection.Dir)),n=!0;let c=(o=t.FindVertex(a.Location))!=null?o:t.AddVertexP(a.Location);t.AddVertexP(a.Location),l!=null||u!=null?(this.AddLowCrossings(t,c,l),this.AddHighCrossings(t,c,u)):this.LowestVisibilityVertex==null?this.SetInitialVisibilityVertex(c):this.AppendHighestVisibilityVertex(c)}return n}static GetCrossingInteriorVertex(t,i,n){var a;let o=n.GetInteriorVertexPoint(i.point);return(a=t.FindVertex(o))!=null?a:t.AddVertexP(o)}AddCrossingEdge(t,i,n,o){let a=null;this.HighestVisibilityVertex!=null&&(U.EqualPP(this.HighestVisibilityVertex.point,n.point)?a=t.FindEdgePP(i.point,n.point):this.AppendHighestVisibilityVertex(i)),a==null&&(a=this.AddVisibilityEdge(i,n));let l=o.map(c=>c.Group.InputShape),u=a.IsPassable;u==null?a.IsPassable=()=>{for(let c of l)if(c.IsTransparent)return!0;return!1}:a.IsPassable=()=>{for(let c of l)if(c.IsTransparent||u())return!0;return!1},this.LowestVisibilityVertex==null&&this.SetInitialVisibilityVertex(i),this.HighestVisibilityVertex=n}AddLowCrossings(t,i,n){if(n!=null){let o=Ts.GetCrossingInteriorVertex(t,i,n[0]);this.AddCrossingEdge(t,o,i,n)}}AddHighCrossings(t,i,n){if(n!=null){let o=Ts.GetCrossingInteriorVertex(t,i,n[0]);this.AddCrossingEdge(t,i,o,n)}}},ve=Ts;ve.NormalWeight=di.DefaultWeight,ve.ReflectionWeight=5,ve.OverlappedWeight=500;var qd=class{constructor(e,t,i,n,o){this.IsClosed=!1;this.Vertex=e,this.Direction=t!=null?K.DirectionFromPointToPoint(t.Vertex.point,e.point):0,this.ResetEntry(t,i,n,o)}ResetEntry(e,t,i,n){this.PreviousEntry=e,this.Length=t,this.NumberOfBends=i,this.Cost=n}get PreviousVertex(){return this.PreviousEntry==null?null:this.PreviousEntry.Vertex}toString(){return this.Vertex.point+(" "+(this.Direction+(" "+(this.IsClosed+(" "+this.Cost)))))}};var Xd=class{constructor(){this.Clear()}Set(e,t){this.Vertex=e,this.Weight=t}Clear(){this.Vertex=null,this.Weight=Number.NaN}},Lt=class{constructor(){this.nextNeighbors=[new Xd,new Xd,new Xd];this.LengthImportance=1,this.BendsImportance=1}CombinedCost(e,t){return this.LengthImportance*e+this.BendsImportance*t}TotalCostFromSourceToVertex(e,t){return this.CombinedCost(e,t)+this.sourceCostAdjustment}InitPath(e,t,i){if(t===i||!this.InitEntryDirectionsAtTarget(i))return!1;this.Target=i,this.Source=t;let n=this.TotalCostFromSourceToVertex(0,0)+this.HeuristicDistanceFromVertexToTarget(t.point,0);return n>=this.upperBoundOnCost?!1:(this.queue=new Er(_e),this.visitedVertices=[t],e==null?this.EnqueueInitialVerticesFromSource(n):this.EnqueueInitialVerticesFromSourceEntries(e),this.queue.count>0)}InitEntryDirectionsAtTarget(e){this.EntryDirectionsToTarget=0;for(let t of e.OutEdges)this.EntryDirectionsToTarget=this.EntryDirectionsToTarget|K.DirectionFromPointToPoint(t.TargetPoint,e.point);for(let t of e.InEdges)this.EntryDirectionsToTarget=this.EntryDirectionsToTarget|K.DirectionFromPointToPoint(t.SourcePoint,e.point);return this.EntryDirectionsToTarget!==0}static IsInDirs(e,t){return e===(e&t)}MultistageAdjustedCostBound(e){return Number.isFinite(e)?e+this.BendsImportance:e}HeuristicDistanceFromVertexToTarget(e,t){let i=this.Target.point.sub(e);if(ue(i.x,0)&&ue(i.y,0))return this.targetCostAdjustment;let n=K.VectorDirection(i),o;return t===0?(t=15,o=this.GetNumberOfBends(t,n)):o=this.GetNumberOfBends(t,n),this.CombinedCost(Lt.ManhattanDistance(e,this.Target.point),o)+this.targetCostAdjustment}GetNumberOfBends(e,t){return K.IsPureDirection(t)?this.GetNumberOfBendsForPureDirection(e,t):Lt.GetBendsForNotPureDirection(t,e,this.EntryDirectionsToTarget)}GetNumberOfBendsForPureDirection(e,t){return(t&e)===t?Lt.IsInDirs(t,this.EntryDirectionsToTarget)?0:Lt.IsInDirs(Lt.Left(t),this.EntryDirectionsToTarget)||Lt.IsInDirs(Lt.Right(t),this.EntryDirectionsToTarget)?2:4:this.GetNumberOfBendsForPureDirection(Lt.AddOneTurn[e],t)+1}static GetBendsForNotPureDirection(e,t,i){let n=e&t;if(n===0)return Lt.GetBendsForNotPureDirection(e,Lt.AddOneTurn[t],i)+1;let o=e&i;return o===0?Lt.GetBendsForNotPureDirection(e,t,Lt.AddOneTurn[i])+1:(n|o)===e?1:2}static Left(e){switch(e){case 0:return 0;case 1:return 8;case 2:return 1;case 4:return 2;case 8:return 4;default:throw new Error("direction")}}static Right(e){switch(e){case 0:return 0;case 1:return 2;case 2:return 4;case 4:return 8;case 8:return 1;default:throw new Error("direction")}}static RestorePathV(e){return Lt.RestorePath(e,null)}static RestorePath(e,t){if(e.entry==null)return[];let i=new Array,n=!1,o=0;for(;;){o===e.entry.Direction?n=!0:(n=!1,i.push(e.entry.Vertex.point),o=e.entry.Direction);let a=e.entry.PreviousEntry;if(a==null||e.entry.Vertex===t)break;e.entry=a}return n&&i.push(e.entry.Vertex.point),i.reverse(),i}QueueReversedEntryToNeighborVertexIfNeeded(e,t,i){let n={numberOfBends:0,length:0},o=t.PreviousVertex,a=Lt.GetLengthAndNumberOfBendsToNeighborVertex(e,o,i,n);if(this.CombinedCost(n.length,n.numberOfBends)<this.CombinedCost(t.Length,t.NumberOfBends)||e.Vertex.Degree===1){let l=this.TotalCostFromSourceToVertex(n.length,n.numberOfBends)+this.HeuristicDistanceFromVertexToTarget(o.point,a);this.EnqueueEntry(e,o,n.length,n.numberOfBends,l)}}UpdateEntryToNeighborVertexIfNeeded(e,t,i){let n={numberOfBends:0,length:0},o=Lt.GetLengthAndNumberOfBendsToNeighborVertex(e,t.Vertex,i,n);if(this.CombinedCost(n.length,n.numberOfBends)<this.CombinedCost(t.Length,t.NumberOfBends)){let a=this.TotalCostFromSourceToVertex(n.length,n.numberOfBends)+this.HeuristicDistanceFromVertexToTarget(t.Vertex.point,o);t.ResetEntry(e,n.length,n.numberOfBends,a),this.queue.DecreasePriority(t,a)}}CreateAndEnqueueEntryToNeighborVertex(e,t,i){let n={numberOfBends:0,length:0},o=Lt.GetLengthAndNumberOfBendsToNeighborVertex(e,t,i,n),a=this.TotalCostFromSourceToVertex(n.length,n.numberOfBends)+this.HeuristicDistanceFromVertexToTarget(t.point,o);a<this.upperBoundOnCost&&(t.VertexEntries==null&&this.visitedVertices.push(t),this.EnqueueEntry(e,t,n.length,n.numberOfBends,a))}EnqueueEntry(e,t,i,n,o){let a=new qd(t,e,i,n,o);t.SetVertexEntry(a),this.queue.Enqueue(a,a.Cost)}static GetLengthAndNumberOfBendsToNeighborVertex(e,t,i,n){n.length=e.Length+Lt.ManhattanDistance(e.Vertex.point,t.point)*i;let o=K.DirectionFromPointToPoint(e.Vertex.point,t.point);return n.numberOfBends=e.NumberOfBends,e.Direction!==0&&o!==e.Direction&&n.numberOfBends++,o}static ManhattanDistance(e,t){return Math.abs(t.x-e.x)+Math.abs(t.y-e.y)}GetPathWithCost(e,t,i,n,o,a,l){if(this.upperBoundOnCost=l,this.sourceCostAdjustment=i,this.targetCostAdjustment=a,!this.InitPath(e,t,o))return null;for(;this.queue.count>0;){let u=this.queue.Dequeue(),c=u.Vertex;if(c===this.Target){if(n==null)return this.Cleanup(),u;if(u.Direction,this.EntryDirectionsToTarget===0){let d=0;for(let f of this.Target.VertexEntries)n[d++]=f;return this.Cleanup(),null}this.upperBoundOnCost=Math.min(this.MultistageAdjustedCostBound(u.Cost),this.upperBoundOnCost);continue}u.IsClosed=!0;for(let d of this.nextNeighbors)d.Clear();let h=Lt.Right(u.Direction);this.ExtendPathAlongInEdges(u,c.InEdges,h),this.ExtendPathAlongOutEdges(u,c.OutEdges,h);for(let d of this.nextNeighbors)d.Vertex!=null&&this.ExtendPathToNeighborVertex(u,d.Vertex,d.Weight)}if(n!=null&&this.Target.VertexEntries!=null)for(let u=0;u<this.Target.VertexEntries.length;u++)n[u]=this.Target.VertexEntries[u];return this.Cleanup(),null}ExtendPathAlongInEdges(e,t,i){for(let n of t)this.ExtendPathAlongEdge(e,n,!0,i)}ExtendPathAlongOutEdges(e,t,i){let n=t.isEmpty()?null:t.treeMinimum();for(;n!=null;n=t.next(n))this.ExtendPathAlongEdge(e,n.item,!1,i)}ExtendPathAlongEdge(e,t,i,n){if(!Lt.IsPassable(t))return;let o=i?t.Source:t.Target;if(o===e.PreviousVertex){if(e.Vertex.Degree>1||e.Vertex!==this.Source)return;this.ExtendPathToNeighborVertex(e,o,t.Weight);return}let a=K.DirectionFromPointToPoint(e.Vertex.point,o.point),l=this.nextNeighbors[2];a!==e.Direction&&(l=this.nextNeighbors[a===n?1:0]),l.Set(o,t.Weight)}EnqueueInitialVerticesFromSource(e){let t=new qd(this.Source,null,0,0,e);t.IsClosed=!0;for(let i of this.Source.OutEdges)!Lt.IsPassable(i)||this.ExtendPathToNeighborVertex(t,i.Target,i.Weight);for(let i of this.Source.InEdges)!Lt.IsPassable(i)||this.ExtendPathToNeighborVertex(t,i.Source,i.Weight)}EnqueueInitialVerticesFromSourceEntries(e){for(let t of e)t!=null&&this.queue.Enqueue(t,t.Cost)}ExtendPathToNeighborVertex(e,t,i){let n=K.DirectionFromPointToPoint(e.Vertex.point,t.point),o=t.VertexEntries!=null?t.VertexEntries[K.ToIndex(n)]:null;o==null?this.CreateAndEnqueueReversedEntryToNeighborVertex(e,t,i)||this.CreateAndEnqueueEntryToNeighborVertex(e,t,i):o.IsClosed||this.UpdateEntryToNeighborVertexIfNeeded(e,o,i)}CreateAndEnqueueReversedEntryToNeighborVertex(e,t,i){if(e.Vertex.VertexEntries!=null){let n=K.DirectionFromPointToPoint(t.point,e.Vertex.point),o=e.Vertex.VertexEntries[K.ToIndex(n)];if(o!=null)return this.QueueReversedEntryToNeighborVertexIfNeeded(e,o,i),!0}return!1}static IsPassable(e){return e.IsPassable==null||e.IsPassable()}Cleanup(){for(let e of this.visitedVertices)e.RemoveVertexEntries();this.visitedVertices=[],this.queue=null}},Ki=Lt;Ki.DefaultBendPenaltyAsAPercentageOfDistance=4,Ki.AddOneTurn=[0,11,7,15,14,15,15,15,13,15,15,15,15,15,15,15];var Oa=class{constructor(e){this.bendPenaltyAsAPercentageOfDistance=Ki.DefaultBendPenaltyAsAPercentageOfDistance;this.currentPassTargetEntries=new Array(4);this.bendPenaltyAsAPercentageOfDistance=e}GetPath(e,t){let i={entry:this.GetPathStage(null,e,null,t)};return Ki.RestorePathV(i)}GetPathStage(e,t,i,n){let o=new Ki,a={bestEntry:null,bestCost:Number.MAX_VALUE/ve.OverlappedWeight},l=Number.POSITIVE_INFINITY,u=Oa.Barycenter(t),c=Oa.Barycenter(n),h=Ki.ManhattanDistance(u,c);o.BendsImportance=Math.max(.001,h*(this.bendPenaltyAsAPercentageOfDistance*.01));let d=o.LengthImportance,f=i!=null?this.currentPassTargetEntries:null,p=[];for(let C of t)for(let O of n)p.push([C,O]);p.sort(([C,O],[B,A])=>S(C,O)-S(B,A));for(let[C,O]of p){if(m.closeDistEps(C.point,O.point))continue;let B=E(C,u)*d,A=E(O,c)*d,N=a.bestCost;if(i!=null){for(let ie=0;ie<f.length;ie++)f[ie]=null;N=o.MultistageAdjustedCostBound(a.bestCost)}let z=o.GetPathWithCost(e,C,B,f,O,A,N);if(f!=null){Oa.UpdateTargetEntriesForEachDirection(i,f,a);continue}if(z==null)continue;let Y=z.Cost/S(C,O);(z.Cost<a.bestCost||ue(z.Cost,a.bestCost)&&Y<l)&&(a.bestCost=z.Cost,a.bestEntry=z,l=z.Cost/S(C,O))}return a.bestEntry;function S(C,O){return Ki.ManhattanDistance(C.point,O.point)}function E(C,O){return Ki.ManhattanDistance(C.point,O)}}static UpdateTargetEntriesForEachDirection(e,t,i){for(let n=0;n<t.length;n++){let o=t[n];o!=null&&(e[n]==null||o.Cost<e[n].Cost)&&(e[n]=o,o.Cost<i.bestCost&&(i.bestCost=o.Cost,i.bestEntry=o))}}static Barycenter(e){let t=new m(0,0);for(let i of e)t=t.add(i.point);return t.div(e.length)}};var sA=Ae(sr(),1);var Nm=class{get PathPoints(){return this._pathPoints}set PathPoints(e){this._pathPoints=e}get Width(){return this.GeomEdge.lineWidth}constructor(e){this.GeomEdge=e}get End(){return this.LastEdge.Target}get Start(){return this.FirstEdge.Source}ArrayOfPathPoints(){return this._pathPoints instanceof fi?Array.from(oA(this._pathPoints)):this._pathPoints}*PathEdges(){for(let e=this.FirstEdge;e!=null;e=e.Next)yield e}AddEdge(e){e.Path=this,this.LastEdge.Next=e,e.Prev=this.LastEdge,this.LastEdge=e}SetFirstEdge(e){this.FirstEdge=e,this.LastEdge=e,e.Path=this}toString(){let e=new sA.StringBuilder;this.PathPoints instanceof fi&&e.Append("L");for(let t of oA(this.PathPoints))e.Append(t.toString());return e.ToString()}};function*oA(s){if(s instanceof fi)for(let e=s;e!=null;e=e.Next)yield e.Point;else for(let e of s)yield e}var Mm=class extends Pa{constructor(t,i,n,o){super(i);this.Slope=0;this.SlopeInverse=0;this.Obstacle=t,this.endVertex=o?i.nextOnPolyline:i.prevOnPolyline,n.IsPerpendicularPP(i.point,this.endVertex.point)||(this.Slope=te.Slope(i.point,this.endVertex.point,n),this.SlopeInverse=1/this.Slope)}get Obstacle(){return this.obstacle}set Obstacle(t){this.obstacle=t}get EndVertex(){return this.endVertex}},Nr=class extends Mm{constructor(e,t,i){super(e,t,i,i.IsHorizontal)}},Is=class extends Mm{constructor(e,t,i){super(e,t,i,i.IsVertical)}};var _a=class{get PaddedPolyline(){return this._PaddedPolyline}set PaddedPolyline(e){this._PaddedPolyline=e}get looseVisibilityPolyline(){return this._looseVisibilityPolyline==null&&(this._looseVisibilityPolyline=_a.CreateLoosePolyline(this.VisibilityPolyline)),this._looseVisibilityPolyline}set looseVisibilityPolyline(e){this._looseVisibilityPolyline=e}GetPortChanges(e){return e.addedPorts=bs(this.InputShape.Ports,this.Ports),e.removedPorts=bs(this.Ports,this.InputShape.Ports),e.addedPorts.size===0&&e.removedPorts.size===0?!1:(this.Ports=new Set(this.InputShape.Ports),!0)}get IsInConvexHull(){return this.ConvexHull!=null}get IsGroup(){return this.InputShape!=null&&this.InputShape.IsGroup}get VisibilityBoundingBox(){return this.VisibilityPolyline.boundingBox}get VisibilityPolyline(){return this.ConvexHull!=null?this.ConvexHull.Polyline:this.PaddedPolyline}static CreateSentinel(e,t,i,n){let o=_a.mk(e,t,n);return o.CreateInitialSides(o.PaddedPolyline.startPoint,i),o}CreateInitialSides(e,t){this.ActiveLowSide=new Nr(this,e,t),this.ActiveHighSide=new Is(this,e,t),t.IsFlatS(this.ActiveHighSide)&&(this.ActiveHighSide=new Is(this,this.ActiveHighSide.EndVertex,t))}constructor(e,t){e!=null&&(this.PaddedPolyline=$t.PaddedPolylineBoundaryOfNode(e.BoundaryCurve,t),_a.RoundVerticesAndSimplify(this.PaddedPolyline),this.IsRectangle=this.IsPolylineRectangle(),this.InputShape=e,this.Ports=new Set(this.InputShape.Ports))}static mk(e,t,i){let n=new _a(null,0);return n.PaddedPolyline=ne.mkClosedFromPoints([m.RoundPoint(e),m.RoundPoint(t)]),n.Ordinal=i,n}IsPolylineRectangle(){if(this.PaddedPolyline.count!==4)return!1;let e=this.PaddedPolyline.startPoint,t=e.nextOnPolyline,i=K.VectorDirectionPP(e.point,t.point);if(!K.IsPureDirection(i))return!1;do{e=t,t=e.nextOnPolyline;let n=K.DirectionFromPointToPoint(e.point,t.point);if(n!==K.RotateRight(i))return!1;i=n}while(e!==this.PaddedPolyline.startPoint);return!0}static RoundVerticesAndSimplify(e){let t=e.startPoint;do t.point=m.RoundPoint(t.point),t=t.nextOnPolyline;while(t!==e.startPoint);_a.RemoveCloseAndCollinearVerticesInPlace(e),e.setInitIsRequired()}get IsPrimaryObstacle(){return this.ConvexHull==null||this===this.ConvexHull.PrimaryObstacle}static RemoveCloseAndCollinearVerticesInPlace(e){let t=R.intersectionEpsilon*10;for(let i=e.startPoint.next;i!=null;i=i.next)m.close(i.prev.point,i.point,t)&&(i.next==null?e.RemoveEndPoint():(i.prev.next=i.next,i.next.prev=i.prev));return m.close(e.start,e.end,t)&&e.RemoveStartPoint(),e=e.RemoveCollinearVertices(),e.endPoint.prev!=null&&e.endPoint.prev!==e.startPoint&&m.getTriangleOrientation(e.endPoint.prev.point,e.end,e.start)===2&&e.RemoveEndPoint(),e.startPoint.next!=null&&e.endPoint.prev!==e.startPoint&&m.getTriangleOrientation(e.end,e.start,e.startPoint.next.point)===2&&e.RemoveStartPoint(),e.setInitIsRequired(),e}get isOverlapped(){return this.clump!==void 0&&this.clump.length>0}get IsSentinel(){return this.InputShape==null}IsInSameClump(e){return this.isOverlapped&&this.clump===e.clump}Close(){this.ActiveLowSide=null,this.ActiveHighSide=null}SetConvexHull(e){this.clump=null,this.IsRectangle=!1,this.ConvexHull=e,this.looseVisibilityPolyline=null}static CreateLoosePolyline(e){let t=$t.CreatePaddedPolyline(e,R.intersectionEpsilon*10);return _a.RoundVerticesAndSimplify(t),t}get IsTransparentAncestor(){return this.InputShape==null?!1:this.InputShape.IsTransparent}set IsTransparentAncestor(e){this.InputShape.IsTransparent=e}},vr=_a;vr.FirstSentinelOrdinal=1,vr.FirstNonSentinelOrdinal=10;var aA=Ae(sr(),1);var Bm=class{constructor(e,t,i,n){this.IsOverlapped=!1;this.unpaddedToPaddedBorderWeight=ve.NormalWeight;this.ObstaclePort=e,this.UnpaddedBorderIntersect=t,this.OutwardDirection=i;let o=k.mkPP(this.UnpaddedBorderIntersect,te.RectangleBorderIntersect(e.Obstacle.VisibilityBoundingBox,this.UnpaddedBorderIntersect,i)),a=I.getAllIntersections(o,e.Obstacle.VisibilityPolyline,!0);this.VisibilityBorderIntersect=m.RoundPoint(a[0].x);let l={pacList:null};this.MaxVisibilitySegment=n.CreateMaxVisibilitySegment(this.VisibilityBorderIntersect,this.OutwardDirection,l),this.pointAndCrossingsList=l.pacList,(this.Obstacle.isOverlapped||this.Obstacle.IsGroup&&!this.Obstacle.IsInConvexHull)&&(this.IsOverlapped=n.IntersectionIsInsideAnotherObstacle(null,this.Obstacle,this.VisibilityBorderIntersect,vt.GetInstance(this.OutwardDirection)),(!this.Obstacle.IsGroup||this.IsOverlapped||this.InteriorEdgeCrossesObstacle(n))&&(this.unpaddedToPaddedBorderWeight=ve.OverlappedWeight)),this.Obstacle.IsInConvexHull&&this.unpaddedToPaddedBorderWeight===ve.NormalWeight&&this.SetUnpaddedToPaddedBorderWeightFromHullSiblingOverlaps(n)}get Obstacle(){return this.ObstaclePort.Obstacle}get InitialWeight(){return this.IsOverlapped?ve.OverlappedWeight:ve.NormalWeight}get IsCollinearWithPort(){return K.IsPureDirection(U.GetDirections(this.VisibilityBorderIntersect,this.ObstaclePort.Location))}get IsVertical(){return te.IsVertical(this.MaxVisibilitySegment)}get WantVisibilityIntersection(){return!this.IsOverlapped&&this.CanExtend&&(!this.ObstaclePort.HasCollinearEntrances||this.IsCollinearWithPort)}get CanExtend(){return U.GetDirections(this.MaxVisibilitySegment.start,this.MaxVisibilitySegment.end)!==0}SetUnpaddedToPaddedBorderWeightFromHullSiblingOverlaps(e){(this.Obstacle.IsGroup?this.InteriorEdgeCrossesObstacle(e):this.InteriorEdgeCrossesConvexHullSiblings())&&(this.unpaddedToPaddedBorderWeight=ve.OverlappedWeight)}InteriorEdgeCrossesObstacle(e){let t=X.mkPP(this.UnpaddedBorderIntersect,this.VisibilityBorderIntersect);return this.InteriorEdgeCrossesObstacleRFI(t,i=>i.VisibilityPolyline,Array.from(e.Root.GetLeafRectangleNodesIntersectingRectangle(t)).filter(i=>!i.UserData.IsGroup&&i.UserData!==this.Obstacle).map(i=>i.UserData))}InteriorEdgeCrossesConvexHullSiblings(){let e=X.mkPP(this.UnpaddedBorderIntersect,this.VisibilityBorderIntersect);return this.InteriorEdgeCrossesObstacleRFI(e,t=>t.PaddedPolyline,this.Obstacle.ConvexHull.Obstacles.filter(t=>t!==this.Obstacle))}InteriorEdgeCrossesObstacleRFI(e,t,i){let n=null;for(let o of i){let a=t(o);if(!te.RectangleInteriorsIntersect(e,a.boundingBox))continue;if(n=n!=null?n:k.mkPP(this.UnpaddedBorderIntersect,this.VisibilityBorderIntersect),I.intersectionOne(n,a,!1)!=null||0!==I.PointRelativeToCurveLocation(this.UnpaddedBorderIntersect,a))return!0}return!1}get HasGroupCrossings(){return this.pointAndCrossingsList!=null&&this.pointAndCrossingsList.Count()>0}HasGroupCrossingBeforePoint(e){if(!this.HasGroupCrossings)return!1;let t=te.IsAscending(this.OutwardDirection)?this.pointAndCrossingsList.First:this.pointAndCrossingsList.Last;return U.GetDirections(this.MaxVisibilitySegment.start,t.Location)===U.GetDirections(t.Location,e)}AddToAdjacentVertex(e,t,i,n){let o=e.VisGraph.FindVertex(this.VisibilityBorderIntersect);if(o!=null){this.ExtendEdgeChain(e,o,o,i,n);return}this.OutwardDirection===U.GetDirections(t.point,this.VisibilityBorderIntersect)?(this.VisibilityBorderIntersect=t.point,o=t):(o=e.FindOrAddVertex(this.VisibilityBorderIntersect),e.FindOrAddEdge(o,t,this.InitialWeight)),this.ExtendEdgeChain(e,o,t,i,n)}ExtendEdgeChain(e,t,i,n,o){e.ExtendEdgeChainVRLPB(i,n,this.MaxVisibilitySegment,this.pointAndCrossingsList,this.IsOverlapped);let a=e.FindOrAddVertex(this.UnpaddedBorderIntersect);e.FindOrAddEdge(a,t,this.unpaddedToPaddedBorderWeight),o&&e.ConnectVertexToTargetVertex(this.ObstaclePort.CenterVertex,a,this.OutwardDirection,this.InitialWeight)}toString(){return aA.String.Format("{0} {1}~{2} {3}",this.ObstaclePort.Location,this.UnpaddedBorderIntersect,this.VisibilityBorderIntersect,this.OutwardDirection)}};var Dm=class{constructor(e,t){this.HasCollinearEntrances=!1;this.VisibilityRectangle=X.mkEmpty();this.Port=e,this.Obstacle=t,this.PortEntrances=new Array,this.Location=m.RoundPoint(this.Port.Location)}CreatePortEntrance(e,t,i){let n=new Bm(this,e,t,i);this.PortEntrances.push(n),this.VisibilityRectangle.add(n.MaxVisibilitySegment.end),this.HasCollinearEntrances=this.HasCollinearEntrances||n.IsCollinearWithPort}ClearVisibility(){this.PortEntrances=[]}AddToGraph(e,t){t&&(this.CenterVertex=e.FindOrAddVertex(this.Location))}RemoveFromGraph(){this.CenterVertex=null}get LocationHasChanged(){return!m.closeDistEps(this.Location,m.RoundPoint(this.Port.Location))}get PortCurve(){return this.Port.Curve}get PortLocation(){return this.Port.Location}toString(){return this.Port+this.Obstacle.toString()}};var Gm=class{constructor(e,t){this.maxVisibilitySegmentsAndCrossings=new Array(4);this.OutOfBoundsDirectionFromGraph=0,this.GetVertex(e,t)}get Point(){return this.Vertex.point}get InitialWeight(){return this.IsOverlapped?ve.OverlappedWeight:ve.NormalWeight}get IsOutOfBounds(){return 0!==this.OutOfBoundsDirectionFromGraph}GetVertex(e,t){this.Vertex=e.FindOrAddVertex(t)}AddEdgeToAdjacentEdge(e,t,i,n){let o=te.SegmentIntersectionEP(t,this.Point),a=e.VisGraph.FindVertex(o);return a!=null?this.AddToAdjacentVertex(e,a,i,n):a=e.AddEdgeToTargetEdge(this.Vertex,t,o),this.ExtendEdgeChain(e,a,i,n),a}AddToAdjacentVertex(e,t,i,n){U.EqualPP(this.Point,t.point)||e.FindOrAddEdge(this.Vertex,t,this.InitialWeight),this.ExtendEdgeChain(e,t,i,n)}ExtendEdgeChain(e,t,i,n){let o=this.IsOverlapped;o&&(o=e.ObstacleTree.PointIsInsideAnObstaclePD(t.point,i));let a=this.GetSegmentAndCrossings(this.IsOverlapped?t:this.Vertex,i,e);e.ExtendEdgeChainVRLPB(t,n,a[0],a[1],o)}GetSegmentAndCrossings(e,t,i){let n=K.ToIndex(t),o=this.maxVisibilitySegmentsAndCrossings[n];if(o==null){let a={pacList:null};o=[i.ObstacleTree.CreateMaxVisibilitySegment(e.point,t,a),a.pacList],this.maxVisibilitySegmentsAndCrossings[n]=o}else U.GetDirections(e.point,o[0].start)===t&&(o[0].start=e.point);return o}MaxVisibilityInDirectionForNonOverlappedFreePoint(e,t){return this.GetSegmentAndCrossings(this.Vertex,e,t)[0].end}AddOobEdgesFromGraphCorner(e,t){let i=U.GetDirections(t,this.Vertex.point),n=e.VisGraph.FindVertex(t);e.ConnectVertexToTargetVertex(n,this.Vertex,i&5,ve.NormalWeight),e.ConnectVertexToTargetVertex(n,this.Vertex,i&10,ve.NormalWeight)}RemoveFromGraph(){this.Vertex=null}toString(){return this.Vertex.toString()}};var cA=Ae(sr(),1);var lA=Ae(sr(),1);var ru=class{constructor(e,t){this.BoundaryWidth=R.distanceEpsilon;this.Group=e,this.DirectionToInside=t}GetInteriorVertexPoint(e){return m.RoundPoint(e.add(K.toPoint(this.DirectionToInside).mul(this.BoundaryWidth)))}toString(){return lA.String.Format("{0} {1}",this.DirectionToInside,this.Group)}};ru.BoundaryWidth=R.distanceEpsilon;var zc=class extends Zt{constructor(t){super();this.site=t}get Site(){return this.site}};var Na=class extends Ci{constructor(t,i){super(i);this.Obstacle=t}};var Ma=class extends Na{constructor(e,t){super(e,t)}};var Fm=class{AddPendingPerpendicularCoord(e){this.pendingPerpCoords==null&&(this.pendingPerpCoords=new Array),this.pendingPerpCoords.push(e)}ResetForIntersections(){this.CurrentSegment=this.FirstSegment}get IsHorizontal(){return!this.FirstSegment.IsVertical}constructor(e){this.Coord=e}TraverseToSegmentContainingPoint(e){if(this.CurrentSegment.ContainsPoint(e))return!0;let t=this.IsHorizontal?e.y:e.x;if(!U.Equal(this.Coord,t)){for(;this.MoveNext(););return!1}for(;;){if((this.CurrentSegment.NextSegment==null||U.GetDirections(this.CurrentSegment.End,e)==U.GetDirections(e,this.CurrentSegment.NextSegment.Start))&&m.closeIntersections(this.CurrentSegment.End,e))return this.CurrentSegment.Update(this.CurrentSegment.Start,e),!0;if(!this.MoveNext())return!1;if(this.CurrentSegment.ContainsPoint(e))return!0;if(U.IsPureLower(e,this.CurrentSegment.Start))return this.CurrentSegment.Update(e,this.CurrentSegment.End),!0}}MoveNext(){return this.CurrentSegment=this.CurrentSegment.NextSegment,this.HasCurrent}get HasCurrent(){return this.CurrentSegment!=null}PointIsCurrentEndAndNextStart(e){return e.equal(this.CurrentSegment.End)&&this.CurrentSegment.NextSegment!=null&&e.equal(this.CurrentSegment.NextSegment.Start)}AddPerpendicularCoord(e){let t=this.IsHorizontal?new m(e,this.Coord):new m(this.Coord,e);this.TraverseToSegmentContainingPoint(t),this.CurrentSegment.AddSparseVertexCoord(e)}toString(){return this.FirstSegment==null?"-0- "+this.Coord:this.IsHorizontal?"(H) Y === "+this.Coord:"(V) X === "}AppendScanSegment(e){this.FirstSegment==null?this.FirstSegment=e:this.CurrentSegment.NextSegment=e,this.CurrentSegment=e}AddPendingPerpendicularCoordsToScanSegments(){if(this.pendingPerpCoords!=null){this.ResetForIntersections();for(let e of this.pendingPerpCoords)this.AddPerpendicularCoord(e)}}};var Yd=class{constructor(e,t){this.CurrentSlotIndex=0;this.vector=[],this.IsHorizontal=t;let i=Array.from(e).sort((n,o)=>n>o?1:n<o?-1:0);for(let n of i)this.vector.push(new Fm(n))}get Length(){return this.vector.length}get CurrentSlot(){return this.vector[this.CurrentSlotIndex]}Item(e){return this.vector[e]}CreateScanSegment(e,t,i,n){this.CurrentSlot.AppendScanSegment(new ve(e,t,i,n))}ScanSegmentsCompleteForCurrentSlot(){this.CurrentSlotIndex++}ScanSegmentsComplete(){for(let e of this.vector)e.AddPendingPerpendicularCoordsToScanSegments()}Items(){return this.vector}ResetForIntersections(){for(let e of this.vector)e.ResetForIntersections()}FindNearest(e,t){let i=0,n=this.vector.length-1;if(e<=this.vector[i].Coord)return i;if(e>=this.vector[n].Coord)return n;for(;n-i>2;){let o=i+(n-i>>1),a=this.vector[o];if(e<a.Coord){n=o;continue}if(e>a.Coord){i=o;continue}return o}for(i++;i<=n;i++){let o=this.vector[i];if(e<o.Coord)return t>0?i:i-1;if(e===o.Coord)break}return i}CreateSparseVerticesAndEdges(e){for(let t of this.vector){t.ResetForIntersections();for(let i=t.FirstSegment;i!=null;i=i.NextSegment)i.CreateSparseVerticesAndEdges(e)}}GetParallelCoord(e){return this.IsHorizontal?e.y:e.x}GetPerpendicularCoord(e){return this.IsHorizontal?e.x:e.y}ConnectAdjoiningSegmentEndpoints(){for(let e of this.vector){e.ResetForIntersections();let t=e.FirstSegment;for(let i=t.NextSegment;i!=null;i=i.NextSegment){if(i.HasSparsePerpendicularCoords&&t.HasSparsePerpendicularCoords&&i.Start===t.End){let n=this.GetPerpendicularCoord(i.Start);t.AddSparseEndpoint(n),i.AddSparseEndpoint(n)}t=i}}}toString(){return(this.IsHorizontal?"(H) count":"(V) count === ")+this.vector.length}};var Zi=class extends Zt{constructor(t,i,n){super();this.InitialObstacle=t,this.ReflectingObstacle=i,this.site=n}static mk(t,i,n){let o=new Zi(t.ReflectingObstacle,i,n);return o.PreviousSite=t,o}IsStaircaseStep(t){return this.InitialObstacle===t}get Site(){return this.site}};var Kd=class{constructor(){this.eventTree=new fa((e,t)=>this.Compare(e,t))}Reset(e){this.scanDirection=e}Enqueue(e){this.eventTree.Enqueue(e)}Dequeue(){return this.eventTree.Dequeue()}get Count(){return this.eventTree.Count}Compare(e,t){if(e===t)return 0;if(e==null)return-1;if(t==null)return 1;let i=this.scanDirection.ComparePerpCoord(e.Site,t.Site);if(i)return i;let n=e instanceof Zi?0:1,o=t instanceof Zi?0:1;return i=n-o,i||this.scanDirection.CompareScanCoord(e.Site,t.Site)}};var uA=Ae(sr(),1);var Wc=class{constructor(){this.pointCrossingMap=new Nt;this.pointList=new Array}AddIntersection(e,t,i){let n=this.pointCrossingMap.get(e);n||(n=new Array,this.pointCrossingMap.set(e,n));let o=n.length;for(let l=0;l<o;l++){let u=n[l];if(u.Group===t)return u}let a=new ru(t,i);return n.push(a),a}Clear(){this.pointCrossingMap.clear()}GetOrderedListBetween(e,t){if(this.pointCrossingMap.size===0)return null;if(U.ComparePP(e,t)>0){let o=e;e=t,t=o}this.pointList=[];for(let o of this.pointCrossingMap.keys())U.ComparePP(o,e)>=0&&U.ComparePP(o,t)<=0&&this.pointList.push(o);this.pointList.sort((o,a)=>o.compareTo(a));let i=new zo,n=this.pointList.length;for(let o=0;o<n;o++){let a=this.pointList[o];i.Add(a,this.pointCrossingMap.get(a))}return i}toString(){return uA.String.Format("{0}",this.pointCrossingMap.size)}};var Zd=class extends Zi{constructor(t,i,n){super(t.ReflectingObstacle,i.Obstacle,n);this.Side=i}};var km=class{constructor(e){this.staleSites=new Array;this.scanDirection=e,this.eventTree=new dt((t,i)=>this.CompareBB(t,i)),this.findFirstPred=t=>this.CompareToFindFirstPoint(t.Site)>=0}Add(e){this.eventTree.insert(e)}MarkStaleSite(e){this.staleSites.push(e)}RemoveStaleSites(){let e=this.staleSites.length;if(e>0){for(let t=0;t<e;t++)this.RemoveExact(this.staleSites[t]);this.staleSites=[]}}RemoveSitesForFlatBottom(e,t){for(let i=this.FindFirstInRange(e,t);i!=null;i=this.FindNextInRange(i,t))this.MarkStaleSite(i.item);this.RemoveStaleSites()}Find(e){return this.FindFirstInRange(e,e)}RemoveExact(e){let t=this.eventTree.find(e);return t!=null&&t.item.Site===e.Site?(this.eventTree.deleteNodeInternal(t),!0):!1}FindFirstInRange(e,t){this.findFirstPoint=e;let i=this.eventTree.findFirst(this.findFirstPred);return i!=null&&this.Compare(i.item.Site,t)<=0?i:null}CompareToFindFirstPoint(e){return this.Compare(e,this.findFirstPoint)}FindNextInRange(e,t){let i=this.eventTree.next(e);return i!=null&&this.Compare(i.item.Site,t)<=0?i:null}CompareBB(e,t){return this.scanDirection.CompareScanCoord(e.Site,t.Site)}Compare(e,t){return this.scanDirection.CompareScanCoord(e,t)}};var Qd=class extends Na{constructor(e,t){super(e,t)}},Jd=class extends Na{constructor(e,t){super(e,t)}},$d=class extends Na{constructor(e,t){super(e,t)}};var ef=class extends Zi{constructor(t,i,n){super(t.ReflectingObstacle,i.obstacle,n);this.Side=i}};var tf=class{get LowNeighborSide(){return this.LowNeighbor==null?null:this.LowNeighbor.item}get HighNeighborSide(){return this.HighNeighbor==null?null:this.HighNeighbor.item}Clear(){this.LowNeighbor=null,this.LowOverlapEnd=null,this.GroupSideInterveningBeforeLowNeighbor=null,this.HighNeighbor=null,this.HighOverlapEnd=null,this.GroupSideInterveningBeforeHighNeighbor=null}SetSides(e,t,i,n){if(te.IsAscending(e)){this.HighNeighbor=t,this.HighOverlapEnd=i,this.GroupSideInterveningBeforeHighNeighbor=n;return}this.LowNeighbor=t,this.LowOverlapEnd=i,this.GroupSideInterveningBeforeLowNeighbor=n}};var Cr=class{has(e){return this.hasxy(e.x,e.y)}remove(e){if(!(e.x<0||e.x>=this.arrayOfSets.length))return this.arrayOfSets[e.x].delete(e.y)}hasxy(e,t){if(e<0||e>=this.arrayOfSets.length)return!1;let i=this.arrayOfSets[e];return i!==void 0&&i.has(t)}constructor(){this.arrayOfSets=new Array}static mk(e){let t=new Cr;for(let i of e)t.add(i);return t}*values(){for(let e=0;e<this.arrayOfSets.length;e++){let t=this.arrayOfSets[e];if(!!t)for(let i of t.values())yield new me(e,i)}}add(e){let t=this.arrayOfSets[e.x];t==null&&(this.arrayOfSets[e.x]=t=new Set),t.add(e.y)}addNN(e,t){let i=this.arrayOfSets[e];i==null&&(this.arrayOfSets[e]=i=new Set),i.add(t)}clear(){for(let e of this.arrayOfSets)e&&e.clear()}};var rf=class{constructor(e,t){this.Polyline=e,this.Obstacles=Array.from(t),this.PrimaryObstacle=this.Obstacles[0],vr.RoundVerticesAndSimplify(this.Polyline)}};var Wo=class{static MungeClosestIntersectionInfo(e,t,i){let n=t.seg1.boundingBox,o=m.RoundPoint(t.x).clone();return i?new m(Wo.MungeIntersect(e.x,o.x,n.left,n.right),o.y):new m(o.x,Wo.MungeIntersect(e.y,o.y,n.bottom,n.top))}static MungeIntersect(e,t,i,n){if(e<t){let o=Math.min(i,n);t<o&&(t=o)}else if(e>t){let o=Math.max(i,n);t>o&&(t=o)}return m.RoundDouble(t)}};var ft=class{constructor(){this.CurrentGroupBoundaryCrossingMap=new Wc;this.overlapPairs=new Cr;this.hasOverlaps=!1;this.lookupIntPair=new me(-1,-1)}get GraphBox(){return this.Root.irect}Init(e,t,i){this.CreateObstacleListAndOrdinals(e),this.AncestorSets=t,this.CreateRoot(),this.shapeIdToObstacleMap=i}CreateObstacleListAndOrdinals(e){this.allObstacles=Array.from(e);let t=vr.FirstNonSentinelOrdinal;for(let i of this.allObstacles)i.Ordinal=t++}OrdinalToObstacle(e){return this.allObstacles[e-vr.FirstNonSentinelOrdinal]}CreateRoot(){this.Root=ft.CalculateHierarchy(this.GetAllObstacles()),this.OverlapsExist()&&(this.AccreteClumps(),this.AccreteConvexHulls(),this.GrowGroupsToAccommodateOverlaps(),this.Root=ft.CalculateHierarchy(this.GetAllObstacles().filter(e=>e.IsPrimaryObstacle)))}OverlapsExist(){return this.Root==null?!1:(Vt(this.Root,this.Root,(e,t)=>this.CheckForInitialOverlaps(e,t)),this.hasOverlaps)}OverlapPairAlreadyFound(e,t){return this.lookupIntPair.x=t.Ordinal,this.lookupIntPair.y=e.Ordinal,this.overlapPairs.has(this.lookupIntPair)}CheckForInitialOverlaps(e,t){if(this.hasOverlaps)return;let i={bIsInsideA:!1,aIsInsideB:!1};if(ft.ObstaclesIntersect(e,t,i)){this.hasOverlaps=!0;return}!i.aIsInsideB&&!i.bIsInsideA||e.IsGroup&&t.IsGroup||e.IsGroup&&i.bIsInsideA||t.IsGroup&&i.aIsInsideB||(this.hasOverlaps=!0)}AccreteClumps(){this.AccumulateObstaclesForClumps(),this.CreateClumps()}AccreteConvexHulls(){for(;;)if(this.AccumulateObstaclesForConvexHulls(),!this.CreateConvexHulls())return}static CalculateHierarchy(e){let t=Array.from(e).map(i=>ct(i,i.VisibilityBoundingBox));return tt(t)}AccumulateObstaclesForClumps(){this.overlapPairs.clear();let e=ft.CalculateHierarchy(this.GetAllObstacles().filter(t=>!t.IsGroup&&t.IsRectangle));e!=null&&yr(e,e,(t,i)=>this.EvaluateOverlappedPairForClump(t,i))}EvaluateOverlappedPairForClump(e,t){if(e===t||this.OverlapPairAlreadyFound(e,t))return;let i={bIsInsideA:!1,aIsInsideB:!1};!ft.ObstaclesIntersect(e,t,i)&&!i.aIsInsideB&&!i.bIsInsideA||this.overlapPairs.add(new me(e.Ordinal,t.Ordinal))}AccumulateObstaclesForConvexHulls(){this.overlapPairs.clear();let e=ft.CalculateHierarchy(this.GetAllObstacles().filter(t=>t.IsPrimaryObstacle&&!t.IsGroup));e!=null&&yr(e,e,(t,i)=>this.EvaluateOverlappedPairForConvexHull(t,i))}EvaluateOverlappedPairForConvexHull(e,t){if(e===t||this.OverlapPairAlreadyFound(e,t))return;let i={bIsInsideA:!1,aIsInsideB:!1};!ft.ObstaclesIntersect(e,t,i)&&!i.aIsInsideB&&!i.bIsInsideA||!e.IsInConvexHull&&!t.IsInConvexHull&&e.IsRectangle&&t.IsRectangle||(this.overlapPairs.add(new me(e.Ordinal,t.Ordinal)),this.AddClumpToConvexHull(e),this.AddClumpToConvexHull(t),this.AddConvexHullToConvexHull(e),this.AddConvexHullToConvexHull(t))}GrowGroupsToAccommodateOverlaps(){for(;;)if(this.AccumulateObstaclesForGroupOverlaps(),!this.GrowGroupsToResolveOverlaps())return}AccumulateObstaclesForGroupOverlaps(){let e=ft.CalculateHierarchy(this.GetAllObstacles().filter(i=>i.IsGroup)),t=ft.CalculateHierarchy(this.GetAllObstacles().filter(i=>i.IsPrimaryObstacle));e==null||t==null||yr(e,t,(i,n)=>this.EvaluateOverlappedPairForGroup(i,n))}EvaluateOverlappedPairForGroup(e,t){if(e===t||this.OverlapPairAlreadyFound(e,t))return;let i={bIsInsideA:!1,aIsInsideB:!1},n=ft.ObstaclesIntersect(e,t,i);if(!(!n&&!i.aIsInsideB&&!i.bIsInsideA)){if(e.IsRectangle&&t.IsRectangle){t.IsGroup||(i.aIsInsideB||ft.FirstRectangleContainsACornerOfTheOther(t.VisibilityBoundingBox,e.VisibilityBoundingBox))&&(t.OverlapsGroupCorner=!0);return}!n&&(t.IsGroup||i.bIsInsideA)||this.overlapPairs.add(new me(e.Ordinal,t.Ordinal))}}static FirstRectangleContainsACornerOfTheOther(e,t){return e.contains(t.leftBottom)||e.contains(t.leftTop)||e.contains(t.rightTop)||e.contains(t.rightBottom)}static FirstPolylineStartIsInsideSecondPolyline(e,t){return I.PointRelativeToCurveLocation(e.start,t)!==0}AddClumpToConvexHull(e){if(e.isOverlapped){for(let t of e.clump.filter(i=>i.Ordinal!==e.Ordinal))this.overlapPairs.add(new me(e.Ordinal,t.Ordinal));e.clump=[]}}AddConvexHullToConvexHull(e){if(e.IsInConvexHull){for(let t of e.ConvexHull.Obstacles.filter(i=>i.Ordinal!==e.Ordinal))this.overlapPairs.add(new me(e.Ordinal,t.Ordinal));e.ConvexHull.Obstacles=[]}}CreateClumps(){let e=Oc(Array.from(this.overlapPairs.values())),t=Yn(e);for(let i of t){if(i.length===1)continue;let n=i.map(o=>this.OrdinalToObstacle(o));for(let o of n)o.clump=n}}CreateConvexHulls(){let e=!1,t=Oc(Array.from(this.overlapPairs.values())),i=Yn(t);for(let n of i){if(n.length===1)continue;e=!0;let o=n.map(this.OrdinalToObstacle),a=wo(o,u=>u.VisibilityPolyline),l=new rf(qr.createConvexHullAsClosedPolyline(a),o);for(let u of o)u.SetConvexHull(l)}return e}GrowGroupsToResolveOverlaps(){let e=!1;for(let t of this.overlapPairs.values()){e=!0;let i=this.OrdinalToObstacle(t.x),n=this.OrdinalToObstacle(t.y);ft.ResolveGroupAndGroupOverlap(i,n)||ft.ResolveGroupAndObstacleOverlap(i,n)}return this.overlapPairs.clear(),e}static ResolveGroupAndGroupOverlap(e,t){return t.IsGroup?(e.VisibilityPolyline.boundingBox.area>t.VisibilityPolyline.boundingBox.area?ft.ResolveGroupAndObstacleOverlap(e,t):ft.ResolveGroupAndObstacleOverlap(t,e),!0):!1}static ResolveGroupAndObstacleOverlap(e,t){let i=t.looseVisibilityPolyline;ft.GrowGroupAroundLoosePolyline(e,i);let n={bIsInsideA:!1,aIsInsideB:!1};for(;ft.ObstaclesIntersect(t,e,n)||!n.aIsInsideB;)i=vr.CreateLoosePolyline(i),ft.GrowGroupAroundLoosePolyline(e,i)}static GrowGroupAroundLoosePolyline(e,t){let i=Array.from(e.VisibilityPolyline).concat(Array.from(t));e.SetConvexHull(new rf(qr.createConvexHullAsClosedPolyline(i),[e]))}static ObstaclesIntersect(e,t,i){return I.CurvesIntersect(e.VisibilityPolyline,t.VisibilityPolyline)?(i.aIsInsideB=!1,i.bIsInsideA=!1,!0):(i.aIsInsideB=ft.FirstPolylineStartIsInsideSecondPolyline(e.VisibilityPolyline,t.VisibilityPolyline),i.bIsInsideA=!i.aIsInsideB&&ft.FirstPolylineStartIsInsideSecondPolyline(t.VisibilityPolyline,e.VisibilityPolyline),e.IsRectangle&&t.IsRectangle?!1:ft.ObstaclesAreCloseEnoughToBeConsideredTouching(e,t,i.aIsInsideB,i.bIsInsideA)?(i.aIsInsideB=!1,i.bIsInsideA=!1,!0):!1)}static ObstaclesAreCloseEnoughToBeConsideredTouching(e,t,i,n){if(!i&&!n)return I.CurvesIntersect(e.looseVisibilityPolyline,t.VisibilityPolyline);let o=i?e.looseVisibilityPolyline:t.looseVisibilityPolyline,a=i?t.VisibilityPolyline:e.VisibilityPolyline;for(let l of o)if(I.PointRelativeToCurveLocation(l,a)===0){let u=I.ClosestPoint(a,l);if(!m.closeIntersections(l,u))return!0}return!1}AdjustSpatialAncestors(){if(this.SpatialAncestorsAdjusted)return!1;for(let t of this.GetAllGroups()){let i=t.VisibilityBoundingBox;for(let n of this.Root.GetNodeItemsIntersectingRectangle(i))if(n!==t&&I.ClosedCurveInteriorsIntersect(n.VisibilityPolyline,t.VisibilityPolyline)){if(n.IsInConvexHull)for(let o of n.ConvexHull.Obstacles)this.AncestorSets.get(o.InputShape).add(t.InputShape);this.AncestorSets.get(n.InputShape).add(t.InputShape)}}let e=new Array;for(let t of this.Root.GetAllLeaves()){let i=t.VisibilityBoundingBox;e=e.concat(Array.from(this.AncestorSets.get(t.InputShape)).filter(n=>!i.intersects(this.shapeIdToObstacleMap.get(n).VisibilityBoundingBox)));for(let n of e)this.AncestorSets.get(t.InputShape).delete(n);e=[]}return this.SpatialAncestorsAdjusted=!0,!0}GetAllGroups(){return this.GetAllObstacles().filter(e=>e.IsGroup)}Clear(){this.Root=null,this.AncestorSets=null}CreateMaxVisibilitySegment(e,t,i){let n=te.RectangleBorderIntersect(this.GraphBox,e,t);if(U.GetDirections(e,n)===0)return i.pacList=null,k.mkPP(e,e);let o=this.RestrictSegmentWithObstacles(e,n);return i.pacList=this.CurrentGroupBoundaryCrossingMap.GetOrderedListBetween(o.start,o.end),o}GetAllObstacles(){return this.allObstacles}GetAllPrimaryObstacles(){return this.Root.GetAllLeaves()}IntersectionIsInsideAnotherObstacle(e,t,i,n){return this.insideHitTestIgnoreObstacle1=t,this.insideHitTestIgnoreObstacle2=e,this.insideHitTestScanDirection=n,this.Root.FirstHitNodeWithPredicate(i,this.InsideObstacleHitTest.bind(this))!=null}PointIsInsideAnObstaclePD(e,t){return this.PointIsInsideAnObstacle(e,vt.GetInstance(t))}PointIsInsideAnObstacle(e,t){return this.insideHitTestIgnoreObstacle1=null,this.insideHitTestIgnoreObstacle2=null,this.insideHitTestScanDirection=t,this.Root.FirstHitNodeWithPredicate(e,this.InsideObstacleHitTest.bind(this))!=null}InsideObstacleHitTest(e,t){if(t===this.insideHitTestIgnoreObstacle1||t===this.insideHitTestIgnoreObstacle2)return 0;if(t.IsGroup)return 0;if(!te.PointIsInRectangleInterior(e,t.VisibilityBoundingBox))return 0;let i=te.RectangleBorderIntersect(t.VisibilityBoundingBox,e,this.insideHitTestScanDirection.dir).add(this.insideHitTestScanDirection.DirectionAsPoint),n=te.RectangleBorderIntersect(t.VisibilityBoundingBox,e,this.insideHitTestScanDirection.OppositeDirection).sub(this.insideHitTestScanDirection.DirectionAsPoint),o=k.mkPP(n,i),a=I.getAllIntersections(o,t.VisibilityPolyline,!0);if(a.length===2){let l=m.RoundPoint(a[0].x),u=m.RoundPoint(a[1].x);if(!U.EqualPP(e,l)&&!U.EqualPP(e,u)&&e.compareTo(l)!==e.compareTo(u)&&!ue(Math.floor(a[0].par1),Math.floor(a[1].par1)))return 1}return 0}SegmentCrossesAnObstacle(e,t){this.stopAtGroups=!0,this.wantGroupCrossings=!1;let i=this.RestrictSegmentPrivate(e,t);return!U.EqualPP(i.end,t)}SegmentCrossesANonGroupObstacle(e,t){this.stopAtGroups=!1,this.wantGroupCrossings=!1;let i=this.RestrictSegmentPrivate(e,t);return!U.EqualPP(i.end,t)}RestrictSegmentWithObstacles(e,t){return this.stopAtGroups=!1,this.wantGroupCrossings=!0,this.RestrictSegmentPrivate(e,t)}RestrictSegmentPrivate(e,t){return this.GetRestrictedIntersectionTestSegment(e,t),this.currentRestrictedRay=k.mkPP(e,t),this.restrictedRayLengthSquared=e.sub(t).lengthSquared,this.CurrentGroupBoundaryCrossingMap.Clear(),this.RecurseRestrictRayWithObstacles(this.Root),this.currentRestrictedRay}GetRestrictedIntersectionTestSegment(e,t){let i=U.GetDirections(e,t),n=8===i?this.GraphBox.right:2===i?this.GraphBox.left:e.x,o=8===i?this.GraphBox.left:2===i?this.GraphBox.right:t.x,a=4===i?this.GraphBox.top*2:1===i?this.GraphBox.bottom:e.y,l=4===i?this.GraphBox.bottom:1===i?this.GraphBox.top:e.y;this.restrictedIntersectionTestSegment=k.mkPP(new m(n,a),new m(o,l))}RecurseRestrictRayWithObstacles(e){if(!te.RectangleInteriorsIntersect(this.currentRestrictedRay.boundingBox,e.irect))return;let t=e.UserData;if(t!=null){let i=I.getAllIntersections(this.restrictedIntersectionTestSegment,t.VisibilityPolyline,!0);if(!t.IsGroup||this.stopAtGroups){this.LookForCloserNonGroupIntersectionToRestrictRay(i);return}this.wantGroupCrossings&&this.AddGroupIntersectionsToRestrictedRay(t,i);return}this.RecurseRestrictRayWithObstacles(e.Left),this.RecurseRestrictRayWithObstacles(e.Right)}LookForCloserNonGroupIntersectionToRestrictRay(e){let t=0,i=null,n=this.restrictedRayLengthSquared,o=U.GetDirections(this.restrictedIntersectionTestSegment.start,this.restrictedIntersectionTestSegment.end);for(let a of e){let l=m.RoundPoint(a.x),u=U.GetDirections(this.currentRestrictedRay.start,l);if(u===K.OppositeDir(o))continue;if(t++,0===u){n=0,i=a;continue}let c=l.sub(this.currentRestrictedRay.start).lengthSquared;if(c<n){if(a.x.sub(this.currentRestrictedRay.start).lengthSquared<R.squareOfDistanceEpsilon)continue;n=c,i=a}}if(i!=null){if(t===1){let a=m.RoundPoint(i.x);if(m.closeIntersections(a,this.currentRestrictedRay.start)||m.closeIntersections(a,this.currentRestrictedRay.end))return}this.restrictedRayLengthSquared=n,this.currentRestrictedRay.end=Wo.MungeClosestIntersectionInfo(this.currentRestrictedRay.start,i,!te.IsVerticalPP(this.currentRestrictedRay.start,this.currentRestrictedRay.end))}}AddGroupIntersectionsToRestrictedRay(e,t){for(let i of t){let n=m.RoundPoint(i.x);if(n.sub(this.currentRestrictedRay.start).lengthSquared>this.restrictedRayLengthSquared)continue;let a=U.GetDirections(this.currentRestrictedRay.start,this.currentRestrictedRay.end),l=i.seg1,u=K.VectorDirection(l.derivative(i.par1)),c=a;(u&K.RotateRight(a))!==0&&(c=K.OppositeDir(c)),this.CurrentGroupBoundaryCrossingMap.AddIntersection(n,e,c)}}};var Vm=class{constructor(e,t){this.scanDirection=e,this.SideTree=new dt((i,n)=>this.Compare(i,n)),this.linePositionAtLastInsertOrRemove=t}Insert(e,t){return this.linePositionAtLastInsertOrRemove=t,this.SideTree.insert(e)}get Count(){return this.SideTree.count}Remove(e,t){this.linePositionAtLastInsertOrRemove=t,this.SideTree.remove(e)}Find(e){return this.scanDirection.ComparePerpCoord(this.linePositionAtLastInsertOrRemove,e.Start)===-1?null:this.SideTree.find(e)}NextLowB(e){return this.NextLowR(this.Find(e))}NextLowR(e){return this.SideTree.previous(e)}NextHighB(e){return this.NextHighR(this.Find(e))}NextHighR(e){return this.SideTree.next(e)}Next(e,t){return te.IsAscending(e)?this.SideTree.next(t):this.SideTree.previous(t)}Lowest(){return this.SideTree.treeMinimum()}Compare(e,t){if(e.Obstacle===t.Obstacle)return e===t?0:e instanceof Nr?-1:1;let i=Ba.ScanLineIntersectSidePBS(this.linePositionAtLastInsertOrRemove,e,this.scanDirection),n=Ba.ScanLineIntersectSidePBS(this.linePositionAtLastInsertOrRemove,t,this.scanDirection),o=i.compareTo(n);if(o===0){let a=e instanceof Nr,l=t instanceof Nr;o=fC(a,l),o===0&&(o=_e(e.Obstacle.Ordinal,t.Obstacle.Ordinal))}return o}};var iu=class{constructor(e){this.lookupSegment=ve.mk(new m(0,0),new m(0,1));this.ScanDirection=e,this.segmentTree=new dt((t,i)=>this.Compare(t,i)),this.findIntersectorPred=t=>this.CompareIntersector(t),this.findPointPred=t=>this.CompareToPoint(t)}get Segments(){return this.segmentTree.allNodes()}InsertUnique(e){this.AssertValidSegmentForInsertion(e);let t=this.segmentTree.find(e);return t!=null?t:this.segmentTree.insert(e)}AssertValidSegmentForInsertion(e){}Remove(e){this.segmentTree.remove(e)}Find(e,t){this.lookupSegment.Update(e,t);let i=this.segmentTree.find(this.lookupSegment);return i!=null&&U.EqualPP(i.item.End,t)?i.item:null}FindLowestIntersector(e,t){let i=this.FindLowestIntersectorNode(e,t);return i!=null?i.item:null}FindLowestIntersectorNode(e,t){this.lookupSegment.Update(e,e);let i=this.segmentTree.findLast(this.findIntersectorPred);if(U.EqualPP(e,t))i!=null&&this.ScanDirection.Compare(i.item.End,e)<0&&(i=null);else for(this.lookupSegment.Update(e,t);i!=null&&!i.item.IntersectsSegment(this.lookupSegment);){if(this.ScanDirection.Compare(i.item.Start,t)>0)return null;i=this.segmentTree.next(i)}return i}FindHighestIntersector(e,t){this.lookupSegment.Update(t,t);let i=this.segmentTree.findLast(this.findIntersectorPred);if(U.EqualPP(e,t))i!=null&&this.ScanDirection.Compare(i.item.End,e)<0&&(i=null);else for(this.lookupSegment.Update(e,t);i!=null&&!i.item.IntersectsSegment(this.lookupSegment);){if(this.ScanDirection.Compare(i.item.End,e)<0)return null;i=this.segmentTree.previous(i)}return i!=null?i.item:null}CompareIntersector(e){return this.ScanDirection.Compare(e.Start,this.lookupSegment.Start)<=0}FindSegmentContainingPoint(e,t){return this.FindSegmentOverlappingPoints(e,e,t)}FindSegmentOverlappingPoints(e,t,i){this.lookupSegment.Update(e,t);let n=this.segmentTree.findFirst(this.findPointPred);if(n!=null){let o=n.item;if(this.ScanDirection.Compare(o.Start,t)<=0)return o}return null}CompareToPoint(e){return this.ScanDirection.Compare(e.End,this.lookupSegment.Start)>=0}MergeAndRemoveNextNode(e,t){return this.ScanDirection.Compare(e.End,t.item.End)===-1&&e.Update(e.Start,t.item.End),e.MergeGroupBoundaryCrossingList(t.item.GroupBoundaryPointAndCrossingsList),this.segmentTree.deleteNodeInternal(t),this.segmentTree.find(e)}MergeSegments(){if(this.segmentTree.count<2)return;let e=this.segmentTree.treeMinimum(),t=this.segmentTree.next(e);for(;t!=null;t=this.segmentTree.next(e))switch(this.ScanDirection.Compare(t.item.Start,e.item.End)){case 1:e=t;break;case 0:t.item.IsOverlapped===e.item.IsOverlapped?e=this.MergeAndRemoveNextNode(e.item,t):(e.item.NeedEndOverlapVertex=!0,t.item.NeedStartOverlapVertex=!0,e=t);break;default:if(e.item.IsOverlapped!==t.item.IsOverlapped){if(e.item.IsOverlapped)e.item.Start===t.item.Start?e=this.MergeAndRemoveNextNode(t.item,e):(e.item.Update(e.item.Start,t.item.Start),e=t);else if(e.item.End===t.item.End)e=this.MergeAndRemoveNextNode(e.item,t);else{let n=t.item,o=e.item;this.segmentTree.deleteNodeInternal(t),n.Update(o.End,n.End),this.segmentTree.insert(n),n.TrimGroupBoundaryCrossingList(),e=this.segmentTree.find(o)}break}e=this.MergeAndRemoveNextNode(e.item,t);break}}Compare(e,t){if(e===t)return 0;if(e==null)return-1;if(t==null)return 1;let i=this.ScanDirection.Compare(e.Start,t.Start);return i===0&&(i=this.ScanDirection.Compare(e.End,t.End)*-1),i}};var Um=class extends Oo{constructor(t){super(t)}SetVertexEntry(t){this.VertexEntries==null&&(this.VertexEntries=new Array(4)),this.VertexEntries[K.ToIndex(t.Direction)]=t}RemoveVertexEntries(){this.VertexEntries=null}};var er=class{constructor(e){this.ObstacleTree=new ft;this.CurrentGroupBoundaryCrossingMap=new Wc;this.LowNeighborSides=new tf;this.HighNeighborSides=new tf;this.ScanDirection=vt.HorizontalInstance,this.eventQueue=new Kd,this.HorizontalScanSegments=new iu(vt.HorizontalInstance),this.VerticalScanSegments=new iu(vt.VerticalInstance),this.wantReflections=e}get ParallelScanSegments(){return this.ScanDirection.IsHorizontal?this.HorizontalScanSegments:this.VerticalScanSegments}get PerpendicularScanSegments(){return this.ScanDirection.IsHorizontal?this.VerticalScanSegments:this.HorizontalScanSegments}static NewVisibilityGraph(){let e=new Ke;return e.VertexFactory=t=>new Um(t),e}GenerateVisibilityGraph(){if(this.ObstacleTree.Root==null)return;this.InitializeEventQueue(vt.HorizontalInstance);let e=vr.FirstSentinelOrdinal,t=new m(this.ObstacleTree.GraphBox.left-er.SentinelOffset,this.ObstacleTree.GraphBox.bottom-er.SentinelOffset),i=new m(this.ObstacleTree.GraphBox.left-er.SentinelOffset,this.ObstacleTree.GraphBox.top+er.SentinelOffset),n=vr.CreateSentinel(t,i,this.ScanDirection,e++);this.scanLine.Insert(n.ActiveHighSide,this.ObstacleTree.GraphBox.leftBottom),t=new m(this.ObstacleTree.GraphBox.right+er.SentinelOffset,this.ObstacleTree.GraphBox.bottom-er.SentinelOffset),i=new m(this.ObstacleTree.GraphBox.right+er.SentinelOffset,this.ObstacleTree.GraphBox.top+er.SentinelOffset),n=vr.CreateSentinel(t,i,this.ScanDirection,e++),this.scanLine.Insert(n.ActiveLowSide,this.ObstacleTree.GraphBox.leftBottom),this.ProcessEvents(),this.InitializeEventQueue(vt.VerticalInstance),t=new m(this.ObstacleTree.GraphBox.left-er.SentinelOffset,this.ObstacleTree.GraphBox.bottom-er.SentinelOffset),i=new m(this.ObstacleTree.GraphBox.right+er.SentinelOffset,this.ObstacleTree.GraphBox.bottom-er.SentinelOffset),n=vr.CreateSentinel(t,i,this.ScanDirection,e++),this.scanLine.Insert(n.ActiveHighSide,this.ObstacleTree.GraphBox.leftBottom),t=new m(this.ObstacleTree.GraphBox.left-er.SentinelOffset,this.ObstacleTree.GraphBox.top+er.SentinelOffset),i=new m(this.ObstacleTree.GraphBox.right+er.SentinelOffset,this.ObstacleTree.GraphBox.top+er.SentinelOffset),n=vr.CreateSentinel(t,i,this.ScanDirection,e),this.scanLine.Insert(n.ActiveLowSide,this.ObstacleTree.GraphBox.leftBottom),this.ProcessEvents()}static ScanLineIntersectSidePBS(e,t,i){let n=t.Direction,o=t.Start.x,a=t.Start.y;return i.IsHorizontal?(o+=n.x/n.y*(e.y-t.Start.y),o=Wo.MungeIntersect(e.x,o,t.Start.x,t.End.x),a=e.y):(o=e.x,a+=n.y/n.x*(e.x-t.Start.x),a=Wo.MungeIntersect(e.y,a,t.Start.y,t.End.y)),new m(o,a)}GetOpenVertex(e){let t=e.startPoint,i=this.TraversePolylineForEvents(t),n=this.PointCompare(i.point,t.point);for(;;i=this.TraversePolylineForEvents(i)){let o=this.PointCompare(i.point,t.point);if(o<=0)t=i;else if(o>0&&n<=0)break;n=o}return t}TraversePolylineForEvents(e){return this.ScanDirection.IsHorizontal?e.nextOnPolyline:e.prevOnPolyline}InitializeEventQueue(e){this.ScanDirection=e,this.eventQueue.Reset(this.ScanDirection),this.EnqueueBottomVertexEvents(),this.scanLine=new Vm(this.ScanDirection,this.ObstacleTree.GraphBox.leftBottom),this.lookaheadScan=new km(this.ScanDirection)}EnqueueBottomVertexEvents(){for(let e of this.ObstacleTree.GetAllPrimaryObstacles()){let t=this.GetOpenVertex(e.VisibilityPolyline);this.eventQueue.Enqueue(new Ma(e,t))}}IsFlat(e){return this.ScanDirection.IsFlatS(e)}IsPerpendicular(e){return this.ScanDirection.IsPerpendicularS(e)}ScanLineIntersectSide(e,t){return er.ScanLineIntersectSidePBS(e,t,this.ScanDirection)}SideReflectsUpward(e){return e instanceof Nr?this.ScanDirection.Coord(e.End)>this.ScanDirection.Coord(e.Start):this.ScanDirection.Coord(e.End)<this.ScanDirection.Coord(e.Start)}SideReflectsDownward(e){return e instanceof Nr?this.ScanDirection.Coord(e.End)<this.ScanDirection.Coord(e.Start):this.ScanDirection.Coord(e.End)>this.ScanDirection.Coord(e.Start)}StoreLookaheadSite(e,t,i,n){if(!!this.wantReflections&&!this.IsPerpendicular(t)){if(!n&&!te.PointIsInRectangleInterior(i,t.Obstacle.VisibilityBoundingBox))return;this.SideReflectsUpward(t)&&this.lookaheadScan.Find(i)==null&&this.lookaheadScan.Add(new Zi(e,t.Obstacle,i))}}LoadReflectionEvents(e){this.LoadReflectionEventsBB(e,e)}LoadReflectionEventsBB(e,t){if(e==null||this.SideReflectsUpward(e)||this.IsPerpendicular(e))return;let i=X.mkPP(e.Start,e.End),n=X.mkPP(t.Start,t.End);if(this.ScanDirection.IsHorizontal?!i.intersectsOnX(n):!i.intersectsOnY(n))return;let o=X.intersect(i,n),a=o.leftBottom,l=o.rightTop,u=this.lookaheadScan.FindFirstInRange(a,l);for(;u!=null;){let c=er.ScanLineIntersectSidePBS(u.item.Site,e,this.ScanDirection.PerpendicularInstance);this.ScanDirection.ComparePerpCoord(c,u.item.Site)>0?this.AddReflectionEvent(u.item,e,c):u.item.ReflectingObstacle!==e.Obstacle&&this.lookaheadScan.MarkStaleSite(u.item),u=this.lookaheadScan.FindNextInRange(u,l)}this.lookaheadScan.RemoveStaleSites()}AddPerpendicularReflectionSegment(e,t,i){if(this.lookaheadScan.RemoveExact(e.PreviousSite)){if(t==null)return!1;if(e.PreviousSite.IsStaircaseStep(e.ReflectingObstacle)){if(!te.PointIsInRectangleInterior(e.Site,e.ReflectingObstacle.VisibilityBoundingBox)||!this.InsertPerpendicularReflectionSegment(e.PreviousSite.Site,e.Site))return!1;if(i!=null&&e.IsStaircaseStep(i.Obstacle))return this.ScanLineCrossesObstacle(e.Site,i.Obstacle)}}return!1}AddParallelReflectionSegment(e,t,i,n){{let o=this.ScanLineIntersectSide(n.Site,t!=null?t:i),a=t!=null?o:n.Site,l=t!=null?n.Site:o;return t==null?t=this.scanLine.NextLowB(i).item:i=this.scanLine.NextHighB(t).item,this.InsertParallelReflectionSegment(a,l,e,t,i,n)}}AddReflectionEvent(e,t,i){let n=t;n!=null?this.eventQueue.Enqueue(new ef(e,n,i)):this.eventQueue.Enqueue(new Zd(e,t,i))}AddSideToScanLine(e,t){let i=this.scanLine.Insert(e,t);return this.LoadReflectionEvents(e),i}RemoveSideFromScanLine(e,t){this.scanLine.Remove(e.item,t)}PointCompare(e,t){return this.ScanDirection.Compare(e,t)}Clear(){this.ObstacleTree.Clear(),this.eventQueue=new Kd,this.HorizontalScanSegments=new iu(vt.HorizontalInstance),this.VerticalScanSegments=new iu(vt.VerticalInstance),this.VisibilityGraph=null}ProcessEvents(){for(;this.eventQueue.Count>0;){let e=this.eventQueue.Dequeue();e instanceof Ma?this.ProcessEventO(e):e instanceof Qd?this.ProcessEventLB(e):e instanceof Jd?this.ProcessEventHB(e):e instanceof $d?this.ProcessEventCV(e):e instanceof ef?this.ProcessEventLR(e):e instanceof Zd?this.ProcessEventHR(e):this.ProcessCustomEvent(e),this.LowNeighborSides.Clear(),this.HighNeighborSides.Clear()}}ProcessCustomEvent(e){}ScanLineCrossesObstacle(e,t){return this.ScanDirection.ComparePerpCoord(e,t.VisibilityBoundingBox.leftBottom)>0&&this.ScanDirection.ComparePerpCoord(e,t.VisibilityBoundingBox.rightTop)<0}FindInitialNeighborSides(e,t){t.lowNborSideNode=this.scanLine.NextLowR(e),t.highNborSideNode=this.scanLine.NextHighR(e)}FindNeighborsBRR(e,t,i){this.LowNeighborSides.Clear(),this.HighNeighborSides.Clear(),this.FindNeighbors(e,t,this.LowNeighborSides),this.FindNeighbors(e,i,this.HighNeighborSides)}FindNeighbors(e,t,i){let n=e instanceof Ma?t.item.Start:t.item.End,o={lowNborSideNode:null,highNborSideNode:null};this.FindInitialNeighborSides(t,o),this.SkipToNeighbor(this.ScanDirection.OppositeDirection,t.item,n,o.lowNborSideNode,i),this.SkipToNeighbor(this.ScanDirection.Dir,t.item,n,o.highNborSideNode,i)}SkipToNeighbor(e,t,i,n,o){let a=null,l=null;for(;;n=this.scanLine.Next(e,n))if(n.item.Obstacle!==t.Obstacle){if(n.item.Obstacle.IsGroup){this.ProcessGroupSideEncounteredOnTraversalToNeighbor(n,i,e)&&l==null&&(l=n.item);continue}if(n.item instanceof Is===te.IsAscending(e)){this.ScanLineCrossesObstacle(i,n.item.Obstacle)&&(a=n,l=null);continue}break}o.SetSides(e,n,a,l)}ProcessGroupSideEncounteredOnTraversalToNeighbor(e,t,i){if(!this.ScanLineCrossesObstacle(t,e.item.Obstacle))return!1;let n=e.item instanceof Nr===te.IsAscending(i)?i:K.OppositeDir(i),o=this.ScanLineIntersectSide(t,e.item);return this.CurrentGroupBoundaryCrossingMap.AddIntersection(o,e.item.Obstacle,n),!0}FindNeighborsAndProcessVertexEvent(e,t,i){this.CurrentGroupBoundaryCrossingMap.Clear(),this.FindNeighborsBRR(i,e,t),this.ProcessVertexEvent(e,t,i),this.CurrentGroupBoundaryCrossingMap.Clear()}ProcessEventO(e){var l,u;let t=e.Obstacle;t.CreateInitialSides(e.Vertex,this.ScanDirection),this.AddSideToScanLine(t.ActiveLowSide,e.Site);let i=this.AddSideToScanLine(t.ActiveHighSide,e.Site),n=this.scanLine.Find(t.ActiveLowSide);this.FindNeighborsAndProcessVertexEvent(n,i,e);let o=(l=this.LowNeighborSides.GroupSideInterveningBeforeLowNeighbor)!=null?l:this.LowNeighborSides.LowNeighborSide;this.SideReflectsUpward(o)&&this.LoadReflectionEvents(t.ActiveLowSide);let a=(u=this.HighNeighborSides.GroupSideInterveningBeforeHighNeighbor)!=null?u:this.HighNeighborSides.HighNeighborSide;if(this.SideReflectsUpward(a)&&this.LoadReflectionEvents(t.ActiveHighSide),t.ActiveHighSide.Start!==t.ActiveLowSide.Start){let c=new Is(t,e.Vertex,this.ScanDirection);this.lookaheadScan.RemoveSitesForFlatBottom(c.Start,c.End)}this.EnqueueLowBendVertexEvent(t.ActiveLowSide),this.EnqueueHighBendOrCloseVertexEvent(t.ActiveHighSide)}ProcessEventLB(e){let t=e.Obstacle,i=new Nr(t,e.Vertex,this.ScanDirection);this.ScanDirection.ComparePerpCoord(i.End,i.Start)>0&&(this.RemoveSideFromScanLine(this.scanLine.Find(t.ActiveLowSide),e.Site),this.AddSideToScanLine(i,e.Site),t.ActiveLowSide=i,this.EnqueueLowBendVertexEvent(i))}EnqueueLowBendVertexEvent(e){this.eventQueue.Enqueue(new Qd(e.Obstacle,e.EndVertex))}ProcessEventHB(e){let t=e.Obstacle,i=new Is(t,e.Vertex,this.ScanDirection);this.RemoveSideFromScanLine(this.scanLine.Find(t.ActiveHighSide),e.Site);let n=this.AddSideToScanLine(i,e.Site);if(t.ActiveHighSide=i,this.EnqueueHighBendOrCloseVertexEvent(t.ActiveHighSide),this.wantReflections&&this.ScanDirection.IsHorizontal&&i.Start.x===t.VisibilityBoundingBox.right&&this.SideReflectsUpward(i)){let o=this.scanLine.NextHighR(n);o.item instanceof Nr&&this.SideReflectsDownward(o.item)&&(!t.isOverlapped||!this.ObstacleTree.PointIsInsideAnObstacle(i.Start,this.ScanDirection))&&(this.StoreLookaheadSite(o.item.Obstacle,i,i.Start,!0),this.LoadReflectionEvents(o.item))}}EnqueueHighBendOrCloseVertexEvent(e){let t=e.Obstacle,i=this.ScanDirection.IsHorizontal?e.EndVertex.prevOnPolyline:e.EndVertex.nextOnPolyline;this.ScanDirection.ComparePerpCoord(i.point,e.End)>0?this.eventQueue.Enqueue(new Jd(t,e.EndVertex)):this.eventQueue.Enqueue(new $d(t,e.EndVertex))}CreateCloseEventSegmentsAndFindNeighbors(e){let t=e.Obstacle,i=this.scanLine.Find(t.ActiveLowSide),n=this.scanLine.Find(t.ActiveHighSide);if(this.scanLine.Compare(t.ActiveLowSide,t.ActiveHighSide)===1){let o=i;i=n,n=o}if(this.FindNeighborsAndProcessVertexEvent(i,n,e),this.wantReflections&&t.isOverlapped)for(let o=this.scanLine.NextHighR(i);o.item!==n.item;o=this.scanLine.NextHighR(o))this.LoadReflectionEvents(o.item);this.scanLine.Remove(t.ActiveLowSide,e.Site),this.scanLine.Remove(t.ActiveHighSide,e.Site)}ProcessEventCV(e){this.CreateCloseEventSegmentsAndFindNeighbors(e);let t=this.LowNeighborSides.LowNeighbor.item,i=this.HighNeighborSides.HighNeighbor.item,n=e.Obstacle;this.LoadReflectionEvents(t),this.LoadReflectionEvents(i),n.Close()}ProcessEventLR(e){let t=e.Side.Obstacle,i=this.scanLine.NextLowB(e.Side).item;this.AddPerpendicularReflectionSegment(e,e.Side,i)&&this.AddParallelReflectionSegment(t,i,null,e)&&this.LoadReflectionEvents(t.ActiveLowSide)}ProcessEventHR(e){let t=e.Side.Obstacle,i=this.scanLine.NextHighB(e.Side).item;this.AddPerpendicularReflectionSegment(e,e.Side,i)&&this.AddParallelReflectionSegment(t,null,i,e)&&this.LoadReflectionEvents(t.ActiveHighSide)}MakeInBoundsLocation(e){let t=Math.max(e.x,this.ObstacleTree.GraphBox.left),i=Math.max(e.y,this.ObstacleTree.GraphBox.bottom);return new m(Math.min(t,this.ObstacleTree.GraphBox.right),Math.min(i,this.ObstacleTree.GraphBox.top))}IsInBoundsV(e){return this.IsInBoundsP(e.point)}IsInBoundsP(e){return U.EqualPP(e,this.MakeInBoundsLocation(e))}},Ba=er;Ba.SentinelOffset=1;var Mr=class extends Ba{constructor(){super(!1);this.horizontalVertexPoints=new He;this.verticalVertexPoints=new He;this.boundingBoxSteinerPoints=new He;this.xCoordAccumulator=new Set;this.yCoordAccumulator=new Set;this.horizontalCoordMap=new Map;this.verticalCoordMap=new Map}Clear(){super.Clear(),this.Cleanup()}Cleanup(){this.horizontalVertexPoints.clear(),this.verticalVertexPoints.clear(),this.boundingBoxSteinerPoints.clear(),this.xCoordAccumulator.clear(),this.yCoordAccumulator.clear(),this.horizontalCoordMap.clear(),this.verticalCoordMap.clear()}GenerateVisibilityGraph(){this.AccumulateVertexCoords(),this.CreateSegmentVectorsAndPopulateCoordinateMaps(),this.RunScanLineToCreateSegmentsAndBoundingBoxSteinerPoints(),this.GenerateSparseIntersectionsFromVertexPoints(),this.CreateScanSegmentTrees(),this.Cleanup()}AccumulateVertexCoords(){for(let t of this.ObstacleTree.GetAllObstacles())this.xCoordAccumulator.add(t.VisibilityBoundingBox.left),this.xCoordAccumulator.add(t.VisibilityBoundingBox.right),this.yCoordAccumulator.add(t.VisibilityBoundingBox.top),this.yCoordAccumulator.add(t.VisibilityBoundingBox.bottom)}CreateSegmentVectorsAndPopulateCoordinateMaps(){this.horizontalScanSegmentVector=new Yd(this.yCoordAccumulator,!0),this.verticalScanSegmentVector=new Yd(this.xCoordAccumulator,!1);for(let t=0;t<this.horizontalScanSegmentVector.Length;t++)this.horizontalCoordMap.set(this.horizontalScanSegmentVector.Item(t).Coord,t);for(let t=0;t<this.verticalScanSegmentVector.Length;t++)this.verticalCoordMap.set(this.verticalScanSegmentVector.Item(t).Coord,t)}RunScanLineToCreateSegmentsAndBoundingBoxSteinerPoints(){super.GenerateVisibilityGraph(),this.horizontalScanSegmentVector.ScanSegmentsComplete(),this.verticalScanSegmentVector.ScanSegmentsComplete(),this.xCoordAccumulator.clear(),this.yCoordAccumulator.clear()}InitializeEventQueue(t){super.InitializeEventQueue(t),this.SetVectorsAndCoordMaps(t),this.AddAxisCoordinateEvents(t)}AddAxisCoordinateEvents(t){if(t.IsHorizontal){for(let i of this.yCoordAccumulator)this.eventQueue.Enqueue(new zc(new m(this.ObstacleTree.GraphBox.left-Mr.SentinelOffset,i)));return}for(let i of this.xCoordAccumulator)this.eventQueue.Enqueue(new zc(new m(i,this.ObstacleTree.GraphBox.bottom-Mr.SentinelOffset)))}ProcessCustomEvent(t){this.ProcessAxisCoordinate(t)||this.ProcessCustomEvent(t)}ProcessAxisCoordinate(t){return t instanceof zc?(this.CreateScanSegmentsOnAxisCoordinate(t.Site),!0):!1}InsertPerpendicularReflectionSegment(t,i){return!1}InsertParallelReflectionSegment(t,i,n,o,a,l){return!1}ProcessVertexEvent(t,i,n){let o=this.ScanDirection.IsHorizontal?this.horizontalVertexPoints:this.verticalVertexPoints;o.add(n.Site);let a=this.LowNeighborSides.LowNeighbor.item,l=this.HighNeighborSides.HighNeighbor.item,u=this.ScanDirection.Dir,c=this.ScanDirection.OppositeDirection,h=this.ScanLineIntersectSide(n.Site,a),d=this.ScanLineIntersectSide(n.Site,l);if(this.ObstacleTree.GraphBox.contains(h)){let p=te.RectangleBorderIntersect(a.Obstacle.VisibilityBoundingBox,h,u);U.IsPureLower(p,n.Site)&&this.boundingBoxSteinerPoints.add(p)}if(this.ObstacleTree.GraphBox.contains(d)){let p=te.RectangleBorderIntersect(l.Obstacle.VisibilityBoundingBox,d,c);U.IsPureLower(n.Site,p)&&this.boundingBoxSteinerPoints.add(p)}let f={lowCorner:void 0,highCorner:void 0};Mr.GetBoundingCorners(t.item.Obstacle.VisibilityBoundingBox,n instanceof Ma,this.ScanDirection.IsHorizontal,f),(U.IsPureLower(h,f.lowCorner)||a.Obstacle.IsInSameClump(n.Obstacle))&&o.add(f.lowCorner),(U.IsPureLower(f.highCorner,d)||l.Obstacle.IsInSameClump(n.Obstacle))&&o.add(f.highCorner)}static GetBoundingCorners(t,i,n,o){if(i){o.lowCorner=t.leftBottom,o.highCorner=n?t.rightBottom:t.leftTop;return}o.lowCorner=n?t.leftTop:t.rightBottom,o.highCorner=t.rightTop}CreateScanSegmentsOnAxisCoordinate(t){this.CurrentGroupBoundaryCrossingMap.Clear();let i=this.scanLine.Lowest(),n=this.scanLine.NextHighR(i),o=0,a=t,l=!1;for(;n!=null;n=this.scanLine.NextHighR(n)){if(this.SkipSide(a,n.item))continue;if(n.item.Obstacle.IsGroup){(o===0||l)&&this.HandleGroupCrossing(t,n.item);continue}if(n.item instanceof Nr){if(o>0){o++;continue}a=this.CreateScanSegment(a,n.item,ve.NormalWeight),this.CurrentGroupBoundaryCrossingMap.Clear(),o=1,l=n.item.Obstacle.isOverlapped;continue}o++,!(o>0)&&(a=n.item.Obstacle.isOverlapped||n.item.Obstacle.OverlapsGroupCorner?this.CreateScanSegment(a,n.item,ve.OverlappedWeight):this.ScanLineIntersectSide(a,n.item),this.CurrentGroupBoundaryCrossingMap.Clear(),l=!1)}let u=this.ScanDirection.IsHorizontal?new m(this.ObstacleTree.GraphBox.right+Mr.SentinelOffset,a.y):new m(a.x,this.ObstacleTree.GraphBox.top+Mr.SentinelOffset);this.parallelSegmentVector.CreateScanSegment(a,u,ve.NormalWeight,this.CurrentGroupBoundaryCrossingMap.GetOrderedListBetween(a,u)),this.parallelSegmentVector.ScanSegmentsCompleteForCurrentSlot()}HandleGroupCrossing(t,i){if(!this.ScanLineCrossesObstacle(t,i.Obstacle))return;let n=i instanceof Nr?this.ScanDirection.Dir:this.ScanDirection.OppositeDirection,o=this.ScanLineIntersectSide(t,i),a=this.CurrentGroupBoundaryCrossingMap.AddIntersection(o,i.Obstacle,n);this.AddPerpendicularCoordForGroupCrossing(o);let l=a.GetInteriorVertexPoint(o);this.AddPerpendicularCoordForGroupCrossing(l)}AddPerpendicularCoordForGroupCrossing(t){let i=this.FindPerpendicularSlot(t,0);i!==-1&&this.perpendicularSegmentVector.Item(i).AddPendingPerpendicularCoord(this.parallelSegmentVector.CurrentSlot.Coord)}SkipSide(t,i){if(i.Obstacle.IsSentinel)return!0;let n=i.Obstacle.VisibilityBoundingBox;return this.ScanDirection.IsHorizontal?t.y===n.bottom||t.y===n.top:t.x===n.left||t.x===n.right}CreateScanSegment(t,i,n){let o=this.ScanLineIntersectSide(t,i);return t!==o&&this.parallelSegmentVector.CreateScanSegment(t,o,n,this.CurrentGroupBoundaryCrossingMap.GetOrderedListBetween(t,o)),o}GenerateSparseIntersectionsFromVertexPoints(){this.VisibilityGraph=Mr.NewVisibilityGraph(),this.GenerateSparseIntersectionsAlongHorizontalAxis(),this.GenerateSparseIntersectionsAlongVerticalAxis(),this.ConnectAdjoiningScanSegments(),this.horizontalScanSegmentVector.CreateSparseVerticesAndEdges(this.VisibilityGraph),this.verticalScanSegmentVector.CreateSparseVerticesAndEdges(this.VisibilityGraph)}GenerateSparseIntersectionsAlongHorizontalAxis(){this.currentAxisPointComparer=xc;let t=Array.from(this.horizontalVertexPoints.values()).sort(this.currentAxisPointComparer),i=Array.from(this.boundingBoxSteinerPoints.values()).sort(this.currentAxisPointComparer);this.ScanDirection=vt.HorizontalInstance,this.SetVectorsAndCoordMaps(this.ScanDirection),this.GenerateSparseIntersections(t,i)}GenerateSparseIntersectionsAlongVerticalAxis(){this.currentAxisPointComparer=(n,o)=>n.compareTo(o);let t=Array.from(this.verticalVertexPoints.values()).sort(this.currentAxisPointComparer),i=Array.from(this.boundingBoxSteinerPoints.values()).sort(this.currentAxisPointComparer);this.ScanDirection=vt.VerticalInstance,this.SetVectorsAndCoordMaps(this.ScanDirection),this.GenerateSparseIntersections(t,i)}SetVectorsAndCoordMaps(t){t.IsHorizontal?(this.parallelSegmentVector=this.horizontalScanSegmentVector,this.perpendicularSegmentVector=this.verticalScanSegmentVector,this.perpendicularCoordMap=this.verticalCoordMap):(this.parallelSegmentVector=this.verticalScanSegmentVector,this.perpendicularSegmentVector=this.horizontalScanSegmentVector,this.perpendicularCoordMap=this.horizontalCoordMap)}ConnectAdjoiningScanSegments(){this.horizontalScanSegmentVector.ConnectAdjoiningSegmentEndpoints(),this.verticalScanSegmentVector.ConnectAdjoiningSegmentEndpoints()}GenerateSparseIntersections(t,i){this.perpendicularSegmentVector.ResetForIntersections(),this.parallelSegmentVector.ResetForIntersections();let n=1,o={j:0};for(let a of this.parallelSegmentVector.Items())for(;!(!a.CurrentSegment.ContainsPoint(t[n])&&(!this.AddSteinerPointsToInterveningSegments(t[n],i,o,a)||!a.TraverseToSegmentContainingPoint(t[n])));){if(this.AddPointsToCurrentSegmentIntersections(i,o,a),this.GenerateIntersectionsFromVertexPointForCurrentSegment(t[n],a),a.PointIsCurrentEndAndNextStart(t[n])){a.MoveNext();continue}if(++n>=t.length)return}}AddSteinerPointsToInterveningSegments(t,i,n,o){for(;n.j<i.length&&this.currentAxisPointComparer(i[n.j],t)===-1;){if(!o.TraverseToSegmentContainingPoint(i[n.j]))return!1;this.AddPointsToCurrentSegmentIntersections(i,n,o)}return!0}AddPointsToCurrentSegmentIntersections(t,i,n){for(;i.j<t.length&&n.CurrentSegment.ContainsPoint(t[i.j]);i.j++){let o=this.FindPerpendicularSlot(t[i.j],0);this.AddSlotToSegmentIntersections(n,o)}}GenerateIntersectionsFromVertexPointForCurrentSegment(t,i){let n=this.FindPerpendicularSlot(i.CurrentSegment.Start,1),o=this.FindPerpendicularSlot(i.CurrentSegment.End,-1),a=this.FindPerpendicularSlot(t,0);n>=o||(this.AddSlotToSegmentIntersections(i,n),this.AddSlotToSegmentIntersections(i,o),a>n&&a<o&&(this.AddSlotToSegmentIntersections(i,a),this.AddBinaryDivisionSlotsToSegmentIntersections(i,n,a,o)))}FindPerpendicularSlot(t,i){return Mr.FindIntersectingSlot(this.perpendicularSegmentVector,this.perpendicularCoordMap,t,i)}static FindIntersectingSlot(t,i,n,o){let a=t.GetParallelCoord(n),l=i.get(a);return l!==void 0?l:o===0?-1:t.FindNearest(a,o)}AddSlotToSegmentIntersections(t,i){let n=this.perpendicularSegmentVector.Item(i);t.CurrentSegment.AddSparseVertexCoord(n.Coord),n.AddPerpendicularCoord(t.Coord)}AddBinaryDivisionSlotsToSegmentIntersections(t,i,n,o){let a=0,l=this.perpendicularSegmentVector.Length-1;for(;l-a>1;){let u=a+Math.floor((l-a)/2);if(n<=u){l=u,n<l&&l<=o&&this.AddSlotToSegmentIntersections(t,l);continue}a=u,n>a&&a>=i&&this.AddSlotToSegmentIntersections(t,a)}}CreateScanSegmentTrees(){Mr.CreateScanSegmentTree(this.horizontalScanSegmentVector,this.HorizontalScanSegments),Mr.CreateScanSegmentTree(this.verticalScanSegmentVector,this.VerticalScanSegments)}static CreateScanSegmentTree(t,i){for(let n of t.Items())for(let o=n.FirstSegment;o!=null;o=o.NextSegment)o.HasVisibility()&&i.InsertUnique(o)}};var Zr=class{constructor(e){this.AddedVertices=new Array;this.AddedEdges=new Array;this.edgesToRestore=new Array;this.LimitPortVisibilitySpliceToEndpointBoundingBox=!1;this.GraphGenerator=e}get ObstacleTree(){return this.GraphGenerator.ObstacleTree}get VisGraph(){return this.GraphGenerator.VisibilityGraph}get IsSparseVg(){return this.GraphGenerator instanceof Mr}AddVertex(e){let t=this.VisGraph.AddVertexP(e);return this.AddedVertices.push(t),t}FindOrAddVertex(e){let t=this.VisGraph.FindVertex(e);return t!=null?t:this.AddVertex(e)}FindOrAddEdgeVV(e,t){return this.FindOrAddEdge(e,t,ve.NormalWeight)}FindOrAddEdge(e,t,i){let n=U.GetPureDirectionVV(e,t),o={bracketSource:void 0,bracketTarget:void 0,splitVertex:void 0};Zr.GetBrackets(e,t,n,o);let a=this.VisGraph.FindEdgePP(o.bracketSource.point,o.bracketTarget.point);return a=a!=null?this.SplitEdge(a,o.splitVertex):this.CreateEdge(o.bracketSource,o.bracketTarget,i),a}static GetBrackets(e,t,i,n){if(n.splitVertex=t,!Zr.FindBracketingVertices(e,t.point,i,n)){let o={bracketSource:null,bracketTarget:null};Zr.FindBracketingVertices(t,e.point,K.OppositeDir(i),o)&&(n.bracketSource=o.bracketTarget,n.splitVertex=e),n.bracketTarget=o.bracketSource}}static FindBracketingVertices(e,t,i,n){for(n.bracketSource=e;n.bracketTarget=te.FindAdjacentVertex(n.bracketSource,i),n.bracketTarget!=null;){if(m.closeDistEps(n.bracketTarget.point,t))return!0;if(i!==U.GetDirections(n.bracketTarget.point,t))break;n.bracketSource=n.bracketTarget}return n.bracketTarget!=null}CreateEdge(e,t,i){let n=e,o=t;U.IsPureLower(n.point,o.point)||(n=t,o=e);let a=new ar(n,o,i);return Ke.AddEdge(a),this.AddedEdges.push(a),a}RemoveFromGraph(){this.RemoveAddedVertices(),this.RemoveAddedEdges(),this.RestoreRemovedEdges()}RemoveAddedVertices(){for(let e of this.AddedVertices)this.VisGraph.FindVertex(e.point)!=null&&this.VisGraph.RemoveVertex(e);this.AddedVertices=[]}RemoveAddedEdges(){for(let e of this.AddedEdges)this.VisGraph.FindVertex(e.SourcePoint)!=null&&Ke.RemoveEdge(e);this.AddedEdges=[]}RestoreRemovedEdges(){for(let e of this.edgesToRestore)Ke.AddEdge(e);this.edgesToRestore=[]}FindNextEdge(e,t){return te.FindAdjacentEdge(e,t)}FindPerpendicularOrContainingEdge(e,t,i){for(;;){let n=te.FindAdjacentVertex(e,t);if(n==null)break;let o=U.GetDirections(n.point,i);if((K.OppositeDir(t)&o)!==0)return this.VisGraph.FindEdgePP(e.point,n.point);e=n}return null}FindNearestPerpendicularOrContainingEdge(e,t,i){let n;t&U.GetDirections(e.point,i);let o=e,a=n;for(;0!==a;){let u=te.FindAdjacentVertex(o,n);if(u==null||(K.OppositeDir(n)&U.GetDirections(u.point,i))!==0)break;o=u,t&U.GetDirections(o.point,i)}let l;for(;l=this.FindPerpendicularOrContainingEdge(o,t,i),!(l!=null||o===e);)o=te.FindAdjacentVertex(o,K.OppositeDir(n));return l}ConnectVertexToTargetVertex(e,t,i,n){if(m.closeDistEps(e.point,t.point))return;let o=U.GetDirections(e.point,t.point);if(U.IsPureDirectionD(o)){this.FindOrAddEdgeVV(e,t);return}let a=te.FindBendPointBetween(e.point,t.point,i),l=this.FindOrAddVertex(a);this.FindOrAddEdge(e,l,n),this.FindOrAddEdge(l,t,n)}AddEdgeToTargetEdge(e,t,i){let n=this.VisGraph.FindVertex(i);return n==null&&(n=this.AddVertex(i),this.SplitEdge(t,n)),this.FindOrAddEdgeVV(e,n),n}SplitEdge(e,t){return e==null?null:m.closeDistEps(e.Source.point,t.point)||m.closeDistEps(e.Target.point,t.point)?e:(e instanceof ar||this.edgesToRestore.push(e),Ke.RemoveEdge(e),(this.IsSparseVg||e.Weight===ve.OverlappedWeight)&&t.Degree>0?(this.FindOrAddEdge(t,e.Source,e.Weight),this.FindOrAddEdge(t,e.Target,e.Weight)):(this.CreateEdge(t,e.Target,e.Weight),this.CreateEdge(e.Source,t,e.Weight)))}ExtendEdgeChainVRLPB(e,t,i,n,o){let a=U.GetDirections(i.start,i.end);if(a===0)return;let l=te.GetRectangleBound(t,a),u=te.IsVerticalD(a)?m.RoundPoint(new m(e.point.x,l)):m.RoundPoint(new m(l,e.point.y));if(m.closeDistEps(u,e.point)||U.GetDirections(e.point,u)!==a)return;let c=i;U.GetDirections(u,c.end)===a&&(c=k.mkPP(c.start,u)),this.ExtendEdgeChain(e,a,c,i,n,o)}ExtendEdgeChain(e,t,i,n,o,a){if(U.GetDirections(e.point,i.end)!==t)return;let u=K.RotateLeft(t),c=te.FindAdjacentVertex(e,u);if(c==null&&(u=K.OppositeDir(u),c=te.FindAdjacentVertex(e,u),c==null))return;let h=K.OppositeDir(u),d={spliceTarget:null};this.ExtendSpliceWorker(c,t,h,i,n,a,d)&&this.ExtendSpliceWorker(d.spliceTarget,t,u,i,n,a,d),this.SpliceGroupBoundaryCrossings(o,e,i)}SpliceGroupBoundaryCrossings(e,t,i){if(e==null||e.Count()===0)return;e.Reset();let n=i.start,o=i.end,a=U.GetDirections(n,o);te.IsAscending(a)||(n=i.end,o=i.start,a=K.OppositeDir(a)),t=Zr.TraverseToFirstVertexAtOrAbove(t,n,K.OppositeDir(a));for(let l=t;l!=null;l=te.FindAdjacentVertex(l,a)){let u=U.ComparePP(l.point,o)>=0;for(;e.CurrentIsBeforeOrAt(l.point);){let c=e.Pop();U.ComparePP(c.Location,t.point)>0&&U.ComparePP(c.Location,o)<=0&&this.SpliceGroupBoundaryCrossing(l,c,K.OppositeDir(a)),U.ComparePP(c.Location,t.point)>=0&&U.ComparePP(c.Location,o)<0&&this.SpliceGroupBoundaryCrossing(l,c,a)}if(u)break}}static TraverseToFirstVertexAtOrAbove(e,t,i){let n=e,o=K.OppositeDir(i);for(;;){let a=te.FindAdjacentVertex(n,i);if(a==null||U.GetDirections(a.point,t)===o)break;n=a}return n}SpliceGroupBoundaryCrossing(e,t,i){var o,a;let n=zo.ToCrossingArray(t.Crossings,i);if(n!=null){let l=(o=this.VisGraph.FindVertex(t.Location))!=null?o:this.AddVertex(t.Location);e.point.equal(l.point)||this.FindOrAddEdgeVV(e,l);let u=n[0].GetInteriorVertexPoint(t.Location),c=(a=this.VisGraph.FindVertex(u))!=null?a:this.AddVertex(u),h=this.FindOrAddEdgeVV(l,c),d=n.map(f=>f.Group.InputShape);h.IsPassable=()=>d.some(f=>f.IsTransparent)}}ExtendSpliceWorker(e,t,i,n,o,a,l){let u=te.FindAdjacentVertex(e,i);l.spliceTarget=te.FindAdjacentVertex(u,i);let c={spliceSource:e};for(;Zr.GetNextSpliceSource(c,i,t);){let h=te.FindBendPointBetween(u.point,c.spliceSource.point,K.OppositeDir(i));if(Zr.IsPointPastSegmentEnd(o,h))break;if(l.spliceTarget=Zr.GetSpliceTarget(c,i,h),l.spliceTarget==null){if(this.IsSkippableSpliceSourceWithNullSpliceTarget(c.spliceSource,t))continue;if(this.ObstacleTree.SegmentCrossesAnObstacle(c.spliceSource.point,h))return!1}let d=this.VisGraph.FindVertex(h);if(d!=null){if(l.spliceTarget==null||this.VisGraph.FindEdgePP(u.point,h)!=null)return l.spliceTarget==null&&this.FindOrAddEdge(u,d,a?ve.OverlappedWeight:ve.NormalWeight),!1}else d=this.AddVertex(h);if(this.FindOrAddEdge(u,d,a?ve.OverlappedWeight:ve.NormalWeight),this.FindOrAddEdge(c.spliceSource,d,a?ve.OverlappedWeight:ve.NormalWeight),a&&(a=this.SeeIfSpliceIsStillOverlapped(t,d)),u=d,(t&U.GetDirections(h,n.end))===0){l.spliceTarget=null;break}}return l.spliceTarget!=null}static GetNextSpliceSource(e,t,i){let n=te.FindAdjacentVertex(e.spliceSource,i);if(n==null)for(n=e.spliceSource;;){if(n=te.FindAdjacentVertex(n,K.OppositeDir(t)),n==null)return!1;let o=te.FindAdjacentVertex(n,i);if(o!=null){n=o;break}}return e.spliceSource=n,!0}static GetSpliceTarget(e,t,i){let n=U.GetDirections(e.spliceSource.point,i),o=n,a=e.spliceSource;for(;o===n&&(e.spliceSource=a,a=te.FindAdjacentVertex(e.spliceSource,t),a!=null);){if(m.closeDistEps(a.point,i)){a=te.FindAdjacentVertex(a,t);break}o=U.GetDirections(a.point,i)}return a}SeeIfSpliceIsStillOverlapped(e,t){let i=this.FindNextEdge(t,K.RotateLeft(e)),n=i==null?!1:ve.NormalWeight===i.Weight;return n||(i=this.FindNextEdge(t,K.RotateRight(e)),n=i==null?!1:ve.NormalWeight===i.Weight),!n||this.ObstacleTree.PointIsInsideAnObstaclePD(t.point,e)}IsSkippableSpliceSourceWithNullSpliceTarget(e,t){if(Zr.IsSkippableSpliceSourceEdgeWithNullTarget(te.FindAdjacentEdge(e,t)))return!0;let i=te.FindAdjacentEdge(e,K.OppositeDir(t));return Zr.IsSkippableSpliceSourceEdgeWithNullTarget(i)||Zr.IsReflectionEdge(i)}static IsSkippableSpliceSourceEdgeWithNullTarget(e){return e!=null&&e.IsPassable!=null&&ue(e.Length,ru.BoundaryWidth)}static IsReflectionEdge(e){return e!=null&&e.Weight===ve.ReflectionWeight}static IsPointPastSegmentEnd(e,t){return U.GetDirections(e.start,e.end)===U.GetDirections(e.end,t)}toString(){return cA.String.Format("{0} {1}",this.AddedVertices.length,this.edgesToRestore.length)}};var Da=class{constructor(e){this.obstaclePortMap=new Map;this.freePointMap=new Nt;this.freePointLocationsUsedByRouteEdges=new He;this.RouteToCenterOfObstacles=!1;this.obstaclePortsInGraph=new Array;this.freePointsInGraph=new Set;this.activeAncestors=new Array;this.TransUtil=new Zr(e),this.graphGenerator=e}get LimitPortVisibilitySpliceToEndpointBoundingBox(){return this.TransUtil.LimitPortVisibilitySpliceToEndpointBoundingBox}set LimitPortVisibilitySpliceToEndpointBoundingBox(e){this.TransUtil.LimitPortVisibilitySpliceToEndpointBoundingBox=e}get VisGraph(){return this.graphGenerator.VisibilityGraph}get HScanSegments(){return this.graphGenerator.HorizontalScanSegments}get VScanSegments(){return this.graphGenerator.VerticalScanSegments}get ObstacleTree(){return this.graphGenerator.ObstacleTree}get AncestorSets(){return this.ObstacleTree.AncestorSets}Clear(){this.TransUtil.RemoveFromGraph(),this.obstaclePortMap.clear()}CreateObstaclePorts(e){for(let t of e.Ports)this.CreateObstaclePort(e,t)}CreateObstaclePort(e,t){if(t.Curve==null)return null;let i=m.RoundPoint(t.Location);if(0===I.PointRelativeToCurveLocation(i,e.InputShape.BoundaryCurve)||e.InputShape.BoundaryCurve!==t.Curve&&0===I.PointRelativeToCurveLocation(i,t.Curve))return null;let n=new Dm(t,e);return this.obstaclePortMap.set(t,n),n}FindVertices(e){let t=new Array,i=this.obstaclePortMap.get(e);if(i)if(this.RouteToCenterOfObstacles)t.push(i.CenterVertex);else for(let n of i.PortEntrances){let o=this.VisGraph.FindVertex(n.UnpaddedBorderIntersect);o!=null&&t.push(o)}else t.push(this.VisGraph.FindVertex(m.RoundPoint(e.Location)));return t}RemoveObstaclePorts(e){for(let t of e.Ports)this.RemoveObstaclePort(t)}RemoveObstaclePort(e){this.obstaclePortMap.delete(e)}AddControlPointsToGraph(e,t){this.GetPortSpliceLimitRectangle(e),this.activeAncestors=[];let i={oport:null},n={oport:null},o=this.FindAncestorsAndObstaclePort(e.sourcePort,i),a=this.FindAncestorsAndObstaclePort(e.targetPort,n);if(this.AncestorSets.size>0&&i.oport!=null&&n.oport!=null){let l=bs(a,o),u=bs(o,a);this.ActivateAncestors(u,l,t)}this.AddPortToGraph(e.sourcePort,i.oport),this.AddPortToGraph(e.targetPort,n.oport)}ConnectOobWaypointToEndpointVisibilityAtGraphBoundary(e,t){if(e==null||!e.IsOutOfBounds)return;let i=this.FindVertices(t),n=e.OutOfBoundsDirectionFromGraph&5;this.ConnectToGraphAtPointsCollinearWithVertices(e,n,i),n=e.OutOfBoundsDirectionFromGraph&10,this.ConnectToGraphAtPointsCollinearWithVertices(e,n,i)}ConnectToGraphAtPointsCollinearWithVertices(e,t,i){if(0===t)return;let n=K.OppositeDir(t);for(let o of i){let a=this.InBoundsGraphBoxIntersect(o.point,t),l=this.VisGraph.FindVertex(a);l!=null&&this.TransUtil.ConnectVertexToTargetVertex(e.Vertex,l,n,ve.NormalWeight)}}SetAllAncestorsActive(e,t){if(this.AncestorSets.size===0)return!1;this.ObstacleTree.AdjustSpatialAncestors(),this.ClearActiveAncestors();let i={oport:null},n={oport:null},o=this.FindAncestorsAndObstaclePort(e.sourcePort,n),a=this.FindAncestorsAndObstaclePort(e.targetPort,i);return this.AncestorSets.size>0&&o!=null&&a!=null?(this.ActivateAncestors(o,a,t),!0):!1}SetAllGroupsActive(){this.ClearActiveAncestors();for(let e of this.ObstacleTree.GetAllGroups())e.IsTransparentAncestor=!0,this.activeAncestors.push(e)}FindAncestorsAndObstaclePort(e,t){return t.oport=this.FindObstaclePort(e),this.AncestorSets.size===0?null:t.oport!=null?this.AncestorSets.get(t.oport.Obstacle.InputShape):new Set(Array.from(this.ObstacleTree.Root.AllHitItems(X.mkPP(e.Location,e.Location),i=>i.IsGroup)).map(i=>i.InputShape))}ActivateAncestors(e,t,i){for(let n of Vn(e,t)){let o=i.get(n);o.IsTransparentAncestor=!0,this.activeAncestors.push(o)}}ClearActiveAncestors(){for(let e of this.activeAncestors)e.IsTransparentAncestor=!1;this.activeAncestors=[]}RemoveControlPointsFromGraph(){this.ClearActiveAncestors(),this.RemoveObstaclePortsFromGraph(),this.RemoveFreePointsFromGraph(),this.TransUtil.RemoveFromGraph(),this.portSpliceLimitRectangle=X.mkEmpty()}RemoveObstaclePortsFromGraph(){for(let e of this.obstaclePortsInGraph)e.RemoveFromGraph();this.obstaclePortsInGraph=[]}RemoveFreePointsFromGraph(){for(let e of this.freePointsInGraph)e.RemoveFromGraph();this.freePointsInGraph.clear()}RemoveStaleFreePoints(){if(this.freePointMap.size>this.freePointLocationsUsedByRouteEdges.size){let e=Array.from(this.freePointMap).filter(t=>!this.freePointLocationsUsedByRouteEdges.has(t[0]));for(let t of e)this.freePointMap.deleteP(t[0])}}ClearVisibility(){this.freePointMap.clear();for(let e of this.obstaclePortMap.values())e.ClearVisibility()}BeginRouteEdges(){this.RemoveControlPointsFromGraph(),this.freePointLocationsUsedByRouteEdges.clear()}EndRouteEdges(){this.RemoveStaleFreePoints()}FindObstaclePort(e){let t=this.obstaclePortMap.get(e);if(t){let i={removedPorts:null,addedPorts:null};if(t.Obstacle.GetPortChanges(i)){for(let n of i.addedPorts)this.CreateObstaclePort(t.Obstacle,n);for(let n of i.removedPorts)this.RemoveObstaclePort(n);t=this.obstaclePortMap.get(e)}}return t}AddPortToGraph(e,t){if(t!=null){this.AddObstaclePortToGraph(t);return}this.AddFreePointToGraph(e.Location)}AddObstaclePortToGraph(e){if(!(e.LocationHasChanged&&(this.RemoveObstaclePort(e.Port),e=this.CreateObstaclePort(e.Obstacle,e.Port),e==null))){e.AddToGraph(this.TransUtil,this.RouteToCenterOfObstacles),this.obstaclePortsInGraph.push(e),this.CreateObstaclePortEntrancesIfNeeded(e);for(let t of e.PortEntrances)this.AddObstaclePortEntranceToGraph(t)}}CreateObstaclePortEntrancesIfNeeded(e){e.PortEntrances.length>0||this.CreateObstaclePortEntrancesFromPoints(e)}GetPortVisibilityIntersection(e){let t=this.FindObstaclePort(e.sourcePort),i=this.FindObstaclePort(e.targetPort);if(t==null||i==null||t.Obstacle.IsInConvexHull||i.Obstacle.IsInConvexHull||(this.CreateObstaclePortEntrancesIfNeeded(t),this.CreateObstaclePortEntrancesIfNeeded(i),!t.VisibilityRectangle.intersects(i.VisibilityRectangle)))return null;for(let n of t.PortEntrances)if(!!n.WantVisibilityIntersection)for(let o of i.PortEntrances){if(!o.WantVisibilityIntersection)continue;let a=n.IsVertical===o.IsVertical?Da.GetPathPointsFromOverlappingCollinearVisibility(n,o):Da.GetPathPointsFromIntersectingVisibility(n,o);if(a!=null)return a}return null}static GetPathPointsFromOverlappingCollinearVisibility(e,t){return!te.IntervalsAreSame(e.MaxVisibilitySegment.start,e.MaxVisibilitySegment.end,t.MaxVisibilitySegment.end,t.MaxVisibilitySegment.start)||e.HasGroupCrossings||t.HasGroupCrossings||m.closeDistEps(e.UnpaddedBorderIntersect,t.UnpaddedBorderIntersect)?null:[e.UnpaddedBorderIntersect,t.UnpaddedBorderIntersect]}static GetPathPointsFromIntersectingVisibility(e,t){let i=te.SegmentsIntersectLL(e.MaxVisibilitySegment,t.MaxVisibilitySegment);return!i||e.HasGroupCrossingBeforePoint(i)||t.HasGroupCrossingBeforePoint(i)?null:[e.UnpaddedBorderIntersect,i,t.UnpaddedBorderIntersect]}CreateObstaclePortEntrancesFromPoints(e){let t=this.graphGenerator.ObstacleTree.GraphBox,i=X.mkPP(m.RoundPoint(e.PortCurve.boundingBox.leftBottom),m.RoundPoint(e.PortCurve.boundingBox.rightTop)),n=m.RoundPoint(e.PortLocation),o=!1,a={xx0:null,xx1:null};if(!U.Equal(n.y,i.top)&&!U.Equal(n.y,i.bottom)){o=!0;let l=new k(t.left,n.y,t.right,n.y);this.GetBorderIntersections(n,l,e.PortCurve,a);let u=new m(Math.min(a.xx0.x,a.xx1.x),n.y);u.x<i.left&&(u=new m(i.left,u.y));let c=new m(Math.max(a.xx0.x,a.xx1.x),n.y);c.x>i.right&&(c=new m(i.right,c.y)),this.CreatePortEntrancesAtBorderIntersections(i,e,n,u,c)}if(!U.Equal(n.x,i.left)&&!U.Equal(n.x,i.right)){o=!0;let l=new k(n.x,t.bottom,n.x,t.top);this.GetBorderIntersections(n,l,e.PortCurve,a);let u=new m(n.x,Math.min(a.xx0.y,a.xx1.y));u.y<t.bottom&&(u=new m(u.x,t.bottom));let c=new m(n.x,Math.max(a.xx0.y,a.xx1.y));c.y>t.top&&(c=new m(c.x,t.top)),this.CreatePortEntrancesAtBorderIntersections(i,e,n,u,c)}o||this.CreateEntrancesForCornerPort(i,e,n)}GetBorderIntersections(e,t,i,n){let o=I.getAllIntersections(t,i,!0);n.xx0=m.RoundPoint(o[0].x),n.xx1=m.RoundPoint(o[1].x)}CreatePortEntrancesAtBorderIntersections(e,t,i,n,o){let a=U.GetDirections(n,o);U.EqualPP(n,i)||this.CreatePortEntrance(e,t,o,a),U.EqualPP(o,i)||this.CreatePortEntrance(e,t,n,K.OppositeDir(a))}static GetDerivative(e,t){let i=e.PortCurve.closestParameter(t),n=e.PortCurve.derivative(i),o=(e.PortCurve.parStart+e.PortCurve.parEnd)/2;return $t.CurveIsClockwise(e.PortCurve,e.PortCurve.value(o))||(n=n.mul(-1)),n}CreatePortEntrance(e,t,i,n){t.CreatePortEntrance(i,n,this.ObstacleTree);let o=vt.GetInstance(n),a=te.GetRectangleBound(e,n)-o.Coord(i);if(a<0&&(a=-a),a>R.intersectionEpsilon){let l=K.VectorDirection(Da.GetDerivative(t,i)),u;n|K.OppositeDir(n),0!==(n&l)&&(u=K.OppositeDir(u)),t.CreatePortEntrance(i,u,this.ObstacleTree)}}CreateEntrancesForCornerPort(e,t,i){let n=1;U.EqualPP(i,e.leftBottom)?n=4:U.EqualPP(i,e.leftTop)?n=8:U.EqualPP(i,e.rightTop)?n=1:U.EqualPP(i,e.rightBottom)&&(n=2),t.CreatePortEntrance(i,n,this.ObstacleTree),t.CreatePortEntrance(i,K.RotateRight(n),this.ObstacleTree)}AddObstaclePortEntranceToGraph(e){let t=this.VisGraph.FindVertex(e.VisibilityBorderIntersect);if(t){e.ExtendEdgeChain(this.TransUtil,t,t,this.portSpliceLimitRectangle,this.RouteToCenterOfObstacles);return}let i={targetVertex:null},n=e.IsOverlapped?ve.OverlappedWeight:ve.NormalWeight;this.FindorCreateNearestPerpEdgePPDNT(e.MaxVisibilitySegment.end,e.VisibilityBorderIntersect,e.OutwardDirection,n,i)!=null&&e.AddToAdjacentVertex(this.TransUtil,i.targetVertex,this.portSpliceLimitRectangle,this.RouteToCenterOfObstacles)}InBoundsGraphBoxIntersect(e,t){return te.RectangleBorderIntersect(this.graphGenerator.ObstacleTree.GraphBox,e,t)}FindorCreateNearestPerpEdgePPDN(e,t,i,n){let o={targetVertex:null};return this.FindorCreateNearestPerpEdgePPDNT(e,t,i,n,o)}FindorCreateNearestPerpEdgePPDNT(e,t,i,n,o){let a=te.SortAscending(e,t),l=a[0],u=a[1],c=te.IsVerticalD(i)?this.HScanSegments:this.VScanSegments,h=te.IsAscending(i)?c.FindLowestIntersector(l,u):c.FindHighestIntersector(l,u);if(h==null)return o.targetVertex=null,null;let d=te.SegmentIntersectionSP(h,l);return this.FindOrCreateNearestPerpEdgeFromNearestPerpSegment(te.IsAscending(i)?l:u,h,d,n,o)}FindOrCreateNearestPerpEdgeFromNearestPerpSegment(e,t,i,n,o){var h;let a={segsegVertex:this.VisGraph.FindVertex(i),targetVertex:null};if(a.segsegVertex==null){let d=this.FindOrCreateSegmentIntersectionVertexAndAssociatedEdge(e,i,t,n,a);if(d!=null)return d}else if(U.EqualPP(e,i))return o.targetVertex=a.segsegVertex,this.TransUtil.FindNextEdge(o.targetVertex,K.OppositeDir(t.ScanDirection.Dir));let l=U.GetDirections(i,e),u=U.GetDirections(a.segsegVertex.point,e);if(l===u){let d={bracketTarget:null,bracketSource:null};return Zr.FindBracketingVertices(a.segsegVertex,e,l,d),(h=this.TransUtil.FindNextEdge(d.bracketSource,K.RotateLeft(l)))!=null?h:this.TransUtil.FindNextEdge(d.bracketSource,K.RotateRight(l))}u&=~l;let c=this.TransUtil.FindNearestPerpendicularOrContainingEdge(a.segsegVertex,u,e);return c==null?(o.targetVertex=this.TransUtil.AddVertex(i),this.TransUtil.FindOrAddEdge(o.targetVertex,t.HighestVisibilityVertex,t.Weight)):(a.segsegVertex=te.GetEdgeEnd(c,K.OppositeDir(u)),i=te.SegmentIntersectionPPP(e,i,a.segsegVertex.point),U.EqualPP(a.segsegVertex.point,i)?(o.targetVertex=a.segsegVertex,this.TransUtil.FindNextEdge(a.segsegVertex,u)):(o.targetVertex=this.TransUtil.FindOrAddVertex(i),this.TransUtil.FindOrAddEdge(a.segsegVertex,o.targetVertex,n)))}FindOrCreateSegmentIntersectionVertexAndAssociatedEdge(e,t,i,n,o){let l=(i.IsVertical?this.HScanSegments:this.VScanSegments).FindHighestIntersector(i.Start,t);if(l==null)return o.segsegVertex=null,o.targetVertex=this.TransUtil.AddVertex(t),this.TransUtil.FindOrAddEdge(o.targetVertex,i.LowestVisibilityVertex,i.Weight);let u=te.SegmentsIntersection(i,l);if(o.segsegVertex=this.VisGraph.FindVertex(u),!o.segsegVertex){o.segsegVertex=this.TransUtil.AddVertex(u);let c=this.AddEdgeToClosestSegmentEnd(i,o.segsegVertex,i.Weight);if(this.AddEdgeToClosestSegmentEnd(l,o.segsegVertex,l.Weight),U.EqualPP(o.segsegVertex.point,t))return o.targetVertex=o.segsegVertex,c}return U.EqualPP(e,t)?(o.targetVertex=this.TransUtil.FindOrAddVertex(t),this.TransUtil.FindOrAddEdge(o.segsegVertex,o.targetVertex,n)):(o.targetVertex=null,null)}AddEdgeToClosestSegmentEnd(e,t,i){return U.IsPureLower(e.HighestVisibilityVertex.point,t.point)?this.TransUtil.FindOrAddEdge(e.HighestVisibilityVertex,t,i):U.IsPureLower(t.point,e.LowestVisibilityVertex.point)?this.TransUtil.FindOrAddEdge(t,e.LowestVisibilityVertex,i):this.TransUtil.FindOrAddEdgeVV(e.LowestVisibilityVertex,t)}GetPortSpliceLimitRectangle(e){if(!this.LimitPortVisibilitySpliceToEndpointBoundingBox){this.portSpliceLimitRectangle=this.graphGenerator.ObstacleTree.GraphBox;return}this.portSpliceLimitRectangle=this.GetPortRectangle(e.sourcePort),this.portSpliceLimitRectangle.addRecSelf(this.GetPortRectangle(e.targetPort))}GetPortRectangle(e){let t=this.obstaclePortMap.get(e);return t?t.Obstacle.VisibilityBoundingBox.clone():X.mkOnPoints([m.RoundPoint(e.Location)])}AddToLimitRectangle(e){this.graphGenerator.IsInBoundsP(e)&&this.portSpliceLimitRectangle.add(e)}FindOrCreateFreePoint(e){let t=this.freePointMap.get(e);return t?t.GetVertex(this.TransUtil,e):(t=new Gm(this.TransUtil,e),this.freePointMap.set(e,t)),this.freePointsInGraph.add(t),this.freePointLocationsUsedByRouteEdges.add(e),t}AddFreePointToGraph(e){e=m.RoundPoint(e);let t=this.VisGraph.FindVertex(e),i=this.FindOrCreateFreePoint(e);if(t!=null)return i;if(!this.graphGenerator.IsInBoundsP(e))return this.CreateOutOfBoundsFreePoint(i),i;let n=null;i.IsOverlapped=this.ObstacleTree.PointIsInsideAnObstacle(i.Point,this.HScanSegments.ScanDirection);let o;if(this.VScanSegments.FindSegmentContainingPoint(e,!0),o!=null){let l={targetVertex:null};n=this.FindOrCreateNearestPerpEdgeFromNearestPerpSegment(e,o,e,i.InitialWeight,l)}let a=4;if(n!=null)a=te.EdgeDirectionVE(n),this.ConnectFreePointToLateralEdge(i,K.RotateLeft(a)),this.ConnectFreePointToLateralEdge(i,K.RotateRight(a));else for(let l=0;l<4;l++)this.ConnectFreePointToLateralEdge(i,a),a=K.RotateLeft(a);return i}CreateOutOfBoundsFreePoint(e){let t=e.Point,i=this.graphGenerator.MakeInBoundsLocation(t),n=U.GetDirections(i,t);if(e.OutOfBoundsDirectionFromGraph=n,!U.IsPureDirectionD(n)){e.AddOobEdgesFromGraphCorner(this.TransUtil,i);return}let o=this.VisGraph.FindVertex(i),a=K.OppositeDir(n);if(o!=null)e.AddToAdjacentVertex(this.TransUtil,o,a,this.portSpliceLimitRectangle);else{let c=this.FindorCreateNearestPerpEdgePPDN(t,i,n,ve.NormalWeight);c!=null&&(o=e.AddEdgeToAdjacentEdge(this.TransUtil,c,a,this.portSpliceLimitRectangle))}let l=te.FindAdjacentVertex(o,K.RotateLeft(a));l!=null&&this.TransUtil.ConnectVertexToTargetVertex(e.Vertex,l,a,ve.NormalWeight);let u=te.FindAdjacentVertex(o,K.RotateRight(a));u!=null&&this.TransUtil.ConnectVertexToTargetVertex(e.Vertex,u,a,ve.NormalWeight)}ConnectFreePointToLateralEdge(e,t){let i=e.IsOverlapped?this.InBoundsGraphBoxIntersect(e.Point,t):e.MaxVisibilityInDirectionForNonOverlappedFreePoint(t,this.TransUtil),n=this.FindorCreateNearestPerpEdgePPDN(i,e.Point,t,e.InitialWeight);n!=null&&e.AddEdgeToAdjacentEdge(this.TransUtil,n,t,this.portSpliceLimitRectangle)}};var cr=class extends Pe{constructor(t,i,n){super(null);this.Padding=0;this.CornerFitRadius=0;this.edgeSeparatian=3;this.BendPenaltyAsAPercentageOfDistance=0;this.ShapeToObstacleMap=new Map;this.EdgesToRoute=new Array;this.removeStaircases=!0;this.selfEdges=new Array;this.Padding=i,this.CornerFitRadius=n,this.BendPenaltyAsAPercentageOfDistance=Ki.DefaultBendPenaltyAsAPercentageOfDistance,this.GraphGenerator=new Mr,this.PortManager=new Da(this.GraphGenerator),this.AddShapes(t)}get RouteToCenterOfObstacles(){return this.PortManager.RouteToCenterOfObstacles}set RouteToCenterOfObstacles(t){this.PortManager.RouteToCenterOfObstacles=t}get LimitPortVisibilitySpliceToEndpointBoundingBox(){return this.PortManager.LimitPortVisibilitySpliceToEndpointBoundingBox}set LimitPortVisibilitySpliceToEndpointBoundingBox(t){this.PortManager.LimitPortVisibilitySpliceToEndpointBoundingBox=t}AddEdgeGeometryToRoute(t){m.closeDistEps(m.RoundPoint(t.sourcePort.Location),m.RoundPoint(t.targetPort.Location))?this.selfEdges.push(t):this.EdgesToRoute.push(t)}get EdgeGeometriesToRoute(){return this.EdgesToRoute}RemoveAllEdgeGeometriesToRoute(){this.EdgesToRoute=[]}get UseSparseVisibilityGraph(){return this.GraphGenerator instanceof Mr}get Obstacles(){return Array.from(this.ShapeToObstacleMap.values()).map(t=>t.InputShape)}get PaddedObstacles(){return Array.from(this.ShapeToObstacleMap.values()).map(t=>t.PaddedPolyline)}AddObstacles(t){this.AddShapes(t),this.RebuildTreeAndGraph()}AddShapes(t){for(let i of t)this.AddObstacleWithoutRebuild(i)}AddObstacle(t){this.AddObstacleWithoutRebuild(t),this.RebuildTreeAndGraph()}UpdateObstacles(t){for(let i of t)this.UpdateObstacleWithoutRebuild(i);this.RebuildTreeAndGraph()}UpdateObstacle(t){this.UpdateObstacleWithoutRebuild(t),this.RebuildTreeAndGraph()}RemoveObstacles(t){for(let i of t)this.RemoveObstacleWithoutRebuild(i);this.RebuildTreeAndGraph()}RemoveObstacle(t){this.RemoveObstacleWithoutRebuild(t),this.RebuildTreeAndGraph()}AddObstacleWithoutRebuild(t){if(t.BoundaryCurve==null)throw new Error("Shape must have a BoundaryCurve");this.CreatePaddedObstacle(t)}UpdateObstacleWithoutRebuild(t){if(t.BoundaryCurve==null)throw new Error("Shape must have a BoundaryCurve");this.PortManager.RemoveObstaclePorts(this.ShapeToObstacleMap.get(t)),this.CreatePaddedObstacle(t)}CreatePaddedObstacle(t){let i=new vr(t,this.Padding);this.ShapeToObstacleMap.set(t,i),this.PortManager.CreateObstaclePorts(i)}RemoveObstacleWithoutRebuild(t){let i=this.ShapeToObstacleMap.get(t);this.ShapeToObstacleMap.delete(t),this.PortManager.RemoveObstaclePorts(i)}RemoveAllObstacles(){this.InternalClear(!1)}RebuildTreeAndGraph(){let t=this.ObsTree.Root!=null,i=this.GraphGenerator.VisibilityGraph!=null;this.InternalClear(!0),t&&this.GenerateObstacleTree(),i&&this.GenerateVisibilityGraph()}get VisibilityGraph(){return this.GenerateVisibilityGraph(),this.GraphGenerator.VisibilityGraph}Clear(){this.InternalClear(!1)}static constructorEmpty(){return cr.constructorC(null)}static constructorC(t){return new cr([],cr.DefaultPadding,cr.DefaultCornerFitRadius)}static constructorI(t){return new cr(t,cr.DefaultPadding,cr.DefaultCornerFitRadius)}static constructorINN(t,i,n){return new cr(t,i,n)}static constructorGNAN(t,i,n,o){let a=new cr(xr.GetShapes(t),n,o);if(i==null)for(let l of t.deepEdges)a.AddEdgeGeometryToRoute(l);else for(let l of i)a.AddEdgeGeometryToRoute(l);return a}run(){this.GenerateVisibilityGraph(),this.GeneratePaths()}GeneratePaths(){let t=this.EdgesToRoute.map(i=>new Nm(i));this.FillEdgePathsWithShortestPaths(t),this.NudgePaths(t),this.RouteSelfEdges(),this.FinaliseEdgeGeometries()}RouteSelfEdges(){for(let t of this.selfEdges){let i={smoothedPolyline:null};t.curve=Ye.RouteSelfEdge(t.sourcePort.Curve,Math.max(this.Padding,2*t.GetMaxArrowheadLength()),i)}}FillEdgePathsWithShortestPaths(t){this.PortManager.BeginRouteEdges();let i=new Oa(this.BendPenaltyAsAPercentageOfDistance);for(let n of t)this.AddControlPointsAndGeneratePath(i,n);this.PortManager.EndRouteEdges()}AddControlPointsAndGeneratePath(t,i){let n=this.PortManager.GetPortVisibilityIntersection(i.GeomEdge);if(n!=null){this.GeneratePathThroughVisibilityIntersection(i,n);return}this.SpliceVisibilityAndGeneratePath(t,i)}GeneratePathThroughVisibilityIntersection(t,i){t.PathPoints=i}SpliceVisibilityAndGeneratePath(t,i){this.PortManager.AddControlPointsToGraph(i.GeomEdge,this.ShapeToObstacleMap),this.GeneratePath(t,i,!1)||this.RetryPathsWithAdditionalGroupsEnabled(t,i),this.PortManager.RemoveControlPointsFromGraph()}GeneratePath(t,i,n){let o=this.PortManager.FindVertices(i.GeomEdge.sourcePort),a=this.PortManager.FindVertices(i.GeomEdge.targetPort);return cr.GetSingleStagePath(i,t,o,a,n)}static GetSingleStagePath(t,i,n,o,a){return t.PathPoints=i.GetPath(n,o),a&&cr.EnsureNonNullPath(t),t.PathPoints!=null&&t.PathPoints.length>0}static EnsureNonNullPath(t){t.PathPoints==null&&(U.IsPureDirection(t.GeomEdge.sourcePort.Location,t.GeomEdge.targetPort.Location)?t.PathPoints=[t.GeomEdge.sourcePort.Location,t.GeomEdge.targetPort.Location]:t.PathPoints=[t.GeomEdge.sourcePort.Location,new m(t.GeomEdge.sourcePort.Location.x,t.GeomEdge.targetPort.Location.y),t.GeomEdge.targetPort.Location])}RetryPathsWithAdditionalGroupsEnabled(t,i){(!this.PortManager.SetAllAncestorsActive(i.GeomEdge,this.ShapeToObstacleMap)||!this.GeneratePath(t,i,!1))&&(this.PortManager.SetAllGroupsActive(),this.GeneratePath(t,i,!0))}NudgePaths(t){let i=this.ObsTree.SpatialAncestorsAdjusted?ke.GetAncestorSetsMap(this.Obstacles):this.AncestorsSets;st.NudgePaths(t,this.edgeSeparatian,this.PaddedObstacles,i,this.RemoveStaircases)}get RemoveStaircases(){return this.removeStaircases}set RemoveStaircases(t){this.removeStaircases=t}FinaliseEdgeGeometries(){for(let t of this.EdgesToRoute.concat(this.selfEdges)){if(t.curve==null)continue;t.curve instanceof ne&&(t.curve=cr.FitArcsIntoCorners(this.CornerFitRadius,Array.from(t.curve))),cr.CalculateArrowheads(t)}}CreateVisibilityGraph(){this.GraphGenerator.Clear(),this.InitObstacleTree(),this.GraphGenerator.GenerateVisibilityGraph()}static CalculateArrowheads(t){ut.trimSplineAndCalculateArrowheadsII(t,t.sourcePort.Curve,t.targetPort.Curve,t.curve,!0)}get ObsTree(){return this.GraphGenerator.ObstacleTree}GenerateObstacleTree(){if(this.Obstacles==null||this.Obstacles.length===0)throw new Error("No obstacles have been added");this.ObsTree.Root==null&&this.InitObstacleTree()}InitObstacleTree(){this.AncestorsSets=ke.GetAncestorSetsMap(this.Obstacles),this.ObsTree.Init(this.ShapeToObstacleMap.values(),this.AncestorsSets,this.ShapeToObstacleMap)}InternalClear(t){this.GraphGenerator.Clear(),this.ClearShortestPaths(),t?this.PortManager.ClearVisibility():(this.PortManager.Clear(),this.ShapeToObstacleMap.clear(),this.EdgesToRoute=[])}ClearShortestPaths(){for(let t of this.EdgesToRoute)t.curve=null}GenerateVisibilityGraph(){if(this.Obstacles==null||this.Obstacles.length===0)throw new Error("No obstacles have been set");this.GraphGenerator.VisibilityGraph==null&&this.CreateVisibilityGraph()}static FitArcsIntoCorners(t,i){if(t==0)return ne.mkFromPoints(i);let n=cr.GetFittedArcSegs(t,i),o=new I,a=null;for(let l of n){let u=cr.EllipseIsAlmostLineSegment(l);a!=null?u?I.continueWithLineSegmentP(o,cr.CornerPoint(l)):(I.continueWithLineSegmentP(o,l.start),o.addSegment(l)):u?I.addLineSegment(o,i[0],cr.CornerPoint(l)):(I.addLineSegment(o,i[0],l.start),o.addSegment(l)),a=l}return o.segs.length>0?I.continueWithLineSegmentP(o,i[i.length-1]):I.addLineSegment(o,i[0],i[i.length-1]),o}static CornerPoint(t){return t.center.add(t.aAxis.add(t.bAxis))}static EllipseIsAlmostLineSegment(t){return t.aAxis.lengthSquared<1e-4||t.aAxis.lengthSquared<1e-4}static*GetFittedArcSegs(t,i){let n=i[1].sub(i[0]),o=n.normalize(),a=Math.min(t,n.length/2);for(let l=1;l<i.length-1;l++){n=i[l+1].sub(i[l]);let u=n.length;if(u<R.intersectionEpsilon){yield new pe(0,0,new m(0,0),new m(0,0),i[l]);continue}let c=n.div(u);Math.abs(c.dot(o))>.9&&(yield new pe(0,0,new m(0,0),new m(0,0),i[l]));let h=Math.min(t,n.length/2),d=c.mul(-h),f=o.mul(a);yield new pe(0,Math.PI/2,d,f,i[l].sub(f.add(d))),o=c,a=h}}},Ga=cr;Ga.DefaultPadding=1,Ga.DefaultCornerFitRadius=3;var hA=Ae(sr(),1),Li=class{constructor(e,t,i,n=1){this.Source=e,this.Target=t,this.CrossingWeight=i,this.Weight=n}toString(){return hA.String.Format("{0}->{1}",this.Source,this.Target)}};var Fa=class{static FindClosestPoints(e,t){let i=I.minDistWithinIntervals(e,t,e.parStart,e.parEnd,t.parStart,t.parEnd,(e.parStart+e.parEnd)/2,(t.parStart+t.parEnd)/2);if(i)return{curveClosestPoint:i.aX,labelSideClosest:i.bX}}static GetSegmentInFrontOfLabel(e,t){if(e instanceof I){for(let i of e.segs)if((i.start.y-t)*(i.end.y-t)<=0)return i}return null}static ShiftLabel(e,t,i){let n=e.lineWidth/2,o=t.sub(i),a=o.length;a>n&&e.label.positionCenter(e.label.center.add(o.div(a*(a-n))))}static updateLabel(e,t){let i=null;t.labelIsToTheRightOfTheSpline?(e.label.positionCenter(new m(t.x+t.rightAnchor/2,t.y)),i=k.mkPP(e.label.boundingBox.leftTop,e.label.boundingBox.leftBottom)):t.labelIsToTheLeftOfTheSpline&&(e.label.positionCenter(new m(t.x-t.leftAnchor/2,t.y)),i=k.mkPP(e.label.boundingBox.rightTop,e.label.boundingBox.rightBottom));let n=Fa.GetSegmentInFrontOfLabel(e.curve,e.label.center.y);if(n!=null&&I.getAllIntersections(e.curve,I.polyFromBox(e.label.boundingBox),!1).length===0){let o=Fa.FindClosestPoints(n,i);if(o)Fa.ShiftLabel(e,o.curveClosestPoint,o.labelSideClosest);else{let a,l,u=n.closestParameter(i.start),c=n.closestParameter(i.end);n.value(u).sub(i.start).length<n.value(c).sub(i.end).length?(a=n.value(u),l=i.start):(a=n.value(c),l=i.end),Fa.ShiftLabel(e,a,l)}}}},Br=class{constructor(e,t,i,n=1,o=1){this.reversed=!1;this.source=e,this.target=t,this.edge=i,this.weight=n,this.separation=o}get CrossingWeight(){return 1}get hasLabel(){return this.edge.label!=null}get labelWidth(){return this.edge.label.width}get labelHeight(){return this.edge.label.height}reverse(){let e=this.source;this.source=this.target,this.target=e,this.reversed=!this.reversed}toString(){return"edge("+this.source+"->"+this.target+")"}get curve(){return this.edge.curve}set curve(e){this.edge.curve=e}get underlyingPolyline(){return this.edge.smoothedPolyline}get LayerSpan(){return this.LayerEdges!=null?this.LayerEdges.length:0}isSelfEdge(){return this.source===this.target}reversedClone(){let e=new Br(this.target,this.source,this.edge);if(this.LayerEdges!=null){let t=this.LayerEdges.length;e.LayerEdges=new Array(t);for(let i=0;i<t;i++){let n=this.LayerEdges[t-1-i];e.LayerEdges[i]=new Li(n.Target,n.Source,n.CrossingWeight)}e.LayerEdges[0].Source=this.target,e.LayerEdges[this.LayerEdges.length-1].Target=this.source}return e}get count(){return this.LayerEdges.length}getNode(e){if(e>=0){if(e<this.LayerEdges.length)return this.LayerEdges[e].Source;if(e===this.LayerEdges.length)return this.LayerEdges[e-1].Target}throw new Error("wrong index "+e)}updateEdgeLabelPosition(e){if(this.edge.label!=null){let t=this.LayerEdges.length/2,i=this.LayerEdges[t];Fa.updateLabel(this.edge,e[i.Source])}}[Symbol.iterator](){return this.nodes()}*nodes(){yield this.LayerEdges[0].Source;for(let e of this.LayerEdges)yield e.Target}};var zm=class{constructor(){this.maxLayerOfGeomGraph=new Set;this.minLayerOfGeomGraph=new Set;this.sameLayerConstraints=new Array;this.upDownConstraints=new Array;this.gluedUpDownIntConstraints=new Cr;this.sameLayerDictionaryOfRepresentatives=new Map;this.representativeToItsLayer=new Map;this.maxLayerInt=new Array;this.minLayerInt=new Array;this.sameLayerInts=new Array;this.upDownInts=new Array}getFeedbackSetExternal(e,t){throw new Error("Method not implemented.")}pinNodeToMaxLayer(e){this.maxLayerOfGeomGraph.add(e)}pinNodeToMinLayer(e){this.minLayerOfGeomGraph.add(e)}get isEmpty(){return this.maxLayerOfGeomGraph.size===0&&this.minLayerOfGeomGraph.size===0&&this.sameLayerConstraints.length===0&&this.upDownConstraints.length===0}clear(){this.maxLayerOfGeomGraph.clear(),this.minLayerOfGeomGraph.clear(),this.sameLayerConstraints=[],this.upDownConstraints=[]}getFeedbackSetImp(e,t){return this.nodeIdToIndex=t,this.intGraph=e,this.maxRepresentative=-1,this.minRepresentative=-1,this.createIntegerConstraints(),this.glueTogetherSameConstraintsMaxAndMin(),this.addMaxMinConstraintsToGluedConstraints(),this.removeCyclesFromGluedConstraints(),this.getFeedbackSet()}removeCyclesFromGluedConstraints(){let e=Sr(Array.from(this.gluedUpDownIntConstraints.values()),this.intGraph.nodeCount),t=Ii.getFeedbackSetWithConstraints(e,null);for(let i of t)this.gluedUpDownIntConstraints.remove(i)}addMaxMinConstraintsToGluedConstraints(){if(this.maxRepresentative!==-1)for(let e=0;e<this.intGraph.nodeCount;e++){let t=this.nodeToRepr(e);t!==this.maxRepresentative&&this.gluedUpDownIntConstraints.add(new me(this.maxRepresentative,t))}if(this.minRepresentative!==-1)for(let e=0;e<this.intGraph.nodeCount;e++){let t=this.nodeToRepr(e);t!==this.minRepresentative&&this.gluedUpDownIntConstraints.add(new me(t,this.minRepresentative))}}glueTogetherSameConstraintsMaxAndMin(){this.createDictionaryOfSameLayerRepresentatives();let e=this.upDownInts.map(this.gluedIntPairNN);this.gluedUpDownIntConstraints=new Cr}gluedIntPairNN(e){return new me(this.nodeToRepr(e[0]),this.nodeToRepr(e[1]))}gluedIntPairI(e){return new me(this.nodeToRepr(e.source),this.nodeToRepr(e.target))}gluedIntPair(e){return new me(this.nodeToRepr(e.source),this.nodeToRepr(e.target))}gluedIntEdge(e){let t=this.nodeToRepr(e.source),i=this.nodeToRepr(e.target),n=new Br(t,i,e.edge);return n.separation=e.separation,n.weight=0,n}nodeToRepr(e){let t=this.sameLayerDictionaryOfRepresentatives.get(e);return t||e}createDictionaryOfSameLayerRepresentatives(){let e=this.createGraphOfSameLayers();for(let t of Yn(e))this.glueSameLayerNodesOfALayer(t)}createGraphOfSameLayers(){return Sr(this.createEdgesOfSameLayers(),this.intGraph.nodeCount)}createEdgesOfSameLayers(){let e=new Array;return this.maxRepresentative!==-1&&this.maxLayerInt.filter(t=>t!==this.maxRepresentative).map(t=>new me(this.maxRepresentative,t)).forEach(t=>e.push(t)),this.minRepresentative!==-1&&this.minLayerInt.filter(t=>t!==this.minRepresentative).map(t=>new me(this.minRepresentative,t)).forEach(t=>e.push(t)),this.sameLayerInts.forEach(t=>e.push(new me(t[0],t[1]))),e}glueSameLayerNodesOfALayer(e){if(e.length>1){let t=-1;if(this.componentsIsMaxLayer(e))for(let i of e)this.sameLayerDictionaryOfRepresentatives.set(i,t=this.maxRepresentative);else if(this.componentIsMinLayer(e))for(let i of e)this.sameLayerDictionaryOfRepresentatives.set(i,t=this.minRepresentative);else for(let i of e)t===-1&&(t=i),this.sameLayerDictionaryOfRepresentatives.set(i,t);this.representativeToItsLayer.set(t,e)}}componentIsMinLayer(e){return e.findIndex(t=>this.minRepresentative===t)>=0}componentsIsMaxLayer(e){return e.findIndex(t=>this.maxRepresentative===t)>=0}createIntegerConstraints(){this.createMaxIntConstraints(),this.createMinIntConstraints(),this.createUpDownConstraints(),this.createSameLayerConstraints()}createSameLayerConstraints(){this.sameLayerInts=this.createIntConstraintsFromStringCouples(this.sameLayerConstraints)}createUpDownConstraints(){this.upDownInts=this.createIntConstraintsFromStringCouples(this.upDownConstraints)}createIntConstraintsFromStringCouples(e){return e.map(t=>[this.nodeIndex(t[0]),this.nodeIndex(t[1])]).filter(t=>t[0]!==-1&&t[1]!==-1)}createMinIntConstraints(){this.minLayerInt=this.createIntConstraintsFromExtremeLayer(this.minLayerOfGeomGraph),this.minLayerInt.length>0&&(this.minRepresentative=this.minLayerInt[0])}createMaxIntConstraints(){this.maxLayerInt=this.createIntConstraintsFromExtremeLayer(this.maxLayerOfGeomGraph),this.maxLayerInt.length>0&&(this.maxRepresentative=this.maxLayerInt[0])}createIntConstraintsFromExtremeLayer(e){return Array.from(e).map(t=>this.nodeIndex(t)).filter(t=>t!==-1)}nodeIndex(e){let t=this.nodeIdToIndex.get(e.node.id);return t||-1}getFeedbackSet(){return this.gluedIntGraph=this.createGluedGraph(),Array.from(this.unglueIntPairs(Ii.getFeedbackSetWithConstraints(this.gluedIntGraph,this.gluedUpDownIntConstraints)))}*unglueIntPairs(e){for(let t of e)for(let i of this.unglueEdge(t))yield i}*unglueEdge(e){for(let t of this.unglueNode(e.source))for(let i of this.intGraph.outEdges[t])this.nodeToRepr(i.target)===e.target&&(yield i)}createGluedGraph(){let e=new Cr;return this.intGraph.edges.forEach(t=>e.add(this.gluedIntPairI(t))),Sr(Array.from(e.values()),this.intGraph.nodeCount)}unglueNode(e){let t=this.representativeToItsLayer.get(e);return t||[e]}getGluedNodeCounts(){let e=new Array(this.nodeIdToIndex.size).fill(0);for(let t=0;t<e.length;t++)e[this.nodeToRepr(t)]++;return e}};function gN(s,e){return[s,e]}var Wm=class{constructor(){this.leftRightConstraints=new Array;this.leftRightNeighbors=new Array;this.nodeToBlockRoot=new Map;this.upDownVerticalConstraints=new Array;this.BlockRootToBlock=new Map}get IsEmpty(){return this.leftRightNeighbors.length===0&&this.upDownVerticalConstraints.length===0&&this.leftRightConstraints.length===0}AddSameLayerNeighbors(e){for(let t=0;t<e.length-1;t++)this.AddSameLayerNeighborsPair(e[t],e[t+1])}AddSameLayerNeighborsPair(e,t){this.leftRightNeighbors.push([e,t])}NodeToBlockRootSoft(e){let t=this.nodeToBlockRoot.get(e);return t||e}CreateMappingOfNeibBlocks(){let e=this.BasicGraphFromLeftRightIntNeibs();for(let t=0;t<e.nodeCount;t++)if(e.inEdges[t].length===0&&!this.nodeToBlockRoot.has(t)){let i=new Array,n=t;for(let o=e.outEdges[n];o.length>0;o=e.outEdges[n])n=o[0].y,i.push(n),this.nodeToBlockRoot.set(n,t);i.length>0&&this.BlockRootToBlock.set(t,i)}}BasicGraphFromLeftRightIntNeibs(){return Oc(Array.from(this.LeftRightIntNeibs.values()).map(e=>new me(e.x,e.y)))}NodeIndex(e){let t=this.nodeIdToIndex.get(e.id);return t||-1}PrepareForOrdering(e,t){this.nodeIdToIndex=e,this.MapNodesToToIntegers(t),this.CreateMappingOfNeibBlocks(),this.LiftLeftRightRelationsToNeibBlocks()}LiftLeftRightRelationsToNeibBlocks(){this.LeftRighInts=Cr.mk(this.leftRightConstraints.map(t=>gN(this.NodeIndex(t[0]),this.NodeIndex(t[1]))).filter(t=>t[0]!==-1&&t[1]!==-1).map(t=>new me(this.NodeToBlockRootSoft(t[0]),this.NodeToBlockRootSoft(t[1]))).filter(t=>t.x!==t.x));let e=Ii.getFeedbackSet(Oc(Array.from(this.LeftRighInts.values())));for(let t of e)this.LeftRighInts.remove(new me(t.source,t.target))}MapNodesToToIntegers(e){this.LeftRightIntNeibs=Cr.mk(Array.from(this.leftRightNeighbors.values()).map(t=>[this.NodeIndex(t[0]),this.NodeIndex(t[1])]).filter(t=>t[0]!==-1&&t[1]!==-1).map(t=>new me(t[0],t[1]))),this.VerticalInts=Cr.mk(this.upDownVerticalConstraints.map(t=>[this.NodeIndex(t[0]),this.NodeIndex(t[1])]).filter(t=>t[0]!==-1&&t[1]!==-1&&e[t[0]]>e[t[1]]).map(t=>new me(t[0],t[1])))}};var Hc=(o=>(o[o.TB=0]="TB",o[o.LR=1]="LR",o[o.BT=2]="BT",o[o.RL=3]="RL",o[o.None=4]="None",o))(Hc||{});var Ho=class{constructor(){this.coneAngle=30*(Math.PI/180);this.padding=2;this.polylinePadding=1;this.routingToParentConeAngle=Math.PI/6;this.simpleSelfLoopsForParentEdgesThreshold=200;this.incrementalRoutingThreshold=5e6;this.routeMultiEdgesAsBundles=!0;this.KeepOriginalSpline=!1;this.EdgeRoutingMode=0}toJSON(){let e={};return this.EdgeRoutingMode!=0&&(e.edgeRoutingMode=0),this.ConeAngle!=30*(Math.PI/180)&&(e.coneAngle=this.ConeAngle),this.padding!=3&&(e.padding=this.padding),this.polylinePadding!=1.5&&(e.polylinePadding=this.polylinePadding),this.bundlingSettings&&(e.bundlingSettingsJSON=this.bundlingSettings.toJSON()),e}static fromJSON(e){let t=new Ho;return e.edgeRoutingMode&&(e.edgeRoutingMode=t.edgeRoutingMode),e.coneAngle&&(t.coneAngle=e.coneAngle),e.padding&&(t.padding=e.padding),e.polylinePadding&&(t.polylinePadding=e.polylinePadding),e.bundlingSettingsJSON&&(t.bundlingSettings=Sn.createFromJSON(e.bundlingSettingsJSON)),e.routingToParentConeAngle&&(t.routingToParentConeAngle=e.routingToParentConeAngle),e.simpleSelfLoopsForParentEdgesThreshold&&(t.simpleSelfLoopsForParentEdgesThreshold=e.simpleSelfLoopsForParentEdgesThreshold),e.incrementalRoutingThreshold&&(t.incrementalRoutingThreshold=e.incrementalRoutingThreshold),e.routeMultiEdgesAsBundles&&(t.routeMultiEdgesAsBundles=e.routeMultiEdgesAsBundles),e.KeepOriginalSpline&&(t.KeepOriginalSpline=e.KeepOriginalSpline),t}get EdgeRoutingMode(){return this.edgeRoutingMode}set EdgeRoutingMode(e){e===1&&this.bundlingSettings==null&&this.bundlingSettings==null&&(this.bundlingSettings=new Sn),this.edgeRoutingMode=e}get ConeAngle(){return this.coneAngle}set ConeAngle(e){this.coneAngle=e}get Padding(){return this.padding}set Padding(e){this.padding=e}get PolylinePadding(){return this.polylinePadding}set PolylinePadding(e){this.polylinePadding=e}get RoutingToParentConeAngle(){return this.routingToParentConeAngle}set RoutingToParentConeAngle(e){this.routingToParentConeAngle=e}get SimpleSelfLoopsForParentEdgesThreshold(){return this.simpleSelfLoopsForParentEdgesThreshold}set SimpleSelfLoopsForParentEdgesThreshold(e){this.simpleSelfLoopsForParentEdgesThreshold=e}get IncrementalRoutingThreshold(){return this.incrementalRoutingThreshold}set IncrementalRoutingThreshold(e){this.incrementalRoutingThreshold=e}get RouteMultiEdgesAsBundles(){return this.routeMultiEdgesAsBundles}set RouteMultiEdgesAsBundles(e){this.routeMultiEdgesAsBundles=e}};var Qn=class{constructor(){this.edgeRoutingSettings=new Ho;this.nodeSeparation=10;this.packingAspectRatio=1.5}static fromJSON(e){let t=new Qn;return e.nodeSeparation!=10&&(t.nodeSeparation=e.nodeSeparation),e.packingAspectRatio&&(t.packingAspectRatio=e.packingAspectRatio),e.edgeRoutingSettings&&(t.edgeRoutingSettings=Ho.fromJSON(e.edgeRoutingSettings)),t}toJSON(){let e=!1,t={};return this.nodeSeparation!=10&&(t.nodeSeparation=this.nodeSeparation,e=!0),this.packingAspectRatio!=1.5&&(t.packingAspectRatio=this.packingAspectRatio,e=!0),(t.edgeRoutingSettings=this.edgeRoutingSettings.toJSON())&&(e=!0),e?t:void 0}get NodeSeparation(){return this.nodeSeparation}set NodeSeparation(e){this.nodeSeparation=e}get PackingAspectRatio(){return this.packingAspectRatio}set PackingAspectRatio(e){this.packingAspectRatio=e}};var Bt=class{constructor(){this.commonSettings=new Qn;this.verticalConstraints=new zm;this.horizontalConstraints=new Wm;this.NoGainAdjacentSwapStepsBound=5;this.NoGainStepsForOrderingMultiplier=1;this.AspectRatio=0;this.MaxNumberOfPassesInOrdering=24;this.BrandesThreshold=600;this.LabelCornersPreserveCoefficient=.1;this.MinNodeHeight=72*.5/4;this.MinNodeWidth=72*.75/4;this.SnapToGridByY=0;this.yLayerSep=10*3;this.transform=Et.getIdentity();this.GridSizeByY=0;this.GridSizeByX=0;this.commonSettings.edgeRoutingSettings.EdgeRoutingMode=3}get NodeSeparation(){return this.commonSettings.NodeSeparation}get edgeRoutingSettings(){return this.commonSettings.edgeRoutingSettings}set edgeRoutingSettings(e){this.commonSettings.edgeRoutingSettings=e}toJSON(){let e={};return this.sameRanks&&(e.sameRanks=this.sameRanks),this.verticalConstraints&&(e.verticalConstraints=this.verticalConstraints),this.horizontalConstraints&&(e.horizontalConstraints=this.horizontalConstraints),this.NoGainAdjacentSwapStepsBound!=5&&(e.horizontalConstraints=this.horizontalConstraints),this.NoGainStepsForOrderingMultiplier!=1&&(e.RepetitionCoefficientForOrdering=this.NoGainStepsForOrderingMultiplier),this.AspectRatio&&(e.AspectRatio=this.AspectRatio),this.MaxNumberOfPassesInOrdering!=24&&(e.MaxNumberOfPassesInOrdering=this.MaxNumberOfPassesInOrdering),this.BrandesThreshold!=600&&(e.BrandesThreshold=this.BrandesThreshold),this.LabelCornersPreserveCoefficient!=.1&&(e.LabelCornersPreserveCoefficient=this.LabelCornersPreserveCoefficient),this.MinNodeHeight!=72*.5/4&&(e.MinNodeHeight=this.MinNodeHeight),this.MinNodeWidth!=72*.75/4&&(e.MinNodeWidth=this.MinNodeWidth),this.SnapToGridByY!=0&&(e.SnapToGridByY=this.SnapToGridByY),this.yLayerSep!=10*3&&(e.yLayerSep=this.yLayerSep),this.transform&&(e.transform=this.transform.elements),this.GridSizeByY&&(e.GridSizeByY=this.GridSizeByY),this.GridSizeByX&&(e.GridSizeByX=this.GridSizeByX),e.commonLayoutSettings=this.commonSettings.toJSON(),e}static fromJSON(e){let t=new Bt;return e.sameRanks&&(t.sameRanks=e.sameRanks),e.verticalConstraints&&(t.verticalConstraints=e.verticalConstraints),e.horizontalConstraints&&(t.horizontalConstraints=e.horizontalConstraints),e.NoGainAdjacentSwapStepsBound&&(t.horizontalConstraints=e.horizontalConstraints),e.RepetitionCoefficientForOrdering&&(t.NoGainStepsForOrderingMultiplier=e.RepetitionCoefficientForOrdering),e.AspectRatio&&(t.AspectRatio=e.AspectRatio),e.MaxNumberOfPassesInOrdering&&(t.MaxNumberOfPassesInOrdering=e.MaxNumberOfPassesInOrdering),e.BrandesThreshold&&(t.BrandesThreshold=e.BrandesThreshold),e.LabelCornersPreserveCoefficient&&(t.LabelCornersPreserveCoefficient=e.LabelCornersPreserveCoefficient),e.MinNodeHeight&&(t.MinNodeHeight=e.MinNodeHeight),e.MinNodeWidth&&(t.MinNodeWidth=t.MinNodeWidth),e.SnapToGridByY&&(t.SnapToGridByY=e.SnapToGridByY),e.yLayerSep&&(t.yLayerSep=e.yLayerSep),e.transform&&(t.transform=new Et(e.transform[0][0],e.transform[0][1],e.transform[0][2],e.transform[1][0],e.transform[1][1],e.transform[1][2])),e.GridSizeByY&&(t.GridSizeByY=e.GridSizeByY),e.GridSizeByX&&(t.GridSizeByX=e.GridSizeByX),e.commonLayoutSettings&&(t.commonSettings=Qn.fromJSON(e.commonLayoutSettings)),t}get LayerSeparation(){return this.yLayerSep}set LayerSeparation(e){this.yLayerSep=Math.max(10*3,e)}ActualLayerSeparation(e){return e?this.LayerSeparation/2:this.LayerSeparation}transformIsRotation(e){let t=Et.rotation(e);for(let i=0;i<2;i++)for(let n=0;n<3;n++)if(!ue(t.elements[i][n],this.transform.elements[i][n]))return!1;return!0}get layerDirection(){if(this.transformIsRotation(0))return 0;if(this.transformIsRotation(Math.PI/2))return 1;if(this.transformIsRotation(-Math.PI/2))return 3;if(this.transformIsRotation(Math.PI))return 2;throw new Error("unexpected layout direction")}set layerDirection(e){switch(e){case 0:this.transform=Et.getIdentity();break;case 1:this.transform=Et.rotation(Math.PI/2);break;case 3:this.transform=Et.rotation(-Math.PI/2);break;case 2:this.transform=Et.rotation(Math.PI);break;default:throw new Error("unexpected layout direction")}}};var jc=class extends Pe{constructor(t,i,n){super(null);this.graph=t,this.source=i,this.length=n}get Result(){return this.result}run(){let t=new Er((o,a)=>o-a),i=new Map;for(let o of this.graph.shallowNodes){let a=o===this.source?0:Number.POSITIVE_INFINITY;t.Enqueue(o,a),i.set(o,a)}for(;t.count>0;){let o={priority:0},a=t.DequeueAndGetPriority(o);i.set(a,o.priority);let l=i.get(a);for(let u of a.inEdges()){let c=u.source,h=l+this.length(u);i.get(c)>h&&(i.set(c,h),t.DecreasePriority(c,h))}for(let u of a.outEdges()){let c=u.target,h=l+this.length(u);i.get(c)>h&&(i.set(c,h),t.DecreasePriority(c,h))}}this.result=new Array(this.graph.shallowNodeCount);let n=0;for(let o of this.graph.shallowNodes){let a=i.get(o);a!==void 0?this.result[n++]=a:this.result[n++]=Number.POSITIVE_INFINITY}}};var qc=class extends Pe{constructor(t,i){super(null);this.graph=t,this.length=i}get Result(){return this.result}set Result(t){this.result=t}run(){this.result=new Array(this.graph.shallowNodeCount);let t=0;for(let i of this.graph.shallowNodes){let n=new jc(this.graph,i,this.length);n.run(),this.Result[t++]=n.Result}}static Stress(t,i){let n=0;if(t.edgeCount===0)return n;let o=new qc(t,i);o.run();let a=o.Result,l=0;for(let c of t.shallowEdges)l+=i(c);l/=t.edgeCount;let u=0;for(let c of t.shallowNodes){let h=0;for(let d of t.shallowNodes){if(u!==h){let f=c.center.sub(d.center).length,p=l*a[u][h],S=p-f;n+=S*S/(p*p)}h++}u++}return n}};var Hm=class extends Pe{constructor(t,i,n){super(null);this.graph=t,this.pivotArray=i,this.length=n}get Result(){return this.result}run(){this.result=new Array(this.pivotArray.length);let t=Array.from(this.graph.shallowNodes),i=new Array(this.graph.shallowNodeCount).fill(Number.POSITIVE_INFINITY),n=t[0];this.pivotArray[0]=0;for(let o=0;;o++){let a=new jc(this.graph,n,this.length);if(a.run(),this.Result[o]=a.Result,o+1<this.pivotArray.length){let l=0;for(let u=0;u<this.Result[o].length;u++)i[u]=Math.min(i[u],this.Result[o][u]),i[u]>i[l]&&(l=u);n=t[l],this.pivotArray[o+1]=l}else break}}};var jm=class{static Rotate(e,t,i){let n=Math.sin(i*(Math.PI/180)),o=Math.cos(i*(Math.PI/180));for(let a=0;a<e.length;a++){let l=o*e[a]+n*t[a];t[a]=o*t[a]-n*e[a],e[a]=l}}};var rt=class{static DoubleCenter(e){let t=new Array(e.length).fill(0),i=new Array(e[0].length).fill(0),n=0;for(let o=0;o<e.length;o++)for(let a=0;a<e[0].length;a++)t[o]+=e[o][a],i[a]+=e[o][a],n+=e[o][a];for(let o=0;o<e.length;o++)t[o]/=e.length;for(let o=0;o<e[0].length;o++)i[o]/=e[0].length;n/=e.length,n/=e[0].length;for(let o=0;o<e.length;o++)for(let a=0;a<e[0].length;a++)e[o][a]-=t[o]+i[a]-n}static SquareEntries(e){for(let t=0;t<e.length;t++)for(let i=0;i<e[0].length;i++)e[t][i]=Math.pow(e[t][i],2)}static Multiply(e,t){for(let i=0;i<e.length;i++)for(let n=0;n<e[0].length;n++)e[i][n]*=t}static MultiplyX(e,t){if(e[0].length!==t.length)return null;let i=new Array(t.length).fill(0);for(let n=0;n<e.length;n++)for(let o=0;o<e[0].length;o++)i[n]+=e[n][o]*t[o];return i}static Norm(e){let t=0;for(let i=0;i<e.length;i++)t+=Math.pow(e[i],2);return Math.sqrt(t)}static Normalize(e){let t=rt.Norm(e);if(t<=0)return 0;for(let i=0;i<e.length;i++)e[i]/=t;return t}static RandomUnitLengthVector(e){let t=new Array(e);for(let i=0;i<e;i++)t[i]=Go();return rt.Normalize(t),t}static SpectralDecomposition(e,t){rt.SpectralDecompositionIE(e,t,30,1e-6)}static SpectralDecompositionIE(e,t,i,n){let o=e[0].length;t.u1=rt.RandomUnitLengthVector(o),t.lambda1=0,t.u2=rt.RandomUnitLengthVector(o),t.lambda2=0;let a=0,l=1-n;for(let u=0;u<i&&a<l;u++){let c=rt.MultiplyX(e,t.u1),h=rt.MultiplyX(e,t.u2);t.lambda1=rt.Normalize(c),t.lambda2=rt.Normalize(h),rt.MakeOrthogonal(h,c),rt.Normalize(h),a=Math.min(rt.DotProduct(t.u1,c),rt.DotProduct(t.u2,h)),t.u1=c,t.u2=h}}static DotProduct(e,t){if(e.length!==t.length)return 0;let i=0;for(let n=0;n<e.length;n++)i+=e[n]*t[n];return i}static MakeOrthogonal(e,t){if(e.length!==t.length)return;let i=rt.DotProduct(e,t)/rt.DotProduct(t,t);for(let n=0;n<e.length;n++)e[n]-=i*t[n]}static ClassicalScaling(e,t){let i=new Array(e.length);for(let n=0;n<e.length;n++)i[n]=e[n].slice();rt.SquareEntries(i),rt.DoubleCenter(i),rt.Multiply(i,-.5),rt.SpectralDecomposition(i,t),t.lambda1=Math.sqrt(Math.abs(t.lambda1)),t.lambda2=Math.sqrt(Math.abs(t.lambda2));for(let n=0;n<t.u1.length;n++)t.u1[n]*=t.lambda1,t.u2[n]*=t.lambda2}static DistanceScalingSubset(e,t,i,n,o){let a=t.length,l=e.length,u=new Array(l);for(let h=0;h<l;h++)for(let d=0;d<a;d++)e[h][d]===0&&(u[h]=d);let c=new Array(l).fill(0);for(let h=0;h<l;h++)for(let d=0;d<a;d++)u[h]!==d&&(c[h]+=n[h][d]);for(let h=0;h<o;h++)for(let d=0;d<l;d++){let f=0,p=0;for(let S=0;S<a;S++)if(d!==S){let E=Math.sqrt(Math.pow(t[u[d]]-t[S],2)+Math.pow(i[u[d]]-i[S],2));E>0&&(E=1/E),f+=n[d][S]*(t[S]+e[d][S]*(t[u[d]]-t[S])*E),p+=n[d][S]*(i[S]+e[d][S]*(i[u[d]]-i[S])*E)}t[u[d]]=f/c[d],i[u[d]]=p/c[d]}}static DistanceScaling(e,t,i,n,o){let a=t.length,l=new Array(a).fill(0);for(let u=0;u<a;u++)for(let c=0;c<a;c++)u!==c&&(l[u]+=n[u][c]);for(let u=0;u<o;u++)for(let c=0;c<a;c++){let h=0,d=0;for(let f=0;f<a;f++)if(c!==f){let p=Math.sqrt(Math.pow(t[c]-t[f],2)+Math.pow(i[c]-i[f],2));p>0&&(p=1/p),h+=n[c][f]*(t[f]+e[c][f]*(t[c]-t[f])*p),d+=n[c][f]*(i[f]+e[c][f]*(i[c]-i[f])*p)}t[c]=h/l[c],i[c]=d/l[c]}}static ExponentialWeightMatrix(e,t){let i=new Array(e.length);for(let n=0;n<e.length;n++){i[n]=new Array(e[n].length).fill(0);for(let o=0;o<e[n].length;o++)e[n][o]>0&&(i[n][o]=Math.pow(e[n][o],t))}return i}static EuclideanDistanceMatrix(e,t){let i=new Array(e.length);for(let n=0;n<e.length;n++){i[n]=new Array(e.length);for(let o=0;o<e.length;o++)i[n][o]=Math.sqrt(Math.pow(e[n]-e[o],2)+Math.pow(t[n]-t[o],2))}return i}static LandmarkClassicalScaling(e,t,i){let n=new Array(e.length);for(let l=0;l<e.length;l++){n[l]=new Array(e.length);for(let u=0;u<e.length;u++)n[l][u]=e[l][i[u]]}rt.SquareEntries(n);let o=new Array(e.length).fill(0);for(let l=0;l<e.length;l++){for(let u=0;u<e.length;u++)o[l]+=n[l][u];o[l]/=e.length}rt.DoubleCenter(n),rt.Multiply(n,-.5);let a={u1:new Array,u2:new Array,lambda1:0,lambda2:0};rt.SpectralDecomposition(n,a),a.lambda1=Math.sqrt(Math.abs(a.lambda1)),a.lambda2=Math.sqrt(Math.abs(a.lambda2)),t.x=new Array(e[0].length).fill(0),t.y=new Array(e[0].length).fill(0);for(let l=0;l<t.x.length;l++)for(let u=0;u<n.length;u++){let c=(Math.pow(e[u][l],2)-o[u])/2;t.x[l]-=a.u1[u]*c,t.y[l]-=a.u2[u]*c}}};var dA=Ae(sr(),1);var qm=class{constructor(e,t){this.constrained=!1;this.Capacity=1e6;qe.AbovePP(e.point,t.point)===1?(this.upperSite=e,this.lowerSite=t):(this.lowerSite=e,this.upperSite=t),this.upperSite.AddEdgeToSite(this)}get CcwTriangle(){return this.ccwTriangle}set CcwTriangle(e){this.ccwTriangle=e}get CwTriangle(){return this.cwTriangle}set CwTriangle(e){this.cwTriangle=e}GetOtherTriangle_c(e){return this.cwTriangle.Contains(e)?this.ccwTriangle:this.cwTriangle}IsAdjacent(e){return e===this.upperSite||e===this.lowerSite}GetOtherTriangle_T(e){return this.ccwTriangle===e?this.cwTriangle:this.ccwTriangle}toString(){return dA.String.Format("({0},{1})",this.upperSite,this.lowerSite)}OtherSite(e){return this.upperSite===e?this.lowerSite:this.upperSite}};var Va=class{constructor(e){this.Owner=null;this.InEdges=new Array;this.point=e}cleanRemovedEdges(){for(let e of this.Edges)e.CcwTriangle===null&&e.CwTriangle===null&&this.Edges.splice(this.Edges.indexOf(e),1)}static mkSO(e,t){let i=new Va(e);return i.Owner=t,i}AddEdgeToSite(e){this.Edges==null&&(this.Edges=new Array),this.Edges.push(e)}EdgeBetweenUpperSiteAndLowerSite(e){if(this.Edges!=null){for(let t of this.Edges)if(t.lowerSite===e)return t}return null}AddInEdge(e){this.InEdges.push(e)}*Triangles(){let e;if(this.Edges!=null&&this.Edges.length>0)e=this.Edges[0];else if(this.InEdges!=null&&this.InEdges.length>0)e=this.InEdges[0];else return;let t=e;do{let i=t.upperSite===this?t.CcwTriangle:t.CwTriangle;if(i==null){t=null;break}yield i,t=i.Edges.getItem(i.Edges.index(t)+2)}while(t!==e);if(t!==e){t=e;do{let i=t.upperSite===this?t.CwTriangle:t.CcwTriangle;if(i==null)break;yield i,t=i.Edges.getItem(i.Edges.index(t)+1)}while(!0)}}toString(){return this.point.toString()}};var Q0=Ae(yn(),1);var ws=class{get x(){return this.LeftSite.point.x}constructor(e,t){this.RightSite=t.upperSite===e?t.lowerSite:t.upperSite,this.LeftSite=e,this.Edge=t}toString(){return"("+this.LeftSite.toString()+", "+this.Edge.toString()+","+this.RightSite.toString()+")"}};var nf=class{has(e){return e===this.item0||e===this.item1||e===this.item2}index(e){return e===this.item0?0:e===this.item1?1:e===this.item2?2:-1}getItem(e){switch(e){case 0:case 3:case-3:return this.item0;case 1:case 4:case-2:return this.item1;case 2:case 5:case-1:return this.item2;default:throw new Error}}setItem(e,t){switch(e){case 0:case 3:case-3:this.item0=t;break;case 1:case 4:case-2:this.item1=t;break;case 2:case 5:case-1:this.item2=t;break;default:throw new Error}}[Symbol.iterator](){return this.GetEnumerator()}*GetEnumerator(){yield this.item0,yield this.item1,yield this.item2}};var Ar=class{constructor(){this.Edges=new nf;this.Sites=new nf}containsPoint(e){return Ar.PointLocationForTriangle(e,this)!==0}static PointLocationForTriangle(e,t){let i=!1;for(let n=0;n<3;n++){let o=m.signedDoubledTriangleArea(e,t.Sites.getItem(n).point,t.Sites.getItem(n+1).point);if(o<-R.distanceEpsilon)return 0;o<R.distanceEpsilon&&(i=!0)}return i?1:2}intersectsLine(e,t,i){if(Ar.PointLocationForTriangle(e,this)!=0||Ar.PointLocationForTriangle(t,this)!=0)return!0;for(let n of this.Edges)if(this.abIntersectsTrianglSide(e,t,n))return!0;return!1}abIntersectsTrianglSide(e,t,i){return Xp(e,t,i.lowerSite.point,i.upperSite.point)}static mkSSSD(e,t,i,n){let o=m.getTriangleOrientation(e.point,t.point,i.point),a=new Ar;switch(o){case 1:a.FillCcwTriangle(e,t,i,n);break;case 0:a.FillCcwTriangle(e,i,t,n);break;default:throw new Error}return a}static mkSED(e,t,i){let n=new Ar;switch(m.getTriangleOrientation(t.upperSite.point,t.lowerSite.point,e.point)){case 1:t.CcwTriangle=n,n.Sites.setItem(0,t.upperSite),n.Sites.setItem(1,t.lowerSite);break;case 0:t.CwTriangle=n,n.Sites.setItem(0,t.lowerSite),n.Sites.setItem(1,t.upperSite);break;default:throw new Error}return n.Edges.setItem(0,t),n.Sites.setItem(2,e),n.CreateEdge(1,i),n.CreateEdge(2,i),n}static mkSSSEE(e,t,i,n,o,a){let l=Ar.mkSSSD(e,t,i,a);return l.Edges.setItem(0,n),l.Edges.setItem(1,o),l.BindEdgeToTriangle(e,n),l.BindEdgeToTriangle(t,o),l.CreateEdge(2,a),l}BindEdgeToTriangle(e,t){e===t.upperSite?t.CcwTriangle=this:t.CwTriangle=this}FillCcwTriangle(e,t,i,n){this.Sites.setItem(0,e),this.Sites.setItem(1,t),this.Sites.setItem(2,i);for(let o=0;o<3;o++)this.CreateEdge(o,n)}CreateEdge(e,t){let i=this.Sites.getItem(e),n=this.Sites.getItem(e+1),o=t(i,n);this.Edges.setItem(e,o),this.BindEdgeToTriangle(i,o)}Contains(e){return this.Sites.has(e)}OppositeEdge(e){let t=this.Sites.index(e);return this.Edges.getItem(t+1)}OppositeSite(e){let t=this.Edges.index(e);return this.Sites.getItem(t+2)}BoundingBox(){let e=X.mkPP(this.Sites.getItem(0).point,this.Sites.getItem(1).point);return e.add(this.Sites.getItem(2).point),e}static mkSSSEED(e,t,i,n,o,a){let l=new Ar;return l.Sites.setItem(0,e),l.Sites.setItem(1,t),l.Sites.setItem(2,i),l.Edges.setItem(0,n),l.Edges.setItem(1,o),l.BindEdgeToTriangle(e,n),l.BindEdgeToTriangle(t,o),l.CreateEdge(2,a),l}toString(){return this.Sites.getItem(0).toString()+","+this.Sites.getItem(1).toString()+","+this.Sites.getItem(2).toString()}};var of=class{constructor(e){this.Edge=e}};var tr=class extends Pe{constructor(t,i,n,o){super(null);this.front=new dt((t,i)=>t.x-i.x);this.triangles=new Set;if(this.listOfSites=t,this.listOfSites.length===0)return;this.p_1=i,this.p_2=n,this.createEdgeDelegate=o;let a=Ar.mkSSSD(i,n,this.listOfSites[0],o);this.triangles.add(a),this.front.insert(new ws(i,a.Edges.getItem(2))),this.front.insert(new ws(this.listOfSites[0],a.Edges.getItem(1)))}run(){if(this.listOfSites.length!==0){for(let t=1;t<this.listOfSites.length;t++)this.ProcessSite(this.listOfSites[t]);this.FinalizeTriangulation()}}FinalizeTriangulation(){this.RemoveP1AndP2Triangles(),this.triangles.size>0&&this.MakePerimeterConvex()}MakePerimeterConvex(){let t=this.CreateDoubleLinkedListOfPerimeter();do{let i=this.FindConcaveEdge(t);if(i==null)return;t=this.ShortcutTwoListElements(i)}while(!0)}FindConcaveEdge(t){let i=t,n;do{if(n=i.Next,m.getTriangleOrientation(i.Start.point,i.End.point,n.End.point)===1)return i;i=n}while(n!==t);return null}static FindPivot(t){let i=t,n=t;do n=n.Next,(n.Start.point.x<i.Start.point.x||n.Start.point.x===i.Start.point.x&&n.Start.point.y<i.Start.point.y)&&(i=n);while(n!==t);return i}FindFirsePerimeterEdge(){for(let t of this.triangles)for(let i of t.Edges)if(i.GetOtherTriangle_T(t)==null)return i;return null}CreateDoubleLinkedListOfPerimeter(){let t=this.FindFirsePerimeterEdge(),i=t,n=null,o,a=null,l=new Array;do o=tr.CreatePerimeterElementFromEdge(i),l.push(k.mkPP(o.Start.point,o.End.point)),i=tr.FindNextEdgeOnPerimeter(i),a!=null?(o.Prev=a,a.Next=o):n=o,a=o;while(i!==t);return n.Prev=o,o.Next=n,n}static FindNextEdgeOnPerimeter(t){var n;let i=(n=t.CwTriangle)!=null?n:t.CcwTriangle;for(t=i.Edges.getItem(i.Edges.index(t)+2);t.CwTriangle!=null&&t.CcwTriangle!=null;)i=t.GetOtherTriangle_T(i),t=i.Edges.getItem(i.Edges.index(t)+2);return t}static CreatePerimeterElementFromEdge(t){let i=new of(t);return t.CwTriangle!=null?(i.Start=t.upperSite,i.End=t.lowerSite):(i.End=t.upperSite,i.Start=t.lowerSite),i}RemoveP1AndP2Triangles(){let t=new Set;for(let i of this.triangles)(i.Sites.has(this.p_1)||i.Sites.has(this.p_2))&&t.add(i);for(let i of t)tr.RemoveTriangleWithEdges(this.triangles,i)}static RemoveTriangleWithEdges(t,i){t.delete(i);for(let n of i.Edges)n.CwTriangle===i?n.CwTriangle=null:n.CcwTriangle=null,n.CwTriangle==null&&n.CcwTriangle==null&&J0(n.upperSite.Edges,n)}static RemoveTriangleButLeaveEdges(t,i){t.delete(i);for(let n of i.Edges)n.CwTriangle===i?n.CwTriangle=null:n.CcwTriangle=null}ProcessSite(t){this.PointEvent(t);for(let i=0;i<t.Edges.length;i++){let n=t.Edges[i];n.constrained&&this.EdgeEvent(n)}}EdgeEvent(t){tr.EdgeIsProcessed(t)||(this.traversingEdge=t,this.runEdgeInserter())}static EdgeIsProcessed(t){return t.CwTriangle!=null||t.CcwTriangle!=null}ShowFrontWithSite(t,i=null){let n=new Array;if(t.Edges!=null)for(let o of t.Edges)n.push(Ie.mkDebugCurveTWCI(200,.8,o.constrained?"Pink":"Brown",k.mkPP(o.upperSite.point,o.lowerSite.point)));n.push(Ie.mkDebugCurveTWCI(200,1,"Brown",pe.mkFullEllipseNNP(.5,.5,t.point)));for(let o of this.triangles)for(let a=0;a<3;a++){let l=o.Edges.getItem(a);n.push(Ie.mkDebugCurveTWCI(l.constrained?155:100,l.constrained?.8:.4,l.constrained?"Pink":"Navy",k.mkPP(l.upperSite.point,l.lowerSite.point)))}if(i!=null)for(let o of i)n.push(Ie.mkDebugCurveTWCI(100,.5,"Red",o));for(let o of this.front)n.push(Ie.mkDebugCurveTWCI(100,5.5,"Green",k.mkPP(o.Edge.upperSite.point,o.Edge.lowerSite.point)))}Show(t){tr.ShowCdt(Array.from(this.triangles.values()),this.front,null,null,[],t)}static ShowCdt(t,i,n,o,a,l){let u=new Array;if(n!=null)for(let c of n)u.push(Ie.mkDebugCurveTWCI(200,.1,"Red",c));if(o!=null)for(let c of o)u.push(Ie.mkDebugCurveTWCI(200,.1,"Blue",c));if(i!=null)for(let c of i)u.push(Ie.mkDebugCurveTWCI(200,.1,"Green",k.mkPP(c.Edge.upperSite.point,c.Edge.lowerSite.point)));for(let c of t)for(let h=0;h<3;h++){let d=c.Edges.getItem(h);u.push(tr.GetDebugCurveOfCdtEdge(d))}u=u.concat(a)}static GetDebugCurveOfCdtEdge(t){return t.CcwTriangle==null||t.CwTriangle==null?Ie.mkDebugCurveTWCI(255,.5,t.constrained?"Brown":"Black",k.mkPP(t.upperSite.point,t.lowerSite.point)):Ie.mkDebugCurveTWCI(200,t.constrained?.8:.2,t.constrained?"Pink":"Navy",k.mkPP(t.upperSite.point,t.lowerSite.point))}PointEvent(t){let i=this.ProjectToFront(t),n={rightSite:null},o=i.item.x+R.distanceEpsilon<t.point.x?this.MiddleCase(t,i,n):this.LeftCase(t,i,n),a=this.InsertSiteIntoFront(o,t,n.rightSite);this.TriangulateEmptySpaceToTheRight(a),a=tr.FindNodeInFrontBySite(this.front,o),this.TriangulateEmptySpaceToTheLeft(a)}LeftCase(t,i,n){let o=i.item;this.InsertAndLegalizeTriangle(t,o);let a=this.front.previous(i),l=a.item.LeftSite;n.rightSite=i.item.RightSite,this.InsertAndLegalizeTriangle(t,a.item),this.front.deleteNodeInternal(a);let u=this.front.remove(o);return l}MiddleCase(t,i,n){let o=i.item.LeftSite;return n.rightSite=i.item.RightSite,this.InsertAndLegalizeTriangle(t,i.item),this.front.deleteNodeInternal(i),o}TriangulateEmptySpaceToTheLeft(t){let i=t.item.RightSite,n=this.front.previous(t);for(;n!=null;){let o=n.item,a=o.LeftSite,l=o.RightSite;if(l.point.sub(i.point).dot(a.point.sub(l.point))<0)t=this.ShortcutTwoFrontElements(n,t),n=this.front.previous(t);else{this.TryTriangulateBasinToTheLeft(t);break}}}ShortcutTwoListElements(t){var l;let i=t.Next,n=Ar.mkSSSEE(t.Start,t.End,i.End,t.Edge,i.Edge,this.createEdgeDelegate);this.triangles.add(n);let o=n.Edges.getItem(2);this.LegalizeEdge(t.Start,n.OppositeEdge(t.Start)),n=(l=o.CcwTriangle)!=null?l:o.CwTriangle,this.LegalizeEdge(i.End,n.OppositeEdge(i.End));let a=new of(o);return a.Start=t.Start,a.End=i.End,t.Prev.Next=a,a.Prev=t.Prev,a.Next=i.Next,i.Next.Prev=a,a}ShortcutTwoFrontElements(t,i){var u;let n=t.item,o=i.item,a=Ar.mkSSSEED(n.LeftSite,n.RightSite,o.RightSite,n.Edge,o.Edge,this.createEdgeDelegate);this.triangles.add(a),this.front.deleteNodeInternal(t),this.front.remove(o);let l=a.Edges.getItem(2);return this.LegalizeEdge(n.LeftSite,a.OppositeEdge(n.LeftSite)),a=(u=l.CcwTriangle)!=null?u:l.CwTriangle,this.LegalizeEdge(o.RightSite,a.OppositeEdge(o.RightSite)),this.front.insert(new ws(n.LeftSite,l))}TryTriangulateBasinToTheLeft(t){if(!tr.DropsSharpEnoughToTheLeft(t.item))return;let i=new Q0.Stack;for(i.push(t.item.LeftSite);;){let n=i.pop();t=tr.FindNodeInFrontBySite(this.front,n);let o=this.front.previous(t);if(o==null)return;if(m.getTriangleOrientation(o.item.LeftSite.point,t.item.LeftSite.point,t.item.RightSite.point)==1)i.push(o.item.LeftSite),this.ShortcutTwoFrontElements(o,t);else if(t.item.LeftSite.point.y>t.item.RightSite.point.y)i.push(o.item.LeftSite);else{if(o.item.LeftSite.point.y<=o.item.RightSite.point.y)return;i.push(o.item.LeftSite)}}}static DropsSharpEnoughToTheLeft(t){let i=t.Edge;if(t.RightSite!==i.upperSite)return!1;let n=i.lowerSite.point.sub(i.upperSite.point);return n.x>=.5*n.y}InsertSiteIntoFront(t,i,n){let o=null,a=null;for(let l of i.Edges)if(a==null&&l.lowerSite===t&&(a=l),o==null&&l.lowerSite===n&&(o=l),a!=null&&o!=null)break;return this.front.insert(new ws(t,a)),this.front.insert(new ws(i,o))}TriangulateEmptySpaceToTheRight(t){let n=t.item.LeftSite.point,o=this.front.next(t);for(;o!=null;){let a=o.item,l=a.LeftSite,u=a.RightSite;if(l.point.sub(n).dot(u.point.sub(l.point))<0)t=this.ShortcutTwoFrontElements(t,o),o=this.front.next(t);else{this.TryTriangulateBasinToTheRight(t);break}}}TryTriangulateBasinToTheRight(t){if(!tr.DropsSharpEnoughToTheRight(t.item))return;let i=new Q0.Stack;for(i.push(t.item.LeftSite);;){let n=i.pop();t=tr.FindNodeInFrontBySite(this.front,n);let o=this.front.next(t);if(o==null)return;if(m.getTriangleOrientation(t.item.LeftSite.point,t.item.RightSite.point,o.item.RightSite.point)==1)this.ShortcutTwoFrontElements(t,o),i.push(n);else if(t.item.LeftSite.point.y>t.item.RightSite.point.y)i.push(t.item.RightSite);else{if(o.item.LeftSite.point.y>=o.item.RightSite.point.y)return;i.push(t.item.RightSite)}}}static DropsSharpEnoughToTheRight(t){let i=t.Edge;if(t.LeftSite!==i.upperSite)return!1;let n=i.lowerSite.point.sub(i.upperSite.point);return n.x<=-.5*n.y}static FindNodeInFrontBySite(t,i){return t.findLast(n=>n.LeftSite.point.x<=i.point.x)}InsertAndLegalizeTriangle(t,i){var n;if(m.getTriangleOrientation(t.point,i.LeftSite.point,i.RightSite.point)!==2){let o=Ar.mkSED(t,i.Edge,this.createEdgeDelegate);this.triangles.add(o),this.LegalizeEdge(t,o.Edges.getItem(0))}else{let o=i.Edge;J0(o.upperSite.Edges,o);let a=(n=o.CcwTriangle)!=null?n:o.CwTriangle,l=a.OppositeSite(o);tr.RemoveTriangleButLeaveEdges(this.triangles,a),a=Ar.mkSSSD(i.LeftSite,l,t,this.createEdgeDelegate);let u=Ar.mkSSSD(i.RightSite,l,t,this.createEdgeDelegate);this.triangles.add(a),this.triangles.add(u),this.LegalizeEdge(t,a.OppositeEdge(t)),this.LegalizeEdge(t,u.OppositeEdge(t))}}LegalizeEdge(t,i){i.constrained||i.CcwTriangle==null||i.CwTriangle==null||(i.CcwTriangle.Contains(t)?this.LegalizeEdgeForOtherCwTriangle(t,i):this.LegalizeEdgeForOtherCcwTriangle(t,i))}LegalizeEdgeForOtherCwTriangle(t,i){let n=i.CwTriangle.Edges.index(i);if(fA(t,i.upperSite,i.CwTriangle.Sites.getItem(n+2),i.lowerSite)){let o=gA(t,i);this.LegalizeEdge(t,o.CwTriangle.OppositeEdge(t)),this.LegalizeEdge(t,o.CcwTriangle.OppositeEdge(t))}}LegalizeEdgeForOtherCcwTriangle(t,i){let n=i.CcwTriangle.Edges.index(i);if(fA(t,i.lowerSite,i.CcwTriangle.Sites.getItem(n+2),i.upperSite)){let o=gA(t,i);this.LegalizeEdge(t,o.CwTriangle.OppositeEdge(t)),this.LegalizeEdge(t,o.CcwTriangle.OppositeEdge(t))}}ProjectToFront(t){return this.front.findLast(i=>i.x<=t.point.x)}runEdgeInserter(){this.initEdgeInserter(),this.TraceEdgeThroughTriangles(),this.TriangulatePolygon0(this.rightPolygon,this.traversingEdge.upperSite,this.traversingEdge.lowerSite,!0),this.TriangulatePolygon0(this.leftPolygon,this.traversingEdge.upperSite,this.traversingEdge.lowerSite,!1),this.UpdateFront()}initEdgeInserter(){this.rightPolygon=new Array,this.leftPolygon=new Array,this.addedTriangles=new Array,this.piercedEdge=null,this.piercedTriangle=null,this.piercedToTheLeftFrontElemNode=null,this.piercedToTheRightFrontElemNode=null}UpdateFront(){let t=new Set;for(let i of this.addedTriangles)for(let n of i.Edges)if(n.CwTriangle==null||n.CcwTriangle==null){if(n.lowerSite==this.p_2&&n.upperSite==this.p_1)continue;t.add(n)}for(let i of t)this.AddEdgeToFront(i)}AddEdgeToFront(t){let i=t.upperSite.point.x<t.lowerSite.point.x?t.upperSite:t.lowerSite;this.front.insert(new ws(i,t))}TriangulatePolygon0(t,i,n,o){t.length>0&&this.TriangulatePolygon1(0,t.length-1,t,i,n,o)}TriangulatePolygon1(t,i,n,o,a,l){let u=n[t],c=t;for(let f=t+1;f<=i;f++){let p=n[f];d(p)&&(c=f,u=p)}let h=Ar.mkSSSD(o,a,u,this.createEdgeDelegate);this.triangles.add(h),this.addedTriangles.push(h),t<c&&this.TriangulatePolygon1(t,c-1,n,o,u,l),c<i&&this.TriangulatePolygon1(c+1,i,n,u,a,l);function d(f){return l?$0(f,o,u,a):$0(f,o,a,u)}}TraceEdgeThroughTriangles(){this.initEdgeTracer(),this.Traverse()}Traverse(){for(;!this.BIsReached();)this.piercedToTheLeftFrontElemNode!=null?this.ProcessLeftFrontPiercedElement():this.piercedToTheRightFrontElemNode!=null?this.ProcessRightFrontPiercedElement():this.ProcessPiercedEdge();this.piercedTriangle!=null&&this.removePiercedTriangle(this.piercedTriangle),this.FindMoreRemovedFromFrontElements();for(let t of this.elementsToBeRemovedFromFront)this.front.remove(t)}ProcessLeftFrontPiercedElement(){let t=this.piercedToTheLeftFrontElemNode;do this.elementsToBeRemovedFromFront.push(t.item),this.AddSiteToLeftPolygon(t.item.LeftSite),t=this.front.previous(t);while(m.pointToTheLeftOfLine(t.item.LeftSite.point,this.a.point,this.b.point));if(this.elementsToBeRemovedFromFront.push(t.item),this.AddSiteToRightPolygon(t.item.LeftSite),t.item.LeftSite===this.b){this.piercedToTheLeftFrontElemNode=t;return}this.FindPiercedTriangle(t),this.piercedToTheLeftFrontElemNode=null}FindPiercedTriangle(t){var a;let i=t.item.Edge,n=(a=i.CcwTriangle)!=null?a:i.CwTriangle,o=n.Edges.index(i);for(let l=1;l<=2;l++){let u=n.Edges.getItem(l+o),c=Xi.sign(m.signedDoubledTriangleArea(u.lowerSite.point,this.a.point,this.b.point));if(Xi.sign(m.signedDoubledTriangleArea(u.upperSite.point,this.a.point,this.b.point))*c<=0){this.piercedTriangle=n,this.piercedEdge=u;break}}}FindMoreRemovedFromFrontElements(){for(let t of this.removedTriangles)for(let i of t.Edges)if(i.CcwTriangle==null&&i.CwTriangle==null){let n=i.upperSite.point.x<i.lowerSite.point.x?i.upperSite:i.lowerSite,o=tr.FindNodeInFrontBySite(this.front,n);o.item.Edge===i&&this.elementsToBeRemovedFromFront.push(o.item)}}ProcessPiercedEdge(){this.piercedEdge.CcwTriangle===this.piercedTriangle?(this.AddSiteToLeftPolygon(this.piercedEdge.lowerSite),this.AddSiteToRightPolygon(this.piercedEdge.upperSite)):(this.AddSiteToLeftPolygon(this.piercedEdge.upperSite),this.AddSiteToRightPolygon(this.piercedEdge.lowerSite)),this.removePiercedTriangle(this.piercedTriangle),this.PrepareNextStateAfterPiercedEdge()}PrepareNextStateAfterPiercedEdge(){var n,o;let t=(n=this.piercedEdge.CwTriangle)!=null?n:this.piercedEdge.CcwTriangle,i=t.Edges.index(this.piercedEdge);for(let a=1;a<=2;a++){let l=t.Edges.getItem(a+i),u=Xi.sign(m.signedDoubledTriangleArea(l.lowerSite.point,this.a.point,this.b.point));if(Xi.sign(m.signedDoubledTriangleArea(l.upperSite.point,this.a.point,this.b.point))*u<=0){if(l.CwTriangle!=null&&l.CcwTriangle!=null){this.piercedTriangle=t,this.piercedEdge=l;break}this.piercedTriangle=null,this.piercedEdge=null;let h=l.upperSite.point.x<l.lowerSite.point.x?l.upperSite:l.lowerSite,d=tr.FindNodeInFrontBySite(this.front,h);h.point.x<this.a.point.x?this.piercedToTheLeftFrontElemNode=d:this.piercedToTheRightFrontElemNode=d,this.removePiercedTriangle((o=l.CwTriangle)!=null?o:l.CcwTriangle);break}}}removePiercedTriangle(t){this.triangles.delete(t);for(let i of t.Edges)i.CwTriangle===t?i.CwTriangle=null:i.CcwTriangle=null,this.removedTriangles.push(t)}ProcessRightFrontPiercedElement(){let t=this.piercedToTheRightFrontElemNode;do this.elementsToBeRemovedFromFront.push(t.item),this.AddSiteToRightPolygon(t.item.RightSite),t=this.front.next(t);while(m.pointToTheRightOfLine(t.item.RightSite.point,this.a.point,this.b.point));if(this.elementsToBeRemovedFromFront.push(t.item),this.AddSiteToLeftPolygon(t.item.RightSite),t.item.RightSite===this.b){this.piercedToTheRightFrontElemNode=t;return}this.FindPiercedTriangle(t),this.piercedToTheRightFrontElemNode=null}AddSiteToLeftPolygon(t){this.AddSiteToPolygonWithCheck(t,this.leftPolygon)}AddSiteToPolygonWithCheck(t,i){t!==this.b&&(i.length===0||i[i.length-1]!==t)&&i.push(t)}AddSiteToRightPolygon(t){this.AddSiteToPolygonWithCheck(t,this.rightPolygon)}BIsReached(){var i;let t=(i=this.piercedToTheLeftFrontElemNode)!=null?i:this.piercedToTheRightFrontElemNode;return t!=null?t.item.Edge.IsAdjacent(this.b):this.piercedEdge.IsAdjacent(this.b)}initEdgeTracer(){this.elementsToBeRemovedFromFront=[],this.a=this.traversingEdge.upperSite,this.b=this.traversingEdge.lowerSite,this.removedTriangles=[];let t=tr.FindNodeInFrontBySite(this.front,this.a),i=this.front.previous(t);if(m.pointToTheLeftOfLine(this.b.point,i.item.LeftSite.point,i.item.RightSite.point))this.piercedToTheLeftFrontElemNode=i;else if(m.pointToTheRightOfLine(this.b.point,t.item.RightSite.point,t.item.LeftSite.point))this.piercedToTheRightFrontElemNode=t;else for(let n of this.a.Edges){let o=n.CcwTriangle;if(o==null||m.pointToTheLeftOfLine(this.b.point,n.lowerSite.point,n.upperSite.point))continue;let a=o.Edges.index(n),l=o.Sites.getItem(a+2);if(m.pointToTheLeftOfLineOrOnLine(this.b.point,l.point,n.upperSite.point)){this.piercedEdge=o.Edges.getItem(a+1),this.piercedTriangle=o;break}}}};function J0(s,e){if(s.length===0)return;let t=s.findIndex(i=>e===i);t>=0&&(t!==s.length-1&&(s[t]=s[s.length-1]),s.pop())}function fA(s,e,t,i){return pN(s,e,t,i)&&$0(s,e,t,i)}function pN(s,e,t,i){return m.getTriangleOrientation(e.point,s.point,t.point)===0&&m.getTriangleOrientation(t.point,s.point,i.point)===0}function $0(s,e,t,i){let n=e.point.x-s.point.x,o=e.point.y-s.point.y,a=t.point.x-s.point.x,l=t.point.y-s.point.y,u=i.point.x-s.point.x,c=i.point.y-s.point.y,h=n*n+o*o,d=a*a+l*l,f=u*u+c*c;return n*(l*f-c*d)-a*(o*f-c*h)+u*(o*d-l*h)>R.tolerance}function gA(s,e){let t,i;e.CcwTriangle.Contains(s)?(t=e.CcwTriangle,i=e.CwTriangle):(t=e.CwTriangle,i=e.CcwTriangle);let n=t.Edges.index(e),o=i.Edges.index(e),a=i.Sites.getItem(o+2),l=t.Edges.getItem(n+1),u=i.Edges.getItem(o+1),c=qe.GetOrCreateEdge(s,a);return t.Sites.setItem(n+1,a),t.Edges.setItem(n,u),t.Edges.setItem(n+1,c),i.Sites.setItem(o+1,s),i.Edges.setItem(o,l),i.Edges.setItem(o+1,c),u.lowerSite===a?u.CcwTriangle=t:u.CwTriangle=t,l.lowerSite===s?l.CcwTriangle=i:l.CwTriangle=i,c.upperSite===s?(c.CcwTriangle=i,c.CwTriangle=t):(c.CcwTriangle=t,c.CwTriangle=i),J0(e.upperSite.Edges,e),c}var qe=class extends Pe{constructor(t,i,n){super(null);this.isolatedSites=[];this.obstacles=[];this.PointsToSites=new Nt;this.simplifyObstacles=!0;this.rectangleNodeOnTriangles=null;this.isolatedSites=t,this.obstacles=i,this.isolatedSegments=n}static constructor_(t){let i=new qe(null,null,null);return i.isolatedSitesWithObject=t,i}FillAllInputSites(){if(this.isolatedSitesWithObject!=null)for(let t of this.isolatedSitesWithObject)this.AddSite(t[0],t[1]);if(this.isolatedSites!=null)for(let t of this.isolatedSites)this.AddSite(t,null);if(this.obstacles!=null)for(let t of this.obstacles)this.AddPolylineToAllInputSites(t);if(this.isolatedSegments!=null)for(let t of this.isolatedSegments)this.AddConstrainedEdge(t.A,t.B,null);this.AddP1AndP2(),this.allInputSites=Array.from(this.PointsToSites.values())}AddSite(t,i){let n;return(n=this.PointsToSites.get(t))?n.Owner=i:(n=Va.mkSO(t,i),this.PointsToSites.set(t,n)),n}AddP1AndP2(){let t=X.mkEmpty();for(let o of this.PointsToSites.keys())t.add(o);let i=10,n=10;this.P1=new Va(t.leftBottom.add(new m(-i,-n))),this.P2=new Va(t.rightBottom.add(new m(i,-n)))}AddPolylineToAllInputSites(t){if(this.simplifyObstacles)for(let i=t.startPoint;i!=null;){let n=i.point;if(i=i.next,!i)break;for(;i.next&&m.getTriangleOrientation(n,i.point,i.next.point)===2;)i=i.next;this.AddConstrainedEdge(n,i.point,t)}else for(let i=t.startPoint;i.next!=null;i=i.next)this.AddConstrainedEdge(i.point,i.next.point,t);t.closed&&this.AddConstrainedEdge(t.endPoint.point,t.startPoint.point,t)}AddConstrainedEdge(t,i,n){let o=qe.AbovePP(t,i),a,l;o>0?(a=this.AddSite(t,n),l=this.AddSite(i,n)):(a=this.AddSite(i,n),l=this.AddSite(t,n));let u=qe.CreateEdgeOnOrderedCouple(a,l);u.constrained=!0}static GetOrCreateEdge(t,i){if(qe.AboveCC(t,i)===1){let n=t.EdgeBetweenUpperSiteAndLowerSite(i);return n!=null?n:qe.CreateEdgeOnOrderedCouple(t,i)}else{let n=i.EdgeBetweenUpperSiteAndLowerSite(t);return n!=null?n:qe.CreateEdgeOnOrderedCouple(i,t)}}static CreateEdgeOnOrderedCouple(t,i){return new qm(t,i)}GetTriangles(){return this.sweeper.triangles}run(){this.Initialization(),this.SweepAndFinalize()}SweepAndFinalize(){this.sweeper=new tr(this.allInputSites,this.P1,this.P2,qe.GetOrCreateEdge),this.sweeper.run(),this.cleanRemovedEdges()}cleanRemovedEdges(){for(let t of this.PointsToSites.values())t.cleanRemovedEdges()}Initialization(){this.FillAllInputSites(),this.allInputSites.sort(qe.OnComparison)}static OnComparison(t,i){return qe.AboveCC(t,i)}static AbovePP(t,i){let n=t.y-i.y;return n>0?1:n<0?-1:(n=t.x-i.x,n>0?-1:n<0?1:0)}static AboveCC(t,i){return qe.AbovePP(t.point,i.point)}RestoreEdgeCapacities(){for(let t of this.allInputSites)for(let i of t.Edges)i.constrained||(i.ResidualCapacity=i.Capacity)}SetInEdges(){for(let t of this.PointsToSites.values())for(let i of t.Edges)i.lowerSite.AddInEdge(i)}FindSite(t){return this.PointsToSites.get(t)}static PointIsInsideOfTriangle(t,i){for(let n=0;n<3;n++){let o=i.Sites.getItem(n).point,a=i.Sites.getItem(n+1).point;if(m.signedDoubledTriangleArea(t,o,a)<R.distanceEpsilon*-1)return!1}return!0}getRectangleNodeOnTriangles(){return this.rectangleNodeOnTriangles==null&&(this.rectangleNodeOnTriangles=tt(Array.from(this.GetTriangles().values()).map(t=>ct(t,t.BoundingBox())))),this.rectangleNodeOnTriangles}};function Xm(s){let e=Array.from(s.GetAllLeaves()),t=s.irect,i=t.diagonal/4,n=t.clone();return n.pad(i),mN(e.concat([n.perimeter()]))}function mN(s){let e=new qe(null,s,null);return e.run(),e}var Ua=class{constructor(e,t){this.start=e,this.end=t}add(e){this.add_d(e)}add_rect(e){let t=e,i=this.clone();return i.add_d(t.start),i.add_d(t.end),i}clone(){return new Ua(this.start,this.end)}contains_point(e){return this.contains_d(e)}contains_rect(e){let t=e;return this.contains_d(t.start)&&this.contains_d(t.end)}intersection_rect(e){let t=e;return new Ua(Math.max(this.start,t.start),Math.min(this.end,t.end))}intersects_rect(e){let t=e;return this.intersects(t)}contains_point_radius(e,t){return this.contains_d(e-t)&&this.contains_d(e+t)}static mkInterval(e,t){let i=new Ua(e.start,e.end);return i.add_d(t.start),i.add_d(t.end),i}add_d(e){this.start>e&&(this.start=e),this.end<e&&(this.end=e)}get Start(){return this.start}set Start(e){this.start=e}get Length(){return this.end-this.start}contains_d(e){return this.start<=e&&e<=this.end}GetInRange(e){return e<this.start?this.start:e>this.end?this.end:e}intersects(e){return e.start>this.end+R.distanceEpsilon?!1:!(e.end<this.start-R.distanceEpsilon)}};var Xc=class{constructor(e){this.heapSize=0;this._priors=new Array(e),this._heap=new Array(e+1),this._reverse_heap=new Array(e)}get Count(){return this.heapSize}SwapWithParent(e){let t=this._heap[e>>1];this.PutAtI(e>>1,this._heap[e]),this.PutAtI(e,t)}Enqueue(e,t){this.heapSize++;let i=this.heapSize;for(this._priors[e]=t,this.PutAtI(i,e);i>1&&this._priors[this._heap[i>>1]]>t;)this.SwapWithParent(i),i>>=1}PutAtI(e,t){this._heap[e]=t,this._reverse_heap[t]=e}Dequeue(){if(this.heapSize===0)throw new Error;let e=this._heap[1];if(this.heapSize>1){this.PutAtI(1,this._heap[this.heapSize]);let t=1;for(;;){let i=t,n=t<<1;n<=this.heapSize&&this._priors[this._heap[n]]<this._priors[this._heap[t]]&&(i=n);let o=n+1;if(o<=this.heapSize&&this._priors[this._heap[o]]<this._priors[this._heap[i]]&&(i=o),i!==t)this.SwapWithParent(i);else break;t=i}}return this.heapSize--,e}IsEmpty(){return this.heapSize===0}DecreasePriority(e,t){this._priors[e]=t;let i=this._reverse_heap[e];for(;i>1&&this._priors[this._heap[i]]<this._priors[this._heap[i>>1]];){this.SwapWithParent(i);i>>=1}}};var Ym=class{constructor(e,t,i,n){this._numberOfOverlaps=0;this._proximityEdges=e,this._nodeSizes=t,this._nodePositions=i,this._forLayers=n,this._q=new Xc(t.length*2)}Run(){return this.InitQueue(),this.FindOverlaps(),this._numberOfOverlaps}FindOverlaps(){for(;this._q.Count>0;){let e=this._q.Dequeue();e<this._nodePositions.length?(this.FindOverlapsWithInterval(e),this.AddIntervalToTree(e)):(e-=this._nodePositions.length,this.RemoveIntervalFromTree(e))}}RemoveIntervalFromTree(e){this._intervalTree.Remove(this.GetInterval(e),e)}AddIntervalToTree(e){let t=this.GetInterval(e);this._intervalTree==null&&(this._intervalTree=ys([])),this._intervalTree.Add(t,e)}FindOverlapsWithInterval(e){if(this._intervalTree==null)return;let t=this.GetInterval(e);for(let i of this._intervalTree.GetAllIntersecting(t)){let n=Qr.GetIdealEdge(e,i,this._nodePositions[e],this._nodePositions[i],this._nodeSizes);if(n.overlapFactor<=1)return;this._proximityEdges.push(n),this._numberOfOverlaps++}}GetInterval(e){let t=this._nodeSizes[e].width/2,i=this._nodePositions[e].x;return new Ua(i-t,i+t)}InitQueue(){for(let e=0;e<this._nodeSizes.length;e++){let t=this._nodeSizes[e].height/2,i=this._nodePositions[e].y;this._q.Enqueue(e,i-t),this._q.Enqueue(this._nodeSizes.length+e,i+t)}}};var sf=class{constructor(e,t,i){this.treeNodes=new Set;this.hedgehog=new Map;this.graph=e,this.weight=t,this.root=i,this.q=new Xc(this.graph.nodeCount)}NodeIsInTree(e){return this.treeNodes.has(e)}GetTreeEdges(){let e=new Array;for(this.Init();e.length<this.graph.nodeCount-1&&this.q.Count>0;)this.AddEdgeToTree(e);return e}AddEdgeToTree(e){let t=this.q.Dequeue(),i=this.hedgehog.get(t);this.treeNodes.add(t),e.push(i),this.UpdateOutEdgesOfV(t),this.UpdateInEdgesOfV(t)}UpdateOutEdgesOfV(e){for(let t of this.graph.outEdges[e]){let i=t.target;if(this.NodeIsInTree(i))continue;let n=this.hedgehog.get(i);if(n){let o=this.weight(n),a=this.weight(t);a<o&&(this.q.DecreasePriority(i,a),this.hedgehog.set(i,t))}else this.q.Enqueue(i,this.weight(t)),this.hedgehog.set(i,t)}}UpdateInEdgesOfV(e){for(let t of this.graph.inEdges[e]){let i=t.source;if(this.NodeIsInTree(i))continue;let n=this.hedgehog.get(i);if(n){let o=this.weight(n),a=this.weight(t);a<o&&(this.q.DecreasePriority(i,a),this.hedgehog.set(i,t))}else this.q.Enqueue(i,this.weight(t)),this.hedgehog.set(i,t)}}Init(){this.treeNodes.add(this.root);for(let e of this.graph.outEdges[this.root]){let t=this.weight(e);this.q.Enqueue(e.target,t),this.hedgehog.set(e.target,e)}for(let e of this.graph.inEdges[this.root]){let t=this.weight(e);this.q.Enqueue(e.source,t),this.hedgehog.set(e.source,e)}}};var Yc=class{static GetMst(e,t){if(e.length===0)return null;let i=e.map(l=>new me(l.source,l.target)),n=new jr;for(let l=0;l<e.length;l++)n.setPair(i[l],e[l]);let o=Sr(i,t);return new sf(o,l=>n.get(l.source,l.target).weight,i[0].source).GetTreeEdges().map(l=>n.get(l.source,l.target))}static GetMstOnCdt(e,t){let i=Array.from(e.PointsToSites.values()),n=new Map;for(let u=0;u<i.length;u++)n.set(i[u],u);let o=Yc.GetEdges(i,n),a=um(Array.from(o.keys()));return new sf(a,u=>t(o.get(u.source,u.target)),0).GetTreeEdges().map(u=>o.get(u.source,u.target))}static GetEdges(e,t){let i=new jr;for(let n=0;n<e.length;n++){let o=e[n],a=t.get(o);for(let l of o.Edges)i.set(a,t.get(l.lowerSite),l)}return i}};var Kc=class{constructor(){this.epsilon=.01;this.iterationsMax=1e3;this.stopOnMaxIterat=!1;this.nodeSeparation=4;this.randomizationSeed=1;this.randomizationShift=.1}get StopOnMaxIterat(){return this.stopOnMaxIterat}set StopOnMaxIterat(e){this.stopOnMaxIterat=e}get Epsilon(){return this.epsilon}set Epsilon(e){this.epsilon=e}get IterationsMax(){return this.iterationsMax}set IterationsMax(e){this.iterationsMax=e}get NodeSeparation(){return this.nodeSeparation}set NodeSeparation(e){this.nodeSeparation=e}get RandomizationSeed(){return this.randomizationSeed}set RandomizationSeed(e){this.randomizationSeed=e}get RandomizationShift(){return this.randomizationShift}set RandomizationShift(e){this.randomizationShift=e}Clone(){let e=new Kc;return e.Epsilon=this.Epsilon,e.IterationsMax=this.IterationsMax,e.StopOnMaxIterat=this.StopOnMaxIterat,e.NodeSeparation=this.NodeSeparation,e.RandomizationSeed=this.RandomizationSeed,e.RandomizationShift=this.randomizationShift,e}};var Qr=class{constructor(e,t){this._settings=e,this._nodes=t}static RemoveOverlaps(e,t){let i=new Kc;i.RandomizationShift=1,i.NodeSeparation=t,new Qr(i,e).RemoveOverlaps()}RemoveOverlaps(){if(this._nodes.length<3){this.RemoveOverlapsOnTinyGraph();return}let e={nodePositions:new Array,nodeSizes:new Array};for(bN(this._settings,this._nodes,e,this._settings.RandomizationShift),this.lastRunNumberIterations=0;this.OneIteration(e.nodePositions,e.nodeSizes,!1);)this.lastRunNumberIterations++;for(;this.OneIteration(e.nodePositions,e.nodeSizes,!0);)this.lastRunNumberIterations++;for(let t=0;t<this._nodes.length;t++)this._nodes[t].center=e.nodePositions[t]}RemoveOverlapsOnTinyGraph(){if(this._nodes.length!==1&&this._nodes.length===2){let e=this._nodes[0],t=this._nodes[1];m.closeDistEps(e.center,t.center)&&(t.center=t.center.add(new m(.001,0)));let i=this.GetIdealDistanceBetweenTwoNodes(e,t),n=m.middle(e.center,t.center),o=e.center.sub(t.center),a=o.length;o=o.mul(.5*(i/a)),e.center=n.add(o),t.center=n.sub(o)}}GetIdealDistanceBetweenTwoNodes(e,t){let i=e.center.sub(t.center),n=Math.abs(i.x),o=Math.abs(i.y),a=(e.width+t.width)/2+this._settings.NodeSeparation,l=(e.height+t.height)/2+this._settings.NodeSeparation,u=Number.POSITIVE_INFINITY,c=Number.POSITIVE_INFINITY;return n>R.tolerance&&(u=a/n),o>R.tolerance&&(c=l/o),Math.min(u,c)*i.length}static AvgEdgeLength(e){let t=0,i=0;for(let n of e)for(let o of n.outEdges())i+=n.center.sub(o.target.center).length,t++;return t>0?i/t:1}OneIteration(e,t,i){let n=new Array;for(let h=0;h<e.length;h++)n.push([e[h],h]);let o=qe.constructor_(n);o.run();let a=new Map;for(let h=0;h<e.length;h++)a.set(o.PointsToSites.get(e[h]),h);let l=0,u=new Array;for(let h of o.PointsToSites.values())for(let d of h.Edges){let f=d.upperSite.point,p=d.lowerSite.point,S=a.get(d.upperSite),E=a.get(d.lowerSite),C=Qr.GetIdealEdge(S,E,f,p,t);u.push(C),C.overlapFactor>1&&l++}if(l===0||i){let h=this.FindProximityEdgesWithSweepLine(u,t,e);if(l===0&&h===0||l===0&&!i)return!1}let c=Yc.GetMst(u,e.length);return Qr.MoveNodePositions(c,e,c[0].source),!0}FindProximityEdgesWithSweepLine(e,t,i){return new Ym(e,t,i,this._overlapForLayers).Run()}static GetIdealEdge(e,t,i,n,o){let a={overlapFactor:0},l=Qr.GetIdealEdgeLength(e,t,i,n,o,a),u=i.sub(n).length,c=X.mkSizeCenter(o[e],i),h=X.mkSizeCenter(o[t],n),d=a.overlapFactor>1?u-l:Qr.GetDistanceRects(c,h);return{source:Math.min(e,t),target:Math.max(e,t),overlapFactor:a.overlapFactor,idealDistance:l,weight:d}}static GetIdealEdgeLength(e,t,i,n,o,a){let l=i.sub(n),u=l.length,c=Math.abs(l.x),h=Math.abs(l.y),d=(o[e].width+o[t].width)/2,f=(o[e].height+o[t].height)/2;if(c>=d||h>=f)return a.overlapFactor=1,l.length;let p,S=1e-10;if(c>S)h>S?p=Math.min(d/c,f/h):p=d/c;else if(h>S)p=f/h;else return a.overlapFactor=2,Math.sqrt(d*d+f*f)/4;return p=Math.max(p,1.001),a.overlapFactor=p,p*u}static GetDistanceRects(e,t){if(e.intersects(t))return 0;let i=0,n=0;return(e.right<t.left||t.right<e.left)&&(n=e.left-t.right),e.top<t.bottom?i=t.bottom-e.top:t.top<e.bottom&&(i=e.bottom-t.top),Math.sqrt(n*n+i*i)}static MoveNodePositions(e,t,i){let n=t.map(a=>a.clone()),o=new Set;o.add(i);for(let a=0;a<e.length;a++){let l=e[a];o.has(l.source)?Qr.MoveNode(l.source,l.target,n,t,o,l.idealDistance):Qr.MoveNode(l.target,l.source,n,t,o,l.idealDistance)}}static MoveNode(e,t,i,n,o,a){let l=i[t].sub(i[e]);l=l.mul(a/l.length+.01),n[t]=n[e].add(l),o.add(t)}GetLastRunIterations(){return this.lastRunNumberIterations}};function bN(s,e,t,i){t.nodePositions=e.map(n=>n.center),i&&PN(t.nodePositions,new ya(0,0),i),t.nodeSizes=e.map(n=>{let o=n.boundingBox.size;return o.width+=s.NodeSeparation,o.height+=s.NodeSeparation,o})}function PN(s,e,t){let i=new He;for(let n=0;n<s.length;n++){let o=s[n];if(t||i.has(o))do{let a=o.x+(2*e.random()-1)*t,l=o.y+(2*e.random()-1)*t;o=new m(a,l)}while(i.has(o));s[n]=o,i.add(o)}}var Ls=class extends Pe{constructor(t,i,n,o){super(n);this.settings=t,this.graph=i,this.length=o}run(){this.LayoutConnectedGraphWithMds(),this.graph.pumpTheBoxToTheGraphWithMargins()}static ScaleToAverageEdgeLength(t,i,n,o){let a=new Map,l=0;for(let h of t.shallowNodes)a.set(h,l),l++;let u=0,c=0;for(let h of t.shallowEdges){let d=a.get(h.source),f=a.get(h.target);c+=Math.sqrt(Math.pow(i[d]-i[f],2)+Math.pow(n[d]-n[f],2)),u+=o(h)}if(u>0&&(c/=u),c>0)for(let h=0;h<i.length;h++)i[h]/=c,n[h]/=c}static LayoutGraphWithMds(t,i,n,o){if(n.x=new Array(t.shallowNodeCount),n.y=new Array(t.shallowNodeCount),n.x.length===0)return;if(n.x.length===1){n.x[0]=n.y[0]=0;return}let a=Math.min(i.PivotNumber,t.shallowNodeCount),l=i.GetNumberOfIterationsWithMajorization(t.shallowNodeCount),u=i.Exponent,c=new Array(a),h=new Hm(t,c,o);h.run();let d=h.Result;if(rt.LandmarkClassicalScaling(d,n,c),Ls.ScaleToAverageEdgeLength(t,n.x,n.y,o),l>0){let f=new qc(t,o);f.run();let p=f.Result,S=rt.ExponentialWeightMatrix(p,u);rt.DistanceScalingSubset(p,n.x,n.y,S,l)}}LayoutConnectedGraphWithMds(){let t={x:[],y:[]};Ls.LayoutGraphWithMds(this.graph,this.settings,t,this.length),this.settings.RotationAngle!==0&&jm.Rotate(t.x,t.y,this.settings.RotationAngle);let i=0;for(let n of this.graph.shallowNodes)n.boundingBox&&(n.center=new m(t.x[i]*this.settings.ScaleX,t.y[i]*this.settings.ScaleY)),i++;this.settings.removeOverlaps&&Qr.RemoveOverlaps(Array.from(this.graph.shallowNodes),this.settings.NodeSeparation),this.graph.pumpTheBoxToTheGraphWithMargins()}ScaleNodes(t,i){for(let n of t)n.center=n.center.mul(i)}static PackGraphs(t,i){if(t.length===0)return X.mkEmpty();if(t.length===1)return t[0].boundingBox;let n=t.map(l=>l.boundingBox),o=new Array;for(let l of t)o.push({g:l,lb:l.boundingBox.leftBottom.clone()});let a=new Hl(n,i.PackingAspectRatio);a.run();for(let{g:l,lb:u}of o){let c=l.boundingBox.leftBottom.sub(u);l.translate(c)}return new X({left:0,bottom:0,right:a.PackedWidth,top:a.PackedHeight})}};var Qi=class{constructor(){this.commonSettings=new Qn;this.pivotNumber=50;this.iterationsWithMajorization=30;this.scaleX=100;this.scaleY=100;this.exponent=-2;this.rotationAngle=0;this._removeOverlaps=!0;this._callIterationsWithMajorizationThreshold=2e3;this.adjustScale=!1}static fromJSON(e){let t=new Qi;return e.pivotNumber&&(t.pivotNumber=e.pivotNumber),e.iterationsWithMajorization&&(t.iterationsWithMajorization=e.iterationsWithMajorization),e.scaleX&&(t.scaleX=e.scaleX),e.scaleY&&(t.scaleY=e.scaleY),e.exponent&&(t.exponent=e.exponent),e.rotationAngle&&(t.rotationAngle=e.rotationAngle),e.removeOverlaps!=null&&(t._removeOverlaps=e.removeOverlaps),e._callIterationsWithMajorizationThreshold&&(t._callIterationsWithMajorizationThreshold=e._callIterationsWithMajorizationThreshold),t}toJSON(){let e={};return this.pivotNumber!=50&&(e.pivotNumber=this.pivotNumber),this.iterationsWithMajorization!=30&&(e.iterationsWithMajorization=this.iterationsWithMajorization),this.scaleX!=200&&(e.scaleX=this.scaleX),this.scaleY!=200&&(e.scaleY=this.scaleY),this.exponent!=-2&&(e.exponent=this.exponent),this.rotationAngle!=0&&(e.rotationAngle=this.rotationAngle),this._removeOverlaps||(e.removeOverlaps=this._removeOverlaps),this._callIterationsWithMajorizationThreshold!=3e3&&(e._callIterationsWithMajorizationThreshold=this._callIterationsWithMajorizationThreshold),e}get NodeSeparation(){return this.commonSettings.NodeSeparation}set NodeSeparation(e){this.commonSettings.NodeSeparation=e}get edgeRoutingSettings(){return this.commonSettings.edgeRoutingSettings}set edgeRoutingSettings(e){this.commonSettings.edgeRoutingSettings=e}get removeOverlaps(){return this._removeOverlaps}set removeOverlaps(e){this._removeOverlaps=e}get PivotNumber(){return this.pivotNumber}set PivotNumber(e){this.pivotNumber=e}get IterationsWithMajorization(){return this.iterationsWithMajorization}set IterationsWithMajorization(e){this.iterationsWithMajorization=e}get ScaleX(){return this.scaleX}set ScaleX(e){this.scaleX=e}get ScaleY(){return this.scaleY}set ScaleY(e){this.scaleY=e}get Exponent(){return this.exponent}set Exponent(e){this.exponent=e}get RotationAngle(){return this.rotationAngle}set RotationAngle(e){this.rotationAngle=e%360}get AdjustScale(){return this.adjustScale}set AdjustScale(e){this.adjustScale=e}GetNumberOfIterationsWithMajorization(e){return e>this.CallIterationsWithMajorizationThreshold?0:this.IterationsWithMajorization}get CallIterationsWithMajorizationThreshold(){return this._callIterationsWithMajorizationThreshold}set CallIterationsWithMajorizationThreshold(e){this._callIterationsWithMajorizationThreshold=e}};var nu=class extends Pe{constructor(t,i,n,o){super(i);this.graph=t,this.length=n,this.settings=o,this.settings.ScaleX=this.settings.ScaleY=200}get scaleX(){return this.settings.ScaleX}set scaleX(t){this.settings.ScaleX=t}get scaleY(){return this.settings.ScaleY}set scaleY(t){this.settings.ScaleY=t}run(){new Ls(this.settings,this.graph,this.cancelToken,this.length).run()}};function Km(s,e,t){if(e)for(let i of e){if(t&&t.canceled)return;Tr.RouteEdge(i,s.padding)}else for(let i of s.nodesBreadthFirst){if(t&&t.canceled)return;for(let n of i.outEdges())n.curve==null&&Tr.RouteEdge(n,s.padding);for(let n of i.selfEdges())n.curve==null&&Tr.RouteEdge(n,s.padding)}}var Tr=class extends Pe{constructor(t,i){super(null);this.edges=t,this.padding=i}run(){ke.CreatePortsIfNeeded(this.edges);for(let t of this.edges)Tr.RouteEdge(t,this.padding)}static RouteEdge(t,i){let n=t;n.sourcePort==null&&(n.sourcePort=Or.mk(()=>t.source.boundaryCurve,()=>t.source.center)),n.targetPort==null&&(n.targetPort=Or.mk(()=>t.target.boundaryCurve,()=>t.target.center)),Tr.ContainmentLoop(n,i)||(n.curve=Tr.GetEdgeLine(t)),ut.trimSplineAndCalculateArrowheadsII(n,n.sourcePort.Curve,n.targetPort.Curve,t.curve,!1)}static ContainmentLoop(t,i){let n=t.sourcePort.Curve,o=t.targetPort.Curve;if(n==null||o==null)return!1;let a=n.boundingBox,l=o.boundingBox,u=a.containsRect(l),c=!u&&l.containsRect(a);return u||c?(t.curve=Tr.CreateLoop(a,l,c,i),!0):!1}static CreateLoop(t,i,n,o){return n?Tr.CreateLoop_(t,i,o,!1):Tr.CreateLoop_(i,t,o,!0)}static CreateLoop_(t,i,n,o){let a=t.center,l=Tr.FindClosestPointOnBoxBoundary(t.center,i),u=l.sub(a),h=(Math.abs(u.x)<R.distanceEpsilon?Math.min(a.y-i.bottom,i.top-a.y):Math.min(a.x-i.left,i.right-a.x))/2,d=Math.min(n,h);u.length<=R.distanceEpsilon&&(u=new m(1,0));let f=u.normalize(),p=f.rotate(Math.PI/2),S=l.add(f.mul(n)),E=S.add(p.mul(d)),C=l.add(p.mul(d)),O=a.add(p.mul(d));return(o?ot.mkFromPoints([O,C,E,S,l,a]):ot.mkFromPoints([a,l,S,E,C,O])).createCurve()}static FindClosestPointOnBoxBoundary(t,i){let n=t.x-i.left<i.right-t.x?i.left:i.right,o=t.y-i.bottom<i.top-t.y?i.bottom:i.top;return Math.abs(n-t.x)<Math.abs(o-t.y)?new m(n,t.y):new m(t.x,o)}static GetEdgeLine(t){let i,n;t.sourcePort==null?(i=t.source.center,n=t.source.boundaryCurve):(i=t.sourcePort.Location,n=t.sourcePort.Curve);let o,a;t.targetPort==null?(o=t.target.center,a=t.target.boundaryCurve):(o=t.targetPort.Location,a=t.targetPort.Curve);let l=k.mkPP(i,o),u=I.getAllIntersections(n,l,!1);if(u.length>0){let c=l.trim(u[0].par1,1);c instanceof k&&(l=c,u=I.getAllIntersections(a,l,!1),u.length>0&&(c=l.trim(0,u[0].par1),c instanceof k&&(l=c)))}return l}static CreateSimpleEdgeCurveWithUnderlyingPolyline(t){let i=t.sourcePort?t.sourcePort.Location:t.source.center,n=t.targetPort?t.targetPort.Location:t.target.center;if(t.source===t.target){let o=2/(3*t.source.boundaryCurve.boundingBox.width),a=t.source.boundingBox.height/4;t.smoothedPolyline=Tr.CreateUnderlyingPolylineForSelfEdge(i,o,a),t.curve=t.smoothedPolyline.createCurve()}else t.smoothedPolyline=ot.mkFromPoints([i,n]),t.curve=t.smoothedPolyline.createCurve();ut.trimSplineAndCalculateArrowheadsII(t,t.source.boundaryCurve,t.target.boundaryCurve,t.curve,!1)}static CreateUnderlyingPolylineForSelfEdge(t,i,n){let o=t.add(new m(0,n)),a=t.add(new m(i,n)),l=t.add(new m(i,n*-1)),u=t.add(new m(0,n*-1)),c=We.mkSiteP(t),h=new ot(c);return c=We.mkSiteSP(c,o),c=We.mkSiteSP(c,a),c=We.mkSiteSP(c,l),c=We.mkSiteSP(c,u),We.mkSiteSP(c,t),h}static SetStraightLineEdgesWithUnderlyingPolylines(t){ke.CreatePortsIfNeeded(Array.from(t.deepEdges));for(let i of t.deepEdges)Tr.CreateSimpleEdgeCurveWithUnderlyingPolyline(i)}};var pA,eS=function(){var s={exports:{}};return function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});function n(o,a,l){if(o.length===0)return-1;let u=0,c=o.length-1;for(;u<=c;){let h=u+(c-u>>1),d=o[h];switch(Math.sign(l.compare(d,a))){case-1:u=h+1;break;case 0:return h;case 1:c=h-1;break}}return~u}t.binarySearch=n}(s,s.exports,null),s.exports}(),tS=class{constructor(...e){this._values=[];let t,i;if(e.length>0){let n=e[0];n===void 0||n!=null&&Symbol.iterator in Object(n)?(t=n,e.length>1&&(i=e[1])):i=n}if(i??(i=xn.defaultComparer),this._comparer=typeof i=="function"?xn.create(i):i,t)for(let n of t)this.add(n)}get comparer(){return this._comparer}get size(){return this._values.length}has(e){return(0,eS.binarySearch)(this._values,e,this._comparer)>=0}add(e){let t=(0,eS.binarySearch)(this._values,e,this._comparer);return t>=0?this._values[t]=e:this._values.splice(~t,0,e),this}delete(e){let t=(0,eS.binarySearch)(this._values,e,this._comparer);return t>=0?(this._values.splice(t,1),!0):!1}clear(){this._values.length=0}keys(){return this._values.values()}values(){return this._values.values()}*entries(){for(let e=0;e<this._values.length;e++)yield[this._values[e],this._values[e]]}[Symbol.iterator](){return this.values()}forEach(e,t){if(typeof e!="function")throw new TypeError("Function expected: callback");for(let i of this)e.call(t,i,i,this)}get[Ut.size](){return this.size}[Ut.has](e){return this.has(e)}[Ut.add](e){this.add(e)}[Ut.delete](e){return this.delete(e)}[Ut.clear](){this.clear()}};pA=tS;Object.defineProperty(pA.prototype,Symbol.toStringTag,{configurable:!0,writable:!0,value:"SortedSet"});var mA,mi=function(){var s={exports:{}};return function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});let n=2**31-1,o=2146435069,a=101,l=[3,7,11,17,23,29,37,47,59,71,89,107,131,163,197,239,293,353,431,521,631,761,919,1103,1327,1597,1931,2333,2801,3371,4049,4861,5839,7013,8419,10103,12143,14591,17519,21023,25229,30293,36353,43627,52361,62851,75431,90523,108631,130363,156437,187751,225307,270371,324449,389357,467237,560689,672827,807403,968897,1162687,1395263,1674319,2009191,2411033,2893249,3471899,4166287,4999559,5999471,7199369];function u(_){if(_&1){let W=Math.sqrt(_)|0;for(let H=3;H<=W;H+=2)if(!(_%H))return!1;return!0}return _===2}function c(_){if(_<0)throw new RangeError;for(let W=0;W<l.length;W++){let H=l[W];if(H>=_)return H}for(let W=_|1;W<n;W+=2)if(u(W)&&(W-1)%a)return W;return _}function h(_){let W=2*_;return W>o&&o>_?o:c(W)}function d(){return{prevEntry:void 0,nextEntry:void 0,skipNextEntry:!1,next:0,hashCode:0,key:void 0,value:void 0}}function f(_,W){let H=d(),ee={buckets:void 0,entries:void 0,freeSize:0,freeList:0,size:0,equaler:_,head:H,tail:H};return p(ee,W),ee}t.createHashData=f;function p(_,W){let H=c(W);return _.freeList=-1,_.buckets=new Int32Array(H),_.entries=new Array(H),H}function S(_,W){let H=_.size,ee=new Int32Array(W),oe=_.entries?_.entries.slice():[];oe.length=W;for(let ce=0;ce<H;ce++){let Ee=oe[ce];if(Ee&&Ee.hashCode>=0){let Oe=Ee.hashCode%W;Ee.next=ee[Oe]-1,ee[Oe]=ce+1}}_.buckets=ee,_.entries=oe}function E(_,W){let H=-1;if(_.buckets&&_.entries){let ee=_.equaler.hash(W)&n;H=_.buckets[ee%_.buckets.length]-1;let oe=_.entries.length;for(;H>>>0<oe;){let ce=_.entries[H];if(ce.hashCode===ee&&_.equaler.equals(ce.key,W))break;H=ce.next}}return H}t.findEntryIndex=E;function C(_,W){let H=E(_,W);return H>=0?_.entries[H].value:void 0}t.findEntryValue=C;function O(_,W,H){if(_.buckets||p(_,0),!_.buckets||!_.entries)throw new Error;let ee=_.equaler.hash(W)&n,oe=ee%_.buckets.length,ce=_.buckets[oe]-1;for(;ce>>>0<_.entries.length;){let zr=_.entries[ce];if(zr.hashCode===ee&&_.equaler.equals(zr.key,W)){zr.value=H;return}ce=zr.next}let Ee=!1,Oe;if(_.freeSize>0)Oe=_.freeList,Ee=!0,_.freeSize--;else{let zr=_.size;if(zr===_.entries.length){if(S(_,h(_.size)),!_.buckets||!_.entries)throw new Error;oe=ee%_.buckets.length}Oe=zr,_.size=zr+1}let nt=_.entries[Oe]||(_.entries[Oe]=d());Ee&&(_.freeList=nt.next),nt.hashCode=ee,nt.next=_.buckets[oe]-1,nt.key=W,nt.value=H,nt.skipNextEntry=!1;let ui=_.tail;ui.nextEntry=nt,nt.prevEntry=ui,_.tail=nt,_.buckets[oe]=Oe+1}t.insertEntry=O;function B(_,W){if(_.buckets&&_.entries){let H=_.equaler.hash(W)&n,ee=H%_.buckets.length,oe=-1,ce;for(let Ee=_.buckets[ee]-1;Ee>=0;Ee=ce.next){if(ce=_.entries[Ee],ce.hashCode===H&&_.equaler.equals(ce.key,W)){oe<0?_.buckets[ee]=ce.next+1:_.entries[oe].next=ce.next;let Oe=ce.prevEntry;return Oe.nextEntry=ce.nextEntry,Oe.nextEntry&&(Oe.nextEntry.prevEntry=Oe),_.tail===ce&&(_.tail=Oe),ce.hashCode=-1,ce.next=_.freeList,ce.key=void 0,ce.value=void 0,ce.prevEntry=void 0,ce.nextEntry=Oe,ce.skipNextEntry=!0,_.freeList=Ee,_.freeSize++,!0}oe=Ee}}return!1}t.deleteEntry=B;function A(_){if(_.size>0){_.buckets&&_.buckets.fill(0),_.entries&&_.entries.fill(void 0);let H=_.head.nextEntry;for(;H;){let ee=H.nextEntry;H.prevEntry=void 0,H.nextEntry=_.head,H.skipNextEntry=!0,H=ee}_.head.nextEntry=void 0,_.tail=_.head,_.size=0,_.freeList=-1,_.freeSize=0}}t.clearEntries=A;function N(_,W){if(W<0)throw new RangeError;let H=_.entries?_.entries.length:0;if(H>=W)return H;if(!_.buckets)return p(_,W);let ee=c(W);return S(_,c(W)),ee}t.ensureCapacity=N;function z(_,W=_.size-_.freeSize){if(W<_.size)throw new RangeError;if(!_.buckets||!_.entries)return;let H=c(W),ee=_.entries;if(H>=(ee?ee.length:0))return;let oe=_.size;if(p(_,H),!_.buckets||!_.entries)throw new Error;let ce=0;for(let Ee=0;Ee<oe;Ee++){let Oe=ee[Ee].hashCode;if(Oe>=0){let nt=Oe%H;_.entries[ce]=ee[Ee],_.entries[ce].next=_.buckets[nt]-1,_.buckets[nt]=ce+1,ce++}}_.size=ce,_.freeSize=0}t.trimExcessEntries=z;function Y(_){return _.key}t.selectEntryKey=Y;function ie(_){return _.value}t.selectEntryValue=ie;function he(_){return[_.key,_.value]}t.selectEntryEntry=he;function*ae(_,W){let H=_;for(;H;){let ee=H.skipNextEntry;H=H.nextEntry,!ee&&H&&(yield W(H))}}t.iterateEntries=ae;function D(_,W,H,ee){let oe=W;for(;oe;){let ce=oe.skipNextEntry;oe=oe.nextEntry,!ce&&oe&&H.call(ee,oe.value,oe.key,_)}}t.forEachEntry=D}(s,s.exports,null),s.exports}(),lf=class{constructor(...e){let t,i,n;if(e.length>0){let o=e[0];if(typeof o=="number"){if(!(Object.is(o,o|0)&&o>=0))throw new RangeError("Argument out of range: capacity");t=o,e.length>1&&(n=e[1])}else o===void 0||o!=null&&Symbol.iterator in Object(o)?(i=o,e.length>1&&(n=e[1])):n=o}if(t??(t=0),n??(n=_r.defaultEqualer),this._hashData=(0,mi.createHashData)(n,t),i)for(let[o,a]of i)this.set(o,a)}get equaler(){return this._hashData.equaler}get size(){return this._hashData.size-this._hashData.freeSize}has(e){return(0,mi.findEntryIndex)(this._hashData,e)>=0}get(e){return(0,mi.findEntryValue)(this._hashData,e)}set(e,t){return(0,mi.insertEntry)(this._hashData,e,t),this}delete(e){return(0,mi.deleteEntry)(this._hashData,e)}clear(){(0,mi.clearEntries)(this._hashData)}ensureCapacity(e){if(typeof e!="number")throw new TypeError("Number expected: capacity");if(!(Object.is(e,e|0)&&e>=0))throw new RangeError("Argument out of range: capacity");return(0,mi.ensureCapacity)(this._hashData,e)}trimExcess(e){if(e!==void 0){if(typeof e!="number")throw new TypeError("Number expected: capacity");if(!(Object.is(e,e|0)&&e>=0))throw new RangeError("Argument out of range: capacity")}(0,mi.trimExcessEntries)(this._hashData,e)}keys(){return(0,mi.iterateEntries)(this._hashData.head,mi.selectEntryKey)}values(){return(0,mi.iterateEntries)(this._hashData.head,mi.selectEntryValue)}entries(){return(0,mi.iterateEntries)(this._hashData.head,mi.selectEntryEntry)}[Symbol.iterator](){return this.entries()}forEach(e,t){if(typeof e!="function")throw new TypeError("Function expected: callback");(0,mi.forEachEntry)(this,this._hashData.head,e,t)}get[wi.size](){return this.size}[wi.has](e){return this.has(e)}[wi.get](e){return this.get(e)}[wi.keys](){return this.keys()}[wi.values](){return this.values()}[pi.set](e,t){this.set(e,t)}[pi.delete](e){return this.delete(e)}[pi.clear](){this.clear()}};mA=lf;Object.defineProperty(mA.prototype,Symbol.toStringTag,{configurable:!0,writable:!0,value:"HashMap"});var bA,bi=function(){var s={exports:{}};return function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});let n=2**31-1,o=2146435069,a=101,l=[3,7,11,17,23,29,37,47,59,71,89,107,131,163,197,239,293,353,431,521,631,761,919,1103,1327,1597,1931,2333,2801,3371,4049,4861,5839,7013,8419,10103,12143,14591,17519,21023,25229,30293,36353,43627,52361,62851,75431,90523,108631,130363,156437,187751,225307,270371,324449,389357,467237,560689,672827,807403,968897,1162687,1395263,1674319,2009191,2411033,2893249,3471899,4166287,4999559,5999471,7199369];function u(D){if(D&1){let _=Math.sqrt(D)|0;for(let W=3;W<=_;W+=2)if(!(D%W))return!1;return!0}return D===2}function c(D){if(D<0)throw new RangeError;for(let _=0;_<l.length;_++){let W=l[_];if(W>=D)return W}for(let _=D|1;_<n;_+=2)if(u(_)&&(_-1)%a)return _;return D}function h(D){let _=2*D;return _>o&&o>D?o:c(_)}function d(){return{prevEntry:void 0,nextEntry:void 0,skipNextEntry:!1,next:0,hashCode:0,key:void 0,value:void 0}}function f(D,_){let W=d(),H={buckets:void 0,entries:void 0,freeSize:0,freeList:0,size:0,equaler:D,head:W,tail:W};return p(H,_),H}t.createHashData=f;function p(D,_){let W=c(_);return D.freeList=-1,D.buckets=new Int32Array(W),D.entries=new Array(W),W}function S(D,_){let W=D.size,H=new Int32Array(_),ee=D.entries?D.entries.slice():[];ee.length=_;for(let oe=0;oe<W;oe++){let ce=ee[oe];if(ce&&ce.hashCode>=0){let Ee=ce.hashCode%_;ce.next=H[Ee]-1,H[Ee]=oe+1}}D.buckets=H,D.entries=ee}function E(D,_){let W=-1;if(D.buckets&&D.entries){let H=D.equaler.hash(_)&n;W=D.buckets[H%D.buckets.length]-1;let ee=D.entries.length;for(;W>>>0<ee;){let oe=D.entries[W];if(oe.hashCode===H&&D.equaler.equals(oe.key,_))break;W=oe.next}}return W}t.findEntryIndex=E;function C(D,_,W){if(D.buckets||p(D,0),!D.buckets||!D.entries)throw new Error;let H=D.equaler.hash(_)&n,ee=H%D.buckets.length,oe=D.buckets[ee]-1;for(;oe>>>0<D.entries.length;){let ui=D.entries[oe];if(ui.hashCode===H&&D.equaler.equals(ui.key,_)){ui.value=W;return}oe=ui.next}let ce=!1,Ee;if(D.freeSize>0)Ee=D.freeList,ce=!0,D.freeSize--;else{let ui=D.size;if(ui===D.entries.length){if(S(D,h(D.size)),!D.buckets||!D.entries)throw new Error;ee=H%D.buckets.length}Ee=ui,D.size=ui+1}let Oe=D.entries[Ee]||(D.entries[Ee]=d());ce&&(D.freeList=Oe.next),Oe.hashCode=H,Oe.next=D.buckets[ee]-1,Oe.key=_,Oe.value=W,Oe.skipNextEntry=!1;let nt=D.tail;nt.nextEntry=Oe,Oe.prevEntry=nt,D.tail=Oe,D.buckets[ee]=Ee+1}t.insertEntry=C;function O(D,_){if(D.buckets&&D.entries){let W=D.equaler.hash(_)&n,H=W%D.buckets.length,ee=-1,oe;for(let ce=D.buckets[H]-1;ce>=0;ce=oe.next){if(oe=D.entries[ce],oe.hashCode===W&&D.equaler.equals(oe.key,_)){ee<0?D.buckets[H]=oe.next+1:D.entries[ee].next=oe.next;let Ee=oe.prevEntry;return Ee.nextEntry=oe.nextEntry,Ee.nextEntry&&(Ee.nextEntry.prevEntry=Ee),D.tail===oe&&(D.tail=Ee),oe.hashCode=-1,oe.next=D.freeList,oe.key=void 0,oe.value=void 0,oe.prevEntry=void 0,oe.nextEntry=Ee,oe.skipNextEntry=!0,D.freeList=ce,D.freeSize++,!0}ee=ce}}return!1}t.deleteEntry=O;function B(D){if(D.size>0){D.buckets&&D.buckets.fill(0),D.entries&&D.entries.fill(void 0);let W=D.head.nextEntry;for(;W;){let H=W.nextEntry;W.prevEntry=void 0,W.nextEntry=D.head,W.skipNextEntry=!0,W=H}D.head.nextEntry=void 0,D.tail=D.head,D.size=0,D.freeList=-1,D.freeSize=0}}t.clearEntries=B;function A(D,_){if(_<0)throw new RangeError;let W=D.entries?D.entries.length:0;if(W>=_)return W;if(!D.buckets)return p(D,_);let H=c(_);return S(D,c(_)),H}t.ensureCapacity=A;function N(D,_=D.size-D.freeSize){if(_<D.size)throw new RangeError;if(!D.buckets||!D.entries)return;let W=c(_),H=D.entries;if(W>=(H?H.length:0))return;let ee=D.size;if(p(D,W),!D.buckets||!D.entries)throw new Error;let oe=0;for(let ce=0;ce<ee;ce++){let Ee=H[ce].hashCode;if(Ee>=0){let Oe=Ee%W;D.entries[oe]=H[ce],D.entries[oe].next=D.buckets[Oe]-1,D.buckets[Oe]=oe+1,oe++}}D.size=oe,D.freeSize=0}t.trimExcessEntries=N;function z(D){return D.key}t.selectEntryKey=z;function Y(D){return D.value}t.selectEntryValue=Y;function ie(D){return[D.key,D.value]}t.selectEntryEntry=ie;function*he(D,_){let W=D;for(;W;){let H=W.skipNextEntry;W=W.nextEntry,!H&&W&&(yield _(W))}}t.iterateEntries=he;function ae(D,_,W,H){let ee=_;for(;ee;){let oe=ee.skipNextEntry;ee=ee.nextEntry,!oe&&ee&&W.call(H,ee.value,ee.key,D)}}t.forEachEntry=ae}(s,s.exports,null),s.exports}(),Rs=class{constructor(...e){let t,i,n;if(e.length>0){let o=e[0];if(typeof o=="number"){if(!(Object.is(o,o|0)&&o>=0))throw new RangeError("Argument out of range: capacity");t=o,e.length>1&&(n=e[1])}else o===void 0||o!=null&&Symbol.iterator in Object(o)?(i=o,e.length>1&&(n=e[1])):n=o}if(t??(t=0),n??(n=_r.defaultEqualer),this._hashData=(0,bi.createHashData)(n,t),i)for(let o of i)this.add(o)}get equaler(){return this._hashData.equaler}get size(){return this._hashData.size-this._hashData.freeSize}has(e){return(0,bi.findEntryIndex)(this._hashData,e)>=0}add(e){return(0,bi.insertEntry)(this._hashData,e,e),this}tryAdd(e){let t=this.size;return(0,bi.insertEntry)(this._hashData,e,e),this.size>t}delete(e){return(0,bi.deleteEntry)(this._hashData,e)}clear(){(0,bi.clearEntries)(this._hashData)}ensureCapacity(e){if(typeof e!="number")throw new TypeError("Number expected: capacity");if(!(Object.is(e,e|0)&&e>=0))throw new RangeError("Argument out of range: capacity");return(0,bi.ensureCapacity)(this._hashData,e)}trimExcess(e){if(e!==void 0){if(typeof e!="number")throw new TypeError("Number expected: capacity");if(!(Object.is(e,e|0)&&e>=0))throw new RangeError("Argument out of range: capacity")}(0,bi.trimExcessEntries)(this._hashData,e)}keys(){return(0,bi.iterateEntries)(this._hashData.head,bi.selectEntryKey)}values(){return(0,bi.iterateEntries)(this._hashData.head,bi.selectEntryValue)}entries(){return(0,bi.iterateEntries)(this._hashData.head,bi.selectEntryEntry)}[Symbol.iterator](){return this.values()}forEach(e,t){if(typeof e!="function")throw new TypeError("Function expected: callback");(0,bi.forEachEntry)(this,this._hashData.head,e,t)}get[Ut.size](){return this.size}[Ut.has](e){return this.has(e)}[Ut.add](e){this.add(e)}[Ut.delete](e){return this.delete(e)}[Ut.clear](){this.clear()}};bA=Rs;Object.defineProperty(bA.prototype,Symbol.toStringTag,{configurable:!0,writable:!0,value:"HashSet"});var PA,rS=class{constructor(...e){var t,i;this._size=0;let n,o,a;vN(e)?[n,a={}]=e:(n=0,xN(e)?[o,a={}]=e:a={});let l=(t=a?.keyEqualer)!==null&&t!==void 0?t:_r.defaultEqualer,u=(i=a?.valueEqualer)!==null&&i!==void 0?i:_r.defaultEqualer;if(this._map=new lf(n,l),this._keyEqualer=l,this._valueEqualer=u,o)for(let[c,h]of o)this.add(c,h)}get keyEqualer(){return this._keyEqualer}get valueEqualer(){return this._valueEqualer}get size(){return this._size}has(e){return this._map.has(e)}hasValue(e,t){let i=this._map.get(e);return i?i.has(t):!1}get(e){return this._map.get(e)}add(e,t){let i=this._map.get(e);i||(i=new Rs(this._valueEqualer),this._map.set(e,i));let n=i.size;return i.add(t),this._size+=i.size-n,this}delete(e){let t=this._map.get(e);return t?(this._size-=t.size,this._map.delete(e),t.size):0}deleteValue(e,t){let i=this._map.get(e);if(i){let n=i.size;if(i.delete(t))return this._size+=i.size-n,i.size<=0&&this._map.delete(e),!0}return!1}clear(){this._map.clear(),this._size=0}ensureCapacity(e){return this._map.ensureCapacity(e)}trimExcess(e){this._map.trimExcess(e)}keys(){return this._map.keys()}*values(){for(let e of this._map.values())yield*e}*entries(){for(let[e,t]of this._map)for(let i of t)yield[e,i]}[Symbol.iterator](){return this.entries()}forEach(e,t){if(typeof e!="function")throw new TypeError("Function expected: callback");for(let[i,n]of this._map)for(let o of n)e.call(t,o,i,this)}get[Kr.size](){return this.size}[Kr.has](e){return this.has(e)}[Kr.hasValue](e,t){return this.hasValue(e,t)}[Kr.get](e){return this.get(e)}[Kr.keys](){return this.keys()}[Kr.values](){return this.values()}[$l.add](e,t){this.add(e,t)}[$l.delete](e){return this.delete(e)}[$l.deleteValue](e,t){return this.deleteValue(e,t)}[$l.clear](){this.clear()}};PA=rS;Object.defineProperty(PA.prototype,Symbol.toStringTag,{configurable:!0,writable:!0,value:"MultiMap"});function xN(s){let[e,t]=s;return(e===void 0||e!=null&&Symbol.iterator in Object(e))&&(t===void 0||typeof t=="object"&&t!==null||typeof t=="function")}function vN(s){let[e,t]=s;return typeof e=="number"&&(t===void 0||typeof t=="object"&&t!==null||typeof t=="function")}var yA,SA,iS,su,za,au,Wa,Ir=class{constructor(e){this._list=void 0,this._previous=void 0,this._next=void 0,this.value=e}get list(){return this._list}get previous(){if(this._previous&&this._list&&this!==this._list.first)return this._previous}get next(){if(this._next&&this._list&&this._next!==this._list.first)return this._next}detachSelf(){return this._list?this._list.deleteNode(this):!1}};yA=Ir;iS=(s,e)=>{s._list=e},su=s=>s._previous,za=(s,e)=>{s._previous=e},au=s=>s._next,Wa=(s,e)=>{s._next=e},Object.defineProperty(yA.prototype,Symbol.toStringTag,{configurable:!0,writable:!0,value:"LinkedListNode"});var jo=class{constructor(...e){this._size=0,this._head=void 0;let t,i;if(e.length>0){let n=e[0];n===void 0||n!=null&&Symbol.iterator in Object(n)?(t=n,e.length>1&&(i=e[1])):i=n}if(i??(i=_r.defaultEqualer),this._equaler=typeof i=="function"?_r.create(i):i,t)for(let n of t)this.push(n)}get equaler(){return this._equaler}get first(){return this._head}get last(){if(this._head)return su(this._head)}get size(){return this._size}[Symbol.iterator](){return this.values()}*values(){for(let e of this.nodes())yield e.value}*nodes(){let e,t=this.first;for(;t!==void 0;)e=t,t=e.next,yield e}*drain(){for(let e of this.nodes())this.deleteNode(e),yield e.value}nodeOf(e,t){if(t!=null&&!(t instanceof Ir))throw new TypeError("LinkedListNode expected: fromNode");if(t!=null&&t.list!==this)throw new TypeError("Wrong list.");for(let i=t??this.first;i;i=i.next)if(this._equaler.equals(i.value,e))return i}lastNodeOf(e,t){if(t!=null&&!(t instanceof Ir))throw new TypeError("LinkedListNode expected: fromNode");if(t!=null&&t.list!==this)throw new TypeError("Wrong list.");for(let i=t??this.last;i;i=i.previous)if(this._equaler.equals(i.value,e))return i}find(e,t){if(typeof e!="function")throw new TypeError("Function expected: callback");let i,n=this.first;for(;n!==void 0;){i=n,n=i.next;let o=i.value;if(e.call(t,o,i,this))return o}}findLast(e,t){if(typeof e!="function")throw new TypeError("Function expected: callback");let i,n=this.last;for(;n!==void 0;){i=n,n=i.previous;let o=i.value;if(e.call(t,o,i,this))return o}}findNode(e,t){if(typeof e!="function")throw new TypeError("Function expected: callback");let i,n=this.first;for(;n!==void 0;)if(i=n,n=i.next,e.call(t,i.value,i,this))return i}findLastNode(e,t){if(typeof e!="function")throw new TypeError("Function expected: callback");let i,n=this.last;for(;n!==void 0;)if(i=n,n=i.previous,e.call(t,i.value,i,this))return i}has(e){return this.nodeOf(e)!==void 0}insertBefore(e,t){if(e!=null&&!(e instanceof Ir))throw new TypeError("LinkedListNode expected: node");if(e!=null&&e.list!==this)throw new TypeError("Wrong list.");return this._insertNode(e??void 0,new Ir(t),0)}insertNodeBefore(e,t){if(e!=null&&!(e instanceof Ir))throw new TypeError("LinkedListNode expected: node");if(e!=null&&e.list!==this)throw new TypeError("Wrong list.");if(!(t instanceof Ir))throw new TypeError("LinkedListNode expected: newNode");if(t.list)throw new Error("Node is already attached to a list.");this._insertNode(e||void 0,t,0)}insertAfter(e,t){if(e!=null&&!(e instanceof Ir))throw new TypeError("LinkedListNode expected: node");if(e!=null&&e.list!==this)throw new TypeError("Wrong list.");return this._insertNode(e||void 0,new Ir(t),1)}insertNodeAfter(e,t){if(e!=null&&!(e instanceof Ir))throw new TypeError("LinkedListNode expected: node");if(e!=null&&e.list!==this)throw new TypeError("Wrong list.");if(!(t instanceof Ir))throw new TypeError("LinkedListNode expected: newNode");if(t.list)throw new Error("Node is already attached to a list.");this._insertNode(e||void 0,t,1)}push(e){return this._insertNode(void 0,new Ir(e),1)}pushNode(e){if(!(e instanceof Ir))throw new TypeError("LinkedListNode expected: newNode");if(e.list)throw new Error("Node is already attached to a list.");this._insertNode(void 0,e,1)}pop(){let e=this.popNode();return e?e.value:void 0}popNode(){let e=this.last;if(this.deleteNode(e))return e}shift(){let e=this.shiftNode();return e?e.value:void 0}shiftNode(){let e=this.first;if(this.deleteNode(e))return e}unshift(e){return this._insertNode(void 0,new Ir(e),0)}unshiftNode(e){if(!(e instanceof Ir))throw new TypeError("LinkedListNode expected: newNode");if(e.list)throw new Error("Node is already attached to a list.");this._insertNode(void 0,e,0)}delete(e){let t=this.nodeOf(e);if(t&&this.deleteNode(t))return t}deleteNode(e){if(e!=null&&!(e instanceof Ir))throw new TypeError("LinkedListNode expected: node");if(e!=null&&e.list!==this)throw new TypeError("Wrong list.");return e==null||!e.list?!1:this._deleteNode(e)}deleteAll(e,t){if(typeof e!="function")throw new TypeError("Function expected: predicate");let i=0,n=this.first;for(;n;){let o=n.next;e.call(t,n.value,n,this)&&n.list===this&&(this._deleteNode(n),++i),n=o}return i}clear(){for(;this.size>0;)this.deleteNode(this.last)}forEach(e,t){if(typeof e!="function")throw new TypeError("Function expected: callback");let i,n=this.first;for(;n!==void 0;)i=n,n=i.next,e.call(t,i.value,i,this)}map(e,t){if(typeof e!="function")throw new TypeError("Function expected: callback");let i=new jo,n,o=this.first;for(;o!==void 0;){n=o,o=n.next;let a=e.call(t,n.value,n,this);i.push(a)}return i}filter(e,t){if(typeof e!="function")throw new TypeError("Function expected: callback");let i=new jo(this.equaler),n,o=this.first;for(;o!==void 0;){n=o,o=n.next;let a=n.value;e.call(t,a,n,this)&&i.push(a)}return i}reduce(e,t){if(typeof e!="function")throw new TypeError("Function expected: callback");let i=arguments.length>1,n=t,o,a=this.first;for(;a!==void 0;){o=a,a=o.next;let l=o.value;i?n=e(n,l,o,this):(n=l,i=!0)}return n}reduceRight(e,t){if(typeof e!="function")throw new TypeError("Function expected: callback");let i=arguments.length>1,n=t,o,a=this.last;for(;a!==void 0;){o=a;let l=o.value;i?n=e(n,l,o,this):(n=l,i=!0),a=o.previous}return n}some(e,t){if(e!==void 0&&typeof e!="function")throw new TypeError("Function expected: callback");let i,n=this.first;for(;n!==void 0;)if(i=n,n=i.next,!e||e.call(t,i.value,i,this))return!0;return!1}every(e,t){if(typeof e!="function")throw new TypeError("Function expected: callback");let i=!1,n,o=this.first;for(;o!==void 0;){if(n=o,o=n.next,!e.call(t,n.value,n,this))return!1;i=!0}return i}_deleteNode(e){return au(e)===e?this._head=void 0:(za(au(e),su(e)),Wa(su(e),au(e)),this._head===e&&(this._head=au(e))),iS(e,void 0),za(e,void 0),Wa(e,void 0),this._size--,!0}_insertNode(e,t,i){if(iS(t,this),this._head===void 0)Wa(t,t),za(t,t),this._head=t;else switch(i){case 0:e===void 0?(e=this._head,this._head=t):e===this._head&&(this._head=t),Wa(t,e),za(t,su(e)),Wa(su(e),t),za(e,t);break;case 1:e===void 0&&(e=su(this._head)),za(t,e),Wa(t,au(e)),za(au(e),t),Wa(e,t);break}return this._size++,t}get[gi.size](){return this.size}[gi.has](e){return this.has(e)}[Ut.add](e){this.push(e)}[Ut.delete](e){return!!this.delete(e)}[Ut.clear](){this.clear()}};SA=jo;Object.defineProperty(SA.prototype,Symbol.toStringTag,{configurable:!0,writable:!0,value:"LinkedList"});var EA=(n=>(n[n.OverlapsOtherLabels=0]="OverlapsOtherLabels",n[n.OverlapsNodes=1]="OverlapsNodes",n[n.OverlapsEdges=2]="OverlapsEdges",n[n.OverlapsNothing=Number.MAX_VALUE]="OverlapsNothing",n))(EA||{});var nS=class{},oS=class{constructor(){this.points=new jo;this.coveredLength=0}AddFirst(e){if(this.points.size!==0){let t=this.points.first.value;this.coveredLength=this.coveredLength+e.Center.sub(t.Center).length}return this.points.insertBefore(null,e),this.coveredLength}AddLast(e){if(this.points.size!==0){let t=this.points.last.value;this.coveredLength=this.coveredLength+e.Center.sub(t.Center).length}return this.points.insertAfter(null,e),this.coveredLength}};var Zm=class{constructor(e){this.location=e,this.boundingBox=X.rectangleOnPoint(e)}},lu=class{constructor(e,t){this.data=t,this.boundingBox=e}},sS=class{constructor(e){this.innerPoints=[];this.outerPoints=[];this.placementSide=0;this.placementOffset=.5;this.edgePoints=e,this.placementSide}},Ze=class extends Pe{constructor(t,i){super(null);this.placementStrategy=[1,0];this.obstacleMaps=[];this.edgeInfos=new Map;this.granularity=Ze.MinGranularity;this.ScaleCollisionGranularity=!0;this.granularity=this.ScaleCollisionGranularity?this.interpolateGranularity(i.length):Ze.MinGranularity,this.InitializeObstacles(t,i),this.edges=i}get CollisionGranularity(){return this.granularity}set CollisionGranularity(t){this.granularity=t}static constructorG(t){return new Ze(Array.from(t.nodesBreadthFirst),Array.from(t.deepEdges).filter(i=>i.label))}static constructorGA(t,i){return new Ze(Array.from(t.nodesBreadthFirst),i.filter(n=>n.label))}interpolateGranularity(t){if(t<=Ze.LowerEdgeBound)return Ze.MaxGranularity;if(t>=Ze.UpperEdgeBound)return Ze.MinGranularity;let i=(Ze.UpperEdgeBound-Ze.LowerEdgeBound)/(t-Ze.LowerEdgeBound);return Math.ceil(Ze.MinGranularity+i)}InitializeObstacles(t,i){let n=this.GetEdgeObstacles(i);this.obstacleMaps[1]=ys(t.map(o=>[o.boundingBox,new lu(o.boundingBox,o)])),this.obstacleMaps[2]=ys(n.map(o=>[o.boundingBox,new lu(o.boundingBox,o)]))}static CurvePoints(t,i){let n=[],o=t.end.sub(t.start).lengthSquared/(i*i);return Ze.SubdivideCurveSegment(n,t,o,t.parStart,t.parEnd),n.sort(Ze.compareByArgument),n}static compareByArgument(t,i){return t[0]<i[0]?-1:t[0]>i[0]?1:0}static SubdivideCurveSegment(t,i,n,o,a){if(t.length>64)return;let l=i.value(o),u=i.value(a);if(l.sub(u).lengthSquared>n){let c=(o+a)/2;Ze.SubdivideCurveSegment(t,i,n,o,c),Ze.SubdivideCurveSegment(t,i,n,c,a)}else t.push([o,l])}static PlaceLabelsAtDefaultPositions(t,i){for(let n of i)n.label&&new Ze([n.source,n.target],[n]).run()}GetEdgeObstacles(t){let i=[];for(let n of t){if(n.curve==null)continue;let o=Ze.CurvePoints(n.curve,this.CollisionGranularity);this.edgeInfos.set(n,new sS(o));for(let a of o)i.push(new Zm(a[1]))}return i}AddLabelObstacle(t){this.labelObstacleMap==null?(this.labelObstacleMap=ys([[t.boundingBox,t]]),this.obstacleMaps[0]=this.labelObstacleMap):this.labelObstacleMap.Add(t.boundingBox,t)}run(){this.edges.sort((t,i)=>this.edgeInfos.get(t).edgePoints.length-this.edgeInfos.get(i).edgePoints.length);for(let t of this.edges)this.PlaceLabel(t)}PlaceLabel(t){let i=!1;for(let n of this.placementStrategy){switch(n){case 0:i=this.PlaceEdgeLabelOnCurve(t.label);break;case 1:i=this.PlaceEdgeLabelHorizontally(t);break;default:throw new Error("unexpected case")}if(i)break}i?this.CalculateCenterLabelInfoCenter(t.label):this.PlaceLabelAtFirstPosition(t.label)}getLabelInfo(t){let i=t.parent;return this.edgeInfos.get(i)}PlaceLabelAtFirstPosition(t){let i=t.parent,n=i.curve,o=this.edgeInfos.get(i).edgePoints,a=this.StartIndex(t,o.map(p=>p[1])),l=o[a][1],u=n.derivative(o[a][0]);u.length<R.distanceEpsilon&&(u=new m(1,1)),u=u.normalize();let c=new wt(t.width,t.height),h=this.getLabelInfo(t),d=Ze.GetPossibleSides(h.placementSide,u)[0],f=Ze.GetLabelBounds(l,u,c,d);this.SetLabelBounds(this.getLabelInfo(t),f)}StartIndex(t,i){let n=this.getLabelInfo(t);return Math.min(i.length-1,Math.max(0,Math.floor(i.length*n.placementOffset)))}CalculateCenterLabelInfoCenter(t){let i=this.getLabelInfo(t),n=new m(0,0);for(let o of i.innerPoints)n=n.add(o);for(let o of i.outerPoints)n=n.add(o);t.positionCenter(n.div(i.innerPoints.length+i.outerPoints.length))}PlaceEdgeLabelHorizontally(t){let i=t.label,o=this.getLabelInfo(i).edgePoints,a=new wt(i.width,i.height),l=-1,u=X.mkEmpty(),c=t.curve;for(let h of Ze.ExpandingSearch(this.StartIndex(i,o.map(d=>d[1])),0,o.length)){let d=o[h],f=c.derivative(d[0]);if(!ue(f.lengthSquared,0)){f=f.normalize();for(let p of Ze.GetPossibleSides(this.getLabelInfo(i).placementSide,f)){let S=Ze.GetLabelBounds(d[1],f,a,p),E=this.ConflictIndexRL(S,i);if(E>l&&(l=E,u=S,l===Number.MAX_VALUE))break}if(l===Number.MAX_VALUE)break}}if(l>=0){this.SetLabelBounds(this.getLabelInfo(i),u);let h=new lu(u,null);this.AddLabelObstacle(h);let d=this.getLabelInfo(i);return l===0?d.placementResult=0:l===1?d.placementResult=1:l===2?d.placementResult=2:d.placementResult=EA.OverlapsNothing,!0}return!1}static GetLabelBounds(t,i,n,o){let a=i.rotate(Math.PI/2).mul(o),l=t.add(a),u=1,c=a.x>0?l.x:l.x-n.width,h=a.y>0?l.y:l.y-n.height;if(Math.abs(a.x)<.75){let d=Math.acos(Math.abs(a.y)/u),f=u/Math.sin(d),p=u/Math.cos(d);c+=(a.x>0?-1:1)*Math.min(f,n.width/2),h+=(a.y>0?1:-1)*p}else if(Math.abs(a.y)<.75){let d=Math.acos(Math.abs(a.x)/u),f=u/Math.sin(d),p=u/Math.cos(d);c+=(a.x>0?1:-1)*p,h+=(a.y>0?-1:1)*Math.min(f,n.height/2)}return X.mkLeftBottomSize(c,h,n)}SetLabelBounds(t,i){t.innerPoints=[i.leftTop,i.rightTop],t.outerPoints=[i.leftBottom,i.rightBottom]}static GetPossibleSides(t,i){switch(i.length===0&&(t=0),t){case 1:return[-1];case 2:return[1];case 3:return ue(i.x,0)?Ze.GetPossibleSides(5,i):[1];case 4:return ue(i.x,0)?Ze.GetPossibleSides(6,i):[i.x<0?-1:1];case 5:return ue(i.y,0)?Ze.GetPossibleSides(3,i):[i.y<0?-1:1];case 6:return ue(i.y,0)?Ze.GetPossibleSides(4,i):[i.y<0?1:-1];default:return[-1,1]}}static*ExpandingSearch(t,i,n){let o=t+1,a=o;for(;a>i;)yield--a;for(;o<n;)yield o++}static PointSetLength(t){let i=0,n=null;for(let o of t)n!=null&&(i+=n.sub(o.Center).length),n=o.Center;return i}PlaceEdgeLabelOnCurve(t){let i=t.parent,n=this.getLabelInfo(t);n.innerPoints=null;let o=n.edgePoints,a=3,l=t.height/2,u=new wt(l,l),c=t.width;for(let h of Ze.ExpandingSearch(this.StartIndex(t,o),0,o.length)){let d=this.GetSidesAndEdgeCurve(t,i,o,h);for(let f of d){let p=new oS,S={coveredLength:0};if(this.ProcessExpandingSearchOnSide(h,o,i.curve,f,l,a,u,S,p,c),S.coveredLength>=c)return this.CaseOfCoveredLengthGreaterThanLabelLength(t,p,S.coveredLength,c,u),!0}}return!1}CaseOfCoveredLengthGreaterThanLabelLength(t,i,n,o,a){let l=new Array,u=new Array,c=Array.from(i.points),h=n-o;if(h>0){let f=c[c.length-1],p=c[c.length-2],S=f.Center.sub(p.Center),E=S.length;h>E&&(f=c[0],p=c[1],S=f.Center.sub(p.Center),E=S.length);let C=S.mul((E-h)/E);f.Center=p.Center.add(C),f.Inner=p.Inner.add(C),f.Outer=p.Outer.add(C)}this.GoOverOrderedPointsAndAddLabelObstacels(c,l,u,a);let d=this.getLabelInfo(t);d.innerPoints=l,d.outerPoints=u}GoOverOrderedPointsAndAddLabelObstacels(t,i,n,o){for(let a of t){let l=a.Center;i.push(a.Inner),n.push(a.Outer);let u=new lu(X.mkSizeCenter(new wt(o.width*2,o.height*2),l),null);this.AddLabelObstacle(u)}}ProcessExpandingSearchOnSide(t,i,n,o,a,l,u,c,h,d){for(let f of Ze.ExpandingSearch(t,0,i.length)){let[p,S]=i[f],E=n.derivative(p);if(ue(E.lengthSquared,0))continue;let C=E.rotate(Math.PI/2).normalize().mul(o),O=S.add(C.mul(a+l));if(this.Conflict(O,a,u))break;{let B=new nS;if(B.Center=O,B.Inner=S.add(C.mul(l)),B.Outer=S.add(C.mul(2*a+l)),c.coveredLength=f<=t?h.AddFirst(B):h.AddLast(B),c.coveredLength>=d)break}}}GetSidesAndEdgeCurve(t,i,n,o){let a=i.curve.derivative(n[o][0]);return Ze.GetPossibleSides(this.getLabelInfo(t).placementSide,a)}Conflict(t,i,n){return this.ConflictIndex(t,i,n)!==Number.MAX_VALUE}ConflictIndexRL(t,i){let n=i.parent,o=n.source,a=n.target;for(let l=0;l<this.obstacleMaps.length;l++)if(this.obstacleMaps[l]!=null){for(let u of this.obstacleMaps[l].GetAllIntersecting(t))if(!(l===1&&u instanceof lu&&u.data instanceof be&&(o.node.isDescendantOf(u.data.graph)||a.node.isDescendantOf(u.data))))return l}return Number.MAX_VALUE}ConflictIndex(t,i,n){let o=X.creatRectangleWithSize(new wt(n.width*2,n.height*2),t),a=i*i;for(let l=0;l<this.obstacleMaps.length;l++)if(this.obstacleMaps[l]!=null){for(let u=0;u<this.obstacleMaps.length;u++)if(this.obstacleMaps[u]!=null)for(let c of this.obstacleMaps[u].GetAllIntersecting(o))if(c instanceof Zm){if(t.sub(c.location).lengthSquared<a)return u}else return u;return Number.MAX_VALUE}}},Ji=Ze;Ji.MinGranularity=5,Ji.MaxGranularity=50,Ji.LowerEdgeBound=500,Ji.UpperEdgeBound=3e3;var $i=class extends ps{constructor(t,i=null){super(t,Xe.AlgorithmDataIndex);this.data=i}clone(){throw new Error("Method not implemented.")}rebind(t){this.entity=t,this.bind(Xe.AlgorithmDataIndex)}static getAlgData(t){return t.getAttr(Xe.AlgorithmDataIndex)}};function uf(s){let e=$i.getAlgData(s.node);return e==null?null:e.data}var Qm=class{constructor(e,t){this.force=new m(0,0);this.stayWeight=1;this.index=e,this.geomNode=t,this.ResetBounds()}get Center(){return this.center}set Center(e){this.geomNode.center=e,this.center=e}ResetBounds(){this.previousCenter=this.geomNode.center,this.center=this.geomNode.center,this.Width=this.geomNode.width,this.Height=this.geomNode.height}ToString(){return"FINode("+(this.index+("):"+this.geomNode))}};var Jm=class{constructor(e){this._length=1;this.mEdge=e,this.sourceFiNode=uf(this.mEdge.source),this.targetFiNode=uf(this.mEdge.target)}get source(){return this.sourceFiNode.index}get target(){return this.targetFiNode.index}get length(){return this._length}set length(e){this._length=e}vector(){return this.sourceFiNode.geomNode.center.sub(this.targetFiNode.geomNode.center)}};var xA=Ae(zn(),1);var vn=class{get Center(){return this.c}get Radius(){return this.r}Distance2(e){let t=this.c.y-e.y,i=this.c.x-e.x;return i*i+t*t}Contains(e){return this.Distance2(e)-1e-7<=this.r2}ContainsPN(e,t){for(let i=0;i<e.length;i++)if(t.findIndex(n=>n==i)==-1&&!this.Contains(e[i]))return!1;return!0}static constructorP(e){let t=new vn;return t.c=e,t.r=0,t.r2=0,t}static midPoint(e,t){return new m((t.x+e.x)/2,(t.y+e.y)/2)}static constructorPP(e,t){let i=new vn;return i.c=vn.midPoint(e,t),i.r2=i.Distance2(e),i.r=Math.sqrt(i.r2),Ce.assert(i.OnBoundary(e)),Ce.assert(i.OnBoundary(t)),i}OnBoundary(e){let t=this.Distance2(e);return Math.abs(t-this.r2)/(t+this.r2)<1e-5}static centre(e,t,i){Ce.assert(t.x!=e.x),Ce.assert(i.x!=t.x);let n=(t.y-e.y)/(t.x-e.x),o=(i.y-t.y)/(i.x-t.x);Ce.assert(o!=n);let a,l=(n*o*(e.y-i.y)+o*(e.x+t.x)-n*(t.x+i.x))/(2*(o-n));return Math.abs(n)>Math.abs(o)?a=(e.y+t.y)/2-(l-(e.x+t.x)/2)/n:a=(t.y+i.y)/2-(l-(t.x+i.x)/2)/o,new m(l,a)}static Collinear(e,t,i){return e.x*(t.y-i.y)+(t.x*(i.y-e.y)+i.x*(e.y-t.y))==0}static constructorPPP(e,t,i){vn.count++;let n=new vn;if(vn.Collinear(e,t,i)){let o=new m(Math.min(e.x,Math.min(t.x,i.x)),Math.min(e.y,Math.max(t.y,i.y))),a=new m(Math.max(e.x,Math.max(t.x,i.x)),Math.max(e.y,Math.max(t.y,i.y)));n.c=vn.midPoint(o,a),n.r2=n.Distance2(a),n.r=Math.sqrt(n.r2)}else{let o=t.x-e.x,a=i.x-t.x,l=i.x-e.x;o!=0?a!=0?n.c=vn.centre(e,t,i):(Ce.assert(l!=0),n.c=vn.centre(t,e,i)):(Ce.assert(a!=0),n.c=vn.centre(t,i,e)),n.r2=n.Distance2(e),n.r=Math.sqrt(n.r2),Ce.assert(n.OnBoundary(e)),Ce.assert(n.OnBoundary(t)),Ce.assert(n.OnBoundary(i))}return n}},Jn=vn;Jn.count=0;var aS=class{constructor(e,t){switch(this.boundary=t,Ce.assert(t.length<=3),t.length){case 0:this.disc=null;break;case 1:this.disc=Jn.constructorP(e[t[0]]);break;case 2:this.disc=Jn.constructorPP(e[t[0]],e[t[1]]);break;case 3:this.disc=Jn.constructorPPP(e[t[0]],e[t[1]],e[t[2]]);break}}contains(e){return this.disc==null?!1:this.disc.Contains(e)}},lS=class{constructor(e){this.ps=e,this.L=new jo;for(let i=0;i<this.ps.length;i++)this.L.push(i);let t=this.mtf_md(null,new Array);this.disc=t.disc,this.boundary=t.boundary}collinear3(e){return e.length==3?Jn.Collinear(this.ps[e[0]],this.ps[e[1]],this.ps[e[2]]):!1}mtf_md(e,t){Ce.assert(t.length<=3);let i=new aS(this.ps,t);if(t.length==3)return i;let n=this.L.first;for(;n!=null&&n!=e;){let o=n.next,a=n.value;if(!i.contains(this.ps[a])){let l=Array.from(t);l.push(a),Ce.assert(!this.collinear3(l),"Collinear points on boundary of minimal enclosing disc"),i=this.mtf_md(n,l),this.L.deleteNode(n),this.L.insertNodeBefore(null,n)}n=o}return i}},$m=class{static LinearComputation(e){return new lS(e).disc}static SlowComputation(e){let t=e.length,i=null,n=null;for(let o=0;o<t;o++)for(let a=0;a<t;a++){if(o!=a){let l=Jn.constructorPP(e[o],e[a]);l.ContainsPN(e,[o,a])&&(i==null||i.Radius>l.Radius)&&(i=l,n=[o,a])}for(let l=0;l<t;l++)if(l!=o&&l!=a&&!Jn.Collinear(e[o],e[a],e[l])){let u=Jn.constructorPPP(e[o],e[a],e[l]);u.ContainsPN(e,[o,a,l])&&(i==null||i.Radius>u.Radius)&&(i=u,n=[o,a,l])}}return Ce.assert(n!=null),i}};var Jr=class{static constructorNPA(e,t,i){let n=new Jr;n.p=e,n.z0=new bt(t.x,t.y),n.a=new Array(e);for(let o=0;o<e;o++)n.a[o]=n.compute(o,i);return n}static constructorPMM(e,t,i){let n=new Jr;Ce.assert(t.p==i.p),n.p=t.p,n.z0=new bt(e.x,e.y);let o=i.shift(n.z0),a=t.shift(n.z0);n.a=new Array(n.p);for(let l=0;l<n.p;l++)n.a[l]=uS(a[l],o[l]);return n}static factorial(e){let t=1;for(let i=2;i<=e;i++)t*=i;return t}static binomial(e,t){return Jr.factorial(e)/(Jr.factorial(t)*Jr.factorial(e-t))}sum(e,t){let i=bt.constructorN(0);for(let n=1;n<=e;n++){let o=bt.constructorN(Jr.binomial(e-1,n-1));i=uS(i,Ha(this.a[n],Ha(bt.Pow(t,e-n),o)))}return i}shift(e){let t=new Array(this.p),i=t[0]=this.a[0],n=cf(this.z0,e);for(let o=1;o<this.p;o++){let a=bt.constructorN(o);t[o]=uS(Ha(AN(i),cS(bt.Pow(n,o),a)),this.sum(o,n))}return t}compute(e,t){let i=t.length,n=bt.constructorN(0);if(e==0)n.re=i;else{for(let o=0;o<i;o++){let a=t[o],l=new bt(a.x,a.y);n=cf(n,bt.Pow(cf(l,this.z0),e))}n.divideBy(e)}return n}ApproximateForce(e){let t=new bt(e.x,e.y),i=cf(t,this.z0),n=cS(this.a[0],i),o=i,a=0;for(;n=cf(n,cS(CN(this.a[a],a),o)),a++,a!=this.p;)o=Ha(o,i);return new m(n.re,-n.im)}static Force(e,t){let i=t.sub(e),n=i.lengthSquared;return n<.1?n!=0?i.div(.1):new m(1,0):i.div(n)}},bt=class{constructor(e,t){this.re=e,this.im=t}static constructorN(e){return new bt(e,0)}divideBy(e){this.re/=e,this.im/=e}static Pow(e,t){switch(Ce.assert(t>=0),t){case 0:return bt.constructorN(1);case 1:return e;case 2:return Ha(e,e);case 3:return Ha(e,Ha(e,e));default:return Ha(bt.Pow(e,t/2),bt.Pow(e,t/2+t%2))}}};function uS(s,e){return new bt(s.re+e.re,s.im+e.im)}function Ha(s,e){return new bt(s.re*e.re-s.im*e.im,s.re*e.im+e.re*s.im)}function CN(s,e){return new bt(s.re*e,s.im*e)}function cf(s,e){return new bt(s.re-e.re,s.im-e.im)}function AN(s){return new bt(-s.re,-s.im)}function cS(s,e){let t=e.re*e.re+e.im*e.im;if(t==0)return bt.constructorN(0);let i=s.re*e.re+s.im*e.im,n=s.im*e.re-s.re*e.im;return new bt(i/t,n/t)}var eb=class{intersects(e){return e.med.Center.sub(this.med.Center).length<e.med.Radius+this.med.Radius}},hS=class extends eb{constructor(t,i,n){super();this.med=t,this.parent=i.parent,this.parent!=null&&(this.parent.leftChild==i?this.parent.leftChild=this:this.parent.rightChild=this),this.leftChild=i,this.rightChild=n,i.parent=this,n.parent=this}computeMultipoleCoefficients(t){this.leftChild.computeMultipoleCoefficients(t),this.rightChild.computeMultipoleCoefficients(t),this.multipoleCoefficients=Jr.constructorPMM(this.med.Center,this.leftChild.multipoleCoefficients,this.rightChild.multipoleCoefficients)}},Zc=class extends eb{constructor(t){super();this.particles=t,this.ComputeMinimumEnclosingDisc()}computeMultipoleCoefficients(t){this.multipoleCoefficients=Jr.constructorNPA(t,this.med.Center,this.ps)}ComputeMinimumEnclosingDisc(){let t=this.Size();this.ps=new Array(t);for(let i=0;i<t;i++)this.ps[i]=this.particles[0][i].point;return this.med=$m.LinearComputation(this.ps)}Min(t){return this.particles[t][0].pos(t)}Size(){return this.particles[0].length}Max(t){return this.particles[t][this.Size()-1].pos(t)}Dimension(t){return this.Max(t)-this.Min(t)}Split(t){let i=this.Dimension(0)>this.Dimension(1)?0:1,n=i==0?1:0,o=this.Size(),a=o>>1,l=o-a,u=[new Array(a),new Array(a)],c=[new Array(l),new Array(l)],h=0,d=0;for(let p=0;p<o;p++){let S=this.particles[i][p];p<a?(u[i][p]=S,S.splitLeft=!0):(c[i][p-a]=S,S.splitLeft=!1)}for(let p=0;p<o;p++){let S=this.particles[n][p];S.splitLeft?u[n][d++]=S:c[n][h++]=S}let f=this.med;return this.particles=u,this.ComputeMinimumEnclosingDisc(),t.rightSibling=new Zc(c),new hS(f,this,t.rightSibling)}ComputeForces(){for(let t of this.particles[0])for(let i of this.particles[0])t!=i&&(t.force=t.force.add(Jr.Force(t.point,i.point)))}},tb=class{pos(e){return e==0?this.point.x:this.point.y}constructor(e){this.point=e,this.force=new m(0,0)}},rb=class{particlesBy(e){return this.particles.map(t=>t).sort((t,i)=>t.pos(e)-i.pos(e))}constructor(e,t){this.particles=e;let i=new Array;i.push(this.particlesBy(0)),i.push(this.particlesBy(1)),this.leaves=new Array;let n=new Zc(i);this.leaves.push(n);let o={rightSibling:null};this.root=n.Split(o),this.leaves.push(o.rightSibling);let a=new dS(t);for(a.EnqueueLL(n,o.rightSibling);a.length>0;)n=a.dequeue(),n.Split(o),this.leaves.push(o.rightSibling),a.EnqueueLL(n,o.rightSibling)}ComputeForces(e){this.root.computeMultipoleCoefficients(e);for(let t of this.leaves){t.ComputeForces();let i=new Array;for(i.push(this.root);i.length>0;){let n=i.pop();if(t.intersects(n))if(n instanceof Zc)for(let o of t.particles[0])for(let a of n.particles[0])o!=a&&(o.force=o.force.add(Jr.Force(o.point,a.point)));else{let o=n;i.push(o.leftChild),i.push(o.rightChild)}else for(let o of t.particles[0])o.force=o.force.sub(n.multipoleCoefficients.ApproximateForce(o.point))}}}},dS=class extends xA.Queue{constructor(t){super();this.B=t}EnqueueLL(t,i){t.Size()>this.B&&this.enqueue(t),i.Size()>this.B&&this.enqueue(i)}};var Os=class extends Pe{constructor(t,i,n){super(null);this.clustersInfo=new Map;this.clusterEdges=new Array;if(this.graph=t,this.settings=i,this.initFiNodesEdges(),this.edges=Array.from(this.graph.shallowEdges).map(o=>$i.getAlgData(o.edge).data),this.nodes=Array.from(this.graph.shallowNodes).map(o=>$i.getAlgData(o.node).data),this.components=new Array,this.settings.InterComponentForces)this.components.push(this.nodes);else{this.basicGraph=Sr(this.edges,this.nodes.length);for(let o of Yn(this.basicGraph)){let a=new Array(o.length),l=0;for(let u of o)a[l++]=this.nodes[u];this.components.push(a)}}this.computeWeight(t),this.setCurrentConstraintLevel(n)}initFiNodesEdges(){let t=0;for(let i of this.graph.shallowNodes){let n=new Qm(t++,i);new $i(i.node,n)}for(let i of this.graph.shallowEdges){let n=new Jm(i);new $i(i.edge,n)}}getCurrentConstraintLevel(){return this.currentConstraintLevel}setCurrentConstraintLevel(t){this.currentConstraintLevel=t,this.settings.Unconverge()}ResetNodePositions(){for(let t of this.nodes)t.ResetBounds()}AddRepulsiveForce(t,i){t.force=i.mul(10*this.settings.RepulsiveForceConstant)}AddLogSpringForces(t,i,n){let o=i.length,a=7e-4*this.settings.AttractiveForceConstant*o*Math.log((o+.1)/(n+.1));t.sourceFiNode.force=t.sourceFiNode.force.add(i.mul(a)),t.targetFiNode.force=t.targetFiNode.force.sub(i.mul(a))}AddSquaredSpringForces(t,i,n){let o=i.length,a=n*n+.1,l=this.settings.AttractiveForceConstant*(o-n)/a;t.sourceFiNode.force=t.sourceFiNode.force.add(i.mul(l)),t.targetFiNode.force=t.targetFiNode.force.sub(i.mul(l))}AddSpringForces(t){let i;if(this.settings.RespectEdgePorts){let n=t.sourceFiNode.Center,o=t.targetFiNode.Center,a=t.mEdge.sourcePort;a instanceof or&&(n=a.Location);let l=t.mEdge.targetPort;l instanceof or&&(o=l.Location),i=n.sub(o)}else i=t.vector();this.settings.LogScaleEdgeForces?this.AddLogSpringForces(t,i,t.length):this.AddSquaredSpringForces(t,i,t.length)}static AddGravityForce(t,i,n){n!=null&&(n.force=n.force.sub(t.sub(n.Center).mul(i*1e-4)))}ComputeRepulsiveForces(t){let i=t.length;if(i>16&&this.settings.ApproximateRepulsion){let n=new Array(t.length),o=2*(Math.PI/i),a=0;for(let u=0;u<i;u++)n[u]=new tb(t[u].Center.add(new m(Math.cos(a),Math.sin(a)).mul(1e-5))),a+=o;new rb(n,8).ComputeForces(5);for(let u=0;u<t.length;u++)this.AddRepulsiveForce(t[u],n[u].force)}else for(let n of t){let o=new m(0,0);for(let a of t)n!=a&&(o=o.add(Jr.Force(n.Center,a.Center)));this.AddRepulsiveForce(n,o)}}SetBarycenter(t){let i=this.clustersInfo.get(t);if(i!=null)return i.barycenter;let n=new m(0,0);if(t.shallowNodeCount||TN(t)){let o=this.clustersInfo.get(t);if((o==null||o.weight==null)&&this.computeWeight(t),o.weight!=null){for(let a of t.shallowNodes)a instanceof lt?n=n.add(a.center):n=n.add(this.SetBarycenter(a).mul(this.clustersInfo.get(a).weight));this.clustersInfo.get(t).barycenter=n=n.div(o.weight)}}else this.clustersInfo.get(t).barycenter=n;return n}computeWeight(t){let i=0;for(let o of t.shallowNodes)o.entity instanceof Te?i+=this.computeWeight(o):i++;let n=this.clustersInfo.get(t);return n==null&&this.clustersInfo.set(t,n={barycenter:new m(0,0)}),n.weight=i,i}AddClusterForces(t){if(t!=null){this.SetBarycenter(t);for(let i of this.clusterEdges){let n=xe.getGeom(i.source),o=xe.getGeom(i.target),a=$i.getAlgData(i.source).data,l=$i.getAlgData(i.target).data,u=n.hasOwnProperty("shallowNodes"),c=u?this.clustersInfo.get(n).barycenter:n.center,h=o.hasOwnProperty("shallowNodes"),d=h?this.clustersInfo.get(o).barycenter:o.center,f=c.sub(d),p=f.length,S=1e-8*(this.settings.AttractiveInterClusterForceConstant*(p*Math.log(p+.1)));if(f=f.mul(S),u){let E=n;for(let C of E.shallowNodes){let O=$i.getAlgData(C.node).data;O.force=O.force.add(f)}}else a.force=a.force.add(f);if(h){let E=o;for(let C of E.shallowNodes){let O=$i.getAlgData(C.node).data;O.force=O.force.sub(f)}}else l.force=l.force.sub(f)}for(let i of t.subgraphsDepthFirst){let n=this.clustersInfo.get(i).barycenter;for(let o of i.shallowNodes)Os.AddGravityForce(n,this.settings.ClusterGravity,uf(o))}}}ComputeForces(){if(this.components!=null)for(let t of this.components)this.ComputeRepulsiveForces(t);else this.ComputeRepulsiveForces(this.nodes);this.edges.forEach(t=>this.AddSpringForces(t));for(let t of this.components){let i=new m(0,0);for(let o=0;o<t.length;o++)i=i.add(t[o].Center);i=i.div(t.length);let n=Number.NEGATIVE_INFINITY;for(let o=0;o<t.length;o++){let a=t[o];Os.AddGravityForce(i,this.settings.GravityConstant,a),a.force.length>n&&(n=a.force.length)}if(n>100)for(let o=0;o<t.length;o++)t[o].force=t[o].force.mul(100/n)}this.AddClusterForces(this.graph)}VerletIntegration(){let t=this.energy;this.energy=this.ComputeDescentDirection(1),this.UpdateStepSize(t);let i=0;for(let n=0;n<this.nodes.length;n++){let o=this.nodes[n];i+=o.Center.sub(o.previousCenter).lengthSquared}return i}ComputeDescentDirection(t){this.ResetForceVectors(),this.settings.ApplyForces&&this.ComputeForces();let i=0;for(let n of this.nodes){i=i+n.force.lengthSquared;let o=n.Center.sub(n.previousCenter).mul(this.settings.Friction),a=n.force.mul(-this.stepSize*t);n.previousCenter=n.Center,Ce.assert(!Number.isNaN(a.x),"!double.IsNaN(a.X)"),Ce.assert(!Number.isNaN(a.y),"!double.IsNaN(a.Y)"),Ce.assert(Number.isFinite(a.x),"!double.IsInfinity(a.X)"),Ce.assert(Number.isFinite(a.y),"!double.IsInfinity(a.Y)"),o=o.add(a),o=o.div(n.stayWeight),n.Center=n.Center.add(o)}return i}ResetForceVectors(){for(let t of this.nodes)t.force=new m(0,0)}UpdateStepSize(t){this.energy<t?++this.progress>=3&&(this.progress=0,this.stepSize/=this.settings.Decay):(this.progress=0,this.stepSize*=this.settings.Decay)}RungeKuttaIntegration(){let t=new Array(this.nodes.length),i=new Array(this.nodes.length),n=new Array(this.nodes.length),o=new Array(this.nodes.length),a=new Array(this.nodes.length),l=this.energy;for(let c=0;c<this.nodes.length;c++)this.nodes[c].previousCenter=this.nodes[c].Center,t[c]=this.nodes[c].Center;let u=3;this.ComputeDescentDirection(u);for(let c=0;c<this.nodes.length;c++)i[c]=this.nodes[c].Center.sub(this.nodes[c].previousCenter),this.nodes[c].Center=t[c].add(i[c].mul(.5));this.ComputeDescentDirection(u);for(let c=0;c<this.nodes.length;c++)n[c]=this.nodes[c].Center.sub(this.nodes[c].previousCenter),this.nodes[c].previousCenter=t[c],this.nodes[c].Center=t[c].add(n[c].mul(.5));this.ComputeDescentDirection(u);for(let c=0;c<this.nodes.length;c++)o[c]=this.nodes[c].Center.sub(this.nodes[c].previousCenter),this.nodes[c].previousCenter=t[c],this.nodes[c].Center=t[c].add(o[c]);this.energy=this.ComputeDescentDirection(u);for(let c=0;c<this.nodes.length;c++){a[c]=this.nodes[c].Center.sub(this.nodes[c].previousCenter),this.nodes[c].previousCenter=t[c];let h=i[c].add(n[c].mul(2).add(o[c].mul(2)).add(a[c])).div(6);this.nodes[c].Center=t[c].add(h)}return this.UpdateStepSize(l),this.nodes.reduce((c,h)=>h.Center.sub(h.previousCenter).lengthSquared+c,0)}run(){this.settings.Converged=!1,this.settings.EdgeRoutesUpToDate=!1,this.settings.Iterations++==0&&(this.stepSize=this.settings.InitialStepSize,this.energy=Number.MAX_VALUE,this.progress=0);for(let t=0;t<this.settings.MinorIterations;t++){if((this.settings.RungeKuttaIntegration?this.RungeKuttaIntegration():this.VerletIntegration())<this.settings.DisplacementThreshold||this.settings.Iterations>this.settings.MaxIterations){this.settings.Converged=!0;break}this.ProgressStep()}}};function TN(s){for(let e of s.Clusters)return!0;return!1}var Dr=class{constructor(){this.commonSettings=new Qn;this.maxIterations=100;this.clusterMargin=10;this.minorIterations=3;this.projectionIterations=5;this.approximateRepulsion=!0;this.RungeKuttaIntegration=!1;this.initialStepSize=1.4;this.decay=.9;this.friction=.8;this.repulsiveForceConstant=1;this.attractiveForceConstant=1;this.gravity=1;this.interComponentForces=!0;this.applyForces=!0;this.AvoidOverlaps=!0;this.approximateRouting=!0;this.logScaleEdgeForces=!0;this.displacementThreshold=.1;this.maxConstraintLevel=2;this.minConstraintLevel=0;this.attractiveInterClusterForceConstant=1;this.clusterGravity=1;this.commonSettings.NodeSeparation*=2}get edgeRoutingSettings(){return this.commonSettings.edgeRoutingSettings}set edgeRoutingSettings(e){this.commonSettings.edgeRoutingSettings=e}get PackingAspectRatio(){return this.commonSettings.PackingAspectRatio}set PackingAspectRatio(e){this.commonSettings.PackingAspectRatio=e}get NodeSeparation(){return this.commonSettings.NodeSeparation}set NodeSeparation(e){this.commonSettings.NodeSeparation=e}get MaxIterations(){return this.maxIterations}set MaxIterations(e){this.maxIterations=e}get MinorIterations(){return this.minorIterations}set MinorIterations(e){this.minorIterations=e}get Iterations(){return this.iterations}set Iterations(e){this.iterations=e}get ProjectionIterations(){return this.projectionIterations}set ProjectionIterations(e){this.projectionIterations=e}get ApproximateRepulsion(){return this.approximateRepulsion}set ApproximateRepulsion(e){this.approximateRepulsion=e}get InitialStepSize(){return this.initialStepSize}set InitialStepSize(e){if(e<=0||e>2)throw new Error("ForceScalar should be greater than 0 and less than 2 (if we let you set it to 0 nothing would happen, greater than 2 would most likely be very unstable!)");this.initialStepSize=e}get Decay(){return this.decay}set Decay(e){if(e<.1||e>1)throw new Error("Setting decay too small gives no progress.  1==no decay, 0.1==minimum allowed value");this.decay=e}get Friction(){return this.friction}set Friction(e){if(e<0||e>1)throw new Error("Setting friction less than 0 or greater than 1 would just be strange.  1==no friction, 0==no conservation of velocity");this.friction=e}get RepulsiveForceConstant(){return this.repulsiveForceConstant}set RepulsiveForceConstant(e){this.repulsiveForceConstant=e}get AttractiveForceConstant(){return this.attractiveForceConstant}set AttractiveForceConstant(e){this.attractiveForceConstant=e}get GravityConstant(){return this.gravity}set GravityConstant(e){this.gravity=e}get InterComponentForces(){return this.interComponentForces}set InterComponentForces(e){this.interComponentForces=e}get ApplyForces(){return this.applyForces}set ApplyForces(e){this.applyForces=e}ResetLayout(){this.Unconverge(),this.algorithm!=null&&this.algorithm.ResetNodePositions()}Unconverge(){this.iterations=0,this.converged=!1}InitializeLayoutGN(e,t){this.InitializeLayout(e,t)}InitializeLayout(e,t){this.algorithm=new Os(e,this,t),this.ResetLayout()}Uninitialize(){this.algorithm=null}get IsInitialized(){return this.algorithm!=null}IncrementalRunG(e){this.IncrementalRunGF(e)}SetupIncrementalRun(e){this.IsInitialized?this.IsDone&&this.ResetLayout():this.InitializeLayout(e,this.MaxConstraintLevel)}IncrementalRunGF(e){this.SetupIncrementalRun(e),this.algorithm.run()}IncrementalRun(e,t){e!=null&&e.throwIfCanceled(),this.SetupIncrementalRun(t),this.algorithm.cancelToken=e,this.algorithm.run()}Clone(){return Dr.ctorClone(this)}get ApproximateRouting(){return this.approximateRouting}set ApproximateRouting(e){this.approximateRouting=e}get LogScaleEdgeForces(){return this.logScaleEdgeForces}set LogScaleEdgeForces(e){this.logScaleEdgeForces=e}get DisplacementThreshold(){return this.displacementThreshold}set DisplacementThreshold(e){this.displacementThreshold=e}get Converged(){return this.converged}set Converged(e){this.converged=e}get PercentDone(){return this.Converged?100:100*this.iterations/this.MaxIterations}get IsDone(){return this.Converged||this.iterations>=this.MaxIterations}get Energy(){return this.algorithm!=null?this.algorithm.energy:0}get MaxConstraintLevel(){return this.maxConstraintLevel}set MaxConstraintLevel(e){this.maxConstraintLevel!=e&&(this.maxConstraintLevel=e,this.IsInitialized&&this.Uninitialize())}get MinConstraintLevel(){return this.minConstraintLevel}set MinConstraintLevel(e){this.minConstraintLevel=e}getCurrentConstraintLevel(){return this.algorithm==null?0:this.algorithm.getCurrentConstraintLevel()}setCurrentConstraintLevel(e){this.algorithm.setCurrentConstraintLevel(e)}get AttractiveInterClusterForceConstant(){return this.attractiveInterClusterForceConstant}set AttractiveInterClusterForceConstant(e){this.attractiveInterClusterForceConstant=e}static ctorClone(e){let t=new Dr;return t.maxIterations=e.maxIterations,t.minorIterations=e.minorIterations,t.projectionIterations=e.projectionIterations,t.approximateRepulsion=e.approximateRepulsion,t.initialStepSize=e.initialStepSize,t.RungeKuttaIntegration=e.RungeKuttaIntegration,t.decay=e.decay,t.friction=e.friction,t.repulsiveForceConstant=e.repulsiveForceConstant,t.attractiveForceConstant=e.attractiveForceConstant,t.gravity=e.gravity,t.interComponentForces=e.interComponentForces,t.applyForces=e.applyForces,t.AvoidOverlaps=e.AvoidOverlaps,t.RespectEdgePorts=e.RespectEdgePorts,t.RouteEdges=e.RouteEdges,t.approximateRouting=e.approximateRouting,t.logScaleEdgeForces=e.logScaleEdgeForces,t.displacementThreshold=e.displacementThreshold,t.minConstraintLevel=e.minConstraintLevel,t.maxConstraintLevel=e.maxConstraintLevel,t.attractiveInterClusterForceConstant=e.attractiveInterClusterForceConstant,t.clusterGravity=e.clusterGravity,t.PackingAspectRatio=e.PackingAspectRatio,t.NodeSeparation=e.NodeSeparation,t.clusterMargin=e.clusterMargin,t}get ClusterGravity(){return this.clusterGravity}set ClusterGravity(e){this.clusterGravity=e}static CreateFastIncrementalLayoutSettings(){let e=new Dr;return e.ApplyForces=!1,e.ApproximateRepulsion=!0,e.ApproximateRouting=!0,e.AttractiveForceConstant=1,e.AttractiveInterClusterForceConstant=1,e.AvoidOverlaps=!0,e.ClusterGravity=1,e.Decay=.9,e.DisplacementThreshold=5e-8,e.Friction=.8,e.GravityConstant=1,e.InitialStepSize=2,e.InterComponentForces=!1,e.Iterations=0,e.LogScaleEdgeForces=!1,e.MaxConstraintLevel=2,e.MaxIterations=20,e.MinConstraintLevel=0,e.MinorIterations=1,e.ProjectionIterations=5,e.RepulsiveForceConstant=2,e.RespectEdgePorts=!1,e.RouteEdges=!1,e.RungeKuttaIntegration=!0,e.NodeSeparation=20,e}};var ib=class{constructor(e){this.topNodes=e}get nodesBreadthFirst(){return this.nodesBreadthFirst_()}*nodesBreadthFirst_(){for(let e of this.topNodes)if(yield lt.getGeom(e),e instanceof Te)for(let t of e.nodesBreadthFirst)yield lt.getGeom(t)}get Clusters(){return this.clusters()}*clusters(){for(let e of this.topNodes)e instanceof Te&&(yield be.getGeom(e))}get subgraphsDepthFirst(){return this.subgraphsDepthFirst_()}*subgraphsDepthFirst_(){for(let e of this.topNodes)if(e instanceof Te){let t=be.getGeom(e);yield*t.subgraphsDepthFirst,yield t}}get shallowEdges(){return this.edges_()}*edges_(){for(let e of this.topNodes){for(let t of e.outEdges)yield Ye.getGeom(t);for(let t of e.selfEdges)yield Ye.getGeom(t)}}get shallowNodes(){return this.shallowNodes_()}*shallowNodes_(){for(let e of this.topNodes)yield lt.getGeom(e)}pumpTheBoxToTheGraphWithMargins(){let e={b:X.mkEmpty()};return rm(this,e),this.boundingBox=e.b}get shallowNodeCount(){return this.topNodes.length}translate(e){this.boundingBox&&(this.boundingBox.center=this.boundingBox.center.add(e));for(let t of this.topNodes)lt.getGeom(t).translate(e)}};var hf=class{static LinearInterpolation(e,t,i,n,o){if(e<t)return n;if(e>i)return o;let a=(e-t)/(i-t);return n+a*(o-n)}static NegativeLinearInterpolation(e,t,i,n,o){if(e<t)return o;if(e>i)return n;let a=(e-t)/(i-t);return n+(1-a)*(o-n)}};var nb=class extends Pe{constructor(t,i){super(null);this.SingleComponent=!1;this.graph=t,this.settings=Dr.ctorClone(i),this.settings.ApplyForces=!0,this.settings.InterComponentForces=!0,this.settings.RungeKuttaIntegration=!1,this.settings.RespectEdgePorts=!1}run(){if(this.SingleComponent)this.componentCount=1,this.LayoutComponent(this.graph);else{let t=Array.from(this.graph.graph.getClusteredConnectedComponents()).map(i=>new ib(i));this.componentCount=t.length;for(let i of t)this.LayoutComponent(i);this.graph.boundingBox=Ls.PackGraphs(t,this.settings.commonSettings)}}LayoutComponent(t){if(t.shallowNodeCount>1){if(this.settings.MaxIterations=hf.NegativeLinearInterpolation(t.shallowNodeCount,50,500,5,10),this.settings.MinorIterations=hf.NegativeLinearInterpolation(t.shallowNodeCount,50,500,3,20),this.settings.MinConstraintLevel==0){let n=new Qi;n.removeOverlaps=!1,n.IterationsWithMajorization=0,new nu(t,null,()=>1,new Qi).run()}let i=new Os(t,this.settings,this.settings.MinConstraintLevel);for(let n of this.GetConstraintLevels(t)){if(n>this.settings.MaxConstraintLevel)break;n>this.settings.MinConstraintLevel&&i.setCurrentConstraintLevel(n);do i.run();while(!this.settings.IsDone)}this.settings.AvoidOverlaps&&Qr.RemoveOverlaps(Array.from(this.graph.shallowNodes),this.settings.NodeSeparation)}t.pumpTheBoxToTheGraphWithMargins(),t.uniformMargins=this.settings.NodeSeparation,t.translate(t.boundingBox.leftBottom.mul(-1))}GetConstraintLevels(t){let i=new Set;return i.add(0),this.settings.AvoidOverlaps&&t.shallowNodeCount<2e3&&i.add(2),i}};function vA(s){s.layoutSettings||(s.layoutSettings=CA(s))}function IN(s){let e=s.parent;for(;e;){if(e.layoutSettings)return e.layoutSettings;e=e.parent}return null}function CA(s){let e=IN(s);if(e)return e;if(s.graph.shallowNodeCount>2e3||s.graph.deepEdgesCount>4e3)return new Dr;let i=!1;for(let n of s.deepEdges)if(n.sourceArrowhead!=null||n.targetArrowhead!=null){i=!0;break}return i?new Bt:new Dr}function wN(s,e,t=()=>1){if(vA(s),s.layoutSettings instanceof Bt)new Jc(s,s.layoutSettings,e).run();else if(s.layoutSettings instanceof Qi)new nu(s,e,t,s.layoutSettings).run();else if(s.layoutSettings instanceof Dr){let i=new nb(s,s.layoutSettings);i.SingleComponent=!0,i.run()}else throw new Error("not implemented")}function ob(s,e=null){vA(s),af(s,e,wN,ou,tm),_N(s)}function fS(s){do{if(s.layoutSettings&&s.layoutSettings.commonSettings.edgeRoutingSettings)return s.layoutSettings.commonSettings.edgeRoutingSettings;let t=s.graph.parent;if(t)s=xe.getGeom(t);else break}while(!0);let e=new Ho;return e.EdgeRoutingMode=0,e}function ou(s,e,t){let i=fS(s);i.EdgeRoutingMode===4?AA(s,e,t):i.EdgeRoutingMode===0||i.EdgeRoutingMode===1?IA(s,e,t):i.EdgeRoutingMode===2?Km(s,e,t):i.EdgeRoutingMode!==6&&new ke(s,e).run(),TA(s,e)}function af(s,e,t,i,n,o=1,a=()=>1){if(s.graph.isEmpty())return;let l=s.shallowNodes.next();s.parent==null&&(Ea(o),ON(s));let u=p();f(s);let c=LN(s.graph),h=RN(s);if(S(),c.forEach(E=>{E[0].edge.remove(),E[1].add()}),h.forEach(E=>{for(let C of E.graph.shallowNodes)C.parent=s.graph}),u.forEach(E=>E.add()),s.graph.parent==null){let E=d(s);i(s,E,e),TA(s,E),s.pumpTheBoxToTheGraphWithMargins()}function d(E){let C=[];for(let O of E.nodesBreadthFirst){for(let B of O.outEdges())B.curve==null&&C.push(B);for(let B of O.selfEdges())B.curve==null&&C.push(B)}return C}function f(E){for(let C of E.shallowNodes)C instanceof be&&af(C,e,t,i,n)}function p(){let E=new Set,C=s.graph;if(C.parent==null)return E;for(let O of C.shallowNodes){for(let B of O.outEdges){let A=C.liftNode(B.target);(A==null||A===O)&&E.add(B)}for(let B of O.inEdges){let A=C.liftNode(B.source);(A==null||A===O)&&E.add(B)}}for(let O of E)O.remove();return E}function S(){if(h.length===1)t(s,e,a);else{for(let E of h)t(E,e,a),E.boundingBox=E.pumpTheBoxToTheGraphWithMargins();n(s,h)}}}function LN(s){let e=new Array;for(let t of s.nodesBreadthFirst){let i=s.liftNode(t);if(i!=null)for(let n of t.outEdges.values()){let o=n.target,a=s.liftNode(o);if(a==null||i===t&&a===o||i===a)continue;n.remove();let l=new hi(i,a),u=new Ye(l);e.push([u,n])}}return e}function RN(s){var o;let e=s.graph,t=SC(e),i=[],n=0;for(let a of t){let l=new Te(e.id+n++);l.parent=e;let u=new be(l);u.layoutSettings=(o=s.layoutSettings)!=null?o:CA(s);for(let c of a)c.parent=l,l.addNode(c);i.push(u)}return i}function AA(s,e,t,i=1,n=3,o=3){let a=Ga.constructorGNAN(s,e,i,n);a.edgeSeparatian=o,a.run()}function TA(s,e){if(e.length===0)return;Ji.constructorGA(s,e).run()}function ON(s){for(let e of s.deepEdges)e.label&&(e.label.isPositioned=!1)}function Qc(s){if(be.getGeom(s)==null)return!1;for(let e of s.shallowNodes){let t=xe.getGeom(e);if(t==null||t.boundaryCurve==null||e instanceof Te&&Qc(e)===!1)return!1}for(let e of s.edges)if(Ye.getGeom(e)==null)return!1;return!0}function _N(s){let e=s.boundingBox.leftBottom;if(e.x<0||e.y<0){let t=new m(-e.x,-e.y);s.translate(t)}}var $c=class{static constructorStatic(e,t){let i=new $c;i.edges=e,i.nodeBoundaries=t,i.boundingBox=X.mkEmpty();for(let n of i.nodeBoundaries)i.boundingBox=i.boundingBox.addRec(n.boundingBox);return i}AddGraph(e){this.edges=this.edges.concat(e.edges),this.nodeBoundaries=Vn(this.nodeBoundaries,e.nodeBoundaries),this.boundingBox.addRec(e.boundingBox)}AddNodeBoundary(e){this.nodeBoundaries.add(e),this.boundingBox.addRec(e.boundingBox)}};var wA=Ae(yn(),1);var ja=class{get CurrentPiercedEdge(){return this.currentPiercedEdge}get CurrentTriangle(){return this.currentTriangle}constructor(e,t,i){this.currentTriangle=e,this.start=t,this.end=i}FindFirstPiercedEdge(){let e=this.GetHyperplaneSign(this.currentTriangle.Sites.item0),t=this.GetHyperplaneSign(this.currentTriangle.Sites.item1);if(e!==t&&m.getTriangleOrientation(this.end,this.currentTriangle.Sites.item0.point,this.currentTriangle.Sites.item1.point)==0)return this.positiveSign=e,this.negativeSign=t,this.currentTriangle.Edges.item0;let i=this.GetHyperplaneSign(this.currentTriangle.Sites.item2);return t!==i&&m.getTriangleOrientation(this.end,this.currentTriangle.Sites.item1.point,this.currentTriangle.Sites.item2.point)==0?(this.positiveSign=t,this.negativeSign=i,this.currentTriangle.Edges.item1):(this.positiveSign=i,this.negativeSign=e,this.currentTriangle.Edges.item2)}FindNextPierced(){if(this.currentTriangle=this.currentPiercedEdge.GetOtherTriangle_T(this.currentTriangle),this.currentTriangle==null){this.currentPiercedEdge=null;return}let e=this.currentTriangle.Edges.index(this.currentPiercedEdge),t,i=this.currentTriangle.Sites.getItem(e+2),n=this.GetHyperplaneSign(i);this.negativeSign===0?n===-1||n===0?(this.negativeSign=n,t=e+1):t=e+2:this.positiveSign===0?n===1||n===0?(this.positiveSign=n,t=e+2):t=e+1:n!==this.positiveSign?(this.negativeSign=n,t=e+1):(this.positiveSign=n,t=e+2),this.currentPiercedEdge=m.signedDoubledTriangleArea(this.end,this.currentTriangle.Sites.getItem(t).point,this.currentTriangle.Sites.getItem(t+1).point)<-R.distanceEpsilon?this.currentTriangle.Edges.getItem(t):null}GetHyperplaneSign(e){let t=m.signedDoubledTriangleArea(this.start,e.point,this.end);return t>R.distanceEpsilon?1:t<-R.distanceEpsilon?-1:0}MoveNext(){return this.currentPiercedEdge==null?this.currentPiercedEdge=this.FindFirstPiercedEdge():this.FindNextPierced(),this.currentPiercedEdge!=null}};var eh=class{constructor(e,t){this.ComputeForcesForBundles=!1;this.metroGraphData=e,this.bundlingSettings=t}EdgeIsLegal_(e,t,i,n){if(qe.PointIsInsideOfTriangle(t,i))return!0;let o=new ja(i,e,t);for(;o.MoveNext();){let a=o.CurrentPiercedEdge;if(a.constrained){let l=a.lowerSite.Owner;if(!n.has(l))return!1}}return!0}BundleAvoidsObstacles(e,t,i,n,o,a){a.closestDist=new Array;let l=this.metroGraphData.looseIntersections.ObstaclesToIgnoreForBundle(e,t),u=this.FindCloseObstaclesForBundle(t.cdtTriangle,n,i,l,o);if(u==null)return!1;for(let c of u){let h=c[1];a.closestDist.push(h)}return!0}FindCloseObstaclesForBundle(e,t,i,n,o){let a=new Map,l=[];if(!this.ThreadLineSegmentThroughTriangles(e,t,i,n,l))return null;if(!this.ComputeForcesForBundles&&!this.bundlingSettings.HighestQuality)return a;let u=new Rs;for(let c of l)for(let h of c.Sites){if(u.has(h))continue;u.add(h);let d=h.Owner;if(n.has(d))continue;let f=eh.FindPolylinePoint(d,h.point),p=k.minDistBetweenLineSegments(f.point,f.nextOnPolyline.point,t,i),S=p.dist,E=p.parab,C=p.parcd,O=k.minDistBetweenLineSegments(f.point,f.prevOnPolyline.point,t,i),B=O.dist,A=O.parab,N=O.parcd,z,Y,ie;if(S<B){if(ie=S,ie>o)continue;z=f.point.add(f.nextOnPolyline.point.sub(f.point).mul(E)),Y=t.add(i.sub(t).mul(C))}else{if(ie=B,ie>o)continue;z=f.point.add(f.prevOnPolyline.point.sub(f.point).mul(A)),Y=t.add(i.sub(t).mul(N))}a.get(d)||a.set(d,[z,Y])}return a}ThreadLineSegmentThroughTriangles(e,t,i,n,o){if(qe.PointIsInsideOfTriangle(i,e))return o.push(e),!0;let a=new ja(e,t,i);for(o.push(e);a.MoveNext();){o.push(a.CurrentTriangle);let l=a.CurrentPiercedEdge;if(l.constrained){let u=l.lowerSite.Owner;if(!n.has(u))return!1}}return a.CurrentTriangle!=null&&o.push(a.CurrentTriangle),!0}static PointLocationInsideTriangle(e,t){let i=!1;for(let n=0;n<3;n++){let o=m.signedDoubledTriangleArea(e,t.Sites.getItem(n).point,t.Sites.getItem(n+1).point);if(o<R.distanceEpsilon*-1)return 0;o<R.distanceEpsilon&&(i=!0)}return i?1:2}static FindPolylinePoint(e,t){for(let i of e.polylinePoints())if(i.point.equal(t))return i;throw new Error("polyline point "+t+" not found")}EdgeIsLegal(e,t,i,n){let o=[],a=this.metroGraphData.looseIntersections.ObstaclesToIgnoreForBundle(e,t);return this.ThreadLineSegmentThroughTriangles(e.cdtTriangle,i,n,a,o)}EdgeIsLegalSSPPS(e,t,i){let n=e.Position,o=e.cdtTriangle,a=t.Position;if(qe.PointIsInsideOfTriangle(a,o))return!0;let l=new ja(o,n,a);for(;l.MoveNext();){let u=l.CurrentPiercedEdge;if(u.constrained){let c=u.lowerSite.Owner;if(!i.has(c))return!1}}return!0}};var $r=class{constructor(e,t,i,n){this.metroGraphData=e,this.obstaclesToIgnoreLambda=n,this.bundlingSettings=t,this.obstacleTree=i}ObstaclesToIgnoreForBundle(e,t){return e!=null&&t!=null?Vn(this.obstaclesToIgnoreLambda(e),this.obstaclesToIgnoreLambda(t)):e==null&&t==null?new Set:e!=null?this.obstaclesToIgnoreLambda(e):this.obstaclesToIgnoreLambda(t)}HubAvoidsObstaclesSPNBA(e,t,i,n){let o={minimalDistance:i};return $r.IntersectCircleWithTree(this.obstacleTree,t,i,this.obstaclesToIgnoreLambda(e),n.touchedObstacles,o)}HubAvoidsObstaclesPNS__(e,t,i){let n={touchedObstacles:Array()},o={minimalDistance:0};return this.HubAvoidsObstaclesPNSTT(e,t,i,n,o)}GetMinimalDistanceToObstacles(e,t,i){let n=new Array,o={minimalDistance:i};return $r.IntersectCircleWithTree(this.obstacleTree,t,i,this.obstaclesToIgnoreLambda(e),n,o)?o.minimalDistance:0}HubAvoidsObstaclesPNSTT(e,t,i,n,o){return n.touchedObstacles=new Array,o.minimalDistance=t,$r.IntersectCircleWithTree(this.obstacleTree,e,t,i,n.touchedObstacles,o)}static IntersectCircleWithTree(e,t,i,n,o,a){if(!e.irect.contains_point_radius(t,i))return!0;if(e.UserData==null){let l=$r.IntersectCircleWithTree(e.Left,t,i,n,o,a);if(!l||(l=$r.IntersectCircleWithTree(e.Right,t,i,n,o,a),!l))return!1}else{let l=e.UserData;if(n.has(l))return!0;if(I.PointRelativeToCurveLocation(t,l)!==0)return $r.containingPoly=l,!1;let c=l.value(l.closestParameter(t)),h=c.sub(t).length;h<=i&&o.push([l,c]),a.minimalDistance=Math.min(h,a.minimalDistance)}return!0}static Create4gon(e,t,i,n){let o=t.sub(e).normalize();return o=new m(o.y,o.x*-1),ne.mkFromPoints([e.add(o.mul(i/2)),e.sub(o.mul(i/2)),t.sub(o.mul(n/2)),t.add(o.mul(n/2))])}};var sb=class{constructor(e,t,i,n){this.Width=t,this.Polyline=e,this.sourceAndTargetLoosePolylines=i,this.Index=n}UpdateLengths(){let e=0;for(let t=this.Polyline.startPoint;t.next!=null;t=t.next)e+=t.next.point.sub(t.point).length;this.Length=e,this.IdealLength=this.Polyline.end.sub(this.Polyline.start).length}};var ab=class{constructor(e,t,i){this.metroline=e,this.station=t,this.polyPoint=i}get Metroline(){return this.metroline}get PolyPoint(){return this.polyPoint}};var lb=class{constructor(e,t,i){this.Radius=0;this.BundleBases=new Map;this.MetroNodeInfos=new Array;this._cachedIdealRadius=0;this.SerialNumber=e,this.IsReal=t,this.Position=i}debStop(){return this.SerialNumber===28&&this.Position.sub(new m(841.2662778763244,303.3817005853006)).length<.001}get Position(){return this._Position}set Position(e){this._Position=e}getELP(){return this.EnterableLoosePolylines}setELP(e){this.EnterableLoosePolylines=e}addEL(e){this.EnterableLoosePolylines.add(e)}get cachedIdealRadius(){return this._cachedIdealRadius}set cachedIdealRadius(e){this._cachedIdealRadius=e}AddEnterableLoosePolyline(e){this.EnterableLoosePolylines==null&&(this.EnterableLoosePolylines=new Set),this.EnterableLoosePolylines.add(e)}AddEnterableTightPolyline(e){this.EnterableTightPolylines==null&&(this.EnterableTightPolylines=new Set),this.EnterableTightPolylines.add(e)}};var ub=class{constructor(){this.Width=0;this.Metrolines=new Array;this.cachedBundleCost=0}get Count(){return this.Metrolines.length}};var Dt=class{constructor(e,t){this.metroGraphData=e,this.bundlingSettings=t}CreateNodeRadii(){for(let e of this.metroGraphData.VirtualStations())e.Radius=0,e.cachedIdealRadius=Dt.CalculateIdealHubRadiusWithNeighborsMBS(this.metroGraphData,this.bundlingSettings,e);this.GrowHubs(!1),this.GrowHubs(!0);for(let e of this.metroGraphData.VirtualStations())e.Radius=Math.max(e.Radius,this.bundlingSettings.MinHubRadius)}GrowHubs(e){let t=new Er(_e);for(let n of this.metroGraphData.VirtualStations())t.Enqueue(n,-this.CalculatePotential(n,e));let i=!1;for(;!t.IsEmpty();){let n={priority:0},o=t.DequeueAndGetPriority(n);if(n.priority>=0)break;this.TryGrowHub(o,e)&&(t.Enqueue(o,-this.CalculatePotential(o,e)),i=!0)}return i}TryGrowHub(e,t){let i=this.CalculateAllowedHubRadius(e);if(e.Radius>=i)return!1;let n=t?Dt.CalculateIdealHubRadiusWithAdjacentEdges(this.bundlingSettings,e):e.cachedIdealRadius;if(e.Radius>=n)return!1;let a=.05*(n-e.Radius);a<1&&(a=1);let l=Math.min(e.Radius+a,i);return l<=e.Radius?!1:(e.Radius=l,!0)}CalculatePotential(e,t){let i=t?Dt.CalculateIdealHubRadiusWithAdjacentEdges(this.bundlingSettings,e):e.cachedIdealRadius;return i<=e.Radius?0:(i-e.Radius)/i}CalculateAllowedHubRadius(e){let t=this.bundlingSettings.MaxHubRadius;for(let n of e.Neighbors){let o=n.Position.sub(e.Position).length;t=Math.min(t,o/1.05-n.Radius)}let i=this.metroGraphData.tightIntersections.GetMinimalDistanceToObstacles(e,e.Position,t);return i<t&&(t=i-.001),Math.max(t,.1)}static CalculateIdealHubRadius(e,t,i){let n=1;for(let o of i.Neighbors){let l=e.GetWidthSSN(o,i,t.EdgeSeparation)/2+t.EdgeSeparation;n=Math.max(n,l)}return n=Math.min(n,2*t.MaxHubRadius),n}static CalculateIdealHubRadiusWithNeighborsMBS(e,t,i){return Dt.CalculateIdealHubRadiusWithNeighborsMBNP(e,t,i,i.Position)}static CalculateIdealHubRadiusWithNeighborsMBNP(e,t,i,n){let o=Dt.CalculateIdealHubRadius(e,t,i);if(i.Neighbors.length>1){let a=i.Neighbors;for(let l=0;l<a.length;l++){let u=a[l],c=a[(l+1)%a.length];o=Math.max(o,Dt.GetMinRadiusForTwoAdjacentBundles(o,i,n,u,c,e,t))}}return o=Math.min(o,2*t.MaxHubRadius),o}static CalculateIdealHubRadiusWithAdjacentEdges(e,t){let i=e.MaxHubRadius;for(let n of t.Neighbors)i=Math.min(i,t.Position.sub(n.Position).length/2);return i}static GetMinRadiusForTwoAdjacentBundles(e,t,i,n,o,a,l){let u=a.GetWidthSSN(t,n,l.EdgeSeparation),c=a.GetWidthSSN(t,o,l.EdgeSeparation);return Dt.GetMinRadiusForTwoAdjacentBundlesNPPPNNB(e,i,n.Position,o.Position,u,c,l)}static GetMinRadiusForTwoAdjacentBundlesNPPPNNB(e,t,i,n,o,a,l){if(o<R.distanceEpsilon||a<R.distanceEpsilon)return e;let u=m.anglePCP(i,t,n);if(u=Math.min(u,Math.PI*2-u),u<R.distanceEpsilon)return 2*l.MaxHubRadius;if(u>=Math.PI/2)return e*1.05;let c=Math.sin(u),h=Math.cos(u),d=o/(4*c),f=a/(4*c),p=2*Math.sqrt(d*d+(f*f+2*(d*(f*h))));return p=Math.min(p,2*l.MaxHubRadius),p=Math.max(p,e),p}};var qa=class{constructor(e,t,i,n){this.metroGraphData=e,this.bundlingSettings=t,this.costCalculator=i,this.cdt=n}InitializeCostCache(){for(let e of this.metroGraphData.VirtualStations())e.cachedIdealRadius=Dt.CalculateIdealHubRadiusWithNeighborsMBS(this.metroGraphData,this.bundlingSettings,e),e.cachedRadiusCost=this.costCalculator.RadiusCost(e,e.Position),e.cachedBundleCost=0;for(let e of this.metroGraphData.VirtualEdges()){let t=e[0],i=e[1],n=this.metroGraphData.GetIjInfo(t,i);n.cachedBundleCost=this.costCalculator.BundleCost(t,i,t.Position),t.cachedBundleCost+=n.cachedBundleCost,i.cachedBundleCost+=n.cachedBundleCost}}UpdateCostCache(e){let t=this.cdt.getRectangleNodeOnTriangles();e.cdtTriangle=t.FirstHitNodeWithPredicate(e.Position,qa.testPointInside).UserData,e.cachedIdealRadius=Dt.CalculateIdealHubRadiusWithNeighborsMBS(this.metroGraphData,this.bundlingSettings,e),e.cachedRadiusCost=this.costCalculator.RadiusCost(e,e.Position),e.cachedBundleCost=0;for(let i of e.Neighbors){i.IsReal||(i.cachedIdealRadius=Dt.CalculateIdealHubRadiusWithNeighborsMBS(this.metroGraphData,this.bundlingSettings,i),i.cachedRadiusCost=this.costCalculator.RadiusCost(i,i.Position));let n=this.metroGraphData.GetIjInfo(e,i);i.cachedBundleCost-=n.cachedBundleCost,n.cachedBundleCost=this.costCalculator.BundleCost(e,i,e.Position),e.cachedBundleCost+=n.cachedBundleCost,i.cachedBundleCost+=n.cachedBundleCost}}static testPointInside(e,t){return qe.PointIsInsideOfTriangle(e,t)?1:0}};var th=class{constructor(){this.mainMap=new Map}get isEmpty(){return this.mainMap.size===0||this.everyMapIsEmpty()}everyMapIsEmpty(){for(let e of this.mainMap.values())if(e.size)return!1;return!0}get(e,t){let i=this.mainMap.get(e);if(i)return i.get(t)}has(e,t){let i=this.mainMap.get(e);return i?i.has(t):!1}set(e,t,i){let n=this.mainMap.get(e);n||(n=new Map,this.mainMap.set(e,n)),n.set(t,i)}*[Symbol.iterator](){for(let[e,t]of this.mainMap)for(let[i,n]of t)yield[e,i,n]}*keys(){for(let[e,t]of this.mainMap)for(let[i]of t)yield[e,i]}};var cb=class{constructor(e,t,i,n,o,a,l,u){this.cachedEnterableLooseForEnd=new Nt;this.bundlingSettings=n,this.regularEdges=e,o!=null?this.cdt=o:this.cdt=Xm(t),this.EdgeLooseEnterable=a,this.EdgeTightEnterable=l,this.LoosePolylineOfPort=u,this.looseIntersections=new $r(this,n,t,c=>c.getELP()),this.tightIntersections=new $r(this,n,i,c=>c.EnterableTightPolylines),this.cdtIntersections=new eh(this,n),this.Initialize(!1)}get Ink(){return this.ink}get Edges(){return this.regularEdges}VirtualStations(){return Array.from(this.Stations).filter(e=>!e.IsReal)}get Metrolines(){return this.metrolines}get LooseTree(){return this.looseIntersections.obstacleTree}get TightTree(){return this.tightIntersections.obstacleTree}*VirtualEdges(){for(let e of this.edgeInfoDictionary.keys())yield e}RealEdgeCount(e,t){let i=e.SerialNumber<t.SerialNumber?[e,t]:[t,e],n=this.edgeInfoDictionary.get(i[0],i[1]);return n?n.Count:0}MetroNodeInfosOfNode(e){return e.MetroNodeInfos}GetIjInfo(e,t){let i=e.SerialNumber<t.SerialNumber?[e,t]:[t,e];return this.edgeInfoDictionary.get(i[0],i[1])}MoveNode(e,t){let i=e.Position;this.PointToStations.deleteP(i),this.PointToStations.set(t,e),e.Position=t;for(let n of this.MetroNodeInfosOfNode(e))n.PolyPoint.point=t;for(let n of this.MetroNodeInfosOfNode(e)){let o=n.Metroline,a=n.PolyPoint.prev.point,l=n.PolyPoint.next.point;o.Length+=l.sub(t).length+a.sub(t).length-l.sub(i).length-a.sub(i).length}for(let n of e.Neighbors)this.ink+=t.sub(n.Position).length-i.sub(n.Position).length;this.SortNeighbors(e);for(let n of e.Neighbors)this.SortNeighbors(n)}GetWidthSSN(e,t,i){let n=e.SerialNumber<t.SerialNumber?[e,t]:[t,e],o=this.edgeInfoDictionary.get(n[0],n[1]);return o?o.Width+(o.Count-1)*i:0}GetWidthAN(e,t){let i=0;for(let o of e)i+=o.Width;let n=e.length;return i+=n>0?(n-1)*t:0,i}Initialize(e){this.SimplifyRegularEdges(),this.InitializeStationData(),this.InitializeEdgeData(),this.InitializeVirtualGraph(),this.InitializeEdgeNodeInfo(e),this.InitializeCdtInfo()}SimplifyRegularEdges(){for(let e of this.regularEdges)this.SimplifyRegularEdge(e)}SimplifyRegularEdge(e){let t=e.curve,i=new wA.Stack,n=new He;for(let o=t.endPoint;o!=null;o=o.prev){let a=o.point;if(n.has(o.point)){let l=o.next;do{let u=i.top;if(!u.equal(a))n.delete(u),i.pop(),l=l.next;else break}while(!0);l.prev=o.prev,l.prev.next=l}else i.push(a),n.add(a)}}InitializeStationData(){this.Stations=[],this.PointToStations=new Nt;for(let e of this.regularEdges){let t=e.curve;this.ProcessPolylinePoints(t)}}ProcessPolylinePoints(e){let t=e.startPoint;for(this.RegisterStation(t,!0),t=t.next;t!==e.endPoint;t=t.next)this.RegisterStation(t,!1);this.RegisterStation(t,!0)}RegisterStation(e,t){if(!this.PointToStations.has(e.point)){let i=new lb(this.Stations.length,t,e.point);this.PointToStations.set(e.point,i),this.Stations.push(i)}}InitializeEdgeData(){this.metrolines=new Array;for(let e=0;e<this.regularEdges.length;e++){let t=this.regularEdges[e];this.InitEdgeData(t,e)}}InitEdgeData(e,t){let i=new sb(e.curve,this.bundlingSettings.ActualEdgeWidth(e),this.EdgeSourceAndTargetFunc(e),t);this.metrolines.push(i),this.PointToStations.get(i.Polyline.start).BoundaryCurve=e.sourcePort.Curve,this.PointToStations.get(i.Polyline.end).BoundaryCurve=e.targetPort.Curve}EdgeSourceAndTargetFunc(e){return()=>[this.LoosePolylineOfPort(e.sourcePort),this.LoosePolylineOfPort(e.targetPort)]}InitializeVirtualGraph(){let e=new Map;for(let t of this.metrolines){let i=this.PointToStations.get(t.Polyline.start),n;for(let o=t.Polyline.startPoint;o.next!=null;o=o.next,i=n)n=this.PointToStations.get(o.next.point),Ul(e,i,n),Ul(e,n,i)}for(let t of this.Stations)t.Neighbors=Array.from(e.get(t))}GetUnorderedIjInfo(e,t){return e.SerialNumber<t.SerialNumber?this.GetCreateOrderedIjInfo(e,t):this.GetCreateOrderedIjInfo(t,e)}static closedeb(e,t){return e.Position.sub(new m(360.561,428.416)).length<.1&&t.Position.sub(new m(414.281,440.732)).length<.1}GetCreateOrderedIjInfo(e,t){let i=this.edgeInfoDictionary.get(e,t);return i||(i=new ub,this.edgeInfoDictionary.set(e,t,i),i)}InitializeEdgeNodeInfo(e){this.edgeInfoDictionary=new th,this.InitAllMetroNodeInfos(e),this.SortAllNeighbors(),this.InitEdgeIjInfos(),this.ink=0;for(let t of this.VirtualEdges())this.ink+=t[0].Position.sub(t[1].Position).length}InitAllMetroNodeInfos(e){for(let t=0;t<this.metrolines.length;t++){let i=this.metrolines[t];this.InitMetroNodeInfos(i),this.InitNodeEnterableLoosePolylines(i,this.regularEdges[t]),e&&this.InitNodeEnterableTightPolylines(i,this.regularEdges[t]),i.UpdateLengths()}}InitMetroNodeInfos(e){for(let t=e.Polyline.startPoint;t!=null;t=t.next){let i=this.PointToStations.get(t.point);i.MetroNodeInfos.push(new ab(e,i,t))}}InitNodeEnterableLoosePolylines(e,t){let i=this.EdgeLooseEnterable!=null?this.EdgeLooseEnterable.get(t):new Set;for(let n=e.Polyline.startPoint.next;n!=null&&n.next!=null;n=n.next){let o=this.PointToStations.get(n.point);o.getELP()!=null?o.setELP(Un(o.getELP(),i)):o.setELP(new Set(i))}this.AddLooseEnterableForMetrolineStartEndPoints(e)}AddLooseEnterableForMetrolineStartEndPoints(e){this.AddLooseEnterableForEnd(e.Polyline.start),this.AddLooseEnterableForEnd(e.Polyline.end)}AddTightEnterableForMetrolineStartEndPoints(e){this.AddTightEnterableForEnd(e.Polyline.start),this.AddTightEnterableForEnd(e.Polyline.end)}AddLooseEnterableForEnd(e){let t=this.PointToStations.get(e);if(this.cachedEnterableLooseForEnd.has(e))t.setELP(this.cachedEnterableLooseForEnd.get(e));else{for(let i of this.LooseTree.AllHitItems_(e))I.PointRelativeToCurveLocation(e,i)===2&&t.AddEnterableLoosePolyline(i);this.cachedEnterableLooseForEnd.set(e,t.getELP())}}AddTightEnterableForEnd(e){let t=this.PointToStations.get(e);for(let i of this.TightTree.AllHitItems_(e))I.PointRelativeToCurveLocation(e,i)===2&&t.AddEnterableTightPolyline(i)}InitNodeEnterableTightPolylines(e,t){let i=this.EdgeTightEnterable!=null?this.EdgeTightEnterable.get(t):new Set;for(let n=e.Polyline.startPoint.next;n!=null&&n.next!=null;n=n.next){let o=this.PointToStations.get(n.point),a=o.EnterableTightPolylines;a!=null?o.EnterableTightPolylines=Un(a,i):o.EnterableTightPolylines=new Set(i)}this.AddTightEnterableForMetrolineStartEndPoints(e)}SortAllNeighbors(){for(let e of this.Stations)this.SortNeighbors(e)}SortNeighbors(e){if(e.Neighbors.length<=2)return;let t=e.Neighbors[0].Position,i=e.Position;e.Neighbors.sort((n,o)=>qo(t.sub(i),n.Position.sub(i),o.Position.sub(i)))}InitEdgeIjInfos(){for(let e of this.metrolines){let t=e.Polyline,i=this.PointToStations.get(t.start),n;for(let o=e.Polyline.startPoint;o.next!=null;o=o.next,i=n){n=this.PointToStations.get(o.next.point);let a=this.GetUnorderedIjInfo(i,n);a.Width+=e.Width,a.Metrolines.push(e)}}}InitializeCdtInfo(){let e=this.cdt.getRectangleNodeOnTriangles();for(let t of this.Stations)t.cdtTriangle=e.FirstHitNodeWithPredicate(t.Position,qa.testPointInside).UserData}PointIsAcceptableForEdge(e,t){if(this.LoosePolylineOfPort==null)return!0;let i=e.sourceAndTargetLoosePolylines();return I.PointRelativeToCurveLocation(t,i[0])===0&&I.PointRelativeToCurveLocation(t,i[1])===0}};function qo(s,e,t){let i=m.crossProduct(s,t),n=s.dot(t),o=m.crossProduct(s,e),a=s.dot(e);return ue(o,0)&&df(a,0)?ue(i,0)&&df(n,0)?0:1:ue(i,0)&&df(n,0)?-1:ue(o,0)||ue(i,0)||o*i>0?wd(m.crossProduct(t,e),0):-wd(Math.sign(o),0)}function df(s,e){return wd(s,e)>=0}var RA=Ae(yn(),1);var Xo=class{constructor(e,t){this.metroGraphData=e,this.bundlingSettings=t}static InkError(e,t,i){return(e-t)*i.InkImportance}static PathLengthsError(e,t,i,n){return(e-t)*(n.PathLengthImportance/i)}static RError(e,t,i){return e<=t?0:i.HubRepulsionImportance*((1-t/e)*(e-t))}static BundleError(e,t,i){return e<=t?0:i.BundleRepulsionImportance*((1-t/e)*(e-t))}static Cost(e,t){let i=t.InkImportance*e.Ink;for(let n of e.Metrolines)i+=t.PathLengthImportance*n.Length/n.IdealLength;return i+=this.CostOfForces(e),i}static CostOfForces(e){let t=0;for(let i of e.VirtualStations())t=t+i.cachedRadiusCost;for(let i of e.VirtualEdges()){let n=i[0],o=i[1];t+=e.GetIjInfo(n,o).cachedBundleCost}return t}InkGain(e,t){let i=this.metroGraphData.Ink,n=this.metroGraphData.Ink;for(let o of e.Neighbors){let a=o.Position;n-=a.sub(e.Position).length,n+=a.sub(t).length}return Xo.InkError(i,n,this.bundlingSettings)}PathLengthsGain(e,t){let i=0;for(let n of this.metroGraphData.MetroNodeInfosOfNode(e)){let o=n.Metroline.Length,a=n.PolyPoint.prev.point,l=n.PolyPoint.next.point,u=n.Metroline.Length+l.sub(t).length+a.sub(t).length-l.sub(e.Position).length-a.sub(e.Position).length;i+=Xo.PathLengthsError(o,u,n.Metroline.IdealLength,this.bundlingSettings)}return i}RadiusGain(e,t){let i=0;return i=i+e.cachedRadiusCost,i=i-this.RadiusCost(e,t),i}RadiusCost(e,t){let i;m.closeDistEps(e.Position,t)?i=e.cachedIdealRadius:i=Dt.CalculateIdealHubRadiusWithNeighborsMBNP(this.metroGraphData,this.bundlingSettings,e,t);let n={touchedObstacles:[]};if(!this.metroGraphData.looseIntersections.HubAvoidsObstaclesSPNBA(e,t,i,n))return Xo.Inf;let o=0;for(let a of n.touchedObstacles){let l=a[1].sub(t).length;o+=Xo.RError(i,l,this.bundlingSettings)}return o}BundleGain(e,t){let i=e.cachedBundleCost;for(let n of e.Neighbors){let o=this.BundleCost(e,n,t);if(df(o,Xo.Inf))return-Xo.Inf;i-=o}return i}BundleCost(e,t,i){let n=this.metroGraphData.GetWidthSSN(e,t,this.bundlingSettings.EdgeSeparation),o={closestDist:[]};if(!this.metroGraphData.cdtIntersections.BundleAvoidsObstacles(e,t,i,t.Position,n,o))return Xo.Inf;let a=0;for(let l of o.closestDist){let u=l[0].sub(l[1]).length;a+=Xo.BundleError(n/2,u,this.bundlingSettings)}return a}},wr=Xo;wr.Inf=1e9;var LA=Ae(zn(),1);var hb=class{constructor(e){this.polylineToEdgeGeom=new Map;this.pathsThroughPoints=new Nt;this.interestingPoints=new He;this.metroGraphData=e}get Polylines(){return Array.from(this.polylineToEdgeGeom.keys())}Run(){this.Init(),this.SwitchFlips()}Init(){for(let e of this.metroGraphData.Edges)this.polylineToEdgeGeom.set(e.curve,e);for(let e of this.Polylines)this.RegisterPolylinePointInPathsThrough(e.polylinePoints())}RegisterPolylinePointInPathsThrough(e){for(let t of e)this.RegisterPolylinePointInPathsThroughP(t)}RegisterPolylinePointInPathsThroughP(e){NN(this.pathsThroughPoints,e.point,e)}UnregisterPolylinePointsInPathsThrough(e){for(let t of e)this.UnregisterPolylinePointInPathsThrough(t)}UnregisterPolylinePointInPathsThrough(e){MN(this.pathsThroughPoints,e.point,e)}SwitchFlips(){let e=new Set(this.Polylines),t=new LA.Queue;for(let i of this.Polylines)t.enqueue(i);for(;t.length>0;){let i=t.dequeue();e.delete(i);let n=this.ProcessPolyline(i);n!=null&&(e.has(i)||(e.add(i),t.enqueue(i)),e.has(n)||(e.add(n),t.enqueue(n)))}}ProcessPolyline(e){let t=new Map;for(let i=e.startPoint.next;i!=null;i=i.next){this.FillDepartedPolylinePoints(i,t);for(let n of this.pathsThroughPoints.get(i.point)){let o=t.get(n.polyline);if(o){if(this.ProcessFlip(i,o))return n.polyline;t.delete(n.polyline)}}}return null}FillDepartedPolylinePoints(e,t){let i=e.prev.point;for(let n of this.pathsThroughPoints.get(i))this.IsNeighborOnTheSamePolyline(n,e)||t.has(n.polyline)||t.set(n.polyline,n)}ProcessFlip(e,t){let i=e.polyline,n=t.polyline,o=e.point,a=t.point,l=this.polylineToEdgeGeom.get(i),u=this.polylineToEdgeGeom.get(n);if(l.lineWidth!==u.lineWidth||this.metroGraphData.EdgeLooseEnterable==null||!Vl(this.metroGraphData.EdgeLooseEnterable.get(l),this.metroGraphData.EdgeLooseEnterable.get(u)))return!1;let c=this.FindPointsOnPolyline(i,o,a),h=c[0],d=c[1],f=c[2];c=this.FindPointsOnPolyline(n,o,a);let p=c[0],S=c[1],E=c[2],C=this.FindRelationOnFirstPoint(h,p,f,E),O=this.FindRelationOnLastPoint(d,S,f,E);return C!==2&&O!==2||C===1||O===1?!1:(this.UnregisterPolylinePointsInPathsThrough(i.polylinePoints()),this.UnregisterPolylinePointsInPathsThrough(n.polylinePoints()),this.Swap(h,p,d,S,f,E),this.RegisterPolylinePointInPathsThrough(i.polylinePoints()),this.RegisterPolylinePointInPathsThrough(n.polylinePoints()),this.RegisterInterestingPoint(h.point),this.RegisterInterestingPoint(d.point),this.numberOfReducedCrossings++,!0)}FindPointsOnPolyline(e,t,i){let n,o;for(let a=e.startPoint;a!=null;a=a.next)if(n==null)if(a.point.equal(t)){if(o!=null)return[a,o,!1];n=a}else o==null&&a.point.equal(i)&&(o=a);else if(a.point.equal(i))return[n,a,!0]}PolylinePointsAreInForwardOrder(e,t){for(let i=e;i!=null;i=i.next)if(i===t)return!0;return!1}Next(e,t){return t?e.next:e.prev}Prev(e,t){return t?e.prev:e.next}FindRelationOnFirstPoint(e,t,i,n){let o=e,a=t;for(;;){let l=this.Prev(e,i),u=this.Prev(t,n);if(l==null||u==null)return 0;if(!l.point.equal(u.point))break;e=l,t=u}return this.PolylinesIntersect(o,a,e,t,i,n)}FindRelationOnLastPoint(e,t,i,n){let o=e,a=t;for(;;){let l=this.Next(e,i),u=this.Next(t,n);if(l==null||u==null)return 0;if(!l.point.equal(u.point))break;e=l,t=u}for(;this.Next(e,i).point.equal(this.Prev(t,n).point);)e=this.Next(e,i),t=this.Prev(t,n);return this.PolylinesIntersect(e,t,o,a,i,n)}PolylinesIntersect(e,t,i,n,o,a){let l=this.Prev(e,o),u=this.Next(e,o),c=this.Next(i,o),h=this.Prev(i,o),d=this.Next(t,a),f=this.Prev(n,a);if(e.point.equal(i.point)){let p=e.point,S=qo(h.point.sub(p),f.point.sub(p),u.point.sub(p)),E=qo(h.point.sub(p),d.point.sub(p),u.point.sub(p));return S===E?1:2}else{let p=qo(l.point.sub(e.point),u.point.sub(e.point),d.point.sub(e.point)),S=qo(c.point.sub(i.point),f.point.sub(i.point),h.point.sub(i.point));return p===S?1:2}}Swap(e,t,i,n,o,a){let l=this.GetRangeOnPolyline(this.Next(e,o),i,o),u=this.GetRangeOnPolyline(this.Next(t,a),n,a);this.ChangePolylineSegment(e,i,o,u),this.ChangePolylineSegment(t,n,a,l),_s.RemoveSelfCyclesFromPolyline(e.polyline),_s.RemoveSelfCyclesFromPolyline(t.polyline)}ChangePolylineSegment(e,t,i,n){let o=e;for(let a of n){let l=Kt.mkFromPoint(a.point);l.polyline=o.polyline,i?(l.prev=o,o.next=l):(l.next=o,o.prev=l),o=l}i?(o.next=t,t.prev=o):(o.prev=t,t.next=o)}GetRangeOnPolyline(e,t,i){let n=new Array;for(let o=e;o!==t;o=this.Next(o,i))n.push(o);return n}IsNeighborOnTheSamePolyline(e,t){return e.prev!=null&&e.prev.point.equal(t.point)||e.next!=null&&e.next.point.equal(t.point)}RegisterInterestingPoint(e){this.interestingPoints.has(e)||this.interestingPoints.add(e)}GetChangedHubs(){return this.interestingPoints}NumberOfReducedCrossings(){return this.numberOfReducedCrossings}PolylineIsOK(e){let t=new He;for(let i=e.startPoint;i!=null;i=i.next){if(i===e.startPoint){if(i.prev!=null)return!1}else if(i.prev.next!==i)return!1;if(i===e.endPoint){if(i.next!=null)return!1}else if(i.next.prev!==i)return!1;if(t.has(i.point))return!1;t.add(i.point)}return!(e.startPoint.prev!=null||e.endPoint.next!=null)}};function NN(s,e,t){let i=s.get(e);i||(i=new Set,s.set(e,i)),i.add(t)}function MN(s,e,t){let i=s.get(e);!i||(i.delete(t),i.size===0&&s.deleteP(e))}var _s=class{constructor(e,t){this.foundCrossings=new He;this.crossingsThatShouldBecomeHubs=new He;this.metroGraphData=e,this.polylineAcceptsPoint=t}*Vertices(){for(let e of this.Polylines)for(let t of e.polylinePoints())yield t}get Polylines(){return this.metroGraphData.Edges.map(e=>e.curve)}Edges(){let e=new Zn;for(let t of this.Vertices())t.next&&e.set(new xt(t.point,t.next.point),0);return Array.from(e.keys())}run(){if(this.metroGraphData.Edges.length===0)return!1;let e=new Zn,t=new Lo(null);for(let l of this.Vertices()){let u=X.mkOnPoints([l.point]);u.pad(R.intersectionEpsilon),t.Add(u,l.point)}let i=ms(this.Edges(),l=>X.mkPP(l.first,l.second));Vt(i,i,(l,u)=>this.IntersectTwoEdges.bind(l,u,e,t)),this.SortInsertedPoints(e);let n=this.InsertPointsIntoPolylines(e),o=this.FixPaths(),a=this.RemoveUnimportantCrossings();return o||n||a}FixPaths(){let e=!1;return this.RemoveSelfCycles()&&(e=!0),this.ReduceEdgeCrossings()&&(e=!0),e}SortInsertedPoints(e){for(let t of e)this.SortInsideSegment(t[0],t[1])}SortInsideSegment(e,t){t.sort((i,n)=>_e(ze(i,e.first),ze(n,e.first)))}InsertPointsIntoPolylines(e){let t=!1;for(let i of this.metroGraphData.Metrolines)return this.InsertPointsIntoPolyline(i,e)&&(t=!0),t}InsertPointsIntoPolyline(e,t){let i=!1;for(let n=e.Polyline.startPoint;n.next!=null;n=n.next)this.InsertPointsOnPolypoint(n,t,e)&&(i=!0);return i}InsertPointsOnPolypoint(e,t,i){let n=new xt(e.point,e.next.point),o=e.point!==n.first,a=t.get(n);if(!a)return!1;let l=e.next,u=e.polyline;if(o)for(let c=a.length-1;c>=0;c--){if(this.polylineAcceptsPoint!=null&&!this.polylineAcceptsPoint(i,a[c]))continue;let h=Kt.mkFromPoint(a[c]);h.prev=e,h.polyline=u,e.next=h,e=h}else for(let c=0;c<a.length;c++){if(this.polylineAcceptsPoint!=null&&!this.polylineAcceptsPoint(i,a[c]))continue;let h=Kt.mkFromPoint(a[c]);h.prev=e,h.polyline=u,e.next=h,e=h}return e.next=l,l.prev=e,!0}RemoveSelfCycles(){let e=!1;for(let t of this.Polylines)_s.RemoveSelfCyclesFromPolyline(t)&&(e=!0);return e}static RemoveSelfCyclesFromPolyline(e){let t=!1,i=new Nt;for(let n=e.startPoint;n!=null;n=n.next){let o=n.point,a=i.get(o);if(a){for(let l=a.next;l!==n.next;l=l.next)i.deleteP(l.point);a.next=n.next,n.next.prev=a,t=!0}else i.set(n.point,n)}return t}ReduceEdgeCrossings(){let e=new hb(this.metroGraphData);e.Run();for(let t of e.GetChangedHubs())this.crossingsThatShouldBecomeHubs.add(t);return e.NumberOfReducedCrossings()>0}RemoveUnimportantCrossings(){let e=!1;this.pointsToDelete=bC(this.foundCrossings,this.crossingsThatShouldBecomeHubs);for(let t of this.Polylines)this.RemoveUnimportantCrossingsFromPolyline(t)&&(e=!0);return e}RemoveUnimportantCrossingsFromPolyline(e){let t=!1;for(let i=e.startPoint.next;i!=null&&i.next!=null;i=i.next)if(this.pointsToDelete.has(i.point)&&m.getTriangleOrientation(i.prev.point,i.point,i.next.point)===2){let n=i.prev,o=i.next;n.next=o,o.prev=n,i=n,t=!0}return t}IntersectTwoEdges(e,t,i,n){let o=k.IntersectPPPP(e.first,e.second,t.first,t.second);if(o){let a=this.FindExistingVertexOrCreateNew(n,o);(this.AddVertexToSplittingList(e,i,a)||this.AddVertexToSplittingList(t,i,a))&&this.foundCrossings.add(a)}}FindExistingVertexOrCreateNew(e,t){let i=e.RootNode.FirstHitNode(t);if(i!=null)return i.UserData;let n=X.mkOnPoints([t]);return n.pad(R.intersectionEpsilon),e.Add(n,t),t}AddVertexToSplittingList(e,t,i){if(!I.closeIntersectionPoints(i,e.first)&&!I.closeIntersectionPoints(i,e.second)){let n=t.get(e);if(n||(n=new Array,t.set(e,n)),!n.find(o=>o.equal(i)))return n.push(i),!0}return!1}};var ff=class{isCorrectlyOrienected(){return m.getTriangleOrientation(this.Curve.boundingBox.center,this.Curve.value(this.parEnd),this.Curve.value(this.parStart))!==1}get Count(){return this.points.length}constructor(e,t,i,n){this.BelongsToRealNode=n,this.Curve=t,this.Position=i,this.points=new Array(e),this.tangents=new Array(e),this.OrientedHubSegments=new Array(e)}get CurveCenter(){return this.Curve.boundingBox.center}get OppositeBase(){return this.OutgoingBundleInfo!=null?this.OutgoingBundleInfo.TargetBase:this.IncomingBundleInfo.SourceBase}get length(){return this.points.length}get Points(){return this.points}get Tangents(){return this.tangents}get InitialMidParameter(){return this.initialMidParameter}set InitialMidParameter(e){this.initialMidParameter=e,this.InitialMidPoint=this.Curve.value(e)}get ParStart(){return this.parStart}set ParStart(e){this.parStart=e,this.StartPoint=this.Curve.value(this.parStart)}get ParEnd(){return this.parEnd}set ParEnd(e){this.parEnd=e,this.EndPoint=this.Curve.value(this.parEnd)}get ParMid(){return(this.parStart+this.parEnd)/2}get MidPoint(){return m.middle(this.StartPoint,this.EndPoint)}get Span(){return this.SpanBetweenTwoParameters(this.parStart,this.parEnd)}SpanBetweenTwoParameters(e,t){return e<=t?t-e:t-e+Pn(this.Curve)}RotateLeftPoint(e,t){return e===0?this.EndPoint:this.RotatePoint(e,this.parEnd,t)}RotateRigthPoint(e,t){return e===0?this.StartPoint:this.RotatePoint(e,this.parStart,t)}RotatePoint(e,t,i){let n=Pn(this.Curve)*i;return t+=e*n,t=this.AdjustParam(t),this.Curve.value(t)}AdjustParam(e){return e>this.Curve.parEnd?e=this.Curve.parStart+(e-this.Curve.parEnd):e<this.Curve.parStart&&(e=this.Curve.parEnd-(this.Curve.parStart-e)),e}RotateBy(e,t,i){let n=Pn(this.Curve)*i;e!==0&&(this.ParStart=this.AdjustParam(this.ParStart+e*n)),t!==0&&(this.ParEnd=this.AdjustParam(this.ParEnd+t*n))}RelativeOrderOfBasesIsPreserved(e,t,i){let n=Pn(this.Curve)*i,o=this.parStart+e*n,a=this.parStart<this.parEnd?this.parEnd+t*n:this.parEnd+Pn(this.Curve)+t*n;if(o>a||this.SpanBetweenTwoParameters(o,a)>Pn(this.Curve)/2)return!1;if(this.Prev==null||this.SpanBetweenTwoParameters(this.Prev.ParMid,this.ParMid)>n&&this.SpanBetweenTwoParameters(this.ParMid,this.Next.ParMid)>n)return!0;let l=this.RotateLeftPoint(t,i),u=this.RotateRigthPoint(e,i),c=m.middle(l,u),h=this.MidPoint;return!(m.getTriangleOrientation(this.CurveCenter,this.Prev.MidPoint,h)!=m.getTriangleOrientation(this.CurveCenter,this.Prev.MidPoint,c)||m.getTriangleOrientation(this.CurveCenter,this.Next.MidPoint,h)!=m.getTriangleOrientation(this.CurveCenter,this.Next.MidPoint,c))}};var uu=class{constructor(e,t,i,n){this.SourceBase=e,this.TargetBase=t,this.obstaclesToIgnore=i,this.HalfWidthArray=n,this.TotalRequiredWidth=this.HalfWidthArray.reduce((a,l)=>a+l,0)*2,this.longEnoughSideLength=e.Curve.boundingBox.addRec(t.Curve.boundingBox).diagonal;let o=Math.max(e.Curve.boundingBox.diagonal,t.Curve.boundingBox.diagonal);if(this.TotalRequiredWidth>o){let a=this.TotalRequiredWidth/o;for(let l=0;l<this.HalfWidthArray.length;l++)this.HalfWidthArray[l]/=a;this.TotalRequiredWidth/=a}}SetParamsFeasiblySymmetrically(e){this.CalculateTightObstaclesForBundle(e,this.obstaclesToIgnore),this.SetEndParamsSymmetrically()}CalculateTightObstaclesForBundle(e,t){let i=this.SourceBase.Curve.boundingBox.diagonal/2,n=this.TargetBase.Curve.boundingBox.diagonal/2,o=$r.Create4gon(this.SourceBase.Position,this.TargetBase.Position,i*2,n*2);this.tightObstaclesInTheBoundingBox=Array.from(e.AllHitItems(o.boundingBox,a=>!t.has(a)&&I.ClosedCurveInteriorsIntersect(o,a)))}SetEndParamsSymmetrically(){let e=this.TargetBase.Position,t=this.SourceBase.Position,i=e.sub(t).normalize(),n=i.rotate90Ccw(),o=m.middle(e,t),a=i.mul(this.longEnoughSideLength),l=o.add(a),u=o.sub(a);if(this.SetRLParamsIfWidthIsFeasible(n.mul(this.TotalRequiredWidth/2),l,u)){this.SetInitialMidParams();return}let c=this.TotalRequiredWidth,h=0,d=c/2;for(;c-h>uu.FeasibleWidthEpsilon;)this.SetRLParamsIfWidthIsFeasible(n.mul(d/2),l,u)?h=d:c=d,d=.5*(c+h);d<=uu.FeasibleWidthEpsilon&&(this.SetRLParamsIfWidthIsFeasible_(n.mul(uu.FeasibleWidthEpsilon),new m(0,0),l,u)||this.SetRLParamsIfWidthIsFeasible_(new m(0,0),n.mul(-uu.FeasibleWidthEpsilon),l,u))&&(d=2*uu.FeasibleWidthEpsilon),this.SourceBase.InitialMidParameter=this.SourceBase.AdjustParam(this.SourceBase.ParStart+this.SourceBase.Span/2),this.TargetBase.InitialMidParameter=this.TargetBase.AdjustParam(this.TargetBase.ParStart+this.TargetBase.Span/2)}mkNameFromLRST(){return"./tmp/leftRight"+this.SourceBase.Position.toString()+"_"+this.TargetBase.Position.toString()+".svg"}SetRLParamsIfWidthIsFeasible(e,t,i){return this.SetRLParamsIfWidthIsFeasible_(e,e.neg(),t,i)}SetRLParamsIfWidthIsFeasible_(e,t,i,n){let o={par:0},a={par:0},l={par:0},u={par:0},c=this.TrimSegWithBoundaryCurves(k.mkPP(i.add(e),n.add(e)),a,l);return c==null||this.tightObstaclesInTheBoundingBox.find(d=>I.intersectionOne(c,d,!1)!=null)||(c=this.TrimSegWithBoundaryCurves(k.mkPP(i.add(t),n.add(t)),u,o),c==null)||this.tightObstaclesInTheBoundingBox.find(d=>I.intersectionOne(c,d,!1)!=null)?!1:(this.SourceBase.IsParent?(this.SourceBase.ParStart=a.par,this.SourceBase.ParEnd=u.par):(this.SourceBase.ParStart=u.par,this.SourceBase.ParEnd=a.par),this.TargetBase.IsParent?(this.TargetBase.ParStart=o.par,this.TargetBase.ParEnd=l.par):(this.TargetBase.ParStart=l.par,this.TargetBase.ParEnd=o.par),!0)}SetInitialMidParams(){let e={par:0},t={par:0};this.TrimSegWithBoundaryCurves(k.mkPP(this.TargetBase.CurveCenter,this.TargetBase.CurveCenter),t,e)!=null?(this.SourceBase.InitialMidParameter=t.par,this.TargetBase.InitialMidParameter=e.par):(this.SourceBase.InitialMidParameter=this.SourceBase.AdjustParam(this.SourceBase.ParStart+this.SourceBase.Span/2),this.TargetBase.InitialMidParameter=this.TargetBase.AdjustParam(this.TargetBase.ParStart+this.TargetBase.Span/2))}mkNameFromST(){return"./tmp/mparam"+this.SourceBase.Position.toString()+"_"+this.TargetBase.Position.toString()+".svg"}TrimSegWithBoundaryCurves(e,t,i){let n=I.getAllIntersections(e,this.SourceBase.Curve,!0);if(n.length===0)return i.par=0,t.par=0,null;let o;if(n.length===1?o=n[0]:this.SourceBase.IsParent?o=n[0].par0<n[1].par0?n[1]:n[0]:o=n[0].par0<n[1].par0?n[0]:n[1],n=I.getAllIntersections(e,this.TargetBase.Curve,!0),n.length===0)return i.par=0,t.par=0,null;let a;return n.length===1?a=n[0]:this.TargetBase.IsParent?a=n[0].par0>n[1].par0?n[1]:n[0]:a=n[0].par0>n[1].par0?n[0]:n[1],t.par=o.par1,i.par=a.par1,k.mkPP(o.x,a.x)}RotateBy(e,t,i,n,o){let a=e!==0||t!==0,l=i!==0||n!==0;a&&this.SourceBase.RotateBy(e,t,o),l&&this.TargetBase.RotateBy(i,n,o),this.UpdateSourceAndTargetBases(a,l)}UpdateSourceAndTargetBases(e,t){e&&this.UpdatePointsOnBundleBase(this.SourceBase),t&&this.UpdatePointsOnBundleBase(this.TargetBase),this.UpdateTangentsOnBases()}UpdateTangentsOnBases(){let e=this.TargetBase.length;for(let t=0;t<e;t++){let i=this.TargetBase.Points[t].sub(this.SourceBase.Points[e-1-t]),n=i.length;n>=R.tolerance&&(i=i.div(n),this.TargetBase.Tangents[t]=i,this.SourceBase.Tangents[e-1-t]=i.neg())}}UpdatePointsOnBundleBase(e){let t=e.length,i=e.Points,n=k.mkPP(e.EndPoint,e.StartPoint),o=1/this.TotalRequiredWidth,a=this.HalfWidthArray[0];i[0]=n.value(a*o);for(let l=1;l<t;l++)a+=this.HalfWidthArray[l-1]+this.HalfWidthArray[l],i[l]=n.value(a*o)}RotationIsLegal(e,t,i,n,o){if(!this.SourceBase.IsParent&&!this.TargetBase.IsParent){if(t!==0||i!==0){let a=this.SourceBase.RotateLeftPoint(t,o),l=this.TargetBase.RotateRigthPoint(i,o);if(!this.LineIsLegal(a,l))return!1}if(e!==0||n!==0){let a=this.SourceBase.RotateRigthPoint(e,o),l=this.TargetBase.RotateLeftPoint(n,o);if(!this.LineIsLegal(a,l))return!1}}else{if(t!==0||n!==0){let a=this.SourceBase.RotateLeftPoint(t,o),l=this.TargetBase.RotateLeftPoint(n,o);if(!this.LineIsLegal(a,l))return!1}if(e!==0||i!==0){let a=this.SourceBase.RotateRigthPoint(e,o),l=this.TargetBase.RotateRigthPoint(i,o);if(!this.LineIsLegal(a,l))return!1}}return!((e!==0||t!==0)&&!this.SourceBase.RelativeOrderOfBasesIsPreserved(e,t,o)||(i!==0||n!==0)&&!this.TargetBase.RelativeOrderOfBasesIsPreserved(i,n,o))}LineIsLegal(e,t){return this.tightObstaclesInTheBoundingBox.find(i=>I.intersectionOne(k.mkPP(e,t),i,!1)!=null)==null}},gf=uu;gf.FeasibleWidthEpsilon=.1;var pf=class{get Segment(){return this.segment}set Segment(e){this.segment=e}constructor(e,t,i,n){this.Segment=e,this.Reversed=t,this.Index=i,this.BundleBase=n}value(e){return this.Reversed?this.Segment.value(this.Segment.parEnd-e):this.Segment.value(e)}};var Qe=class{constructor(e,t,i){this.fixedBundles=new Rs;this.stepsWithProgress=0;this.metroOrdering=e,this.metroGraphData=t,this.bundlingSettings=i}Run(){this.AllocateBundleBases(),this.SetBasesRightLeftParamsToTheMiddles(),this.bundlingSettings.KeepOverlaps?(this.UpdateSourceAndTargetBases(),this.CreateOrientedSegs()):(this.SetRightLeftParamsFeasiblySymmetrically(),this.AdjustStartEndParamsToAvoidBaseOverlaps(),this.UpdateSourceAndTargetBases(),this.CreateOrientedSegs(),this.bundlingSettings.RotateBundles&&this.RotateBundlesToDiminishCost(),this.AdjustStartEndParamsToAvoidBaseOverlaps(),this.UpdateSourceAndTargetBases())}AllocateBundleBases(){this.externalBases=new Map,this.internalBases=new Map,this.Bundles=new Array;for(let e of this.metroGraphData.Stations)e.BoundaryCurve==null&&(e.BoundaryCurve=pe.mkCircle(e.Radius,e.Position));for(let e of this.metroGraphData.Stations)for(let t of e.Neighbors)if(e.SerialNumber<t.SerialNumber){let i=new ff(this.metroGraphData.RealEdgeCount(e,t),e.BoundaryCurve,e.Position,e.IsReal);e.BundleBases.set(t,i);let n=new ff(this.metroGraphData.RealEdgeCount(e,t),t.BoundaryCurve,t.Position,t.IsReal);t.BundleBases.set(e,n),I.PointRelativeToCurveLocation(t.Position,e.BoundaryCurve)!==0?(i.IsParent=!0,zl(this.internalBases,e,i),zl(this.externalBases,t,n)):I.PointRelativeToCurveLocation(e.Position,t.BoundaryCurve)!==0?(n.IsParent=!0,zl(this.externalBases,e,i),zl(this.internalBases,t,n)):(zl(this.externalBases,e,i),zl(this.externalBases,t,n));let o=this.metroGraphData.tightIntersections.ObstaclesToIgnoreForBundle(e,t),a=new gf(i,n,o,Array.from(this.metroOrdering.GetOrder(e,t)).map(l=>l.Width/2));i.OutgoingBundleInfo=n.IncomingBundleInfo=a,this.Bundles.push(a)}this.SetBundleBaseNeighbors()}SetBundleBaseNeighbors(){for(let e of this.externalBases.keys()){let t=this.externalBases.get(e);this.SortBundlesCounterClockwise(t),this.SetLeftRightBases(t)}for(let e of this.internalBases.keys()){let t=this.internalBases.get(e);this.SortBundlesCounterClockwise(t),this.SetLeftRightBases(t)}}SortBundlesCounterClockwise(e){if(e.length>2){let t=e[0].OppositeBase.Position,i=e[0].CurveCenter;e.sort((n,o)=>qo(t.sub(i),n.OppositeBase.Position.sub(i),o.OppositeBase.Position.sub(i)))}}SetLeftRightBases(e){let t=e.length;if(!(t<=1))for(let i=0;i<t;i++)e[i].Prev=e[(i-1+t)%t],e[i].Next=e[(i+1)%t]}CreateOrientedSegs(){for(let e of this.metroGraphData.Metrolines)this.CreateOrientedSegsOnLine(e)}CreateOrientedSegsOnLine(e){for(let t=e.Polyline.startPoint.next;t.next!=null;t=t.next)this.CreateOrientedSegsOnLineVertex(e,t)}CreateOrientedSegsOnLineVertex(e,t){let i=this.metroGraphData.PointToStations.get(t.prev.point),n=this.metroGraphData.PointToStations.get(t.point),o=this.metroGraphData.PointToStations.get(t.next.point),a=n.BundleBases.get(i),l=n.BundleBases.get(o),u=this.metroOrdering.GetLineIndexInOrder(i,n,e),c=this.metroOrdering.GetLineIndexInOrder(o,n,e),h=a.OrientedHubSegments[u]=new pf(null,!1,u,a),d=l.OrientedHubSegments[c]=new pf(null,!0,c,l);d.Other=h,h.Other=d}UpdateSourceAndTargetBases(){for(let e of this.Bundles)e.UpdateSourceAndTargetBases(!0,!0)}SetBasesRightLeftParamsToTheMiddles(){for(let e of this.Bundles){let t=e.SourceBase,i=e.TargetBase;t.ParEnd=t.ParStart=this.GetBaseMiddleParamInDirection(t,t.Position,i.Position),i.ParEnd=i.ParStart=this.GetBaseMiddleParamInDirection(i,i.Position,t.Position)}}GetBaseMiddleParamInDirection(e,t,i){let n=e.Curve;if(n instanceof pe){let l=n;if(l.isArc())return m.angle(l.aAxis,i.sub(t))}let a=I.getAllIntersections(n,k.mkPP(t,i),!0);for(let l of a){let u=l.x;if(u.sub(t).dot(u.sub(i))<=0)return l.par0}throw new Error}SetRightLeftParamsFeasiblySymmetrically(){for(let e of this.Bundles)e.SetParamsFeasiblySymmetrically(this.metroGraphData.TightTree)}AdjustStartEndParamsToAvoidBaseOverlaps(){for(let e of this.externalBases.values())this.AdjustCurrentBundleWidthsOnCurve(e);for(let e of this.internalBases.values())this.AdjustCurrentBundleWidthsOnCurve(e)}AdjustCurrentBundleWidthsOnCurve(e){let t=e.length;if(!(t<=1))for(let i=0;i<t;i++){let n=e[i],o=n.Next;this.ShrinkBasesToMakeTwoConsecutiveNeighborsHappy(n,o)}}ShrinkBasesToMakeTwoConsecutiveNeighborsHappy(e,t){let i=BN(e,t);if(i==null||ue(i.start,i.end))return;let n=i.rbaseMiddle,o=i.lbaseMiddle;if(n<o){let c=e;e=t,t=c}let a=e.Span,l=t.Span,u=(i.end*a+i.start*l)/(l+a);e.ParStart=e.AdjustParam(u+R.distanceEpsilon),t.ParEnd=t.AdjustParam(u-R.distanceEpsilon)}RegularCut(e,t,i,n,o,a){let l=(o*n+a*e)/(o+a),u=Math.min(t,n),c=Math.max(e,i);return l<c&&(l=c),l>u&&(l=u),l}RotateBundlesToDiminishCost(){let e=Qe.MaxParameterChange,t={cost:this.Cost()},i=0;for(;i++<Qe.MaxIterations;){let n=t.cost;if(this.RotateBundlesToDiminishCostOneIteration(e,t),e=this.UpdateParameterChange(e,n,t.cost),e<Qe.MinParameterChange)break}}UpdateParameterChange(e,t,i){return i+1<t?(this.stepsWithProgress++,this.stepsWithProgress>=5&&(this.stepsWithProgress=0,this.fixedBundles.clear())):(this.stepsWithProgress=0,e*=.8,this.fixedBundles.clear()),e}RotateBundlesToDiminishCostOneIteration(e,t){let i=!1;for(let n of this.Bundles)this.fixedBundles.has(n)||(this.OptimizeBundle(n,e,t)?i=!0:this.fixedBundles.add(n));return i}OptimizeBundle(e,t,i){let n=this.CostBi(e);if(n<Qe.CostThreshold)return!1;let o=0,a=-1,l=-1;for(let u=0;u<Qe.Deltas.length-1;u++){let c=this.DeltaWithChangedAngles(Qe.Deltas[u][0],Qe.Deltas[u][1],0,0,e,n,t);c>Qe.CostDeltaThreshold&&c>o&&(l=u,a=Qe.Deltas.length-1,o=c),c=this.DeltaWithChangedAngles(0,0,Qe.Deltas[u][0],Qe.Deltas[u][1],e,n,t),c>Qe.CostDeltaThreshold&&c>o&&(l=Qe.Deltas.length-1,a=u,o=c)}return o<Qe.CostDeltaThreshold?!1:(i.cost-=o,e.RotateBy(Qe.Deltas[l][0],Qe.Deltas[l][1],Qe.Deltas[a][0],Qe.Deltas[a][1],t),!0)}DeltaWithChangedAngles(e,t,i,n,o,a,l){if(!o.RotationIsLegal(e,t,i,n,l))return 0;o.RotateBy(e,t,i,n,l);let u=this.CostBN(o,a);return o.RotateBy(e*-1,t*-1,i*-1,n*-1,l),a-u}CostBi(e){return Qe.SeparationCoeff*this.SeparationCost(e)+(Qe.SqueezeCoeff*this.SqueezeCost(e)+(Qe.AssymetryCoeff*this.AssymetryCost(e)+Qe.CenterCoeff*this.CenterCostBi(e)))}CostBN(e,t){let i=0;return i=i+Qe.CenterCoeff*this.CenterCostBi(e),i>t||(i=i+Qe.SeparationCoeff*this.SeparationCost(e),i>t)||(i=i+Qe.SqueezeCoeff*this.SqueezeCost(e),i>t)||(i=i+Qe.AssymetryCoeff*this.AssymetryCost(e)),i}SqueezeCost(e){let i=e.TargetBase.MidPoint.sub(e.SourceBase.MidPoint).normalize().rotate90Ccw(),n=Math.abs(e.SourceBase.StartPoint.sub(e.SourceBase.EndPoint).dot(i)),o=Math.abs(e.TargetBase.StartPoint.sub(e.TargetBase.EndPoint).dot(i)),a=Math.abs(e.TotalRequiredWidth-n)/e.TotalRequiredWidth,l=Math.abs(e.TotalRequiredWidth-o)/e.TotalRequiredWidth,u=Math.abs(n-o)/e.TotalRequiredWidth;return Math.exp(a*10)-1+(Math.exp(l*10)-1)+u}CenterCostBi(e){return!e.SourceBase.BelongsToRealNode&&!e.TargetBase.BelongsToRealNode?0:this.CenterCostBb(e.SourceBase)+this.CenterCostBb(e.TargetBase)}CenterCostBb(e){if(!e.BelongsToRealNode)return 0;let t=e.ParMid,i=Math.min(e.InitialMidParameter,t),n=Math.max(e.InitialMidParameter,t),o=Math.min(n-i,i+(Pn(e.Curve)-n));return e.CurveCenter.equal(e.Position)||e.IsParent?25*(o*o):500*(o*o)}AssymetryCost(e){return this.GetAssymetryCostForBase(e.SourceBase)+this.GetAssymetryCostForBase(e.TargetBase)}GetAssymetryCostForBase(e){if(e.BelongsToRealNode)return 0;let t=e.OppositeBase.BelongsToRealNode?200:500,i=0;for(let n of e.OrientedHubSegments){let o=n.Index,a=n.Other.Index,l=e.Points[o],u=e.Tangents[o],c=n.Other.BundleBase,h=c.Points[a],d=c.Tangents[a],f=e.Count+c.Count;i+=this.GetAssymetryCostOnData(l,u,h,d,t)/f}return i}GetAssymetryCostOnData(e,t,i,n,o){let a=e.sub(i),l=a.length;if(l<R.distanceEpsilon)return 0;let u=t.add(n).dot(a),c=m.crossProduct(a,t),h=m.crossProduct(a,n),d=c-h,f=u*u+d*d,p=c*c+h*h;return 10*f+o*p}SeparationCost(e){return this.SeparationCostForBundleBase(e.SourceBase)+this.SeparationCostForBundleBase(e.TargetBase)}SeparationCostForBundleBase(e){return e.Prev==null?0:this.SeparationCostForAdjacentBundleBases(e,e.Prev)+this.SeparationCostForAdjacentBundleBases(e,e.Next)}SeparationCostForAdjacentBundleBases(e,t){let i=e.Curve,n=this.IntervalsOverlapLength(e.ParStart,e.ParEnd,t.ParStart,t.ParEnd,i),o=Math.min(e.Span,t.Span);return Math.exp(n/(o*10))-1}IntervalsOverlapLength(e,t,i,n,o){let a=o.parStart,l=o.parEnd;return e<t?i<n?this.IntersectRegularIntervals(e,t,i,n):this.IntersectRegularIntervals(e,t,i,l)+this.IntersectRegularIntervals(e,t,a,n):i<n?this.IntersectRegularIntervals(e,l,i,n)+this.IntersectRegularIntervals(a,t,i,n):this.IntersectRegularIntervals(e,l,i,l)+this.IntersectRegularIntervals(a,t,a,n)}IntersectRegularIntervals(e,t,i,n){let o=Math.max(e,i),a=Math.min(t,n);return o<a?a-o:0}Cost(){let e=0;for(let t of this.Bundles){let i=Qe.SeparationCoeff*this.SeparationCost(t),n=Qe.AssymetryCoeff*this.AssymetryCost(t),o=Qe.SqueezeCoeff*this.SqueezeCost(t),a=Qe.CenterCoeff*this.CenterCostBi(t);e+=(i+n)/2+o+a}return e}},Ri=Qe;Ri.Deltas=[[1,-1],[1,-1]],Ri.SeparationCoeff=1,Ri.SqueezeCoeff=1,Ri.CenterCoeff=10,Ri.AssymetryCoeff=1,Ri.MaxIterations=200,Ri.MaxParameterChange=8/360,Ri.MinParameterChange=.1/360,Ri.CostThreshold=1e-5,Ri.CostDeltaThreshold=.01;function BN(s,e){let t=Pn(s.Curve),i=s.ParEnd,n=s.ParStart<s.ParEnd?s.ParStart:s.ParStart-t,o=e.ParEnd,a=e.ParStart<e.ParEnd?e.ParStart:e.ParStart-t;i>o?i-a>t&&(a+=t,o+=t):o-n>t&&(n+=t,i+=t);let l=Math.min(i,o),u=Math.max(n,a);return u<=l?{start:u,end:l,rbaseMiddle:(n+i)/2,lbaseMiddle:(a+o)/2}:null}var db=class{constructor(){this.Metrolines=new Array}Add(e){this.Metrolines.push(e)}};var cu=class{constructor(e){this.Metrolines=e,this.BuildOrder()}*GetOrder(e,t){let i=new xt(e.Position,t.Position),n=this.bundles.get(i).Metrolines;if(e.Position===i.first)for(let o=0;o<n.length;o++)yield n[o];else for(let o=n.length-1;o>=0;o--)yield n[o]}GetLineIndexInOrder(e,t,i){let n=new xt(e.Position,t.Position),o=e.Position!==n.first,a=this.bundles.get(n).LineIndexInOrder;return o?a.size-1-a.get(i):a.get(i)}BuildOrder(){this.bundles=new Zn;for(let e of this.Metrolines)for(let t=e.Polyline.startPoint;t.next!=null;t=t.next){let i=new xt(t.point,t.next.point),n=this.bundles.get(i);n||this.bundles.set(i,n=new db),n.Add(e)}for(let e of this.bundles)this.BuildOrderPP(e[0],e[1])}BuildOrderPP(e,t){if(!t.orderFixed){t.Metrolines.sort((i,n)=>this.CompareLines(i,n,e.first,e.second)),t.orderFixed=!0,t.LineIndexInOrder=new Map;for(let i=0;i<t.Metrolines.length;i++)t.LineIndexInOrder.set(t.Metrolines[i],i)}}CompareLines(e,t,i,n){let o={polyPoint:null,next:null,prev:null};this.FindStationOnLine(i,n,e,o);let a=o.polyPoint,l=o.next,u=o.prev;this.FindStationOnLine(i,n,t,o);let c=o.polyPoint,h=o.next,d=o.prev,f=a,p=c,S,E;for(;(E=u(f))!=null&&(S=d(p))!=null&&E.point.equal(S.point);){let C=new xt(E.point,f.point);if(this.bundles.get(C).orderFixed)return this.CompareOnFixedOrder(C,e,t,!E.point.equal(C.first));f=E,p=S}if(E!=null&&S!=null){let C=f.point;return-cu.IsLeft(l(f).point.sub(C),E.point.sub(C),S.point.sub(C))}for(f=a,p=c;(E=l(f))!=null&&(S=h(p))!=null&&E.point.equal(S.point);){let C=new xt(E.point,f.point);if(this.bundles.get(C).orderFixed)return this.CompareOnFixedOrder(C,e,t,!f.point.equal(C.first));f=E,p=S}if(E!=null&&S!=null){let C=f.point;return cu.IsLeft(u(f).point.sub(C),E.point.sub(C),S.point.sub(C))}return _e(e.Index,t.Index)}CompareOnFixedOrder(e,t,i,n){let o=this.bundles.get(e).LineIndexInOrder;return(n?-1:1)*_e(o.get(t),o.get(i))}FindStationOnLine(e,t,i,n){for(let o=i.Polyline.startPoint;o.next!=null;o=o.next){if(o.point.equal(e)&&o.next.point.equal(t)){n.next=a=>a.next,n.prev=a=>a.prev,n.polyPoint=o;return}if(o.point.equal(t)&&o.next.point.equal(e)){n.next=a=>a.prev,n.prev=a=>a.next,n.polyPoint=o.next;return}}throw new Error}static IsLeft(e,t,i){return qo(e,t,i)}};var it=class extends Pe{constructor(t,i){super(null);this.metroGraphData=t,this.bundlingSettings=i}run(){this.CreateMetroOrdering(),this.InitRadii(),this.FinalizePaths()}InitRadii(){new Dt(this.metroGraphData,this.bundlingSettings).CreateNodeRadii()}CreateMetroOrdering(){this.metroOrdering=new cu(this.metroGraphData.Metrolines)}FinalizePaths(){this.CreateBundleBases(),this.CreateSegmentsInsideHubs(),this.CreateCurves()}CreateBundleBases(){new Ri(this.metroOrdering,this.metroGraphData,this.bundlingSettings).Run()}CreateCurves(){for(let t=0;t<this.metroGraphData.Metrolines.length;t++)this.CreateCurveLine(this.metroGraphData.Metrolines[t],this.metroGraphData.Edges[t])}CreateCurveLine(t,i){let n=new I,a=it.FindCurveStart(this.metroGraphData,this.metroOrdering,t),l=it.HubSegsOfLine(this.metroGraphData,this.metroOrdering,t);for(let u of l)u!=null&&(n.addSegment(k.mkPP(a,u.start)),n.addSegment(u),a=u.end);n.addSegment(k.mkPP(a,it.FindCurveEnd(this.metroGraphData,this.metroOrdering,t))),i.curve=n}static FindCurveStart(t,i,n){let o=t.PointToStations.get(n.Polyline.startPoint.point),a=t.PointToStations.get(n.Polyline.startPoint.next.point),l=o.BundleBases.get(a),u=l.IsParent?i.GetLineIndexInOrder(o,a,n):i.GetLineIndexInOrder(a,o,n);return l.Points[u]}static FindCurveEnd(t,i,n){let o=t.PointToStations.get(n.Polyline.endPoint.prev.point),a=t.PointToStations.get(n.Polyline.endPoint.point),l=a.BundleBases.get(o),u=l.IsParent?i.GetLineIndexInOrder(a,o,n):i.GetLineIndexInOrder(o,a,n);return l.Points[u]}static*HubSegsOfLine(t,i,n){for(let o=n.Polyline.startPoint.next;o.next!=null;o=o.next)yield it.SegOnLineVertex(t,i,n,o)}static SegOnLineVertex(t,i,n,o){let a=t.PointToStations.get(o.prev.point),l=t.PointToStations.get(o.point),u=l.BundleBases.get(a),c=i.GetLineIndexInOrder(a,l,n);if(u.OrientedHubSegments[c]==null||u.OrientedHubSegments[c].Segment==null){let h=t.PointToStations.get(o.next.point),d=l.BundleBases.get(h),f=i.GetLineIndexInOrder(h,l,n);return k.mkPP(u.Points[c],d.Points[f])}return u.OrientedHubSegments[c].Segment}CreateSegmentsInsideHubs(){for(let t of this.metroGraphData.Metrolines)this.CreateOrientedSegsOnLine(t);this.bundlingSettings.UseCubicBezierSegmentsInsideOfHubs&&this.FanBezierSegs()}CreateOrientedSegsOnLine(t){for(let i=t.Polyline.startPoint.next;i.next!=null;i=i.next)this.CreateICurveForOrientedSeg(t,i)}CreateICurveForOrientedSeg(t,i){let n=this.metroGraphData.PointToStations.get(i.prev.point),o=this.metroGraphData.PointToStations.get(i.point),a=this.metroGraphData.PointToStations.get(i.next.point),l=o.BundleBases.get(n),u=o.BundleBases.get(a),c=this.metroOrdering.GetLineIndexInOrder(n,o,t),h=this.metroOrdering.GetLineIndexInOrder(a,o,t),d=this.bundlingSettings.UseCubicBezierSegmentsInsideOfHubs?it.StandardBezier(l.Points[c],l.Tangents[c],u.Points[h],u.Tangents[h]):it.BiArc(l.Points[c],l.Tangents[c],u.Points[h],u.Tangents[h]);l.OrientedHubSegments[c].Segment=d,u.OrientedHubSegments[h].Segment=d}static ShowHubs(t,i,n,o,a=[]){let l=it.GetAllDebugCurves(i,t);n!=null&&l.push(Ie.mkDebugCurveTWCI(255,1,"red",Fe.mkDiamond(5,25,n.Position))),l=l.concat(a)}static GetAllDebugCurves(t,i){return it.GraphNodes(i).concat(it.VertexDebugCurves(t,i)).concat(it.DebugEdges(i))}static DebugEdges(t){return t.Edges.map(i=>Ie.mkDebugCurveTWCI(40,.1,"gray",i.curve))}static VertexDebugCurves(t,i){return it.DebugCircles(i).concat(it.DebugHubBases(i)).concat(it.DebugSegs(i)).concat(it.BetweenHubs(t,i))}static BetweenHubs(t,i){let n=[];for(let o of i.Metrolines){let a=it.GetInterestingSegs(i,t,o),l=it.GetMonotoneColor(o.Polyline.start,o.Polyline.end,a);for(let u of a)n.push(Ie.mkDebugCurveTWCI(100,o.Width,l,k.mkPP(u[0],u[1])))}return n}static GetInterestingSegs(t,i,n){let o=new Array;if(t.Stations.length===0||t.Stations[0].BundleBases==null||t.Stations[0].BundleBases.size===0)return[];let a=it.FindCurveStart(t,i,n),l=it.HubSegsOfLine(t,i,n);for(let u of l)u!=null&&(o.push([a,u.start]),a=u.end);return o.push([a,it.FindCurveEnd(t,i,n)]),o}static GetMonotoneColor(t,i,n){return"green"}static DebugHubBases(t){let i=new Array;for(let n of t.Stations)for(let o of n.BundleBases.values())i.push(Ie.mkDebugCurveTWCI(100,1,"red",k.mkPP(o.EndPoint,o.StartPoint)));return i}static DebugCircles(t){return t.Stations.map(i=>Ie.mkDebugCurveTWCI(100,.1,"blue",Fe.mkCircle(i.Radius,i.Position)))}static DebugSegs(t){let i=new Array;for(let n of t.VirtualStations())for(let o of n.BundleBases.values())for(let a of o.OrientedHubSegments)if(a!=null)if(a.Segment==null){let l=a.Other.BundleBase,u=a.Index,c=a.Other.Index;i.push(k.mkPP(o.Points[u],l.Points[c]))}else i.push(a.Segment);return i.map(n=>Ie.mkDebugCurveTWCI(100,.01,"green",n))}static GraphNodes(t){return t.Edges.map(n=>n.sourcePort.Curve).concat(t.Edges.map(n=>n.targetPort.Curve)).map(n=>Ie.mkDebugCurveTWCI(40,1,"black",n))}static BiArc(t,i,n,o){let a=t.sub(n);if(a.length<R.distanceEpsilon)return null;let l=a.dot(i.sub(o)),u=-i.dot(o);if(i.dot(n.sub(t))<=0&&i.dot(o)<=0)return it.StandardBezier(t,i,n,o);let c=2*(u-1),h=2*l,d=a.dot(a),f;if(Math.abs(c)<R.distanceEpsilon)if(Math.abs(h)>R.distanceEpsilon)f=-d/h;else return null;else{let A=h*h-4*c*d;A<0&&(A=0),A=Math.sqrt(A),f=(-h+A)/(2*c),f<0&&(f=(-h-A)/(2*c))}let p=t.add(i.mul(f)),S=n.add(o.mul(f)),E=m.middle(p,S),C=m.getTriangleOrientation(t,p,E),O=m.getTriangleOrientation(E,S,n);if(C!==O)return it.StandardBezier(t,i,n,o);let B=new I;return B.addSegs([it.ArcOn(t,p,E),it.ArcOn(E,S,n)]),B}static ArcOn(t,i,n){let o={center:null};if(Math.abs(m.signedDoubledTriangleArea(t,i,n))<1e-4||!it.FindArcCenter(t,i,n,o))return k.mkPP(t,n);let a=o.center,l=ze(t,a);if(ze(t,i)/l<1e-4)return k.mkPP(t,n);let c=t.sub(a),h=Math.atan2(c.y,c.x),d=n.sub(a),f=Math.atan2(d.y,d.x),p=f-h;if(p<0&&(p+=2*Math.PI,f+=2*Math.PI),p<=Math.PI)return new pe(h,f,new m(l,0),new m(0,l),a);for(f>2*Math.PI&&(f-=2*Math.PI),h=Math.PI-h,f=Math.PI-f,h<0&&(h+=2*Math.PI);f<h;)f+=2*Math.PI;return p=f-h,new pe(h,f,new m(-l,0),new m(0,l),a)}static FindArcCenter(t,i,n,o){let a=i.sub(t).rotate90Cw(),l=i.sub(n).rotate90Cw();return o.center=m.lineLineIntersection(t,t.add(a),n,n.add(l)),o.center!=null}static StandardBezier(t,i,n,o){let a=ze(t,n)/4;return Me.mkBezier([t,t.add(i.mul(a)),n.add(o.mul(a)),n])}FanBezierSegs(){let t=!0,i=5,n=0;for(;t&&n++<i;){t=!1;for(let o of this.metroGraphData.Stations)for(let a of o.BundleBases.values())t||(t=this.FanEdgesOfHubSegment(a))}}FanEdgesOfHubSegment(t){let i=!1;for(let n=0;n<t.Count-1;n++)i||(i=this.FanCouple(t,n,t.CurveCenter,t.Curve.boundingBox.diagonal/2));return i}FanCouple(t,i,n,o){let a=t.OrientedHubSegments[i],l=t.OrientedHubSegments[i+1];if(a==null||Xp(a.Segment.start,a.Segment.end,l.Segment.start,l.Segment.end)||m.getTriangleOrientation(a.value(0),a.value(.5),a.value(1))!=m.getTriangleOrientation(l.value(0),l.value(.5),l.value(1)))return!1;let c=this.BaseLength(a),h=this.BaseLength(l);return Math.abs(c-h)<R.intersectionEpsilon?!1:c>h?this.AdjustLongerSeg(a,l,n,o):this.AdjustLongerSeg(l,a,n,o)}AdjustLongerSeg(t,i,n,o){let a=t.value(0).sub(i.value(0)),l=t.value(1).sub(i.value(1)),u=Math.min(a.length,l.length),c=i.value(.5),h=Math.max(a.length,l.length);return this.NicelyAligned(t.Segment,a,l,c,u,h)===0?!1:this.FitLonger(t,a,l,c,u,h,n,o)}FitLonger(t,i,n,o,a,l,u,c){let h=t.Segment,d=h.start,f=h.end,p=0,S=10,E=h.start.mul(1-it.SqueezeBound).add(h.B(1).mul(it.SqueezeBound)),C=h.end.mul(1-it.SqueezeBound).add(h.B(2).mul(it.SqueezeBound)),O=h.B(1).mul(2).sub(h.start),B=h.B(2).mul(2).sub(h.end),A={highP:O};this.PullControlPointToTheCircle(h.start,A,u,c),O=A.highP;let N=this.NicelyAligned(h,i,n,o,a,l);do{if(N===-1){let z=m.middle(h.B(1),E),Y=m.middle(h.B(2),C);O=h.B(1),B=h.B(2),h=new Me(d,z,Y,f)}else{let z=m.middle(h.B(1),O),Y=(h.B(2),B);E=h.B(1),C=h.B(2),h=new Me(d,z,Y,f)}if((N=this.NicelyAligned(h,i,n,o,a,l))===0)return t.Segment=h,t.Other.Segment=h,!0;if(p++>S)return!1}while(!0)}PullControlPointToTheCircle(t,i,n,o){let a=m.ProjectionToLine(t,i.highP,n),l=Math.sqrt(o*o-a.sub(n).lengthSquared),u=i.highP.sub(a),c=u.length;c>l&&(i.highP=a.add(u.mul(l/c)))}NicelyAligned(t,i,n,o,a,l){let c=t.value(.5).sub(o),h=c.length;return i.dot(c)<0||n.dot(c)<0||h<a-.001?1:h>l+.001?-1:0}BaseLength(t){return t.value(0).sub(t.value(1)).lengthSquared}},Xa=it;Xa.SqueezeBound=.2;var Cn=class{constructor(e,t){this.stepsWithProgress=0;this.metroGraphData=e,this.bundlingSettings=t,this.costCalculator=new wr(this.metroGraphData,this.bundlingSettings),this.cache=new qa(this.metroGraphData,this.bundlingSettings,this.costCalculator,this.metroGraphData.cdt)}static FixRouting(e,t){return this.FixRoutingMBP(e,t,null)}static FixRoutingMBP(e,t,i){return new Cn(e,t).FixRoutingP(i)}FixRoutingP(e){this.stationsForOptimizations=this.GetStationsForOptimizations(e),this.cache.InitializeCostCache();let t=Cn.MaxStep,i=Number.POSITIVE_INFINITY,n=this.metroGraphData.VirtualStations().map(a=>a.Position),o=0;for(;o++<Cn.MaxIterations;){let a=this.TryMoveStations();if(o<=1&&!a)return!1;if(!a)break;let l=i;i=wr.Cost(this.metroGraphData,this.bundlingSettings),t=this.UpdateMaxStep(t,l,i);let u=n;if(n=this.metroGraphData.VirtualStations().map(c=>c.Position),t<Cn.MinStep||this.Converged(t,u,n))break}return!0}static stationsArePositionedCorrectly(e){for(let t of e.VirtualEdges())if(!this.edgeIsPositionedCorrectly(t,e))return!1;return!0}static edgeIsPositionedCorrectly(e,t){let i=e[0],n=e[1],o=t.looseIntersections.ObstaclesToIgnoreForBundle(i,n),a=k.mkPP(i.Position,n.Position),l=Array.from(t.looseIntersections.obstacleTree.GetNodeItemsIntersectingRectangle(a.boundingBox)).filter(u=>!o.has(u)).filter(u=>I.CurvesIntersect(a,u));return l.length>0?(Xa.ShowHubs(t,null,null,"./tmp/badcross.svg",[Ie.mkDebugCurveTWCI(200,1,"Brown",a),Ie.mkDebugCurveTWCI(200,1,"Red",Fe.mkCircle(2,i.Position)),Ie.mkDebugCurveTWCI(200,1,"Blue",Fe.mkCircle(5,n.Position)),Ie.mkDebugCurveTWCI(100,1,"Blue",Fe.mkCircle(5,n.Position))].concat(l.map(u=>Ie.mkDebugCurveTWCI(100,1,"Pink",u)))),!1):!0}GetStationsForOptimizations(e){if(e==null)return new Set(this.metroGraphData.VirtualStations());{let t=new Set;for(let i of e){let n=this.metroGraphData.PointToStations.get(i);n&&!n.IsReal&&t.add(n)}return t}}Converged(e,t,i){let n=0,o=0;for(let l=0;l<t.length;l++)o+=t[l].sub(i[l]).lengthSquared,n+=t[l].lengthSquared;return Math.sqrt(o/n)<Cn.MinRelativeChange}UpdateMaxStep(e,t,i){return i+1<t?(this.stepsWithProgress++,this.stepsWithProgress>=5&&(this.stepsWithProgress=0,e=Math.min(Cn.MaxStep,e/.8))):(this.stepsWithProgress=0,e*=.8),e}TryMoveStations(){let e=!1,t=new Set;for(let i of this.stationsForOptimizations)if(this.TryMoveStation(i)){e=!0,t.add(i);for(let n of i.Neighbors)n.IsReal||t.add(n)}return this.stationsForOptimizations=t,e}TryMoveStation(e){let t=this.BuildDirection(e);if(t.length===0)return!1;let i=this.BuildStepLength(e,t);if(i<Cn.MinStep&&(t=DN(),i=this.BuildStepLength(e,t),i<Cn.MinStep))return!1;let n=t.mul(i),o=e.Position.add(n);return this.metroGraphData.PointToStations.has(o)||!this.moveIsLegalForAdjacentBundles(e,o)?!1:(this.metroGraphData.MoveNode(e,o),this.cache.UpdateCostCache(e),!0)}moveIsLegalForAdjacentBundles(e,t){for(let i of this.metroGraphData.looseIntersections.obstacleTree.AllHitItems(X.mkOnPoints([t]),n=>I.PointRelativeToCurveLocation(t,n)!==0))if(e.getELP().has(i)===!1)return!1;for(let i of e.Neighbors){let n=this.metroGraphData.looseIntersections.ObstaclesToIgnoreForBundle(i,e);if(!this.metroGraphData.cdtIntersections.EdgeIsLegal_(i.Position,t,i.cdtTriangle,n))return!1}return!0}BuildDirection(e){let t=this.BuildForceForInk(e),i=this.BuildForceForPathLengths(e),n=this.BuildForceForRadius(e),o=this.BuildForceForBundle(e),a=t.add(i.add(n.add(o)));return a.length<.1?new m(0,0):a.normalize()}BuildStepLength(e,t){let i=Cn.MinStep,n=this.CostGain(e,e.Position.add(t.mul(i)));if(n<.01)return 0;for(;2*i<=Cn.MaxStep;){let o=this.CostGain(e,e.Position.add(t.mul(i*2)));if(o<=n)break;i*=2,n=o}return i}CostGain(e,t){let n=this.costCalculator.RadiusGain(e,t);if(n<-12345678)return-12345678;let o=this.costCalculator.BundleGain(e,t);if(o<-12345678)return-12345678;let a=this.costCalculator.InkGain(e,t),l=this.costCalculator.PathLengthsGain(e,t);return n+a+l+o}BuildForceForInk(e){let t=new m(0,0);for(let n of e.Neighbors){let o=n.Position.sub(e.Position);t=t.add(o.normalize())}return t.mul(this.bundlingSettings.InkImportance)}BuildForceForPathLengths(e){let t=new m(0,0);for(let n of this.metroGraphData.MetroNodeInfosOfNode(e)){let o=n.Metroline,a=n.PolyPoint.next.point,l=n.PolyPoint.prev.point,u=a.sub(e.Position),c=l.sub(e.Position);t=t.add(u.div(u.length*o.IdealLength)),t=t.add(c.div(c.length*o.IdealLength))}return t.mul(this.bundlingSettings.PathLengthImportance)}BuildForceForRadius(e){let t=new m(0,0),i=e.cachedIdealRadius,n={touchedObstacles:[]};if(!this.metroGraphData.looseIntersections.HubAvoidsObstaclesSPNBA(e,e.Position,i,n))throw Xa.ShowHubs(this.metroGraphData,null,e,"./tmp/hubs.svg",[Ie.mkDebugCurveTWCI(255,1,"Brown",$r.containingPoly),Ie.mkDebugCurveTWCI(100,1,"Blue",Fe.mkCircle(i,e.Position))]),new Error;for(let l of n.touchedObstacles){let u=l[1].sub(e.Position).length,c=2*(1-u/i),h=e.Position.sub(l[1]).normalize();t=t.add(h.mul(c))}return t.mul(this.bundlingSettings.HubRepulsionImportance)}BuildForceForBundle(e){let t=new m(0,0);for(let n of e.Neighbors){let o=this.metroGraphData.GetWidthSSN(e,n,this.bundlingSettings.EdgeSeparation),a={closestDist:[]},l=this.metroGraphData.cdtIntersections.BundleAvoidsObstacles(e,n,e.Position,n.Position,o/2,a);for(let u of a.closestDist){let c=u[0].sub(u[1]).length,h=2*(1-c/(o/2)),d=u[0].sub(u[1]).normalize().neg();t=t.add(d.mul(h))}}return t.mul(this.bundlingSettings.BundleRepulsionImportance)}},An=Cn;An.MaxIterations=100,An.MaxStep=50,An.MinStep=1,An.MinRelativeChange=5e-4;function DN(){return new m(1+2*Go(),1+2*Go())}var Yo=class{constructor(e,t){this.metroGraphData=e,this.bundlingSettings=t}static FixRouting(e,t){let i=new Yo(e,t);i.GlueConflictingStations(),i.UnglueEdgesFromBundleToSaveInk(!0);let n=0,o=10;for(;++n<o;){let a=i.GlueConflictingStations();if(a||(a=i.RelaxConstrainedEdges()),a||(a=n<=3&&i.UnglueEdgesFromBundleToSaveInk(!1)),a||(a=i.GlueCollinearNeighbors(n)),a||(a=n===3&&i.RemoveDoublePathCrossings()),!a)break}for(e.cdtIntersections.ComputeForcesForBundles=!0,i.RemoveDoublePathCrossings(),i.UnglueEdgesFromBundleToSaveInk(!0);i.GlueConflictingStations(););e.Initialize(!0)}GlueConflictingStations(){let e=this.GetCirclesHierarchy();if(e==null)return!1;let t=new Map,i=new Set;if(Vt(e,e,(o,a)=>this.TryToGlueStations(o,a,t,i)),t.size===0)return!1;for(let o=0;o<this.metroGraphData.Edges.length;o++)this.RegenerateEdge(t,o);let n=new He;for(let o of i){n.add(o.Position);for(let a of o.Neighbors)a.IsReal||n.add(a.Position)}return this.metroGraphData.Initialize(!1),An.FixRoutingMBP(this.metroGraphData,this.bundlingSettings,n),!0}GetCirclesHierarchy(){for(let i of this.metroGraphData.VirtualStations())i.Radius=this.GetCurrentHubRadius(i);let e=this.metroGraphData.VirtualStations().map(t);return tt(e);function t(i){let n=i.Position,o=Math.max(i.Radius,5),a=new m(o,o),l=X.mkPP(n.add(a),n.sub(a));return ct(i,l)}}GetCurrentHubRadius(e){if(e.IsReal)return e.BoundaryCurve.boundingBox.diagonal/2;{let t=e.cachedIdealRadius,i=this.metroGraphData.looseIntersections.GetMinimalDistanceToObstacles(e,e.Position,t);for(let n of e.Neighbors)i=Math.min(i,e.Position.sub(n.Position).length);return i}}TryToGlueStations(e,t,i,n){if(!Vl(e.getELP(),t.getELP()))return!1;let o=e.Position.sub(t.Position).length,a=Math.max(e.Radius,5),l=Math.max(t.Radius,5);o>=a+l||this.TryGlueOrdered(e,t,n,i)||this.TryGlueOrdered(t,e,n,i)}TryGlueOrdered(e,t,i,n){return!n.has(e)&&!i.has(e)&&this.StationGluingIsAllowed(e,t,n)?(this.Map(e,t,i,n),!0):!1}Map(e,t,i,n){n.set(e,t),i.add(t)}StationGluingIsAllowed(e,t,i){for(let o of e.Neighbors){let a=Yo.Glued(o,i),l=this.metroGraphData.looseIntersections.ObstaclesToIgnoreForBundle(a,e);if(!this.metroGraphData.cdtIntersections.EdgeIsLegalSSPPS(a,t,l))return!1}return!(this.ComputeCostDeltaAfterStationGluing(e,t,i)<0)}ComputeCostDeltaAfterStationGluing(e,t,i){let n=e.Position.sub(t.Position).length;if(e.Radius>=n||t.Radius>=n)return 1;let o=0,a=this.metroGraphData.Ink,l=this.metroGraphData.Ink-t.Position.sub(e.Position).length;for(let u of e.Neighbors){let c=Yo.Glued(u,i);l-=c.Position.sub(e.Position).length,l+=this.metroGraphData.RealEdgeCount(c,t)===0?c.Position.sub(t.Position).length:0}o+=wr.InkError(a,l,this.bundlingSettings);for(let u of this.metroGraphData.MetroNodeInfosOfNode(e)){let c=u.Metroline.Length,h=u.Metroline.Length,d=u.PolyPoint,f=d.prev,p=d.next;h-=f.point.sub(e.Position).length+p.point.sub(e.Position).length,h+=f.point.sub(t.Position).length+p.point.sub(t.Position).length,o+=wr.PathLengthsError(c,h,u.Metroline.IdealLength,this.bundlingSettings)}return o}RegenerateEdge(e,t){let i=this.metroGraphData.Metrolines[t].Polyline;for(let a of i)if(!this.metroGraphData.PointToStations.has(a))return;let n=!1;for(let a of i)if(e.has(this.metroGraphData.PointToStations.get(a))){n=!0;break}if(!n)return;let o=Array.from(i).map(a=>this.metroGraphData.PointToStations.get(a));this.metroGraphData.Edges[t].curve=ne.mkFromPoints(Yo.GluedPolyline(o,e))}static GluedPolyline(e,t){let i,n=new RA.Stack;n.push(e[0]);let o=new Set;for(i=1;i<e.length-1;i++){let a=Yo.Glued(e[i],t);if(o.has(a)){for(;n.top!==a;)o.delete(n.pop());continue}m.closeDistEps(a.Position,n.top.Position)||(o.add(a),n.push(a))}return n.push(e[i]),Array.from(n).reverse().map(a=>a.Position)}static Glued(e,t){var i;return(i=t.get(e))!=null?i:e}UnglueEdgesFromBundleToSaveInk(e){let t=new Zn;this.ink=this.metroGraphData.Ink,this.polylineLength=new Map;for(let o of this.metroGraphData.Metrolines){this.polylineLength.set(o,o.Length);for(let a=o.Polyline.startPoint;a.next!=null;a=a.next){let l=new xt(a.point,a.next.point);T0(t,l,o)}}let i=new He,n=!1;for(let o of this.metroGraphData.Metrolines){let a=Un(this.metroGraphData.PointToStations.get(o.Polyline.start).getELP(),this.metroGraphData.PointToStations.get(o.Polyline.end).getELP());this.TrySeparateOnPolyline(o,t,i,a)&&(n=!0)}return n&&this.metroGraphData.Initialize(!1),(e||n)&&An.FixRoutingMBP(this.metroGraphData,this.bundlingSettings,e?null:i),n}TrySeparateOnPolyline(e,t,i,n){let o=!1,a=!0;for(;a;){a=!1;for(let l=e.Polyline.startPoint;l.next!=null&&l.next.next!=null;l=l.next)this.TryShortcutPolypoint(l,t,i,n)&&(a=!0);a&&(o=!0)}return o}TryShortcutPolypoint(e,t,i,n){return this.SeparationShortcutAllowed(e,t,n)?(i.add(e.point),i.add(e.next.point),i.add(e.next.next.point),this.RemoveShortcuttedPolypoint(e,t),!0):!1}SeparationShortcutAllowed(e,t,i){let n=e.point,o=e.next.point,a=e.next.next.point,l=this.metroGraphData.PointToStations.get(n),u=this.metroGraphData.PointToStations.get(o),c=this.metroGraphData.PointToStations.get(a),h=Vn(l.getELP(),c.getELP()),d=PC([i,u.getELP(),h]);return!(!this.metroGraphData.cdtIntersections.EdgeIsLegalSSPPS(l,c,d)||this.GetInkgain(e,t,n,o,a)<0)}GetInkgain(e,t,i,n,o){let[a,l,u]=this.FindPolylines(e,t),c=0,h=this.ink,d=this.ink,f=i.sub(n).length,p=n.sub(o).length,S=i.sub(o).length;a.size===u.size&&(d-=f),l.size===u.size&&(d-=p);let E=t.get(new xt(i,o));(!E||E.size===0)&&(d+=S),c+=wr.InkError(h,d,this.bundlingSettings);for(let z of u){let Y=this.polylineLength.get(z),ie=Y-(f+p-S);c+=wr.PathLengthsError(Y,ie,z.IdealLength,this.bundlingSettings)}let C=this.GetCurrentHubRadius(this.metroGraphData.PointToStations.get(i)),O=this.metroGraphData.GetWidthAN(Array.from(u),this.bundlingSettings.EdgeSeparation),B=this.metroGraphData.GetWidthAN(Array.from(bs(a,u)),this.bundlingSettings.EdgeSeparation),A=Dt.GetMinRadiusForTwoAdjacentBundlesNPPPNNB(C,i,o,n,O,B,this.bundlingSettings);A>C&&(c-=wr.RError(A,C,this.bundlingSettings)),C=this.GetCurrentHubRadius(this.metroGraphData.PointToStations.get(o));let N=this.metroGraphData.GetWidthAN(Array.from(bs(l,u)),this.bundlingSettings.EdgeSeparation);return A=Dt.GetMinRadiusForTwoAdjacentBundlesNPPPNNB(C,o,n,i,N,O,this.bundlingSettings),A>C&&(c-=wr.RError(A,C,this.bundlingSettings)),c}RemoveShortcuttedPolypoint(e,t){let i=e.point,n=e.next.point,o=e.next.next.point,[a,l,u]=this.FindPolylines(e,t),c=ze(i,n),h=ze(n,o),d=ze(i,o);a.size===u.size&&(this.ink-=c),l.size===u.size&&(this.ink-=h);let f=t.get(new xt(i,o));(!f||f.size===0)&&(this.ink+=d);for(let p of u){let S=this.polylineLength.get(p);this.polylineLength.set(p,S-(c+h-d))}for(let p of u){let S=Array.from(p.Polyline.polylinePoints()).find(E=>E.point.equal(n));this.RemovePolypoint(S),I0(t,[i,n],p),I0(t,[n,o],p),yC(t,[i,o],p)}}FindPolylines(e,t){let i=e.point,n=e.next.point,o=e.next.next.point,a=t.getPP(i,n),l=t.getPP(n,o),u=Un(a,l);return[a,l,u]}RemovePolypoint(e){let t=e.prev,i=e.next;t.next=i,i.prev=t}GlueCollinearNeighbors(e){let t=new He,i=!1;for(let n of this.metroGraphData.Stations)this.GlueCollinearNeighborsSPN(n,t,e)&&(i=!0);return i&&(this.metroGraphData.Initialize(!1),An.FixRoutingMBP(this.metroGraphData,this.bundlingSettings,t)),i}GlueCollinearNeighborsSPN(e,t,i){if(e.Neighbors.length<=1)return!1;let n=new th,o=e.Neighbors;for(let a=0;a<o.length;a++)this.TryToGlueEdges(e,o[a],o[(a+1)%o.length],n,i);if(n.isEmpty)return!1;for(let a of n)this.GlueEdge(a),t.add(a[0].Position),t.add(a[1].Position),t.add(a[2]);return!0}TryToGlueEdges(e,t,i,n,o){if(m.anglePCP(t.Position,e.Position,i.Position)<this.bundlingSettings.AngleThreshold){let l=ze(t.Position,e.Position),u=ze(i.Position,e.Position),c=Math.min(l,u)/Math.max(l,u);if(c<.05)return;if(l<u){if(this.EdgeGluingIsAllowedSSS(e,t,i)){this.AddEdgeToGlue(e,i,t,t.Position,n);return}}else if(this.EdgeGluingIsAllowedSSS(e,i,t)){this.AddEdgeToGlue(e,t,i,i.Position,n);return}if(o<5&&c>.5){let h=this.ConstructGluingPoint(e,t,i);this.EdgeGluingIsAllowedSSSP(e,t,i,h)&&this.AddEdgeToGlue(e,i,t,h,n)}}}ConstructGluingPoint(e,t,i){let n=Math.min(ze(t.Position,e.Position),ze(i.Position,e.Position)/2),o=t.Position.sub(e.Position).normalize().add(i.Position.sub(e.Position).normalize());return e.Position.add(o.mul(n/2))}EdgeGluingIsAllowedSSS(e,t,i){if(t.IsReal||i.IsReal||!Vl(t.getELP(),i.getELP())||!this.metroGraphData.cdtIntersections.EdgeIsLegal(t,i,t.Position,i.Position))return!1;let n=this.metroGraphData.looseIntersections.ObstaclesToIgnoreForBundle(e,i);return!(je.IntersectionsOfLineAndRectangleNodeOverPolylineLR(k.mkPP(e.Position,t.Position),this.metroGraphData.LooseTree).find(u=>!n.has(u.seg1))||je.IntersectionsOfLineAndRectangleNodeOverPolylineLR(k.mkPP(t.Position,i.Position),this.metroGraphData.LooseTree).find(u=>!n.has(u.seg1))||this.ComputeCostDeltaAfterEdgeGluing(e,t,i,t.Position)<0)}EdgeGluingIsAllowedSSSP(e,t,i,n){return!(!this.metroGraphData.looseIntersections.HubAvoidsObstaclesPNS__(n,0,Un(t.getELP(),i.getELP()))||!this.metroGraphData.cdtIntersections.EdgeIsLegal(e,null,e.Position,n)||!this.metroGraphData.cdtIntersections.EdgeIsLegal(t,null,t.Position,n)||!this.metroGraphData.cdtIntersections.EdgeIsLegal(i,null,i.Position,n)||this.ComputeCostDeltaAfterEdgeGluing(e,t,i,n)<0)}ComputeCostDeltaAfterEdgeGluing(e,t,i,n){let o=0,a=this.metroGraphData.Ink,l=this.metroGraphData.Ink-ze(e.Position,i.Position)-ze(e.Position,t.Position)+ze(e.Position,n)+ze(n,t.Position)+ze(n,i.Position);o+=wr.InkError(a,l,this.bundlingSettings);for(let d of this.metroGraphData.GetIjInfo(e,i).Metrolines){let f=d.Length,p=d.Length-ze(e.Position,i.Position)+ze(e.Position,n)+ze(n,i.Position);o+=wr.PathLengthsError(f,p,d.IdealLength,this.bundlingSettings)}for(let d of this.metroGraphData.GetIjInfo(e,t).Metrolines){let f=d.Length,p=d.Length-ze(e.Position,t.Position)+ze(e.Position,n)+ze(n,t.Position);o+=wr.PathLengthsError(f,p,d.IdealLength,this.bundlingSettings)}let u=e.cachedIdealRadius,c=this.GetCurrentHubRadius(e),h=Dt.GetMinRadiusForTwoAdjacentBundles(c,e,e.Position,t,i,this.metroGraphData,this.bundlingSettings);return h>c&&(o+=wr.RError(h,c,this.bundlingSettings)),u>ze(e.Position,n)&&!e.IsReal&&(o-=wr.RError(u,ze(e.Position,n),this.bundlingSettings)),o}AddEdgeToGlue(e,t,i,n,o){o.has(i,e)||o.has(t,e)||o.has(e,i)||o.has(e,t)||(o.set(e,i,n),o.set(e,t,n))}GlueEdge(e){let t=e[0],i=e[1],n=e[2];for(let o of t.MetroNodeInfos.map(a=>a.PolyPoint))o.next!=null&&o.next.point.equal(i.Position)?this.SplitPolylinePoint(o,n):o.prev!=null&&o.prev.point.equal(i.Position)&&this.SplitPolylinePoint(o.prev,n)}SplitPolylinePoint(e,t){if(e.point===t||e.next.point===t)return;let i=Kt.mkFromPoint(t);i.polyline=e.polyline,i.next=e.next,i.prev=e,i.next.prev=i,i.prev.next=i}RelaxConstrainedEdges(){let e=new He,t=!1;for(let i of this.metroGraphData.VirtualEdges())this.RelaxConstrainedEdge(i[0],i[1],e)&&(t=!0);return t&&(this.metroGraphData.Initialize(!1),An.FixRoutingMBP(this.metroGraphData,this.bundlingSettings,e)),t}RelaxConstrainedEdge(e,t,i){let n=this.metroGraphData.GetWidthSSN(e,t,this.bundlingSettings.EdgeSeparation),o={closestDist:new Array};this.metroGraphData.cdtIntersections.BundleAvoidsObstacles(e,t,e.Position,t.Position,.99*n/2,o);let a=o.closestDist;if(a.length>0){let l=-1,u;for(let c of a){let h=Math.min(ze(e.Position,c[1]),ze(t.Position,c[1])),d=ze(e.Position,t.Position);if(h/d<.1)continue;let p=ze(c[0],c[1]);(l===-1||p<l)&&(l=p,u=c[1])}if(l===-1||!this.metroGraphData.looseIntersections.HubAvoidsObstaclesPNS__(u,0,Un(e.getELP(),t.getELP())))return!1;i.add(u),i.add(e.Position),i.add(t.Position);for(let c of this.metroGraphData.GetIjInfo(e,t).Metrolines){let h=null;for(let d of c.Polyline.polylinePoints())if(d.point.equal(e.Position)){h=d;break}h.next!=null&&h.next.point.equal(t.Position)?this.SplitPolylinePoint(h,u):this.SplitPolylinePoint(h.prev,u)}return!0}return!1}RemoveDoublePathCrossings(){let e=new _s(this.metroGraphData,this.metroGraphData.PointIsAcceptableForEdge.bind(this)).run();return e&&(this.metroGraphData.Initialize(!1),An.FixRouting(this.metroGraphData,this.bundlingSettings)),e}};var hu=class{constructor(e,t,i){this.upperBound=Number.POSITIVE_INFINITY;this._visGraph=i,i.ClearPrevEdgesTable();for(let n of i.Vertices())n.Distance=Number.POSITIVE_INFINITY;this.sources=e,this.targets=new Set(t)}GetPath(){let e=new Er;for(let t of this.sources)t.Distance=0,e.Enqueue(t,0);for(;!e.IsEmpty()&&(this._current=e.Dequeue(),!this.targets.has(this._current));){for(let t of this._current.OutEdges)this.PassableOutEdge(t)&&this.ProcessNeighbor(e,t,t.Target);for(let t of this._current.InEdges.filter(this.PassableInEdge.bind))this.ProcessNeighbor(e,t,t.Source)}return this._visGraph.PreviosVertex(this._current)==null?null:this.CalculatePath()}PassableOutEdge(e){return this.targets.has(e.Target)||!hu.IsForbidden(e)}PassableInEdge(e){return this.targets.has(e.Source)||!hu.IsForbidden(e)}static IsForbidden(e){return(e.IsPassable!=null&&!e.IsPassable()||e)instanceof ar}ProcessNeighbor(e,t,i){let n=t.Length,o=this._current.Distance+n;o>=this.upperBound||(this.targets.has(i)&&(this.upperBound=o,this.closestTarget=i),this._visGraph.PreviosVertex(i)==null?(i.Distance=o,this._visGraph.SetPreviousEdge(i,t),e.Enqueue(i,o)):o<i.Distance&&(i.Distance=o,this._visGraph.SetPreviousEdge(i,t),e.DecreasePriority(i,o)))}CalculatePath(){if(this.closestTarget==null)return null;let e=new Array,t=this.closestTarget;do e.push(t),t=this._visGraph.PreviosVertex(t);while(t.Distance>0);return e.push(t),e.reverse()}};var Ns=class extends Pe{constructor(t,i,n,o,a,l,u,c,h,d){super(null);this.bundlingSettings=o,this.bundlingSettings.edgeWidthShrinkCoeff=1,this.edgesToRoute=t,this.regularEdges=t.filter(f=>f.source!==f.target),this.VisibilityGraph=n,this.shortestPathRouter=i,this.LoosePadding=a,this.LooseHierarchy=u,this.TightHierarchy=l,this.EdgeLooseEnterable=c,this.EdgeTightEnterable=h,this.loosePolylineOfPort=d,Ea(0)}ThereAreOverlaps(t){return ji(t,t,I.CurvesIntersect)}run(){if(this.ThereAreOverlaps(this.TightHierarchy)){this.Status=1;return}this.FixLocationsForHookAnywherePorts(this.edgesToRoute),this.RoutePathsWithSteinerDijkstra(),this.FixChildParentEdges(),this.bundlingSettings.StopAfterShortestPaths||this.OrderOptimizeNudgeEtc(),this.RouteSelfEdges(),this.FixArrowheads()}OrderOptimizeNudgeEtc(){let t=new cb(this.regularEdges,this.LooseHierarchy,this.TightHierarchy,this.bundlingSettings,this.shortestPathRouter.cdt,this.EdgeLooseEnterable,this.EdgeTightEnterable,this.loosePolylineOfPort);Yo.FixRouting(t,this.bundlingSettings),new Xa(t,this.bundlingSettings).run()}FixChildParentEdges(){for(let t of this.regularEdges){let i=t.sourcePort,n=t.targetPort;if(i.Curve.boundingBox.containsRect(n.Curve.boundingBox)){let o=I.intersectionOne(i.Curve,k.mkPP(t.curve.start,t.curve.end),!1),a=t.curve;a.startPoint.point=o.x}if(n.Curve.boundingBox.containsRect(i.Curve.boundingBox)){let o=I.intersectionOne(n.Curve,k.mkPP(t.curve.start,t.curve.end),!0),a=t.curve;a.endPoint.point=o.x}}}FixLocationsForHookAnywherePorts(t){for(let i of t){let n=i.sourcePort instanceof Mt;if(n){let o=i.sourcePort;o.SetLocation(this.FigureOutHookLocation(o.LoosePolyline,i.targetPort,i))}else if(n=i.targetPort instanceof Mt,n){let o=i.targetPort;o.SetLocation(this.FigureOutHookLocation(o.LoosePolyline,i.sourcePort,i))}}}FigureOutHookLocation(t,i,n){return i instanceof br?this.FigureOutHookLocationForClusterOtherPort(t,i,n):this.FigureOutHookLocationForSimpleOtherPort(t,i,n)}FigureOutHookLocationForClusterOtherPort(t,i,n){let o=this.shortestPathRouter.MakeTransparentShapesOfEdgeGeometry(n),l=new hu(Array.from(i.LoosePolyline).map(this.VisibilityGraph.FindVertex.bind),Array.from(t).map(this.VisibilityGraph.FindVertex.bind),this.VisibilityGraph).GetPath();for(let u of o)u.IsTransparent=!1;return l[l.length-1].point}FigureOutHookLocationForSimpleOtherPort(t,i,n){let o=i.Location,a=this.shortestPathRouter.MakeTransparentShapesOfEdgeGeometry(n),u=new xs(this.VisibilityGraph.FindVertex(o),Array.from(t).map(c=>this.VisibilityGraph.FindVertex(c)),this.VisibilityGraph).GetPath();for(let c of a)c.IsTransparent=!1;return u[u.length-1].point}RoutePathsWithSteinerDijkstra(){this.shortestPathRouter.VisibilityGraph=this.VisibilityGraph,this.shortestPathRouter.BundlingSettings=this.bundlingSettings,this.shortestPathRouter.geomEdges=this.regularEdges,this.shortestPathRouter.ObstacleHierarchy=this.LooseHierarchy,this.shortestPathRouter.RouteEdges(),this.shortestPathRouter.cdt!=null&&this.AdjustEdgeSeparation()}AdjustEdgeSeparation(){let t=new Map;this.shortestPathRouter.FillCrossedCdtEdges(t);let i=this.GetPathsOnCdtEdge(t);this.bundlingSettings.edgeWidthShrinkCoeff=this.CalculateEdgeWidthShrinkCoeff(i)}GetPathsOnCdtEdge(t){let i=new Map;for(let n of t.keys())for(let o of t.get(n))Ul(i,o,n);return i}CalculateEdgeWidthShrinkCoeff(t){let i=0,n=this.bundlingSettings.edgeWidthShrinkCoeff;if(this.EdgeSeparationIsOkMN(t,n))return n;let o=!1;for(;!o||Math.abs(n-i)>.01;){let a=(i+n)/2;this.EdgeSeparationIsOkMN(t,a)?(i=a,o=!0):n=a}return i}EdgeSeparationIsOkMN(t,i){for(let n of t.keys())if(!this.EdgeSeparationIsOk(n,t.get(n),i))return!1;return!0}EdgeSeparationIsOk(t,i,n){return Array.from(i).map(a=>this.bundlingSettings.ActualEdgeWidth(a,n)).reduce((a,l)=>a+l,0)<=t.Capacity}RouteSelfEdges(){for(let t of this.edgesToRoute)if(t.source===t.target){let i={smoothedPolyline:null};t.curve=Ye.RouteSelfEdge(t.source.boundaryCurve,this.LoosePadding*2,i)}}FixArrowheads(){for(let t of this.edgesToRoute)ut.trimSplineAndCalculateArrowheadsII(t,t.source.boundaryCurve,t.target.boundaryCurve,t.curve,!1)}};Ns.SuperLoosePaddingCoefficient=1.1;var fb=class{constructor(e,t,i){this.numberOfPassedPaths=0;this.VisibilityEdge=e,this.Source=t,this.Target=i}get TargetPoint(){return this.Target.Point}get SourcePoint(){return this.Source.Point}get IsOccupied(){return this.numberOfPassedPaths>0}get IsPassable(){return this.Target.IsTargetOfRouting||this.Source.IsSourceOfRouting||this.VisibilityEdge.IsPassable==null||this.VisibilityEdge.IsPassable()}AddOccupiedEdge(){this.numberOfPassedPaths++}RemoveOccupiedEdge(){this.numberOfPassedPaths--}};var gb=class{constructor(e){this.InBoneEdges=new Array;this.OutBoneEdges=new Array;this.VisibilityVertex=e}get Prev(){return this.PrevEdge==null?null:this.PrevEdge.Source===this?this.PrevEdge.Target:this.PrevEdge.Source}get Point(){return this.VisibilityVertex.point}get Cost(){return this.IsSourceOfRouting?this.cost:this.Prev==null?Number.POSITIVE_INFINITY:this.cost}set Cost(e){this.cost=e}SetPreviousToNull(){this.PrevEdge=null}};var Tn=class{constructor(e,t,i){this.EdgesToRoutes=new Map;this.EdgesToRouteSources=new Map;this.MakeTransparentShapesOfEdgeGeometry=e,this.cdt=t,this.Gates=i}CreateGraphElements(){for(let e of this.vertexArray){let t=e.VisibilityVertex;for(let i of t.InEdges){let n=new fb(i,this.VisibilityVerticesToSdVerts.get(i.Source),this.VisibilityVerticesToSdVerts.get(i.Target)),o=this.VisibilityVerticesToSdVerts.get(i.Source);e.InBoneEdges.push(n),o.OutBoneEdges.push(n)}}}CreateRoutingGraph(){this.vertexArray=[],this.VisibilityVerticesToSdVerts=new Map;for(let e of this.VisibilityGraph.Vertices()){let t=new gb(e);this.vertexArray.push(t),this.VisibilityVerticesToSdVerts.set(e,t)}this.CreateGraphElements()}RouteEdges(){this.Initialize(),this.RestoreCapacities();for(let e of this.geomEdges)this.EdgesToRoutes.set(e,this.RouteEdge(e));this.RerouteEdges();for(let e of this.geomEdges)this.SetEdgeGeometryCurve(e)}SetEdgeGeometryCurve(e){let t=new ne,i=this.EdgesToRouteSources.get(e);t.addPoint(i.Point);for(let a of this.EdgesToRoutes.get(e))a.SourcePoint.equal(i.Point)?(t.addPoint(a.TargetPoint),i=a.Target):(t.addPoint(a.SourcePoint),i=a.Source);e.curve=t,e.sourcePort instanceof br&&Tn.ExtendPolylineStartToClusterBoundary(t,e.sourcePort.Curve),e.targetPort instanceof br&&Tn.ExtendPolylineEndToClusterBoundary(t,e.targetPort.Curve)}static ExtendPolylineEndToClusterBoundary(e,t){let i=t.closestParameter(e.end);e.addPoint(t.value(i))}static ExtendPolylineStartToClusterBoundary(e,t){let i=t.closestParameter(e.start);e.PrependPoint(t.value(i))}RerouteEdges(){this.RestoreCapacities();for(let e of this.geomEdges){let t=this.RerouteEdge(e);this.EdgesToRoutes.set(e,t)}}RestoreCapacities(){this.cdt!=null&&this.cdt.RestoreEdgeCapacities()}RerouteEdge(e){let t=this.EdgesToRoutes.get(e);for(let i of t)i.RemoveOccupiedEdge();return this.RouteEdge(e)}RouteEdge(e){this.CurrentEdgeGeometry=e;for(let n=0;n<this.vertexArray.length;n++){let o=this.vertexArray[n];o.SetPreviousToNull(),o.IsTargetOfRouting=o.IsSourceOfRouting=!1}let t=this.MakeTransparentShapesOfEdgeGeometry(e),i=this.RouteEdgeWithGroups();for(let n of t)n.IsTransparent=!1;return i}RouteEdgeWithGroups(){for(let e=0;e<2;e++){this.SetLengthCoefficient(),this.Queue=new Er,this.sourceLoosePoly=this.SetPortVerticesAndObstacles(this.CurrentEdgeGeometry.sourcePort,!0),this.targetLoosePoly=this.SetPortVerticesAndObstacles(this.CurrentEdgeGeometry.targetPort,!1);let t=this.RouteOnKnownSourceTargetVertices(this.CurrentEdgeGeometry.targetPort.Location.sub(this.CurrentEdgeGeometry.sourcePort.Location).normalize(),e===0);if(t!=null)return t;for(let i=0;i<this.vertexArray.length;i++)this.vertexArray[i].SetPreviousToNull()}throw new Error}RouteOnKnownSourceTargetVertices(e,t){for(this.LowestCostToTarget=Number.POSITIVE_INFINITY,this.ClosestTargetVertex=null;this.Queue.count>0;){let i={priority:0},n=this.Queue.DequeueAndGetPriority(i);if(!(i.priority>=this.LowestCostToTarget)){for(let o=0;o<n.OutBoneEdges.length;o++){let a=n.OutBoneEdges[o];a.IsPassable&&this.ProcessOutcomingBoneEdge(n,a,e,t)}for(let o=0;o<n.InBoneEdges.length;o++){let a=n.InBoneEdges[o];a.IsPassable&&this.ProcessIncomingBoneEdge(n,a,e,t)}}}return this.GetPathAndUpdateRelatedCosts()}ProcessOutcomingBoneEdge(e,t,i,n){n&&i.dot(t.TargetPoint.sub(t.SourcePoint))<0||this.ProcessBoneEdge(e,t.Target,t)}ProcessIncomingBoneEdge(e,t,i,n){n&&i.dot(t.SourcePoint.sub(t.TargetPoint))<0||this.ProcessBoneEdge(e,t.Source,t)}ProcessBoneEdge(e,t,i){let n=this.GetEdgeAdditionalCost(i,e.Cost);if(!(t.Cost<=n))if(t.Cost=n,t.PrevEdge=i,this.Queue.ContainsElement(t))this.Queue.DecreasePriority(t,n);else{if(t.IsTargetOfRouting){let o=0;this.CurrentEdgeGeometry.targetPort instanceof br&&(o=this.LengthCoefficient*t.Point.sub(this.CurrentEdgeGeometry.targetPort.Location).length),n+o<this.LowestCostToTarget&&(this.LowestCostToTarget=n+o,this.ClosestTargetVertex=t);return}this.Enqueue(t)}}GetPathAndUpdateRelatedCosts(){let e=this.ClosestTargetVertex;if(e==null)return null;let t=new Array;for(;e.PrevEdge!=null;)t.push(e.PrevEdge),this.RegisterPathInBoneEdge(e.PrevEdge),e=e.Prev;return this.EdgesToRouteSources.set(this.CurrentEdgeGeometry,e),t.reverse(),t}RegisterPathInBoneEdge(e){e.AddOccupiedEdge(),this.cdt!=null&&this.BundlingSettings.CapacityOverflowCoefficient!==0&&this.UpdateResidualCostsOfCrossedCdtEdges(e)}UpdateResidualCostsOfCrossedCdtEdges(e){for(let t of e.CrossedCdtEdges)this.AdjacentToSourceOrTarget(t)||(t.ResidualCapacity===t.Capacity?t.ResidualCapacity-=this.BundlingSettings.edgeWidthShrinkCoeff*this.CurrentEdgeGeometry.lineWidth:t.ResidualCapacity-=this.BundlingSettings.ActualEdgeWidth(this.CurrentEdgeGeometry))}H(e){return e.Cost+this.LengthCoefficient*e.Point.sub(this.CurrentEdgeGeometry.targetPort.Location).length}GetEdgeAdditionalCost(e,t){let i=e.TargetPoint.sub(e.SourcePoint).length;return this.LengthCoefficient*i+t+(e.IsOccupied?0:this.BundlingSettings.InkImportance*i)+this.CapacityOverflowCost(e)}CapacityOverflowCost(e){if(this.cdt==null||this.BundlingSettings.CapacityOverflowCoefficient===0)return 0;let t=0;for(let i of this.CrossedCdtEdgesOfBoneEdge(e))t+=this.CostOfCrossingCdtEdgeLocal(this.capacityOverlowPenaltyMultiplier,this.BundlingSettings,this.CurrentEdgeGeometry,i);return t}CrossedCdtEdgesOfBoneEdge(e){return e.CrossedCdtEdges!=null?Array.from(e.CrossedCdtEdges):Array.from(e.CrossedCdtEdges=this.ThreadBoneEdgeThroughCdt(e))}ThreadBoneEdgeThroughCdt(e){let t=e.SourcePoint,i=e.Source.Triangle,n=new Set,o=e.TargetPoint;if(qe.PointIsInsideOfTriangle(o,i))return n;let a=new ja(i,t,o);for(;a.MoveNext();){let l=a.CurrentPiercedEdge;this.Gates.has(l)&&n.add(l)}return n}static CostOfCrossingCdtEdge(e,t,i,n){let o=i.lineWidth*t.edgeWidthShrinkCoeff;n.Capacity!==n.ResidualCapacity&&(o+=t.EdgeSeparation*t.edgeWidthShrinkCoeff);let a=n.ResidualCapacity-o;return a>=0?0:-a*e}CostOfCrossingCdtEdgeLocal(e,t,i,n){return this.AdjacentToSourceOrTarget(n)?0:Tn.CostOfCrossingCdtEdge(e,t,i,n)}AdjacentToSourceOrTarget(e){return e.upperSite.Owner===this.sourceLoosePoly||e.lowerSite.Owner===this.sourceLoosePoly||e.upperSite.Owner===this.targetLoosePoly||e.lowerSite.Owner===this.targetLoosePoly}SetLengthCoefficient(){let e=this.GetIdealDistanceBetweenSourceAndTarget(this.CurrentEdgeGeometry);this.LengthCoefficient=this.BundlingSettings.PathLengthImportance/e}GetIdealDistanceBetweenSourceAndTarget(e){return e.sourcePort.Location.sub(e.targetPort.Location).length}SetPortVerticesAndObstacles(e,t){let i;if(e instanceof br){i=e.LoosePolyline;for(let o of i){let a=0;t&&(a=this.LengthCoefficient*o.sub(this.CurrentEdgeGeometry.sourcePort.Location).length),this.AddAndEnqueueVertexToEnds(o,t,a)}}else if(e instanceof Mt){i=e.LoosePolyline;for(let o of i)this.AddAndEnqueueVertexToEnds(o,t,0)}else{this.AddAndEnqueueVertexToEnds(e.Location,t,0);let n=Array.from(this.ObstacleHierarchy.GetNodeItemsIntersectingRectangle(e.Curve.boundingBox)),o=n[0].boundingBox.diagonal;i=n[0];for(let a=1;a<n.length;a++){let l=n[a],u=l.boundingBox.diagonal;u<o&&(o=u,i=l)}}return i}Enqueue(e){this.Queue.Enqueue(e,this.H(e))}AddAndEnqueueVertexToEnds(e,t,i){let n=this.FindVertex(e),o=this.VisibilityVerticesToSdVerts.get(n);t?(o.IsSourceOfRouting=!0,o.Cost=i,this.Enqueue(o)):o.IsTargetOfRouting=!0}FindVertex(e){return this.VisibilityGraph.FindVertex(e)}Initialize(){this.CreateRoutingGraph(),this.cdt!=null&&(this.capacityOverlowPenaltyMultiplier=Tn.CapacityOverflowPenaltyMultiplier(this.BundlingSettings),this.SetVertexTriangles(),this.CalculateCapacitiesOfTrianglulation())}CalculateCapacitiesOfTrianglulation(){for(let e of this.Gates)Tn.CalculateCdtEdgeCapacityForEdge(e)}static CalculateCdtEdgeCapacityForEdge(e){if(e.constrained||e.CwTriangle==null||e.CcwTriangle==null)return;let t=e.upperSite.Owner,i=e.lowerSite.Owner;if(t!==i){let n=Jt.DistancePoint(new Jt(t),e.lowerSite.point),o=Jt.DistancePoint(new Jt(i),e.upperSite.point);e.Capacity=(n+o)/2}}SetVertexTriangles(){let e=tt(Array.from(this.cdt.GetTriangles()).map(i=>ct(i,i.BoundingBox()))),t=tt(this.vertexArray.map(i=>ct(i,X.mkOnPoints([i.Point]))));yr(e,t,(i,n)=>this.TryToAssigenTriangleToVertex(i,n))}TryToAssigenTriangleToVertex(e,t){t.Triangle==null&&qe.PointIsInsideOfTriangle(t.Point,e)&&(t.Triangle=e)}static CapacityOverflowPenaltyMultiplier(e){return e.CapacityOverflowCoefficient*(e.PathLengthImportance+e.InkImportance)}FillCrossedCdtEdges(e){for(let t of this.geomEdges){this.sourceLoosePoly=this.SetPortVerticesAndObstacles(t.sourcePort,!0),this.targetLoosePoly=this.SetPortVerticesAndObstacles(t.targetPort,!1);for(let i of this.EdgesToRoutes.get(t))for(let n of this.CrossedCdtEdgesOfBoneEdge(i))this.AdjacentToSourceOrTarget(n)||Ul(e,t,n)}}};var du=class{constructor(e,t,i,n,o){this.multiEdges=e,this.interactiveEdgeRouter=t,this.bundlingSettings=n,this.bundlingSettings.edgeWidthShrinkCoeff=1,this.transparentShapeSetter=o,this.nodeTree=ms(i,a=>a.boundingBox)}run(){for(let e of this.GetIndependantPreGraphs())new Ns(e.edges,new Tn(this.transparentShapeSetter,null,null),this.interactiveEdgeRouter.VisibilityGraph,this.bundlingSettings,this.interactiveEdgeRouter.LoosePadding,this.interactiveEdgeRouter.TightHierarchy,this.interactiveEdgeRouter.LooseHierarchy,null,null,null).run()}GetPortCurve(e){return this.nodeTree.FirstHitNodeWithPredicate(e.Location,(i,n)=>I.PointRelativeToCurveLocation(i,n)!==0?1:0).UserData}GetIndependantPreGraphs(){let e=this.CreateInitialPregraphs();do{let t=e.length,i={preGraphs:e};if(this.UniteConnectedPreGraphs(i),t<=e.length)break}while(!0);return e}UniteConnectedPreGraphs(e){let t=du.GetIntersectionGraphOfPreGraphs(e.preGraphs);if(t==null)return;let i=Yn(t),n=new Array;for(let o of i){let a=null;for(let l of o)a==null?(a=e.preGraphs[l],n.push(a)):a.AddGraph(e.preGraphs[l])}e.preGraphs=n;for(let o of e.preGraphs)this.AddIntersectingNodes(o)}AddIntersectingNodes(e){let t=e.boundingBox;for(let i of this.nodeTree.GetNodeItemsIntersectingRectangle(t))e.AddNodeBoundary(i)}static GetIntersectionGraphOfPreGraphs(e){let t=du.EnumeratePairsOfIntersectedPreGraphs(e);return t.length?Sr(t,e.length):null}static EnumeratePairsOfIntersectedPreGraphs(e){let t=Array.from(Array(e.length).keys()),i=ms(t,o=>e[o].boundingBox),n=new Array;return Vt(i,i,(o,a)=>n.push(new me(o,a))),n}CreateInitialPregraphs(){return this.multiEdges.map(e=>this.CreatePregraphFromSetOfEdgeGeometries(e))}CreatePregraphFromSetOfEdgeGeometries(e){let t=new Set,i=e[0],n=this.GetPortCurve(i.sourcePort),o=n.boundingBox;t.add(n),t.add(i.targetPort.Curve),o.addRec(i.targetPort.Curve.boundingBox);let a=this.nodeTree.GetNodeItemsIntersectingRectangle(o);for(let l of a)t.add(l);return $c.constructorStatic(e,t)}};var OA=Ae(zn(),1);var pb=class{constructor(){this.triangles=new Set}setCdt(e){this.cdt=e,this.cdt.SetInEdges();let t=new Set;for(let i of e.GetTriangles())for(let n of i.Sites)n.Owner!=null&&t.add(n.Owner)}outsideOfObstacles(e){var i;if(e==null)return!1;let t=(i=e.Sites.item0.Owner)!=null?i:e.Sites.item1.Owner;return t===this.sourcePoly||t===this.targetPoly||!GN(e)}run(e){if(this.triangles.clear(),this.poly=e,this.d=[],e.count<=2||this.cdt==null)return;this.sourcePoly=this.findPoly(e.start),this.targetPoly=this.findPoly(e.end),this.findChannelTriangles();let t=this.getPerimeterEdges();t=this.fillTheCollapedSites(t);let i=new qe([],[],Array.from(t).map(o=>({A:o.lowerSite.point,B:o.upperSite.point})));i.run();let n=this.getSleeve(this.findSourceTriangle(i));if(n==null){console.log("failed to create sleeve");return}if(n.length==0){this.poly=ne.mkFromPoints([e.start,e.end]);return}this.initDiagonals(n),this.refineFunnel()}getAllCrossedTriangles(e,t,i){let n=[],o=[],a=null;for(o.push(e);o.length>0;){let l=o.pop();if(a==null&&l.containsPoint(i)&&(a=l),l.intersectsLine(t,i,0)){n.push(l);for(let u of l.Edges){let c=u.GetOtherTriangle_T(l);c&&!n.includes(c)&&!o.includes(c)&&o.push(c)}}}return{triangles:n,containsEnd:a}}findChannelTriangles(){let t=this.cdt.FindSite(this.poly.start).Triangles().next().value;this.triangles.clear();for(let i=this.poly.startPoint;i.next!=null;i=i.next){let n=this.getAllCrossedTriangles(t,i.point,i.next.point);t=n.containsEnd;for(let o of n.triangles)this.outsideOfObstacles(o)&&this.triangles.add(o)}}findPoly(e){var i;let t=this.cdt.FindSite(e);for(let n of t.Edges)return(i=n.lowerSite.Owner)!=null?i:n.upperSite.Owner}fillTheCollapedSites(e){let t=new Map;for(let o of e)n(o.lowerSite,o),n(o.upperSite,o);let i=[];for(let[o,a]of t)a.length>2&&i.push(o);if(i.length==0)return e;for(let o of i)for(let a of o.Triangles())this.outsideOfObstacles(a)&&this.triangles.add(a);return this.getPerimeterEdges();function n(o,a){let l=t.get(o);l==null&&t.set(o,l=[]),l.push(a)}}findSourceTriangle(e){let t;for(let i of e.GetTriangles())if(i.containsPoint(this.poly.start)){t=i;break}return t}refineFunnel(){let e=[],t=this.poly.start,i={point:t},n={point:t},o={point:this.d[0].left,prev:i},a={point:this.d[0].right,prev:n};i.next=o,n.next=a;let l;for(let A=1;A<this.d.length;A++)c(A,this.d);this.d.push({right:this.poly.end,left:o.point}),c(this.d.length-1,this.d);let u=ne.mkFromPoints(e);for(let A=n;A!=null;A=A.next)u.addPoint(A.point);this.poly=u;function c(A,N){if(N[A-1].left!==N[A].left){l=N[A].left;let Y=o;for(;!(C(Y)||f(Y));Y=Y.prev);C(Y)?S():B(Y)}else{l=N[A].right;let Y=a;for(;!(C(Y)||p(Y));Y=Y.prev);C(Y)?E():O(Y)}}function h(A){return A.next==null?!0:m.pointToTheLeftOfLineOrOnLine(l,A.point,A.next.point)}function d(A){return A.next==null?!0:m.pointToTheRightOfLineOrOnLine(l,A.point,A.next.point)}function f(A){return m.pointToTheLeftOfLine(l,A.prev.point,A.point)}function p(A){return m.pointToTheRightOfLine(l,A.prev.point,A.point)}function S(){let A=n;for(;!h(A);)A=A.next;if(!C(A)){let N=n;for(;!N.point.equal(A.point);N=N.next)e.push(N.point);n.point=N.point,n.next=N.next,t=N.point,a.point.equal(n.point)&&(a.prev=a.next=null)}i.point=t,o.point=l,o.prev=i,i.next=o}function E(){let A=i;for(;!d(A);)A=A.next;if(!C(A)){let N=i;for(;!N.point.equal(A.point);N=N.next)e.push(N.point);i.point=N.point,i.next=N.next,t=N.point,o.point.equal(i.point)&&(o.prev=i.next=null)}n.point=t,a.point=l,a.prev=n,n.next=a}function C(A){return A.point==t}function O(A){A!=a?(a.point=l,a.prev=A,A.next=a):(a={point:l,prev:A},A.next=a)}function B(A){A!=o?(o.point=l,o.prev=A,A.next=o):(o={point:l,prev:A},A.next=o)}}initDiagonals(e){for(let t of e){let i=t.edge,n=t.source.OppositeSite(i);m.getTriangleOrientation(n.point,i.lowerSite.point,i.upperSite.point)==1?this.d.push({left:i.upperSite.point,right:i.lowerSite.point}):this.d.push({right:i.upperSite.point,left:i.lowerSite.point})}}getSleeve(e){let t=new OA.Queue;t.enqueue(e);let i=new Map;for(i.set(e,void 0);t.length>0;){let n=t.dequeue(),o=i.get(n);if(n.containsPoint(this.poly.end))return this.recoverPath(e,i,n);for(let a of n.Edges){if(a.constrained||o!==void 0&&a===o)continue;let l=a.GetOtherTriangle_T(n);l!=null&&(i.has(l)||(i.set(l,a),t.enqueue(l)))}}}recoverPath(e,t,i){let n=[];for(let o=i;o!=e&&o!==e;){let a=t.get(o);o=a.GetOtherTriangle_T(o),n.push({source:o,edge:a})}return n.reverse()}getPerimeterEdges(){let e=new Set;for(let t of this.triangles)for(let i of t.Edges)this.triangles.has(i.GetOtherTriangle_T(t))||e.add(i);return e}};function GN(s){return s.Sites.item0.Owner==null||s.Sites.item1.Owner==null||s.Sites.item2.Owner==null?!0:s.Sites.item0.Owner==s.Sites.item1.Owner&&s.Sites.item0.Owner==s.Sites.item2.Owner}var ke=class extends Pe{constructor(t,i,n=1,o=2,a=30*(Math.PI/180),l=null,u=null){super(u);this.continueOnOverlaps=!0;this.shapesToTightLooseCouples=new Map;this.multiEdgesSeparation=.5;this.routeMultiEdgesAsBundles=!0;this.UsePolylineEndShortcutting=!0;this.UseInnerPolylingShortcutting=!0;this.AllowedShootingStraightLines=!0;this._overlapsDetected=!1;this.edges=i,this.BundlingSettings=l,this.geomGraph=t,this.LoosePadding=o,this.tightPadding=n,this.coneAngle=a,this.routeMultiEdgesAsBundles=i.length<1e3&&t.deepNodeCount<1e3}get ContinueOnOverlaps(){return this.continueOnOverlaps}set ContinueOnOverlaps(t){this.continueOnOverlaps=t}get LoosePadding(){return this.loosePadding}set LoosePadding(t){this.loosePadding=t}get MultiEdgesSeparation(){return this.multiEdgesSeparation}set MultiEdgesSeparation(t){this.multiEdgesSeparation=t}static mk2(t,i){return ke.mk5(t,i.Padding,i.PolylinePadding,i.ConeAngle,i.bundlingSettings)}static mk4(t,i,n,o){return new ke(t,Array.from(t.deepEdges),i,n,o,null)}static mk5(t,i,n,o,a){return new ke(t,Array.from(t.deepEdges),i,n,o,a)}static mk6(t,i,n,o,a,l){let u=ke.mk4(t,i,n,o),c=Ti.GetShapes(a,l);return u.Initialize(c,o),u}Initialize(t,i){this.rootShapes=t.filter(n=>n.Parents==null||n.Parents.length===0),this.coneAngle=i,this.coneAngle===0&&(this.coneAngle=Math.PI/6)}run(){if(this.edges.length==0||this.geomGraph.isEmpty())return;console.time("SplineRouter");let t=xr.GetShapes(this.geomGraph,this.edges);this.BundlingSettings==null&&this.geomGraph.layoutSettings&&this.geomGraph.layoutSettings.commonSettings.edgeRoutingSettings&&this.geomGraph.layoutSettings.commonSettings.edgeRoutingSettings.bundlingSettings&&(this.BundlingSettings=this.geomGraph.layoutSettings.commonSettings.edgeRoutingSettings.bundlingSettings),this.Initialize(t,this.coneAngle),this.GetOrCreateRoot(),this.RouteOnRoot(),this.RemoveRoot(),console.timeEnd("SplineRouter")}rerouteOnSubsetOfNodes(t){this.RouteMultiEdgesAsBundles=!1,this.edges=Array.from(this.geomGraph.deepEdges).filter(n=>Ac(n.edge,t));let i=xr.GetShapes(this.geomGraph,this.edges);this.rootShapes=i.filter(n=>n.Parents==null||n.Parents.length===0),this.GetOrCreateRoot(),this.CalculateShapeToBoundaries(this.root),this.calcLooseShapesToNodes(),this.CalculatePortsToShapes(),this.rerouteOnActiveNodes(t),this.RemoveRoot()}calcLooseShapesToNodes(){if(this.loosePolylinesToNodes=new Map,!this.OverlapsDetected){for(let[n,o]of this.shapesToTightLooseCouples)this.loosePolylinesToNodes.set(o.LooseShape.BoundaryCurve,new Set([n.node.node]));return}let t=ms(this.geomGraph.nodesBreadthFirst,n=>n.boundingBox),i=this.GetLooseHierarchy();yr(i,t,(n,o)=>{if(I.CurveIsInsideOther(o.boundaryCurve,n)){let a=this.loosePolylinesToNodes.get(n);for(let l of o.getAncestors())if(!(l instanceof be&&l.parent==null)&&l.boundaryCurve!=null&&I.CurveIsInsideOther(l.boundaryCurve,n))return;a==null&&this.loosePolylinesToNodes.set(n,a=new Set),a.add(o.node)}})}RouteOnRoot(){Ea(0),this.CalculatePortsToShapes(),this.CalculatePortsToEnterableShapes(),this.CalculateShapeToBoundaries(this.root),!(this.OverlapsDetected&&!this.ContinueOnOverlaps)&&(this.BindLooseShapes(),this.SetLoosePolylinesForAnywherePorts(),this.CalculateVisibilityGraph(),this.RouteOnVisGraph())}CalculatePortsToEnterableShapes(){this.portsToEnterableShapes=new Map;for(let[t,i]of this.portsToShapes){let n=new Set;ke.EdgesAttachedToPortAvoidTheNode(t)||n.add(i),this.portsToEnterableShapes.set(t,n)}for(let t of this.rootShapes)for(let i of t.Descendants())for(let n of i.Ports){let o=this.portsToEnterableShapes.get(n);ua(o,Array.from(i.Ancestors()).filter(a=>a.BoundaryCurve!=null))}}static EdgesAttachedToPortAvoidTheNode(t){return t instanceof Pr||t instanceof br}SetLoosePolylinesForAnywherePorts(){for(let[t,i]of this.shapesToTightLooseCouples)for(let n of t.Ports){if(n instanceof Mt){let a=n;a.LoosePolyline=i.LooseShape.BoundaryCurve}if(n instanceof br){let a=n;a.LoosePolyline=i.LooseShape.BoundaryCurve}}}BindLooseShapes(){this.looseRoot=new Wn;for(let t of this.root.Children){let i=this.shapesToTightLooseCouples.get(t).LooseShape;this.BindLooseShapesUnderShape(t),this.looseRoot.AddChild(i)}}BindLooseShapesUnderShape(t){let i=this.shapesToTightLooseCouples.get(t).LooseShape;for(let n of t.Children){let o=this.shapesToTightLooseCouples.get(n).LooseShape;i.AddChild(o),this.BindLooseShapesUnderShape(n)}}CalculateShapeToBoundaries(t){if(this.ProgressStep(),t.Children.length===0)return;for(let n of t.Children)this.CalculateShapeToBoundaries(n);let i=Number.POSITIVE_INFINITY;if(t instanceof Do){let o=t.node.padding;this.tightPadding=Math.min(this.tightPadding,.4*o),i=.4*o}this.obstacleCalculator=new Nc(t,this.tightPadding,Math.min(this.AdjustedLoosePadding,i),this.shapesToTightLooseCouples),this.obstacleCalculator.Calculate(.01),this.OverlapsDetected||(this.OverlapsDetected=this.obstacleCalculator.OverlapsDetected)}get OverlapsDetected(){return this._overlapsDetected}set OverlapsDetected(t){this._overlapsDetected=t}get AdjustedLoosePadding(){return this.BundlingSettings==null?this.LoosePadding:this.LoosePadding*Ns.SuperLoosePaddingCoefficient}GroupEdgesByPassport(){let t=new Array;for(let i of this.edges){let n=this.EdgePassport(i),o=t.find(a=>Vl(a.passport,n));o||(o={passport:n,edges:[]},t.push(o)),o.edges.push(i)}return t}RouteOnVisGraph(){if(this.ancestorSets=ke.GetAncestorSetsMap(Array.from(this.root.Descendants())),this.BundlingSettings==null){let t=this.GroupEdgesByPassport();for(let i=0;i<t.length;i++){let n=t[i],o=n.passport,a=this.GetObstaclesFromPassport(o),l=this.CreateInteractiveEdgeRouter(Array.from(a));this.RouteEdgesWithTheSamePassport(n,l,a)}}else this.RouteBundles()}rerouteOnActiveNodes(t){if(this.ancestorSets=ke.GetAncestorSetsMap(Array.from(this.root.Descendants())),this.BundlingSettings==null)for(let i of this.GroupEdgesByPassport()){let n=i.passport,o=this.GetObstaclesFromPassport(n),a=new Set;for(let u of o){let c=this.LooseShapeOfOriginalShape(u);for(let h of this.loosePolylinesToNodes.get(c.BoundaryCurve))t.has(h)&&a.add(u)}let l=this.CreateInteractiveEdgeRouter(Array.from(a));this.rerouteEdgesWithTheSamePassportActiveNodes(i,l,a,t)}else this.RouteBundles()}getDebugCurvesFromEdgesAndCdt(t){let i=Array.from(this.geomGraph.deepEdges).map(n=>n.curve).filter(n=>n!=null).filter(n=>n.count>5).map(n=>Ie.mkDebugCurveTWCI(200,1,"Red",n));for(let n of t.PointsToSites.values())for(let o of n.Edges)i.push(Ie.mkDebugCurveTWCI(200,.5,o.constrained?"Blue":"Green",k.mkPP(o.lowerSite.point,o.upperSite.point)));return i}RouteEdgesWithTheSamePassport(t,i,n){let o={regularEdges:[],multiEdges:[]};try{let a=this.getCdtFromPassport(n);i.pathOptimizer.setCdt(a)}catch(a){i.pathOptimizer.setCdt(null)}if(this.RouteMultiEdgesAsBundles){if(this.SplitOnRegularAndMultiedges(t.edges,o),o.regularEdges.length>0)for(let a=0;a<o.regularEdges.length;a++)this.routeEdge(i,o.regularEdges[a]);o.multiEdges!=null&&(this.ScaleDownLooseHierarchy(i,n),this.RouteMultiEdges(o.multiEdges,i,t.passport))}else for(let a=0;a<t.edges.length;a++)this.routeEdge(i,t.edges[a])}rerouteEdgesWithTheSamePassportActiveNodes(t,i,n,o){let a={regularEdges:[],multiEdges:[]};try{let l=this.getCdtFromPassport(n);i.pathOptimizer.setCdt(l)}catch(l){console.log(l),i.pathOptimizer.setCdt(null)}if(this.RouteMultiEdgesAsBundles){if(this.SplitOnRegularAndMultiedges(t.edges,a),a.regularEdges.length>0)for(let l=0;l<a.regularEdges.length;l++){let u=a.regularEdges[l];Ce.assert(Ac(u.edge,o)),this.rerouteEdge(i,u)}a.multiEdges!=null&&(this.ScaleDownLooseHierarchy(i,n),this.RouteMultiEdges(a.multiEdges,i,t.passport))}else for(let l=0;l<t.edges.length;l++){let u=t.edges[l];Ac(u.edge,o)&&this.rerouteEdge(i,u)}}rerouteEdge(t,i){try{t.rerouteEdge(i),ut.trimSplineAndCalculateArrowheadsII(i,i.sourcePort.Curve,i.targetPort.Curve,i.curve,!1)}catch(n){console.log("failed")}}getCdtFromPassport(t){let i=new Set,n=[],o=X.mkEmpty();for(let u of t){let c=this.LoosePolyOfOriginalShape(u);if(c!=null){i.add(c);for(let h of u.Ports)n.push(h.Location);o.addRecSelf(c.boundingBox)}}o.pad(Math.max(o.diagonal/4,100));let a=Array.from(i);a.push(o.perimeter());let l=new qe(n,a,[]);return l.run(),l}get RouteMultiEdgesAsBundles(){return this.routeMultiEdgesAsBundles}set RouteMultiEdgesAsBundles(t){this.routeMultiEdgesAsBundles=t}routeEdge(t,i){let n=this.makeTransparentShapesOfEdgeAndGetTheShapes(i);this.ProgressStep(),this.RouteEdgeInternal(i,t),ke.SetTransparency(n,!1)}ScaleDownLooseHierarchy(t,i){let n=new Array;for(let o of i){let a=this.shapesToTightLooseCouples.get(o);n.push($t.LoosePolylineWithFewCorners(a.TightPolyline,a.Distance/1.1,0))}t.LooseHierarchy=ke.CreateLooseObstacleHierarachy(n),t.ClearActivePolygons(),t.AddActivePolygons(n.map(o=>new Jt(o)))}RouteMultiEdges(t,i,n){let o=[];for(let u of n)for(let c of u.Children)o.push(c.BoundaryCurve);let a=new Sn;a.InkImportance=1e-5,a.EdgeSeparation=this.MultiEdgesSeparation,new du(t,i,o,a,u=>this.makeTransparentShapesOfEdgeAndGetTheShapes(u)).run()}SplitOnRegularAndMultiedges(t,i){let n=new Zn;for(let o of t)ke.IsEdgeToParent(o)?i.regularEdges.push(o):ke.RegisterInPortLocationsToEdges(o,n);i.multiEdges=null;for(let o of n.values())o.length===1||this.OverlapsDetected?Io(i.regularEdges,o):(i.multiEdges==null&&(i.multiEdges=new Array),i.multiEdges.push(o))}static RegisterInPortLocationsToEdges(t,i){let n,o=new xt(t.sourcePort.Location,t.targetPort.Location);n=i.get(o),n||(n=new Array,i.set(o,n)),n.push(t)}static IsEdgeToParent(t){return t.sourcePort instanceof Mt||t.targetPort instanceof Mt}CreateInteractiveEdgeRouter(t){let i=new Set(t.map(o=>this.shapesToTightLooseCouples.get(o).LooseShape.BoundaryCurve)),n=new je(this.cancelToken);return n.pathOptimizer=new pb,n.ObstacleCalculator=new $t(t.map(o=>o.BoundaryCurve),this.tightPadding,this.loosePadding,!1),n.VisibilityGraph=this.visGraph,n.TightHierarchy=this.CreateTightObstacleHierarachy(t),n.LooseHierarchy=ke.CreateLooseObstacleHierarachy(Array.from(i)),n.UseSpanner=!0,n.LookForRoundedVertices=!0,n.TightPadding=this.tightPadding,n.LoosePadding=this.LoosePadding,n.UseEdgeLengthMultiplier=this.UseEdgeLengthMultiplier,n.UsePolylineEndShortcutting=this.UsePolylineEndShortcutting,n.UseInnerPolylingShortcutting=this.UseInnerPolylingShortcutting,n.AllowedShootingStraightLines=this.AllowedShootingStraightLines,n.AddActivePolygons(Array.from(i).map(o=>new Jt(o))),n}GetObstaclesFromPassport(t){if(t.size===0)return new Set(this.root.Children);let i=this.GetCommonAncestorsAbovePassport(t),n=this.GetAllAncestors(t),o=new Set;for(let u of t)for(let c of u.Children)n.has(c)||o.add(c);let a=Vn(new Set(t),o),l=new _A.Queue;for(let u of t)i.has(u)||l.enqueue(u);for(;l.length>0;){let u=l.dequeue();for(let c of u.Parents){for(let h of c.Children)n.has(h)||o.add(h);!i.has(c)&&!a.has(c)&&(l.enqueue(c),a.add(c))}}return o}GetAllAncestors(t){if(t.size===0)return new Set;let i=new Set(t);for(let n of t)i=Vn(i,this.ancestorSets.get(n));return i}GetCommonAncestorsAbovePassport(t){if(t.size===0)return new Set;let i=Array.from(t),n=this.ancestorSets.get(i[0]);for(let o=1;o<i.length;o++){let a=i[o];n=Un(n,this.ancestorSets.get(a))}return n}RouteBundles(){this.ScaleLooseShapesDown(),this.CalculateEdgeEnterablePolylines();let t=this.GetLooseHierarchy(),i=Xm(t),n=new Tn(a=>this.makeTransparentShapesOfEdgeAndGetTheShapes(a),i,this.FindCdtGates(i));new Ns(this.edges,n,this.visGraph,this.BundlingSettings,this.LoosePadding,this.GetTightHierarchy(),t,this.enterableLoose,this.enterableTight,a=>this.LoosePolyOfOriginalShape(this.portsToShapes.get(a))).run()}CreateTheMapToParentLooseShapes(t,i){for(let n of t.Children){let a=this.shapesToTightLooseCouples.get(n).LooseShape.BoundaryCurve;i.set(a,t),this.CreateTheMapToParentLooseShapes(n,i)}}FindCdtGates(t){let i=new Map;this.CreateTheMapToParentLooseShapes(this.root,i);let n=new Set;for(let o of t.PointsToSites.values())for(let a of o.Edges){if(a.CwTriangle==null&&a.CcwTriangle==null)continue;let l=o.Owner,u=a.lowerSite.Owner;if(l===u)continue;let c=i.get(l);if(c){let h=i.get(u);c===h&&n.add(a)}}return n}CalculateEdgeEnterablePolylines(){this.enterableLoose=new Map,this.enterableTight=new Map;for(let t of this.edges){let i=new Set,n=new Set;this.GetEdgeEnterablePolylines(t,i,n),this.enterableLoose.set(t,i),this.enterableTight.set(t,n)}}GetEdgeEnterablePolylines(t,i,n){let o=this.portsToShapes.get(t.sourcePort),a=this.portsToShapes.get(t.targetPort);o!==this.root&&this.GetEnterablesForShape(o,i,n),a!==this.root&&this.GetEnterablesForShape(a,i,n)}GetEnterablesForShape(t,i,n){for(let o of this.ancestorSets.get(t)){let a=this.LoosePolyOfOriginalShape(o);a&&i.add(a);let l=this.TightPolyOfOriginalShape(o);l&&n.add(l)}}GetTightHierarchy(){return tt(Array.from(this.shapesToTightLooseCouples.values()).map(t=>ct(t.TightPolyline,t.TightPolyline.boundingBox)))}GetLooseHierarchy(){let t=new Set;for(let i of this.shapesToTightLooseCouples.values())t.add(i.LooseShape.BoundaryCurve);return tt(Array.from(t).map(i=>ct(i,i.boundingBox)))}ScaleLooseShapesDown(){for(let[,t]of this.shapesToTightLooseCouples)t.LooseShape.BoundaryCurve=$t.LoosePolylineWithFewCorners(t.TightPolyline,t.Distance/Ns.SuperLoosePaddingCoefficient,0)}EdgePassport(t){let i=new Set,n=this.portsToShapes.get(t.sourcePort),o=this.portsToShapes.get(t.targetPort);return this.IsAncestor(n,o)?(ua(i,o.Parents),i.add(n),i):this.IsAncestor(o,n)?(ua(i,n.Parents),i.add(o),i):(n!==this.looseRoot&&ua(i,n.Parents),o!==this.looseRoot&&ua(i,o.Parents),i)}*AllPorts(){for(let t of this.edges)yield t.sourcePort,yield t.targetPort}CalculatePortsToShapes(){this.portsToShapes=new Map;for(let t of this.root.Descendants())for(let i of t.Ports)this.portsToShapes.set(i,t);for(let t of this.AllPorts())this.portsToShapes.has(t)||(this.root.Ports.add(t),this.portsToShapes.set(t,this.root))}RouteEdgeInternal(t,i){let n=new Array;t.sourcePort instanceof Mt||Io(n,this.AddVisibilityEdgesFromPort(t.sourcePort)),t.targetPort instanceof Mt||Io(n,this.AddVisibilityEdgesFromPort(t.targetPort));let o={smoothedPolyline:null};if(m.closeDistEps(t.sourcePort.Location,t.targetPort.Location)?t.curve=Ye.RouteSelfEdge(t.sourcePort.Curve,Math.max(this.LoosePadding*2,t.GetMaxArrowheadLength()),o):t.curve=i.RouteSplineFromPortToPortWhenTheWholeGraphIsReady(t.sourcePort,t.targetPort,!0,o),t.smoothedPolyline=null,t.curve==null)throw new Error;for(let a of n)Ke.RemoveEdge(a);ut.trimSplineAndCalculateArrowheadsII(t,t.sourcePort.Curve,t.targetPort.Curve,t.curve,!1)}*AddVisibilityEdgesFromPort(t){let i,n;if(t instanceof Pr||!(i=this.portsToShapes.get(t))||!(n=this.shapesToTightLooseCouples.get(i)))return;let o=n.LooseShape;for(let a of o.BoundaryCurve)this.visGraph.FindEdgePP(t.Location,a)==null&&(yield this.visGraph.AddEdgePP(t.Location,a))}makeTransparentShapesOfEdgeAndGetTheShapes(t){let i=this.portsToShapes.get(t.sourcePort),n=this.portsToShapes.get(t.targetPort),o=new Array;for(let a of this.GetTransparentShapes(t.sourcePort,t.targetPort,i,n))a!=null&&o.push(this.LooseShapeOfOriginalShape(a));for(let a of this.portsToEnterableShapes.get(t.sourcePort))o.push(this.LooseShapeOfOriginalShape(a));for(let a of this.portsToEnterableShapes.get(t.targetPort))o.push(this.LooseShapeOfOriginalShape(a));return ke.SetTransparency(o,!0),o}LooseShapeOfOriginalShape(t){return t===this.root?this.looseRoot:this.shapesToTightLooseCouples.get(t).LooseShape}LoosePolyOfOriginalShape(t){return this.LooseShapeOfOriginalShape(t).BoundaryCurve}TightPolyOfOriginalShape(t){return t===this.root?null:this.shapesToTightLooseCouples.get(t).TightPolyline}*GetTransparentShapes(t,i,n,o){for(let a of this.ancestorSets.get(n))yield a;for(let a of this.ancestorSets.get(o))yield a;ke.EdgesAttachedToPortAvoidTheNode(t)||(yield n),ke.EdgesAttachedToPortAvoidTheNode(i)||(yield o)}static SetTransparency(t,i){for(let n of t)n.IsTransparent=i}IsAncestor(t,i){let n;return i!=null&&(n=this.ancestorSets.get(i))!=null&&n.has(t)}static CreateLooseObstacleHierarachy(t){return tt(t.map(i=>ct(i,i.boundingBox)))}CreateTightObstacleHierarachy(t){let i=t.map(n=>this.shapesToTightLooseCouples.get(n).TightPolyline);return tt(i.map(n=>ct(n,n.boundingBox)))}CalculateVisibilityGraph(){let t=this.LineSweeperPorts!=null?He.mk(this.LineSweeperPorts):new He;this.ProcessHookAnyWherePorts(t),this.portRTree=ys(Array.from(t.values()).map(i=>[X.rectangleOnPoint(i),i])),this.visGraph=new Ke,this.FillVisibilityGraphUnderShape(this.root)}static ShowVisGraph(t,i,n,o=null,a=null){let l=Array.from(i.Edges).map(u=>Ie.mkDebugCurveTWCI(100,1,u.IsPassable!=null&&u.IsPassable()?"green":"black",k.mkPP(u.SourcePoint,u.TargetPoint)));if(n!=null)for(let u of n){l.push(Ie.mkDebugCurveTWCI(100,.3,"brown",u));for(let c of u)l.push(Ie.mkDebugCurveTWCI(100,1,"green",Fe.mkCircle(1,c)))}if(o!=null)for(let u of o)l.push(Ie.mkDebugCurveTWCI(100,10,"navy",u));if(a!=null)for(let u of a)l.push(Ie.mkDebugCurveTWCI(100,10,"red",u))}ProcessHookAnyWherePorts(t){for(let i of this.edges)i.sourcePort instanceof Mt||i.sourcePort instanceof br||t.add(i.sourcePort.Location),i.targetPort instanceof Mt||i.targetPort instanceof br||t.add(i.targetPort.Location)}FillVisibilityGraphUnderShape(t){let i=t.Children;for(let d=0;d<i.length;d++){let f=i[d];this.FillVisibilityGraphUnderShape(f)}let n=this.shapesToTightLooseCouples.get(t),o=n?n.LooseShape.BoundaryCurve:null,a=n?n.LooseShape:this.looseRoot,l=new Set(a.Children.map(d=>d.BoundaryCurve)),u=this.RemoveInsidePortsAndSplitBoundaryIfNeeded(o),c=new Ke,h=Bo.mk([],c,this.coneAngle,u,o);h.run(),c=new Ke,h=Bo.mk(Array.from(l),c,this.coneAngle,u,o),h.run(),this.ProgressStep();for(let d of c.Edges)this.TryToCreateNewEdgeAndSetIsPassable(d,a);this.AddBoundaryEdgesToVisGraph(o)}TryToCreateNewEdgeAndSetIsPassable(t,i){let n=this.visGraph.FindEdgePP(t.SourcePoint,t.TargetPoint);n==null&&(n=this.visGraph.AddEdgePP(t.SourcePoint,t.TargetPoint),i!=null&&(n.IsPassable=()=>i.IsTransparent))}AddBoundaryEdgesToVisGraph(t){if(t==null)return;let i;for(let n=t.startPoint;i=n.nextOnPolyline,this.visGraph.AddEdgePP(n.point,i.point),i!==t.startPoint;n=i);}RemoveInsidePortsAndSplitBoundaryIfNeeded(t){let i=new He;if(t==null){for(let a of this.portRTree.GetAllLeaves())i.add(a);return this.portRTree.clear(),i}let n=t.boundingBox,o=this.portRTree.GetAllIntersecting(n);for(let a of o)switch(I.PointRelativeToCurveLocation(a,t)){case 2:i.add(a),this.portRTree.Remove(X.rectangleOnPoint(a),a);break;case 1:this.portRTree.Remove(X.rectangleOnPoint(a),a);let l=ke.FindPointOnPolylineToInsertAfter(t,a);if(l!=null)Qt.InsertPointIntoPolylineAfter(t,l,a);else throw new Error;break}return i}static FindPointOnPolylineToInsertAfter(t,i){for(let n=t.startPoint;;){let o=n.nextOnPolyline;if(m.closeDistEps(i,n.point)||m.closeDistEps(i,o.point))return null;let a=m.distToLineSegment(i,n.point,o.point).dist;if(ue(a,0))return n;if(n=o,n===t.startPoint)throw new Error}}GetOrCreateRoot(){if(this.rootShapes.length===1){let t=this.rootShapes[0];if(t.BoundaryCurve==null){this.root=t;return}}this.rootWasCreated=!0,this.root=new Wn(null);for(let t of this.rootShapes)this.root.AddChild(t)}RemoveRoot(){if(!!this.rootWasCreated){for(let t of this.rootShapes)t.RemoveParent(this.root);this.root=null,this.rootWasCreated=!1}}static GetAncestorSetsMap(t){let i=new Map;for(let n of t.filter(o=>!i.has(o)))i.set(n,ke.GetAncestorSet(n,i));return i}static GetAncestorSet(t,i){let n=new Set(t.Parents);for(let o of t.Parents){let a=i.get(o);a||i.set(o,a=ke.GetAncestorSet(o,i));for(let l of a)n.add(l)}return n}static CreatePortsIfNeeded(t){for(let i of t){if(i.sourcePort==null){let n=i;new Or(()=>n.source.boundaryCurve,()=>n.source.center,new m(0,0))}if(i.targetPort==null){let n=i;new Or(()=>n.target.boundaryCurve,()=>n.target.center,new m(0,0))}}}};function IA(s,e,t){let i=fS(s);new ke(s,e,i.Padding,i.PolylinePadding,i.coneAngle,i.bundlingSettings,t).run()}var mf=class{constructor(e,t){this.numberOfNodesOnLevel=[];this.nodeScales=[];this.tileCapacity=500;this.levels=[];this.nodeIndexInSortedNodes=new Map;this.geomGraph=e,this.topLevelTileRect=t,this.tileSizes=[],this.tileSizes.push(t.size)}getTileData(e,t,i){let n=this.levels[i];return n?n.get(e,t):null}*getTilesOfLevel(e){let t=this.levels[e];if(t!=null)for(let[i,n]of t.keyValues())yield{x:i.x,y:i.y,data:n}}getMinTileSize(){let e=0,t=0,i=0;for(let n of this.geomGraph.nodesBreadthFirst)n instanceof be||(i==0?(e=n.width,t=n.height):(e=(i*e+n.width)/(i+1),t=(i*t+n.height)/(i+1)),i++);return new wt(e*10,t*10)}fillTheLowestLayer(){let e=new jr,t=new Ro(this.topLevelTileRect),i=t.arrowheads,n=t.labels;for(let a of this.geomGraph.graph.deepEdges)o(a);t.nodes=Array.from(this.geomGraph.nodesBreadthFirst),e.set(0,0,t),this.levels.push(e);function o(a){let l=Ye.getGeom(a),u=Ye.getGeom(a).curve;if(u instanceof I)for(let c of u.segs)t.addElement({edge:a,curve:c,startPar:c.parStart,endPar:c.parEnd});else t.addElement({edge:a,curve:u,startPar:u.parStart,endPar:u.parEnd});l.sourceArrowhead&&i.push({edge:l.edge,tip:l.sourceArrowhead.tipPosition,base:l.curve.start}),l.targetArrowhead&&i.push({edge:l.edge,tip:l.targetArrowhead.tipPosition,base:l.curve.end}),l.label&&n.push(l.label)}}buildUpToLevel(e){if(this.fillTheLowestLayer(),this.minTileSize=this.getMinTileSize(),this.pageRank=_0(this.geomGraph.graph,.85),!this.needToSubdivide())return 1;for(let i=1;i<=e&&!this.subdivideLevel(i);i++);this.sortedNodes=Array.from(this.pageRank.keys()).sort(this.compareByPagerank.bind(this));for(let i=0;i<this.sortedNodes.length;i++)this.nodeIndexInSortedNodes.set(this.sortedNodes[i],i);for(let i=0;i<this.levels.length-1;i++)this.numberOfNodesOnLevel.push(this.filterOutEntities(this.levels[i],i));this.numberOfNodesOnLevel.push(this.sortedNodes.length);let t=new ke(this.geomGraph,[]);for(let i=this.levels.length-2;i>=0;i--){let n=this.setOfNodesOnTheLevel(i);t.rerouteOnSubsetOfNodes(n),this.regenerateCurveClipsUpToLevel(i,n)}return this.calculateNodeRank(),this.levels.length}keepInsideGraphBoundingBox(e){let t=this.geomGraph.boundingBox,i=e.width/2,n=e.height/2;return Math.min((e.center.x-t.left)/i,(t.top-e.center.y)/n,(t.right-e.center.x)/i,(e.center.y-t.bottom)/n)}diminishScaleToAvoidTree(e,t,i){Ce.assert(t.intersects(i));let n,o=i.center.x,a=i.center.y,l=i.height/2,u=i.width/2;if(o<t.left)n=(t.left-o)/l;else if(o>t.right)n=(o-t.right)/l;else return 1;let c;if(a<t.bottom)c=(t.bottom-a)/u;else if(a>t.top)c=(a-t.top)/u;else return n;return Math.min(n,c)}needToSubdivide(){let e=!1;for(let t of this.levels[0].values())if(t.entityCount>this.tileCapacity){e=!0;break}return e}setOfNodesOnTheLevel(e){let t=new Set;for(let i of this.levels[e].values())for(let n of i.nodes)t.add(n.node);return t}regenerateCurveClipsUpToLevel(e,t){this.clearCurveClipsInLevelsUpTo(e);for(let i of this.levels[0].values())this.regenerateCurveClipsUnderTileUpToLevel(i,e,t)}clearCurveClipsInLevelsUpTo(e){for(let t=0;t<=e;t++)for(let i of this.levels[t].values())i.initCurveClips()}regenerateCurveClipsUnderTileUpToLevel(e,t,i){e.arrowheads=[],e.initCurveClips();for(let n of this.geomGraph.deepEdges)if(!!Ac(n.edge,i)){if(n.curve instanceof I)for(let o of n.curve.segs)e.addElement({edge:n.edge,curve:o,startPar:o.parStart,endPar:o.parEnd});else e.addElement({edge:n.edge,curve:n.curve,startPar:n.curve.parStart,endPar:n.curve.parEnd});n.sourceArrowhead&&e.arrowheads.push({edge:n.edge,tip:n.sourceArrowhead.tipPosition,base:n.curve.start}),n.targetArrowhead&&e.arrowheads.push({edge:n.edge,tip:n.targetArrowhead.tipPosition,base:n.curve.end})}for(let n=1;n<=t;n++)this.regenerateCurveClipsWhenPreviosLayerIsDone(n),this.removeEmptyTiles(n)}removeEmptyTiles(e){let t=this.levels[e],i=[];for(let[n,o]of t.keyValues())o.isEmpty()&&i.push(n);for(let n of i)t.delete(n.x,n.y)}regenerateCurveClipsWhenPreviosLayerIsDone(e){for(let[t,i]of this.levels[e-1].keyValues())this.subdivideTile(t,e,i,!0)}calculateNodeRank(){this.nodeRank=new Map;let e=this.sortedNodes.length,t=Math.log10(e);for(let i=0;i<e;i++)this.nodeRank.set(this.sortedNodes[i],t-Math.log10(i+1))}compareByPagerank(e,t){return this.pageRank.get(t)-this.pageRank.get(e)}filterOutEntities(e,t){let i=this.transferDataOfLevelToMap(e),n=0;for(;n<this.sortedNodes.length;n++){let o=this.sortedNodes[n];if(!this.addNodeToLevel(e,o,i))break}return this.removeEmptyTiles(t),n}addNodeToLevel(e,t,i){let n=i.get(t);for(let a of n)if(a.tile.entityCount>=this.tileCapacity)return!1;for(let a of n){let l=a.tile,u=a.data;l.addElement(u)}for(let a of t.selfEdges){let l=i.get(a);for(let u of l){let c=u.tile,h=u.data;c.addElement(h)}if(a.label)for(let u of i.get(a.label)){let c=u.tile,h=u.data;c.addElement(h)}}let o=this.nodeIndexInSortedNodes.get(t);for(let a of t.inEdges){let l=a.source;if(!(this.nodeIndexInSortedNodes.get(l)>o)){for(let c of i.get(a)){let h=c.tile,d=c.data;h.addElement(d)}if(a.label)for(let c of i.get(a.label)){let h=c.tile,d=c.data;h.addElement(d)}}}for(let a of t.outEdges){let l=a.target;if(!(this.nodeIndexInSortedNodes.get(l)>o)){for(let c of i.get(a)){let h=c.tile,d=c.data;h.addElement(d)}if(a.label)for(let c of i.get(a.label)){let h=c.tile,d=c.data;h.addElement(d)}}}return!0}transferDataOfLevelToMap(e){let t=new Map;for(let n of e.values()){for(let o of n.curveClips){let a=o.edge;i(a).push({tile:n,data:o})}for(let o of n.labels){let a=o.parent.edge;i(a).push({tile:n,data:o})}for(let o of n.nodes){let a=o.node;i(a).push({tile:n,data:o})}for(let o of n.arrowheads){let a=o.edge;i(a).push({tile:n,data:o})}n.clear()}return t;function i(n){let o=t.get(n);return o||t.set(n,o=new Array),o}}subdivideLevel(e){console.log("subdivideLevel",e);let t=Math.pow(2,e);if(this.levels[e]=new jr,this.subdivideTilesOnLevel(e))return console.log("done subdividing at level",e,"because each tile contains less than",this.tileCapacity),!0;let{w:n,h:o}=this.getWHOnLevel(e);return n<=this.minTileSize.width&&o<=this.minTileSize.height?(console.log("done subdividing at level",e," because of tile size = ",n,o,"is less than ",this.minTileSize),!0):!1}countClips(e){let t=0;for(let i of this.levels[e].values())t+=i.curveClips.length;return t}getWHOnLevel(e){for(let t=this.tileSizes.length;t<=e;t++){let i=this.tileSizes[t-1];this.tileSizes.push(new wt(i.width/2,i.height/2))}return{w:this.tileSizes[e].width,h:this.tileSizes[e].height}}subdivideTilesOnLevel(e){let i=!0;for(let[n,o]of this.levels[e-1].keyValues()){let a=this.subdivideTile(n,e,o,!1);i&&(i=a.allSmall)}return this.removeEmptyTiles(e),console.log("generated",this.levels[e].size,"tiles"),i}subdivideTile(e,t,i,n){let{w:o,h:a}=this.getWHOnLevel(t),l=this.levels[t],u=e.x,c=e.y,h=this.topLevelTileRect.left+u*o*2,d=this.topLevelTileRect.bottom+c*a*2,f=new Array(4);for(let A=0;A<2;A++)for(let N=0;N<2;N++)f[A*2+N]=new me(u*2+A,c*2+N);n||this.generateSubtilesWithoutTileClips(h,o,d,a,f,i,t);let p=new k(h,d+a,h+2*o,d+a),S=new k(h+o,d,h+o,d+2*a);O();let E=0,C=!0;for(let A of f){let N=l.get(A.x,A.y);N!=null&&(E++,N.entityCount>this.tileCapacity&&(C=!1))}return{count:E,allSmall:C};function O(){for(let A of i.curveClips){let N=A.curve,z=B(N,A.startPar,A.endPar);if(Ce.assert(z.length>=2),z.length==2){let Y=(z[0]+z[1])/2,ie=N.value(Y),he=ie.x<=h+o?0:1,ae=ie.y<=d+a?0:1,D=2*he+ae,_=f[D],W=l.getI(_);if(!W){let H=h+he*o,ee=d+ae*a;W=new Ro(new X({left:H,bottom:ee,top:ee+a,right:H+o})),l.setPair(_,W)}W.addCurveClip({curve:N,edge:A.edge,startPar:z[0],endPar:z[1]})}else for(let Y=0;Y<z.length-1;Y++){let ie=(z[Y]+z[Y+1])/2,he=N.value(ie),ae=he.x<=h+o?0:1,D=he.y<=d+a?0:1,_=2*ae+D,W=f[_],H=l.getI(W);if(!H){let ee=h+ae*o,oe=d+D*a;H=new Ro(new X({left:ee,bottom:oe,top:oe+a,right:ee+o})),l.setPair(W,H)}H.addCurveClip({curve:N,edge:A.edge,startPar:z[Y],endPar:z[Y+1]})}}}function B(A,N,z){let Y=Array.from(I.getAllIntersections(A,p,!0)).concat(Array.from(I.getAllIntersections(A,S,!0))).map(ie=>ie.par0);return Y.sort((ie,he)=>ie-he),[N].concat(Y.filter(ie=>ie>=N&&ie<=z)).concat(z)}}addSubtilesToLevel(e,t,i,n,o){for(let a=0;a<2;a++)for(let l=0;l<2;l++){let u=e[a*2+l];u.isEmpty()||(t.set(2*i+a,2*n+l,u),o&&u.entityCount>this.tileCapacity&&(o=!1))}return o}generateSubtilesWithoutTileClips(e,t,i,n,o,a,l){let u=0;for(let c=0;c<2;c++)for(let h=0;h<2;h++){let d=new X({left:e+t*c,right:e+t*(c+1),bottom:i+n*h,top:i+n*(h+1)}),f=this.generateOneSubtileExceptEdgeClips(a,d);f&&this.levels[l].set(o[u].x,o[u].y,f),u++}}innerClips(e,t,i){let n=[],o=Array.from(I.getAllIntersections(e,i,!0)).concat(Array.from(I.getAllIntersections(e,t,!0)));o.sort((l,u)=>l.par0-u.par0);let a=[e.parStart];for(let l=0;l<o.length;l++){let u=o[l];u.par0>a[a.length-1]+R.distanceEpsilon&&a.push(u.par0)}if(e.parEnd>a[a.length-1]+R.distanceEpsilon&&a.push(e.parEnd),a.length<=2)return n.push(e),n;for(let l=0;l<a.length-1;l++)n.push(e.trim(a[l],a[l+1]));return n}generateOneSubtileExceptEdgeClips(e,t){let i=new Ro(t);for(let n of e.nodes)n.boundingBox.intersects(t)&&i.nodes.push(n);for(let n of e.labels)n.boundingBox.intersects(t)&&i.labels.push(n);for(let n of e.arrowheads){let o=X.mkPP(n.base,n.tip),l=n.tip.sub(n.base).div(3).rotate90Cw();o.add(n.base.add(l)),o.add(n.base.sub(l)),o.intersects(t)&&i.arrowheads.push(n)}return i.isEmpty()?null:i}};var Ms=class extends Ps{toString(){return"label of "+(this.parent?this.parent.toString():"null")}constructor(e){super(),this.parent=e}};var Ko=class extends lr{constructor(t,i){super();this.SetEdges(t,i)}};var mb=class{constructor(e){this.MultipleMiddles=new Set;this.Multiedges=new jr}*RegularMultiedges(){for(let[e,t]of this.Multiedges.keyValues())e.x!==e.y&&(yield t)}*AllIntEdges(){for(let e of this.Multiedges.values())for(let t of e)yield t}addFeedbackSet(e){for(let t of e){let i=new me(t.source,t.target),n=new me(t.target,t.source),o=this.Multiedges.get(i.x,i.y);for(let a of o)a.reverse();if(this.Multiedges.has(n.x,n.y)){let a=this.Multiedges.get(n.x,n.y);for(let l of o)a.push(l)}else this.Multiedges.set(n.x,n.y,o);this.Multiedges.delete(i.x,i.y)}}registerOriginalEdgeInMultiedges(e){let t=this.Multiedges.get(e.source,e.target);t==null&&this.Multiedges.set(e.source,e.target,t=[]),t.push(e)}*SkeletonEdges(){for(let[e,t]of this.Multiedges.keyValues())e.x!==e.y&&(yield t[0])}GetMultiedge(e,t){return this.GetMultiedgeI(new me(e,t))}GetMultiedgeI(e){return this.Multiedges.has(e.x,e.y)?this.Multiedges.get(e.x,e.y):new Array}};function bf(s,e){for(let t=0;t<s.length;t++)e[t]=s[t]}var Oi=class{constructor(e){this.initialize(e)}initialize(e){this.y=e,this.verticesToX=null,this.layers=null}DropEmptyLayers(){let e=new Array(this.Layers.length),t=0;for(let a=0;a<this.Layers.length;a++)e[a]=t,this.Layers[a].length===0&&t++;if(t===0)return this;let i=new Array(this.y.length);for(let a=0;a<i.length;a++)i[a]=this.y[a]-e[this.y[a]];let n=new Array(this.layers.length-t);for(let a=0;a<this.layers.length;a++)this.layers[a].length>0&&(n[a-e[a]]=Array.from(this.layers[a]));let o=new Oi(i);return o.layers=n,o}updateLayers(e){this.layers==null&&this.InitLayers();for(let t=0;t<this.layers.length;t++)bf(e[t],this.layers[t]);this.UpdateXFromLayers()}UpdateXFromLayers(){this.layers==null&&this.InitLayers(),this.verticesToX==null&&(this.verticesToX=new Array(this.y.length));for(let e of this.layers){let t=0;for(let i of e)this.verticesToX[i]=t++}}get x(){return this.verticesToX!=null?this.verticesToX:(this.verticesToX=new Array(this.y.length),this.UpdateXFromLayers(),this.verticesToX)}ReversedClone(){let e=new Array(this.y.length),t=this.Layers.length-1;for(let i=0;i<this.y.length;i++)e[i]=t-this.y[i];return new Oi(e)}get Layers(){return this.layers!=null?this.layers:(this.InitLayers(),this.layers)}set Layers(e){this.layers=e}InitLayers(){let e=0;for(let i of this.y)i+1>e&&(e=i+1);let t=new Array(e).fill(0);for(let i of this.y)t[i]++;this.layers=new Array(e);for(let i=0;i<e;i++)this.layers[i]=new Array(t[i]),t[i]=0;for(let i=0;i<this.y.length;i++){let n=this.y[i];this.layers[n][t[n]++]=i}}};var rh=class extends Pe{constructor(t,i,n,o){super(o);this.jumpers=new Set;this.possibleJumperFeasibleIntervals=new Map;this.nodeCount=n,this.dag=t,this.layering=i,this.Init()}static Balance(t,i,n,o){new rh(t,i,n,o).run()}run(){for(;this.jumpers.size>0;)this.Jump(this.ChooseJumper())}Init(){this.CalculateLayerCounts(),this.InitJumpers()}Jump(t){this.jumpers.delete(t);let i=this.possibleJumperFeasibleIntervals.get(t),n=this.CalcJumpInfo(i.x,i.y,t);if(n==null)return;this.layering[t]=n.layerToJumpTo;let o=this.nodeCount[t];this.vertsCounts[n.jumperLayer]-=o,this.vertsCounts[n.layerToJumpTo]+=o,this.UpdateRegionsForPossibleJumpersAndInsertJumpers(n.jumperLayer,t)}IsJumper(t){return this.possibleJumperFeasibleIntervals.has(t)}UpdateRegionsForPossibleJumpersAndInsertJumpers(t,i){let n=new Set;for(let a of this.dag.pred(i))this.IsJumper(a)&&(this.CalculateRegionAndInsertJumper(a),n.add(a));for(let a of this.dag.succ(i))this.IsJumper(a)&&(this.CalculateRegionAndInsertJumper(a),n.add(a));let o=new Array;for(let a of this.possibleJumperFeasibleIntervals)n.has(a[0])||a[1].x>t&&a[1].y<t&&o.push(a[0]);for(let a of o)this.CalculateRegionAndInsertJumper(a)}InitJumpers(){let t=new Array(this.dag.nodeCount).fill(0);for(let i of this.dag.edges)t[i.source]-=i.weight,t[i.target]+=i.weight;this.possibleJumperFeasibleIntervals=new Map;for(let i=0;i<this.dag.nodeCount;i++)t[i]===0&&this.CalculateRegionAndInsertJumper(i)}CalculateRegionAndInsertJumper(t){let i=new me(this.Up(t),this.Down(t));this.possibleJumperFeasibleIntervals.set(t,i),this.InsertJumper(i.x,i.y,t)}InsertJumper(t,i,n){this.CalcJumpInfo(t,i,n)!=null&&this.jumpers.add(n)}CalcJumpInfo(t,i,n){let o=this.layering[n],a=-1,l=this.vertsCounts[o]-2*this.nodeCount[n];for(let u=t-1;u>o;u--)this.vertsCounts[u]<l&&(l=this.vertsCounts[u],a=u);for(let u=o-1;u>i;u--)this.vertsCounts[u]<l&&(l=this.vertsCounts[u],a=u);if(a!==-1)return{jumperLayer:o,layerToJumpTo:a}}Up(t){let i=Number.MAX_SAFE_INTEGER;for(let n of this.dag.inEdges[t]){let o=this.layering[n.source]-n.separation+1;o<i&&(i=o)}return i===Number.MAX_SAFE_INTEGER&&(i=this.layering[t]+1),i}Down(t){let i=Number.NEGATIVE_INFINITY;for(let n of this.dag.outEdges[t]){let o=this.layering[n.target]+n.separation-1;o>i&&(i=o)}return i===Number.NEGATIVE_INFINITY&&(i=this.layering[t]-1),i}CalculateLayerCounts(){this.vertsCounts=new Array(Math.max(...this.layering)+1).fill(0);for(let t of this.layering)this.vertsCounts[t]+=this.nodeCount[t]}ChooseJumper(){for(let t of this.jumpers)return t;throw new Error("there are no jumpers to choose")}};var In=class{constructor(e){this.Initialize(e)}Initialize(e){this.BaseGraph=e,this.totalNumberOfNodes=e.nodeCount;for(let t of this.BaseGraph.edges)if(t.LayerEdges!=null)for(let i of t.LayerEdges){let n=Math.max(i.Source,i.Target)+1;n>this.totalNumberOfNodes&&(this.totalNumberOfNodes=n)}this.firstVirtualNode=Number.POSITIVE_INFINITY;for(let t of this.BaseGraph.edges)if(t.LayerEdges!=null)for(let i=1;i<t.LayerEdges.length;i++){let n=t.LayerEdges[i];this.firstVirtualNode=Math.min(this.firstVirtualNode,n.Source)}this.firstVirtualNode===Number.POSITIVE_INFINITY&&(this.firstVirtualNode=this.BaseGraph.nodeCount,this.totalNumberOfNodes=this.BaseGraph.nodeCount),this.virtualNodesToInEdges=new Array(this.totalNumberOfNodes-this.firstVirtualNode),this.virtualNodesToOutEdges=new Array(this.totalNumberOfNodes-this.firstVirtualNode);for(let t of this.BaseGraph.edges)if(t.LayerSpan>0)for(let i of t.LayerEdges)i.Target!==t.target&&(this.virtualNodesToInEdges[i.Target-this.firstVirtualNode]=i),i.Source!==t.source&&(this.virtualNodesToOutEdges[i.Source-this.firstVirtualNode]=i)}*edges_(){for(let e of this.BaseGraph.edges)if(e.LayerSpan>0)for(let t of e.LayerEdges)yield t}get Edges(){return this.edges_()}*InEdges(e){if(e<this.BaseGraph.nodeCount)for(let t of this.BaseGraph.inEdges[e])t.source!==t.target&&t.LayerEdges!=null&&(yield In.LastEdge(t));else e>=this.firstVirtualNode&&(yield this.InEdgeOfVirtualNode(e))}static LastEdge(e){return e.LayerEdges[e.LayerEdges.length-1]}InEdgeOfVirtualNode(e){return this.virtualNodesToInEdges[e-this.firstVirtualNode]}*OutEdges(e){if(e<this.BaseGraph.nodeCount)for(let t of this.BaseGraph.outEdges[e])t.source!==t.target&&t.LayerEdges!=null&&(yield In.FirstEdge(t));else e>=this.firstVirtualNode&&(yield this.OutEdgeOfVirtualNode(e))}OutDegreeIsMoreThanOne(e){return e<this.BaseGraph.nodeCount?this.BaseGraph.outEdges[e].length>1:!1}InDegreeIsMoreThanOne(e){return e<this.BaseGraph.nodeCount?this.BaseGraph.inEdges[e].length>1:!1}OutEdgeOfVirtualNode(e){return this.virtualNodesToOutEdges[e-this.firstVirtualNode]}static FirstEdge(e){return e.LayerEdges[0]}InEdgesCount(e){return this.RealInEdgesCount(e)}RealInEdgesCount(e){return e<this.BaseGraph.nodeCount?this.BaseGraph.inEdges[e].filter(t=>t.LayerEdges!=null).length:1}OutEdgesCount(e){return this.RealOutEdgesCount(e)}RealOutEdgesCount(e){return e<this.BaseGraph.nodeCount?this.BaseGraph.outEdges[e].filter(t=>t.LayerEdges!=null).length:1}get NodeCount(){return this.totalNumberOfNodes}IsRealNode(e){return e<this.BaseGraph.nodeCount}IsVirtualNode(e){return!this.IsRealNode(e)}ReversedClone(){let e=this.CreateReversedEdges();return new In(new Ko(e,this.BaseGraph.nodeCount))}CreateReversedEdges(){let e=new Array;for(let t of this.BaseGraph.edges)t.isSelfEdge()||e.push(t.reversedClone());return e}*Succ(e){for(let t of this.OutEdges(e))yield t.Target}*Pred(e){for(let t of this.InEdges(e))yield t.Source}};var Bs=class{constructor(e,t,i,n){this.la=t,this.database=i,this.layeredGraph=e,this.intGraph=n}static InsertLayers(e,t,i,n){let o=new Bs(e,t,i,n);return o.InsertLayers(),{layeredGraph:o.nLayeredGraph,la:o.Nla.DropEmptyLayers()}}get NLayering(){return this.Nla.y}InsertLayers(){this.EditOldLayering(),this.CreateFullLayeredGraph(),this.InitNewLayering(),this.MapVirtualNodesToEdges(),this.FillUnsortedNewOddLayers(),this.WidenOriginalLayers(),this.SortNewOddLayers()}EditOldLayering(){let e=this.intGraph.nodeCount;for(let t of this.database.RegularMultiedges()){let i=0,n=t[0];if(i=n.LayerSpan*2,i>0){for(let o of n.LayerEdges)o.Target!==n.target&&(e++,this.UpdateOldLayer(e++,o.Target));e+=(i-1)*(t.length-1)+1}}}UpdateOldLayer(e,t){let i=this.la.x[t],n=this.la.y[t],o=this.la.Layers[n];o[i]=e}WidenOriginalLayers(){for(let e=0;e<this.la.Layers.length;e++){let t=this.Nla.Layers[e*2],i=0;for(let n of this.la.Layers[e]){let o=this.virtNodesToIntEdges[n];if(o!=null){let a=this.NLayering[o.source]-this.NLayering[n],l=this.database.Multiedges.get(o.source,o.target);for(let u of l)if(u!==o){let c=u.LayerEdges[a].Source;t[i]=c,this.Nla.x[c]=i++}else t[i]=n,this.Nla.x[n]=i++}else t[i]=n,this.Nla.x[n]=i++}}}FillUnsortedNewOddLayers(){let e=new Array(this.Nla.Layers.length).fill(0);for(let t=this.intGraph.nodeCount;t<this.nLayeredGraph.NodeCount;t++){let i=this.NLayering[t];i%2===1&&(this.Nla.Layers[i][e[i]++]=t)}}MapVirtualNodesToEdges(){this.virtNodesToIntEdges=new Array(this.NLayering.length);for(let e of this.database.AllIntEdges())if(e.source!==e.target&&e.LayerEdges!=null)for(let t of e.LayerEdges)t.Target!==e.target&&(this.virtNodesToIntEdges[t.Target]=e)}CreateFullLayeredGraph(){this.totalNodes=this.intGraph.nodeCount;for(let e of this.database.RegularMultiedges()){let t=0,i=!0;for(let n of e)if(i&&(i=!1,t=n.LayerSpan*2),t>0){n.LayerEdges=new Array(t);for(let o=0;o<t;o++){let a={currentVV:this.totalNodes},l=$n.GetSource(a,n,o);this.totalNodes=a.currentVV;let u=$n.GetTarget(this.totalNodes,n,o,t);n.LayerEdges[o]=new Li(l,u,n.CrossingWeight)}Bs.RegisterDontStepOnVertex(this.database,n)}}this.nLayeredGraph=new In(this.intGraph)}SortNewOddLayers(){for(let e=1;e<this.Nla.Layers.length;e+=2){let t=new ko,i=this.Nla.Layers[e];for(let o of i){let a=-1;for(let c of this.nLayeredGraph.InEdges(o))a=c.Source;let l=-1;for(let c of this.nLayeredGraph.OutEdges(o))l=c.Target;let u=this.Nla.x[a]+this.Nla.x[l];if(t.has(u)){let c=t.get(u);if(typeof c=="number"){let h=new Array;h.push(c),h.push(o),t.set(u,h)}else c.push(o)}else t.set(u,o)}let n=0;for(let o of t.values())if(typeof o=="number")i[n++]=o;else for(let a of o)i[n++]=a;for(let o=0;o<i.length;o++)this.Nla.x[i[o]]=o}}InitNewLayering(){this.Nla=new Oi(new Array(this.totalNodes));for(let i=0;i<this.layeredGraph.NodeCount;i++)this.NLayering[i]=this.la.y[i]*2;for(let[i,n]of this.database.Multiedges.keyValues())if(i.x!==i.y&&this.la.y[i.x]!==this.la.y[i.y]){let o=this.la.y[i.x]*2;for(let a of n){let l=o-1;for(let u of a.LayerEdges)u.Target!==a.target&&(this.NLayering[u.Target]=l--)}}let e=new Array(2*this.la.Layers.length-1),t=new Array(e.length).fill(0);for(let i of this.NLayering)t[i]++;for(let i=0;i<t.length;i++)e[i]=new Array(t[i]);this.Nla=new Oi(this.NLayering),this.Nla.Layers=e}static RegisterDontStepOnVertex(e,t){if(e.Multiedges.get(t.source,t.target).length>1){let i=t.LayerEdges[Math.floor(t.LayerEdges.length/2)];e.MultipleMiddles.add(i.Source)}}};var $n=class{constructor(e,t,i,n){this.virtNodesToIntEdges=new Map;this.la=t,this.database=i,this.layeredGraph=e,this.intGraph=n}get NLayering(){return this.Nla.y}static InsertPaths(e,t,i,n){let o=new $n(e,t,i,n);return o.InsertPaths(),{layeredGraph:o.NLayeredGraph,la:o.Nla}}InsertPaths(){this.CreateFullLayeredGraph(),this.InitNewLayering(),this.MapVirtualNodesToEdges(),this.WidenOriginalLayers()}WidenOriginalLayers(){for(let e=0;e<this.la.Layers.length;e++){let t=this.Nla.Layers[e],i=0;for(let n of this.la.Layers[e]){let o=this.virtNodesToIntEdges.get(n);if(o!=null){let a=this.NLayering[o.source]-this.NLayering[n],l=this.database.Multiedges.get(o.source,o.target);for(let u of l)if(!this.EdgeIsFlat(u))if(u!==o){let c=u.LayerEdges[a].Source;t[i]=c,this.Nla.x[c]=i++}else t[i]=n,this.Nla.x[n]=i++}else t[i]=n,this.Nla.x[n]=i++}}}EdgeIsFlat(e){return this.la.y[e.source]===this.la.y[e.target]}MapVirtualNodesToEdges(){for(let e of this.database.RegularMultiedges())for(let t of e)if(!this.EdgeIsFlat(t))for(let i of t.LayerEdges)i.Target!==t.target&&this.virtNodesToIntEdges.set(i.Target,t)}CreateFullLayeredGraph(){let e=this.layeredGraph.NodeCount;for(let[t,i]of this.database.Multiedges.keyValues())if(t.x!==t.y){let n=!0,o=0;for(let a of i){if(n)n=!1,o=a.LayerSpan;else if(a.LayerEdges=new Array(o),o===1)a.LayerEdges[0]=new Li(a.source,a.target,a.CrossingWeight);else for(let l=0;l<o;l++){let u={currentVV:e},c=$n.GetSource(u,a,l);e=u.currentVV;let h=$n.GetTarget(e,a,l,o);a.LayerEdges[l]=new Li(c,h,a.CrossingWeight)}Bs.RegisterDontStepOnVertex(this.database,a)}}this.NLayeredGraph=new In(this.intGraph)}static GetTarget(e,t,i,n){return i<n-1?e:t.target}static GetSource(e,t,i){return i===0?t.source:e.currentVV++}InitNewLayering(){this.Nla=new Oi(new Array(this.NLayeredGraph.NodeCount));for(let i=0;i<this.layeredGraph.NodeCount;i++)this.NLayering[i]=this.la.y[i];for(let[i,n]of this.database.Multiedges.keyValues())if(i.x!==i.y&&this.la.y[i.x]!==this.la.y[i.y]){let o=0,a=!0;for(let l of n){a&&(a=!1,o=this.la.y[l.source]);let u=o-1;for(let c of l.LayerEdges)this.NLayering[c.Target]=u--}}let e=new Array(this.la.Layers.length),t=new Array(e.length).fill(0);for(let i of this.NLayering)t[i]++;for(let i=0;i<t.length;i++)e[i]=new Array(t[i]);this.Nla=new Oi(this.NLayering),this.Nla.Layers=e}};var Ya=class{constructor(e,t,i){this.numberOfCrossings=t,this.la=e,this.virtVertexStart=i}LayerGroupDisbalance(e,t,i){return t===1?this.LayerGroupDisbalanceWithOrigSeparators(e,i):this.LayerGroupDisbalanceWithVirtSeparators(e,t)}LayerGroupDisbalanceWithVirtSeparators(e,t){let i=0;for(let n=0;n<e.length;){let o=this.CurrentOrigGroupDelta(n,e,t);n=o.i,i+=o.ret}return i}CurrentOrigGroupDelta(e,t,i){let n=0,o=e;for(;o<t.length&&t[o]<this.virtVertexStart;o++)n++;return e=o+1,{ret:Math.abs(i-n),i:e}}LayerGroupDisbalanceWithOrigSeparators(e,t){let i=0;for(let n=0;n<e.length;){let o=this.CurrentVirtGroupDelta(n,e,t);i+=o.ret,n=o.i}return i}CurrentVirtGroupDelta(e,t,i){let n=0,o=e;for(;o<t.length&&t[o]>=this.virtVertexStart;o++)n++;return e=o+1,{ret:Math.abs(i-n),i:e}}static less(e,t){return e.numberOfCrossings<t.numberOfCrossings}static greater(e,t){return e.numberOfCrossings>t.numberOfCrossings}IsPerfect(){return this.numberOfCrossings===0}};var MA=Ae(yn(),1);var bb=class{constructor(e){this.x=e}Compare(e,t){let i=this.x[e.Source]-this.x[t.Source];return i!==0?i:this.x[e.Target]-this.x[t.Target]}};var Pb=class{constructor(e){this.x=e}Compare(e,t){let i=this.x[e.Target]-this.x[t.Target];return i!==0?i:this.x[e.Source]-this.x[t.Source]}};function yb(){return Sa(2)===0}function FN(s,e,t){let i=t.Layers[s+1],n=t.Layers[s];return n.length<=i.length?VN(n,e,t):kN(i,n,e,t)}function kN(s,e,t,i){let n=BA(e,t),o=new Pb(i.x);n.sort((c,h)=>o.Compare(c,h));let a=1;for(;a<s.length;)a*=2;let l=new Array(2*a-1).fill(0);a--;let u=0;for(let c of n){let h=a+i.x[c.Source],d=c.CrossingWeight;for(l[h]+=d;h>0;)h%2!==0&&(u+=d*l[h+1]),h=Math.floor((h-1)/2),l[h]+=d}return u}function VN(s,e,t){let i=BA(s,e),n=new bb(t.x);i.sort((u,c)=>n.Compare(u,c));let o=1;for(;o<s.length;)o*=2;let a=new Array(2*o-1).fill(0);o--;let l=0;for(let u of i){let c=o+t.x[u.Target],h=u.CrossingWeight;for(a[c]+=h;c>0;)c%2!==0&&(l+=h*a[c+1]),c=Math.floor((c-1)/2),a[c]+=h}return l}function BA(s,e){return wo(s,t=>e.InEdges(t))}function NA(s,e){let t=0;for(let i=0;i<e.Layers.length-1;i++)t+=FN(i,s,e);return t}var Ds=class extends Pe{constructor(t,i,n,o,a,l,u){super(u);this.tryReverse=!0;this.MaxNumberOfAdjacentExchanges=50;this.cancelToken=u,this.tryReverse=i,this.startOfVirtNodes=o,this.layerArrays=n,this.layering=n.y,this.nOfLayers=n.Layers.length,this.layers=n.Layers,this.properLayeredGraph=t,this.hasCrossWeights=a,this.SugSettings=l}get NoGainStepsBound(){return this.SugSettings.NoGainAdjacentSwapStepsBound*this.SugSettings.NoGainStepsForOrderingMultiplier}get SeedOfRandom(){return Sa(100)}get MaxOfIterations(){return this.SugSettings.MaxNumberOfPassesInOrdering*this.SugSettings.NoGainStepsForOrderingMultiplier}static OrderLayers(t,i,n,o,a){let l=!1;for(let c of t.Edges)if(c.CrossingWeight!==1){l=!0;break}new Ds(t,!0,i,n,l,o,a).run()}run(){if(this.Calculate(),this.tryReverse){let t=this.layerArrays.ReversedClone(),i=new Ds(this.properLayeredGraph.ReversedClone(),!1,t,this.startOfVirtNodes,this.hasCrossWeights,this.SugSettings,this.cancelToken);if(i.run(),Ya.less(i.measure,this.measure)){for(let n=0;n<this.nOfLayers;n++)bf(t.Layers[n],this.layerArrays.Layers[this.nOfLayers-1-n]);this.layerArrays.UpdateXFromLayers()}}}Calculate(){this.Init(),this.layerArraysCopy=Ds.CloneLayers(this.layers,this.layerArraysCopy);let t=0;this.measure=new Ya(this.layerArraysCopy,NA(this.properLayeredGraph,this.layerArrays),this.startOfVirtNodes);for(let i=0;i<this.MaxOfIterations&&t<this.NoGainStepsBound&&!this.measure.IsPerfect();i++){let n=i%2===0;this.LayerByLayerSweep(n),this.AdjacentExchange();let o=new Ya(this.layerArrays.Layers,NA(this.properLayeredGraph,this.layerArrays),this.startOfVirtNodes);Ya.less(this.measure,o)?(this.Restore(),t++):(Ya.less(o,this.measure)||yb())&&(t=0,this.layerArraysCopy=Ds.CloneLayers(this.layers,this.layerArraysCopy),this.measure=o)}}static CloneLayers(t,i){if(i==null){i=new Array(t.length);for(let n=0;n<t.length;n++)i[n]=t[n].map(o=>o)}else for(let n=0;n<t.length;n++)bf(t[n],i[n]);return i}Restore(){this.layerArrays.updateLayers(this.layerArraysCopy)}LayerByLayerSweep(t){if(t)for(let i=1;i<this.nOfLayers;i++)this.SweepLayer(i,!0);else for(let i=this.nOfLayers-2;i>=0;i--)this.SweepLayer(i,!1)}SweepLayer(t,i){let n=this.layers[t],o=new Array(n.length);for(let l=0;l<o.length;l++)o[l]=this.WMedian(n[l],i);this.Sort(t,o);let a=this.layerArrays.Layers[t];for(let l=0;l<a.length;l++)this.layerArrays.x[a[l]]=l}Sort(t,i){let n=new ko,o=this.layers[t],a=0;for(let u of i){let c=o[a++];if(u!==-1)if(!n.has(u))n.set(u,c);else{let h=n.get(u);if(typeof h!="number"){let d=h;if(yb())d.push(c);else{let f=Sa(d.length),p=d[f];d[f]=c,d.push(p)}}else{let d=h,f=new Array;n.set(u,f),yb()?(f.push(d),f.push(c)):(f.push(c),f.push(d))}}}let l=n.values();for(a=0;a<o.length;)if(i[a]!==-1){let u=l.next().value;if(typeof u=="number")o[a++]=u;else{let c=u;for(let h of c){for(;i[a]===-1;)a++;o[a++]=h}}}else a++}WMedian(t,i){let n,o;if(i?(n=this.properLayeredGraph.OutEdges(t),o=this.properLayeredGraph.OutEdgesCount(t)):(n=this.properLayeredGraph.InEdges(t),o=this.properLayeredGraph.InEdgesCount(t)),o===0)return-1;let a=new Array(o),l=0;if(i)for(let d of n)a[l++]=this.X[d.Target];else for(let d of n)a[l++]=this.X[d.Source];a.sort((d,f)=>d-f);let u=Math.floor(o/2);if(o%2===1)return a[u];if(o===2)return .5*(a[0]+a[1]);let c=a[u-1]-a[0],h=a[o-1]-a[u];return Math.floor((a[u-1]*c+a[u]*h)/(c+h))}Init(){let t=new Array(this.nOfLayers).fill(0),i=new MA.Stack;for(let o=0;o<this.properLayeredGraph.NodeCount;o++)this.properLayeredGraph.InEdgesCount(o)===0&&i.push(o);let n=new Array(this.properLayeredGraph.NodeCount).fill(!1);for(;i.size>0;){let o=i.pop(),a=this.layerArrays.y[o];this.layerArrays.Layers[a][t[a]]=o,this.layerArrays.x[o]=t[a],t[a]++;for(let l of this.properLayeredGraph.Succ(o))n[l]||(n[l]=!0,i.push(l))}this.X=this.layerArrays.x}AdjacentExchange(){this.InitArrays();let t=0,i=!0;for(;i&&t++<this.MaxNumberOfAdjacentExchanges;){i=!1;for(let n=0;n<this.layers.length;n++)i=this.AdjExchangeLayer(n)||i;for(let n=this.layers.length-2;n>=0;n--)i=this.AdjExchangeLayer(n)||i}}AllocArrays(){let t=this.properLayeredGraph.NodeCount;this.predecessors=new Array(t),this.successors=new Array(t),this.pOrder=new Array(t),this.sOrder=new Array(t),this.hasCrossWeights&&(this.outCrossingCount=new Array(t),this.inCrossingCount=new Array(t));for(let i=0;i<t;i++){let n=this.properLayeredGraph.InEdgesCount(i);if(this.predecessors[i]=new Array(n),this.hasCrossWeights){let o=this.inCrossingCount[i]=new Map;for(let a of this.properLayeredGraph.InEdges(i))o.set(a.Source,a.CrossingWeight)}if(this.pOrder[i]=new Map,n=this.properLayeredGraph.OutEdgesCount(i),this.successors[i]=new Array(n),this.sOrder[i]=new Map,this.hasCrossWeights){let o=this.outCrossingCount[i]=new Map;for(let a of this.properLayeredGraph.OutEdges(i))o.set(a.Target,a.CrossingWeight)}}}InitArrays(){this.successors==null&&this.AllocArrays();for(let t=0;t<this.properLayeredGraph.NodeCount;t++)this.pOrder[t]=new Map,this.sOrder[t]=new Map;for(let t of this.layers)this.InitPsArraysForLayer(t)}CalcPair(t,i){let n=this.successors[t],o=this.successors[i],a=this.predecessors[t],l=this.predecessors[i];if(this.hasCrossWeights){let u=this.outCrossingCount[t],c=this.outCrossingCount[i],h=this.inCrossingCount[t],d=this.inCrossingCount[i];return{cuv:this.CountOnArraysUV(n,o,u,c)+this.CountOnArraysUV(a,l,h,d),cvu:this.CountOnArraysUV(o,n,c,u)+this.CountOnArraysUV(l,a,d,h)}}else return{cuv:this.CountOnArrays(n,o)+this.CountOnArrays(a,l),cvu:this.CountOnArrays(o,n)+this.CountOnArrays(l,a)}}InitPsArraysForLayer(t){for(let i of t){for(let n of this.properLayeredGraph.Pred(i)){let o=this.sOrder[n],a=o.size;this.successors[n][a]=i,o.set(i,a)}for(let n of this.properLayeredGraph.Succ(i)){let o=this.pOrder[n],a=o.size;this.predecessors[n][a]=i,o.set(i,a)}}}CountOnArrays(t,i){let n=0,o=i.length-1,a=-1,l=0;for(let u of t){let c=this.X[u];for(;a<o&&this.X[i[a+1]]<c;a++)l++;n+=l}return n}CountOnArraysUV(t,i,n,o){let a=0,l=i.length-1,u=-1,c=0;for(let h of t){let d=this.X[h],f;for(;u<l&&this.X[f=i[u+1]]<d;u++)c+=o.get(f);a+=c*n.get(h)}return a}AdjExchangeLayer(t){let i=this.layers[t];return this.ExchangeWithGainWithNoDisturbance(i)?!0:(this.DisturbLayer(i),this.ExchangeWithGainWithNoDisturbance(i))}Swap(t,i){let n=this.X[t],o=this.X[i],a=this.layering[t],l=this.layers[a];l[n]=i,l[o]=t,this.X[t]=o,this.X[i]=n,this.UpdateSsContainingUv(t,i),this.UpdatePsContainingUv(t,i)}UpdatePsContainingUv(t,i){if(this.successors[t].length<=this.successors[i].length)for(let n of this.successors[t]){let o=this.pOrder[n];if(o.has(i)){let a=o.get(i),l=this.predecessors[n];l[a-1]=i,l[a]=t,o.set(i,a-1),o.set(t,a)}}else for(let n of this.successors[i]){let o=this.pOrder[n];if(o.has(t)){let a=o.get(i),l=this.predecessors[n];l[a-1]=i,l[a]=t,o.set(i,a-1),o.set(t,a)}}}UpdateSsContainingUv(t,i){if(this.predecessors[t].length<=this.predecessors[i].length)for(let n of this.predecessors[t]){let o=this.sOrder[n];if(o.has(i)){let a=o.get(i),l=this.successors[n];l[a-1]=i,l[a]=t,o.set(i,a-1),o.set(t,a)}}else for(let n of this.predecessors[i]){let o=this.sOrder[n];if(o.has(t)){let a=o.get(i),l=this.successors[n];l[a-1]=i,l[a]=t,o.set(i,a-1),o.set(t,a)}}}DisturbLayer(t){for(let i=0;i<t.length-1;i++)this.AdjacentSwapToTheRight(t,i)}ExchangeWithGainWithNoDisturbance(t){let i=!1,n;do n=this.ExchangeWithGain(t),i=i||n;while(n);return i}ExchangeWithGain(t){for(let i=0;i<t.length-1;i++)if(this.SwapWithGain(t[i],t[i+1]))return this.SwapToTheLeft(t,i),this.SwapToTheRight(t,i+1),!0;return!1}SwapToTheLeft(t,i){for(let n=i-1;n>=0;n--)this.AdjacentSwapToTheRight(t,n)}SwapToTheRight(t,i){for(let n=i;n<t.length-1;n++)this.AdjacentSwapToTheRight(t,n)}AdjacentSwapToTheRight(t,i){let n=t[i],o=t[i+1],a=this.SwapGain(n,o);(a>0||a===0&&yb())&&this.Swap(n,o)}SwapGain(t,i){let n=this.CalcPair(t,i);return n.cuv-n.cvu}UvAreOfSameKind(t,i){return t<this.startOfVirtNodes&&i<this.startOfVirtNodes||t>=this.startOfVirtNodes&&i>=this.startOfVirtNodes}NeighborsForbidTheSwap(t,i){return this.UpperNeighborsForbidTheSwap(t,i)||this.LowerNeighborsForbidTheSwap(t,i)}LowerNeighborsForbidTheSwap(t,i){let n,o;return(n=this.properLayeredGraph.OutEdgesCount(t))===0||(o=this.properLayeredGraph.OutEdgesCount(i))===0?!1:this.X[this.successors[t][n>>1]]<this.X[this.successors[i][o>>1]]}UpperNeighborsForbidTheSwap(t,i){let n=this.properLayeredGraph.InEdgesCount(t),o=this.properLayeredGraph.InEdgesCount(i);return n===0||o===0?!1:this.X[this.predecessors[t][n>>1]]<this.X[this.predecessors[i][o>>1]]}CalcDeltaBetweenGroupsToTheLeftAndToTheRightOfTheSeparator(t,i,n){let o=this.GetKindDelegate(n),a=0;for(let u=i-1;u>=0&&!o(t[u]);u--)a++;let l=0;for(let u=i+1;u<t.length&&!o(t[u]);u++)l++;return a-l}IsOriginal(t){return t<this.startOfVirtNodes}IsVirtual(t){return t>=this.startOfVirtNodes}GetKindDelegate(t){return this.IsVirtual(t)?this.IsVirtual:this.IsOriginal}SwapWithGain(t,i){return this.SwapGain(t,i)>0?(this.Swap(t,i),!0):!1}};var fu=class{constructor(e,t,i){this.properLayeredGraph=e,this.layerArrays=t,this.nodePositions=i}static UpdateLayerArrays0(e,t,i){new fu(e,t,i).UpdateLayerArrays()}static UpdateLayerArrays1(e,t){let i=fu.BuildInitialNodePositions(e,t);this.UpdateLayerArrays0(e,t,i)}static BuildInitialNodePositions(e,t){let i=new Map;for(let n=0;n<t.Layers.length;n++){let o=0,a=0;for(;o<t.Layers[n].length;){for(;o<t.Layers[n].length&&e.IsVirtualNode(t.Layers[n][o]);)o++;for(let l=a;l<o;l++)i.set(t.Layers[n][l],new m(n,a));o<t.Layers[n].length&&i.set(t.Layers[n][o],new m(n,o)),o++,a=o}}return i}UpdateLayerArrays(){let e=this.CreateInitialOrdering();e=this.BuildOrdering(e),this.RestoreLayerArrays(e)}CreateInitialOrdering(){let e=new Nt;for(let t of this.layerArrays.Layers)for(let i of t){let n=this.nodePositions.get(i);e.hasxy(n.x,n.y)||e.setxy(n.x,n.y,[]),e.getxy(n.x,n.y).push(i)}return e}BuildOrdering(e){let t=new Nt,i=new Map;for(let n of this.layerArrays.Layers)for(let o of n){let a=this.nodePositions.get(o);t.hasxy(a.x,a.y)||(this.BuildNodeOrdering(e.get(a),i),t.set(a,e.get(a)))}return t}BuildNodeOrdering(e,t){e.sort(this.Comparison(t));for(let i=0;i<e.length;i++)t.set(e[i],i)}firstSucc(e){for(let t of this.properLayeredGraph.Succ(e))return t}firstPred(e){for(let t of this.properLayeredGraph.Pred(e))return t}Comparison(e){return(t,i)=>{let n=this.firstSucc(t),o=this.firstSucc(i),a=this.firstPred(t),l=this.firstPred(i),u=this.nodePositions.get(n),c=this.nodePositions.get(o),h=this.nodePositions.get(a),d=this.nodePositions.get(l);if(!u.equal(c))return h.equal(d)?u.compareTo(c):h.compareTo(d);if(this.properLayeredGraph.IsVirtualNode(n)){if(!h.equal(d))return h.compareTo(d);let f=e.get(n),p=e.get(o);return _e(f,p)}for(;this.nodePositions.get(a).equal(this.nodePositions.get(l))&&this.properLayeredGraph.IsVirtualNode(a);)a=this.firstPred(a),l=this.firstPred(l);return this.nodePositions.get(a).equal(this.nodePositions.get(l))?_e(t,i):this.nodePositions.get(a).compareTo(this.nodePositions.get(l))}}RestoreLayerArrays(e){for(let t of this.layerArrays.Layers){let i=0,n=0;for(;i<t.length;){for(;i<t.length&&this.nodePositions.get(t[n]).equal(this.nodePositions.get(t[i]));)i++;let o=e.get(this.nodePositions.get(t[n]));for(let a=n;a<i;a++)t[a]=o[a-n];n=i}}this.layerArrays.UpdateXFromLayers()}};var GA=Ae(sr(),1);var DA=Ae(yn(),1);var Ka=class{static getOrder(e,t){let i=Sr(t.map(([n,o])=>new me(n,o)),e);return Ka.getOrderOnGraph(i)}static getOrderOnGraph(e){let t=new Array(e.nodeCount).fill(!1),i=new DA.Stack,n=[],o;for(let a=0;a<e.nodeCount;a++){if(t[a])continue;let l=a;t[l]=!0;let u=0;o=e.outEdges[a];do{for(;u<o.length;u++){let c=o[u].target;t[c]||(t[c]=!0,i.push({edges:o,index:u+1,current_u:l}),l=c,o=e.outEdges[l],u=-1)}if(n.push(l),i.length>0){let c=i.pop();o=c.edges,u=c.index,l=c.current_u}else break}while(!0)}return n.reverse()}};var Sb=class{GetLayers(){let e=Ka.getOrderOnGraph(this.graph),t=new Array(this.graph.nodeCount).fill(0),i=this.graph.nodeCount;for(;i-- >0;){let n=e[i];for(let o of this.graph.inEdges[n]){let a=o.source,l=t[n]+o.separation;t[a]<l&&(t[a]=l)}}return t}checkTopoOrder(e){for(let t of this.graph.edges)if(UN(t,e))return!1;return!0}constructor(e){this.graph=e}};function UN(s,e){let t=e.findIndex(n=>n===s.source),i=e.findIndex(n=>n===s.target);return t===-1||i===-1||t>=i}var gS=class{constructor(e){this.inTree=!1;this.cut=gS.infinity;this.iedge=e}get source(){return this.iedge.source}get target(){return this.iedge.target}get separation(){return this.iedge.separation}get crossingWeight(){return this.iedge.CrossingWeight}get weight(){return this.iedge.weight}},Pi=gS;Pi.infinity=Number.MAX_SAFE_INTEGER;var Za=Ae(yn(),1);function zN(s){let e=new Array;for(let t of s.edges)e.push(new Pi(t));return Sr(e,s.nodeCount)}var Pf=class{constructor(e,t,i,n,o){this.v=e,this.outEnum=t,this.i=i,this.inEnum=n,this.j=o}},ih=class{constructor(e,t){this.layers=null;this.treeVertices=[];this.vertices=[];this.leaves=[];this.graph=zN(e),this.networkCancelToken=t;for(let i=0;i<this.graph.nodeCount;i++)this.vertices.push({inTree:!1,lim:-1,low:-1,parent:null})}get weight(){return this.graph.edges.map(e=>e.weight*(this.layers[e.source]-this.layers[e.target])).reduce((e,t)=>e+t,0)}get nodeCount(){return this.vertices.length}setLow(e,t){this.vertices[e].low=t}setLim(e,t){this.vertices[e].lim=t}setParent(e,t){this.vertices[e].parent=t}GetLayers(){return this.layers==null&&this.run(),this.layers}shiftLayerToZero(){let e=Math.min(...this.layers);for(let t=0;t<this.layers.length;t++)this.layers[t]-=e}addVertexToTree(e){this.vertices[e].inTree=!0}vertexInTree(e){return this.vertices[e].inTree}lim(e){return this.vertices[e].lim}low(e){return this.vertices[e].low}parent(e){return this.vertices[e].parent}feasibleTree(){for(this.initLayers();this.tightTree()<this.nodeCount;){let e=this.getNonTreeEdgeIncidentToTheTreeWithMinimalAmountOfSlack();if(e==null)break;let t=this.slack(e);this.vertexInTree(e.source)&&(t=-t);for(let i of this.treeVertices)this.layers[i]+=t}this.initCutValues()}vertexSourceTargetVal(e,t){let i=t.source,n=t.target;return this.lim(i)>this.lim(n)?this.lim(e)<=this.lim(n)&&this.low(n)<=this.lim(e)?0:1:this.lim(e)<=this.lim(i)&&this.low(i)<=this.lim(e)?1:0}incidentEdges(e){return this.graph.incidentEdges(e)}allLowCutsHaveBeenDone(e){for(let t of this.incidentEdges(e))if(t.inTree&&t.cut===Pi.infinity&&t!==this.parent(e))return!1;return!0}edgeSourceTargetVal(e,t){return this.vertexSourceTargetVal(e.source,t)-this.vertexSourceTargetVal(e.target,t)}initCutValues(){this.initLimLowAndParent();let e=new Za.Stack;for(let i of this.leaves)e.push(i);let t=new Za.Stack;for(;e.length>0;){for(;e.length>0;){let n=e.pop(),o=this.parent(n);if(o==null)continue;let a=0;for(let u of this.incidentEdges(n))if(u.inTree===!1){let c=this.edgeSourceTargetVal(u,o);c!==0&&(a+=c*u.weight)}else if(u===o)a+=u.weight;else{let c=o.source===u.target||o.target===u.source?1:-1;a+=this.edgeContribution(u,n)*c}o.cut=a;let l=o.source===n?o.target:o.source;this.allLowCutsHaveBeenDone(l)&&t.push(l)}let i=e;e=t,t=i}}edgeContribution(e,t){let i=e.cut-e.weight;for(let n of this.incidentEdges(t))if(n.inTree===!1){let o=this.edgeSourceTargetVal(n,e);o===-1?i+=n.weight:o===1&&(i-=n.weight)}return i}initLimLowAndParent(){this.initLowLimParentAndLeavesOnSubtree(1,0)}initLowLimParentAndLeavesOnSubtree(e,t){let i=new Za.Stack,n=this.graph.outEdges[t],o=-1,a=this.graph.inEdges[t],l=-1;for(i.push(new Pf(t,n,o,a,l)),this.vertices[t].low=e;i.length>0;){let u=i.pop();t=u.v,n=u.outEnum,o=u.i,a=u.inEnum,l=u.j;let c;do{for(c=!0;++o<n.length;){let h=n[o];!h.inTree||this.vertices[h.target].low>0||(i.push(new Pf(t,n,o,a,l)),t=h.target,this.setParent(t,h),this.setLow(t,e),n=this.graph.outEdges[t],o=-1,a=this.graph.inEdges[t],l=-1)}for(;++l<a.length;){let h=a[l];if(!(!h.inTree||this.vertices[h.source].low>0)){i.push(new Pf(t,n,o,a,l)),t=h.source,this.setLow(t,e),this.setParent(t,h),n=this.graph.outEdges[t],o=-1,a=this.graph.inEdges[t],l=-1,c=!1;break}}}while(!c);this.setLim(t,e++),this.lim(t)===this.low(t)&&this.leaves.push(t)}}updateLimLowLeavesAndParentsUnderNode(e){let t=this.vertices[e].low,i=this.vertices[e].lim;this.leaves=[];for(let n=0;n<this.nodeCount;n++)t<=this.vertices[n].lim&&this.vertices[n].lim<=i?this.setLow(n,0):this.low(n)===this.lim(n)&&this.leaves.push(n);this.initLowLimParentAndLeavesOnSubtree(t,e)}slack(e){return this.layers[e.source]-this.layers[e.target]-e.separation}getNonTreeEdgeIncidentToTheTreeWithMinimalAmountOfSlack(){let e=null,t=Pi.infinity;for(let i of this.treeVertices){for(let n of this.graph.outEdges[i]){if(this.vertexInTree(n.source)&&this.vertexInTree(n.target))continue;let o=this.slack(n);if(o<t&&(e=n,t=o,o===1))return n}for(let n of this.graph.inEdges[i]){if(this.vertexInTree(n.source)&&this.vertexInTree(n.target))continue;let o=this.slack(n);if(o<t&&(e=n,t=o,o===1))return n}}return e}tightTree(){this.treeVertices=[];for(let t of this.graph.edges)t.inTree=!1;for(let t=1;t<this.nodeCount;t++)this.vertices[t].inTree=!1;this.vertices[0].inTree=!0,this.treeVertices.push(0);let e=new Za.Stack;for(e.push(0);e.length>0;){let t=e.pop();for(let i of this.graph.outEdges[t])this.vertexInTree(i.target)||this.layers[i.source]-this.layers[i.target]===i.separation&&(e.push(i.target),this.addVertexToTree(i.target),this.treeVertices.push(i.target),i.inTree=!0);for(let i of this.graph.inEdges[t])this.vertexInTree(i.source)||this.layers[i.source]-this.layers[i.target]===i.separation&&(e.push(i.source),this.addVertexToTree(i.source),this.treeVertices.push(i.source),i.inTree=!0)}return this.treeVertices.length}leaveEnterEdge(){let e,t,i=0;for(let a of this.graph.edges)a.inTree&&a.cut<i&&(i=a.cut,e=a);if(e==null)return null;let n=!1,o=Pi.infinity;for(let a of this.graph.edges){let l=this.slack(a);if(a.inTree===!1&&this.edgeSourceTargetVal(a,e)===-1&&(l<o||l===o&&(n=Sa(2)===1))){if(o=l,t=a,o===0&&!n)break;n=!1}}if(t==null)throw new Error;return{leaving:e,entering:t}}exchange(e,t){let i=this.commonPredecessorOfSourceAndTargetOfF(t);this.createPathForCutUpdates(e,t,i),this.updateLimLowLeavesAndParentsUnderNode(i),this.updateCuts(e),this.updateLayersUnderNode(i)}updateLayersUnderNode(e){let t=new Za.Stack;t.push(e);for(let i=0;i<this.nodeCount;i++)this.low(e)<=this.lim(i)&&this.lim(i)<=this.lim(e)&&i!==e&&(this.layers[i]=Pi.infinity);for(;t.length>0;){let i=t.pop();for(let n of this.graph.outEdges[i])n.inTree&&this.layers[n.target]===Pi.infinity&&(this.layers[n.target]=this.layers[i]-n.separation,t.push(n.target));for(let n of this.graph.inEdges[i])n.inTree&&this.layers[n.source]===Pi.infinity&&(this.layers[n.source]=this.layers[i]+n.separation,t.push(n.source))}}updateCuts(e){let t=new Za.Stack,i=new Za.Stack;for(t.push(e.source),t.push(e.target);t.length>0;){for(;t.length>0;){let o=t.pop(),a=this.parent(o);if(a==null||a.cut!==Pi.infinity)continue;let l=0;for(let c of this.incidentEdges(o))if(c.inTree===!1)l+=this.edgeSourceTargetVal(c,a)*c.weight;else if(c===a)l+=c.weight;else{let h=a.source===c.target||a.target===c.source?1:-1;l+=this.edgeContribution(c,o)*h}a.cut=l;let u=a.source===o?a.target:a.source;this.allLowCutsHaveBeenDone(u)&&i.push(u)}let n=t;t=i,i=n}}createPathForCutUpdates(e,t,i){let n=t.target;for(;n!==i;){let o=this.parent(n);o.cut=Pi.infinity,n=o.source===n?o.target:o.source}t.cut=Pi.infinity,e.inTree=!1,t.inTree=!0}commonPredecessorOfSourceAndTargetOfF(e){let t,i;this.lim(e.source)<this.lim(e.target)?(t=this.lim(e.source),i=this.lim(e.target)):(t=this.lim(e.target),i=this.lim(e.source));let n=e.source;for(;!(this.low(n)<=t&&i<=this.lim(n));){let o=this.parent(n);o.cut=Pi.infinity,n=o.source===n?o.target:o.source}return n}checkCutValues(){for(let e of this.graph.edges)if(e.inTree){let t=0;for(let i of this.graph.edges)t+=this.edgeSourceTargetVal(i,e)*i.weight;e.cut!==t&&console.log(GA.String.Format("cuts are wrong for {0}; should be {1} but is {2}",e,t,e.cut))}}initLayers(){let e=new Sb(this.graph);return this.layers=e.GetLayers()}run(){if(this.graph.edges.length===0&&this.graph.nodeCount===0)this.layers=[];else{this.feasibleTree();let e;for(;(e=this.leaveEnterEdge())!=null;)this.exchange(e.leaving,e.entering);this.shiftLayerToZero()}}};var Eb=class{GetLayers(){return new ih(this.graph,this.Cancel).GetLayers()}ShrunkComponent(e){let t=[];for(let i of e){let n=i[0],o=i[1];for(let a of this.graph.outEdges[n]){let l=new Br(o,e.get(a.target),a.edge);l.separation=a.separation,l.weight=a.weight,t.push(l)}}return new Ko(t,e.size)}constructor(e,t){this.graph=e,this.Cancel=t}};var ei=class{constructor(e){this.padding=0;this.alreadySitsOnASpline=!1;this.labelIsToTheLeftOfTheSpline=!1;this.labelIsToTheRightOfTheSpline=!1;this.labelCornersPreserveCoefficient=e}toString(){return"la:ra "+this.la+" "+this.ra+" ta:ba "+this.ta+" "+this.ba+" x:y "+this.x_+" "+this.y_}get leftAnchor(){return this.la}set leftAnchor(e){this.la=Math.max(e,0)}get rightAnchor(){return this.ra}set rightAnchor(e){this.ra=Math.max(e,0)}get topAnchor(){return this.ta}set topAnchor(e){this.ta=Math.max(e,0)}get bottomAnchor(){return this.ba}set bottomAnchor(e){this.ba=Math.max(e,0)}get left(){return this.x_-this.la}get right(){return this.x_+this.ra}get top(){return this.y_+this.ta}set top(e){this.y_+=e-this.ta}get bottom(){return this.y_-this.ba}set bottom(e){this.y_+=e-this.ba}get leftTop(){return new m(this.left,this.top)}get leftBottom(){return new m(this.left,this.bottom)}get rightBottom(){return new m(this.right,this.bottom)}get node(){return this.node_}set node(e){this.node_=e,this.polygonalBoundary_=null}get rightTop(){return new m(this.right,this.top)}static mkAnchor(e,t,i,n,o,a){let l=new ei(a);return l.la=e,l.ra=t,l.ta=i,l.ba=n,l.node=o,l}get x(){return this.x_}set x(e){this.polygonalBoundary_=null,this.x_=e}get y(){return this.y_}set y(e){this.polygonalBoundary_=null,this.y_=e}get origin(){return new m(this.x,this.y)}get width(){return this.la+this.ra}get height(){return this.ta+this.ba}get hasLabel(){return this.labelIsToTheLeftOfTheSpline||this.labelIsToTheLeftOfTheSpline}get LabelWidth(){if(this.labelIsToTheLeftOfTheSpline)return this.leftAnchor;if(this.labelIsToTheRightOfTheSpline)return this.rightAnchor;throw new Error}get polygonalBoundary(){return this.polygonalBoundary_!=null?this.polygonalBoundary_:this.polygonalBoundary_=ei.pad(this.creatPolygonalBoundaryWithoutPadding(),this.padding)}static pad(e,t){return t===0?e:ei.curveIsConvex(e)?ei.padConvexCurve(e,t):ei.padConvexCurve(e.boundingBox.perimeter(),t)}static padCorner(e,t,i,n,o){let a=ei.getPaddedCorner(t,i,n,o);e.addPoint(a.a),a.numberOfPoints===2&&e.addPoint(a.b)}static padConvexCurve(e,t){let i=new ne;ei.padCorner(i,e.endPoint.prev,e.endPoint,e.startPoint,t),ei.padCorner(i,e.endPoint,e.startPoint,e.startPoint.next,t);for(let n=e.startPoint;n.next.next!=null;n=n.next)ei.padCorner(i,n,n.next,n.next.next,t);return i.closed=!0,i}static getPaddedCorner(e,t,i,n){let o=e.point,a=t.point,l=i.point,u=m.getTriangleOrientation(o,a,l)===1,c=a.sub(o),h=c.rotate((u?-Math.PI:Math.PI)/2).normalize(),d=c.normalize().add(a.sub(l).normalize());if(d.length<R.intersectionEpsilon)return{a:a.add(h.mul(n)),b:null,numberOfPoints:1};let f=d.normalize().mul(n),p=f.rotate(Math.PI/2),S=(n-f.dot(h))/p.dot(h);return{a:f.add(p.mul(S)).add(a),b:f.sub(p.mul(S)).add(a),numberOfPoints:2}}static*orientations(e){yield m.getTriangleOrientation(e.endPoint.point,e.startPoint.point,e.startPoint.next.point),yield m.getTriangleOrientation(e.endPoint.prev.point,e.endPoint.point,e.startPoint.point);let t=e.startPoint;for(;t.next.next!=null;)yield m.getTriangleOrientation(t.point,t.next.point,t.next.next.point),t=t.next}static curveIsConvex(e){let t=2;for(let i of ei.orientations(e))if(i!==2){if(t===2)t=i;else if(i!==t)return!1}return!0}creatPolygonalBoundaryWithoutPadding(){return this.hasLabel?this.labelIsToTheLeftOfTheSpline?this.polygonOnLeftLabel():this.polygonOnRightLabel():this.nodeBoundary==null?this.standardRectBoundary():I.polylineAroundClosedCurve(this.nodeBoundary)}get nodeBoundary(){return this.node==null?null:this.node.boundaryCurve}standardRectBoundary(){let e=new ne;return e.addPoint(this.leftTop),e.addPoint(this.rightTop),e.addPoint(this.rightBottom),e.addPoint(this.leftBottom),e.closed=!0,e}polygonOnLeftLabel(){let e=this.left+(1-this.labelCornersPreserveCoefficient)*this.LabelWidth;return ne.mkClosedFromPoints([new m(e,this.top),this.rightTop,this.rightBottom,new m(e,this.bottom),new m(this.left,this.y)])}polygonOnRightLabel(){let e=this.right-(1-this.labelCornersPreserveCoefficient)*this.LabelWidth;return ne.mkClosedFromPoints([new m(e,this.top),new m(this.right,this.y),new m(e,this.bottom),this.leftBottom,this.leftTop])}move(e){this.x+=e.x,this.y+=e.y}};var nh=class{constructor(e,t,i,n,o){this.xCoords=new Array(4);this.la=e,this.graph=t,this.nOfOriginalVertices=i,this.nOfVertices=this.graph.NodeCount,this.markedEdges=new Cr,this.h=this.la.Layers.length,this.root=new Array(this.nOfVertices),this.align=new Array(this.nOfVertices),this.anchors=n,this.nodeSep=o}get CurrentEnumRightUp(){return(this.LR?0:1)+2*(this.BT?0:1)}IsVirtual(e){return e>=this.nOfOriginalVertices}Source(e){return this.BT?e.Source:e.Target}Target(e){return this.BT?e.Target:e.Source}static CalculateXCoordinates(e,t,i,n,o){new nh(e,t,i,n,o).Calculate()}Calculate(){this.SortInAndOutEdges(),this.RightUpSetup(),this.CalcBiasedAlignment(),this.LeftUpSetup(),this.CalcBiasedAlignment(),this.RightDownSetup(),this.CalcBiasedAlignment(),this.LeftDownSetup(),this.CalcBiasedAlignment(),this.HorizontalBalancing()}SortInAndOutEdges(){this.FillLowMedians(),this.FillUpperMedins()}FillUpperMedins(){this.upperMedians=new Array(this.graph.NodeCount);for(let e=0;e<this.graph.NodeCount;e++)this.FillUpperMediansForNode(e)}CompareByX(e,t){return this.la.x[e]-this.la.x[t]}FillUpperMediansForNode(e){let t=this.graph.InEdgesCount(e);if(t>0){let i=new Array(t);t=0;for(let o of this.graph.InEdges(e))i[t++]=o.Source;i.sort((o,a)=>this.CompareByX(o,a));let n=Math.floor(t/2);n*2===t?this.upperMedians[e]=new me(i[n-1],i[n]):this.upperMedians[e]=i[n]}else this.upperMedians[e]=-1}FillLowMedians(){this.lowMedians=new Array(this.graph.NodeCount);for(let e=0;e<this.graph.NodeCount;e++)this.FillLowMediansForNode(e)}FillLowMediansForNode(e){let t=this.graph.OutEdgesCount(e);if(t>0){let i=new Array(t);t=0;for(let o of this.graph.OutEdges(e))i[t++]=o.Target;i.sort((o,a)=>this.CompareByX(o,a));let n=Math.floor(t/2);n*2===t?this.lowMedians[e]=new me(i[n-1],i[n]):this.lowMedians[e]=i[n]}else this.lowMedians[e]=-1}HorizontalBalancing(){let e=-1,t=new Array(4),i=new Array(4),n=Number.MAX_VALUE;for(let a=0;a<4;a++){let l={a:0,b:0};this.AssignmentBounds(a,l),t[a]=l.a,i[a]=l.b;let u=i[a]-t[a];u<n&&(e=a,n=u)}for(let a=0;a<4;a++){let l;if(nh.IsLeftMostAssignment(a)?l=t[e]-t[a]:l=i[e]-i[a],this.x=this.xCoords[a],l!==0)for(let u=0;u<this.nOfVertices;u++)this.x[u]=this.x[u]+l}let o=new Array(4);for(let a=0;a<this.nOfVertices;a++)o[0]=this.xCoords[0][a],o[1]=this.xCoords[1][a],o[2]=this.xCoords[2][a],o[3]=this.xCoords[3][a],o.sort((l,u)=>l-u),this.anchors[a].x=(o[1]+o[2])/2}static IsLeftMostAssignment(e){return e===0||e===2}AssignmentBounds(e,t){if(this.nOfVertices===0)t.a=0,t.b=0;else{this.x=this.xCoords[e],t.a=t.b=this.x[0];for(let i=1;i<this.nOfVertices;i++){let n=this.x[i];n<t.a?t.a=n:n>t.b&&(t.b=n)}}}CalcBiasedAlignment(){this.ConflictElimination(),this.Align()}LeftUpSetup(){this.LR=!1,this.BT=!0}LeftDownSetup(){this.LR=!1,this.BT=!1}RightDownSetup(){this.LR=!0,this.BT=!1}RightUpSetup(){this.LR=!0,this.BT=!0}ConflictElimination(){this.RemoveMarksFromEdges(),this.MarkConflictingEdges()}*UpperEdgeMedians(e){let t=this.BT?this.upperMedians[e]:this.lowMedians[e];if(typeof t!="number"){let n=t;this.LR?(yield n.x,yield n.y):(yield n.y,yield n.x)}else{let n=t;n>=0&&(yield n)}}MarkConflictingEdges(){let e=this.LowerOf(0,this.h-1),t=e,i=this.UpperOf(0,this.h-1),n=this.NextLower(i);for(;this.IsBelow(e,i);e=this.NextUpper(e))this.IsBelow(t,e)&&this.IsBelow(e,n)&&this.ConflictsWithAtLeastOneInnerEdgeForALayer(e)}NextUpper(e){return this.BT?e+1:e-1}NextLower(e){return this.BT?e-1:e+1}UpperOf(e,t){return this.BT?Math.max(e,t):Math.min(e,t)}LowerOf(e,t){return this.BT?Math.min(e,t):Math.max(e,t)}IsBelow(e,t){return this.BT?e<t:t<e}LeftMost(e,t){return this.LR?Math.min(e,t):Math.max(e,t)}RightMost(e,t){return this.LR?Math.max(e,t):Math.min(e,t)}IsNotRightFrom(e,t){return this.LR?e<=t:t<=e}IsLeftFrom(e,t){return this.LR?e<t:t<e}NextRight(e){return this.LR?e+1:e-1}NextLeft(e){return this.LR?e-1:e+1}ConflictsWithAtLeastOneInnerEdgeForALayer(e){if(e>=0&&e<this.la.Layers.length){let t=this.la.Layers[e],i=null,n=this.LeftMost(0,t.length-1),o=this.RightMost(0,t.length-1);for(;this.IsNotRightFrom(n,o)&&i==null;n=this.NextRight(n))i=this.InnerEdgeByTarget(t[n]);if(i!=null){let a=this.Pos(this.Source(i));for(let u=this.LeftMost(0,t.length-1);this.IsLeftFrom(u,n);u=this.NextRight(u))for(let c of this.InEdges(t[u]))this.IsLeftFrom(a,this.Pos(this.Source(c)))&&this.MarkEdge(c);let l=this.Pos(this.Source(i));for(;this.IsNotRightFrom(n,o);){let u=this.AlignmentToTheRightOfInner(t,n,a);if(n=this.NextRight(n),u!=null){let c=this.Pos(this.Source(u));this.MarkEdgesBetweenInnerAndNewInnerEdges(t,i,u,l,c),i=u,l=c}}for(let u=this.NextRight(this.Pos(this.Target(i)));this.IsNotRightFrom(u,o);u=this.NextRight(u))for(let c of this.InEdges(t[u]))this.IsLeftFrom(this.Pos(this.Source(c)),this.Pos(this.Source(i)))&&this.MarkEdge(c)}}}InEdgeOfVirtualNode(e){return this.BT?this.graph.InEdgeOfVirtualNode(e):this.graph.OutEdgeOfVirtualNode(e)}InEdges(e){return this.BT?this.graph.InEdges(e):this.graph.OutEdges(e)}MarkEdgesBetweenInnerAndNewInnerEdges(e,t,i,n,o){let a=this.NextRight(this.Pos(this.Target(t)));for(;this.IsLeftFrom(a,this.Pos(this.Target(i)));a=this.NextRight(a))for(let l of this.InEdges(e[a])){let u=this.Pos(this.Source(l));this.IsLeftFrom(u,n)?this.MarkEdge(l):this.IsLeftFrom(o,u)&&this.MarkEdge(l)}}AlignmentToTheRightOfInner(e,t,i){if(this.NumberOfInEdges(e[t])===1){let o=null;for(let a of this.InEdges(e[t]))o=a;return this.IsInnerEdge(o)&&this.IsLeftFrom(i,this.Pos(o.Source))?o:null}return null}NumberOfInEdges(e){return this.BT?this.graph.InEdgesCount(e):this.graph.OutEdgesCount(e)}Pos(e){return this.la.x[e]}InnerEdgeByTarget(e){if(this.IsVirtual(e)){let t=this.InEdgeOfVirtualNode(e);if(this.IsVirtual(this.Source(t)))return t}return null}IsInnerEdge(e){return this.IsVirtual(e.Source)&&this.IsVirtual(e.Target)}RemoveMarksFromEdges(){this.markedEdges.clear()}Align(){this.CreateBlocks(),this.AssignCoordinatesByLongestPath()}AssignCoordinatesByLongestPath(){this.x=this.xCoords[this.CurrentEnumRightUp]=new Array(this.nOfVertices);let e=new Array;for(let n=0;n<this.nOfVertices;n++)if(n===this.root[n]){let o=n;do{let a={neighbor:0};this.TryToGetRightNeighbor(o,a)&&e.push(new Br(n,this.root[a.neighbor],null)),o=this.align[o]}while(o!==n)}let t=Sr(e,this.nOfVertices),i=Ka.getOrderOnGraph(t);for(let n of i)if(n===this.root[n]){let o=0,a=!0,l=n;do{let u={neighbor:0};this.TryToGetLeftNeighbor(l,u)&&(a?(o=this.x[this.root[u.neighbor]]+this.DeltaBetweenVertices(u.neighbor,l),a=!1):o=this.RightMost(o,this.x[this.root[u.neighbor]]+this.DeltaBetweenVertices(u.neighbor,l))),l=this.align[l]}while(l!==n);this.x[n]=o}for(let n of i)if(n===this.root[n]&&t.inEdges[n].length===0){let o=n,a=this.RightMost(-nh.infinity,nh.infinity),l=a;do{let u={neighbor:0};this.TryToGetRightNeighbor(o,u)&&(a=this.LeftMost(a,this.x[this.root[u.neighbor]]-this.DeltaBetweenVertices(o,u.neighbor))),o=this.align[o]}while(o!==n);l!==a&&(this.x[n]=a)}for(let n=0;n<this.nOfVertices;n++)n!==this.root[n]&&(this.x[n]=this.x[this.root[n]])}TryToGetRightNeighbor(e,t){let i=this.NextRight(this.Pos(e)),n=this.la.Layers[this.la.y[e]];return i>=0&&i<n.length?(t.neighbor=n[i],!0):!1}TryToGetLeftNeighbor(e,t){let i=this.NextLeft(this.Pos(e)),n=this.la.Layers[this.la.y[e]];return i>=0&&i<n.length?(t.neighbor=n[i],!0):!1}CreateBlocks(){for(let t=0;t<this.nOfVertices;t++)this.root[t]=this.align[t]=t;let e=this.LowerOf(0,this.h-1);for(let t=this.NextLower(this.UpperOf(0,this.h-1));!this.IsBelow(t,e);t=this.NextLower(t)){let i=this.la.Layers[t],n=this.LeftMost(-1,this.la.Layers[this.NextUpper(t)].length),o=this.RightMost(0,i.length-1);for(let a=this.LeftMost(0,i.length-1);this.IsNotRightFrom(a,o);a=this.NextRight(a)){let l=i[a];for(let u of this.UpperEdgeMedians(l))if(!this.IsMarked(l,u)&&this.IsLeftFrom(n,this.Pos(u))){this.align[u]=l,this.root[l]=this.root[u],this.align[l]=this.root[u],n=this.Pos(u);break}}}}IsMarked(e,t){return this.BT?this.markedEdges.hasxy(t,e):this.markedEdges.hasxy(e,t)}MarkEdge(e){this.markedEdges.addNN(e.Source,e.Target)}DeltaBetweenVertices(e,t){let i;if(this.Pos(e)>this.Pos(t)){let n=e;e=t,t=n,i=-1}else i=1;return(this.anchors[e].rightAnchor+this.anchors[t].leftAnchor+this.nodeSep)*i}},yf=nh;yf.infinity=1e7;var xb=class extends lr{constructor(t,i,n,o,a){super();this.weightMultiplierOfOriginalOriginal=1;this.weightMultOfOneVirtual=3;this.weightMultiplierOfTwoVirtual=8;this.SetEdges(o,a),this.virtualVerticesStart=t.nodeCount,this.virtualVerticesEnd=i.NodeCount-1,this.layeredGraph=i,this.layerArrays=n}EdgeWeightMultiplier(t){let i=t.source,n=t.target;if(i<this.layeredGraph.NodeCount&&this.layerArrays.y[i]===this.layerArrays.y[n]&&this.layerArrays.x[i]===this.layerArrays.x[n]+1)return 0;let o=0,a=-1,l=-1;for(let c of this.outEdges[i])l===-1?l=c.target:a=c.target;return l>=this.virtualVerticesStart&&l<=this.virtualVerticesEnd&&o++,a>=this.virtualVerticesStart&&a<=this.virtualVerticesEnd&&o++,o===0?this.weightMultiplierOfOriginalOriginal:o===1?this.weightMultOfOneVirtual:this.weightMultiplierOfTwoVirtual}SetEdgeWeights(){for(let t of this.edges)t.weight=t.weight*this.EdgeWeightMultiplier(t)}};var Gs=class{constructor(e,t){this.groupSplitThreshold=2;this.initialNodes=e,this.groupSplitThreshold=t}static Calculate(e,t=0){return new Gs(e,t).Calculate()}Calculate(){return this.Calc(this.initialNodes)}Calc(e){if(e.length===0)return null;if(e.length===1)return e[0];let t=e[0].parallelogram,i=1,n=Le.parallelogramOfTwo(t,e[i].parallelogram).area;for(let h=2;h<e.length;h++){let d=Le.parallelogramOfTwo(t,e[h].parallelogram).area;d>n&&(i=h,n=d)}let o;for(let h=0;h<e.length;h++)if(h!==i){o=h;break}n=Le.parallelogramOfTwo(e[i].parallelogram,e[o].parallelogram).area;for(let h=0;h<e.length;h++){if(h===i)continue;let d=Le.parallelogramOfTwo(e[i].parallelogram,e[h].parallelogram).area;d>n&&(o=h,n=d)}let a=new Array,l=new Array;a.push(e[i]),l.push(e[o]);let u=e[i].parallelogram,c=e[o].parallelogram;for(let h=0;h<e.length;h++){if(h===i||h===o)continue;let d=Le.parallelogramOfTwo(u,e[h].parallelogram),f=d.area-u.area,p=Le.parallelogramOfTwo(c,e[h].parallelogram),S=p.area-c.area;a.length*this.groupSplitThreshold<l.length?(a.push(e[h]),u=d):l.length*this.groupSplitThreshold<a.length?(l.push(e[h]),c=p):f<S?(a.push(e[h]),u=d):(l.push(e[h]),c=p)}return{parallelogram:Le.parallelogramOfTwo(u,c),node:{children:[this.Calc(a),this.Calc(l)]},seg:void 0,leafBoxesOffset:void 0}}};var ti=class{constructor(e,t,i,n,o,a,l,u){this.topNode=e,this.bottomNode=t,this.topSite=i,this.bottomSite=i.next,this.currentTopSite=i,this.currentBottomSite=i.next,this.layerArrays=n,this.layeredGraph=o,this.originalGraph=a,this.anchors=l,this.layerSeparation=u}static Refine(e,t,i,n,o,a,l,u){new ti(e,t,i,o,a,l,n,u).Refine()}Refine(){for(this.Init();this.InsertSites(););}FixCorner(e,t,i){if(e.equal(t))return t;let n=m.ClosestPointAtLineSegment(t,e,i),o=t.sub(n),a=Math.abs(o.y),l=this.layerSeparation/2;return a>l&&(o=o.mul(l/(a*2))),o.add(t)}InsertSites(){return Sa(2)===0?this.CalculateNewTopSite()||this.CalculateNewBottomSite():this.CalculateNewBottomSite()||this.CalculateNewTopSite()}CalculateNewBottomSite(){let e=this.currentBottomSite.point.sub(this.currentTopSite.point),t=ti.absCotan(e),i,n=!1;for(let o of this.bottomCorners()){let a=ti.absCotan(o.sub(this.currentBottomSite.point));a<t&&(t=a,i=o,n=!0)}return n?ue(t,ti.absCotan(e))?!1:(this.currentBottomSite=We.mkSiteSPS(this.currentTopSite,this.FixCorner(this.currentTopSite.point,i,this.currentBottomSite.point),this.currentBottomSite),!0):!1}static absCotan(e){return Math.abs(e.x/e.y)}CalculateNewTopSite(){let e=this.currentBottomSite.point.sub(this.currentTopSite.point),t=ti.absCotan(e),i,n=!1;for(let o of this.topCorners()){let a=ti.absCotan(o.sub(this.currentTopSite.point));a<t&&(t=a,i=o,n=!0)}return n?ue(t,ti.absCotan(e))?!1:(this.currentTopSite=We.mkSiteSPS(this.currentTopSite,this.FixCorner(this.currentTopSite.point,i,this.currentBottomSite.point),this.currentBottomSite),!0):!1}Init(){this.IsTopToTheLeftOfBottom()?(this.topCorners=()=>this.CornersToTheRightOfTop(),this.bottomCorners=()=>this.CornersToTheLeftOfBottom()):(this.topCorners=()=>this.CornersToTheLeftOfTop(),this.bottomCorners=()=>this.CornersToTheRightOfBottom())}IsTopToTheLeftOfBottom(){return this.topSite.point.x<this.topSite.next.point.x}*NodeCorners(e){for(let t of this.anchors[e].polygonalBoundary.polylinePoints())yield t.point}*CornersToTheLeftOfBottom(){let e=this.layerArrays.x[this.bottomNode],t=this.currentTopSite.point.x,i=this.currentBottomSite.point.x;for(let n of this.LeftFromTheNode(this.NodeLayer(this.bottomNode),e,2,t,i))for(let o of this.NodeCorners(n))o.y>this.currentBottomSite.point.y&&ti.PossibleCorner(t,i,o)&&(yield o)}*CornersToTheLeftOfTop(){let e=this.layerArrays.x[this.topNode],t=this.currentBottomSite.point.x,i=this.currentTopSite.point.x;for(let n of this.LeftFromTheNode(this.NodeLayer(this.topNode),e,0,t,i))for(let o of this.NodeCorners(n))o.y<this.currentTopSite.point.y&&ti.PossibleCorner(t,i,o)&&(yield o)}*CornersToTheRightOfBottom(){let e=this.layerArrays.x[this.bottomNode],t=this.currentBottomSite.point.x,i=this.currentTopSite.point.x;for(let n of this.RightFromTheNode(this.NodeLayer(this.bottomNode),e,2,t,i))for(let o of this.NodeCorners(n))o.y>this.currentBottomSite.point.y&&ti.PossibleCorner(t,i,o)&&(yield o)}*CornersToTheRightOfTop(){let e=this.layerArrays.x[this.topNode],t=this.currentTopSite.point.x,i=this.currentBottomSite.point.x;for(let n of this.RightFromTheNode(this.NodeLayer(this.topNode),e,0,t,i))for(let o of this.NodeCorners(n))o.y<this.currentTopSite.point.y&&ti.PossibleCorner(t,i,o)&&(yield o)}static PossibleCorner(e,t,i){return i.x>e&&i.x<t}NodeLayer(e){return this.layerArrays.Layers[this.layerArrays.y[e]]}IsLabel(e){return this.anchors[e].hasLabel}NodeUCanBeCrossedByNodeV(e,t){return this.IsLabel(e)||this.IsLabel(t)?!1:!!(this.IsVirtualVertex(e)&&this.IsVirtualVertex(t)&&this.AdjacentEdgesIntersect(e,t))}AdjacentEdgesIntersect(e,t){return this.Intersect(this.IncomingEdge(e),this.IncomingEdge(t))||this.Intersect(this.OutcomingEdge(e),this.OutcomingEdge(t))}Intersect(e,t){return(this.layerArrays.x[e.Source]-this.layerArrays.x[t.Source])*(this.layerArrays.x[e.Target]-this.layerArrays.x[t.Target])<0}IncomingEdge(e){for(let t of this.layeredGraph.InEdges(e))return t;throw new Error}OutcomingEdge(e){for(let t of this.layeredGraph.OutEdges(e))return t;throw new Error}IsVirtualVertex(e){return e>=this.originalGraph.shallowNodeCount}*RightFromTheNode(e,t,i,n,o){let a=0,l=0;i===2&&(a=Number.MAX_VALUE),i===0&&(l=Number.MAX_VALUE);let u=e[t];for(let c=t+1;c<e.length;c++){let h=e[c];if(this.NodeUCanBeCrossedByNodeV(h,u))continue;let d=this.anchors[h];if(d.left>=o)break;d.right>n&&(d.topAnchor>l+R.distanceEpsilon?(l=d.topAnchor,yield h):d.bottomAnchor>a+R.distanceEpsilon&&(a=d.bottomAnchor,yield h))}}*LeftFromTheNode(e,t,i,n,o){let a=0,l=0;i===2&&(a=Number.MAX_VALUE),i===0&&(l=Number.MAX_VALUE);let u=e[t];for(let c=t-1;c>-1;c--){let h=e[c];if(this.NodeUCanBeCrossedByNodeV(h,u))continue;let d=this.anchors[h];if(d.right<=n)break;d.left<o&&(d.topAnchor>l+R.distanceEpsilon?(l=d.topAnchor,yield h):d.bottomAnchor>a+R.distanceEpsilon&&(a=d.bottomAnchor,yield h))}}};var hr=class{constructor(e,t,i,n,o,a,l){this.thinRightNodes=new Array;this.thinWestNodes=new Array;this.database=l,this.edgePath=e,this.anchors=t,this.layerArrays=o,this.originalGraph=i,this.settings=n,this.layeredGraph=a,this.eastHierarchy=this.BuildEastHierarchy(),this.westHierarchy=this.BuildWestHierarchy()}BuildEastHierarchy(){let e=this.FindEastBoundaryAnchorCurves(),t=new Array;for(let i of e)t.push(i.pNodeOverICurve());return this.thinEastHierarchy=Gs.Calculate(this.thinRightNodes),Gs.Calculate(t)}BuildWestHierarchy(){let e=this.FindWestBoundaryAnchorCurves(),t=new Array;for(let i of e)t.push(i.pNodeOverICurve());return this.thinWestHierarchy=Gs.Calculate(this.thinWestNodes),Gs.Calculate(t)}FindEastBoundaryAnchorCurves(){let e=new Array,t=0;for(let i of this.edgePath){let n=null;for(let o of this.EastBoundaryNodesOfANode(i,wn.GetNodeKind(t,this.edgePath))){let a=this.anchors[o];(n==null||n.origin.x>a.origin.x)&&(n=a),e.push(a.polygonalBoundary)}n!=null&&this.thinRightNodes.push(k.mkLinePXY(n.origin,this.originalGraph.right,n.y).pNodeOverICurve()),t++}return e}FindWestBoundaryAnchorCurves(){let e=[],t=0;for(let i of this.edgePath.nodes()){let n=-1;for(let o of this.LeftBoundaryNodesOfANode(i,wn.GetNodeKind(t,this.edgePath)))(n===-1||this.layerArrays.x[o]>this.layerArrays.x[n])&&(n=o),e.push(this.anchors[o].polygonalBoundary);if(n!==-1){let o=this.anchors[n];this.thinWestNodes.push(k.mkLinePXY(o.origin,this.originalGraph.left,o.origin.y).pNodeOverICurve())}t++}return e}*FillRightTopAndBottomVerts(e,t,i){let n=0,o=0;i===2?n=Number.MAX_VALUE:i===0&&(o=Number.MAX_VALUE);let a=e[t];for(let l=t+1;l<e.length;l++){let u=e[l],c=this.anchors[u];c.topAnchor>o?this.NodeUCanBeCrossedByNodeV(u,a)||(o=c.topAnchor,c.bottomAnchor>n&&(n=c.bottomAnchor),yield u):c.bottomAnchor>n&&(this.NodeUCanBeCrossedByNodeV(u,a)||(n=c.bottomAnchor,c.topAnchor>o&&(o=c.topAnchor),yield u))}}*FillLeftTopAndBottomVerts(e,t,i){let n=0,o=0;i===0?o=Number.MAX_VALUE:i===2&&(n=Number.MAX_VALUE);let a=e[t];for(let l=t-1;l>=0;l--){let u=e[l],c=this.anchors[u];c.topAnchor>o+R.distanceEpsilon?this.NodeUCanBeCrossedByNodeV(u,a)||(o=c.topAnchor,n=Math.max(n,c.bottomAnchor),yield u):c.bottomAnchor>n+R.distanceEpsilon&&(this.NodeUCanBeCrossedByNodeV(u,a)||(o=Math.max(o,c.topAnchor),n=c.bottomAnchor,yield u))}}IsVirtualVertex(e){return e>=this.originalGraph.shallowNodeCount}IsLabel(e){return this.anchors[e].hasLabel}NodeUCanBeCrossedByNodeV(e,t){return this.IsLabel(e)||this.IsLabel(t)?!1:!!(this.IsVirtualVertex(e)&&this.IsVirtualVertex(t)&&this.EdgesIntersectSomewhere(e,t))}EdgesIntersectSomewhere(e,t){return this.UVAreMiddlesOfTheSameMultiEdge(e,t)?!1:this.IntersectAbove(e,t)||this.IntersectBelow(e,t)}UVAreMiddlesOfTheSameMultiEdge(e,t){return!!(this.database.MultipleMiddles.has(e)&&this.database.MultipleMiddles.has(t)&&this.SourceOfTheOriginalEdgeContainingAVirtualNode(e)===this.SourceOfTheOriginalEdgeContainingAVirtualNode(t))}SourceOfTheOriginalEdgeContainingAVirtualNode(e){for(;this.IsVirtualVertex(e);)e=this.IncomingEdge(e).Source;return e}IntersectBelow(e,t){do{let i=this.OutcomingEdge(e),n=this.OutcomingEdge(t);if(this.Intersect(i,n))return!0;e=i.Target,t=n.Target}while(this.IsVirtualVertex(e)&&this.IsVirtualVertex(t));return e===t}IntersectAbove(e,t){do{let i=this.IncomingEdge(e),n=this.IncomingEdge(t);if(this.Intersect(i,n))return!0;e=i.Source,t=n.Source}while(this.IsVirtualVertex(e)&&this.IsVirtualVertex(t));return e===t}Intersect(e,t){let i=this.layerArrays.x[e.Source]-this.layerArrays.x[t.Source],n=this.layerArrays.x[e.Target]-this.layerArrays.x[t.Target];return i>0&&n<0||i<0&&n>0}IncomingEdge(e){return this.layeredGraph.InEdgeOfVirtualNode(e)}OutcomingEdge(e){return this.layeredGraph.OutEdgeOfVirtualNode(e)}EastBoundaryNodesOfANode(e,t){return this.FillRightTopAndBottomVerts(this.NodeLayer(e),this.layerArrays.x[e],t)}NodeLayer(e){return this.layerArrays.Layers[this.layerArrays.y[e]]}LeftBoundaryNodesOfANode(e,t){return this.FillLeftTopAndBottomVerts(this.NodeLayer(e),this.layerArrays.x[e],t)}getSpline(e){return this.createRefinedPolyline(e),this.createSmoothedPolyline()}get GetPolyline(){return new ot(this.headSite)}LineSegIntersectBound(e,t){let i=k.mkPP(e,t);return hr.CurveIntersectsHierarchy(i,this.westHierarchy)||hr.CurveIntersectsHierarchy(i,this.thinWestHierarchy)||hr.CurveIntersectsHierarchy(i,this.eastHierarchy)||hr.CurveIntersectsHierarchy(i,this.thinEastHierarchy)}SegIntersectWestBound(e,t){return hr.SegIntersectsBound(e,t,this.westHierarchy)||hr.SegIntersectsBound(e,t,this.thinWestHierarchy)}SegIntersectEastBound(e,t){return hr.SegIntersectsBound(e,t,this.eastHierarchy)||hr.SegIntersectsBound(e,t,this.thinEastHierarchy)}TryToRemoveInflectionCorner(e){if(!e.s.next||!e.s.prev||e.s.turn===1&&this.SegIntersectEastBound(e.s.prev,e.s.next)||e.s.turn===0&&this.SegIntersectWestBound(e.s.prev,e.s.next)){e.cut=!1,e.s=e.s.next;return}let t=e.s.next;e.s.prev.next=t,t.prev=e.s.prev,e.s=t,e.cut=!0}static SegIntersectsBound(e,t,i){return hr.CurveIntersectsHierarchy(k.mkPP(e.point,t.point),i)}static CurveIntersectsHierarchy(e,t){if(t==null||!Le.intersect(e.pNodeOverICurve().parallelogram,t.parallelogram))return!1;if(t.node.hasOwnProperty("children")){let i=t.node;return hr.CurveIntersectsHierarchy(e,i.children[0])||hr.CurveIntersectsHierarchy(e,i.children[1])}return I.intersectionOne(e,t.seg,!1)!=null}static Flat(e){return m.getTriangleOrientation(e.prev.point,e.point,e.next.point)===2}Reverse(){let e=new hr(this.edgePath,this.anchors,this.originalGraph,this.settings,this.layerArrays,this.layeredGraph,this.database),t=this.headSite,i=null;for(;t!=null;)e.headSite=t.clone(),e.headSite.next=i,i!=null&&(i.prev=e.headSite),i=e.headSite,t=t.next;return e}createRefinedPolyline(e){this.CreateInitialListOfSites();let t=this.headSite,i;for(let n=0;n<this.edgePath.count;n++)i=t.next,this.RefineBeetweenNeighborLayers(t,this.EdgePathNode(n),this.EdgePathNode(n+1)),t=i;this.TryToRemoveInflections(),e&&this.OptimizeShortPath()}RefineBeetweenNeighborLayers(e,t,i){ti.Refine(t,i,e,this.anchors,this.layerArrays,this.layeredGraph,this.originalGraph,this.settings.LayerSeparation)}CreateInitialListOfSites(){let e=this.headSite=We.mkSiteP(this.EdgePathPoint(0));for(let t=1;t<=this.edgePath.count;t++)e=We.mkSiteSP(e,this.EdgePathPoint(t))}get TailSite(){let e=this.headSite;for(;e.next!=null;)e=e.next;return e}OptimizeForThreeSites(){let e=this.EdgePathNode(0),t=this.EdgePathNode(2),i=this.anchors[e],n=this.anchors[t];if(ue(i.x,n.x))return;let o={ax:i.x,bx:n.x,sign:0};if(!this.FindLegalPositions(i,n,o))return;let a=(i.y-n.y)/(i.bottom-n.top),l=.5*(o.ax+o.bx),u=o.sign*((o.ax-o.bx)*.5);o.ax=l+a*(u*o.sign),o.bx=l-a*(u*o.sign),this.headSite.point=new m(o.ax,i.y);let c=this.headSite.next,h=c.point.y;c.point=new m(this.MiddlePos(o.ax,o.bx,i,n,h),h),c.next.point=new m(o.bx,n.y);let d=this.anchors[this.EdgePathNode(1)];d.x=c.point.x}OptimizeForTwoSites(){let e=this.EdgePathNode(0),t=this.EdgePathNode(1),i=this.anchors[e],n=this.anchors[t];if(ue(i.x,n.x))return;let o={ax:i.x,bx:n.x,sign:0};if(!this.FindPositions(i,n,o))return;let a=(i.y-n.y)/(i.bottom-n.top),l=.5*(o.ax+o.bx),u=o.sign*((o.ax-o.bx)*.5);o.ax=l+a*(u*o.sign),o.bx=l-a*(u*o.sign),this.headSite.point=new m(o.ax,i.y),this.headSite.next.point=new m(o.bx,n.y)}FindLegalPositions(e,t,i){return this.FindPositions(e,t,i)?this.PositionsAreLegal(i.ax,i.bx,i.sign,e,t,this.EdgePathNode(1)):!1}FindPositions(e,t,i){let n,o;if(i.ax<i.bx?(i.sign=1,o=Math.max(i.ax,t.left),n=Math.min(e.right,i.bx)):(i.sign=-1,o=Math.max(e.left,i.bx),n=Math.min(t.right,i.ax)),o<=n)i.bx=.5*(o+n),i.ax=.5*(o+n);else{if(this.OriginToOriginSegCrossesAnchorSide(e,t))return!1;i.sign===1?(i.ax=e.right-.1*e.rightAnchor,i.bx=t.left):(i.ax=e.left+.1*e.leftAnchor,i.bx=t.right)}return!0}OriginToOriginSegCrossesAnchorSide(e,t){let i=k.mkPP(e.origin,t.origin);return e.x<t.x&&I.CurvesIntersect(i,k.mkPP(e.rightBottom,e.rightTop))||I.CurvesIntersect(i,k.mkPP(t.leftBottom,e.leftTop))||e.x>t.x&&I.CurvesIntersect(i,k.mkPP(e.leftBottom,e.leftTop))||I.CurvesIntersect(i,k.mkPP(t.rightBottom,e.rightTop))}OptimizeShortPath(){this.edgePath.count>2||(this.edgePath.count===2&&this.headSite.next.next!=null&&this.headSite.next.next.next==null&&this.anchors[this.EdgePathNode(1)].node==null?this.OptimizeForThreeSites():this.edgePath.count===1&&this.OptimizeForTwoSites())}PositionsAreLegal(e,t,i,n,o,a){if(!ue(e,t)&&(e-t)*i>0)return!1;let l=this.anchors[a],u=this.MiddlePos(e,t,n,o,l.y);return this.MiddleAnchorLegal(u,a,l)?!this.LineSegIntersectBound(new m(e,n.bottom),new m(t,o.top)):!1}MiddleAnchorLegal(e,t,i){let n=this.NodeLayer(t),o=this.layerArrays.x[t],a=e-i.x;return!(o>0&&this.anchors[n[o-1]].right>a+i.left||o<n.length-1&&this.anchors[n[o+1]].left<a+i.right)}MiddlePos(e,t,i,n,o){let a=i.y-o,l=o-n.y;return(e*a+t*l)/(a+l)}TryToRemoveInflections(){if(this.TurningAlwaySameDirection())return;let e=!0;for(;e;){e=!1;for(let t={s:this.headSite,cut:!1};t.s;)this.TryToRemoveInflectionCorner(t),e=t.cut||e}}TurningAlwaySameDirection(){let e=0;for(let t=this.headSite.next;t!=null&&t.next!=null;t=t.next){let i=t.turn;if(e===0)i>0?e=1:i<0&&(e=-1);else if(e*i<0)return!1}return!0}EdgePathPoint(e){return this.anchors[this.EdgePathNode(e)].origin}EdgePathNode(e){return e===this.edgePath.count?this.edgePath.LayerEdges[this.edgePath.count-1].Target:this.edgePath.LayerEdges[e].Source}createSmoothedPolyline(){this.RemoveVerticesWithNoTurns();let e=new I,t=this.headSite,i=I.findCorner(t);return i!==void 0?(this.createFilletCurve(e,{a:t,b:i.b,c:i.c}),e=this.ExtendCurveToEndpoints(e)):e.addSegment(k.mkPP(this.headSite.point,this.TailSite.point)),e}curveIsLegal(e){return!0}RemoveVerticesWithNoTurns(){for(;this.RemoveVerticesWithNoTurnsOnePass(););}RemoveVerticesWithNoTurnsOnePass(){let e=!1;for(let t=this.headSite;t.next!=null&&t.next.next!=null;t=t.next)hr.Flat(t.next)&&(e=!0,t.next=t.next.next,t.next.prev=t);return e}ExtendCurveToEndpoints(e){let t=this.headSite.point;if(!m.closeDistEps(t,e.start)){let i=new I;i.addSegs([k.mkPP(t,e.start),e]),e=i}return t=this.TailSite.point,m.closeDistEps(t,e.end)||e.addSegment(k.mkPP(e.end,t)),e}createFilletCurve(e,t){for(;this.AddSmoothedCorner(t.a,t.b,t.c,e),t.a=t.b,t.b=t.c,t.b.next!=null;)t.c=t.b.next}AddSmoothedCorner(e,t,i,n){let o=.5,a;do a=I.createBezierSeg(o,o,e,t,i),t.previouisBezierCoefficient=o,o/=2;while(this.BezierSegIntersectsBoundary(a));if(o*=2,o<.5){o=.5*(o+o*2);let l=I.createBezierSeg(o,o,e,t,i);this.BezierSegIntersectsBoundary(l)||(t.nextBezierCoefficient=o,t.previouisBezierCoefficient=o,a=l)}n.segs.length>0&&!m.closeDistEps(n.end,a.start)&&n.addSegment(k.mkPP(n.end,a.start)),n.addSegment(a)}BezierSegIntersectsBoundary(e){return m.signedDoubledTriangleArea(e.B(0),e.B(1),e.B(2))<0?this.BezierSegIntersectsTree(e,this.thinWestHierarchy)||this.BezierSegIntersectsTree(e,this.westHierarchy):this.BezierSegIntersectsTree(e,this.thinEastHierarchy)||this.BezierSegIntersectsTree(e,this.eastHierarchy)}BezierSegIntersectsTree(e,t){if(t==null)return!1;if(Le.intersect(e.pNodeOverICurve().parallelogram,t.parallelogram))if(t.node.hasOwnProperty("children")){let i=t.node;return this.BezierSegIntersectsTree(e,i.children[0])||this.BezierSegIntersectsTree(e,i.children[1])}else return hr.BezierSegIntersectsBoundary(e,t.seg);else return!1}static BezierSegIntersectsBoundary(e,t){for(let i of I.getAllIntersections(e,t,!1))if(t instanceof I){let n=t;if(I.realCutWithClosedCurve(i,n,!1))return!0}else return!0;return!1}};var wn=class extends Pe{constructor(t,i,n,o,a,l){super(null);this.settings=t,this.OriginalGraph=i,this.Database=n,this.ProperLayeredGraph=a,this.LayerArrays=o,this.IntGraph=l}run(){this.createSplines()}createSplines(){this.createRegularSplines(),this.createSelfSplines(),this.IntGraph!=null&&this.RouteFlatEdges(),this.OriginalGraph.graph.parent==null&&this.RouteUnroutedEdges()}RouteUnroutedEdges(){let t=[];for(let l of this.OriginalGraph.deepEdges)l.curve||t.push(l);if(t.length==0)return;let n=(this.OriginalGraph.layoutSettings?this.OriginalGraph.layoutSettings:new Bt).commonSettings.edgeRoutingSettings;new ke(this.OriginalGraph,t,n.padding,n.polylinePadding,n.coneAngle,n.bundlingSettings,this.cancelToken).run(),Ji.constructorGA(this.OriginalGraph,t).run()}RouteFlatEdges(){}createRegularSplines(){for(let t of this.Database.RegularMultiedges()){if(WN(t))continue;let i=t.length,n=i===1&&this.MayOptimizeEdge(t[0]);for(let o=Math.floor(i/2);o<i;o++)this.createSplineForNonSelfEdge(t[o],n);for(let o=Math.floor(i/2)-1;o>=0;o--)this.createSplineForNonSelfEdge(t[o],n)}}MayOptimizeEdge(t){return!(this.ProperLayeredGraph.OutDegreeIsMoreThanOne(t.source)||this.ProperLayeredGraph.InDegreeIsMoreThanOne(t.target)||kA(t.edge.source)||kA(t.edge.target))}createSelfSplines(){for(let[t,i]of this.Database.Multiedges.keyValues()){let n=t;if(n.x===n.y){let o=this.Database.Anchors[n.x],a=o.leftAnchor;for(let l of i){let u=this.settings.NodeSeparation+(this.settings.MinNodeWidth+a),c=o.bottomAnchor/2,h=o.origin,d=h.add(new m(0,c)),f=h.add(new m(u,c)),p=h.add(new m(u,-c)),S=h.add(new m(0,-c)),E=We.mkSiteP(h),C=new ot(E);E=We.mkSiteSP(E,d),E=We.mkSiteSP(E,f),E=We.mkSiteSP(E,p),E=We.mkSiteSP(E,S),We.mkSiteSP(E,h);let O=C.createCurve();if(l.curve=O,a=u,l.edge.label!=null){a+=l.edge.label.width;let B=O.value((O.parStart+O.parEnd)/2),A=new m(B.x+l.labelWidth/2,o.y),N=new m(l.edge.label.width/2,l.edge.label.height/2),z=X.mkPP(A.add(N),A.sub(N));l.edge.label.width=z.width,l.edge.label.height=z.height,l.edge.label.positionCenter(A)}ut.trimSplineAndCalculateArrowheadsII(l.edge,l.edge.source.boundaryCurve,l.edge.target.boundaryCurve,O,!1)}}}}createSplineForNonSelfEdge(t,i){t.LayerEdges!=null&&(this.drawSplineBySmothingThePolyline(t,i),t.IsVirtualEdge||(t.updateEdgeLabelPosition(this.Database.Anchors),ut.trimSplineAndCalculateArrowheadsII(t.edge,t.edge.source.boundaryCurve,t.edge.target.boundaryCurve,t.curve,!0)))}drawSplineBySmothingThePolyline(t,i){let o=new hr(t,this.Database.Anchors,this.OriginalGraph,this.settings,this.LayerArrays,this.ProperLayeredGraph,this.Database).getSpline(i);t.reversed?t.curve=o.reverse():t.curve=o}static UpdateLabel(t,i){let n=null;i.labelIsToTheRightOfTheSpline?(t.label.positionCenter(new m(i.x+i.rightAnchor/2,i.y)),n=k.mkPP(t.label.boundingBox.leftTop,t.label.boundingBox.leftBottom)):i.labelIsToTheLeftOfTheSpline&&(t.label.positionCenter(new m(i.x-i.leftAnchor/2,i.y)),n=k.mkPP(t.label.boundingBox.rightTop,t.label.boundingBox.rightBottom));let o=wn.GetSegmentInFrontOfLabel(t.curve,t.label.center.y);if(o!=null&&I.getAllIntersections(t.curve,I.polyFromBox(t.label.boundingBox),!1).length===0){let a={curveClosestPoint:void 0,labelSideClosest:void 0};if(wn.FindClosestPoints(a,o,n))wn.ShiftLabel(t,a);else{let l=o.closestParameter(n.start),u=o.closestParameter(n.end);o.value(l).sub(n.start).length<o.value(u).sub(n.end).length?(a.curveClosestPoint=o.value(l),a.labelSideClosest=n.start):(a.curveClosestPoint=o.value(u),a.labelSideClosest=n.end),wn.ShiftLabel(t,a)}}}static ShiftLabel(t,i){let n=t.lineWidth/2,o=i.curveClosestPoint.sub(i.labelSideClosest),a=o.length;a>n&&t.label.positionCenter(t.label.center.add(o.div(a*(a-n))))}static FindClosestPoints(t,i,n){let o=I.minDistWithinIntervals(i,n,i.parStart,i.parEnd,n.parStart,n.parEnd,(i.parStart+i.parEnd)/2,(n.parStart+n.parEnd)/2);return o?(t.curveClosestPoint=o.aX,t.labelSideClosest=o.bX,!0):!1}static GetSegmentInFrontOfLabel(t,i){if(t instanceof I){let n=t;for(let o of n.segs)if((o.start.y-i)*(o.end.y-i)<=0)return o}return null}static GetNodeKind(t,i){return t===0?0:t<i.count?1:2}};function WN(s){if(s.length<4)return!1;for(let e of s)if(e.edge.label)return!1;return!0}function kA(s){return s.node.selfEdges.size>0}var Jc=class extends Pe{constructor(t,i,n){super(n);this.LayersAreDoubled=!1;if(t==null)return;this.originalGraph=t,this.sugiyamaSettings=i;let o=Array.from(t.shallowNodes);this.nodeIdToIndex=new Map;let a=0;for(let u of o)this.nodeIdToIndex.set(u.id,a++);let l=[];for(let u of this.originalGraph.shallowEdges){let c=this.nodeIdToIndex.get(u.source.id);if(c==null)continue;let h=this.nodeIdToIndex.get(u.target.id);if(h==null)continue;let d=new Br(c,h,u);l.push(d)}this.IntGraph=new Ko(l,t.shallowNodeCount),this.IntGraph.nodes=o,this.database=new mb(o.length);for(let u of this.IntGraph.edges)this.database.registerOriginalEdgeInMultiedges(u);this.cycleRemoval()}get extremeAspectRatio(){let t=this.originalGraph.boundingBox,i=t.width/t.height;return i<1/50||i>50}get verticalConstraints(){return this.sugiyamaSettings.verticalConstraints}get HorizontalConstraints(){return this.sugiyamaSettings.horizontalConstraints}run(){if(this.originalGraph.shallowNodeCount===0){this.originalGraph.boundingBox=X.mkEmpty();return}nM(this.originalGraph,this.sugiyamaSettings.transform),this.engineLayerArrays=this.calculateLayers(),this.sugiyamaSettings.edgeRoutingSettings.EdgeRoutingMode===3&&this.runPostLayering(),oM(this.originalGraph,this.sugiyamaSettings.transform)}runPostLayering(){let t=this.sugiyamaSettings.commonSettings.edgeRoutingSettings,i=this.constrainedOrdering!=null?0:t.EdgeRoutingMode;this.extremeAspectRatio?Km(this.originalGraph,Array.from(this.originalGraph.deepEdges),this.cancelToken):i===3?this.calculateEdgeSplines():ou(this.originalGraph,Array.from(this.originalGraph.deepEdges),this.cancelToken)}SetLabels(){throw new Error("not implementedt")}cycleRemoval(){let t=this.sugiyamaSettings.verticalConstraints,i=t.isEmpty?Ii.getFeedbackSet(this.IntGraph):t.getFeedbackSetExternal(this.IntGraph,this.nodeIdToIndex);this.database.addFeedbackSet(i)}calculateLayers(){this.CreateGluedDagSkeletonForLayering();let t=this.CalculateLayerArrays();return this.UpdateNodePositionData(),t}UpdateNodePositionData(){for(let t=0;t<this.IntGraph.nodeCount&&t<this.database.Anchors.length;t++)this.IntGraph.nodes[t].center=this.database.Anchors[t].origin;if(this.sugiyamaSettings.GridSizeByX>0)for(let t=0;t<this.originalGraph.shallowNodeCount;t++)this.SnapLeftSidesOfTheNodeToGrid(t,this.sugiyamaSettings.GridSizeByX)}SnapLeftSidesOfTheNodeToGrid(t,i){let n=this.IntGraph.nodes[t],o=this.database.Anchors[t];o.leftAnchor-=i/2,o.rightAnchor-=i/2;let a=n.boundingBox.left,l=Math.floor(a/i),u=a-l*i;Math.abs(u)<.001||(Math.abs(u)<=i/2?n.center=n.center.add(new m(-u,0)):n.center=n.center.add(new m(i-u,0)),o.x=n.center.x)}GetCurrentHeight(){let t=new Xi;for(let i of this.NodeAnchors())t.AddValue(i.top),t.AddValue(i.bottom);return t.length}*NodeAnchors(){let t=Math.min(this.IntGraph.nodeCount,this.anchors.length);for(let i=0;i<t;i++)yield this.anchors[i]}GetCurrentWidth(){let t=new Xi;for(let i of this.NodeAnchors())t.AddValue(i.left),t.AddValue(i.right);return t.length}ExtendLayeringToUngluedSameLayerVertices(t){let i=this.verticalConstraints;for(let n=0;n<t.length;n++)t[n]=t[i.nodeToRepr(n)];return t}calculateEdgeSplines(){new wn(this.sugiyamaSettings,this.originalGraph,this.database,this.engineLayerArrays,this.properLayeredGraph,this.IntGraph).run()}YLayeringAndOrdering(t){let i=t.GetLayers();rh.Balance(this.gluedDagSkeletonForLayering,i,this.GetNodeCountsOfGluedDag(),null),i=this.ExtendLayeringToUngluedSameLayerVertices(i);let n=new Oi(i);if(this.HorizontalConstraints==null||this.HorizontalConstraints.IsEmpty)return n=this.YLayeringAndOrderingWithoutHorizontalConstraints(n),n;throw new Error("not implemented")}CreateProperLayeredGraph(t){let i=t.length,n=0;for(let a of this.database.SkeletonEdges()){let l=YN(t,a);l>0&&(a.LayerEdges=new Array(l));let u=0;if(l>1){let c=i+n++,h=new Li(a.source,c,a.CrossingWeight,a.weight);a.LayerEdges[u++]=h;for(let d=0;d<l-2;d++)c++,n++,h=new Li(c-1,c,a.CrossingWeight,a.weight),a.LayerEdges[u++]=h;h=new Li(c,a.target,a.CrossingWeight,a.weight),a.LayerEdges[u]=h}else if(l===1){let c=new Li(a.source,a.target,a.CrossingWeight,a.weight);a.LayerEdges[u]=c}}let o=new Array(this.originalGraph.shallowNodeCount+n).fill(0);for(let a of this.database.SkeletonEdges())if(a.LayerEdges!=null){let l=t[a.source];o[a.source]=l--;for(let u of a.LayerEdges)o[u.Target]=l--}else o[a.source]=t[a.source],o[a.target]=t[a.target];return this.properLayeredGraph=new In(new Ko(Array.from(this.database.SkeletonEdges()),t.length)),this.properLayeredGraph.BaseGraph.nodes=this.IntGraph.nodes,new Oi(o)}YLayeringAndOrderingWithoutHorizontalConstraints(t){let i=this.CreateProperLayeredGraph(t.y);return Ds.OrderLayers(this.properLayeredGraph,i,this.originalGraph.shallowNodeCount,this.sugiyamaSettings,this.cancelToken),fu.UpdateLayerArrays1(this.properLayeredGraph,i),i}CalculateYLayers(){let t=this.YLayeringAndOrdering(new Eb(this.gluedDagSkeletonForLayering,this.cancelToken));return this.constrainedOrdering!=null?t:this.InsertLayersIfNeeded(t)}InsertLayersIfNeeded(t){this.InsertVirtualEdgesIfNeeded(t);let i=this.AnalyzeNeedToInsertLayersAndHasMultiedges(t);if(i.needToInsertLayers){let n=Bs.InsertLayers(this.properLayeredGraph,t,this.database,this.IntGraph);this.properLayeredGraph=n.layeredGraph,t=n.la,this.LayersAreDoubled=!0}else if(i.multipleEdges){let n=$n.InsertPaths(this.properLayeredGraph,t,this.database,this.IntGraph);this.properLayeredGraph=n.layeredGraph,t=n.la}return this.RecreateIntGraphFromDataBase(),t}RecreateIntGraphFromDataBase(){let t=new Array;for(let i of this.database.Multiedges.values())t=t.concat(i);this.IntGraph.SetEdges(t,this.IntGraph.nodeCount)}InsertVirtualEdgesIfNeeded(t){if(this.constrainedOrdering==null){for(let[i,n]of this.database.Multiedges.keyValues())if(n.length%2===0&&t.y[i.x]-1===t.y[i.y]){let o=new Ye(null),a=new Br(i.x,i.y,o);a.IsVirtualEdge=!0,n.splice(n.length/2,0,a),this.IntGraph.addEdge(a)}}}AnalyzeNeedToInsertLayersAndHasMultiedges(t){let i=!1,n=!1;for(let o of this.IntGraph.edges)if(o.hasLabel&&t.y[o.source]!==t.y[o.target]){i=!0;break}if(i===!1&&this.constrainedOrdering==null){for(let[o,a]of this.database.Multiedges.keyValues())if(a.length>1&&(n=!0,t.y[o.x]-t.y[o.y]===1)){i=!0;break}}return{needToInsertLayers:i,multipleEdges:n}}UseBrandesXCalculations(t){return t.x.length>=this.sugiyamaSettings.BrandesThreshold}CalculateAnchorsAndYPositions(t){this.anchors=jN(this.database,this.properLayeredGraph,this.originalGraph,this.IntGraph,this.sugiyamaSettings),qN(t,500,this.originalGraph,this.database,this.IntGraph,this.sugiyamaSettings,this.LayersAreDoubled)}OptimizeEdgeLabelsLocations(){for(let t=0;t<this.anchors.length;t++){let i=this.anchors[t];if(i.labelIsToTheRightOfTheSpline){let n=this.GetSuccessorAndPredecessor(t);if(!JN(i,n.predecessor,n.successor)){let o=n.predecessor.origin.sub(i.origin).length+n.successor.origin.sub(i.origin).length,a=i.right-i.leftAnchor,l=new m(a,i.y);n.predecessor.origin.sub(l).length+n.successor.origin.sub(l).length<o&&WA(i)}}}}GetSuccessorAndPredecessor(t){let i;for(let o of this.properLayeredGraph.InEdges(t))i=o.Source;let n;for(let o of this.properLayeredGraph.OutEdges(t))n=o.Target;return{predecessor:this.anchors[i],successor:this.anchors[n]}}CalculateLayerArrays(){let t=this.CalculateYLayers();return this.constrainedOrdering==null?(this.CalculateAnchorsAndYPositions(t),this.UseBrandesXCalculations(t)?this.CalculateXPositionsByBrandes(t):this.CalculateXLayersByGansnerNorth(t)):this.anchors=this.database.Anchors,this.OptimizeEdgeLabelsLocations(),this.engineLayerArrays=t,this.StraightensShortEdges(),this.CalculateOriginalGraphBox(),t}StretchToDesiredAspectRatio(t,i){t>i?this.StretchInYDirection(t/i):t<i&&this.StretchInXDirection(i/t)}StretchInYDirection(t){let i=(this.originalGraph.boundingBox.top+this.originalGraph.boundingBox.bottom)/2;for(let o of this.database.Anchors)o.bottomAnchor=o.bottomAnchor*t,o.topAnchor=o.topAnchor*t,o.y=i+t*(o.y-i);let n=this.originalGraph.height*t;this.originalGraph.boundingBox=new X({left:this.originalGraph.boundingBox.left,top:i+n/2,right:this.originalGraph.boundingBox.right,bottom:i-n/2})}StretchInXDirection(t){let i=(this.originalGraph.boundingBox.left+this.originalGraph.boundingBox.right)/2;for(let o of this.database.Anchors)o.leftAnchor=o.leftAnchor*t,o.rightAnchor=o.rightAnchor*t,o.x=i+t*(o.x-i);let n=this.originalGraph.width*t;this.originalGraph.boundingBox=new X({left:i-n/2,top:this.originalGraph.boundingBox.top,right:i+n/2,bottom:this.originalGraph.boundingBox.bottom})}CalculateOriginalGraphBox(){if(this.anchors.length===0)return;let t=new X({left:this.anchors[0].left,top:this.anchors[0].top,right:this.anchors[0].right,bottom:this.anchors[0].bottom});for(let i=1;i<this.anchors.length;i++){let n=this.anchors[i];t.add(n.leftTop),t.add(n.rightBottom)}this.originalGraph.labelSize&&this.originalGraph.addLabelToGraphBB(t),t.padEverywhere(this.originalGraph.margins),this.originalGraph.boundingBox=t}StraightensShortEdges(){for(;this.StraightenEdgePaths(););}StraightenEdgePaths(){let t=!1;for(let i of this.database.AllIntEdges())i.LayerSpan===2&&(t=this.ShiftVertexWithNeighbors(i.LayerEdges[0].Source,i.LayerEdges[0].Target,i.LayerEdges[1].Target)||t);return t}ShiftVertexWithNeighbors(t,i,n){let o=this.database.Anchors[t],a=this.database.Anchors[n],l=this.database.Anchors[i],u=(l.y-o.y)*((a.x-o.x)/(a.y-o.y))+o.x,c=1e-4;return u>l.x+c?this.TryShiftToTheRight(u,i):u<l.x-c?this.TryShiftToTheLeft(u,i):!1}TryShiftToTheLeft(t,i){let n=this.engineLayerArrays.Layers[this.engineLayerArrays.y[i]],o=this.engineLayerArrays.x[i];if(o>0){let a=this.database.Anchors[n[o-1]],l=Math.max(a.right+(this.sugiyamaSettings.NodeSeparation+this.database.Anchors[i].leftAnchor),t);return l<this.database.Anchors[i].x-1?(this.database.Anchors[i].x=l,!0):!1}return this.database.Anchors[i].x=t,!0}TryShiftToTheRight(t,i){let n=this.engineLayerArrays.Layers[this.engineLayerArrays.y[i]],o=this.engineLayerArrays.x[i];if(o<n.length-1){let a=this.database.Anchors[n[o+1]],l=Math.min(a.left-(this.sugiyamaSettings.NodeSeparation-this.database.Anchors[i].rightAnchor),t);return l>this.database.Anchors[i].x+1?(this.database.Anchors[i].x=l,!0):!1}return this.database.Anchors[i].x=t,!0}CalculateXLayersByGansnerNorth(t){this.xLayoutGraph=this.CreateXLayoutGraph(t),this.CalculateXLayersByGansnerNorthOnProperLayeredGraph()}CalculateXLayersByGansnerNorthOnProperLayeredGraph(){let t=new ih(this.xLayoutGraph,null).GetLayers();for(let i=0;i<this.database.Anchors.length;i++)this.anchors[i].x=t[i]}CreateXLayoutGraph(t){let i=this.properLayeredGraph.NodeCount,n=new Array;for(let a of this.properLayeredGraph.Edges){let l=new Br(i,a.Source,null),u=new Br(i,a.Target,null);u.weight=a.Weight,l.weight=a.Weight,l.separation=0,u.separation=0,i++,n.push(l),n.push(u)}for(let a of t.Layers)for(let l=a.length-1;l>0;l--){let u=a[l],c=a[l-1],h=new Br(u,c,null),d=this.database.Anchors[u],f=this.database.Anchors[c],p=d.leftAnchor+(f.rightAnchor+this.sugiyamaSettings.NodeSeparation);h.separation=Math.ceil(p+.5),n.push(h)}let o=new xb(this.IntGraph,this.properLayeredGraph,t,n,i);return o.SetEdgeWeights(),o}CalculateXPositionsByBrandes(t){yf.CalculateXCoordinates(t,this.properLayeredGraph,this.originalGraph.shallowNodeCount,this.database.Anchors,this.sugiyamaSettings.NodeSeparation)}GluedDagSkeletonEdges(){let t=new jr;for(let[n,o]of this.database.Multiedges.keyValues()){if(n.isDiagonal())continue;let a=this.verticalConstraints.gluedIntEdge(o[0]);a.source!==a.target&&t.set(a.source,a.target,a)}let i=Array.from(this.verticalConstraints.gluedUpDownIntConstraints.values()).map(n=>XN(n,null));for(let n of i)t.set(n.source,n.target,n);return Array.from(t.values())}static CalcAnchorsForOriginalNode(t,i,n,o,a){let l={leftAnchor:0,rightAnchor:0,topAnchor:0,bottomAnchor:0};if(i.nodes!=null){let h=i.nodes[t];tM(l,h,a)}rM(t,l,o,a);let u=a.MinNodeWidth/2;l.leftAnchor<u&&(l.leftAnchor=u),l.rightAnchor<u&&(l.rightAnchor=u);let c=a.MinNodeHeight/2;l.topAnchor<c&&(l.topAnchor=c),l.bottomAnchor<c&&(l.bottomAnchor=c),n[t]=ei.mkAnchor(l.leftAnchor,l.rightAnchor,l.topAnchor,l.bottomAnchor,i.nodes[t],a.LabelCornersPreserveCoefficient),n[t].padding=i.nodes[t].padding}CreateGluedDagSkeletonForLayering(){this.gluedDagSkeletonForLayering=new Ko(this.GluedDagSkeletonEdges(),this.originalGraph.shallowNodeCount),this.SetGluedEdgesWeights()}SetGluedEdgesWeights(){let t=new jr;for(let i of this.gluedDagSkeletonForLayering.edges)t.set(i.source,i.target,i);for(let[i,n]of this.database.Multiedges.keyValues())if(i.x!==i.y){let o=this.verticalConstraints.gluedIntPair(i);if(o.x===o.y)continue;let a=t.get(o.x,o.y);for(let l of n)a.weight+=l.weight}}GetNodeCountsOfGluedDag(){return this.verticalConstraints.isEmpty?new Array(this.IntGraph.nodeCount).fill(1):this.verticalConstraints.getGluedNodeCounts()}};function VA(s,e){if(e===0)return 0;let t=Math.floor(s/e),i=s-t*e;return Math.abs(i)<1e-4?0:e-i}function HN(s,e){for(let t of s)if(t<e)return!0;return!1}function jN(s,e,t,i,n){let o=s.Anchors=new Array(e.NodeCount);for(let a=0;a<o.length;a++)o[a]=new ei(n.LabelCornersPreserveCoefficient);for(let a=0;a<t.shallowNodeCount;a++)Jc.CalcAnchorsForOriginalNode(a,i,o,s,n);for(let a of s.AllIntEdges())if(a.LayerEdges!=null){for(let l of a.LayerEdges){let u=l.Target;if(u!==a.target){let c=o[u];s.MultipleMiddles.has(u)?(c.leftAnchor=c.rightAnchor=pS()*4,c.topAnchor=c.bottomAnchor=UA(n)/2):(c.leftAnchor=c.rightAnchor=pS()/2,c.topAnchor=c.bottomAnchor=UA(n)/2)}}if(a.hasLabel){let l=a.LayerEdges[a.LayerEdges.length/2].Source,u=o[l],c=a.labelWidth,h=a.labelHeight;u.rightAnchor=c,u.leftAnchor=pS()*8,u.topAnchor<h/2&&(u.topAnchor=u.bottomAnchor=h/2),u.labelIsToTheRightOfTheSpline=!0}}return o}function pS(){return 1}function UA(s){return s.MinNodeHeight*1.5/8}function zA(s,e,t,i,n,o){let a=0;if(t>0){let l=$N(e.Layers[t-1],e.y,i);if(l.length){let u=n.LayerSeparation/3,c=o;a=Math.max(...l.map(h=>eM(h,c,u,s)))}}return a}function qN(s,e,t,i,n,o,a){let l=i.Anchors,u=t.margins.top+e,c=0;for(let h of s.Layers){let d=0,f=0;for(let O of h){let B=l[O];B.bottomAnchor>d&&(d=B.bottomAnchor),B.topAnchor>f&&(f=B.topAnchor)}KN(h,d,f,t.shallowNodeCount,i.Anchors);let p=zA(i,s,c,n,o,u),S=u+d+p,E=S+f;if(ZN(o)){E+=VA(E,o.GridSizeByY);for(let O of h)l[O].top=E}else if(QN(o)){let O=S-d;O+=VA(O,O);for(let B of h)l[B].bottom=O,E=Math.max(l[B].top,E)}else for(let O of h)l[O].y=S;let C=o.ActualLayerSeparation(a);u=E+C,c++}zA(i,s,c,n,o,u)}function XN(s,e){let t=new Br(s.x,s.y,e);return t.weight=0,t.separation=1,t}function YN(s,e){return s[e.source]-s[e.target]}function KN(s,e,t,i,n){if(HN(s,i)){for(let o of s)if(o>=i){let a=n[o];a.bottomAnchor=e,a.topAnchor=t}}}function ZN(s){return s.SnapToGridByY===1}function QN(s){return s.SnapToGridByY===2}function JN(s,e,t){if(s.labelIsToTheRightOfTheSpline){if(m.getTriangleOrientation(e.origin,s.origin,t.origin)===0)return!0;let i=s.leftAnchor,n=s.rightAnchor,o=s.x;return WA(s),m.getTriangleOrientation(e.origin,s.origin,t.origin)===1?!0:(s.x=o,s.leftAnchor=i,s.rightAnchor=n,s.labelIsToTheRightOfTheSpline=!0,s.labelIsToTheLeftOfTheSpline=!1,!1)}return!1}function WA(s){let e=s.right,t=s.leftAnchor;s.leftAnchor=s.rightAnchor,s.rightAnchor=t,s.x=e-s.rightAnchor,s.labelIsToTheLeftOfTheSpline=!0,s.labelIsToTheRightOfTheSpline=!1}function $N(s,e,t){let i=new Cr;for(let n of s)if(!(n>=t.nodeCount))for(let o of t.outEdges[n])e[o.source]===e[o.target]&&i.addNN(o.source,o.target);return Array.from(i.values())}function eM(s,e,t,i){let n=0,o=i.GetMultiedgeI(s);for(let a of o){n+=t;let l=a.edge.label;l!=null&&(l.positionCenter(new m(l.center.x,e+n+l.height/2)),n+=l.height)}return n}function tM(s,e,t){s.rightAnchor=s.leftAnchor=(e.width+t.GridSizeByX)/2,s.topAnchor=s.bottomAnchor=e.height/2}function rM(s,e,t,i){let n=iM(t,s,e,i);e.rightAnchor+=n}function iM(s,e,t,i){let n=0,o=s.GetMultiedge(e,e);if(o.length>0){for(let a of o)a.edge.label!=null&&(t.rightAnchor+=a.edge.label.width,t.topAnchor<a.edge.label.height/2&&(t.topAnchor=t.bottomAnchor=a.edge.label.height/2));n+=(i.NodeSeparation+i.MinNodeWidth)*o.length}return n}function nM(s,e){if(e.isIdentity())return;let t=e.inverse();for(let i of s.shallowNodes)i.transform(t);for(let i of s.shallowEdges)if(i.label!=null){let n=X.mkPP(t.multiplyPoint(new m(0,0)),t.multiplyPoint(new m(i.label.width,i.label.height)));i.label.width=n.width,i.label.height=n.height}}function oM(s,e){if(!e.isIdentity()){for(let t of s.shallowNodes)t.transform(e);for(let t of s.shallowEdges)if(t.label!=null){let i=X.mkPP(e.multiplyPoint(new m(0,0)),e.multiplyPoint(new m(t.label.width,t.label.height)));t.label.width=i.width,t.label.height=i.height}sM(s,e),s.graph.parent==null&&(s.boundingBox=null)}}function sM(s,e){for(let t of s.shallowEdges)t.label&&t.label.transform(e),aM(e,t)}function aM(s,e){if(e.curve!=null){e.curve=e.curve.transform(s);let t=e;t.sourceArrowhead!=null&&(t.sourceArrowhead.tipPosition=s.multiplyPoint(t.sourceArrowhead.tipPosition)),t.targetArrowhead!=null&&(t.targetArrowhead.tipPosition=s.multiplyPoint(t.targetArrowhead.tipPosition)),lM(e,s)}}function lM(s,e){if(s.smoothedPolyline!=null)for(let t=s.smoothedPolyline.headSite;t!=null;t=t.next)t.point=e.multiplyPoint(t.point)}var u1=Ae(YA(),1);var eo=(A=>(A[A.normal=0]="normal",A[A.inv=1]="inv",A[A.dot=2]="dot",A[A.invdot=3]="invdot",A[A.odot=4]="odot",A[A.invodot=5]="invodot",A[A.none=6]="none",A[A.tee=7]="tee",A[A.empty=8]="empty",A[A.invempty=9]="invempty",A[A.diamond=10]="diamond",A[A.odiamond=11]="odiamond",A[A.ediamond=12]="ediamond",A[A.crow=13]="crow",A[A.box=14]="box",A[A.obox=15]="obox",A[A.open=16]="open",A[A.halfopen=17]="halfopen",A[A.vee=18]="vee",A))(eo||{});var Zo=(N=>(N[N.diamond=0]="diamond",N[N.ellipse=1]="ellipse",N[N.box=2]="box",N[N.circle=3]="circle",N[N.record=4]="record",N[N.plaintext=5]="plaintext",N[N.point=6]="point",N[N.mdiamond=7]="mdiamond",N[N.msquare=8]="msquare",N[N.polygon=9]="polygon",N[N.doublecircle=10]="doublecircle",N[N.house=11]="house",N[N.invhouse=12]="invhouse",N[N.parallelogram=13]="parallelogram",N[N.octagon=14]="octagon",N[N.tripleoctagon=15]="tripleoctagon",N[N.triangle=16]="triangle",N[N.trapezium=17]="trapezium",N[N.drawFromGeometry=18]="drawFromGeometry",N[N.hexagon=19]="hexagon",N))(Zo||{});var vb=(o=>(o[o.same=0]="same",o[o.min=1]="min",o[o.source=2]="source",o[o.max=3]="max",o[o.sink=4]="sink",o))(vb||{});var Sf=(c=>(c[c.none=0]="none",c[c.dashed=1]="dashed",c[c.solid=2]="solid",c[c.invis=3]="invis",c[c.bold=4]="bold",c[c.filled=5]="filled",c[c.diagonals=6]="diagonals",c[c.dotted=7]="dotted",c[c.rounded=8]="rounded",c))(Sf||{});var Cb=(n=>(n[n.forward=0]="forward",n[n.back=1]="back",n[n.both=2]="both",n[n.none=3]="none",n))(Cb||{});var Ab=(t=>(t[t.in=0]="in",t[t.out=1]="out",t))(Ab||{});var L=class{static mkWithKeyword(e,t,i,n,o){let a=new L(e,t,i,n);return a.keyword=o,a}static parse(e){switch(e.toLowerCase()){case"aliceblue":return L.AliceBlue;case"antiquewhite":return L.AntiqueWhite;case"aqua":return L.Aqua;case"aquamarine":return L.Aquamarine;case"azure":return L.Azure;case"beige":return L.Beige;case"bisque":return L.Bisque;case"black":return L.Black;case"blanchedalmond":return L.BlanchedAlmond;case"blue":return L.Blue;case"blueviolet":return L.BlueViolet;case"brown":return L.Brown;case"burlywood":return L.BurlyWood;case"cadetblue":return L.CadetBlue;case"chartreuse":return L.Chartreuse;case"chocolate":return L.Chocolate;case"coral":return L.Coral;case"cornflowerblue":return L.CornflowerBlue;case"cornsilk":return L.Cornsilk;case"crimson":return L.Crimson;case"cyan":return L.Cyan;case"darkblue":return L.DarkBlue;case"darkcyan":return L.DarkCyan;case"darkgoldenrod":return L.DarkGoldenrod;case"darkgray":return L.DarkGray;case"darkgreen":return L.DarkGreen;case"darkkhaki":return L.DarkKhaki;case"darkmagenta":return L.DarkMagenta;case"darkolivegreen":return L.DarkOliveGreen;case"darkorange":return L.DarkOrange;case"darkorchid":return L.DarkOrchid;case"darkred":return L.DarkRed;case"darksalmon":return L.DarkSalmon;case"darkseagreen":return L.DarkSeaGreen;case"darkslateblue":return L.DarkSlateBlue;case"darkslategray":return L.DarkSlateGray;case"darkturquoise":return L.DarkTurquoise;case"darkviolet":return L.DarkViolet;case"deeppink":return L.DeepPink;case"deepskyblue":return L.DeepSkyBlue;case"dimgray":return L.DimGray;case"dodgerblue":return L.DodgerBlue;case"firebrick":return L.Firebrick;case"floralwhite":return L.FloralWhite;case"forestgreen":return L.ForestGreen;case"fuchsia":return L.Fuchsia;case"gainsboro":return L.Gainsboro;case"ghostwhite":return L.GhostWhite;case"gold":return L.Gold;case"goldenrod":return L.Goldenrod;case"gray":return L.Gray;case"green":return L.Green;case"greenyellow":return L.GreenYellow;case"honeydew":return L.Honeydew;case"hotpink":return L.HotPink;case"indianred":return L.IndianRed;case"indigo":return L.Indigo;case"ivory":return L.Ivory;case"khaki":return L.Khaki;case"lavender":return L.Lavender;case"lavenderblush":return L.LavenderBlush;case"lawngreen":return L.LawnGreen;case"lemonchiffon":return L.LemonChiffon;case"lightblue":return L.LightBlue;case"lightcoral":return L.LightCoral;case"lightcyan":return L.LightCyan;case"lightgoldenrodyellow":return L.LightGoldenrodYellow;case"lightgray":case"lightgrey":return L.LightGray;case"lightgreen":return L.LightGreen;case"lightpink":return L.LightPink;case"lightsalmon":return L.LightSalmon;case"lightseagreen":return L.LightSeaGreen;case"lightskyblue":return L.LightSkyBlue;case"lightslategray":return L.LightSlateGray;case"lightsteelblue":return L.LightSteelBlue;case"lightyellow":return L.LightYellow;case"lime":return L.Lime;case"limegreen":return L.LimeGreen;case"linen":return L.Linen;case"magenta":return L.Magenta;case"maroon":return L.Maroon;case"mediumaquamarine":return L.MediumAquamarine;case"mediumblue":return L.MediumBlue;case"mediumorchid":return L.MediumOrchid;case"mediumpurple":return L.MediumPurple;case"mediumseagreen":return L.MediumSeaGreen;case"mediumslateblue":return L.MediumSlateBlue;case"mediumspringgreen":return L.MediumSpringGreen;case"mediumturquoise":return L.MediumTurquoise;case"mediumvioletred":return L.MediumVioletRed;case"midnightblue":return L.MidnightBlue;case"mintcream":return L.MintCream;case"mistyrose":return L.MistyRose;case"moccasin":return L.Moccasin;case"navajowhite":return L.NavajoWhite;case"navy":return L.Navy;case"oldlace":return L.OldLace;case"olive":return L.Olive;case"olivedrab":return L.OliveDrab;case"orange":return L.Orange;case"orangered":return L.OrangeRed;case"orchid":return L.Orchid;case"palegoldenrod":return L.PaleGoldenrod;case"palegreen":return L.PaleGreen;case"paleturquoise":return L.PaleTurquoise;case"palevioletred":return L.PaleVioletRed;case"papayawhip":return L.PapayaWhip;case"peachpuff":return L.PeachPuff;case"peru":return L.Peru;case"pink":return L.Pink;case"plum":return L.Plum;case"powderblue":return L.PowderBlue;case"purple":return L.Purple;case"red":return L.Red;case"rosybrown":return L.RosyBrown;case"royalblue":return L.RoyalBlue;case"saddlebrown":return L.SaddleBrown;case"salmon":return L.Salmon;case"sandybrown":return L.SandyBrown;case"seagreen":return L.SeaGreen;case"seashell":return L.SeaShell;case"sienna":return L.Sienna;case"silver":return L.Silver;case"skyblue":return L.SkyBlue;case"slateblue":return L.SlateBlue;case"slategray":return L.SlateGray;case"snow":return L.Snow;case"springgreen":return L.SpringGreen;case"steelblue":return L.SteelBlue;case"tan":return L.Tan;case"teal":return L.Teal;case"thistle":return L.Thistle;case"tomato":return L.Tomato;case"transparent":return L.Transparent;case"turquoise":return L.Turquoise;case"violet":return L.Violet;case"wheat":return L.Wheat;case"white":return L.White;case"whitesmoke":return L.WhiteSmoke;case"yellow":return L.Yellow;case"yellowgreen":return L.YellowGreen;default:return}}get keyword(){return this.keyword_}set keyword(e){this.keyword_=e}constructor(e,t,i,n){this.a=e,this.r=t,this.g=i,this.b=n}static mkRGB(e,t,i){return new L(255,e,t,i)}get A(){return this.a}set A(e){this.a=e}get R(){return this.r}set R(e){this.r=e}get G(){return this.g}set G(e){this.g=e}get B(){return this.b}set B(e){this.b=e}static Xex(e){let t=e.toString(16);return t.length===1?"0"+t:t.substring(t.length-2,2)}static equal(e,t){return e.a===t.a&&e.r===t.r&&e.b===t.b&&e.g===t.g}toString(){return this.keyword?this.keyword:'"#'+L.Xex(this.R)+L.Xex(this.G)+L.Xex(this.B)+(this.A===255?"":L.Xex(this.A))+'"'}static get AliceBlue(){return L.mkWithKeyword(255,240,248,255,"aliceblue")}static get AntiqueWhite(){return L.mkWithKeyword(255,250,235,215,"antiquewhite")}static get Aqua(){return L.mkWithKeyword(255,0,255,255,"aqua")}static get Aquamarine(){return L.mkWithKeyword(255,127,255,212,"aquamarine")}static get Azure(){return L.mkWithKeyword(255,240,255,255,"azure")}static get Beige(){return L.mkWithKeyword(255,245,245,220,"beige")}static get Bisque(){return L.mkWithKeyword(255,255,228,196,"bisque")}static get Black(){return L.mkWithKeyword(255,0,0,0,"black")}static get BlanchedAlmond(){return L.mkWithKeyword(255,255,235,205,"blanchedalmond")}static get Blue(){return L.mkWithKeyword(255,0,0,255,"blue")}static get BlueViolet(){return L.mkWithKeyword(255,138,43,226,"blueviolet")}static get Brown(){return L.mkWithKeyword(255,165,42,42,"brown")}static get BurlyWood(){return L.mkWithKeyword(255,222,184,135,"burlywood")}static get CadetBlue(){return L.mkWithKeyword(255,95,158,160,"cadetblue")}static get Chartreuse(){return L.mkWithKeyword(255,127,255,0,"chartreuse")}static get Chocolate(){return L.mkWithKeyword(255,210,105,30,"chocolate")}static get Coral(){return L.mkWithKeyword(255,255,127,80,"coral")}static get CornflowerBlue(){return L.mkWithKeyword(255,100,149,237,"cornflowerblue")}static get Cornsilk(){return L.mkWithKeyword(255,255,248,220,"cornsilk")}static get Crimson(){return L.mkWithKeyword(255,220,20,60,"crimson")}static get Cyan(){return L.mkWithKeyword(255,0,255,255,"cyan")}static get DarkBlue(){return L.mkWithKeyword(255,0,0,139,"darkblue")}static get DarkCyan(){return L.mkWithKeyword(255,0,139,139,"darkcyan")}static get DarkGoldenrod(){return L.mkWithKeyword(255,184,134,11,"darkgoldenrod")}static get DarkGray(){return L.mkWithKeyword(255,169,169,169,"darkgray")}static get DarkGreen(){return L.mkWithKeyword(255,0,100,0,"darkgreen")}static get DarkKhaki(){return L.mkWithKeyword(255,189,183,107,"darkkhaki")}static get DarkMagenta(){return L.mkWithKeyword(255,139,0,139,"darkmagenta")}static get DarkOliveGreen(){return L.mkWithKeyword(255,85,107,47,"darkolivegreen")}static get DarkOrange(){return L.mkWithKeyword(255,255,140,0,"darkorange")}static get DarkOrchid(){return L.mkWithKeyword(255,153,50,204,"darkorchid")}static get DarkRed(){return L.mkWithKeyword(255,139,0,0,"darkred")}static get DarkSalmon(){return L.mkWithKeyword(255,233,150,122,"darksalmon")}static get DarkSeaGreen(){return L.mkWithKeyword(255,143,188,139,"darkseagreen")}static get DarkSlateBlue(){return L.mkWithKeyword(255,72,61,139,"darkslateblue")}static get DarkSlateGray(){return L.mkWithKeyword(255,47,79,79,"darkslategray")}static get DarkTurquoise(){return L.mkWithKeyword(255,0,206,209,"darkturquoise")}static get DarkViolet(){return L.mkWithKeyword(255,148,0,211,"darkviolet")}static get DeepPink(){return L.mkWithKeyword(255,255,20,147,"deeppink")}static get DeepSkyBlue(){return L.mkWithKeyword(255,0,191,255,"deepskyblue")}static get DimGray(){return L.mkWithKeyword(255,105,105,105,"dimgray")}static get DodgerBlue(){return L.mkWithKeyword(255,30,144,255,"dodgerblue")}static get Firebrick(){return L.mkWithKeyword(255,178,34,34,"firebrick")}static get FloralWhite(){return L.mkWithKeyword(255,255,250,240,"floralwhite")}static get ForestGreen(){return L.mkWithKeyword(255,34,139,34,"forestgreen")}static get Fuchsia(){return L.mkWithKeyword(255,255,0,255,"fuchsia")}static get Gainsboro(){return L.mkWithKeyword(255,220,220,220,"gainsboro")}static get GhostWhite(){return L.mkWithKeyword(255,248,248,255,"ghostwhite")}static get Gold(){return L.mkWithKeyword(255,255,215,0,"gold")}static get Goldenrod(){return L.mkWithKeyword(255,218,165,32,"goldenrod")}static get Gray(){return L.mkWithKeyword(255,128,128,128,"gray")}static get Green(){return L.mkWithKeyword(255,0,128,0,"green")}static get GreenYellow(){return L.mkWithKeyword(255,173,255,47,"greenyellow")}static get Honeydew(){return L.mkWithKeyword(255,240,255,240,"honeydew")}static get HotPink(){return L.mkWithKeyword(255,255,105,180,"hotpink")}static get IndianRed(){return L.mkWithKeyword(255,205,92,92,"indianred")}static get Indigo(){return L.mkWithKeyword(255,75,0,130,"indigo")}static get Ivory(){return L.mkWithKeyword(255,255,255,240,"ivory")}static get Khaki(){return L.mkWithKeyword(255,240,230,140,"khaki")}static get Lavender(){return L.mkWithKeyword(255,230,230,250,"lavender")}static get LavenderBlush(){return L.mkWithKeyword(255,255,240,245,"lavenderblush")}static get LawnGreen(){return L.mkWithKeyword(255,124,252,0,"lawngreen")}static get LemonChiffon(){return L.mkWithKeyword(255,255,250,205,"lemonchiffon")}static get LightBlue(){return L.mkWithKeyword(255,173,216,230,"lightblue")}static get LightCoral(){return L.mkWithKeyword(255,240,128,128,"lightcoral")}static get LightCyan(){return L.mkWithKeyword(255,224,255,255,"lightcyan")}static get LightGoldenrodYellow(){return L.mkWithKeyword(255,250,250,210,"lightgoldenrodyellow")}static get LightGray(){return L.mkWithKeyword(255,211,211,211,"lightgray")}static get LightGreen(){return L.mkWithKeyword(255,144,238,144,"lightgreen")}static get LightPink(){return L.mkWithKeyword(255,255,182,193,"lightpink")}static get LightSalmon(){return L.mkWithKeyword(255,255,160,122,"lightsalmon")}static get LightSeaGreen(){return L.mkWithKeyword(255,32,178,170,"lightseagreen")}static get LightSkyBlue(){return L.mkWithKeyword(255,135,206,250,"lightskyblue")}static get LightSlateGray(){return L.mkWithKeyword(255,119,136,153,"lightslategray")}static get LightSteelBlue(){return L.mkWithKeyword(255,176,196,222,"lightsteelblue")}static get LightYellow(){return L.mkWithKeyword(255,255,255,224,"lightyellow")}static get Lime(){return L.mkWithKeyword(255,0,255,0,"lime")}static get LimeGreen(){return L.mkWithKeyword(255,50,205,50,"limegreen")}static get Linen(){return L.mkWithKeyword(255,250,240,230,"linen")}static get Magenta(){return L.mkWithKeyword(255,255,0,255,"magenta")}static get Maroon(){return L.mkWithKeyword(255,128,0,0,"maroon")}static get MediumAquamarine(){return L.mkWithKeyword(255,102,205,170,"mediumaquamarine")}static get MediumBlue(){return L.mkWithKeyword(255,0,0,205,"mediumblue")}static get MediumOrchid(){return L.mkWithKeyword(255,186,85,211,"mediumorchid")}static get MediumPurple(){return L.mkWithKeyword(255,147,112,219,"mediumpurple")}static get MediumSeaGreen(){return L.mkWithKeyword(255,60,179,113,"mediumseagreen")}static get MediumSlateBlue(){return L.mkWithKeyword(255,123,104,238,"mediumslateblue")}static get MediumSpringGreen(){return L.mkWithKeyword(255,0,250,154,"mediumspringgreen")}static get MediumTurquoise(){return L.mkWithKeyword(255,72,209,204,"mediumturquoise")}static get MediumVioletRed(){return L.mkWithKeyword(255,199,21,133,"mediumvioletred")}static get MidnightBlue(){return L.mkWithKeyword(255,25,25,112,"midnightblue")}static get MintCream(){return L.mkWithKeyword(255,245,255,250,"mintcream")}static get MistyRose(){return L.mkWithKeyword(255,255,228,225,"mistyrose")}static get Moccasin(){return L.mkWithKeyword(255,255,228,181,"moccasin")}static get NavajoWhite(){return L.mkWithKeyword(255,255,222,173,"navajowhite")}static get Navy(){return L.mkWithKeyword(255,0,0,128,"navy")}static get OldLace(){return L.mkWithKeyword(255,253,245,230,"oldlace")}static get Olive(){return L.mkWithKeyword(255,128,128,0,"olive")}static get OliveDrab(){return L.mkWithKeyword(255,107,142,35,"olivedrab")}static get Orange(){return L.mkWithKeyword(255,255,165,0,"orange")}static get OrangeRed(){return L.mkWithKeyword(255,255,69,0,"orangered")}static get Orchid(){return L.mkWithKeyword(255,218,112,214,"orchid")}static get PaleGoldenrod(){return L.mkWithKeyword(255,238,232,170,"palegoldenrod")}static get PaleGreen(){return L.mkWithKeyword(255,152,251,152,"palegreen")}static get PaleTurquoise(){return L.mkWithKeyword(255,175,238,238,"paleturquoise")}static get PaleVioletRed(){return L.mkWithKeyword(255,219,112,147,"palevioletred")}static get PapayaWhip(){return L.mkWithKeyword(255,255,239,213,"papayawhip")}static get PeachPuff(){return L.mkWithKeyword(255,255,218,185,"peachpuff")}static get Peru(){return L.mkWithKeyword(255,205,133,63,"peru")}static get Pink(){return L.mkWithKeyword(255,255,192,203,"pink")}static get Plum(){return L.mkWithKeyword(255,221,160,221,"plum")}static get PowderBlue(){return L.mkWithKeyword(255,176,224,230,"powderblue")}static get Purple(){return L.mkWithKeyword(255,128,0,128,"purple")}static get Red(){return L.mkWithKeyword(255,255,0,0,"red")}static get RosyBrown(){return L.mkWithKeyword(255,188,143,143,"rosybrown")}static get RoyalBlue(){return L.mkWithKeyword(255,65,105,225,"royalblue")}static get SaddleBrown(){return L.mkWithKeyword(255,139,69,19,"saddlebrown")}static get Salmon(){return L.mkWithKeyword(255,250,128,114,"salmon")}static get SandyBrown(){return L.mkWithKeyword(255,244,164,96,"sandybrown")}static get SeaGreen(){return L.mkWithKeyword(255,46,139,87,"seagreen")}static get SeaShell(){return L.mkWithKeyword(255,255,245,238,"seashell")}static get Sienna(){return L.mkWithKeyword(255,160,82,45,"sienna")}static get Silver(){return L.mkWithKeyword(255,192,192,192,"silver")}static get SkyBlue(){return L.mkWithKeyword(255,135,206,235,"skyblue")}static get SlateBlue(){return L.mkWithKeyword(255,106,90,205,"slateblue")}static get SlateGray(){return L.mkWithKeyword(255,112,128,144,"slategray")}static get Snow(){return L.mkWithKeyword(255,255,250,250,"snow")}static get SpringGreen(){return L.mkWithKeyword(255,0,255,127,"springgreen")}static get SteelBlue(){return L.mkWithKeyword(255,70,130,180,"steelblue")}static get Tan(){return L.mkWithKeyword(255,210,180,140,"tan")}static get Teal(){return L.mkWithKeyword(255,0,128,128,"teal")}static get Thistle(){return L.mkWithKeyword(255,216,191,216,"thistle")}static get Tomato(){return L.mkWithKeyword(255,255,99,71,"tomato")}static get Transparent(){return L.mkWithKeyword(0,255,255,255,"transparent")}static get Turquoise(){return L.mkWithKeyword(255,64,224,208,"turquoise")}static get Violet(){return L.mkWithKeyword(255,238,130,238,"violet")}static get Wheat(){return L.mkWithKeyword(255,245,222,179,"wheat")}static get White(){return L.mkWithKeyword(255,255,255,255,"white")}static get WhiteSmoke(){return L.mkWithKeyword(255,245,245,245,"whitesmoke")}static get Yellow(){return L.mkWithKeyword(255,255,255,0,"yellow")}static get YellowGreen(){return L.mkWithKeyword(255,154,205,50,"yellowgreen")}};var oh=class extends ps{constructor(t){super(t,Xe.DrawingObjectIndex);this.labelfontcolor=L.Black;this.styles=[];this.penwidth=1;this.fontname=oh.defaultLabelFontName,this.fontsize=oh.defaultLabelFontSize}rebind(t){this.entity=t,this.bind(Xe.DrawingObjectIndex)}static copyValidFields(t,i){t==null||i==null||(t.color&&t.color.keyword&&t.color.keyword.toLowerCase()!=="black"&&(i.color=t.color),t.fillColor&&(i.fillColor=t.fillColor),t.labelfontcolor&&t.labelfontcolor.keyword.toLowerCase()!=="black"&&(i.labelfontcolor=t.labelfontcolor),t.labelText!=null&&t.labelText!==""&&t.labelText!==t.id&&(i.labelText=t.labelText),t.fontColor&&t.fontColor.keyword&&t.fontColor.keyword.toLowerCase()!=="black"&&(i.fontColor=t.fontColor),t.styles&&t.styles.length&&(i.styles=t.styles.map(n=>n)),t.pencolor&&t.pencolor.keyword!=="black"&&(i.pencolor=t.pencolor),t.penwidth&&t.penwidth!==1&&(i.penwidth=t.penwidth),t.rankdir&&(i.rankdir=t.rankdir),t.fontname&&t.fontname!==oh.defaultLabelFontName&&(i.fontname=t.fontname),t.margin&&(i.margin=t.margin),t.fontsize&&t.fontsize!==oh.defaultLabelFontSize&&(i.fontsize=t.fontsize),t.orientation&&(i.orientation=t.orientation),t.ranksep&&(i.ranksep=t.ranksep),t.arrowtail&&(i.arrowtail=t.arrowtail),t.arrowhead&&(i.arrowhead=t.arrowhead),t.ordering&&(i.ordering=t.ordering),t.bgcolor&&(i.bgcolor=t.bgcolor),t.pos&&(i.pos=t.pos),t.nodesep&&(i.nodesep=t.nodesep),t.arrowsize&&(i.arrowsize=t.arrowsize),t.samehead&&(i.samehead=t.samehead),t.layersep&&(i.layersep=t.layersep),t.clusterRank&&(i.clusterRank=t.clusterRank))}get labelText(){return this._labelText}set labelText(t){this._labelText=t}get arrowhead(){return this._arrowhead}set arrowhead(t){this._arrowhead=t}get id(){return this._id}set id(t){this._id=t}static getDrawingObj(t){return t==null?null:t.getAttr(Xe.DrawingObjectIndex)}},Ve=oh;Ve.defaultLabelFontName="Times-Roman",Ve.defaultLabelFontSize=12;var Tb=class extends Ve{constructor(t){super(t);this.shape=2;this.padding=2;this.xRad=3;this.yRad=3;this.labelMargin=1;this.labelWidthToHeightRatio=1;t!=null&&(this.labelText=t.id)}clone(){throw new Error("Method not implemented.")}get Padding(){return this.padding}set Padding(t){this.padding=Math.max(0,t)}get XRadius(){return this.xRad}set XRadius(t){this.xRad=t}get YRadius(){return this.yRad}set YRadius(t){this.yRad=t}static get DefaultFillColor(){return Tb.defaultFillColor}static set DefaultFillColor(t){Tb.defaultFillColor=t}get ShapeEnum(){return this.shape}set ShapeEnum(t){this.shape=t}get LabelMargin(){return this.labelMargin}set LabelMargin(t){this.labelMargin=t}get LabelWidthToHeightRatio(){return this.labelWidthToHeightRatio}set LabelWidthToHeightRatio(t){this.labelWidthToHeightRatio=t}get node(){return this.entity}get id(){return this.node?this.node.id:""}},rr=Tb;rr.defaultFillColor=L.LightGray;var Ln=class extends Ve{constructor(t,i){super(t);this.directed=!0;this.directed=i,i?this.arrowhead=0:this.arrowhead=6,this.arrowtail=6}clone(){let t=new Ln(null,this.directed);return Ve.copyValidFields(this,t),t.directed=this.directed,t.arrowtail=this.arrowtail,t.arrowhead=this.arrowhead,t}};var zt=class extends rr{constructor(){super(...arguments);this.graphVisData={sameRanks:new Array,minRanks:new Array,maxRanks:new Array,sourceRanks:new Array,sinkRanks:new Array}}get defaultNodeObject(){return this._defaultNodeObject}set defaultNodeObject(t){this._defaultNodeObject=t}static getDrawingGraph(t){return Ve.getDrawingObj(t)}get graph(){return this.entity}findNode(t){let n=this.graph.findNode(t);return n==null?null:Ve.getDrawingObj(n)}hasDirectedEdge(){for(let t of this.graph.deepEdges)if(Ve.getDrawingObj(t).directed)return!0;return!1}createGeometry(t=i=>i?new wt(i.length*8+8,20):null){let i=new be(this.graph);this.textMeasure=t;let n={fontFamily:this.fontname,fontSize:this.fontsize,fontStyle:"normal"};i.labelSize=t(this.labelText,n);for(let o of this.graph.nodesBreadthFirst)this.createNodeGeometry(o);for(let o of this.graph.deepEdges)this.createEdgeGeometry(o);if(this.rankdir){let o=i.layoutSettings=new Bt;o.layerDirection=this.rankdir}return i}createEdgeGeometry(t){let i=Ln.getDrawingObj(t),n=new Ye(t);if(i.arrowhead!=6&&(n.targetArrowhead=new ut),i.arrowtail!=6&&(n.sourceArrowhead=new ut),i.labelText){let o=this.textMeasure(i.labelText,{fontSize:i.fontsize,fontFamily:i.fontname,fontStyle:"normal"}),a=t.label=new Ms(t);new Wi(a,X.mkPP(new m(0,0),new m(o.width,o.height))),i.measuredTextSize=o}i.penwidth&&(n.lineWidth=i.penwidth)}curveByShape(t,i,n,o){let a;switch(o.shape){case 0:a=Fe.mkDiamond(t,i,n);break;case 1:a=Fe.mkEllipse(t/1.6,i/1.6,n);break;case 4:case 2:a=Fe.mkRectangleWithRoundedCorners(t,i,o.XRadius,o.YRadius,n);break;case 3:a=Fe.mkCircle(Math.sqrt(t*t+i*i),n);break;case 5:break;case 6:break;case 7:break;case 8:break;case 9:break;case 10:a=Fe.mkCircle(Math.sqrt(t*t+i*i)+2*o.penwidth,n);break;case 11:a=Fe.createHouse(t,i,n);break;case 12:a=Fe.createInvertedHouse(t,i,n);break;case 13:a=Fe.createParallelogram(t,i,n);break;case 14:a=Fe.createOctagon(t,i,n);break;case 15:break;case 16:break;case 17:break;case 18:break;case 19:a=Fe.createHexagon(t,i,n);break}return a!=null?a:Fe.mkRectangleWithRoundedCorners(t,i,o.XRadius,o.YRadius,n)}createNodeGeometry(t,i=new m(0,0)){if(t instanceof Te){let n=Ve.getDrawingObj(t),o=new be(t);n.labelText&&(o.labelSize=n.measuredTextSize=mS(n,this.textMeasure))}else{let n=rr.getDrawingObj(t),o=new wt(1,1);n.labelText&&(o=mS(n,this.textMeasure)),n.measuredTextSize=o;let a=new lt(t),l=o.width+n.LabelMargin*2,u=o.height+n.LabelMargin*2;a.boundaryCurve=this.curveByShape(l,u,i,n)}}measureLabelSizes(t){var i;for(let n of this.graph.nodesBreadthFirst){let o=rr.getDrawingObj(n);o.measuredTextSize=(i=mS(o,t))!=null?i:new wt(1,1)}}};function mS(s,e){return s.labelText?e(s.labelText,{fontSize:s.fontsize,fontFamily:s.fontname,fontStyle:"normal"}):null}var dM=Ae(zn(),1);var s1=Ae(o1(),1);function Fs(s){let e=(0,s1.default)(s);if(e.keyword!=null)return L.parse(e.keyword.toString());if(e!=null){if(e.rgba!=null)return new L(e.rgba[3],e.rgba[0],e.rgba[1],e.rgba[2]);if(e.rgb!=null)return L.mkRGB(e.rgb[0],e.rgb[1],e.rgb[2])}return L.Black}function wS(s,e,t){for(let n of t.attr_list)if(n.type==="attr"){let o=n.eq;switch(n.id){case"edgeCurve":{let a=Qa(s),l=JSON.parse(o);a.curve=Kp(l)}break;case"graphBoundingBox":{let a=Qa(s),l=JSON.parse(o);a.boundingBox=new X(l)}break;case"boundaryCurve":{let a=Qa(s),l=JSON.parse(o),u=Kp(l);a instanceof be?a.boundingBox=u.boundingBox:a.boundaryCurve=u}break;case"geomEdge":{let a=Qa(s);break}case"sourceArrowhead":{let a=Qa(s);a.sourceArrowhead==null&&(a.sourceArrowhead=new ut);break}case"targetArrowhead":{let a=Qa(s);a.targetArrowhead==null&&(a.targetArrowhead=new ut);break}case"sourceArrowheadTip":{let a=Qa(s);a.sourceArrowhead==null&&(a.sourceArrowhead=new ut),o!=="none"&&(a.sourceArrowhead.tipPosition=m.fromJSON(JSON.parse(o)));break}case"targetArrowheadTip":{let a=Qa(s);a.targetArrowhead==null&&(a.targetArrowhead=new ut),o!=="none"&&(a.targetArrowhead.tipPosition=m.fromJSON(JSON.parse(o)));break}case"geomEdgeLabel":{let a=JSON.parse(o),l=s;i(l),new Wi(l.label,new X(a)).setBoundingBox(new X(a));break}case"color":e.color=Fs(o);break;case"pencolor":e.pencolor=Fs(o);break;case"labelfontcolor":e.labelfontcolor=Fs(o);break;case"fontcolor":e.fontColor=Fs(o);break;case"fillcolor":e.fillColor=Fs(o);break;case"style":for(let a of WM(o))e.styles.push(a);break;case"shape":{let a=e;a.shape=HM(o);break}case"peripheries":e.peripheries=parseInt(o);break;case"headlabel":e.headlabel=o;break;case"label":if(typeof o=="string"){let a="\\n",l=0;e.labelText="";do{let u=o.indexOf(a,l);if(u>=0)e.labelText+=o.substring(l,u)+`
`,l=u+2;else{e.labelText+=o.substring(l);break}}while(!0)}else typeof o=="number"&&(e.labelText=o.toString());s instanceof hi&&i(s);break;case"size":e.size=IS(o);break;case"pos":e.pos=IS(o);break;case"rankdir":e.rankdir=jM(o);break;case"fontname":e.fontname=o;break;case"fontsize":e.fontsize=parseFloat(o);break;case"width":e.width=parseFloat(o);break;case"penwidth":e.penwidth=parseFloat(o);break;case"height":e.height=parseFloat(o);break;case"margin":e.margin=parseFloat(o);break;case"len":e.len=parseFloat(o);break;case"minlen":e.minlen=parseFloat(o);break;case"rank":e.rank=qM(o);break;case"charset":e.charset=o;break;case"orientation":e.orientation=o;break;case"ratio":e.ratio=o;break;case"weight":e.weight=parseFloat(o);break;case"nodesep":e.nodesep=parseFloat(o);break;case"layersep":e.layersep=parseFloat(o);break;case"arrowsize":e.arrowsize=parseFloat(o);break;case"rotate":e.rotate=parseFloat(o);break;case"ranksep":e.ranksep=parseFloat(o);break;case"splines":e.splines=o==="true";break;case"overlap":e.overlap=o==="true";break;case"arrowtail":e.arrowtail=a1(o);break;case"taillabel":e.taillabel=o;break;case"arrowhead":e.arrowhead=a1(o);break;case"ordering":e.ordering=XM(o);break;case"URL":e.URL=o;break;case"dir":e.dir=YM(o);break;case"concentrate":e.concentrate=o==="true";break;case"compound":e.compound=o==="true";break;case"lhead":e.lhead=o;break;case"ltail":e.ltail=o;break;case"bgcolor":e.bgcolor=Fs(o);break;case"center":e.center=o===!0||parseInt(o)===1;break;case"colorscheme":e.colorscheme=o;break;case"sides":e.sides=parseInt(o);break;case"distortion":e.distortion=parseFloat(o);break;case"skew":e.skew=parseFloat(o);break;case"bb":e.bb=KM(o);break;case"labelloc":e.labelloc=o;break;case"decorate":e.decorate=o==="true";break;case"tailclip":e.tailclip=o==="true";break;case"headclip":e.headclip=o==="true";break;case"constraint":e.constraint=o==="true";break;case"gradientangle":e.gradientangle=parseFloat(o);break;case"samehead":e.samehead=o;break;case"href":e.href=o;break;case"imagepath":e.imagepath=o;break;case"image":e.image=o;break;case"labeljust":e.labejust=o;break;case"layers":e.layers=o.split(",");break;case"layer":e.layer=o;break;case"f":e.f=parseFloat(o);break;case"nojustify":e.nojustify=o==="true";break;case"root":e.root=o==="true";break;case"page":e.page=IS(o);break;case"pname":e.pname=o;break;case"kind":e.kind=o;break;case"fname":e.fname=o;break;case"subkind":e.subkind=o;break;case"area":e.area=parseFloat(o);break;case"tailport":e.tailport=o;break;case"headport":e.headport=o;break;case"wt":e.wt=o;break;case"id":e instanceof rr||(e.id=o);break;case"edgetooltip":e.edgetooltip=o;break;case"headtooltip":e.headtooltip=o;break;case"tailtooltip":e.tailtooltip=o;break;case"headURL":e.headURL=o;break;case"tailURL":e.tailURL=o;break;case"labelURL":e.labelURL=o;break;case"edgeurl":e.edgeurl=o;break;case"shapefile":e.shapefile=o;break;case"xlabel":e.xlabel=o;break;case"sametail":e.sametail=o;break;case"clusterrank":e.clusterRank=o;break;case"measuredTextSize":e.measuredTextSize=JSON.parse(o);break;default:break}}else throw new Error("unexpected type "+n.type);function i(n){n.label==null&&(n.label=new Ms(n))}}function ah(s,e){let t=Ve.getDrawingObj(e);s.attr_list!=null&&wS(e,t,s)}var Ob=class{constructor(e){this.nodeMap=new Map;this.ast=e}parseEdge(e,t,i,n,o){let a,l;if(e.type==="node_id"){let c=e.id.toString();a=this.nodeMap.get(c),a==null?a=this.newNode(c,i,!1):this.tryToMoveToADeeperGraph(a,i)}else{let c=[];for(let h of e.children)if(h.type==="node_stmt")for(let d of this.parseEdge(h.node_id,t,i,n,o))c.push(d);else if(h.type!=="attr_stmt")throw new Error("not implemented");for(let h of e.children)if(h.type==="attr_stmt")for(let d of c)ah(h,d);return c}if(t.type==="node_id"){let c=t.id.toString();l=this.nodeMap.get(c),l==null?l=this.newNode(c,i,!1):this.tryToMoveToADeeperGraph(l,i)}else if(t.type==="subgraph"){let c=new Array;for(let h of t.children)if(h.type==="node_stmt")for(let d of this.parseEdge(e,h.node_id,i,n,o))c.push(d);else if(h.type!=="attr_stmt")throw new Error("not implemented");for(let h of t.children)if(h.type==="attr_stmt")for(let d of c)ah(h,d);return c}let u=new hi(a,l);return new Ln(u,n),ah(o,u),[u]}tryToMoveToADeeperGraph(e,t){Ce.assert(e.parent!=null);let i=e.parent;i!=t&&n(i)<n(t)&&(i.remove(e),t.addNode(e));function n(o){let a=0,l=o.parent;for(;l;)a++,l=l.parent;return a}}newNode(e,t,i){let n=this.nodeMap.get(e);if(n==null){n=new Hi(e),this.nodeMap.set(e,n),t.addNode(n);let o=new rr(n);o.labelText=e;let a=zt.getDrawingObj(t);Ve.copyValidFields(a.defaultNodeObject,o)}else i&&O0(t,n);return n}parseNode(e,t,i){let n=e.node_id.id.toString(),o=this.newNode(n,t,i);return Ve.getDrawingObj(o)==null&&new rr(o),ah(e,o),o}parse(){return this.ast==null?null:(this.graph=new Te(this.ast[0].id?this.ast[0].id.toString():"__graph__"),this.drawingGraph=new zt(this.graph),this.parseUnderGraph(this.ast[0].children,this.graph,this.ast[0].type==="digraph",!1),QM(this.graph),JM(this.graph),this.graph)}parseGraphAttr(e,t){if(e.target==="node"){let i=zt.getDrawingObj(t);i.defaultNodeObject==null&&(i.defaultNodeObject=new rr(null)),wS(null,i.defaultNodeObject,e)}else e.target==="graph"&&ah(e,t)}getEntitiesSubg(e,t,i){let n=[];for(let o of e.children)if(o.type==="edge_stmt")for(let a=0;a<o.edge_list.length-1;a++)for(let l of this.parseEdge(o.edge_list[a],o.edge_list[a+1],t,i,o))n.push(l);else if(o.type!=="attr_stmt")if(o.type==="node_stmt")n.push(this.parseNode(o,t,!0));else if(o.type==="subgraph")if(o.id!=null){let a=new Te(o.id.toString());t.addNode(a),this.nodeMap.set(a.id,a);let l=new zt(a);this.parseUnderGraph(o.children,a,i,!0),n.push(l.graph),a.isEmpty&&(t.removeNode(a),this.nodeMap.delete(a.id))}else n=n.concat(this.getEntitiesSubg(o,t,i));else throw new Error("Function not implemented.");return n}parseUnderGraph(e,t,i,n){for(let o of e)switch(o.type){case"node_stmt":this.parseNode(o,t,n);break;case"edge_stmt":{let a=o.edge_list;for(let l=0;l<a.length-1;l++)this.parseEdge(a[l],a[l+1],t,i,o)}break;case"subgraph":if(!this.process_same_rank(o,zt.getDrawingGraph(t)))if(o.id==null){let a=this.getEntitiesSubg(o,t,i);ZM(o,zt.getDrawingGraph(t),a)}else{let a=new Te(o.id.toString());this.nodeMap.set(o.id.toString(),a),t.addNode(a),new zt(a),this.parseUnderGraph(o.children,a,i,!0),a.isEmpty()&&(t.remove(a),this.nodeMap.delete(a.id))}break;case"attr_stmt":this.parseGraphAttr(o,t);break;default:throw new Error("not implemented")}}process_same_rank(e,t){let i=e.children[0];if(i==null||i.type!=="attr_stmt")return!1;let n=i.attr_list;if(n==null||n.length===0)return!1;let o=n[0];if(o.type!=="attr"||o.id!=="rank")return!1;switch(o.eq){case"min":for(let a=1;a<e.children.length;a++){let l=e.children[a];if(l.type==="node_stmt")t.graphVisData.minRanks.push(l.node_id.id.toString());else throw new Error}return!0;case"max":for(let a=1;a<e.children.length;a++){let l=e.children[a];if(l.type==="node_stmt")t.graphVisData.minRanks.push(l.node_id.id.toString());else throw new Error}return!0;case"same":{let a=[];for(let l=1;l<e.children.length;l++){let u=e.children[l];u.type==="node_stmt"?(this.newNode(u.node_id.id.toString(),t.graph,!1),a.push(u.node_id.id.toString())):u.type==="attr_stmt"&&u.target==="node"&&(t.defaultNodeObject==null&&(t.defaultNodeObject=new rr(null)),wS(null,t.defaultNodeObject,u))}return t.graphVisData.sameRanks.push(a),!0}case"source":{for(let a=1;a<e.children.length;a++){let l=e.children[a];if(l.type==="node_stmt")t.graphVisData.sourceRanks.push(l.node_id.id.toString());else throw new Error}return!0}case"sink":for(let a=1;a<e.children.length;a++){let l=e.children[a];if(l.type==="node_stmt")t.graphVisData.sinkRanks.push(l.node_id.id.toString());else throw new Error}return!0;default:throw new Error("incorrect rank")}}};function LS(s){try{return new Ob((0,u1.default)(s)).parse()}catch(e){return console.log("cannot parse the graph"),null}}function zM(s){try{return new Ob([s]).parse()}catch(e){return console.log(e.message),null}}function*WM(s){let e=s.split(",");for(let t of e){let n=Sf[t];n&&(yield n)}}function HM(s){let e=s.toLowerCase();return Zo[e]}function IS(s){let e=s.split(",");return[parseFloat(e[0]),parseFloat(e[1])]}function jM(s){return Hc[s]}function qM(s){return vb[s]}function a1(s){return eo[s]}function XM(s){return Ab[s]}function YM(s){return Cb[s]}function KM(s){let e=s.split(",");return[parseFloat(e[0]),parseFloat(e[1]),parseFloat(e[2]),parseFloat(e[3])]}function ZM(s,e,t){for(let i of s.children)if(i.type==="attr_stmt")for(let n of t)ah(i,n)}function QM(s){let e=[];for(let t of s.subgraphsBreadthFirst())t.isEmpty()&&e.push(t);for(let t of e){let i=t.parent;i&&i.removeNode(t)}}function JM(s){for(let e of s.subgraphsBreadthFirst())be.getGeom(e)==null&&e.hasSomeAttrOnIndex(Xe.GeomObjectIndex)&&new be(e);be.getGeom(s)==null&&s.hasSomeAttrOnIndex(Xe.GeomObjectIndex)&&new be(s)}function _b(s){let e=aB(s);return{type:oB(s),id:s.id,children:eB(s,e)}}function $M(s){return{type:"edge_stmt",edge_list:[{type:"node_id",id:s.source.id},{type:"node_id",id:s.target.id}],attr_list:Array.from(tB(s))}}function eB(s,e){let t=new Map,i=[],n=be.getGeom(s);if(n){let o=Array.from(h1(n));i.push({type:"attr_stmt",target:"graph",attr_list:o})}uB(i,s);for(let o of s.nodesBreadthFirst)t.set(o.id,rB(o));for(let o of s.nodesBreadthFirst){if(o.parent===s)continue;t.get(o.parent.id).children.push(t.get(o.id))}for(let o of s.deepEdges){let a=$M(o),l=sB(o,e);l===s?i.push(a):t.get(l.id).children.push(a)}for(let o of s.shallowNodes)i.push(t.get(o.id));return i}function*tB(s){let e=xe.getGeom(s);if(e&&(yield{type:"attr",id:"geomEdge",eq:"none"},e.curve&&(yield{type:"attr",id:"edgeCurve",eq:JSON.stringify(Zp(e.curve))}),e.sourceArrowhead&&(yield{type:"attr",id:"sourceArrowhead",eq:"none"},e.sourceArrowhead.tipPosition&&(yield{type:"attr",id:"sourceArrowheadTip",eq:JSON.stringify(e.sourceArrowhead.tipPosition.toJSON())})),e.targetArrowhead&&(yield{type:"attr",id:"targetArrowhead",eq:"none"},e.targetArrowhead.tipPosition&&(yield{type:"attr",id:"targetArrowheadTip",eq:JSON.stringify(e.targetArrowhead.tipPosition.toJSON())})),s.label)){let t=s.label.getAttr(Xe.GeomObjectIndex).boundingBox,i={left:t.left,right:t.right,top:t.top,bottom:t.bottom};yield{type:"attr",id:"geomEdgeLabel",eq:JSON.stringify(i)}}yield*RS(Ve.getDrawingObj(s))}function rB(s){if(s instanceof Te){let t=Array.from(h1(be.getGeom(s))),i=[],n={type:"attr_stmt",target:"graph",attr_list:t};return i.push(n),{type:"subgraph",children:i,id:s.id}}else return{type:"node_stmt",node_id:{type:"node_id",id:s.id},attr_list:Array.from(nB(s))}}function iB(s){let e=lt.getGeom(s).boundaryCurve;return{type:"attr",id:"boundaryCurve",eq:JSON.stringify(Zp(e))}}function*nB(s){xe.getGeom(s)&&(yield iB(s)),yield*RS(Ve.getDrawingObj(s))}function*RS(s){if(s.color&&s.color.keyword.toLowerCase()!=="black"&&(yield{type:"attr",id:"color",eq:s.color.toString()}),s.fillColor&&(yield{type:"attr",id:"fillColor",eq:s.fillColor.toString()}),s.labelfontcolor&&s.labelfontcolor.keyword.toLowerCase()!=="black"&&(yield{type:"attr",id:"labelfontcolor",eq:s.labelfontcolor.toString()}),!(s.labelText==null||s.labelText==="")&&s.entity&&s.labelText!==s.id&&(yield{type:"attr",id:"label",eq:s.labelText}),s.fontColor&&s.fontColor.keyword.toLowerCase()!=="black"&&(yield{type:"attr",id:"fontColor",eq:s.fontColor.toString()}),s.styles&&s.styles.length){let e=s.styles.map(t=>Sf[t]).reduce((t,i)=>t.concat(","+i));yield{type:"attr",id:"style",eq:e}}s.pencolor&&s.pencolor.keyword!=="black"&&(yield{type:"attr",id:"pencolor",eq:s.pencolor.toString()}),s.penwidth&&s.penwidth!==1&&(yield{type:"attr",id:"penwidth",eq:s.penwidth.toString()}),s.rankdir&&(yield{type:"attr",id:"rankdir",eq:s.rankdir.toString()}),s.fontname&&s.fontname!==Ve.defaultLabelFontName&&(yield{type:"attr",id:"fontname",eq:s.fontname}),s.margin&&(yield{type:"attr",id:"margin",eq:s.margin.toString()}),s.fontsize&&s.fontsize!==Ve.defaultLabelFontSize&&(yield{type:"attr",id:"fontsize",eq:s.fontsize.toString()}),s.orientation&&(yield{type:"attr",id:"orientation",eq:s.orientation.toString()}),s.ranksep&&(yield{type:"attr",id:"ranksep",eq:s.ranksep.toString()}),s.arrowtail&&(yield{type:"attr",id:"arrowtail",eq:eo[s.arrowtail]}),s.arrowhead&&(yield{type:"attr",id:"arrowhead",eq:eo[s.arrowhead]}),s.ordering&&(yield{type:"attr",id:"ordering",eq:s.ordering.toString()}),s.bgcolor&&(yield{type:"attr",id:"bgcolor",eq:s.bgcolor.toString()}),s.pos&&(yield{type:"attr",id:"pos",eq:s.pos.toString()}),s.nodesep&&(yield{type:"attr",id:"nodesep",eq:s.nodesep.toString()}),s.arrowsize&&(yield{type:"attr",id:"arrowsize",eq:s.arrowsize.toString()}),s.samehead&&(yield{type:"attr",id:"samehead",eq:s.samehead.toString()}),s.layersep&&(yield{type:"attr",id:"layersep",eq:s.layersep.toString()}),s.clusterRank&&(yield{type:"attr",id:"clusterrank",eq:s.clusterRank.toString()}),s.measuredTextSize&&(yield{type:"attr",id:"measuredTextSize",eq:JSON.stringify(s.measuredTextSize)}),s instanceof rr&&(s.shape&&s.shape!==2&&(yield{type:"attr",id:"shape",eq:s.shape.toString()}),s.xRad&&s.xRad!==3&&(yield{type:"attr",id:"xRad",eq:s.xRad.toString()}),s.yRad&&s.yRad!==3&&(yield{type:"attr",id:"yRad",eq:s.yRad.toString()}),s.padding&&s.padding!==2&&(yield{type:"attr",id:"padding",eq:s.padding.toString()}))}function oB(s){return zt.getDrawingGraph(s).hasDirectedEdge()?"digraph":"graph"}function sB(s,e){let t=s.source,i=s.target,n=e.get(t.id),o=e.get(i.id);for(;n>o;)t=t.parent,n--;for(;n<o;)i=i.parent,o--;for(;t.parent!==i.parent;)t=t.parent,i=i.parent;return t.parent}function aB(s){let e=new Map;return e.set(s.id,0),c1(s,e),e}function c1(s,e){let t=e.get(s.id)+1;for(let i of s.shallowNodes)e.set(i.id,t),i instanceof Te&&c1(i,e)}function Qa(s){var e;return(e=xe.getGeom(s))!=null?e:lB(s)}function lB(s){if(s instanceof Te)return new be(s);if(s instanceof Hi)return new lt(s);if(s instanceof hi)return new Ye(s);throw new Error("unsupported type "+s)}function uB(s,e){let t=zt.getDrawingObj(e);if(t==null)return;let i=t.defaultNodeObject;i&&s.push({type:"attr_stmt",target:"node",attr_list:Array.from(RS(i))})}function*h1(s){if(s==null)return;let e=s.boundingBox;if(e&&e.isEmpty()===!1){let t={left:e.left,right:e.right,top:e.top,bottom:e.bottom};yield{type:"attr",id:"graphBoundingBox",eq:JSON.stringify(t)}}s.radX!==10&&(yield{type:"attr",id:"radX",eq:s.radX.toString()}),s.radY!==10&&(yield{type:"attr",id:"radY",eq:s.radY.toString()})}function OS(s){let e=new Te;try{let t=s.split(/\r\n|\r|\n/);for(let i of t){if(i.length==0||i.charAt(0)=="#")continue;let n=i.split(/\t| |,/);if(n.length<2)return console.log("cannot parse",i),null;let o=n[0],a=n[1],l=l1(e,o),u=l1(e,a),c=new hi(l,u);new Ln(c,!0)}}catch(t){console.log(t.message)}return new zt(e),e}function l1(s,e){let t=s.findNode(e);return t==null&&(t=s.addNode(new Hi(e)),new rr(t)),t}async function _S(s){let e=await s.text(),t;return s.name.toLowerCase().endsWith(".json")?t=lh(JSON.parse(e)):s.name.toLowerCase().endsWith(".txt")||s.name.toLowerCase().endsWith(".tsv")||s.name.toLowerCase().endsWith(".csv")?t=OS(e):t=LS(e),t&&(t.id=s.name),t}async function Nb(s){let e=s.slice(s.lastIndexOf("/")+1),t=await fetch(s),i;if(e.endsWith(".json")){let n=await t.json();i=lh(n)}else if(e.endsWith(".txt")){let n=await t.text();i=OS(n)}else{let n=await t.text();i=LS(n)}return i&&(i.id=e),i}function lh(s){return"nodes"in s?cB(s):zM(s)}function cB(s){let e=new Te;for(let t of s.nodes){let i=String(t.id),n=e.addNode(new Hi(i)),o=new rr(n),{label:a=i,shape:l="box"}=t;o.labelText=a,o.ShapeEnum=Zo[l],"weight"in t&&(o.weight=t.weight),"color"in t&&(o.color=Fs(t.color))}for(let t of s.edges){let i=e.setEdge(String(t.source),String(t.target)),n=new Ln(i,!1),{arrowhead:o="none",arrowtail:a="none",directed:l=!0}=t;n.arrowhead=eo[o],n.arrowtail=eo[a],n.directed=l,"weight"in t&&(n.weight=t.weight),"color"in t&&(n.color=Fs(t.color))}return new zt(e),e}var uh=null,d1=!1;async function NS(s,e,t,i=!1){if(d1&&(uh.terminate(),uh=null),!uh){s=new URL(s,location.href).href;let n=`importScripts( "${s}" )`,o=URL.createObjectURL(new Blob([n],{type:"text/javascript"}));uh=new Worker(o)}return new Promise((n,o)=>{uh.onmessage=({data:a})=>{if(a.type==="error")o(a.message);else if(a.type==="layout-done")try{e=lh(a.graph),console.debug("graph transfer to main thread",Date.now()-a.timestamp+" ms"),n(e)}catch(l){o(l.message)}},uh.postMessage({type:"layout",timestamp:Date.now(),graph:_b(e),options:t,forceUpdate:i}),d1=!0})}function Mb(s,e,t=!1){let i=!1,n=t,o=zt.getDrawingObj(s),a=be.getGeom(s);function l(u){if(!u)return;for(let d of u.subgraphs())l(d);let c=hB(o,u,e),h=dB(u.layoutSettings,c);n=n||h.layoutChanged,i=i||h.routingChanged,u.layoutSettings=c}if(l(a),n||i)for(let u of a.deepEdges)u.requireRouting();return n?ob(a,null):i&&ou(a,Array.from(a.deepEdges),null),s}function hB(s,e,t){let i=!1;for(let o of e.deepEdges)if(o.sourceArrowhead!=null||o.targetArrowhead!=null){i=!0;break}let n;switch(t.layoutType){case"Sugiyama LR":{let o=n=new Bt;o.layerDirection=1;break}case"Sugiyama RL":{let o=n=new Bt;o.layerDirection=3;break}case"Sugiyama TB":{let o=n=new Bt;o.layerDirection=0;break}case"Sugiyama BT":{let o=n=new Bt;o.layerDirection=2;break}case"MDS":n=new Qi;break;case"IPsepCola":n=new Dr;break;default:{let o=e.graph.shallowNodeCount>2001||e.graph.deepEdgesCount>4e3;if(i&&!o){let a=n=new Bt;s&&s.rankdir&&(a.layerDirection=s.rankdir)}else n=new Dr}}return t.edgeRoutingMode==null?n instanceof Bt?n.edgeRoutingSettings.EdgeRoutingMode=3:n.edgeRoutingSettings.EdgeRoutingMode=0:n.edgeRoutingSettings.EdgeRoutingMode=t.edgeRoutingMode,n}function dB(s,e){if(!s)return{layoutChanged:!0,routingChanged:!0};let t=s.commonSettings.edgeRoutingSettings.EdgeRoutingMode!==e.commonSettings.edgeRoutingSettings.EdgeRoutingMode,i=t&&e.commonSettings.edgeRoutingSettings.EdgeRoutingMode===3,n=s instanceof Bt&&e instanceof Bt&&s.layerDirection!=e.layerDirection;return{layoutChanged:s.constructor!==e.constructor||i||n,routingChanged:t}}var ch=class{constructor(e={}){this.opts={fontFamily:"sans-serif",fontSize:16,lineHeight:1,fontStyle:"normal",fontWeight:"normal"};this.el=document.createElement("canvas"),this.ctx=this.el.getContext("2d"),this.measure=this.measure.bind(this),this.setOptions(e)}setOptions(e){Object.assign(this.opts,e);let{fontFamily:t,fontSize:i,fontStyle:n,fontWeight:o}=this.opts;this.ctx.font=`${n} ${o} ${i}px ${t}`}measure(e,t){this.setOptions(t);let{fontSize:i,lineHeight:n}=this.opts,o=i*1.2,a=i*(n-1),l=0,u=e.split(`
`);for(let c of u){let h=this.ctx.measureText(c);l=Math.max(l,h.width)}return new wt(l,u.length*o+(u.length-1)*a)}};function wf(s,e){if(s===e)return!0;if(!s||!e)return!1;if(Array.isArray(s)){if(!Array.isArray(e)||s.length!==e.length)return!1;for(let t=0;t<s.length;t++)if(!wf(s[t],e[t]))return!1;return!0}else if(Array.isArray(e))return!1;if(typeof s=="object"&&typeof e=="object"){let t=Object.keys(s),i=Object.keys(e);if(t.length!==i.length)return!1;for(let n of t)if(!e.hasOwnProperty(n)||!wf(s[n],e[n]))return!1;return!0}return!1}function Ja(s,e){if(!s)throw new Error(e||"loader assertion failed.")}var Qo={self:typeof self<"u"&&self,window:typeof window<"u"&&window,global:typeof global<"u"&&global,document:typeof document<"u"&&document},gB=Qo.self||Qo.window||Qo.global||{},pB=Qo.window||Qo.self||Qo.global||{},mB=Qo.global||Qo.self||Qo.window||{},bB=Qo.document||{};var bu=Boolean(typeof process!="object"||String(process)!=="[object process]"||process.browser);var f1=typeof process<"u"&&process.version&&/v([0-9]*)/.exec(process.version),PB=f1&&parseFloat(f1[1])||0;var g1="3.2.12";function ri(s,e){if(!s)throw new Error(e||"loaders.gl assertion failed.")}var Jo={self:typeof self<"u"&&self,window:typeof window<"u"&&window,global:typeof global<"u"&&global,document:typeof document<"u"&&document},aPe=Jo.self||Jo.window||Jo.global||{},lPe=Jo.window||Jo.self||Jo.global||{},uPe=Jo.global||Jo.self||Jo.window||{},cPe=Jo.document||{};var Pu=typeof process!="object"||String(process)!=="[object process]"||process.browser;var m1=typeof window<"u"&&typeof window.orientation<"u",p1=typeof process<"u"&&process.version&&/v([0-9]*)/.exec(process.version),hPe=p1&&parseFloat(p1[1])||0;function y(s,e,t){return e in s?Object.defineProperty(s,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):s[e]=t,s}var Lf=class{constructor(e,t){y(this,"name",void 0),y(this,"workerThread",void 0),y(this,"isRunning",!0),y(this,"result",void 0),y(this,"_resolve",()=>{}),y(this,"_reject",()=>{}),this.name=e,this.workerThread=t,this.result=new Promise((i,n)=>{this._resolve=i,this._reject=n})}postMessage(e,t){this.workerThread.postMessage({source:"loaders.gl",type:e,payload:t})}done(e){ri(this.isRunning),this.isRunning=!1,this._resolve(e)}error(e){ri(this.isRunning),this.isRunning=!1,this._reject(e)}};var hh=class{};var MS=new Map;function b1(s){ri(s.source&&!s.url||!s.source&&s.url);let e=MS.get(s.source||s.url);return e||(s.url&&(e=yB(s.url),MS.set(s.url,e)),s.source&&(e=P1(s.source),MS.set(s.source,e))),ri(e),e}function yB(s){if(!s.startsWith("http"))return s;let e=SB(s);return P1(e)}function P1(s){let e=new Blob([s],{type:"application/javascript"});return URL.createObjectURL(e)}function SB(s){return`try {
  importScripts('`.concat(s,`');
} catch (error) {
  console.error(error);
  throw error;
}`)}function BS(s,e=!0,t){let i=t||new Set;if(s){if(y1(s))i.add(s);else if(y1(s.buffer))i.add(s.buffer);else if(!ArrayBuffer.isView(s)){if(e&&typeof s=="object")for(let n in s)BS(s[n],e,i)}}return t===void 0?Array.from(i):[]}function y1(s){return s?s instanceof ArrayBuffer||typeof MessagePort<"u"&&s instanceof MessagePort||typeof ImageBitmap<"u"&&s instanceof ImageBitmap||typeof OffscreenCanvas<"u"&&s instanceof OffscreenCanvas:!1}var DS=()=>{},$a=class{static isSupported(){return typeof Worker<"u"&&Pu||typeof hh<"u"&&!Pu}constructor(e){y(this,"name",void 0),y(this,"source",void 0),y(this,"url",void 0),y(this,"terminated",!1),y(this,"worker",void 0),y(this,"onMessage",void 0),y(this,"onError",void 0),y(this,"_loadableURL","");let{name:t,source:i,url:n}=e;ri(i||n),this.name=t,this.source=i,this.url=n,this.onMessage=DS,this.onError=o=>console.log(o),this.worker=Pu?this._createBrowserWorker():this._createNodeWorker()}destroy(){this.onMessage=DS,this.onError=DS,this.worker.terminate(),this.terminated=!0}get isRunning(){return Boolean(this.onMessage)}postMessage(e,t){t=t||BS(e),this.worker.postMessage(e,t)}_getErrorFromErrorEvent(e){let t="Failed to load ";return t+="worker ".concat(this.name," from ").concat(this.url,". "),e.message&&(t+="".concat(e.message," in ")),e.lineno&&(t+=":".concat(e.lineno,":").concat(e.colno)),new Error(t)}_createBrowserWorker(){this._loadableURL=b1({source:this.source,url:this.url});let e=new Worker(this._loadableURL,{name:this.name});return e.onmessage=t=>{t.data?this.onMessage(t.data):this.onError(new Error("No data received"))},e.onerror=t=>{this.onError(this._getErrorFromErrorEvent(t)),this.terminated=!0},e.onmessageerror=t=>console.error(t),e}_createNodeWorker(){let e;if(this.url){let i=this.url.includes(":/")||this.url.startsWith("/")?this.url:"./".concat(this.url);e=new hh(i,{eval:!1})}else if(this.source)e=new hh(this.source,{eval:!0});else throw new Error("no worker");return e.on("message",t=>{this.onMessage(t)}),e.on("error",t=>{this.onError(t)}),e.on("exit",t=>{}),e}};var Rf=class{static isSupported(){return $a.isSupported()}constructor(e){y(this,"name","unnamed"),y(this,"source",void 0),y(this,"url",void 0),y(this,"maxConcurrency",1),y(this,"maxMobileConcurrency",1),y(this,"onDebug",()=>{}),y(this,"reuseWorkers",!0),y(this,"props",{}),y(this,"jobQueue",[]),y(this,"idleQueue",[]),y(this,"count",0),y(this,"isDestroyed",!1),this.source=e.source,this.url=e.url,this.setProps(e)}destroy(){this.idleQueue.forEach(e=>e.destroy()),this.isDestroyed=!0}setProps(e){this.props={...this.props,...e},e.name!==void 0&&(this.name=e.name),e.maxConcurrency!==void 0&&(this.maxConcurrency=e.maxConcurrency),e.maxMobileConcurrency!==void 0&&(this.maxMobileConcurrency=e.maxMobileConcurrency),e.reuseWorkers!==void 0&&(this.reuseWorkers=e.reuseWorkers),e.onDebug!==void 0&&(this.onDebug=e.onDebug)}async startJob(e,t=(n,o,a)=>n.done(a),i=(n,o)=>n.error(o)){let n=new Promise(o=>(this.jobQueue.push({name:e,onMessage:t,onError:i,onStart:o}),this));return this._startQueuedJob(),await n}async _startQueuedJob(){if(!this.jobQueue.length)return;let e=this._getAvailableWorker();if(!e)return;let t=this.jobQueue.shift();if(t){this.onDebug({message:"Starting job",name:t.name,workerThread:e,backlog:this.jobQueue.length});let i=new Lf(t.name,e);e.onMessage=n=>t.onMessage(i,n.type,n.payload),e.onError=n=>t.onError(i,n),t.onStart(i);try{await i.result}finally{this.returnWorkerToQueue(e)}}}returnWorkerToQueue(e){this.isDestroyed||!this.reuseWorkers||this.count>this._getMaxConcurrency()?(e.destroy(),this.count--):this.idleQueue.push(e),this.isDestroyed||this._startQueuedJob()}_getAvailableWorker(){if(this.idleQueue.length>0)return this.idleQueue.shift()||null;if(this.count<this._getMaxConcurrency()){this.count++;let e="".concat(this.name.toLowerCase()," (#").concat(this.count," of ").concat(this.maxConcurrency,")");return new $a({name:e,source:this.source,url:this.url})}return null}_getMaxConcurrency(){return m1?this.maxMobileConcurrency:this.maxConcurrency}};var EB={maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:!0,onDebug:()=>{}},_i=class{static isSupported(){return $a.isSupported()}static getWorkerFarm(e={}){return _i._workerFarm=_i._workerFarm||new _i({}),_i._workerFarm.setProps(e),_i._workerFarm}constructor(e){y(this,"props",void 0),y(this,"workerPools",new Map),this.props={...EB},this.setProps(e),this.workerPools=new Map}destroy(){for(let e of this.workerPools.values())e.destroy();this.workerPools=new Map}setProps(e){this.props={...this.props,...e};for(let t of this.workerPools.values())t.setProps(this._getWorkerPoolProps())}getWorkerPool(e){let{name:t,source:i,url:n}=e,o=this.workerPools.get(t);return o||(o=new Rf({name:t,source:i,url:n}),o.setProps(this._getWorkerPoolProps()),this.workerPools.set(t,o)),o}_getWorkerPoolProps(){return{maxConcurrency:this.props.maxConcurrency,maxMobileConcurrency:this.props.maxMobileConcurrency,reuseWorkers:this.props.reuseWorkers,onDebug:this.props.onDebug}}};y(_i,"_workerFarm",void 0);var xB="latest";function GS(s,e={}){let t=e[s.id]||{},i="".concat(s.id,"-worker.js"),n=t.workerUrl;if(!n&&s.id==="compression"&&(n=e.workerUrl),e._workerType==="test"&&(n="modules/".concat(s.module,"/dist/").concat(i)),!n){let o=s.version;o==="latest"&&(o=xB);let a=o?"@".concat(o):"";n="https://unpkg.com/@loaders.gl/".concat(s.module).concat(a,"/dist/").concat(i)}return ri(n),n}function FS(s,e=g1){ri(s,"no worker provided");let t=s.version;return!(!e||!t)}function kS(s,e){return!_i.isSupported()||!Pu&&!(e!=null&&e._nodeWorkers)?!1:s.worker&&e?.worker}async function VS(s,e,t,i,n){let o=s.id,a=GS(s,t),u=_i.getWorkerFarm(t).getWorkerPool({name:o,url:a});t=JSON.parse(JSON.stringify(t)),i=JSON.parse(JSON.stringify(i||{}));let c=await u.startJob("process-on-worker",vB.bind(null,n));return c.postMessage("process",{input:e,options:t,context:i}),await(await c.result).result}async function vB(s,e,t,i){switch(t){case"done":e.done(i);break;case"error":e.error(new Error(i.error));break;case"process":let{id:n,input:o,options:a}=i;try{let l=await s(o,a);e.postMessage("done",{id:n,result:l})}catch(l){let u=l instanceof Error?l.message:"unknown error";e.postMessage("error",{id:n,error:u})}break;default:console.warn("parse-with-worker unknown message ".concat(t))}}function US(s){return s&&typeof s=="object"&&s.isBuffer}function S1(s){return US(s)?new Uint8Array(s.buffer,s.byteOffset,s.length).slice().buffer:s}function Bb(s){if(US(s))return S1(s);if(s instanceof ArrayBuffer)return s;if(ArrayBuffer.isView(s))return s.byteOffset===0&&s.byteLength===s.buffer.byteLength?s.buffer:s.buffer.slice(s.byteOffset,s.byteOffset+s.byteLength);if(typeof s=="string"){let e=s;return new TextEncoder().encode(e).buffer}if(s&&typeof s=="object"&&s._toArrayBuffer)return s._toArrayBuffer();throw new Error("toArrayBuffer")}function zS(s,e,t){if(t=t||s.byteLength,s.byteLength<t||e.byteLength<t)return!1;let i=new Uint8Array(s),n=new Uint8Array(e);for(let o=0;o<i.length;++o)if(i[o]!==n[o])return!1;return!0}function WS(...s){let e=s.map(o=>o instanceof ArrayBuffer?new Uint8Array(o):o),t=e.reduce((o,a)=>o+a.byteLength,0),i=new Uint8Array(t),n=0;for(let o of e)i.set(o,n),n+=o.byteLength;return i.buffer}async function HS(s){let e=[];for await(let t of s)e.push(t);return WS(...e)}function Of(){let s;if(typeof window<"u"&&window.performance)s=window.performance.now();else if(typeof process<"u"&&process.hrtime){let e=process.hrtime();s=e[0]*1e3+e[1]/1e6}else s=Date.now();return s}var el=class{constructor(e,t){y(this,"name",void 0),y(this,"type",void 0),y(this,"sampleSize",1),y(this,"time",void 0),y(this,"count",void 0),y(this,"samples",void 0),y(this,"lastTiming",void 0),y(this,"lastSampleTime",void 0),y(this,"lastSampleCount",void 0),y(this,"_count",0),y(this,"_time",0),y(this,"_samples",0),y(this,"_startTime",0),y(this,"_timerPending",!1),this.name=e,this.type=t,this.reset()}setSampleSize(e){return this.sampleSize=e,this}incrementCount(){return this.addCount(1),this}decrementCount(){return this.subtractCount(1),this}addCount(e){return this._count+=e,this._samples++,this._checkSampling(),this}subtractCount(e){return this._count-=e,this._samples++,this._checkSampling(),this}addTime(e){return this._time+=e,this.lastTiming=e,this._samples++,this._checkSampling(),this}timeStart(){return this._startTime=Of(),this._timerPending=!0,this}timeEnd(){return this._timerPending?(this.addTime(Of()-this._startTime),this._timerPending=!1,this._checkSampling(),this):this}getSampleAverageCount(){return this.sampleSize>0?this.lastSampleCount/this.sampleSize:0}getSampleAverageTime(){return this.sampleSize>0?this.lastSampleTime/this.sampleSize:0}getSampleHz(){return this.lastSampleTime>0?this.sampleSize/(this.lastSampleTime/1e3):0}getAverageCount(){return this.samples>0?this.count/this.samples:0}getAverageTime(){return this.samples>0?this.time/this.samples:0}getHz(){return this.time>0?this.samples/(this.time/1e3):0}reset(){return this.time=0,this.count=0,this.samples=0,this.lastTiming=0,this.lastSampleTime=0,this.lastSampleCount=0,this._count=0,this._time=0,this._samples=0,this._startTime=0,this._timerPending=!1,this}_checkSampling(){this._samples===this.sampleSize&&(this.lastSampleTime=this._time,this.lastSampleCount=this._count,this.count+=this._count,this.time+=this._time,this.samples+=this._samples,this._time=0,this._count=0,this._samples=0)}};var en=class{constructor(e){y(this,"id",void 0),y(this,"stats",{}),this.id=e.id,this.stats={},this._initializeStats(e.stats),Object.seal(this)}get(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"count";return this._getOrCreate({name:e,type:t})}get size(){return Object.keys(this.stats).length}reset(){for(let e in this.stats)this.stats[e].reset();return this}forEach(e){for(let t in this.stats)e(this.stats[t])}getTable(){let e={};return this.forEach(t=>{e[t.name]={time:t.time||0,count:t.count||0,average:t.getAverageTime()||0,hz:t.getHz()||0}}),e}_initializeStats(){(arguments.length>0&&arguments[0]!==void 0?arguments[0]:[]).forEach(t=>this._getOrCreate(t))}_getOrCreate(e){if(!e||!e.name)return null;let{name:t,type:i}=e;return this.stats[t]||(e instanceof el?this.stats[t]=e:this.stats[t]=new el(t,i)),this.stats[t]}};var CB="Queued Requests",AB="Active Requests",TB="Cancelled Requests",IB="Queued Requests Ever",wB="Active Requests Ever",LB={id:"request-scheduler",throttleRequests:!0,maxRequests:6},dh=class{constructor(e={}){y(this,"props",void 0),y(this,"stats",void 0),y(this,"activeRequestCount",0),y(this,"requestQueue",[]),y(this,"requestMap",new Map),y(this,"deferredUpdate",null),this.props={...LB,...e},this.stats=new en({id:this.props.id}),this.stats.get(CB),this.stats.get(AB),this.stats.get(TB),this.stats.get(IB),this.stats.get(wB)}scheduleRequest(e,t=()=>0){if(!this.props.throttleRequests)return Promise.resolve({done:()=>{}});if(this.requestMap.has(e))return this.requestMap.get(e);let i={handle:e,priority:0,getPriority:t},n=new Promise(o=>(i.resolve=o,i));return this.requestQueue.push(i),this.requestMap.set(e,n),this._issueNewRequests(),n}_issueRequest(e){let{handle:t,resolve:i}=e,n=!1,o=()=>{n||(n=!0,this.requestMap.delete(t),this.activeRequestCount--,this._issueNewRequests())};return this.activeRequestCount++,i?i({done:o}):Promise.resolve({done:o})}_issueNewRequests(){this.deferredUpdate||(this.deferredUpdate=setTimeout(()=>this._issueNewRequestsAsync(),0))}_issueNewRequestsAsync(){this.deferredUpdate=null;let e=Math.max(this.props.maxRequests-this.activeRequestCount,0);if(e!==0){this._updateAllRequests();for(let t=0;t<e;++t){let i=this.requestQueue.shift();i&&this._issueRequest(i)}}}_updateAllRequests(){let e=this.requestQueue;for(let t=0;t<e.length;++t){let i=e[t];this._updateRequest(i)||(e.splice(t,1),this.requestMap.delete(i.handle),t--)}e.sort((t,i)=>t.priority-i.priority)}_updateRequest(e){return e.priority=e.getPriority(e.handle),e.priority<0?(e.resolve(null),!1):!0}};var RB="",E1={};function jS(s){for(let e in E1)if(s.startsWith(e)){let t=E1[e];s=s.replace(e,t)}return!s.startsWith("http://")&&!s.startsWith("https://")&&(s="".concat(RB).concat(s)),s}var Db={};E_(Db,{dirname:()=>_B,filename:()=>OB,join:()=>NB});function OB(s){let e=s&&s.lastIndexOf("/");return e>=0?s.substr(e+1):""}function _B(s){let e=s&&s.lastIndexOf("/");return e>=0?s.substr(0,e):""}function NB(...s){let e="/";return s=s.map((t,i)=>(i&&(t=t.replace(new RegExp("^".concat(e)),"")),i!==s.length-1&&(t=t.replace(new RegExp("".concat(e,"$")),"")),t)),s.join(e)}var MB=s=>typeof s=="boolean",_f=s=>typeof s=="function",fh=s=>s!==null&&typeof s=="object",qS=s=>fh(s)&&s.constructor==={}.constructor;var x1=s=>s&&typeof s[Symbol.iterator]=="function",v1=s=>s&&typeof s[Symbol.asyncIterator]=="function";var to=s=>typeof Response<"u"&&s instanceof Response||s&&s.arrayBuffer&&s.text&&s.json;var ro=s=>typeof Blob<"u"&&s instanceof Blob,C1=s=>s&&typeof s=="object"&&s.isBuffer;var BB=s=>typeof ReadableStream<"u"&&s instanceof ReadableStream||fh(s)&&_f(s.tee)&&_f(s.cancel)&&_f(s.getReader);var DB=s=>fh(s)&&_f(s.read)&&_f(s.pipe)&&MB(s.readable),Gb=s=>BB(s)||DB(s);var GB=/^data:([-\w.]+\/[-\w.+]+)(;|,)/,FB=/^([-\w.]+\/[-\w.+]+)/;function A1(s){let e=FB.exec(s);return e?e[1]:s}function XS(s){let e=GB.exec(s);return e?e[1]:""}var kB=/\?.*/;function yu(s){if(to(s)){let e=YS(s.url||""),t=s.headers.get("content-type")||"";return{url:e,type:A1(t)||XS(e)}}return ro(s)?{url:YS(s.name||""),type:s.type||""}:typeof s=="string"?{url:YS(s),type:XS(s)}:{url:"",type:""}}function T1(s){return to(s)?s.headers["content-length"]||-1:ro(s)?s.size:typeof s=="string"?s.length:s instanceof ArrayBuffer||ArrayBuffer.isView(s)?s.byteLength:-1}function YS(s){return s.replace(kB,"")}async function Fb(s){if(to(s))return s;let e={},t=T1(s);t>=0&&(e["content-length"]=String(t));let{url:i,type:n}=yu(s);n&&(e["content-type"]=n);let o=await UB(s);o&&(e["x-first-bytes"]=o),typeof s=="string"&&(s=new TextEncoder().encode(s));let a=new Response(s,{headers:e});return Object.defineProperty(a,"url",{value:i}),a}async function I1(s){if(!s.ok){let e=await VB(s);throw new Error(e)}}async function VB(s){let e="Failed to fetch resource ".concat(s.url," (").concat(s.status,"): ");try{let t=s.headers.get("Content-Type"),i=s.statusText;t.includes("application/json")&&(i+=" ".concat(await s.text())),e+=i,e=e.length>60?"".concat(e.slice(0,60),"..."):e}catch{}return e}async function UB(s){if(typeof s=="string")return"data:,".concat(s.slice(0,5));if(s instanceof Blob){let t=s.slice(0,5);return await new Promise(i=>{let n=new FileReader;n.onload=o=>{var a;return i(o==null||(a=o.target)===null||a===void 0?void 0:a.result)},n.readAsDataURL(t)})}if(s instanceof ArrayBuffer){let t=s.slice(0,5),i=zB(t);return"data:base64,".concat(i)}return null}function zB(s){let e="",t=new Uint8Array(s);for(let i=0;i<t.byteLength;i++)e+=String.fromCharCode(t[i]);return btoa(e)}async function KS(s,e){if(typeof s=="string"){s=jS(s);let t=e;return e!=null&&e.fetch&&typeof e?.fetch!="function"&&(t=e.fetch),await fetch(s,t)}return await Fb(s)}function Nf(s){if(typeof window<"u"&&typeof window.process=="object"&&window.process.type==="renderer"||typeof process<"u"&&typeof process.versions=="object"&&Boolean(process.versions.electron))return!0;let e=typeof navigator=="object"&&typeof navigator.userAgent=="string"&&navigator.userAgent,t=s||e;return!!(t&&t.indexOf("Electron")>=0)}function dr(){return!(typeof process=="object"&&String(process)==="[object process]"&&!process.browser)||Nf()}var tl={self:typeof self<"u"&&self,window:typeof window<"u"&&window,global:typeof global<"u"&&global,document:typeof document<"u"&&document,process:typeof process=="object"&&process};var WB=tl.self||tl.window||tl.global,gh=tl.window||tl.self||tl.global,HB=tl.document||{},Su=tl.process||{};var kb=typeof __VERSION__<"u"?__VERSION__:"untranspiled source",Yye=dr();var ZS=globalThis;function ph(s){if(!s&&!dr())return"Node";if(Nf(s))return"Electron";let t=s||(typeof navigator<"u"?navigator:{}).userAgent||"";if(t.indexOf("Edge")>-1)return"Edge";let i=t.indexOf("MSIE ")!==-1,n=t.indexOf("Trident/")!==-1;return i||n?"IE":ZS.chrome?"Chrome":ZS.safari?"Safari":ZS.mozInnerScreenX?"Firefox":"Unknown"}function jB(s){try{let e=window[s],t="__storage_test__";return e.setItem(t,t),e.removeItem(t),e}catch{return null}}var Mf=class{constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"sessionStorage";y(this,"storage",void 0),y(this,"id",void 0),y(this,"config",{}),this.storage=jB(i),this.id=e,this.config={},Object.assign(this.config,t),this._loadConfiguration()}getConfiguration(){return this.config}setConfiguration(e){return this.config={},this.updateConfiguration(e)}updateConfiguration(e){if(Object.assign(this.config,e),this.storage){let t=JSON.stringify(this.config);this.storage.setItem(this.id,t)}return this}_loadConfiguration(){let e={};if(this.storage){let t=this.storage.getItem(this.id);e=t?JSON.parse(t):{}}return Object.assign(this.config,e),this}};function w1(s){let e;return s<10?e="".concat(s.toFixed(2),"ms"):s<100?e="".concat(s.toFixed(1),"ms"):s<1e3?e="".concat(s.toFixed(0),"ms"):e="".concat((s/1e3).toFixed(2),"s"),e}function L1(s){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:8,t=Math.max(e-s.length,0);return"".concat(" ".repeat(t)).concat(s)}function Vb(s,e,t){let i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:600,n=s.src.replace(/\(/g,"%28").replace(/\)/g,"%29");s.width>i&&(t=Math.min(t,i/s.width));let o=s.width*t,a=s.height*t,l=["font-size:1px;","padding:".concat(Math.floor(a/2),"px ").concat(Math.floor(o/2),"px;"),"line-height:".concat(a,"px;"),"background:url(".concat(n,");"),"background-size:".concat(o,"px ").concat(a,"px;"),"color:transparent;"].join("");return["".concat(e," %c+"),l]}var Ub;(function(s){s[s.BLACK=30]="BLACK",s[s.RED=31]="RED",s[s.GREEN=32]="GREEN",s[s.YELLOW=33]="YELLOW",s[s.BLUE=34]="BLUE",s[s.MAGENTA=35]="MAGENTA",s[s.CYAN=36]="CYAN",s[s.WHITE=37]="WHITE",s[s.BRIGHT_BLACK=90]="BRIGHT_BLACK",s[s.BRIGHT_RED=91]="BRIGHT_RED",s[s.BRIGHT_GREEN=92]="BRIGHT_GREEN",s[s.BRIGHT_YELLOW=93]="BRIGHT_YELLOW",s[s.BRIGHT_BLUE=94]="BRIGHT_BLUE",s[s.BRIGHT_MAGENTA=95]="BRIGHT_MAGENTA",s[s.BRIGHT_CYAN=96]="BRIGHT_CYAN",s[s.BRIGHT_WHITE=97]="BRIGHT_WHITE"})(Ub||(Ub={}));function R1(s){return typeof s=="string"?Ub[s.toUpperCase()]||Ub.WHITE:s}function O1(s,e,t){return!dr&&typeof s=="string"&&(e&&(e=R1(e),s="\x1B[".concat(e,"m").concat(s,"\x1B[39m")),t&&(e=R1(t),s="\x1B[".concat(t+10,"m").concat(s,"\x1B[49m"))),s}function _1(s){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:["constructor"],t=Object.getPrototypeOf(s),i=Object.getOwnPropertyNames(t);for(let n of i)typeof s[n]=="function"&&(e.find(o=>n===o)||(s[n]=s[n].bind(s)))}function mh(s,e){if(!s)throw new Error(e||"Assertion failed")}function Eu(){let s;if(dr&&"performance"in gh){var e,t;s=gh===null||gh===void 0||(e=gh.performance)===null||e===void 0||(t=e.now)===null||t===void 0?void 0:t.call(e)}else if("hrtime"in Su){var i;let n=Su===null||Su===void 0||(i=Su.hrtime)===null||i===void 0?void 0:i.call(Su);s=n[0]*1e3+n[1]/1e6}else s=Date.now();return s}var bh={debug:dr&&console.debug||console.log,log:console.log,info:console.info,warn:console.warn,error:console.error},qB={enabled:!0,level:0};function Rn(){}var N1={},M1={once:!0},ii=class{constructor(){let{id:e}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{id:""};y(this,"id",void 0),y(this,"VERSION",kb),y(this,"_startTs",Eu()),y(this,"_deltaTs",Eu()),y(this,"_storage",void 0),y(this,"userData",{}),y(this,"LOG_THROTTLE_TIMEOUT",0),this.id=e,this._storage=new Mf("__probe-".concat(this.id,"__"),qB),this.userData={},this.timeStamp("".concat(this.id," started")),_1(this),Object.seal(this)}set level(e){this.setLevel(e)}get level(){return this.getLevel()}isEnabled(){return this._storage.config.enabled}getLevel(){return this._storage.config.level}getTotal(){return Number((Eu()-this._startTs).toPrecision(10))}getDelta(){return Number((Eu()-this._deltaTs).toPrecision(10))}set priority(e){this.level=e}get priority(){return this.level}getPriority(){return this.level}enable(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return this._storage.updateConfiguration({enabled:e}),this}setLevel(e){return this._storage.updateConfiguration({level:e}),this}get(e){return this._storage.config[e]}set(e,t){this._storage.updateConfiguration({[e]:t})}settings(){console.table?console.table(this._storage.config):console.log(this._storage.config)}assert(e,t){mh(e,t)}warn(e){return this._getLogFunction(0,e,bh.warn,arguments,M1)}error(e){return this._getLogFunction(0,e,bh.error,arguments)}deprecated(e,t){return this.warn("`".concat(e,"` is deprecated and will be removed in a later version. Use `").concat(t,"` instead"))}removed(e,t){return this.error("`".concat(e,"` has been removed. Use `").concat(t,"` instead"))}probe(e,t){return this._getLogFunction(e,t,bh.log,arguments,{time:!0,once:!0})}log(e,t){return this._getLogFunction(e,t,bh.debug,arguments)}info(e,t){return this._getLogFunction(e,t,console.info,arguments)}once(e,t){for(var i=arguments.length,n=new Array(i>2?i-2:0),o=2;o<i;o++)n[o-2]=arguments[o];return this._getLogFunction(e,t,bh.debug||bh.info,arguments,M1)}table(e,t,i){return t?this._getLogFunction(e,t,console.table||Rn,i&&[i],{tag:ZB(t)}):Rn}image(e){let{logLevel:t,priority:i,image:n,message:o="",scale:a=1}=e;return this._shouldLog(t||i)?dr?KB({image:n,message:o,scale:a}):YB({image:n,message:o,scale:a}):Rn}time(e,t){return this._getLogFunction(e,t,console.time?console.time:console.info)}timeEnd(e,t){return this._getLogFunction(e,t,console.timeEnd?console.timeEnd:console.info)}timeStamp(e,t){return this._getLogFunction(e,t,console.timeStamp||Rn)}group(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{collapsed:!1},n=B1({logLevel:e,message:t,opts:i}),{collapsed:o}=i;return n.method=(o?console.groupCollapsed:console.group)||console.info,this._getLogFunction(n)}groupCollapsed(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};return this.group(e,t,Object.assign({},i,{collapsed:!0}))}groupEnd(e){return this._getLogFunction(e,"",console.groupEnd||Rn)}withGroup(e,t,i){this.group(e,t)();try{i()}finally{this.groupEnd(e)()}}trace(){console.trace&&console.trace()}_shouldLog(e){return this.isEnabled()&&this.getLevel()>=D1(e)}_getLogFunction(e,t,i,n,o){if(this._shouldLog(e)){o=B1({logLevel:e,message:t,args:n,opts:o}),i=i||o.method,mh(i),o.total=this.getTotal(),o.delta=this.getDelta(),this._deltaTs=Eu();let a=o.tag||o.message;if(o.once)if(!N1[a])N1[a]=Eu();else return Rn;return t=XB(this.id,o.message,o),i.bind(console,t,...o.args)}return Rn}};y(ii,"VERSION",kb);function D1(s){if(!s)return 0;let e;switch(typeof s){case"number":e=s;break;case"object":e=s.logLevel||s.priority||0;break;default:return 0}return mh(Number.isFinite(e)&&e>=0),e}function B1(s){let{logLevel:e,message:t}=s;s.logLevel=D1(e);let i=s.args?Array.from(s.args):[];for(;i.length&&i.shift()!==t;);switch(typeof e){case"string":case"function":t!==void 0&&i.unshift(t),s.message=e;break;case"object":Object.assign(s,e);break;default:}typeof s.message=="function"&&(s.message=s.message());let n=typeof s.message;return mh(n==="string"||n==="object"),Object.assign(s,{args:i},s.opts)}function XB(s,e,t){if(typeof e=="string"){let i=t.time?L1(w1(t.total)):"";e=t.time?"".concat(s,": ").concat(i,"  ").concat(e):"".concat(s,": ").concat(e),e=O1(e,t.color,t.background)}return e}function YB(s){let{image:e,message:t="",scale:i=1}=s,n=null;try{n=module.require("asciify-image")}catch{}return n?()=>n(e,{fit:"box",width:"".concat(Math.round(80*i),"%")}).then(o=>console.log(o)):Rn}function KB(s){let{image:e,message:t="",scale:i=1}=s;if(typeof e=="string"){let o=new Image;return o.onload=()=>{let a=Vb(o,t,i);console.log(...a)},o.src=e,Rn}let n=e.nodeName||"";if(n.toLowerCase()==="img")return console.log(...Vb(e,t,i)),Rn;if(n.toLowerCase()==="canvas"){let o=new Image;return o.onload=()=>console.log(...Vb(o,t,i)),o.src=e.toDataURL(),Rn}return Rn}function ZB(s){for(let e in s)for(let t in s[e])return t||"untitled";return"empty"}var I0e=new ii({id:"@probe.gl/log"});var QS=new ii({id:"loaders.gl"}),zb=class{log(){return()=>{}}info(){return()=>{}}warn(){return()=>{}}error(){return()=>{}}},Wb=class{constructor(){y(this,"console",void 0),this.console=console}log(...e){return this.console.log.bind(this.console,...e)}info(...e){return this.console.info.bind(this.console,...e)}warn(...e){return this.console.warn.bind(this.console,...e)}error(...e){return this.console.error.bind(this.console,...e)}};var JS={fetch:null,mimeType:void 0,nothrow:!1,log:new Wb,CDN:"https://unpkg.com/@loaders.gl",worker:!0,maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:bu,_nodeWorkers:!1,_workerType:"",limit:0,_limitMB:0,batchSize:"auto",batchDebounceMs:0,metadata:!1,transforms:[]},G1={throws:"nothrow",dataType:"(no longer used)",uri:"baseUri",method:"fetch.method",headers:"fetch.headers",body:"fetch.body",mode:"fetch.mode",credentials:"fetch.credentials",cache:"fetch.cache",redirect:"fetch.redirect",referrer:"fetch.referrer",referrerPolicy:"fetch.referrerPolicy",integrity:"fetch.integrity",keepalive:"fetch.keepalive",signal:"fetch.signal"};function $S(){globalThis.loaders=globalThis.loaders||{};let{loaders:s}=globalThis;return s._state=s._state||{},s._state}var V1=()=>{let s=$S();return s.globalOptions=s.globalOptions||{...JS},s.globalOptions};function U1(s,e,t,i){return t=t||[],t=Array.isArray(t)?t:[t],QB(s,t),$B(e,s,i)}function Hb(s,e){let t=V1(),i=s||t;return typeof i.fetch=="function"?i.fetch:fh(i.fetch)?n=>KS(n,i):e!=null&&e.fetch?e?.fetch:KS}function QB(s,e){F1(s,null,JS,G1,e);for(let t of e){let i=s&&s[t.id]||{},n=t.options&&t.options[t.id]||{},o=t.deprecatedOptions&&t.deprecatedOptions[t.id]||{};F1(i,t.id,n,o,e)}}function F1(s,e,t,i,n){let o=e||"Top level",a=e?"".concat(e,"."):"";for(let l in s){let u=!e&&fh(s[l]),c=l==="baseUri"&&!e,h=l==="workerUrl"&&e;if(!(l in t)&&!c&&!h){if(l in i)QS.warn("".concat(o," loader option '").concat(a).concat(l,"' no longer supported, use '").concat(i[l],"'"))();else if(!u){let d=JB(l,n);QS.warn("".concat(o," loader option '").concat(a).concat(l,"' not recognized. ").concat(d))()}}}}function JB(s,e){let t=s.toLowerCase(),i="";for(let n of e)for(let o in n.options){if(s===o)return"Did you mean '".concat(n.id,".").concat(o,"'?");let a=o.toLowerCase();(t.startsWith(a)||a.startsWith(t))&&(i=i||"Did you mean '".concat(n.id,".").concat(o,"'?"))}return i}function $B(s,e,t){let n={...s.options||{}};return eD(n,t),n.log===null&&(n.log=new zb),k1(n,V1()),k1(n,e),n}function k1(s,e){for(let t in e)if(t in e){let i=e[t];qS(i)&&qS(s[t])?s[t]={...s[t],...e[t]}:s[t]=e[t]}}function eD(s,e){e&&!("baseUri"in s)&&(s.baseUri=e)}function Bf(s){var e;return s?(Array.isArray(s)&&(s=s[0]),Array.isArray((e=s)===null||e===void 0?void 0:e.extensions)):!1}function Df(s){var e,t;Ja(s,"null loader"),Ja(Bf(s),"invalid loader");let i;return Array.isArray(s)&&(i=s[1],s=s[0],s={...s,options:{...s.options,...i}}),((e=s)!==null&&e!==void 0&&e.parseTextSync||(t=s)!==null&&t!==void 0&&t.parseText)&&(s.text=!0),s.text||(s.binary=!0),s}var z1=()=>{let s=$S();return s.loaderRegistry=s.loaderRegistry||[],s.loaderRegistry};function eE(s){let e=z1();s=Array.isArray(s)?s:[s];for(let t of s){let i=Df(t);e.find(n=>i===n)||e.unshift(i)}}function W1(){return z1()}var H1=new ii({id:"loaders.gl"});var tD=/\.([^.]+)$/;async function X1(s,e=[],t,i){if(!Y1(s))return null;let n=j1(s,e,{...t,nothrow:!0},i);if(n)return n;if(ro(s)&&(s=await s.slice(0,10).arrayBuffer(),n=j1(s,e,t,i)),!n&&!(t!=null&&t.nothrow))throw new Error(K1(s));return n}function j1(s,e=[],t,i){if(!Y1(s))return null;if(e&&!Array.isArray(e))return Df(e);let n=[];e&&(n=n.concat(e)),t!=null&&t.ignoreRegisteredLoaders||n.push(...W1()),iD(n);let o=rD(s,n,t,i);if(!o&&!(t!=null&&t.nothrow))throw new Error(K1(s));return o}function rD(s,e,t,i){let{url:n,type:o}=yu(s),a=n||i?.url,l=null,u="";if(t!=null&&t.mimeType&&(l=tE(e,t?.mimeType),u="match forced by supplied MIME type ".concat(t?.mimeType)),l=l||nD(e,a),u=u||(l?"matched url ".concat(a):""),l=l||tE(e,o),u=u||(l?"matched MIME type ".concat(o):""),l=l||sD(e,s),u=u||(l?"matched initial data ".concat(Z1(s)):""),l=l||tE(e,t?.fallbackMimeType),u=u||(l?"matched fallback MIME type ".concat(o):""),u){var c;H1.log(1,"selectLoader selected ".concat((c=l)===null||c===void 0?void 0:c.name,": ").concat(u,"."))}return l}function Y1(s){return!(s instanceof Response&&s.status===204)}function K1(s){let{url:e,type:t}=yu(s),i="No valid loader found (";i+=e?"".concat(Db.filename(e),", "):"no url provided, ",i+="MIME type: ".concat(t?'"'.concat(t,'"'):"not provided",", ");let n=s?Z1(s):"";return i+=n?' first bytes: "'.concat(n,'"'):"first bytes: not available",i+=")",i}function iD(s){for(let e of s)Df(e)}function nD(s,e){let t=e&&tD.exec(e),i=t&&t[1];return i?oD(s,i):null}function oD(s,e){e=e.toLowerCase();for(let t of s)for(let i of t.extensions)if(i.toLowerCase()===e)return t;return null}function tE(s,e){for(let t of s)if(t.mimeTypes&&t.mimeTypes.includes(e)||e==="application/x.".concat(t.id))return t;return null}function sD(s,e){if(!e)return null;for(let t of s)if(typeof e=="string"){if(aD(e,t))return t}else if(ArrayBuffer.isView(e)){if(q1(e.buffer,e.byteOffset,t))return t}else if(e instanceof ArrayBuffer&&q1(e,0,t))return t;return null}function aD(s,e){return e.testText?e.testText(s):(Array.isArray(e.tests)?e.tests:[e.tests]).some(i=>s.startsWith(i))}function q1(s,e,t){return(Array.isArray(t.tests)?t.tests:[t.tests]).some(n=>lD(s,e,t,n))}function lD(s,e,t,i){if(i instanceof ArrayBuffer)return zS(i,s,i.byteLength);switch(typeof i){case"function":return i(s,t);case"string":let n=rE(s,e,i.length);return i===n;default:return!1}}function Z1(s,e=5){return typeof s=="string"?s.slice(0,e):ArrayBuffer.isView(s)?rE(s.buffer,s.byteOffset,e):s instanceof ArrayBuffer?rE(s,0,e):""}function rE(s,e,t){if(s.byteLength<e+t)return"";let i=new DataView(s),n="";for(let o=0;o<t;o++)n+=String.fromCharCode(i.getUint8(e+o));return n}function*Q1(s,e){let t=e?.chunkSize||262144,i=0,n=new TextEncoder;for(;i<s.length;){let o=Math.min(s.length-i,t),a=s.slice(i,i+o);i+=o,yield n.encode(a)}}function*J1(s,e={}){let{chunkSize:t=262144}=e,i=0;for(;i<s.byteLength;){let n=Math.min(s.byteLength-i,t),o=new ArrayBuffer(n),a=new Uint8Array(s,i,n);new Uint8Array(o).set(a),i+=n,yield o}}async function*$1(s,e){let t=e?.chunkSize||1048576,i=0;for(;i<s.size;){let n=i+t,o=await s.slice(i,n).arrayBuffer();i=n,yield o}}function iE(s,e){return bu?uD(s,e):cD(s,e)}async function*uD(s,e){let t=s.getReader(),i;try{for(;;){let n=i||t.read();e!=null&&e._streamReadAhead&&(i=t.read());let{done:o,value:a}=await n;if(o)return;yield Bb(a)}}catch{t.releaseLock()}}async function*cD(s,e){for await(let t of s)yield Bb(t)}function eT(s,e){if(typeof s=="string")return Q1(s,e);if(s instanceof ArrayBuffer)return J1(s,e);if(ro(s))return $1(s,e);if(Gb(s))return iE(s,e);if(to(s))return iE(s.body,e);throw new Error("makeIterator")}var tT="Cannot convert supplied data type";function hD(s,e,t){if(e.text&&typeof s=="string")return s;if(C1(s)&&(s=s.buffer),s instanceof ArrayBuffer){let i=s;return e.text&&!e.binary?new TextDecoder("utf8").decode(i):i}if(ArrayBuffer.isView(s)){if(e.text&&!e.binary)return new TextDecoder("utf8").decode(s);let i=s.buffer,n=s.byteLength||s.length;return(s.byteOffset!==0||n!==i.byteLength)&&(i=i.slice(s.byteOffset,s.byteOffset+n)),i}throw new Error(tT)}async function rT(s,e,t){let i=s instanceof ArrayBuffer||ArrayBuffer.isView(s);if(typeof s=="string"||i)return hD(s,e,t);if(ro(s)&&(s=await Fb(s)),to(s)){let n=s;return await I1(n),e.binary?await n.arrayBuffer():await n.text()}if(Gb(s)&&(s=eT(s,t)),x1(s)||v1(s))return HS(s);throw new Error(tT)}function iT(s,e,t=null){if(t)return t;let i={fetch:Hb(e,s),...s};return Array.isArray(i.loaders)||(i.loaders=null),i}function nT(s,e){if(!e&&s&&!Array.isArray(s))return s;let t;if(s&&(t=Array.isArray(s)?s:[s]),e&&e.loaders){let i=Array.isArray(e.loaders)?e.loaders:[e.loaders];t=t?[...t,...i]:i}return t&&t.length?t:null}async function jb(s,e,t,i){ri(!i||typeof i=="object"),e&&!Array.isArray(e)&&!Bf(e)&&(i=void 0,t=e,e=void 0),s=await s,t=t||{};let{url:n}=yu(s),a=nT(e,i),l=await X1(s,a,t);return l?(t=U1(t,l,a,n),i=iT({url:n,parse:jb,loaders:a},t,i),await dD(l,s,t,i)):null}async function dD(s,e,t,i){if(FS(s),to(e)){let n=e,{ok:o,redirected:a,status:l,statusText:u,type:c,url:h}=n,d=Object.fromEntries(n.headers.entries());i.response={headers:d,ok:o,redirected:a,status:l,statusText:u,type:c,url:h}}if(e=await rT(e,s,t),s.parseTextSync&&typeof e=="string")return t.dataType="text",s.parseTextSync(e,t,i,s);if(kS(s,t))return await VS(s,e,t,i,jb);if(s.parseText&&typeof e=="string")return await s.parseText(e,t,i,s);if(s.parse)return await s.parse(e,t,i,s);throw ri(!s.parseSync),new Error("".concat(s.id," loader - no parser found and worker is disabled"))}async function $o(s,e,t,i){!Array.isArray(e)&&!Bf(e)&&(i=void 0,t=e,e=void 0);let n=Hb(t),o=s;return typeof s=="string"&&(o=await n(s)),ro(s)&&(o=await n(s)),await jb(o,e,t)}var oT="3.2.12";var{_parseImageNode:fD}=globalThis,nE=typeof Image<"u",oE=typeof ImageBitmap<"u",gD=Boolean(fD),sE=bu?!0:gD;function sT(s){switch(s){case"auto":return oE||nE||sE;case"imagebitmap":return oE;case"image":return nE;case"data":return sE;default:throw new Error("@loaders.gl/images: image ".concat(s," not supported in this environment"))}}function aT(){if(oE)return"imagebitmap";if(nE)return"image";if(sE)return"data";throw new Error("Install '@loaders.gl/polyfills' to parse images under Node.js")}function pD(s){let e=mD(s);if(!e)throw new Error("Not an image");return e}function lT(s){switch(pD(s)){case"data":return s;case"image":case"imagebitmap":let e=document.createElement("canvas"),t=e.getContext("2d");if(!t)throw new Error("getImageData");return e.width=s.width,e.height=s.height,t.drawImage(s,0,0),t.getImageData(0,0,s.width,s.height);default:throw new Error("getImageData")}}function mD(s){return typeof ImageBitmap<"u"&&s instanceof ImageBitmap?"imagebitmap":typeof Image<"u"&&s instanceof Image?"image":s&&typeof s=="object"&&s.data&&s.width&&s.height?"data":null}var bD=/^data:image\/svg\+xml/,PD=/\.svg((\?|#).*)?$/;function qb(s){return s&&(bD.test(s)||PD.test(s))}function uT(s,e){if(qb(e)){let i=new TextDecoder().decode(s);try{typeof unescape=="function"&&typeof encodeURIComponent=="function"&&(i=unescape(encodeURIComponent(i)))}catch(o){throw new Error(o.message)}return"data:image/svg+xml;base64,".concat(btoa(i))}return aE(s,e)}function aE(s,e){if(qb(e))throw new Error("SVG cannot be parsed directly to imagebitmap");return new Blob([new Uint8Array(s)])}async function Gf(s,e,t){let i=uT(s,t),n=self.URL||self.webkitURL,o=typeof i!="string"&&n.createObjectURL(i);try{return await yD(o||i,e)}finally{o&&n.revokeObjectURL(o)}}async function yD(s,e){let t=new Image;return t.src=s,e.image&&e.image.decode&&t.decode?(await t.decode(),t):await new Promise((i,n)=>{try{t.onload=()=>i(t),t.onerror=o=>n(new Error("Could not load image ".concat(s,": ").concat(o)))}catch(o){n(o)}})}var SD={},cT=!0;async function lE(s,e,t){let i;qb(t)?i=await Gf(s,e,t):i=aE(s,t);let n=e&&e.imagebitmap;return await ED(i,n)}async function ED(s,e=null){if((xD(e)||!cT)&&(e=null),e)try{return await createImageBitmap(s,e)}catch(t){console.warn(t),cT=!1}return await createImageBitmap(s)}function xD(s){for(let e in s||SD)return!1;return!0}function Xb(s){let e=Ff(s);return vD(e)||TD(e)||CD(e)||AD(e)}function vD(s){let e=Ff(s);return e.byteLength>=24&&e.getUint32(0,!1)===2303741511?{mimeType:"image/png",width:e.getUint32(16,!1),height:e.getUint32(20,!1)}:null}function CD(s){let e=Ff(s);return e.byteLength>=10&&e.getUint32(0,!1)===1195984440?{mimeType:"image/gif",width:e.getUint16(6,!0),height:e.getUint16(8,!0)}:null}function AD(s){let e=Ff(s);return e.byteLength>=14&&e.getUint16(0,!1)===16973&&e.getUint32(2,!0)===e.byteLength?{mimeType:"image/bmp",width:e.getUint32(18,!0),height:e.getUint32(22,!0)}:null}function TD(s){let e=Ff(s);if(!(e.byteLength>=3&&e.getUint16(0,!1)===65496&&e.getUint8(2)===255))return null;let{tableMarkers:i,sofMarkers:n}=ID(),o=2;for(;o+9<e.byteLength;){let a=e.getUint16(o,!1);if(n.has(a))return{mimeType:"image/jpeg",height:e.getUint16(o+5,!1),width:e.getUint16(o+7,!1)};if(!i.has(a))return null;o+=2,o+=e.getUint16(o,!1)}return null}function ID(){let s=new Set([65499,65476,65484,65501,65534]);for(let t=65504;t<65520;++t)s.add(t);return{tableMarkers:s,sofMarkers:new Set([65472,65473,65474,65475,65477,65478,65479,65481,65482,65483,65485,65486,65487,65502])}}function Ff(s){if(s instanceof DataView)return s;if(ArrayBuffer.isView(s))return new DataView(s.buffer);if(s instanceof ArrayBuffer)return new DataView(s);throw new Error("toDataView")}async function uE(s,e){let{mimeType:t}=Xb(s)||{},i=globalThis._parseImageNode;return Ja(i),await i(s,t)}async function cE(s,e,t){e=e||{};let n=(e.image||{}).type||"auto",{url:o}=t||{},a=wD(n),l;switch(a){case"imagebitmap":l=await lE(s,e,o);break;case"image":l=await Gf(s,e,o);break;case"data":l=await uE(s,e);break;default:Ja(!1)}return n==="data"&&(l=lT(l)),l}function wD(s){switch(s){case"auto":case"data":return aT();default:return sT(s),s}}var LD=["png","jpg","jpeg","gif","webp","bmp","ico","svg"],RD=["image/png","image/jpeg","image/gif","image/webp","image/bmp","image/vnd.microsoft.icon","image/svg+xml"],OD={image:{type:"auto",decode:!0}},xu={id:"image",module:"images",name:"Images",version:oT,mimeTypes:RD,extensions:LD,parse:cE,tests:[s=>Boolean(Xb(new DataView(s)))],options:OD};var fe=new ii({id:"deck"});var hE={};function hT(s){hE=s}function Gt(s,e,t,i){fe.level>0&&hE[s]&&hE[s].call(null,e,t,i)}function _D(s){let e=s[0],t=s[s.length-1];return e==="{"&&t==="}"||e==="["&&t==="]"}var dT={id:"JSON",name:"JSON",module:"",version:"",options:{},extensions:["json","geojson"],mimeTypes:["application/json","application/geo+json"],testText:_D,parseTextSync:JSON.parse};var kf="8.8.20",Yb=globalThis.deck&&globalThis.deck.VERSION;if(Yb&&Yb!==kf)throw new Error("deck.gl - multiple versions detected: ".concat(Yb," vs ").concat(kf));Yb||(fe.log(1,"deck.gl ".concat(kf))(),globalThis.deck={...globalThis.deck,VERSION:kf,version:kf,log:fe,_registerLoggers:hT},eE([dT,[xu,{imagebitmap:{premultiplyAlpha:"none"}}]]));var fT=globalThis.deck;var se=new ii({id:"luma.gl"});function Wt(s,e){if(!s)throw new Error(e||"luma.gl: assertion failed.")}var ND="Invalid WebGLRenderingContext";var MD="Requires WebGL2";function ks(s){return typeof WebGLRenderingContext<"u"&&s instanceof WebGLRenderingContext||typeof WebGL2RenderingContext<"u"&&s instanceof WebGL2RenderingContext?!0:Boolean(s&&Number.isFinite(s._version))}function ge(s){return typeof WebGL2RenderingContext<"u"&&s instanceof WebGL2RenderingContext?!0:Boolean(s&&s._version===2)}function dE(s){return ge(s)?s:null}function Vs(s){return Wt(ks(s),ND),s}function Pt(s){return Wt(ge(s),MD),s}var Vf={};function BD(s){globalThis.console&&globalThis.console.error&&globalThis.console.error(s)}function DD(s){globalThis.console&&globalThis.console.log&&globalThis.console.log(s)}function GD(s,e){Vf[s]=!0,e!==void 0&&BD(e)}function FD(s){let e=s.getError;s.getError=function(){let i;do i=e.apply(s),i!==0&&(Vf[i]=!0);while(i!==0);for(i in Vf)if(Vf[i])return delete Vf[i],parseInt(i,10);return 0}}var Uf=function s(e){let t=e.gl;this.ext=e,this.isAlive=!0,this.hasBeenBound=!1,this.elementArrayBuffer=null,this.attribs=new Array(e.maxVertexAttribs);for(let i=0;i<this.attribs.length;i++){let n=new s.VertexAttrib(t);this.attribs[i]=n}this.maxAttrib=0};Uf.VertexAttrib=function(e){this.enabled=!1,this.buffer=null,this.size=4,this.type=5126,this.normalized=!1,this.stride=16,this.offset=0,this.cached="",this.recache()};Uf.VertexAttrib.prototype.recache=function(){this.cached=[this.size,this.type,this.normalized,this.stride,this.offset].join(":")};var vu=function(e){let t=this;this.gl=e,FD(e);let i=this.original={getParameter:e.getParameter,enableVertexAttribArray:e.enableVertexAttribArray,disableVertexAttribArray:e.disableVertexAttribArray,bindBuffer:e.bindBuffer,getVertexAttrib:e.getVertexAttrib,vertexAttribPointer:e.vertexAttribPointer};e.getParameter=function(o){return o===t.VERTEX_ARRAY_BINDING_OES?t.currentVertexArrayObject===t.defaultVertexArrayObject?null:t.currentVertexArrayObject:i.getParameter.apply(this,arguments)},e.enableVertexAttribArray=function(o){let a=t.currentVertexArrayObject;a.maxAttrib=Math.max(a.maxAttrib,o);let l=a.attribs[o];return l.enabled=!0,i.enableVertexAttribArray.apply(this,arguments)},e.disableVertexAttribArray=function(o){let a=t.currentVertexArrayObject;a.maxAttrib=Math.max(a.maxAttrib,o);let l=a.attribs[o];return l.enabled=!1,i.disableVertexAttribArray.apply(this,arguments)},e.bindBuffer=function(o,a){switch(o){case 34962:t.currentArrayBuffer=a;break;case 34963:t.currentVertexArrayObject.elementArrayBuffer=a;break;default:}return i.bindBuffer.apply(this,arguments)},e.getVertexAttrib=function(o,a){let u=t.currentVertexArrayObject.attribs[o];switch(a){case 34975:return u.buffer;case 34338:return u.enabled;case 34339:return u.size;case 34340:return u.stride;case 34341:return u.type;case 34922:return u.normalized;default:return i.getVertexAttrib.apply(this,arguments)}},e.vertexAttribPointer=function(o,a,l,u,c,h){let d=t.currentVertexArrayObject;d.maxAttrib=Math.max(d.maxAttrib,o);let f=d.attribs[o];return f.buffer=t.currentArrayBuffer,f.size=a,f.type=l,f.normalized=u,f.stride=c,f.offset=h,f.recache(),i.vertexAttribPointer.apply(this,arguments)},e.instrumentExtension&&e.instrumentExtension(this,"OES_vertex_array_object"),e.canvas&&e.canvas.addEventListener("webglcontextrestored",()=>{DD("OESVertexArrayObject emulation library context restored"),t.reset_()},!0),this.reset_()};vu.prototype.VERTEX_ARRAY_BINDING_OES=34229;vu.prototype.reset_=function(){if(this.vertexArrayObjects!==void 0)for(let i=0;i<this.vertexArrayObjects.length;++i)this.vertexArrayObjects.isAlive=!1;let t=this.gl;this.maxVertexAttribs=t.getParameter(34921),this.defaultVertexArrayObject=new Uf(this),this.currentVertexArrayObject=null,this.currentArrayBuffer=null,this.vertexArrayObjects=[this.defaultVertexArrayObject],this.bindVertexArrayOES(null)};vu.prototype.createVertexArrayOES=function(){let e=new Uf(this);return this.vertexArrayObjects.push(e),e};vu.prototype.deleteVertexArrayOES=function(e){e.isAlive=!1,this.vertexArrayObjects.splice(this.vertexArrayObjects.indexOf(e),1),this.currentVertexArrayObject===e&&this.bindVertexArrayOES(null)};vu.prototype.isVertexArrayOES=function(e){return!!(e&&e instanceof Uf&&e.hasBeenBound&&e.ext===this)};vu.prototype.bindVertexArrayOES=function(e){let t=this.gl;if(e&&!e.isAlive){GD(1282,"bindVertexArrayOES: attempt to bind deleted arrayObject");return}let i=this.original,n=this.currentVertexArrayObject;this.currentVertexArrayObject=e||this.defaultVertexArrayObject,this.currentVertexArrayObject.hasBeenBound=!0;let o=this.currentVertexArrayObject;if(n===o)return;(!n||o.elementArrayBuffer!==n.elementArrayBuffer)&&i.bindBuffer.call(t,34963,o.elementArrayBuffer);let a=this.currentArrayBuffer,l=Math.max(n?n.maxAttrib:0,o.maxAttrib);for(let u=0;u<=l;u++){let c=o.attribs[u],h=n?n.attribs[u]:null;if((!n||c.enabled!==h.enabled)&&(c.enabled?i.enableVertexAttribArray.call(t,u):i.disableVertexAttribArray.call(t,u)),c.enabled){let d=!1;(!n||c.buffer!==h.buffer)&&(a!==c.buffer&&(i.bindBuffer.call(t,34962,c.buffer),a=c.buffer),d=!0),(d||c.cached!==h.cached)&&i.vertexAttribPointer.call(t,u,c.size,c.type,c.normalized,c.stride,c.offset)}}this.currentArrayBuffer!==a&&i.bindBuffer.call(t,34962,this.currentArrayBuffer)};function gT(s){if(typeof s.createVertexArray=="function")return;let e=s.getSupportedExtensions;s.getSupportedExtensions=function(){let n=e.call(this)||[];return n.indexOf("OES_vertex_array_object")<0&&n.push("OES_vertex_array_object"),n};let t=s.getExtension;s.getExtension=function(n){let o=t.call(this,n);return o||(n!=="OES_vertex_array_object"?null:(s.__OESVertexArrayObject||(this.__OESVertexArrayObject=new vu(this)),this.__OESVertexArrayObject))}}var pT="OES_element_index",mT="WEBGL_draw_buffers",kD="EXT_disjoint_timer_query",VD="EXT_disjoint_timer_query_webgl2",UD="EXT_texture_filter_anisotropic",bT="WEBGL_debug_renderer_info",zD=35723,WD=4352,HD=36795,jD=34047,qD=37445,XD=37446,gt=s=>ge(s)?void 0:0,YD={[3074]:s=>ge(s)?void 0:36064,[zD]:s=>ge(s)?void 0:WD,[35977]:gt,[32937]:gt,[HD]:(s,e)=>{let t=ge(s)?s.getExtension(VD):s.getExtension(kD);return t&&t.GPU_DISJOINT_EXT?e(t.GPU_DISJOINT_EXT):0},[qD]:(s,e)=>{let t=s.getExtension(bT);return e(t&&t.UNMASKED_VENDOR_WEBGL||7936)},[XD]:(s,e)=>{let t=s.getExtension(bT);return e(t&&t.UNMASKED_RENDERER_WEBGL||7937)},[jD]:(s,e)=>{let t=s.luma.extensions[UD];return t?e(t.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1},[32883]:gt,[35071]:gt,[37447]:gt,[36063]:(s,e)=>{if(!ge(s)){let t=s.getExtension(mT);return t?e(t.MAX_COLOR_ATTACHMENTS_WEBGL):0}},[35379]:gt,[35374]:gt,[35377]:gt,[34852]:s=>{if(!ge(s)){let e=s.getExtension(mT);return e?e.MAX_DRAW_BUFFERS_WEBGL:0}},[36203]:s=>s.getExtension(pT)?2147483647:65535,[33001]:s=>s.getExtension(pT)?16777216:65535,[33e3]:s=>16777216,[37157]:gt,[35373]:gt,[35657]:gt,[36183]:gt,[37137]:gt,[34045]:gt,[35978]:gt,[35979]:gt,[35968]:gt,[35376]:gt,[35375]:gt,[35659]:gt,[37154]:gt,[35371]:gt,[35658]:gt,[35076]:gt,[35077]:gt,[35380]:gt};function PT(s,e,t){let i=YD[t],n=typeof i=="function"?i(s,e,t):i;return n!==void 0?n:e(t)}var KD="OES_vertex_array_object",yT="ANGLE_instanced_arrays",ZD="WEBGL_draw_buffers",QD="EXT_disjoint_timer_query",JD="EXT_texture_filter_anisotropic",$D="VertexArray requires WebGL2 or OES_vertex_array_object extension";function eG(s,e){return{webgl2:ge(s),ext:s.getExtension(e)}}var fE={[KD]:{meta:{suffix:"OES"},createVertexArray:()=>{Wt(!1,$D)},deleteVertexArray:()=>{},bindVertexArray:()=>{},isVertexArray:()=>!1},[yT]:{meta:{suffix:"ANGLE"},vertexAttribDivisor(s,e){Wt(e===0,"WebGL instanced rendering not supported")},drawElementsInstanced:()=>{},drawArraysInstanced:()=>{}},[ZD]:{meta:{suffix:"WEBGL"},drawBuffers:()=>{Wt(!1)}},[QD]:{meta:{suffix:"EXT"},createQuery:()=>{Wt(!1)},deleteQuery:()=>{Wt(!1)},beginQuery:()=>{Wt(!1)},endQuery:()=>{},getQuery(s,e){return this.getQueryObject(s,e)},getQueryParameter(s,e){return this.getQueryObject(s,e)},getQueryObject:()=>{}}},Kb={readBuffer:(s,e,t)=>{ge(s)&&e(t)},getVertexAttrib:(s,e,t,i)=>{let{webgl2:n,ext:o}=eG(s,yT),a;switch(i){case 35069:a=n?void 0:!1;break;case 35070:a=!n&&!o?0:void 0;break;default:}return a!==void 0?a:e(t,i)},getProgramParameter:(s,e,t,i)=>{if(!ge(s))switch(i){case 35967:return 35981;case 35971:return 0;case 35382:return 0;default:}return e(t,i)},getInternalformatParameter:(s,e,t,i,n)=>{if(!ge(s))switch(n){case 32937:return new Int32Array([0]);default:}return s.getInternalformatParameter(t,i,n)},getTexParameter(s,e,t,i){switch(i){case 34046:let{extensions:n}=s.luma,o=n[JD];i=o&&o.TEXTURE_MAX_ANISOTROPY_EXT||34046;break;default:}return e(t,i)},getParameter:PT,hint(s,e,t,i){return e(t,i)}};function ST(s){s.luma=s.luma||{};let{luma:e}=s;return e.polyfilled||(gT(s),tG(s),iG(s,fE),rG(s,{target:e,target2:s}),e.polyfilled=!0),s}globalThis.polyfillContext=ST;function tG(s){s.luma.extensions={};let e=s.getSupportedExtensions()||[];for(let t of e)s.luma[t]=s.getExtension(t)}function rG(s,e){let{target:t,target2:i}=e;Object.keys(Kb).forEach(n=>{if(typeof Kb[n]=="function"){let o=s[n]?s[n].bind(s):()=>{},a=Kb[n].bind(null,s,o);t[n]=a,i[n]=a}})}function iG(s,e){for(let t of Object.getOwnPropertyNames(e))t!=="overrides"&&nG(s,{extension:t,target:s.luma,target2:s})}function nG(s,e){let{extension:t,target:i,target2:n}=e,o=fE[t];Wt(o);let{meta:a={}}=o,{suffix:l=""}=a,u=s.getExtension(t);for(let c of Object.keys(o)){let h="".concat(c).concat(l),d=null;c==="meta"||typeof s[c]=="function"||(u&&typeof u[h]=="function"?d=function(){return u[h](...arguments)}:typeof o[c]=="function"&&(d=o[c].bind(i))),d&&(i[c]=d,n[c]=d)}}var Wf={[3042]:!1,[32773]:new Float32Array([0,0,0,0]),[32777]:32774,[34877]:32774,[32969]:1,[32968]:0,[32971]:1,[32970]:0,[3106]:new Float32Array([0,0,0,0]),[3107]:[!0,!0,!0,!0],[2884]:!1,[2885]:1029,[2929]:!1,[2931]:1,[2932]:513,[2928]:new Float32Array([0,1]),[2930]:!0,[3024]:!0,[36006]:null,[2886]:2305,[33170]:4352,[2849]:1,[32823]:!1,[32824]:0,[10752]:0,[32938]:1,[32939]:!1,[3089]:!1,[3088]:new Int32Array([0,0,1024,1024]),[2960]:!1,[2961]:0,[2968]:4294967295,[36005]:4294967295,[2962]:519,[2967]:0,[2963]:4294967295,[34816]:519,[36003]:0,[36004]:4294967295,[2964]:7680,[2965]:7680,[2966]:7680,[34817]:7680,[34818]:7680,[34819]:7680,[2978]:[0,0,1024,1024],[3333]:4,[3317]:4,[37440]:!1,[37441]:!1,[37443]:37444,[35723]:4352,[36010]:null,[35977]:!1,[3330]:0,[3332]:0,[3331]:0,[3314]:0,[32878]:0,[3316]:0,[3315]:0,[32877]:0},rl=(s,e,t)=>e?s.enable(t):s.disable(t),ET=(s,e,t)=>s.hint(t,e),tn=(s,e,t)=>s.pixelStorei(t,e),oG=(s,e)=>{let t=ge(s)?36009:36160;return s.bindFramebuffer(t,e)},sG=(s,e)=>s.bindFramebuffer(36008,e);function zf(s){return Array.isArray(s)||ArrayBuffer.isView(s)}var xT={[3042]:rl,[32773]:(s,e)=>s.blendColor(...e),[32777]:"blendEquation",[34877]:"blendEquation",[32969]:"blendFunc",[32968]:"blendFunc",[32971]:"blendFunc",[32970]:"blendFunc",[3106]:(s,e)=>s.clearColor(...e),[3107]:(s,e)=>s.colorMask(...e),[2884]:rl,[2885]:(s,e)=>s.cullFace(e),[2929]:rl,[2931]:(s,e)=>s.clearDepth(e),[2932]:(s,e)=>s.depthFunc(e),[2928]:(s,e)=>s.depthRange(...e),[2930]:(s,e)=>s.depthMask(e),[3024]:rl,[35723]:ET,[36006]:oG,[2886]:(s,e)=>s.frontFace(e),[33170]:ET,[2849]:(s,e)=>s.lineWidth(e),[32823]:rl,[32824]:"polygonOffset",[10752]:"polygonOffset",[35977]:rl,[32938]:"sampleCoverage",[32939]:"sampleCoverage",[3089]:rl,[3088]:(s,e)=>s.scissor(...e),[2960]:rl,[2961]:(s,e)=>s.clearStencil(e),[2968]:(s,e)=>s.stencilMaskSeparate(1028,e),[36005]:(s,e)=>s.stencilMaskSeparate(1029,e),[2962]:"stencilFuncFront",[2967]:"stencilFuncFront",[2963]:"stencilFuncFront",[34816]:"stencilFuncBack",[36003]:"stencilFuncBack",[36004]:"stencilFuncBack",[2964]:"stencilOpFront",[2965]:"stencilOpFront",[2966]:"stencilOpFront",[34817]:"stencilOpBack",[34818]:"stencilOpBack",[34819]:"stencilOpBack",[2978]:(s,e)=>s.viewport(...e),[3333]:tn,[3317]:tn,[37440]:tn,[37441]:tn,[37443]:tn,[3330]:tn,[3332]:tn,[3331]:tn,[36010]:sG,[3314]:tn,[32878]:tn,[3316]:tn,[3315]:tn,[32877]:tn,framebuffer:(s,e)=>{let t=e&&"handle"in e?e.handle:e;return s.bindFramebuffer(36160,t)},blend:(s,e)=>e?s.enable(3042):s.disable(3042),blendColor:(s,e)=>s.blendColor(...e),blendEquation:(s,e)=>{e=zf(e)?e:[e,e],s.blendEquationSeparate(...e)},blendFunc:(s,e)=>{e=zf(e)&&e.length===2?[...e,...e]:e,s.blendFuncSeparate(...e)},clearColor:(s,e)=>s.clearColor(...e),clearDepth:(s,e)=>s.clearDepth(e),clearStencil:(s,e)=>s.clearStencil(e),colorMask:(s,e)=>s.colorMask(...e),cull:(s,e)=>e?s.enable(2884):s.disable(2884),cullFace:(s,e)=>s.cullFace(e),depthTest:(s,e)=>e?s.enable(2929):s.disable(2929),depthFunc:(s,e)=>s.depthFunc(e),depthMask:(s,e)=>s.depthMask(e),depthRange:(s,e)=>s.depthRange(...e),dither:(s,e)=>e?s.enable(3024):s.disable(3024),derivativeHint:(s,e)=>{s.hint(35723,e)},frontFace:(s,e)=>s.frontFace(e),mipmapHint:(s,e)=>s.hint(33170,e),lineWidth:(s,e)=>s.lineWidth(e),polygonOffsetFill:(s,e)=>e?s.enable(32823):s.disable(32823),polygonOffset:(s,e)=>s.polygonOffset(...e),sampleCoverage:(s,e)=>s.sampleCoverage(...e),scissorTest:(s,e)=>e?s.enable(3089):s.disable(3089),scissor:(s,e)=>s.scissor(...e),stencilTest:(s,e)=>e?s.enable(2960):s.disable(2960),stencilMask:(s,e)=>{e=zf(e)?e:[e,e];let[t,i]=e;s.stencilMaskSeparate(1028,t),s.stencilMaskSeparate(1029,i)},stencilFunc:(s,e)=>{e=zf(e)&&e.length===3?[...e,...e]:e;let[t,i,n,o,a,l]=e;s.stencilFuncSeparate(1028,t,i,n),s.stencilFuncSeparate(1029,o,a,l)},stencilOp:(s,e)=>{e=zf(e)&&e.length===3?[...e,...e]:e;let[t,i,n,o,a,l]=e;s.stencilOpSeparate(1028,t,i,n),s.stencilOpSeparate(1029,o,a,l)},viewport:(s,e)=>s.viewport(...e)};function Ft(s,e,t){return e[s]!==void 0?e[s]:t[s]}var vT={blendEquation:(s,e,t)=>s.blendEquationSeparate(Ft(32777,e,t),Ft(34877,e,t)),blendFunc:(s,e,t)=>s.blendFuncSeparate(Ft(32969,e,t),Ft(32968,e,t),Ft(32971,e,t),Ft(32970,e,t)),polygonOffset:(s,e,t)=>s.polygonOffset(Ft(32824,e,t),Ft(10752,e,t)),sampleCoverage:(s,e,t)=>s.sampleCoverage(Ft(32938,e,t),Ft(32939,e,t)),stencilFuncFront:(s,e,t)=>s.stencilFuncSeparate(1028,Ft(2962,e,t),Ft(2967,e,t),Ft(2963,e,t)),stencilFuncBack:(s,e,t)=>s.stencilFuncSeparate(1029,Ft(34816,e,t),Ft(36003,e,t),Ft(36004,e,t)),stencilOpFront:(s,e,t)=>s.stencilOpSeparate(1028,Ft(2964,e,t),Ft(2965,e,t),Ft(2966,e,t)),stencilOpBack:(s,e,t)=>s.stencilOpSeparate(1029,Ft(34817,e,t),Ft(34818,e,t),Ft(34819,e,t))},gE={enable:(s,e)=>s({[e]:!0}),disable:(s,e)=>s({[e]:!1}),pixelStorei:(s,e,t)=>s({[e]:t}),hint:(s,e,t)=>s({[e]:t}),bindFramebuffer:(s,e,t)=>{switch(e){case 36160:return s({[36006]:t,[36010]:t});case 36009:return s({[36006]:t});case 36008:return s({[36010]:t});default:return null}},blendColor:(s,e,t,i,n)=>s({[32773]:new Float32Array([e,t,i,n])}),blendEquation:(s,e)=>s({[32777]:e,[34877]:e}),blendEquationSeparate:(s,e,t)=>s({[32777]:e,[34877]:t}),blendFunc:(s,e,t)=>s({[32969]:e,[32968]:t,[32971]:e,[32970]:t}),blendFuncSeparate:(s,e,t,i,n)=>s({[32969]:e,[32968]:t,[32971]:i,[32970]:n}),clearColor:(s,e,t,i,n)=>s({[3106]:new Float32Array([e,t,i,n])}),clearDepth:(s,e)=>s({[2931]:e}),clearStencil:(s,e)=>s({[2961]:e}),colorMask:(s,e,t,i,n)=>s({[3107]:[e,t,i,n]}),cullFace:(s,e)=>s({[2885]:e}),depthFunc:(s,e)=>s({[2932]:e}),depthRange:(s,e,t)=>s({[2928]:new Float32Array([e,t])}),depthMask:(s,e)=>s({[2930]:e}),frontFace:(s,e)=>s({[2886]:e}),lineWidth:(s,e)=>s({[2849]:e}),polygonOffset:(s,e,t)=>s({[32824]:e,[10752]:t}),sampleCoverage:(s,e,t)=>s({[32938]:e,[32939]:t}),scissor:(s,e,t,i,n)=>s({[3088]:new Int32Array([e,t,i,n])}),stencilMask:(s,e)=>s({[2968]:e,[36005]:e}),stencilMaskSeparate:(s,e,t)=>s({[e===1028?2968:36005]:t}),stencilFunc:(s,e,t,i)=>s({[2962]:e,[2967]:t,[2963]:i,[34816]:e,[36003]:t,[36004]:i}),stencilFuncSeparate:(s,e,t,i,n)=>s({[e===1028?2962:34816]:t,[e===1028?2967:36003]:i,[e===1028?2963:36004]:n}),stencilOp:(s,e,t,i)=>s({[2964]:e,[2965]:t,[2966]:i,[34817]:e,[34818]:t,[34819]:i}),stencilOpSeparate:(s,e,t,i,n)=>s({[e===1028?2964:34817]:t,[e===1028?2965:34818]:i,[e===1028?2966:34819]:n}),viewport:(s,e,t,i,n)=>s({[2978]:[e,t,i,n]})},es=(s,e)=>s.isEnabled(e),pE={[3042]:es,[2884]:es,[2929]:es,[3024]:es,[32823]:es,[32926]:es,[32928]:es,[3089]:es,[2960]:es,[35977]:es};function mE(s){for(let e in s)return!1;return!0}function CT(s,e){if(s===e)return!0;let t=Array.isArray(s)||ArrayBuffer.isView(s),i=Array.isArray(e)||ArrayBuffer.isView(e);if(t&&i&&s.length===e.length){for(let n=0;n<s.length;++n)if(s[n]!==e[n])return!1;return!0}return!1}function AT(s,e){let t=s[e].bind(s);s[e]=function(){let n=arguments.length<=0?void 0:arguments[0];return n in s.state.cache?s.state.enable?s.state.cache[n]:t(...arguments):t(...arguments)},Object.defineProperty(s[e],"name",{value:"".concat(e,"-from-cache"),configurable:!1})}function aG(s,e,t){let i=s[e].bind(s);s[e]=function(){for(var o=arguments.length,a=new Array(o),l=0;l<o;l++)a[l]=arguments[l];let{valueChanged:u,oldValue:c}=t(s.state._updateCache,...a);return u&&i(...a),c},Object.defineProperty(s[e],"name",{value:"".concat(e,"-to-cache"),configurable:!1})}function lG(s){let e=s.useProgram.bind(s);s.useProgram=function(i){s.state.program!==i&&(e(i),s.state.program=i)}}var bE=class{constructor(e){let{copyState:t=!1,log:i=()=>{}}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};this.gl=e,this.program=null,this.stateStack=[],this.enable=!0,this.cache=t?Jb(e):Object.assign({},Wf),this.log=i,this._updateCache=this._updateCache.bind(this),Object.seal(this)}push(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this.stateStack.push({})}pop(){Wt(this.stateStack.length>0);let e=this.stateStack[this.stateStack.length-1];yi(this.gl,e),this.stateStack.pop()}_updateCache(e){let t=!1,i,n=this.stateStack.length>0&&this.stateStack[this.stateStack.length-1];for(let o in e){Wt(o!==void 0);let a=e[o],l=this.cache[o];CT(a,l)||(t=!0,i=l,n&&!(o in n)&&(n[o]=l),this.cache[o]=a)}return{valueChanged:t,oldValue:i}}};function Zb(s){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},{enable:t=!0,copyState:i}=e;if(Wt(i!==void 0),!s.state){let{polyfillContext:n}=globalThis;n&&n(s),s.state=new bE(s,{copyState:i}),lG(s);for(let o in gE){let a=gE[o];aG(s,o,a)}AT(s,"getParameter"),AT(s,"isEnabled")}return s.state.enable=t,s}function PE(s){s.state||Zb(s,{copyState:!1}),s.state.push()}function Qb(s){Wt(s.state),s.state.pop()}function yi(s,e){if(Wt(ks(s),"setParameters requires a WebGL context"),mE(e))return;let t={};for(let n in e){let o=Number(n),a=xT[n];a&&(typeof a=="string"?t[a]=!0:a(s,e[n],o))}let i=s.state&&s.state.cache;if(i)for(let n in t){let o=vT[n];o(s,e,i)}}function Jb(s,e){if(e=e||Wf,typeof e=="number"){let n=e,o=pE[n];return o?o(s,n):s.getParameter(n)}let t=Array.isArray(e)?e:Object.keys(e),i={};for(let n of t){let o=pE[n];i[n]=o?o(s,Number(n)):s.getParameter(Number(n))}return i}function $b(s){yi(s,Wf)}function pt(s,e,t){if(mE(e))return t(s);let{nocatch:i=!0}=e;PE(s),yi(s,e);let n;if(i)n=t(s),Qb(s);else try{n=t(s)}finally{Qb(s)}return n}function io(s){let{luma:e}=s;if(s.canvas&&e){let{clientWidth:t}=e.canvasSizeInfo;return t?s.drawingBufferWidth/t:1}return 1}function Ph(s,e){let t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0,i=io(s),n=s.drawingBufferWidth,o=s.drawingBufferHeight;return uG(e,i,n,o,t)}function wT(s){let e=typeof window>"u"?1:window.devicePixelRatio||1;return Number.isFinite(s)?s<=0?1:s:s?e:1}function uG(s,e,t,i,n){let o=TT(s[0],e,t),a=IT(s[1],e,i,n),l=TT(s[0]+1,e,t),u=l===t-1?l:l-1;l=IT(s[1]+1,e,i,n);let c;return n?(l=l===0?l:l+1,c=a,a=l):c=l===i-1?l:l-1,{x:o,y:a,width:Math.max(u-o+1,1),height:Math.max(c-a+1,1)}}function TT(s,e,t){return Math.min(Math.round(s*e),t-1)}function IT(s,e,t,i){return i?Math.max(0,t-1-Math.round(s*e)):Math.min(Math.round(s*e),t-1)}var yE=dr(),cG=yE&&typeof document<"u",LT={webgl2:!0,webgl1:!0,throwOnError:!0,manageState:!0,canvas:null,debug:!1,width:800,height:600};function yh(){let s=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};Wt(yE,`createGLContext only available in the browser.
Create your own headless context or use 'createHeadlessContext' from @luma.gl/test-utils`),s=Object.assign({},LT,s);let{width:e,height:t}=s;function i(l){if(s.throwOnError)throw new Error(l);return console.error(l),null}s.onError=i;let n,{canvas:o}=s,a=dG({canvas:o,width:e,height:t,onError:i});return n=hG(a,s),n?(n=Cu(n,s),fG(n),n):null}function Cu(s){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!s||s._instrumented)return s;s._version=s._version||gG(s),s.luma=s.luma||{},s.luma.canvasSizeInfo=s.luma.canvasSizeInfo||{},e=Object.assign({},LT,e);let{manageState:t,debug:i}=e;return t&&Zb(s,{copyState:!1,log:function(){for(var n=arguments.length,o=new Array(n),a=0;a<n;a++)o[a]=arguments[a];return se.log(1,...o)()}}),yE&&i&&(globalThis.makeDebugContext?(s=globalThis.makeDebugContext(s,e),se.level=Math.max(se.level,1)):se.warn('WebGL debug mode not activated. import "@luma.gl/debug" to enable.')()),s._instrumented=!0,s}function RT(s){let e=s.getParameter(7936),t=s.getParameter(7937),i=s.getExtension("WEBGL_debug_renderer_info"),n=i&&s.getParameter(i.UNMASKED_VENDOR_WEBGL||7936),o=i&&s.getParameter(i.UNMASKED_RENDERER_WEBGL||7937);return{vendor:n||e,renderer:o||t,vendorMasked:e,rendererMasked:t,version:s.getParameter(7938),shadingLanguageVersion:s.getParameter(35724)}}function SE(s){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(s.canvas){let i=wT(e.useDevicePixels);pG(s,i,e);return}let t=s.getExtension("STACKGL_resize_drawingbuffer");t&&"width"in e&&"height"in e&&t.resize(e.width,e.height)}function hG(s,e){let{onError:t}=e,i=null,n=u=>i=u.statusMessage||i;s.addEventListener("webglcontextcreationerror",n,!1);let{webgl1:o=!0,webgl2:a=!0}=e,l=null;return a&&(l=l||s.getContext("webgl2",e),l=l||s.getContext("experimental-webgl2",e)),o&&(l=l||s.getContext("webgl",e),l=l||s.getContext("experimental-webgl",e)),s.removeEventListener("webglcontextcreationerror",n,!1),l?(e.onContextLost&&s.addEventListener("webglcontextlost",e.onContextLost,!1),e.onContextRestored&&s.addEventListener("webglcontextrestored",e.onContextRestored,!1),l):t("Failed to create ".concat(a&&!o?"WebGL2":"WebGL"," context: ").concat(i||"Unknown error"))}function dG(s){let{canvas:e,width:t=800,height:i=600,onError:n}=s,o;return typeof e=="string"?(cG&&document.readyState==="complete"||n("createGLContext called on canvas '".concat(e,"' before page was loaded")),o=document.getElementById(e)):e?o=e:(o=document.createElement("canvas"),o.id="lumagl-canvas",o.style.width=Number.isFinite(t)?"".concat(t,"px"):"100%",o.style.height=Number.isFinite(i)?"".concat(i,"px"):"100%",document.body.insertBefore(o,document.body.firstChild)),o}function fG(s){let e=ge(s)?"WebGL2":"WebGL1",t=RT(s),i=t?"(".concat(t.vendor,",").concat(t.renderer,")"):"",n=s.debug?" debug":"";se.info(1,"".concat(e).concat(n," context ").concat(i))()}function gG(s){return typeof WebGL2RenderingContext<"u"&&s instanceof WebGL2RenderingContext?2:1}function pG(s,e,t){let i="width"in t?t.width:s.canvas.clientWidth,n="height"in t?t.height:s.canvas.clientHeight;(!i||!n)&&(se.log(1,"Canvas clientWidth/clientHeight is 0")(),e=1,i=s.canvas.width||1,n=s.canvas.height||1),s.luma=s.luma||{},s.luma.canvasSizeInfo=s.luma.canvasSizeInfo||{};let o=s.luma.canvasSizeInfo;if(o.clientWidth!==i||o.clientHeight!==n||o.devicePixelRatio!==e){let a=e,l=Math.floor(i*a),u=Math.floor(n*a);s.canvas.width=l,s.canvas.height=u,(s.drawingBufferWidth!==l||s.drawingBufferHeight!==u)&&(se.warn("Device pixel ratio clamped")(),a=Math.min(s.drawingBufferWidth/i,s.drawingBufferHeight/n),s.canvas.width=Math.floor(i*a),s.canvas.height=Math.floor(n*a)),Object.assign(s.luma.canvasSizeInfo,{clientWidth:i,clientHeight:n,devicePixelRatio:e})}}var Hf="8.5.16",mG="set luma.log.level=1 (or higher) to trace rendering",jf=class{constructor(){this.stats=new Map}get(e){return this.stats.has(e)||this.stats.set(e,new en({id:e})),this.stats.get(e)}},On=new jf;if(globalThis.luma&&globalThis.luma.VERSION!==Hf)throw new Error("luma.gl - multiple VERSIONs detected: ".concat(globalThis.luma.VERSION," vs ").concat(Hf));globalThis.luma||(dr()&&se.log(1,"luma.gl ".concat(Hf," - ").concat(mG))(),globalThis.luma=globalThis.luma||{VERSION:Hf,version:Hf,log:se,stats:On,globals:{modules:{},nodeIO:{}}});var Sxe=globalThis.luma;function EE(s){return typeof window<"u"&&window.requestAnimationFrame?window.requestAnimationFrame(s):setTimeout(s,1e3/60)}function xE(s){return typeof window<"u"&&window.cancelAnimationFrame?window.cancelAnimationFrame(s):clearTimeout(s)}function J(s,e){if(!s)throw new Error(e||"luma.gl: assertion failed.")}function eP(s,e){if(typeof e!="string")return e;let t=Number(e);if(!isNaN(t))return t;e=e.replace(/^.*\./,"");let i=s[e];return J(i!==void 0,"Accessing undefined constant GL.".concat(e)),i}function _n(s,e){e=Number(e);for(let t in s)if(s[t]===e)return"GL.".concat(t);return String(e)}var vE={};function Si(){let s=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"id";vE[s]=vE[s]||1;let e=vE[s]++;return"".concat(s,"-").concat(e)}function CE(s){return J(typeof s=="number","Input must be a number"),s&&(s&s-1)===0}function ts(s){let e=!0;for(let t in s){e=!1;break}return e}function tP(s,e,t,i){let n="See luma.gl ".concat(t," Upgrade Guide at https://luma.gl/docs/upgrade-guide"),o=Object.getPrototypeOf(s);i.forEach(a=>{o.methodName||(o[a]=()=>{throw se.removed("Calling removed method ".concat(e,".").concat(a,": "),n)(),new Error(a)})})}var Sh="Resource subclass must define virtual methods",Ht=class{get[Symbol.toStringTag](){return"Resource"}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};Vs(e);let{id:i,userData:n={}}=t;this.gl=e,this.gl2=e,this.id=i||Si(this[Symbol.toStringTag]),this.userData=n,this._bound=!1,this._handle=t.handle,this._handle===void 0&&(this._handle=this._createHandle()),this.byteLength=0,this._initStats(),this._addStats()}toString(){return"".concat(this[Symbol.toStringTag]||this.constructor.name,"(").concat(this.id,")")}get handle(){return this._handle}delete(){let{deleteChildren:e=!1}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=this._handle&&this._deleteHandle(this._handle);return this._handle&&this._removeStats(),this._handle=null,t&&e&&t.filter(Boolean).forEach(i=>i.delete()),this}bind(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.handle;if(typeof e!="function")return this._bindHandle(e),this;let t;return this._bound?t=e():(this._bindHandle(this.handle),this._bound=!0,t=e(),this._bound=!1,this._bindHandle(null)),t}unbind(){this.bind(null)}getParameter(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};e=eP(this.gl,e),J(e);let n=(this.constructor.PARAMETERS||{})[e];if(n){let o=ge(this.gl);if(!((!("webgl2"in n)||o)&&(!("extension"in n)||this.gl.getExtension(n.extension)))){let l=n.webgl1,u="webgl2"in n?n.webgl2:n.webgl1;return o?u:l}}return this._getParameter(e,t)}getParameters(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{parameters:t,keys:i}=e,n=this.constructor.PARAMETERS||{},o=ge(this.gl),a={},l=t||Object.keys(n);for(let u of l){let c=n[u];if(c&&(!("webgl2"in c)||o)&&(!("extension"in c)||this.gl.getExtension(c.extension))){let d=i?_n(this.gl,u):u;a[d]=this.getParameter(u,e),i&&c.type==="GLenum"&&(a[d]=_n(this.gl,a[d]))}}return a}setParameter(e,t){e=eP(this.gl,e),J(e);let n=(this.constructor.PARAMETERS||{})[e];if(n){let o=ge(this.gl);if(!((!("webgl2"in n)||o)&&(!("extension"in n)||this.gl.getExtension(n.extension))))throw new Error("Parameter not available on this platform");n.type==="GLenum"&&(t=eP(t))}return this._setParameter(e,t),this}setParameters(e){for(let t in e)this.setParameter(t,e[t]);return this}stubRemovedMethods(e,t,i){return tP(this,e,t,i)}initialize(e){}_createHandle(){throw new Error(Sh)}_deleteHandle(){throw new Error(Sh)}_bindHandle(e){throw new Error(Sh)}_getOptsFromHandle(){throw new Error(Sh)}_getParameter(e,t){throw new Error(Sh)}_setParameter(e,t){throw new Error(Sh)}_context(){return this.gl.luma=this.gl.luma||{},this.gl.luma}_initStats(){this.gl.stats=this.gl.stats||new jf}_addStats(){let e=this[Symbol.toStringTag],t=On.get("Resource Counts");t.get("Resources Created").incrementCount(),t.get("".concat(e,"s Created")).incrementCount(),t.get("".concat(e,"s Active")).incrementCount()}_removeStats(){let e=this[Symbol.toStringTag];On.get("Resource Counts").get("".concat(e,"s Active")).decrementCount()}_trackAllocatedMemory(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:this[Symbol.toStringTag];this._doTrackAllocatedMemory(e,t),this._doTrackAllocatedMemory(e,t,this.gl.stats.get("Memory Usage"))}_doTrackAllocatedMemory(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:this[Symbol.toStringTag],i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:On.get("Memory Usage");i.get("GPU Memory").addCount(e),i.get("".concat(t," Memory")).addCount(e),this.byteLength=e}_trackDeallocatedMemory(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this[Symbol.toStringTag];this._doTrackDeallocatedMemory(e),this._doTrackDeallocatedMemory(e,this.gl.stats.get("Memory Usage"))}_doTrackDeallocatedMemory(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this[Symbol.toStringTag],t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:On.get("Memory Usage");t.get("GPU Memory").subtractCount(this.byteLength),t.get("".concat(e," Memory")).subtractCount(this.byteLength),this.byteLength=0}};var bG="Failed to deduce GL constant from typed array";function qf(s){switch(ArrayBuffer.isView(s)?s.constructor:s){case Float32Array:return 5126;case Uint16Array:return 5123;case Uint32Array:return 5125;case Uint8Array:return 5121;case Uint8ClampedArray:return 5121;case Int8Array:return 5120;case Int16Array:return 5122;case Int32Array:return 5124;default:throw new Error(bG)}}function il(s){let{clamped:e=!0}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};switch(s){case 5126:return Float32Array;case 5123:case 33635:case 32819:case 32820:return Uint16Array;case 5125:return Uint32Array;case 5121:return e?Uint8ClampedArray:Uint8Array;case 5120:return Int8Array;case 5122:return Int16Array;case 5124:return Int32Array;default:throw new Error("Failed to deduce typed array type from GL constant")}}function OT(s){let{data:e,width:t,height:i,bytesPerPixel:n=4,temp:o}=s,a=t*n;o=o||new Uint8Array(a);for(let l=0;l<i/2;++l){let u=l*a,c=(i-l-1)*a;o.set(e.subarray(u,u+a)),e.copyWithin(u,c,c+a),e.set(o,c)}}function _T(s){let{data:e,width:t,height:i}=s,n=Math.round(t/2),o=Math.round(i/2),a=new Uint8Array(n*o*4);for(let l=0;l<o;l++)for(let u=0;u<n;u++)for(let c=0;c<4;c++)a[(l*n+u)*4+c]=e[(l*2*t+u*2)*4+c];return{data:a,width:n,height:o}}function Xf(s,e,t){let{removedProps:i={},deprecatedProps:n={},replacedProps:o={}}=t;for(let l in i)if(l in e){let c=i[l]?"".concat(s,".").concat(i[l]):"N/A";se.removed("".concat(s,".").concat(l),c)()}for(let l in n)if(l in e){let u=n[l];se.deprecated("".concat(s,".").concat(l),"".concat(s,".").concat(u))()}let a=null;for(let l in o)if(l in e){let u=o[l];se.deprecated("".concat(s,".").concat(l),"".concat(s,".").concat(u))(),a=a||Object.assign({},e),a[u]=e[l],delete a[l]}return a||e}var PG={offset:0,stride:0,type:5126,size:1,divisor:0,normalized:!1,integer:!1},yG={deprecatedProps:{instanced:"divisor",isInstanced:"divisor"}},fr=class{static getBytesPerElement(e){return il(e.type||5126).BYTES_PER_ELEMENT}static getBytesPerVertex(e){return J(e.size),il(e.type||5126).BYTES_PER_ELEMENT*e.size}static resolve(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return new fr(PG,...t)}constructor(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];t.forEach(n=>this._assign(n)),Object.freeze(this)}toString(){return JSON.stringify(this)}get BYTES_PER_ELEMENT(){return fr.getBytesPerElement(this)}get BYTES_PER_VERTEX(){return fr.getBytesPerVertex(this)}_assign(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return e=Xf("Accessor",e,yG),e.type!==void 0&&(this.type=e.type,(e.type===5124||e.type===5125)&&(this.integer=!0)),e.size!==void 0&&(this.size=e.size),e.offset!==void 0&&(this.offset=e.offset),e.stride!==void 0&&(this.stride=e.stride),e.normalized!==void 0&&(this.normalized=e.normalized),e.integer!==void 0&&(this.integer=e.integer),e.divisor!==void 0&&(this.divisor=e.divisor),e.buffer!==void 0&&(this.buffer=e.buffer),e.index!==void 0&&(typeof e.index=="boolean"?this.index=e.index?1:0:this.index=e.index),e.instanced!==void 0&&(this.divisor=e.instanced?1:0),e.isInstanced!==void 0&&(this.divisor=e.isInstanced?1:0),this}};var NT=10,MT={offset:"accessor.offset",stride:"accessor.stride",type:"accessor.type",size:"accessor.size",divisor:"accessor.divisor",normalized:"accessor.normalized",integer:"accessor.integer",instanced:"accessor.divisor",isInstanced:"accessor.divisor"},SG={removedProps:{},replacedProps:{bytes:"byteLength"},deprecatedProps:MT},EG={removedProps:MT},ye=class extends Ht{get[Symbol.toStringTag](){return"Buffer"}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(e,t),this.stubRemovedMethods("Buffer","v6.0",["layout","setLayout","getIndexedParameter"]),this.target=t.target||(this.gl.webgl2?36662:34962),this.initialize(t),Object.seal(this)}getElementCount(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.accessor;return Math.round(this.byteLength/fr.getBytesPerElement(e))}getVertexCount(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.accessor;return Math.round(this.byteLength/fr.getBytesPerVertex(e))}initialize(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return ArrayBuffer.isView(e)&&(e={data:e}),Number.isFinite(e)&&(e={byteLength:e}),e=Xf("Buffer",e,SG),this.usage=e.usage||35044,this.debugData=null,this.setAccessor(Object.assign({},e,e.accessor)),e.data?this._setData(e.data,e.offset,e.byteLength):this._setByteLength(e.byteLength||0),this}setProps(e){return e=Xf("Buffer",e,EG),"accessor"in e&&this.setAccessor(e.accessor),this}setAccessor(e){return e=Object.assign({},e),delete e.buffer,this.accessor=new fr(e),this}reallocate(e){return e>this.byteLength?(this._setByteLength(e),!0):(this.bytesUsed=e,!1)}setData(e){return this.initialize(e)}subData(e){ArrayBuffer.isView(e)&&(e={data:e});let{data:t,offset:i=0,srcOffset:n=0}=e,o=e.byteLength||e.length;J(t);let a=this.gl.webgl2?36663:this.target;return this.gl.bindBuffer(a,this.handle),n!==0||o!==void 0?(Pt(this.gl),this.gl.bufferSubData(this.target,i,t,n,o)):this.gl.bufferSubData(a,i,t),this.gl.bindBuffer(a,null),this.debugData=null,this._inferType(t),this}copyData(e){let{sourceBuffer:t,readOffset:i=0,writeOffset:n=0,size:o}=e,{gl:a}=this;return Pt(a),a.bindBuffer(36662,t.handle),a.bindBuffer(36663,this.handle),a.copyBufferSubData(36662,36663,i,n,o),a.bindBuffer(36662,null),a.bindBuffer(36663,null),this.debugData=null,this}getData(){let{dstData:e=null,srcByteOffset:t=0,dstOffset:i=0,length:n=0}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};Pt(this.gl);let o=il(this.accessor.type||5126,{clamped:!1}),a=this._getAvailableElementCount(t),l=i,u,c;e?(c=e.length,u=c-l):(u=Math.min(a,n||a),c=l+u);let h=Math.min(a,u);return n=n||h,J(n<=h),e=e||new o(c),this.gl.bindBuffer(36662,this.handle),this.gl.getBufferSubData(36662,t,e,i,n),this.gl.bindBuffer(36662,null),e}bind(){let{target:e=this.target,index:t=this.accessor&&this.accessor.index,offset:i=0,size:n}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return e===35345||e===35982?n!==void 0?this.gl.bindBufferRange(e,t,this.handle,i,n):(J(i===0),this.gl.bindBufferBase(e,t,this.handle)):this.gl.bindBuffer(e,this.handle),this}unbind(){let{target:e=this.target,index:t=this.accessor&&this.accessor.index}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return e===35345||e===35982?this.gl.bindBufferBase(e,t,null):this.gl.bindBuffer(e,null),this}getDebugData(){return this.debugData?{data:this.debugData,changed:!1}:(this.debugData=this.getData({length:Math.min(NT,this.byteLength)}),{data:this.debugData,changed:!0})}invalidateDebugData(){this.debugData=null}_setData(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:e.byteLength+t;J(ArrayBuffer.isView(e)),this._trackDeallocatedMemory();let n=this._getTarget();this.gl.bindBuffer(n,this.handle),this.gl.bufferData(n,i,this.usage),this.gl.bufferSubData(n,t,e),this.gl.bindBuffer(n,null),this.debugData=e.slice(0,NT),this.bytesUsed=i,this._trackAllocatedMemory(i);let o=qf(e);return J(o),this.setAccessor(new fr(this.accessor,{type:o})),this}_setByteLength(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:this.usage;J(e>=0),this._trackDeallocatedMemory();let i=e;e===0&&(i=new Float32Array(0));let n=this._getTarget();return this.gl.bindBuffer(n,this.handle),this.gl.bufferData(n,i,t),this.gl.bindBuffer(n,null),this.usage=t,this.debugData=null,this.bytesUsed=e,this._trackAllocatedMemory(e),this}_getTarget(){return this.gl.webgl2?36663:this.target}_getAvailableElementCount(e){let t=il(this.accessor.type||5126,{clamped:!1}),i=e/t.BYTES_PER_ELEMENT;return this.getElementCount()-i}_inferType(e){this.accessor.type||this.setAccessor(new fr(this.accessor,{type:qf(e)}))}_createHandle(){return this.gl.createBuffer()}_deleteHandle(){this.gl.deleteBuffer(this.handle),this._trackDeallocatedMemory()}_getParameter(e){this.gl.bindBuffer(this.target,this.handle);let t=this.gl.getBufferParameter(this.target,e);return this.gl.bindBuffer(this.target,null),t}get type(){return se.deprecated("Buffer.type","Buffer.accessor.type")(),this.accessor.type}get bytes(){return se.deprecated("Buffer.bytes","Buffer.byteLength")(),this.byteLength}setByteLength(e){return se.deprecated("setByteLength","reallocate")(),this.reallocate(e)}updateAccessor(e){return se.deprecated("updateAccessor(...)","setAccessor(new Accessor(buffer.accessor, ...)")(),this.accessor=new fr(this.accessor,e),this}};var rP={[6407]:{dataFormat:6407,types:[5121,33635]},[6408]:{dataFormat:6408,types:[5121,32819,32820]},[6406]:{dataFormat:6406,types:[5121]},[6409]:{dataFormat:6409,types:[5121]},[6410]:{dataFormat:6410,types:[5121]},[33326]:{dataFormat:6403,types:[5126],gl2:!0},[33328]:{dataFormat:33319,types:[5126],gl2:!0},[34837]:{dataFormat:6407,types:[5126],gl2:!0},[34836]:{dataFormat:6408,types:[5126],gl2:!0}},iP={[6403]:1,[36244]:1,[33319]:2,[33320]:2,[6407]:3,[36248]:3,[6408]:4,[36249]:4,[6402]:1,[34041]:1,[6406]:1,[6409]:1,[6410]:2},nP={[5126]:4,[5125]:4,[5124]:4,[5123]:2,[5122]:2,[5131]:2,[5120]:1,[5121]:1};function BT(s,e){let t=rP[e];if(!t)return!1;if(t.gl1===void 0&&t.gl2===void 0)return!0;let i=ge(s)&&t.gl2||t.gl1;return typeof i=="string"?s.getExtension(i):i}function DT(s,e){let t=rP[e];switch(t&&t.types[0]){case 5126:return s.getExtension("OES_texture_float_linear");case 5131:return s.getExtension("OES_texture_half_float_linear");default:return!0}}var xG=[9729,9728],GT=globalThis.WebGLBuffer||function(){},ni=class extends Ht{get[Symbol.toStringTag](){return"Texture"}static isSupported(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},{format:i,linearFiltering:n}=t,o=!0;return i&&(o=o&&BT(e,i),o=o&&(!n||DT(e,i))),o}constructor(e,t){let{id:i=Si("texture"),handle:n,target:o}=t;super(e,{id:i,handle:n}),this.target=o,this.textureUnit=void 0,this.loaded=!1,this.width=void 0,this.height=void 0,this.depth=void 0,this.format=void 0,this.type=void 0,this.dataFormat=void 0,this.border=void 0,this.textureUnit=void 0,this.mipmaps=void 0}toString(){return"Texture(".concat(this.id,",").concat(this.width,"x").concat(this.height,")")}initialize(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=e.data;if(t instanceof Promise)return t.then(B=>this.initialize(Object.assign({},e,{pixels:B,data:B}))),this;let i=typeof HTMLVideoElement<"u"&&t instanceof HTMLVideoElement;if(i&&t.readyState<HTMLVideoElement.HAVE_METADATA)return this._video=null,t.addEventListener("loadeddata",()=>this.initialize(e)),this;let{pixels:n=null,format:o=6408,border:a=0,recreate:l=!1,parameters:u={},pixelStore:c={},textureUnit:h=void 0}=e;t||(t=n);let{width:d,height:f,dataFormat:p,type:S,compressed:E=!1,mipmaps:C=!0}=e,{depth:O=0}=e;return{width:d,height:f,compressed:E,dataFormat:p,type:S}=this._deduceParameters({format:o,type:S,dataFormat:p,compressed:E,data:t,width:d,height:f}),this.width=d,this.height=f,this.depth=O,this.format=o,this.type=S,this.dataFormat=p,this.border=a,this.textureUnit=h,Number.isFinite(this.textureUnit)&&(this.gl.activeTexture(33984+this.textureUnit),this.gl.bindTexture(this.target,this.handle)),C&&this._isNPOT()&&(se.warn("texture: ".concat(this," is Non-Power-Of-Two, disabling mipmaping"))(),C=!1,this._updateForNPOT(u)),this.mipmaps=C,this.setImageData({data:t,width:d,height:f,depth:O,format:o,type:S,dataFormat:p,border:a,mipmaps:C,parameters:c,compressed:E}),C&&this.generateMipmap(),this.setParameters(u),l&&(this.data=t),i&&(this._video={video:t,parameters:u,lastTime:t.readyState>=HTMLVideoElement.HAVE_CURRENT_DATA?t.currentTime:-1}),this}update(){if(this._video){let{video:e,parameters:t,lastTime:i}=this._video;if(i===e.currentTime||e.readyState<HTMLVideoElement.HAVE_CURRENT_DATA)return;this.setSubImageData({data:e,parameters:t}),this.mipmaps&&this.generateMipmap(),this._video.lastTime=e.currentTime}}resize(e){let{height:t,width:i,mipmaps:n=!1}=e;return i!==this.width||t!==this.height?this.initialize({width:i,height:t,format:this.format,type:this.type,dataFormat:this.dataFormat,border:this.border,mipmaps:n}):this}generateMipmap(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this._isNPOT()?(se.warn("texture: ".concat(this," is Non-Power-Of-Two, disabling mipmaping"))(),this):(this.mipmaps=!0,this.gl.bindTexture(this.target,this.handle),pt(this.gl,e,()=>{this.gl.generateMipmap(this.target)}),this.gl.bindTexture(this.target,null),this)}setImageData(e){this._trackDeallocatedMemory("Texture");let{target:t=this.target,pixels:i=null,level:n=0,format:o=this.format,border:a=this.border,offset:l=0,parameters:u={}}=e,{data:c=null,type:h=this.type,width:d=this.width,height:f=this.height,dataFormat:p=this.dataFormat,compressed:S=!1}=e;c||(c=i),{type:h,dataFormat:p,compressed:S,width:d,height:f}=this._deduceParameters({format:o,type:h,dataFormat:p,compressed:S,data:c,width:d,height:f});let{gl:E}=this;E.bindTexture(this.target,this.handle);let C=null;({data:c,dataType:C}=this._getDataType({data:c,compressed:S}));let O,B=0;if(pt(this.gl,u,()=>{switch(C){case"null":E.texImage2D(t,n,o,d,f,a,p,h,c);break;case"typed-array":E.texImage2D(t,n,o,d,f,a,p,h,c,l);break;case"buffer":O=Pt(E),O.bindBuffer(35052,c.handle||c),O.texImage2D(t,n,o,d,f,a,p,h,l),O.bindBuffer(35052,null);break;case"browser-object":ge(E)?E.texImage2D(t,n,o,d,f,a,p,h,c):E.texImage2D(t,n,o,p,h,c);break;case"compressed":for(let[A,N]of c.entries())E.compressedTexImage2D(t,A,N.format,N.width,N.height,a,N.data),B+=N.levelSize;break;default:J(!1,"Unknown image data type")}}),C==="compressed")this._trackAllocatedMemory(B,"Texture");else if(c&&c.byteLength)this._trackAllocatedMemory(c.byteLength,"Texture");else{let A=iP[this.dataFormat]||4,N=nP[this.type]||1;this._trackAllocatedMemory(this.width*this.height*A*N,"Texture")}return this.loaded=!0,this}setSubImageData(e){let{target:t=this.target,pixels:i=null,data:n=null,x:o=0,y:a=0,width:l=this.width,height:u=this.height,level:c=0,format:h=this.format,type:d=this.type,dataFormat:f=this.dataFormat,compressed:p=!1,offset:S=0,border:E=this.border,parameters:C={}}=e;if({type:d,dataFormat:f,compressed:p,width:l,height:u}=this._deduceParameters({format:h,type:d,dataFormat:f,compressed:p,data:n,width:l,height:u}),J(this.depth===0,"texSubImage not supported for 3D textures"),n||(n=i),n&&n.data){let O=n;n=O.data,l=O.shape[0],u=O.shape[1]}n instanceof ye&&(n=n.handle),this.gl.bindTexture(this.target,this.handle),pt(this.gl,C,()=>{if(p)this.gl.compressedTexSubImage2D(t,c,o,a,l,u,h,n);else if(n===null)this.gl.texSubImage2D(t,c,o,a,l,u,f,d,null);else if(ArrayBuffer.isView(n))this.gl.texSubImage2D(t,c,o,a,l,u,f,d,n,S);else if(n instanceof GT){let O=Pt(this.gl);O.bindBuffer(35052,n),O.texSubImage2D(t,c,o,a,l,u,f,d,S),O.bindBuffer(35052,null)}else ge(this.gl)?Pt(this.gl).texSubImage2D(t,c,o,a,l,u,f,d,n):this.gl.texSubImage2D(t,c,o,a,f,d,n)}),this.gl.bindTexture(this.target,null)}copyFramebuffer(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return se.error("Texture.copyFramebuffer({...}) is no logner supported, use copyToTexture(source, target, opts})")(),null}getActiveUnit(){return this.gl.getParameter(34016)-33984}bind(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.textureUnit,{gl:t}=this;return e!==void 0&&(this.textureUnit=e,t.activeTexture(33984+e)),t.bindTexture(this.target,this.handle),e}unbind(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.textureUnit,{gl:t}=this;return e!==void 0&&(this.textureUnit=e,t.activeTexture(33984+e)),t.bindTexture(this.target,null),e}_getDataType(e){let{data:t,compressed:i=!1}=e;return i?{data:t,dataType:"compressed"}:t===null?{data:t,dataType:"null"}:ArrayBuffer.isView(t)?{data:t,dataType:"typed-array"}:t instanceof ye?{data:t.handle,dataType:"buffer"}:t instanceof GT?{data:t,dataType:"buffer"}:{data:t,dataType:"browser-object"}}_deduceParameters(e){let{format:t,data:i}=e,{width:n,height:o,dataFormat:a,type:l,compressed:u}=e,c=rP[t];return a=a||c&&c.dataFormat,l=l||c&&c.types[0],u=u||c&&c.compressed,{width:n,height:o}=this._deduceImageSize(i,n,o),{dataFormat:a,type:l,compressed:u,width:n,height:o,format:t,data:i}}_deduceImageSize(e,t,i){let n;return typeof ImageData<"u"&&e instanceof ImageData?n={width:e.width,height:e.height}:typeof HTMLImageElement<"u"&&e instanceof HTMLImageElement?n={width:e.naturalWidth,height:e.naturalHeight}:typeof HTMLCanvasElement<"u"&&e instanceof HTMLCanvasElement?n={width:e.width,height:e.height}:typeof ImageBitmap<"u"&&e instanceof ImageBitmap?n={width:e.width,height:e.height}:typeof HTMLVideoElement<"u"&&e instanceof HTMLVideoElement?n={width:e.videoWidth,height:e.videoHeight}:e?n={width:t,height:i}:n={width:t>=0?t:1,height:i>=0?i:1},J(n,"Could not deduced texture size"),J(t===void 0||n.width===t,"Deduced texture width does not match supplied width"),J(i===void 0||n.height===i,"Deduced texture height does not match supplied height"),n}_createHandle(){return this.gl.createTexture()}_deleteHandle(){this.gl.deleteTexture(this.handle),this._trackDeallocatedMemory("Texture")}_getParameter(e){switch(e){case 4096:return this.width;case 4097:return this.height;default:this.gl.bindTexture(this.target,this.handle);let t=this.gl.getTexParameter(this.target,e);return this.gl.bindTexture(this.target,null),t}}_setParameter(e,t){switch(this.gl.bindTexture(this.target,this.handle),t=this._getNPOTParam(e,t),e){case 33082:case 33083:this.gl.texParameterf(this.handle,e,t);break;case 4096:case 4097:J(!1);break;default:this.gl.texParameteri(this.target,e,t);break}return this.gl.bindTexture(this.target,null),this}_isNPOT(){return ge(this.gl)||!this.width||!this.height?!1:!CE(this.width)||!CE(this.height)}_updateForNPOT(e){e[this.gl.TEXTURE_MIN_FILTER]===void 0&&(e[this.gl.TEXTURE_MIN_FILTER]=this.gl.LINEAR),e[this.gl.TEXTURE_WRAP_S]===void 0&&(e[this.gl.TEXTURE_WRAP_S]=this.gl.CLAMP_TO_EDGE),e[this.gl.TEXTURE_WRAP_T]===void 0&&(e[this.gl.TEXTURE_WRAP_T]=this.gl.CLAMP_TO_EDGE)}_getNPOTParam(e,t){if(this._isNPOT())switch(e){case 10241:xG.indexOf(t)===-1&&(t=9729);break;case 10242:case 10243:t!==33071&&(t=33071);break;default:break}return t}};var vG="";function FT(s,e){return J(typeof s=="string"),s=vG+s,new Promise((t,i)=>{try{let n=new Image;n.onload=()=>t(n),n.onerror=()=>i(new Error("Could not load image ".concat(s,"."))),n.crossOrigin=e&&e.crossOrigin||"anonymous",n.src=s}catch(n){i(n)}})}var Ue=class extends ni{get[Symbol.toStringTag](){return"Texture2D"}static isSupported(e,t){return ni.isSupported(e,t)}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};Vs(e),(t instanceof Promise||typeof t=="string")&&(t={data:t}),typeof t.data=="string"&&(t=Object.assign({},t,{data:FT(t.data)})),super(e,Object.assign({},t,{target:3553})),this.initialize(t),Object.seal(this)}};var AE=[34069,34070,34071,34072,34073,34074],Au=class extends ni{get[Symbol.toStringTag](){return"TextureCube"}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};Vs(e),super(e,Object.assign({},t,{target:34067})),this.initialize(t),Object.seal(this)}initialize(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{mipmaps:t=!0,parameters:i={}}=e;return this.opts=e,this.setCubeMapImageData(e).then(()=>{this.loaded=!0,t&&this.generateMipmap(e),this.setParameters(i)}),this}subImage(e){let{face:t,data:i,x:n=0,y:o=0,mipmapLevel:a=0}=e;return this._subImage({target:t,data:i,x:n,y:o,mipmapLevel:a})}async setCubeMapImageData(e){let{width:t,height:i,pixels:n,data:o,border:a=0,format:l=6408,type:u=5121}=e,{gl:c}=this,h=n||o,d=await Promise.all(AE.map(f=>{let p=h[f];return Promise.all(Array.isArray(p)?p:[p])}));this.bind(),AE.forEach((f,p)=>{d[p].length>1&&this.opts.mipmaps!==!1&&se.warn("".concat(this.id," has mipmap and multiple LODs."))(),d[p].forEach((S,E)=>{t&&i?c.texImage2D(f,E,l,t,i,a,l,u,S):c.texImage2D(f,E,l,l,u,S)})}),this.unbind()}setImageDataForFace(e){let{face:t,width:i,height:n,pixels:o,data:a,border:l=0,format:u=6408,type:c=5121}=e,{gl:h}=this,d=o||a;return this.bind(),d instanceof Promise?d.then(f=>this.setImageDataForFace(Object.assign({},e,{face:t,data:f,pixels:f}))):this.width||this.height?h.texImage2D(t,0,u,i,n,l,u,c,d):h.texImage2D(t,0,u,u,c,d),this}};Au.FACES=AE;var Eh=class extends ni{get[Symbol.toStringTag](){return"Texture3D"}static isSupported(e){return ge(e)}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};Pt(e),t=Object.assign({depth:1},t,{target:32879,unpackFlipY:!1}),super(e,t),this.initialize(t),Object.seal(this)}setImageData(e){let{level:t=0,dataFormat:i=6408,width:n,height:o,depth:a=1,border:l=0,format:u,type:c=5121,offset:h=0,data:d,parameters:f={}}=e;if(this._trackDeallocatedMemory("Texture"),this.gl.bindTexture(this.target,this.handle),pt(this.gl,f,()=>{ArrayBuffer.isView(d)&&this.gl.texImage3D(this.target,t,i,n,o,a,l,u,c,d),d instanceof ye&&(this.gl.bindBuffer(35052,d.handle),this.gl.texImage3D(this.target,t,i,n,o,a,l,u,c,h))}),d&&d.byteLength)this._trackAllocatedMemory(d.byteLength,"Texture");else{let p=iP[this.dataFormat]||4,S=nP[this.type]||1;this._trackAllocatedMemory(this.width*this.height*this.depth*p*S,"Texture")}return this.loaded=!0,this}};var Tu="EXT_color_buffer_float",TE={[33189]:{bpp:2},[33190]:{gl2:!0,bpp:3},[36012]:{gl2:!0,bpp:4},[36168]:{bpp:1},[34041]:{bpp:4},[35056]:{gl2:!0,bpp:4},[36013]:{gl2:!0,bpp:5},[32854]:{bpp:2},[36194]:{bpp:2},[32855]:{bpp:2},[33321]:{gl2:!0,bpp:1},[33330]:{gl2:!0,bpp:1},[33329]:{gl2:!0,bpp:1},[33332]:{gl2:!0,bpp:2},[33331]:{gl2:!0,bpp:2},[33334]:{gl2:!0,bpp:4},[33333]:{gl2:!0,bpp:4},[33323]:{gl2:!0,bpp:2},[33336]:{gl2:!0,bpp:2},[33335]:{gl2:!0,bpp:2},[33338]:{gl2:!0,bpp:4},[33337]:{gl2:!0,bpp:4},[33340]:{gl2:!0,bpp:8},[33339]:{gl2:!0,bpp:8},[32849]:{gl2:!0,bpp:3},[32856]:{gl2:!0,bpp:4},[32857]:{gl2:!0,bpp:4},[36220]:{gl2:!0,bpp:4},[36238]:{gl2:!0,bpp:4},[36975]:{gl2:!0,bpp:4},[36214]:{gl2:!0,bpp:8},[36232]:{gl2:!0,bpp:8},[36226]:{gl2:!0,bpp:16},[36208]:{gl2:!0,bpp:16},[33325]:{gl2:Tu,bpp:2},[33327]:{gl2:Tu,bpp:4},[34842]:{gl2:Tu,bpp:8},[33326]:{gl2:Tu,bpp:4},[33328]:{gl2:Tu,bpp:8},[34836]:{gl2:Tu,bpp:16},[35898]:{gl2:Tu,bpp:4}};function CG(s,e,t){let i=t[e];if(!i)return!1;let n=ge(s)&&i.gl2||i.gl1;return typeof n=="string"?s.getExtension(n):n}var Ni=class extends Ht{get[Symbol.toStringTag](){return"Renderbuffer"}static isSupported(e){let{format:t}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{format:null};return!t||CG(e,t,TE)}static getSamplesForFormat(e,t){let{format:i}=t;return e.getInternalformatParameter(36161,i,32937)}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(e,t),this.initialize(t),Object.seal(this)}initialize(e){let{format:t,width:i=1,height:n=1,samples:o=0}=e;return J(t,"Needs format"),this._trackDeallocatedMemory(),this.gl.bindRenderbuffer(36161,this.handle),o!==0&&ge(this.gl)?this.gl.renderbufferStorageMultisample(36161,o,t,i,n):this.gl.renderbufferStorage(36161,t,i,n),this.format=t,this.width=i,this.height=n,this.samples=o,this._trackAllocatedMemory(this.width*this.height*(this.samples||1)*TE[this.format].bpp),this}resize(e){let{width:t,height:i}=e;return t!==this.width||i!==this.height?this.initialize({width:t,height:i,format:this.format,samples:this.samples}):this}_createHandle(){return this.gl.createRenderbuffer()}_deleteHandle(){this.gl.deleteRenderbuffer(this.handle),this._trackDeallocatedMemory()}_bindHandle(e){this.gl.bindRenderbuffer(36161,e)}_syncHandle(e){this.format=this.getParameter(36164),this.width=this.getParameter(36162),this.height=this.getParameter(36163),this.samples=this.getParameter(36011)}_getParameter(e){return this.gl.bindRenderbuffer(36161,this.handle),this.gl.getRenderbufferParameter(36161,e)}};var AG=256,TG=1024,IG=16384,kT=6144,VT=6145,UT=6146,zT=34041,WT="clear: bad arguments";function nl(s){let{framebuffer:e=null,color:t=null,depth:i=null,stencil:n=null}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},o={};e&&(o.framebuffer=e);let a=0;t&&(a|=IG,t!==!0&&(o.clearColor=t)),i&&(a|=AG,i!==!0&&(o.clearDepth=i)),n&&(a|=TG,i!==!0&&(o.clearStencil=i)),J(a!==0,WT),pt(s,o,()=>{s.clear(a)})}function IE(s){let{framebuffer:e=null,buffer:t=kT,drawBuffer:i=0,value:n=[0,0,0,0]}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};Pt(s),pt(s,{framebuffer:e},()=>{switch(t){case kT:switch(n.constructor){case Int32Array:s.clearBufferiv(t,i,n);break;case Uint32Array:s.clearBufferuiv(t,i,n);break;case Float32Array:default:s.clearBufferfv(t,i,n)}break;case VT:s.clearBufferfv(VT,0,[n]);break;case UT:s.clearBufferiv(UT,0,[n]);break;case zT:let[o,a]=n;s.clearBufferfi(zT,0,o,a);break;default:J(!1,WT)}})}function HT(s){switch(s){case 6406:case 33326:case 6403:return 1;case 33328:case 33319:return 2;case 6407:case 34837:return 3;case 6408:case 34836:return 4;default:return J(!1),0}}function Us(s){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},{sourceX:t=0,sourceY:i=0,sourceFormat:n=6408}=e,{sourceAttachment:o=36064,target:a=null,sourceWidth:l,sourceHeight:u,sourceType:c}=e,{framebuffer:h,deleteFramebuffer:d}=jT(s);J(h);let{gl:f,handle:p,attachments:S}=h;l=l||h.width,u=u||h.height,o===36064&&p===null&&(o=1028),J(S[o]),c=c||S[o].type,a=wG(a,c,n,l,u),c=c||qf(a);let E=f.bindFramebuffer(36160,p);return f.readPixels(t,i,l,u,n,c,a),f.bindFramebuffer(36160,E||null),d&&h.delete(),a}function oP(s){let{sourceAttachment:e=36064,targetMaxHeight:t=Number.MAX_SAFE_INTEGER}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},i=Us(s,{sourceAttachment:e}),{width:n,height:o}=s;for(;o>t;)({data:i,width:n,height:o}=_T({data:i,width:n,height:o}));OT({data:i,width:n,height:o});let a=document.createElement("canvas");a.width=n,a.height=o;let l=a.getContext("2d"),u=l.createImageData(n,o);return u.data.set(i),l.putImageData(u,0,0),a.toDataURL()}function sP(s,e){let t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},{sourceX:i=0,sourceY:n=0,targetMipmaplevel:o=0,targetInternalFormat:a=6408}=t,{targetX:l,targetY:u,targetZ:c,width:h,height:d}=t,{framebuffer:f,deleteFramebuffer:p}=jT(s);J(f);let{gl:S,handle:E}=f,C=typeof l<"u"||typeof u<"u"||typeof c<"u";l=l||0,u=u||0,c=c||0;let O=S.bindFramebuffer(36160,E);J(e);let B=null;if(e instanceof ni&&(B=e,h=Number.isFinite(h)?h:B.width,d=Number.isFinite(d)?d:B.height,B.bind(0),e=B.target),!C)S.copyTexImage2D(e,o,a,i,n,h,d,0);else switch(e){case 3553:case 34067:S.copyTexSubImage2D(e,o,l,u,i,n,h,d);break;case 35866:case 32879:Pt(S).copyTexSubImage3D(e,o,l,u,c,i,n,h,d);break;default:}return B&&B.unbind(),S.bindFramebuffer(36160,O||null),p&&f.delete(),B}function jT(s){return s instanceof De?{framebuffer:s,deleteFramebuffer:!1}:{framebuffer:qT(s),deleteFramebuffer:!0}}function wG(s,e,t,i,n){if(s)return s;e=e||5121;let o=il(e,{clamped:!1}),a=HT(t);return new o(i*n*a)}var et={WEBGL2:"WEBGL2",VERTEX_ARRAY_OBJECT:"VERTEX_ARRAY_OBJECT",TIMER_QUERY:"TIMER_QUERY",INSTANCED_RENDERING:"INSTANCED_RENDERING",MULTIPLE_RENDER_TARGETS:"MULTIPLE_RENDER_TARGETS",ELEMENT_INDEX_UINT32:"ELEMENT_INDEX_UINT32",BLEND_EQUATION_MINMAX:"BLEND_EQUATION_MINMAX",FLOAT_BLEND:"FLOAT_BLEND",COLOR_ENCODING_SRGB:"COLOR_ENCODING_SRGB",TEXTURE_DEPTH:"TEXTURE_DEPTH",TEXTURE_FLOAT:"TEXTURE_FLOAT",TEXTURE_HALF_FLOAT:"TEXTURE_HALF_FLOAT",TEXTURE_FILTER_LINEAR_FLOAT:"TEXTURE_FILTER_LINEAR_FLOAT",TEXTURE_FILTER_LINEAR_HALF_FLOAT:"TEXTURE_FILTER_LINEAR_HALF_FLOAT",TEXTURE_FILTER_ANISOTROPIC:"TEXTURE_FILTER_ANISOTROPIC",COLOR_ATTACHMENT_RGBA32F:"COLOR_ATTACHMENT_RGBA32F",COLOR_ATTACHMENT_FLOAT:"COLOR_ATTACHMENT_FLOAT",COLOR_ATTACHMENT_HALF_FLOAT:"COLOR_ATTACHMENT_HALF_FLOAT",GLSL_FRAG_DATA:"GLSL_FRAG_DATA",GLSL_FRAG_DEPTH:"GLSL_FRAG_DEPTH",GLSL_DERIVATIVES:"GLSL_DERIVATIVES",GLSL_TEXTURE_LOD:"GLSL_TEXTURE_LOD"};function LG(s){let e=new Ue(s,{format:6408,type:5126,dataFormat:6408}),t=new De(s,{id:"test-framebuffer",check:!1,attachments:{[36064]:e}}),i=t.getStatus();return e.delete(),t.delete(),i===36053}var wE={[et.WEBGL2]:[!1,!0],[et.VERTEX_ARRAY_OBJECT]:["OES_vertex_array_object",!0],[et.TIMER_QUERY]:["EXT_disjoint_timer_query","EXT_disjoint_timer_query_webgl2"],[et.INSTANCED_RENDERING]:["ANGLE_instanced_arrays",!0],[et.MULTIPLE_RENDER_TARGETS]:["WEBGL_draw_buffers",!0],[et.ELEMENT_INDEX_UINT32]:["OES_element_index_uint",!0],[et.BLEND_EQUATION_MINMAX]:["EXT_blend_minmax",!0],[et.FLOAT_BLEND]:["EXT_float_blend"],[et.COLOR_ENCODING_SRGB]:["EXT_sRGB",!0],[et.TEXTURE_DEPTH]:["WEBGL_depth_texture",!0],[et.TEXTURE_FLOAT]:["OES_texture_float",!0],[et.TEXTURE_HALF_FLOAT]:["OES_texture_half_float",!0],[et.TEXTURE_FILTER_LINEAR_FLOAT]:["OES_texture_float_linear"],[et.TEXTURE_FILTER_LINEAR_HALF_FLOAT]:["OES_texture_half_float_linear"],[et.TEXTURE_FILTER_ANISOTROPIC]:["EXT_texture_filter_anisotropic"],[et.COLOR_ATTACHMENT_RGBA32F]:[LG,"EXT_color_buffer_float"],[et.COLOR_ATTACHMENT_FLOAT]:[!1,"EXT_color_buffer_float"],[et.COLOR_ATTACHMENT_HALF_FLOAT]:["EXT_color_buffer_half_float"],[et.GLSL_FRAG_DATA]:["WEBGL_draw_buffers",!0],[et.GLSL_FRAG_DEPTH]:["EXT_frag_depth",!0],[et.GLSL_DERIVATIVES]:["OES_standard_derivatives",!0],[et.GLSL_TEXTURE_LOD]:["EXT_shader_texture_lod",!0]};var RG=2;function Yf(s,e){return ol(s,e)}function ol(s,e){return e=Array.isArray(e)?e:[e],e.every(t=>XT(s,t))}function aP(s){s.luma=s.luma||{},s.luma.caps=s.luma.caps||{};for(let e in wE)s.luma.caps[e]===void 0&&(s.luma.caps[e]=XT(s,e));return s.luma.caps}function XT(s,e){return s.luma=s.luma||{},s.luma.caps=s.luma.caps||{},s.luma.caps[e]===void 0&&(s.luma.caps[e]=OG(s,e)),s.luma.caps[e]||se.log(RG,"Feature: ".concat(e," not supported"))(),s.luma.caps[e]}function OG(s,e){let t=wE[e];J(t,e);let i,n=ge(s)&&t[1]||t[0];if(typeof n=="function")i=n(s);else if(Array.isArray(n)){i=!0;for(let o of n)i=i&&Boolean(s.getExtension(o))}else typeof n=="string"?i=Boolean(s.getExtension(n)):typeof n=="boolean"?i=n:J(!1);return i}var YT="Multiple render targets not supported",De=class extends Ht{get[Symbol.toStringTag](){return"Framebuffer"}static isSupported(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},{colorBufferFloat:i,colorBufferHalfFloat:n}=t,o=!0;return i&&(o=Boolean(e.getExtension("EXT_color_buffer_float")||e.getExtension("WEBGL_color_buffer_float")||e.getExtension("OES_texture_float"))),n&&(o=o&&Boolean(e.getExtension("EXT_color_buffer_float")||e.getExtension("EXT_color_buffer_half_float"))),o}static getDefaultFramebuffer(e){return e.luma=e.luma||{},e.luma.defaultFramebuffer=e.luma.defaultFramebuffer||new De(e,{id:"default-framebuffer",handle:null,attachments:{}}),e.luma.defaultFramebuffer}get MAX_COLOR_ATTACHMENTS(){let e=Pt(this.gl);return e.getParameter(e.MAX_COLOR_ATTACHMENTS)}get MAX_DRAW_BUFFERS(){let e=Pt(this.gl);return e.getParameter(e.MAX_DRAW_BUFFERS)}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(e,t),this.width=null,this.height=null,this.attachments={},this.readBuffer=36064,this.drawBuffers=[36064],this.ownResources=[],this.initialize(t),Object.seal(this)}get color(){return this.attachments[36064]||null}get texture(){return this.attachments[36064]||null}get depth(){return this.attachments[36096]||this.attachments[33306]||null}get stencil(){return this.attachments[36128]||this.attachments[33306]||null}initialize(e){let{width:t=1,height:i=1,attachments:n=null,color:o=!0,depth:a=!0,stencil:l=!1,check:u=!0,readBuffer:c=void 0,drawBuffers:h=void 0}=e;if(J(t>=0&&i>=0,"Width and height need to be integers"),this.width=t,this.height=i,n)for(let d in n){let f=n[d];(Array.isArray(f)?f[0]:f).resize({width:t,height:i})}else n=this._createDefaultAttachments(o,a,l,t,i);this.update({clearAttachments:!0,attachments:n,readBuffer:c,drawBuffers:h}),n&&u&&this.checkStatus()}delete(){for(let e of this.ownResources)e.delete();return super.delete(),this}update(e){let{attachments:t={},readBuffer:i,drawBuffers:n,clearAttachments:o=!1,resizeAttachments:a=!0}=e;this.attach(t,{clearAttachments:o,resizeAttachments:a});let{gl:l}=this,u=l.bindFramebuffer(36160,this.handle);return i&&this._setReadBuffer(i),n&&this._setDrawBuffers(n),l.bindFramebuffer(36160,u||null),this}resize(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{width:t,height:i}=e;if(this.handle===null)return J(t===void 0&&i===void 0),this.width=this.gl.drawingBufferWidth,this.height=this.gl.drawingBufferHeight,this;t===void 0&&(t=this.gl.drawingBufferWidth),i===void 0&&(i=this.gl.drawingBufferHeight),t!==this.width&&i!==this.height&&se.log(2,"Resizing framebuffer ".concat(this.id," to ").concat(t,"x").concat(i))();for(let n in this.attachments)this.attachments[n].resize({width:t,height:i});return this.width=t,this.height=i,this}attach(e){let{clearAttachments:t=!1,resizeAttachments:i=!0}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},n={};t&&Object.keys(this.attachments).forEach(a=>{n[a]=null}),Object.assign(n,e);let o=this.gl.bindFramebuffer(36160,this.handle);for(let a in n){J(a!==void 0,"Misspelled framebuffer binding point?");let l=Number(a),u=n[l],c=u;if(!c)this._unattach(l);else if(c instanceof Ni)this._attachRenderbuffer({attachment:l,renderbuffer:c});else if(Array.isArray(u)){let[h,d=0,f=0]=u;c=h,this._attachTexture({attachment:l,texture:h,layer:d,level:f})}else this._attachTexture({attachment:l,texture:c,layer:0,level:0});i&&c&&c.resize({width:this.width,height:this.height})}this.gl.bindFramebuffer(36160,o||null),Object.assign(this.attachments,e),Object.keys(this.attachments).filter(a=>!this.attachments[a]).forEach(a=>{delete this.attachments[a]})}checkStatus(){let{gl:e}=this,t=this.getStatus();if(t!==36053)throw new Error(NG(t));return this}getStatus(){let{gl:e}=this,t=e.bindFramebuffer(36160,this.handle),i=e.checkFramebufferStatus(36160);return e.bindFramebuffer(36160,t||null),i}clear(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{color:t,depth:i,stencil:n,drawBuffers:o=[]}=e,a=this.gl.bindFramebuffer(36160,this.handle);return(t||i||n)&&nl(this.gl,{color:t,depth:i,stencil:n}),o.forEach((l,u)=>{IE(this.gl,{drawBuffer:u,value:l})}),this.gl.bindFramebuffer(36160,a||null),this}readPixels(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return se.error("Framebuffer.readPixels() is no logner supported, use readPixelsToArray(framebuffer)")(),null}readPixelsToBuffer(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return se.error("Framebuffer.readPixelsToBuffer()is no logner supported, use readPixelsToBuffer(framebuffer)")(),null}copyToDataUrl(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return se.error("Framebuffer.copyToDataUrl() is no logner supported, use copyToDataUrl(framebuffer)")(),null}copyToImage(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return se.error("Framebuffer.copyToImage() is no logner supported, use copyToImage(framebuffer)")(),null}copyToTexture(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return se.error("Framebuffer.copyToTexture({...}) is no logner supported, use copyToTexture(source, target, opts})")(),null}blit(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return se.error("Framebuffer.blit({...}) is no logner supported, use blit(source, target, opts)")(),null}invalidate(e){let{attachments:t=[],x:i=0,y:n=0,width:o,height:a}=e,l=Pt(this.gl),u=l.bindFramebuffer(36008,this.handle);return i===0&&n===0&&o===void 0&&a===void 0?l.invalidateFramebuffer(36008,t):l.invalidateFramebuffer(36008,t,i,n,o,a),l.bindFramebuffer(36008,u),this}getAttachmentParameter(e,t,i){let n=this._getAttachmentParameterFallback(t);return n===null&&(this.gl.bindFramebuffer(36160,this.handle),n=this.gl.getFramebufferAttachmentParameter(36160,e,t),this.gl.bindFramebuffer(36160,null)),i&&n>1e3&&(n=_n(this.gl,n)),n}getAttachmentParameters(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:36064,t=arguments.length>1?arguments[1]:void 0,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:this.constructor.ATTACHMENT_PARAMETERS||[],n={};for(let o of i){let a=t?_n(this.gl,o):o;n[a]=this.getAttachmentParameter(e,o,t)}return n}getParameters(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0,t=Object.keys(this.attachments),i={};for(let n of t){let o=Number(n),a=e?_n(this.gl,o):o;i[a]=this.getAttachmentParameters(o,e)}return i}show(){return typeof window<"u"&&window.open(oP(this),"luma-debug-texture"),this}log(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0,t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"";if(e>se.level||typeof window>"u")return this;t=t||"Framebuffer ".concat(this.id);let i=oP(this,{targetMaxHeight:100});return se.image({logLevel:e,message:t,image:i},t)(),this}bind(){let{target:e=36160}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.gl.bindFramebuffer(e,this.handle),this}unbind(){let{target:e=36160}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.gl.bindFramebuffer(e,null),this}_createDefaultAttachments(e,t,i,n,o){let a=null;return e&&(a=a||{},a[36064]=new Ue(this.gl,{id:"".concat(this.id,"-color0"),pixels:null,format:6408,type:5121,width:n,height:o,mipmaps:!1,parameters:{[10241]:9729,[10240]:9729,[10242]:33071,[10243]:33071}}),this.ownResources.push(a[36064])),t&&i?(a=a||{},a[33306]=new Ni(this.gl,{id:"".concat(this.id,"-depth-stencil"),format:35056,width:n,height:111}),this.ownResources.push(a[33306])):t?(a=a||{},a[36096]=new Ni(this.gl,{id:"".concat(this.id,"-depth"),format:33189,width:n,height:o}),this.ownResources.push(a[36096])):i&&J(!1),a}_unattach(e){let t=this.attachments[e];!t||(t instanceof Ni?this.gl.framebufferRenderbuffer(36160,e,36161,null):this.gl.framebufferTexture2D(36160,e,3553,null,0),delete this.attachments[e])}_attachRenderbuffer(e){let{attachment:t=36064,renderbuffer:i}=e,{gl:n}=this;n.framebufferRenderbuffer(36160,t,36161,i.handle),this.attachments[t]=i}_attachTexture(e){let{attachment:t=36064,texture:i,layer:n,level:o}=e,{gl:a}=this;switch(a.bindTexture(i.target,i.handle),i.target){case 35866:case 32879:Pt(a).framebufferTextureLayer(36160,t,i.target,o,n);break;case 34067:let u=_G(n);a.framebufferTexture2D(36160,t,u,i.handle,o);break;case 3553:a.framebufferTexture2D(36160,t,3553,i.handle,o);break;default:J(!1,"Illegal texture type")}a.bindTexture(i.target,null),this.attachments[t]=i}_setReadBuffer(e){let t=dE(this.gl);t?t.readBuffer(e):J(e===36064||e===1029,YT),this.readBuffer=e}_setDrawBuffers(e){let{gl:t}=this,i=Pt(t);if(i)i.drawBuffers(e);else{let n=t.getExtension("WEBGL_draw_buffers");n?n.drawBuffersWEBGL(e):J(e.length===1&&(e[0]===36064||e[0]===1029),YT)}this.drawBuffers=e}_getAttachmentParameterFallback(e){let t=aP(this.gl);switch(e){case 36052:return t.WEBGL2?null:0;case 33298:case 33299:case 33300:case 33301:case 33302:case 33303:return t.WEBGL2?null:8;case 33297:return t.WEBGL2?null:5125;case 33296:return!t.WEBGL2&&!t.EXT_sRGB?9729:null;default:return null}}_createHandle(){return this.gl.createFramebuffer()}_deleteHandle(){this.gl.deleteFramebuffer(this.handle)}_bindHandle(e){return this.gl.bindFramebuffer(36160,e)}};function _G(s){return s<34069?s+34069:s}function NG(s){return(De.STATUS||{})[s]||"Framebuffer error ".concat(s)}var MG=[36049,36048,33296,33298,33299,33300,33301,33302,33303];De.ATTACHMENT_PARAMETERS=MG;function lP(s,e){J(s instanceof Ue||s instanceof Au||s instanceof Eh);let t=s.constructor,{gl:i,width:n,height:o,format:a,type:l,dataFormat:u,border:c,mipmaps:h}=s,d=Object.assign({width:n,height:o,format:a,type:l,dataFormat:u,border:c,mipmaps:h},e);return new t(i,d)}function qT(s,e){let{gl:t,width:i,height:n,id:o}=s;return new De(t,Object.assign({},e,{id:"framebuffer-for-".concat(o),width:i,height:n,attachments:{[36064]:s}}))}function sl(s){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"unnamed",t=/#define[\s*]SHADER_NAME[\s*]([A-Za-z0-9_-]+)[\s*]/,i=s.match(t);return i?i[1]:e}function LE(s){switch(s){case 35632:return"fragment";case 35633:return"vertex";default:return"unknown type"}}function RE(s,e,t,i){let n=s.split(/\r?\n/),o={},a={},l=i||sl(e)||"(unnamed)",u="".concat(LE(t)," shader ").concat(l);for(let h=0;h<n.length;h++){let d=n[h];if(d.length<=1)continue;let f=d.split(":"),p=f[0],S=parseInt(f[2],10);if(isNaN(S))throw new Error("GLSL compilation error in ".concat(u,": ").concat(s));p!=="WARNING"?o[S]=d:a[S]=d}let c=BG(e);return{shaderName:u,errors:KT(o,c),warnings:KT(a,c)}}function KT(s,e){let t="";for(let i=0;i<e.length;i++){let n=e[i];if(!(!s[i+3]&&!s[i+2]&&!s[i+1])&&(t+="".concat(n,`
`),s[i+1])){let o=s[i+1],a=o.split(":",3),l=a[0],u=parseInt(a[1],10)||0,c=o.substring(a.join(":").length+1).trim();t+=ZT("^^^ ".concat(l,": ").concat(c,`

`),u)}}return t}function BG(s){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1,t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:": ",i=s.split(/\r?\n/),n=String(i.length+e-1).length;return i.map((o,a)=>{let l=String(a+e),u=l.length;return ZT(l,n-u)+t+o})}function ZT(s,e){let t="";for(let i=0;i<e;++i)t+=" ";return"".concat(t).concat(s)}function xh(s){let e=100,t=s.match(/[^\s]+/g);if(t.length>=2&&t[0]==="#version"){let i=parseInt(t[1],10);Number.isFinite(i)&&(e=i)}return e}var DG="Shader: GLSL source code must be a JavaScript string",Iu=class extends Ht{get[Symbol.toStringTag](){return"Shader"}static getTypeName(e){switch(e){case 35633:return"vertex-shader";case 35632:return"fragment-shader";default:return J(!1),"unknown"}}constructor(e,t){Vs(e),J(typeof t.source=="string",DG);let i=sl(t.source,null)||t.id||Si("unnamed ".concat(Iu.getTypeName(t.shaderType)));super(e,{id:i}),this.shaderType=t.shaderType,this.source=t.source,this.initialize(t)}initialize(e){let{source:t}=e,i=sl(t,null);i&&(this.id=Si(i)),this._compile(t)}getParameter(e){return this.gl.getShaderParameter(this.handle,e)}toString(){return"".concat(Iu.getTypeName(this.shaderType),":").concat(this.id)}getName(){return sl(this.source)||"unnamed-shader"}getSource(){return this.gl.getShaderSource(this.handle)}getTranslatedSource(){let e=this.gl.getExtension("WEBGL_debug_shaders");return e?e.getTranslatedShaderSource(this.handle):"No translated source available. WEBGL_debug_shaders not implemented"}_compile(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.source;if(e.startsWith("#version ")||(e=`#version 100
`.concat(e)),this.source=e,this.gl.shaderSource(this.handle,this.source),this.gl.compileShader(this.handle),!this.getParameter(35713)){let i=this.gl.getShaderInfoLog(this.handle),{shaderName:n,errors:o,warnings:a}=RE(i,this.source,this.shaderType,this.id);throw se.error("GLSL compilation errors in ".concat(n,`
`).concat(o))(),se.warn("GLSL compilation warnings in ".concat(n,`
`).concat(a))(),new Error("GLSL compilation errors in ".concat(n))}}_deleteHandle(){this.gl.deleteShader(this.handle)}_getOptsFromHandle(){return{type:this.getParameter(35663),source:this.getSource()}}},wu=class extends Iu{get[Symbol.toStringTag](){return"VertexShader"}constructor(e,t){typeof t=="string"&&(t={source:t}),super(e,Object.assign({},t,{shaderType:35633}))}_createHandle(){return this.gl.createShader(35633)}},Lu=class extends Iu{get[Symbol.toStringTag](){return"FragmentShader"}constructor(e,t){typeof t=="string"&&(t={source:t}),super(e,Object.assign({},t,{shaderType:35632}))}_createHandle(){return this.gl.createShader(35632)}};var GG={[5126]:yt.bind(null,"uniform1fv",rn,1,oi),[35664]:yt.bind(null,"uniform2fv",rn,2,oi),[35665]:yt.bind(null,"uniform3fv",rn,3,oi),[35666]:yt.bind(null,"uniform4fv",rn,4,oi),[5124]:yt.bind(null,"uniform1iv",al,1,oi),[35667]:yt.bind(null,"uniform2iv",al,2,oi),[35668]:yt.bind(null,"uniform3iv",al,3,oi),[35669]:yt.bind(null,"uniform4iv",al,4,oi),[35670]:yt.bind(null,"uniform1iv",al,1,oi),[35671]:yt.bind(null,"uniform2iv",al,2,oi),[35672]:yt.bind(null,"uniform3iv",al,3,oi),[35673]:yt.bind(null,"uniform4iv",al,4,oi),[35674]:yt.bind(null,"uniformMatrix2fv",rn,4,zs),[35675]:yt.bind(null,"uniformMatrix3fv",rn,9,zs),[35676]:yt.bind(null,"uniformMatrix4fv",rn,16,zs),[35678]:Gr,[35680]:Gr,[5125]:yt.bind(null,"uniform1uiv",uP,1,oi),[36294]:yt.bind(null,"uniform2uiv",uP,2,oi),[36295]:yt.bind(null,"uniform3uiv",uP,3,oi),[36296]:yt.bind(null,"uniform4uiv",uP,4,oi),[35685]:yt.bind(null,"uniformMatrix2x3fv",rn,6,zs),[35686]:yt.bind(null,"uniformMatrix2x4fv",rn,8,zs),[35687]:yt.bind(null,"uniformMatrix3x2fv",rn,6,zs),[35688]:yt.bind(null,"uniformMatrix3x4fv",rn,12,zs),[35689]:yt.bind(null,"uniformMatrix4x2fv",rn,8,zs),[35690]:yt.bind(null,"uniformMatrix4x3fv",rn,12,zs),[35678]:Gr,[35680]:Gr,[35679]:Gr,[35682]:Gr,[36289]:Gr,[36292]:Gr,[36293]:Gr,[36298]:Gr,[36299]:Gr,[36300]:Gr,[36303]:Gr,[36306]:Gr,[36307]:Gr,[36308]:Gr,[36311]:Gr},FG={},kG={},VG={},QT=[0];function OE(s,e,t,i){e===1&&typeof s=="boolean"&&(s=s?1:0),Number.isFinite(s)&&(QT[0]=s,s=QT);let n=s.length;if(n%e&&se.warn("Uniform size should be multiples of ".concat(e),s)(),s instanceof t)return s;let o=i[n];o||(o=new t(n),i[n]=o);for(let a=0;a<n;a++)o[a]=s[a];return o}function rn(s,e){return OE(s,e,Float32Array,FG)}function al(s,e){return OE(s,e,Int32Array,kG)}function uP(s,e){return OE(s,e,Uint32Array,VG)}function _E(s,e,t){let i=GG[t.type];if(!i)throw new Error("Unknown GLSL uniform type ".concat(t.type));return i().bind(null,s,e)}function JT(s){if(s[s.length-1]!=="]")return{name:s,length:1,isArray:!1};let e=/([^[]*)(\[[0-9]+\])?/,t=s.match(e);if(!t||t.length<2)throw new Error("Failed to parse GLSL uniform name ".concat(s));return{name:t[1],length:t[2]||1,isArray:Boolean(t[2])}}function $T(s,e,t){for(let i in s){let n=s[i];if((!t||Boolean(t[i]))&&!UG(n))throw e=e?"".concat(e," "):"",console.error("".concat(e," Bad uniform ").concat(i),n),new Error("".concat(e," Bad uniform ").concat(i))}return!0}function UG(s){return Array.isArray(s)||ArrayBuffer.isView(s)?zG(s):isFinite(s)||s===!0||s===!1||s instanceof ni||s instanceof Ni?!0:s instanceof De?Boolean(s.texture):!1}function eI(s,e,t){if(Array.isArray(t)||ArrayBuffer.isView(t))if(s[e]){let i=s[e];for(let n=0,o=t.length;n<o;++n)i[n]=t[n]}else s[e]=t.slice();else s[e]=t}function zG(s){if(s.length===0)return!1;let e=Math.min(s.length,16);for(let t=0;t<e;++t)if(!Number.isFinite(s[t]))return!1;return!0}function Gr(){let s=null;return(e,t,i)=>{let n=s!==i;return n&&(e.uniform1i(t,i),s=i),n}}function yt(s,e,t,i){let n=null,o=null;return(a,l,u)=>{let c=e(u,t),h=c.length,d=!1;if(n===null)n=new Float32Array(h),o=h,d=!0;else{J(o===h,"Uniform length cannot change.");for(let f=0;f<h;++f)if(c[f]!==n[f]){d=!0;break}}return d&&(i(a,s,l,c),n.set(c)),d}}function oi(s,e,t,i){s[e](t,i)}function zs(s,e,t,i){s[e](t,!1,i)}var WG=5120,HG=5121,jG=5122,qG=5123,tI=0,cP=1,XG=2,YG=3,hP=4,KG=5,ZG=6,gr=5126,QG=35664,JG=35665,$G=35666,Kf=5124,eF=35667,tF=35668,rF=35669,Zf=5125,iF=36294,nF=36295,oF=36296,sF=35670,aF=35671,lF=35672,uF=35673,cF=35674,hF=35675,dF=35676,fF=35685,gF=35686,pF=35687,mF=35688,bF=35689,PF=35690,NE={[gr]:[gr,1,"float"],[QG]:[gr,2,"vec2"],[JG]:[gr,3,"vec3"],[$G]:[gr,4,"vec4"],[Kf]:[Kf,1,"int"],[eF]:[Kf,2,"ivec2"],[tF]:[Kf,3,"ivec3"],[rF]:[Kf,4,"ivec4"],[Zf]:[Zf,1,"uint"],[iF]:[Zf,2,"uvec2"],[nF]:[Zf,3,"uvec3"],[oF]:[Zf,4,"uvec4"],[sF]:[gr,1,"bool"],[aF]:[gr,2,"bvec2"],[lF]:[gr,3,"bvec3"],[uF]:[gr,4,"bvec4"],[cF]:[gr,8,"mat2"],[fF]:[gr,8,"mat2x3"],[gF]:[gr,8,"mat2x4"],[hF]:[gr,12,"mat3"],[pF]:[gr,12,"mat3x2"],[mF]:[gr,12,"mat3x4"],[dF]:[gr,16,"mat4"],[bF]:[gr,16,"mat4x2"],[PF]:[gr,16,"mat4x3"]};function rI(s){switch(s){case tI:return tI;case cP:return cP;case YG:return cP;case XG:return cP;case hP:return hP;case KG:return hP;case ZG:return hP;default:return J(!1),0}}function ME(s){let e=NE[s];if(!e)return null;let[t,i]=e;return{type:t,components:i}}function dP(s,e){switch(s){case WG:case HG:case jG:case qG:s=gr;break;default:}for(let t in NE){let[i,n,o]=NE[t];if(i===s&&n===e)return{glType:t,name:o}}return null}var Qf=class{constructor(e){this.id=e.id,this.attributeInfos=[],this.attributeInfosByName={},this.attributeInfosByLocation=[],this.varyingInfos=[],this.varyingInfosByName={},Object.seal(this),this._readAttributesFromProgram(e),this._readVaryingsFromProgram(e)}getAttributeInfo(e){let t=Number(e);return Number.isFinite(t)?this.attributeInfosByLocation[t]:this.attributeInfosByName[e]||null}getAttributeLocation(e){let t=this.getAttributeInfo(e);return t?t.location:-1}getAttributeAccessor(e){let t=this.getAttributeInfo(e);return t?t.accessor:null}getVaryingInfo(e){let t=Number(e);return Number.isFinite(t)?this.varyingInfos[t]:this.varyingInfosByName[e]||null}getVaryingIndex(e){let t=this.getVaryingInfo();return t?t.location:-1}getVaryingAccessor(e){let t=this.getVaryingInfo();return t?t.accessor:null}_readAttributesFromProgram(e){let{gl:t}=e,i=t.getProgramParameter(e.handle,35721);for(let n=0;n<i;n++){let{name:o,type:a,size:l}=t.getActiveAttrib(e.handle,n),u=t.getAttribLocation(e.handle,o);u>=0&&this._addAttribute(u,o,a,l)}this.attributeInfos.sort((n,o)=>n.location-o.location)}_readVaryingsFromProgram(e){let{gl:t}=e;if(!ge(t))return;let i=t.getProgramParameter(e.handle,35971);for(let n=0;n<i;n++){let{name:o,type:a,size:l}=t.getTransformFeedbackVarying(e.handle,n);this._addVarying(n,o,a,l)}this.varyingInfos.sort((n,o)=>n.location-o.location)}_addAttribute(e,t,i,n){let{type:o,components:a}=ME(i),l={type:o,size:n*a};this._inferProperties(e,t,l);let u={location:e,name:t,accessor:new fr(l)};this.attributeInfos.push(u),this.attributeInfosByLocation[e]=u,this.attributeInfosByName[u.name]=u}_inferProperties(e,t,i){/instance/i.test(t)&&(i.divisor=1)}_addVarying(e,t,i,n){let{type:o,components:a}=ME(i),l=new fr({type:o,size:n*a}),u={location:e,name:t,accessor:l};this.varyingInfos.push(u),this.varyingInfosByName[u.name]=u}};var iI=4,yF=35981,SF=["setVertexArray","setAttributes","setBuffers","unsetBuffers","use","getUniformCount","getUniformInfo","getUniformLocation","getUniformValue","getVarying","getFragDataLocation","getAttachedShaders","getAttributeCount","getAttributeLocation","getAttributeInfo"],Ws=class extends Ht{get[Symbol.toStringTag](){return"Program"}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(e,t),this.stubRemovedMethods("Program","v6.0",SF),this._isCached=!1,this.initialize(t),Object.seal(this),this._setId(t.id)}initialize(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{hash:t,vs:i,fs:n,varyings:o,bufferMode:a=yF}=e;return this.hash=t||"",this.vs=typeof i=="string"?new wu(this.gl,{id:"".concat(e.id,"-vs"),source:i}):i,this.fs=typeof n=="string"?new Lu(this.gl,{id:"".concat(e.id,"-fs"),source:n}):n,J(this.vs instanceof wu),J(this.fs instanceof Lu),this.uniforms={},this._textureUniforms={},o&&o.length>0&&(Pt(this.gl),this.varyings=o,this.gl2.transformFeedbackVaryings(this.handle,o,a)),this._compileAndLink(),this._readUniformLocationsFromLinkedProgram(),this.configuration=new Qf(this),this.setProps(e)}delete(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this._isCached?this:super.delete(e)}setProps(e){return"uniforms"in e&&this.setUniforms(e.uniforms),this}draw(e){let{logPriority:t,drawMode:i=4,vertexCount:n,offset:o=0,start:a,end:l,isIndexed:u=!1,indexType:c=5123,instanceCount:h=0,isInstanced:d=h>0,vertexArray:f=null,transformFeedback:p,framebuffer:S,parameters:E={},uniforms:C,samplers:O}=e;if((C||O)&&(se.deprecated("Program.draw({uniforms})","Program.setUniforms(uniforms)")(),this.setUniforms(C||{})),se.priority>=t){let B=S?S.id:"default",A="mode=".concat(_n(this.gl,i)," verts=").concat(n," ")+"instances=".concat(h," indexType=").concat(_n(this.gl,c)," ")+"isInstanced=".concat(d," isIndexed=").concat(u," ")+"Framebuffer=".concat(B);se.log(t,A)()}return J(f),this.gl.useProgram(this.handle),!this._areTexturesRenderable()||n===0||d&&h===0?!1:(f.bindForDraw(n,h,()=>{if(S!==void 0&&(E=Object.assign({},E,{framebuffer:S})),p){let B=rI(i);p.begin(B)}this._bindTextures(),pt(this.gl,E,()=>{u&&d?this.gl2.drawElementsInstanced(i,n,c,o,h):u&&ge(this.gl)&&!isNaN(a)&&!isNaN(l)?this.gl2.drawRangeElements(i,a,l,n,c,o):u?this.gl.drawElements(i,n,c,o):d?this.gl2.drawArraysInstanced(i,o,n,h):this.gl.drawArrays(i,o,n)}),p&&p.end()}),!0)}setUniforms(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};se.priority>=2&&$T(e,this.id,this._uniformSetters),this.gl.useProgram(this.handle);for(let t in e){let i=e[t],n=this._uniformSetters[t];if(n){let o=i,a=!1;if(o instanceof De&&(o=o.texture),o instanceof ni)if(a=this.uniforms[t]!==i,a){n.textureIndex===void 0&&(n.textureIndex=this._textureIndexCounter++);let l=o,{textureIndex:u}=n;l.bind(u),o=u,this._textureUniforms[t]=l}else o=n.textureIndex;else this._textureUniforms[t]&&delete this._textureUniforms[t];(n(o)||a)&&eI(this.uniforms,t,i)}}return this}_areTexturesRenderable(){let e=!0;for(let t in this._textureUniforms){let i=this._textureUniforms[t];i.update(),e=e&&i.loaded}return e}_bindTextures(){for(let e in this._textureUniforms){let t=this._uniformSetters[e].textureIndex;this._textureUniforms[e].bind(t)}}_createHandle(){return this.gl.createProgram()}_deleteHandle(){this.gl.deleteProgram(this.handle)}_getOptionsFromHandle(e){let t=this.gl.getAttachedShaders(e),i={};for(let n of t)switch(this.gl.getShaderParameter(this.handle,35663)){case 35633:i.vs=new wu({handle:n});break;case 35632:i.fs=new Lu({handle:n});break;default:}return i}_getParameter(e){return this.gl.getProgramParameter(this.handle,e)}_setId(e){if(!e){let t=this._getName();this.id=Si(t)}}_getName(){let e=this.vs.getName()||this.fs.getName();return e=e.replace(/shader/i,""),e=e?"".concat(e,"-program"):"program",e}_compileAndLink(){let{gl:e}=this;if(e.attachShader(this.handle,this.vs.handle),e.attachShader(this.handle,this.fs.handle),se.time(iI,"linkProgram for ".concat(this._getName()))(),e.linkProgram(this.handle),se.timeEnd(iI,"linkProgram for ".concat(this._getName()))(),e.debug||se.level>0){if(!e.getProgramParameter(this.handle,35714))throw new Error("Error linking: ".concat(e.getProgramInfoLog(this.handle)));if(e.validateProgram(this.handle),!e.getProgramParameter(this.handle,35715))throw new Error("Error validating: ".concat(e.getProgramInfoLog(this.handle)))}}_readUniformLocationsFromLinkedProgram(){let{gl:e}=this;this._uniformSetters={},this._uniformCount=this._getParameter(35718);for(let t=0;t<this._uniformCount;t++){let i=this.gl.getActiveUniform(this.handle,t),{name:n}=JT(i.name),o=e.getUniformLocation(this.handle,n);if(this._uniformSetters[n]=_E(e,o,i),i.size>1)for(let a=0;a<i.size;a++)o=e.getUniformLocation(this.handle,"".concat(n,"[").concat(a,"]")),this._uniformSetters["".concat(n,"[").concat(a,"]")]=_E(e,o,i)}this._textureIndexCounter=0}getActiveUniforms(e,t){return this.gl2.getActiveUniforms(this.handle,e,t)}getUniformBlockIndex(e){return this.gl2.getUniformBlockIndex(this.handle,e)}getActiveUniformBlockParameter(e,t){return this.gl2.getActiveUniformBlockParameter(this.handle,e,t)}uniformBlockBinding(e,t){this.gl2.uniformBlockBinding(this.handle,e,t)}};var EF=34918,xF=34919,vF=35007,CF=36795,AF=35976,TF=35887,IF=36202,Hs=class extends Ht{get[Symbol.toStringTag](){return"Query"}static isSupported(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:[],i=ge(e),n=ol(e,et.TIMER_QUERY),o=i||n;for(let a of t)switch(a){case"queries":o=o&&i;break;case"timers":o=o&&n;break;default:J(!1)}return o}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(e,t),this.target=null,this._queryPending=!1,this._pollingPromise=null,Object.seal(this)}beginTimeElapsedQuery(){return this.begin(vF)}beginOcclusionQuery(){let{conservative:e=!1}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.begin(e?IF:TF)}beginTransformFeedbackQuery(){return this.begin(AF)}begin(e){return this._queryPending?this:(this.target=e,this.gl2.beginQuery(this.target,this.handle),this)}end(){return this._queryPending?this:(this.target&&(this.gl2.endQuery(this.target),this.target=null,this._queryPending=!0),this)}isResultAvailable(){if(!this._queryPending)return!1;let e=this.gl2.getQueryParameter(this.handle,xF);return e&&(this._queryPending=!1),e}isTimerDisjoint(){return this.gl2.getParameter(CF)}getResult(){return this.gl2.getQueryParameter(this.handle,EF)}getTimerMilliseconds(){return this.getResult()/1e6}createPoll(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:Number.POSITIVE_INFINITY;if(this._pollingPromise)return this._pollingPromise;let t=0;return this._pollingPromise=new Promise((i,n)=>{let o=()=>{this.isResultAvailable()?(i(this.getResult()),this._pollingPromise=null):t++>e?(n("Timed out"),this._pollingPromise=null):requestAnimationFrame(o)};requestAnimationFrame(o)}),this._pollingPromise}_createHandle(){return Hs.isSupported(this.gl)?this.gl2.createQuery():null}_deleteHandle(){this.gl2.deleteQuery(this.handle)}};var js=class extends Ht{get[Symbol.toStringTag](){return"TransformFeedback"}static isSupported(e){return ge(e)}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};Pt(e),super(e,t),this.initialize(t),this.stubRemovedMethods("TransformFeedback","v6.0",["pause","resume"]),Object.seal(this)}initialize(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.buffers={},this.unused={},this.configuration=null,this.bindOnUse=!0,ts(this.buffers)||this.bind(()=>this._unbindBuffers()),this.setProps(e),this}setProps(e){"program"in e&&(this.configuration=e.program&&e.program.configuration),"configuration"in e&&(this.configuration=e.configuration),"bindOnUse"in e&&(e=e.bindOnUse),"buffers"in e&&this.setBuffers(e.buffers)}setBuffers(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.bind(()=>{for(let t in e)this.setBuffer(t,e[t])}),this}setBuffer(e,t){let i=this._getVaryingIndex(e),{buffer:n,byteSize:o,byteOffset:a}=this._getBufferParams(t);return i<0?(this.unused[e]=n,se.warn("".concat(this.id," unused varying buffer ").concat(e))(),this):(this.buffers[i]=t,this.bindOnUse||this._bindBuffer(i,n,a,o),this)}begin(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0;return this.gl.bindTransformFeedback(36386,this.handle),this._bindBuffers(),this.gl.beginTransformFeedback(e),this}end(){return this.gl.endTransformFeedback(),this._unbindBuffers(),this.gl.bindTransformFeedback(36386,null),this}_getBufferParams(e){let t,i,n;return e instanceof ye?n=e:(n=e.buffer,i=e.byteSize,t=e.byteOffset),(t!==void 0||i!==void 0)&&(t=t||0,i=i||n.byteLength-t),{buffer:n,byteOffset:t,byteSize:i}}_getVaryingInfo(e){return this.configuration&&this.configuration.getVaryingInfo(e)}_getVaryingIndex(e){if(this.configuration)return this.configuration.getVaryingInfo(e).location;let t=Number(e);return Number.isFinite(t)?t:-1}_bindBuffers(){if(this.bindOnUse)for(let e in this.buffers){let{buffer:t,byteSize:i,byteOffset:n}=this._getBufferParams(this.buffers[e]);this._bindBuffer(e,t,n,i)}}_unbindBuffers(){if(this.bindOnUse)for(let e in this.buffers)this._bindBuffer(e,null)}_bindBuffer(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0,n=arguments.length>3?arguments[3]:void 0,o=t&&t.handle;return!o||n===void 0?this.gl.bindBufferBase(35982,e,o):this.gl.bindBufferRange(35982,e,o,i,n),this}_createHandle(){return this.gl.createTransformFeedback()}_deleteHandle(){this.gl.deleteTransformFeedback(this.handle)}_bindHandle(e){this.gl.bindTransformFeedback(36386,this.handle)}};var fP=null;function wF(s){return(!fP||fP.byteLength<s)&&(fP=new ArrayBuffer(s)),fP}function nI(s,e){let t=wF(s.BYTES_PER_ELEMENT*e);return new s(t,0,e)}function oI(s){let{target:e,source:t,start:i=0,count:n=1}=s,o=t.length,a=n*o,l=0;for(let u=i;l<o;l++)e[u++]=t[l];for(;l<a;)l<a-l?(e.copyWithin(i+l,i,i+l),l*=2):(e.copyWithin(i+l,i,i+a-l),l=a);return e}var LF="elements must be GL.ELEMENT_ARRAY_BUFFER",Fr=class extends Ht{get[Symbol.toStringTag](){return"VertexArrayObject"}static isSupported(e){return(arguments.length>1&&arguments[1]!==void 0?arguments[1]:{}).constantAttributeZero?ge(e)||ph()==="Chrome":!0}static getDefaultArray(e){return e.luma=e.luma||{},e.luma.defaultVertexArray||(e.luma.defaultVertexArray=new Fr(e,{handle:null,isDefaultArray:!0})),e.luma.defaultVertexArray}static getMaxAttributes(e){return Fr.MAX_ATTRIBUTES=Fr.MAX_ATTRIBUTES||e.getParameter(34921),Fr.MAX_ATTRIBUTES}static setConstant(e,t,i){switch(i.constructor){case Float32Array:Fr._setConstantFloatArray(e,t,i);break;case Int32Array:Fr._setConstantIntArray(e,t,i);break;case Uint32Array:Fr._setConstantUintArray(e,t,i);break;default:J(!1)}}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},i=t.id||t.program&&t.program.id;super(e,Object.assign({},t,{id:i})),this.buffer=null,this.bufferValue=null,this.isDefaultArray=t.isDefaultArray||!1,this.gl2=e,this.initialize(t),Object.seal(this)}delete(){return super.delete(),this.buffer&&this.buffer.delete(),this}get MAX_ATTRIBUTES(){return Fr.getMaxAttributes(this.gl)}initialize(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.setProps(e)}setProps(e){return this}setElementBuffer(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:null,t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};return J(!e||e.target===34963,LF),this.bind(()=>{this.gl.bindBuffer(34963,e?e.handle:null)}),this}setBuffer(e,t,i){if(t.target===34963)return this.setElementBuffer(t,i);let{size:n,type:o,stride:a,offset:l,normalized:u,integer:c,divisor:h}=i,{gl:d,gl2:f}=this;return e=Number(e),this.bind(()=>{d.bindBuffer(34962,t.handle),c?(J(ge(d)),f.vertexAttribIPointer(e,n,o,a,l)):d.vertexAttribPointer(e,n,o,u,a,l),d.enableVertexAttribArray(e),f.vertexAttribDivisor(e,h||0)}),this}enable(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return!t&&e===0&&!Fr.isSupported(this.gl,{constantAttributeZero:!0})||(e=Number(e),this.bind(()=>t?this.gl.enableVertexAttribArray(e):this.gl.disableVertexAttribArray(e))),this}getConstantBuffer(e,t){let i=this._normalizeConstantArrayValue(t),n=i.byteLength*e,o=i.length*e,a=!this.buffer;if(this.buffer=this.buffer||new ye(this.gl,n),a=a||this.buffer.reallocate(n),a=a||!this._compareConstantArrayValues(i,this.bufferValue),a){let l=nI(t.constructor,o);oI({target:l,source:i,start:0,count:o}),this.buffer.subData(l),this.bufferValue=t}return this.buffer}_normalizeConstantArrayValue(e){return Array.isArray(e)?new Float32Array(e):e}_compareConstantArrayValues(e,t){if(!e||!t||e.length!==t.length||e.constructor!==t.constructor)return!1;for(let i=0;i<e.length;++i)if(e[i]!==t[i])return!1;return!0}static _setConstantFloatArray(e,t,i){switch(i.length){case 1:e.vertexAttrib1fv(t,i);break;case 2:e.vertexAttrib2fv(t,i);break;case 3:e.vertexAttrib3fv(t,i);break;case 4:e.vertexAttrib4fv(t,i);break;default:J(!1)}}static _setConstantIntArray(e,t,i){switch(J(ge(e)),i.length){case 1:e.vertexAttribI1iv(t,i);break;case 2:e.vertexAttribI2iv(t,i);break;case 3:e.vertexAttribI3iv(t,i);break;case 4:e.vertexAttribI4iv(t,i);break;default:J(!1)}}static _setConstantUintArray(e,t,i){switch(J(ge(e)),i.length){case 1:e.vertexAttribI1uiv(t,i);break;case 2:e.vertexAttribI2uiv(t,i);break;case 3:e.vertexAttribI3uiv(t,i);break;case 4:e.vertexAttribI4uiv(t,i);break;default:J(!1)}}_createHandle(){return this.gl.createVertexArray()}_deleteHandle(e){return this.gl2.deleteVertexArray(e),[this.elements]}_bindHandle(e){this.gl2.bindVertexArray(e)}_getParameter(e,t){let{location:i}=t;return J(Number.isFinite(i)),this.bind(()=>{switch(e){case 34373:return this.gl.getVertexAttribOffset(i,e);default:return this.gl.getVertexAttrib(i,e)}})}};var RF="VertexArray: attributes must be Buffers or constants (i.e. typed array)",OF=/^(.+)__LOCATION_([0-9]+)$/,_F=["setBuffers","setGeneric","clearBindings","setLocations","setGenericValues","setDivisor","enable","disable"],vh=class{constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},i=t.id||t.program&&t.program.id;this.id=i,this.gl=e,this.configuration=null,this.elements=null,this.elementsAccessor=null,this.values=null,this.accessors=null,this.unused=null,this.drawParams=null,this.buffer=null,this.attributes={},this.vertexArrayObject=new Fr(e),tP(this,"VertexArray","v6.0",_F),this.initialize(t),Object.seal(this)}delete(){this.buffer&&this.buffer.delete(),this.vertexArrayObject.delete()}initialize(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.reset(),this.configuration=null,this.bindOnUse=!1,this.setProps(e)}reset(){this.elements=null,this.elementsAccessor=null;let{MAX_ATTRIBUTES:e}=this.vertexArrayObject;return this.values=new Array(e).fill(null),this.accessors=new Array(e).fill(null),this.unused={},this.drawParams=null,this}setProps(e){return"program"in e&&(this.configuration=e.program&&e.program.configuration),"configuration"in e&&(this.configuration=e.configuration),"attributes"in e&&this.setAttributes(e.attributes),"elements"in e&&this.setElementBuffer(e.elements),"bindOnUse"in e&&(e=e.bindOnUse),this}clearDrawParams(){this.drawParams=null}getDrawParams(){return this.drawParams=this.drawParams||this._updateDrawParams(),this.drawParams}setAttributes(e){return Object.assign(this.attributes,e),this.vertexArrayObject.bind(()=>{for(let t in e){let i=e[t];this._setAttribute(t,i)}this.gl.bindBuffer(34962,null)}),this}setElementBuffer(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:null,t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};return this.elements=e,this.elementsAccessor=t,this.clearDrawParams(),this.vertexArrayObject.setElementBuffer(e,t),this}setBuffer(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};if(t.target===34963)return this.setElementBuffer(t,i);let{location:n,accessor:o}=this._resolveLocationAndAccessor(e,t,t.accessor,i);return n>=0&&(this.values[n]=t,this.accessors[n]=o,this.clearDrawParams(),this.vertexArrayObject.setBuffer(n,t,o)),this}setConstant(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},{location:n,accessor:o}=this._resolveLocationAndAccessor(e,t,Object.assign({size:t.length},i));return n>=0&&(t=this.vertexArrayObject._normalizeConstantArrayValue(t),this.values[n]=t,this.accessors[n]=o,this.clearDrawParams(),this.vertexArrayObject.enable(n,!1)),this}unbindBuffers(){return this.vertexArrayObject.bind(()=>{this.elements&&this.vertexArrayObject.setElementBuffer(null),this.buffer=this.buffer||new ye(this.gl,{accessor:{size:4}});for(let e=0;e<this.vertexArrayObject.MAX_ATTRIBUTES;e++)this.values[e]instanceof ye&&(this.gl.disableVertexAttribArray(e),this.gl.bindBuffer(34962,this.buffer.handle),this.gl.vertexAttribPointer(e,1,5126,!1,0,0))}),this}bindBuffers(){return this.vertexArrayObject.bind(()=>{this.elements&&this.setElementBuffer(this.elements);for(let e=0;e<this.vertexArrayObject.MAX_ATTRIBUTES;e++){let t=this.values[e];t instanceof ye&&this.setBuffer(e,t)}}),this}bindForDraw(e,t,i){let n;return this.vertexArrayObject.bind(()=>{this._setConstantAttributes(e,t),n=i()}),n}_resolveLocationAndAccessor(e,t,i,n){let o={location:-1,accessor:null},{location:a,name:l}=this._getAttributeIndex(e);if(!Number.isFinite(a)||a<0)return this.unused[e]=t,se.once(3,()=>"unused value ".concat(e," in ").concat(this.id))(),o;let u=this._getAttributeInfo(l||a);if(!u)return o;let c=this.accessors[a]||{},h=fr.resolve(u.accessor,c,i,n),{size:d,type:f}=h;return J(Number.isFinite(d)&&Number.isFinite(f)),{location:a,accessor:h}}_getAttributeInfo(e){return this.configuration&&this.configuration.getAttributeInfo(e)}_getAttributeIndex(e){let t=Number(e);if(Number.isFinite(t))return{location:t};let i=OF.exec(e),n=i?i[1]:e,o=i?Number(i[2]):0;return this.configuration?{location:this.configuration.getAttributeLocation(n)+o,name:n}:{location:-1}}_setAttribute(e,t){if(t instanceof ye)this.setBuffer(e,t);else if(Array.isArray(t)&&t.length&&t[0]instanceof ye){let i=t[0],n=t[1];this.setBuffer(e,i,n)}else if(ArrayBuffer.isView(t)||Array.isArray(t)){let i=t;this.setConstant(e,i)}else if(t.buffer instanceof ye){let i=t;this.setBuffer(e,i.buffer,i)}else throw new Error(RF)}_setConstantAttributes(e,t){let i=Math.max(e|0,t|0),n=this.values[0];ArrayBuffer.isView(n)&&this._setConstantAttributeZero(n,i);for(let o=1;o<this.vertexArrayObject.MAX_ATTRIBUTES;o++)n=this.values[o],ArrayBuffer.isView(n)&&this._setConstantAttribute(o,n)}_setConstantAttributeZero(e,t){if(Fr.isSupported(this.gl,{constantAttributeZero:!0})){this._setConstantAttribute(0,e);return}let i=this.vertexArrayObject.getConstantBuffer(t,e);this.vertexArrayObject.setBuffer(0,i,this.accessors[0])}_setConstantAttribute(e,t){Fr.setConstant(this.gl,e,t)}_updateDrawParams(){let e={isIndexed:!1,isInstanced:!1,indexCount:1/0,vertexCount:1/0,instanceCount:1/0};for(let t=0;t<this.vertexArrayObject.MAX_ATTRIBUTES;t++)this._updateDrawParamsForLocation(e,t);return this.elements&&(e.elementCount=this.elements.getElementCount(this.elements.accessor),e.isIndexed=!0,e.indexType=this.elementsAccessor.type||this.elements.accessor.type,e.indexOffset=this.elementsAccessor.offset||0),e.indexCount===1/0&&(e.indexCount=0),e.vertexCount===1/0&&(e.vertexCount=0),e.instanceCount===1/0&&(e.instanceCount=0),e}_updateDrawParamsForLocation(e,t){let i=this.values[t],n=this.accessors[t];if(!i)return;let{divisor:o}=n,a=o>0;if(e.isInstanced=e.isInstanced||a,i instanceof ye){let l=i;if(a){let u=l.getVertexCount(n);e.instanceCount=Math.min(e.instanceCount,u)}else{let u=l.getVertexCount(n);e.vertexCount=Math.min(e.vertexCount,u)}}}setElements(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:null,t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};return se.deprecated("setElements","setElementBuffer")(),this.setElementBuffer(e,t)}};function NF(s,e){let{maxElts:t=16,size:i=1}=e,n="[";for(let a=0;a<s.length&&a<t;++a)a>0&&(n+=",".concat(a%i===0?" ":"")),n+=Ru(s[a],e);let o=s.length>t?"...":"]";return"".concat(n).concat(o)}function Ru(s){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},t=1e-16,{isInteger:i=!1}=e;if(Array.isArray(s)||ArrayBuffer.isView(s))return NF(s,e);if(!Number.isFinite(s))return String(s);if(Math.abs(s)<t)return i?"0":"0.";if(i||Math.abs(s)>100&&Math.abs(s)<1e4)return s.toFixed(0);let n=s.toPrecision(2);return n.indexOf(".0")===n.length-2?n.slice(0,-1):n}function gP(s){let{header:e="Uniforms",program:t,uniforms:i,undefinedOnly:n=!1}=s;J(t);let o=".*_.*",a=".*Matrix",l=t._uniformSetters,u={},c=Object.keys(l).sort(),h=0;for(let p of c)!p.match(o)&&!p.match(a)&&BE({table:u,header:e,uniforms:i,uniformName:p,undefinedOnly:n})&&h++;for(let p of c)p.match(a)&&BE({table:u,header:e,uniforms:i,uniformName:p,undefinedOnly:n})&&h++;for(let p of c)u[p]||BE({table:u,header:e,uniforms:i,uniformName:p,undefinedOnly:n})&&h++;let d=0,f={};if(!n)for(let p in i){let S=i[p];u[p]||(d++,f[p]={Type:"NOT USED: ".concat(S),[e]:Ru(S)})}return{table:u,count:h,unusedTable:f,unusedCount:d}}function BE(s){let{table:e,header:t,uniforms:i,uniformName:n,undefinedOnly:o}=s,a=i[n],l=MF(a);return!o||!l?(e[n]={[t]:l?Ru(a):"N/A","Uniform Type":l?a:"NOT PROVIDED"},!0):!1}function MF(s){return s!=null}function DE(s){let{vertexArray:e,header:t="Attributes"}=s;if(!e.configuration)return{};let i={};e.elements&&(i.ELEMENT_ARRAY_BUFFER=sI(e,e.elements,null,t));let n=e.values;for(let o in n){let a=e._getAttributeInfo(o);if(a){let l="".concat(o,": ").concat(a.name),u=e.accessors[a.location];u&&(l="".concat(o,": ").concat(BF(a.name,u))),i[l]=sI(e,n[o],u,t)}}return i}function sI(s,e,t,i){let{gl:n}=s;if(!e)return{[i]:"null","Format ":"N/A"};let o="NOT PROVIDED",a=1,l=0,u=0,c,h,d;if(t&&(o=t.type,a=t.size,o=String(o).replace("Array",""),c=o.indexOf("nt")!==-1),e instanceof ye){let f=e,{data:p,changed:S}=f.getDebugData();h=S?"*":"",d=p,u=f.byteLength,l=u/p.BYTES_PER_ELEMENT/a;let E;if(t){let C=t.divisor>0;E="".concat(C?"I ":"P "," ").concat(l," (x").concat(a,"=").concat(u," bytes ").concat(_n(n,o),")")}else c=!0,E="".concat(u," bytes");return{[i]:"".concat(h).concat(Ru(d,{size:a,isInteger:c})),"Format ":E}}return d=e,a=e.length,o=String(e.constructor.name).replace("Array",""),c=o.indexOf("nt")!==-1,{[i]:"".concat(Ru(d,{size:a,isInteger:c})," (constant)"),"Format ":"".concat(a,"x").concat(o," (constant)")}}function BF(s,e){let{type:t,size:i}=e,n=dP(t,i);return n?"".concat(s," (").concat(n.name,")"):s}function GE(s){let e={},t="Accessors for ".concat(s.id);for(let i of s.attributeInfos)if(i){let n=aI(i);e["in ".concat(n)]={[t]:JSON.stringify(i.accessor)}}for(let i of s.varyingInfos)if(i){let n=aI(i);e["out ".concat(n)]={[t]:JSON.stringify(i.accessor)}}return e}function aI(s){let{type:e,size:t}=s.accessor,i=dP(e,t);return i?"".concat(i.name," ").concat(s.name):s.name}var lI=dr()&&typeof document<"u",GF=0,Ou=class{constructor(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{onCreateContext:t=C=>yh(C),onAddHTML:i=null,onInitialize:n=()=>{},onRender:o=()=>{},onFinalize:a=()=>{},onError:l,gl:u=null,glOptions:c={},debug:h=!1,createFramebuffer:d=!1,autoResizeViewport:f=!0,autoResizeDrawingBuffer:p=!0,stats:S=On.get("animation-loop-".concat(GF++))}=e,{useDevicePixels:E=!0}=e;"useDevicePixelRatio"in e&&(se.deprecated("useDevicePixelRatio","useDevicePixels")(),E=e.useDevicePixelRatio),this.props={onCreateContext:t,onAddHTML:i,onInitialize:n,onRender:o,onFinalize:a,onError:l,gl:u,glOptions:c,debug:h,createFramebuffer:d},this.gl=u,this.needsRedraw=null,this.timeline=null,this.stats=S,this.cpuTime=this.stats.get("CPU Time"),this.gpuTime=this.stats.get("GPU Time"),this.frameRate=this.stats.get("Frame Rate"),this._initialized=!1,this._running=!1,this._animationFrameId=null,this._nextFramePromise=null,this._resolveNextFrame=null,this._cpuStartTime=0,this.setProps({autoResizeViewport:f,autoResizeDrawingBuffer:p,useDevicePixels:E}),this.start=this.start.bind(this),this.stop=this.stop.bind(this),this._pageLoadPromise=null,this._onMousemove=this._onMousemove.bind(this),this._onMouseleave=this._onMouseleave.bind(this)}delete(){this.stop(),this._setDisplay(null)}setNeedsRedraw(e){return J(typeof e=="string"),this.needsRedraw=this.needsRedraw||e,this}setProps(e){return"autoResizeViewport"in e&&(this.autoResizeViewport=e.autoResizeViewport),"autoResizeDrawingBuffer"in e&&(this.autoResizeDrawingBuffer=e.autoResizeDrawingBuffer),"useDevicePixels"in e&&(this.useDevicePixels=e.useDevicePixels),this}start(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(this._running)return this;this._running=!0;let t=this._getPageLoadPromise().then(()=>!this._running||this._initialized?null:(this._createWebGLContext(e),this._createFramebuffer(),this._startEventHandling(),this._initializeCallbackData(),this._updateCallbackData(),this._resizeCanvasDrawingBuffer(),this._resizeViewport(),this._gpuTimeQuery=Hs.isSupported(this.gl,["timers"])?new Hs(this.gl):null,this._initialized=!0,this.onInitialize(this.animationProps))).then(i=>{this._running&&(this._addCallbackData(i||{}),i!==!1&&this._startLoop())});return this.props.onError&&t.catch(this.props.onError),this}redraw(){return this.isContextLost()?this:(this._beginTimers(),this._setupFrame(),this._updateCallbackData(),this._renderFrame(this.animationProps),this._clearNeedsRedraw(),this.offScreen&&this.gl.commit&&this.gl.commit(),this._resolveNextFrame&&(this._resolveNextFrame(this),this._nextFramePromise=null,this._resolveNextFrame=null),this._endTimers(),this)}stop(){return this._running&&(this._finalizeCallbackData(),this._cancelAnimationFrame(this._animationFrameId),this._nextFramePromise=null,this._resolveNextFrame=null,this._animationFrameId=null,this._running=!1),this}attachTimeline(e){return this.timeline=e,this.timeline}detachTimeline(){this.timeline=null}waitForRender(){return this.setNeedsRedraw("waitForRender"),this._nextFramePromise||(this._nextFramePromise=new Promise(e=>{this._resolveNextFrame=e})),this._nextFramePromise}async toDataURL(){return this.setNeedsRedraw("toDataURL"),await this.waitForRender(),this.gl.canvas.toDataURL()}isContextLost(){return this.gl.isContextLost()}onCreateContext(){return this.props.onCreateContext(...arguments)}onInitialize(){return this.props.onInitialize(...arguments)}onRender(){return this.props.onRender(...arguments)}onFinalize(){return this.props.onFinalize(...arguments)}getHTMLControlValue(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1,i=document.getElementById(e);return i?Number(i.value):t}setViewParameters(){return se.removed("AnimationLoop.setViewParameters","AnimationLoop.setProps")(),this}_startLoop(){let e=()=>{!this._running||(this.redraw(),this._animationFrameId=this._requestAnimationFrame(e))};this._cancelAnimationFrame(this._animationFrameId),this._animationFrameId=this._requestAnimationFrame(e)}_getPageLoadPromise(){return this._pageLoadPromise||(this._pageLoadPromise=lI?new Promise((e,t)=>{if(lI&&document.readyState==="complete"){e(document);return}window.addEventListener("load",()=>{e(document)})}):Promise.resolve({})),this._pageLoadPromise}_setDisplay(e){this.display&&(this.display.delete(),this.display.animationLoop=null),e&&(e.animationLoop=this),this.display=e}_cancelAnimationFrame(e){return this.display&&this.display.cancelAnimationFrame?this.display.cancelAnimationFrame(e):xE(e)}_requestAnimationFrame(e){if(this._running)return this.display&&this.display.requestAnimationFrame?this.display.requestAnimationFrame(e):EE(e)}_renderFrame(){if(this.display){this.display._renderFrame(...arguments);return}this.onRender(...arguments)}_clearNeedsRedraw(){this.needsRedraw=null}_setupFrame(){this._resizeCanvasDrawingBuffer(),this._resizeViewport(),this._resizeFramebuffer()}_initializeCallbackData(){this.animationProps={gl:this.gl,stop:this.stop,canvas:this.gl.canvas,framebuffer:this.framebuffer,useDevicePixels:this.useDevicePixels,needsRedraw:null,startTime:Date.now(),engineTime:0,tick:0,tock:0,time:0,_timeline:this.timeline,_loop:this,_animationLoop:this,_mousePosition:null}}_updateCallbackData(){let{width:e,height:t,aspect:i}=this._getSizeAndAspect();(e!==this.animationProps.width||t!==this.animationProps.height)&&this.setNeedsRedraw("drawing buffer resized"),i!==this.animationProps.aspect&&this.setNeedsRedraw("drawing buffer aspect changed"),this.animationProps.width=e,this.animationProps.height=t,this.animationProps.aspect=i,this.animationProps.needsRedraw=this.needsRedraw,this.animationProps.engineTime=Date.now()-this.animationProps.startTime,this.timeline&&this.timeline.update(this.animationProps.engineTime),this.animationProps.tick=Math.floor(this.animationProps.time/1e3*60),this.animationProps.tock++,this.animationProps.time=this.timeline?this.timeline.getTime():this.animationProps.engineTime,this.animationProps._offScreen=this.offScreen}_finalizeCallbackData(){this.onFinalize(this.animationProps)}_addCallbackData(e){typeof e=="object"&&e!==null&&(this.animationProps=Object.assign({},this.animationProps,e))}_createWebGLContext(e){if(this.offScreen=e.canvas&&typeof OffscreenCanvas<"u"&&e.canvas instanceof OffscreenCanvas,e=Object.assign({},e,this.props.glOptions),this.gl=this.props.gl?Cu(this.props.gl,e):this.onCreateContext(e),!ks(this.gl))throw new Error("AnimationLoop.onCreateContext - illegal context returned");$b(this.gl),this._createInfoDiv()}_createInfoDiv(){if(this.gl.canvas&&this.props.onAddHTML){let e=document.createElement("div");document.body.appendChild(e),e.style.position="relative";let t=document.createElement("div");t.style.position="absolute",t.style.left="10px",t.style.bottom="10px",t.style.width="300px",t.style.background="white",e.appendChild(this.gl.canvas),e.appendChild(t);let i=this.props.onAddHTML(t);i&&(t.innerHTML=i)}}_getSizeAndAspect(){let e=this.gl.drawingBufferWidth,t=this.gl.drawingBufferHeight,i=1,{canvas:n}=this.gl;return n&&n.clientHeight?i=n.clientWidth/n.clientHeight:e>0&&t>0&&(i=e/t),{width:e,height:t,aspect:i}}_resizeViewport(){this.autoResizeViewport&&this.gl.viewport(0,0,this.gl.drawingBufferWidth,this.gl.drawingBufferHeight)}_resizeCanvasDrawingBuffer(){this.autoResizeDrawingBuffer&&SE(this.gl,{useDevicePixels:this.useDevicePixels})}_createFramebuffer(){this.props.createFramebuffer&&(this.framebuffer=new De(this.gl))}_resizeFramebuffer(){this.framebuffer&&this.framebuffer.resize({width:this.gl.drawingBufferWidth,height:this.gl.drawingBufferHeight})}_beginTimers(){this.frameRate.timeEnd(),this.frameRate.timeStart(),this._gpuTimeQuery&&this._gpuTimeQuery.isResultAvailable()&&!this._gpuTimeQuery.isTimerDisjoint()&&this.stats.get("GPU Time").addTime(this._gpuTimeQuery.getTimerMilliseconds()),this._gpuTimeQuery&&this._gpuTimeQuery.beginTimeElapsedQuery(),this.cpuTime.timeStart()}_endTimers(){this.cpuTime.timeEnd(),this._gpuTimeQuery&&this._gpuTimeQuery.end()}_startEventHandling(){let{canvas:e}=this.gl;e&&(e.addEventListener("mousemove",this._onMousemove),e.addEventListener("mouseleave",this._onMouseleave))}_onMousemove(e){this.animationProps._mousePosition=[e.offsetX,e.offsetY]}_onMouseleave(e){this.animationProps._mousePosition=null}};var _u="vs",Jf="fs";function jt(s,e){if(!s)throw new Error(e||"shadertools: assertion failed.")}var FE={number:{validate(s,e){return Number.isFinite(s)&&(!("max"in e)||s<=e.max)&&(!("min"in e)||s>=e.min)}},array:{validate(s,e){return Array.isArray(s)||ArrayBuffer.isView(s)}}};function cI(s){let e={};for(let t in s){let i=s[t],n=FF(i);e[t]=n}return e}function FF(s){let e=uI(s);return e==="object"?s?"type"in s?Object.assign({},s,FE[s.type]):"value"in s?(e=uI(s.value),Object.assign({type:e},s,FE[e])):{type:"object",value:s}:{type:"object",value:null}:Object.assign({type:e,value:s},FE[e])}function uI(s){return Array.isArray(s)||ArrayBuffer.isView(s)?"array":typeof s}var kF="vs",VF="fs",Ch=class{constructor(e){let{name:t,vs:i,fs:n,dependencies:o=[],uniforms:a,getUniforms:l,deprecations:u=[],defines:c={},inject:h={},vertexShader:d,fragmentShader:f}=e;jt(typeof t=="string"),this.name=t,this.vs=i||d,this.fs=n||f,this.getModuleUniforms=l,this.dependencies=o,this.deprecations=this._parseDeprecationDefinitions(u),this.defines=c,this.injections=UF(h),a&&(this.uniforms=cI(a))}getModuleSource(e){let t;switch(e){case kF:t=this.vs||"";break;case VF:t=this.fs||"";break;default:jt(!1)}return"#define MODULE_".concat(this.name.toUpperCase().replace(/[^0-9a-z]/gi,"_"),`
`).concat(t,"// END MODULE_").concat(this.name,`

`)}getUniforms(e,t){return this.getModuleUniforms?this.getModuleUniforms(e,t):this.uniforms?this._defaultGetUniforms(e):{}}getDefines(){return this.defines}checkDeprecations(e,t){this.deprecations.forEach(i=>{i.regex.test(e)&&(i.deprecated?t.deprecated(i.old,i.new)():t.removed(i.old,i.new)())})}_parseDeprecationDefinitions(e){return e.forEach(t=>{switch(t.type){case"function":t.regex=new RegExp("\\b".concat(t.old,"\\("));break;default:t.regex=new RegExp("".concat(t.type," ").concat(t.old,";"))}}),e}_defaultGetUniforms(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t={},i=this.uniforms;for(let n in i){let o=i[n];n in e&&!o.private?(o.validate&&jt(o.validate(e[n],o),"".concat(this.name,": invalid ").concat(n)),t[n]=e[n]):t[n]=o.value}return t}};function UF(s){let e={vs:{},fs:{}};for(let t in s){let i=s[t],n=t.slice(0,2);typeof i=="string"&&(i={order:0,injection:i}),e[n][t]=i}return e}function hI(s){return zF(fI(s))}function zF(s){let e={},t={};return dI({modules:s,level:0,moduleMap:e,moduleDepth:t}),Object.keys(t).sort((i,n)=>t[n]-t[i]).map(i=>e[i])}function dI(s){let{modules:e,level:t,moduleMap:i,moduleDepth:n}=s;if(t>=5)throw new Error("Possible loop in shader dependency graph");for(let o of e)i[o.name]=o,(n[o.name]===void 0||n[o.name]<t)&&(n[o.name]=t);for(let o of e)o.dependencies&&dI({modules:o.dependencies,level:t+1,moduleMap:i,moduleDepth:n})}function fI(s,e){return s.map(t=>(t instanceof Ch||(jt(typeof t!="string","Shader module use by name is deprecated. Import shader module '".concat(t,"' and use it directly.")),jt(t.name,"shader module has no name"),t=new Ch(t),t.dependencies=fI(t.dependencies)),t))}function kE(){let s=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=typeof window<"u"?window.navigator||{}:{},t=s.userAgent||e.userAgent||"",i=t.indexOf("MSIE ")!==-1,n=t.indexOf("Trident/")!==-1;return i||n}var WF=7936,HF=7937,jF=7938,qF=35724,UE={GLSL_FRAG_DATA:["WEBGL_draw_buffers",!0],GLSL_FRAG_DEPTH:["EXT_frag_depth",!0],GLSL_DERIVATIVES:["OES_standard_derivatives",!0],GLSL_TEXTURE_LOD:["EXT_shader_texture_lod",!0]},ll={};Object.keys(UE).forEach(s=>{ll[s]=s});function XF(s){return typeof WebGL2RenderingContext<"u"&&s instanceof WebGL2RenderingContext?!0:Boolean(s&&s._version===2)}function gI(s){let e=s.getExtension("WEBGL_debug_renderer_info"),t=s.getParameter(e&&e.UNMASKED_VENDOR_WEBGL||WF),i=s.getParameter(e&&e.UNMASKED_RENDERER_WEBGL||HF);return{gpuVendor:YF(t,i),vendor:t,renderer:i,version:s.getParameter(jF),shadingLanguageVersion:s.getParameter(qF)}}function YF(s,e){return s.match(/NVIDIA/i)||e.match(/NVIDIA/i)?"NVIDIA":s.match(/INTEL/i)||e.match(/INTEL/i)?"INTEL":s.match(/AMD/i)||e.match(/AMD/i)||s.match(/ATI/i)||e.match(/ATI/i)?"AMD":"UNKNOWN GPU"}var VE={};function zE(s,e){let t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},i=UE[e];if(jt(i,e),!kE(t))return!0;if(e in VE)return VE[e];let n=i[0],o=t.behavior||"enable",a="#extension GL_".concat(n," : ").concat(o,`
void main(void) {}`),l=s.createShader(35633);s.shaderSource(l,a),s.compileShader(l);let u=s.getShaderParameter(l,35713);return s.deleteShader(l),VE[e]=u,u}function KF(s,e){let t=UE[e];jt(t,e);let i=XF(s)&&t[1]||t[0],n=typeof i=="string"?Boolean(s.getExtension(i)):i;return jt(n===!1||n===!0),n}function $f(s,e){return e=Array.isArray(e)?e:[e],e.every(t=>KF(s,t))}function pI(s){switch(gI(s).gpuVendor.toLowerCase()){case"nvidia":return`#define NVIDIA_GPU
// Nvidia optimizes away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
`;case"intel":return`#define INTEL_GPU
// Intel optimizes away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
// Intel's built-in 'tan' function doesn't have acceptable precision
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
// Intel GPU doesn't have full 32 bits precision in same cases, causes overflow
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`;case"amd":return`#define AMD_GPU
`;default:return`#define DEFAULT_GPU
// Prevent driver from optimizing away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
// Intel's built-in 'tan' function doesn't have acceptable precision
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
// Intel GPU doesn't have full 32 bits precision in same cases, causes overflow
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`}}function mI(s,e,t){let i=`#if (__VERSION__ > 120)

# define FEATURE_GLSL_DERIVATIVES
# define FEATURE_GLSL_DRAW_BUFFERS
# define FEATURE_GLSL_FRAG_DEPTH
# define FEATURE_GLSL_TEXTURE_LOD

// DEPRECATED FLAGS, remove in v9
# define FRAG_DEPTH
# define DERIVATIVES
# define DRAW_BUFFERS
# define TEXTURE_LOD

#endif // __VERSION
`;return $f(s,ll.GLSL_FRAG_DEPTH)&&(i+=`
// FRAG_DEPTH => gl_FragDepth is available
#ifdef GL_EXT_frag_depth
#extension GL_EXT_frag_depth : enable
# define FEATURE_GLSL_FRAG_DEPTH
# define FRAG_DEPTH
# define gl_FragDepth gl_FragDepthEXT
#endif
`),$f(s,ll.GLSL_DERIVATIVES)&&zE(s,ll.GLSL_DERIVATIVES)&&(i+=`
// DERIVATIVES => dxdF, dxdY and fwidth are available
#ifdef GL_OES_standard_derivatives
#extension GL_OES_standard_derivatives : enable
# define FEATURE_GLSL_DERIVATIVES
# define DERIVATIVES
#endif
`),$f(s,ll.GLSL_FRAG_DATA)&&zE(s,ll.GLSL_FRAG_DATA,{behavior:"require"})&&(i+=`
// DRAW_BUFFERS => gl_FragData[] is available
#ifdef GL_EXT_draw_buffers
#extension GL_EXT_draw_buffers : require
#define FEATURE_GLSL_DRAW_BUFFERS
#define DRAW_BUFFERS
#endif
`),$f(s,ll.GLSL_TEXTURE_LOD)&&(i+=`// TEXTURE_LOD => texture2DLod etc are available
#ifdef GL_EXT_shader_texture_lod
#extension GL_EXT_shader_texture_lod : enable

# define FEATURE_GLSL_TEXTURE_LOD
# define TEXTURE_LOD

#endif
`),i}var bI=`#ifdef MODULE_LOGDEPTH
  logdepth_adjustPosition(gl_Position);
#endif
`,PI=`#ifdef MODULE_MATERIAL
  gl_FragColor = material_filterColor(gl_FragColor);
#endif

#ifdef MODULE_LIGHTING
  gl_FragColor = lighting_filterColor(gl_FragColor);
#endif

#ifdef MODULE_FOG
  gl_FragColor = fog_filterColor(gl_FragColor);
#endif

#ifdef MODULE_PICKING
  gl_FragColor = picking_filterHighlightColor(gl_FragColor);
  gl_FragColor = picking_filterPickingColor(gl_FragColor);
#endif

#ifdef MODULE_LOGDEPTH
  logdepth_setFragDepth();
#endif
`;var ZF={[_u]:bI,[Jf]:PI},eg="__LUMA_INJECT_DECLARATIONS__",yI=/void\s+main\s*\([^)]*\)\s*\{\n?/,SI=/}\n?[^{}]*$/,WE=[];function pP(s,e,t){let i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1,n=e===_u;for(let o in t){let a=t[o];a.sort((u,c)=>u.order-c.order),WE.length=a.length;for(let u=0,c=a.length;u<c;++u)WE[u]=a[u].injection;let l="".concat(WE.join(`
`),`
`);switch(o){case"vs:#decl":n&&(s=s.replace(eg,l));break;case"vs:#main-start":n&&(s=s.replace(yI,u=>u+l));break;case"vs:#main-end":n&&(s=s.replace(SI,u=>l+u));break;case"fs:#decl":n||(s=s.replace(eg,l));break;case"fs:#main-start":n||(s=s.replace(yI,u=>u+l));break;case"fs:#main-end":n||(s=s.replace(SI,u=>l+u));break;default:s=s.replace(o,u=>u+l)}}return s=s.replace(eg,""),i&&(s=s.replace(/\}\s*$/,o=>o+ZF[e])),s}function Ah(s){let e={};return jt(Array.isArray(s)&&s.length>1),s.forEach(t=>{for(let i in t)e[i]=e[i]?"".concat(e[i],`
`).concat(t[i]):t[i]}),e}function Th(s){return new RegExp("\\b".concat(s,"[ \\t]+(\\w+[ \\t]+\\w+(\\[\\w+\\])?;)"),"g")}var EI=[[/^(#version[ \t]+(100|300[ \t]+es))?[ \t]*\n/,`#version 300 es
`],[/\btexture(2D|2DProj|Cube)Lod(EXT)?\(/g,"textureLod("],[/\btexture(2D|2DProj|Cube)(EXT)?\(/g,"texture("]],QF=[...EI,[Th("attribute"),"in $1"],[Th("varying"),"out $1"]],JF=[...EI,[Th("varying"),"in $1"]],xI=[[/^#version[ \t]+300[ \t]+es/,"#version 100"],[/\btexture(2D|2DProj|Cube)Lod\(/g,"texture$1LodEXT("],[/\btexture\(/g,"texture2D("],[/\btextureLod\(/g,"texture2DLodEXT("]],$F=[...xI,[Th("in"),"attribute $1"],[Th("out"),"varying $1"]],ek=[...xI,[Th("in"),"varying $1"]],HE="gl_FragColor",jE=/\bout[ \t]+vec4[ \t]+(\w+)[ \t]*;\n?/,tk=/void\s+main\s*\([^)]*\)\s*\{\n?/;function qE(s,e,t){switch(e){case 300:return t?mP(s,QF):rk(s);case 100:return t?mP(s,$F):ik(s);default:throw new Error("unknown GLSL version ".concat(e))}}function mP(s,e){for(let[t,i]of e)s=s.replace(t,i);return s}function rk(s){s=mP(s,JF);let e=s.match(jE);if(e){let t=e[1];s=s.replace(new RegExp("\\b".concat(HE,"\\b"),"g"),t)}else{let t="fragmentColor";s=s.replace(tk,i=>"out vec4 ".concat(t,`;
`).concat(i)).replace(new RegExp("\\b".concat(HE,"\\b"),"g"),t)}return s}function ik(s){s=mP(s,ek);let e=s.match(jE);if(e){let t=e[1];s=s.replace(jE,"").replace(new RegExp("\\b".concat(t,"\\b"),"g"),HE)}return s}var nk=`

`.concat(eg,`

`),CI={[_u]:"vertex",[Jf]:"fragment"},ok=`precision highp float;

`;function XE(s,e){let{vs:t,fs:i}=e,n=hI(e.modules||[]);return{gl:s,vs:vI(s,Object.assign({},e,{source:t,type:_u,modules:n})),fs:vI(s,Object.assign({},e,{source:i,type:Jf,modules:n})),getUniforms:sk(n)}}function vI(s,e){let{id:t,source:i,type:n,modules:o,defines:a={},hookFunctions:l=[],inject:u={},transpileToGLSL100:c=!1,prologue:h=!0,log:d}=e;jt(typeof i=="string","shader source must be a string");let f=n===_u,p=i.split(`
`),S=100,E="",C=i;p[0].indexOf("#version ")===0?(S=300,E=p[0],C=p.slice(1).join(`
`)):E="#version ".concat(S);let O={};o.forEach(ie=>{Object.assign(O,ie.getDefines())}),Object.assign(O,a);let B=h?"".concat(E,`
`).concat(lk({id:t,source:i,type:n}),`
`).concat(ak({type:n}),`
`).concat(pI(s),`
`).concat(mI(s,S,!f),`
`).concat(uk(O),`
`).concat(f?"":ok,`
`):"".concat(E,`
`),A=hk(l),N={},z={},Y={};for(let ie in u){let he=typeof u[ie]=="string"?{injection:u[ie],order:0}:u[ie],ae=ie.match(/^(v|f)s:(#)?([\w-]+)$/);if(ae){let D=ae[2],_=ae[3];D?_==="decl"?z[ie]=[he]:Y[ie]=[he]:N[ie]=[he]}else Y[ie]=[he]}for(let ie of o){d&&ie.checkDeprecations(C,d),B+=ie.getModuleSource(n,S);let ae=ie.injections[n];for(let D in ae){let _=D.match(/^(v|f)s:#([\w-]+)$/);if(_){let H=_[2]==="decl"?z:Y;H[D]=H[D]||[],H[D].push(ae[D])}else N[D]=N[D]||[],N[D].push(ae[D])}}return B+=nk,B=pP(B,n,z),B+=ck(A[n],N),B+=C,B=pP(B,n,Y),B=qE(B,c?100:S,f),B}function sk(s){return function(t){let i={};for(let n of s){let o=n.getUniforms(t,i);Object.assign(i,o)}return i}}function ak(s){let{type:e}=s;return`
#define SHADER_TYPE_`.concat(CI[e].toUpperCase(),`
`)}function lk(s){let{id:e,source:t,type:i}=s;return e&&typeof e=="string"&&t.indexOf("SHADER_NAME")===-1?`
#define SHADER_NAME `.concat(e,"_").concat(CI[i],`

`):""}function uk(){let s=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=0,t="";for(let i in s){e===0&&(t+=`
// APPLICATION DEFINES
`),e++;let n=s[i];(n||Number.isFinite(n))&&(t+="#define ".concat(i.toUpperCase()," ").concat(s[i],`
`))}return e===0&&(t+=`
`),t}function ck(s,e){let t="";for(let i in s){let n=s[i];if(t+="void ".concat(n.signature,` {
`),n.header&&(t+="  ".concat(n.header)),e[i]){let o=e[i];o.sort((a,l)=>a.order-l.order);for(let a of o)t+="  ".concat(a.injection,`
`)}n.footer&&(t+="  ".concat(n.footer)),t+=`}
`}return t}function hk(s){let e={vs:{},fs:{}};return s.forEach(t=>{let i;typeof t!="string"?(i=t,t=i.hook):i={},t=t.trim();let[n,o]=t.split(":"),a=t.replace(/\(.+/,"");e[n][a]=Object.assign(i,{signature:o})}),e}var dk="void main() {gl_FragColor = vec4(0);}",AI=`out vec4 transform_output;
void main() {
  transform_output = vec4(0);
}`,fk=`#version 300 es
`.concat(AI);function bP(s,e){e=Array.isArray(e)?e:[e];let t=s.replace(/^\s+/,"").split(/\s+/),[i,n,o]=t;if(!e.includes(i)||!n||!o)return null;let a=o.split(";")[0];return{qualifier:i,type:n,name:a}}function tg(){let s=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{version:e=100,input:t,inputType:i,output:n}=s;if(!t)return e===300?fk:e>300?"#version ".concat(e,`
`).concat(AI):dk;let o=TI(t,i);return e>=300?"#version ".concat(e," ").concat(e===300?"es":"",`
in `).concat(i," ").concat(t,`;
out vec4 `).concat(n,`;
void main() {
  `).concat(n," = ").concat(o,`;
}`):"varying ".concat(i," ").concat(t,`;
void main() {
  gl_FragColor = `).concat(o,`;
}`)}function YE(s){switch(s){case"float":return"x";case"vec2":return"xy";case"vec3":return"xyz";case"vec4":return"xyzw";default:return jt(!1),null}}function KE(s){switch(s){case"float":return 1;case"vec2":return 2;case"vec3":return 3;case"vec4":return 4;default:return jt(!1),null}}function TI(s,e){switch(e){case"float":return"vec4(".concat(s,", 0.0, 0.0, 1.0)");case"vec2":return"vec4(".concat(s,", 0.0, 1.0)");case"vec3":return"vec4(".concat(s,", 1.0)");case"vec4":return s;default:return jt(!1),null}}var gk=`#ifdef LUMA_FP32_TAN_PRECISION_WORKAROUND
const float TWO_PI = 6.2831854820251465;
const float PI_2 = 1.5707963705062866;
const float PI_16 = 0.1963495463132858;

const float SIN_TABLE_0 = 0.19509032368659973;
const float SIN_TABLE_1 = 0.3826834261417389;
const float SIN_TABLE_2 = 0.5555702447891235;
const float SIN_TABLE_3 = 0.7071067690849304;

const float COS_TABLE_0 = 0.9807852506637573;
const float COS_TABLE_1 = 0.9238795042037964;
const float COS_TABLE_2 = 0.8314695954322815;
const float COS_TABLE_3 = 0.7071067690849304;

const float INVERSE_FACTORIAL_3 = 1.666666716337204e-01;
const float INVERSE_FACTORIAL_5 = 8.333333767950535e-03;
const float INVERSE_FACTORIAL_7 = 1.9841270113829523e-04;
const float INVERSE_FACTORIAL_9 = 2.75573188446287533e-06;

float sin_taylor_fp32(float a) {
  float r, s, t, x;

  if (a == 0.0) {
    return 0.0;
  }

  x = -a * a;
  s = a;
  r = a;

  r = r * x;
  t = r * INVERSE_FACTORIAL_3;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_5;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_7;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_9;
  s = s + t;

  return s;
}

void sincos_taylor_fp32(float a, out float sin_t, out float cos_t) {
  if (a == 0.0) {
    sin_t = 0.0;
    cos_t = 1.0;
  }
  sin_t = sin_taylor_fp32(a);
  cos_t = sqrt(1.0 - sin_t * sin_t);
}

float tan_taylor_fp32(float a) {
    float sin_a;
    float cos_a;

    if (a == 0.0) {
        return 0.0;
    }
    float z = floor(a / TWO_PI);
    float r = a - TWO_PI * z;

    float t;
    float q = floor(r / PI_2 + 0.5);
    int j = int(q);

    if (j < -2 || j > 2) {
        return 1.0 / 0.0;
    }

    t = r - PI_2 * q;

    q = floor(t / PI_16 + 0.5);
    int k = int(q);
    int abs_k = int(abs(float(k)));

    if (abs_k > 4) {
        return 1.0 / 0.0;
    } else {
        t = t - PI_16 * q;
    }

    float u = 0.0;
    float v = 0.0;

    float sin_t, cos_t;
    float s, c;
    sincos_taylor_fp32(t, sin_t, cos_t);

    if (k == 0) {
        s = sin_t;
        c = cos_t;
    } else {
        if (abs(float(abs_k) - 1.0) < 0.5) {
            u = COS_TABLE_0;
            v = SIN_TABLE_0;
        } else if (abs(float(abs_k) - 2.0) < 0.5) {
            u = COS_TABLE_1;
            v = SIN_TABLE_1;
        } else if (abs(float(abs_k) - 3.0) < 0.5) {
            u = COS_TABLE_2;
            v = SIN_TABLE_2;
        } else if (abs(float(abs_k) - 4.0) < 0.5) {
            u = COS_TABLE_3;
            v = SIN_TABLE_3;
        }
        if (k > 0) {
            s = u * sin_t + v * cos_t;
            c = u * cos_t - v * sin_t;
        } else {
            s = u * sin_t - v * cos_t;
            c = u * cos_t + v * sin_t;
        }
    }

    if (j == 0) {
        sin_a = s;
        cos_a = c;
    } else if (j == 1) {
        sin_a = c;
        cos_a = -s;
    } else if (j == -1) {
        sin_a = -c;
        cos_a = s;
    } else {
        sin_a = -s;
        cos_a = -c;
    }
    return sin_a / cos_a;
}
#endif

float tan_fp32(float a) {
#ifdef LUMA_FP32_TAN_PRECISION_WORKAROUND
  return tan_taylor_fp32(a);
#else
  return tan(a);
#endif
}
`,PP={name:"fp32",vs:gk,fs:null};function no(s,e){if(!s)throw new Error("math.gl assertion ".concat(e))}var j1e=1/Math.PI*180,q1e=1/180*Math.PI,qt={EPSILON:1e-12,debug:!1,precision:4,printTypes:!1,printDegrees:!1,printRowMajor:!0};function ZE(s,{precision:e=qt.precision}={}){return s=pk(s),"".concat(parseFloat(s.toPrecision(e)))}function oo(s){return Array.isArray(s)||ArrayBuffer.isView(s)&&!(s instanceof DataView)}function Rt(s,e,t){return bk(s,i=>Math.max(e,Math.min(t,i)))}function Nu(s,e,t){return oo(s)?s.map((i,n)=>Nu(i,e[n],t)):t*e+(1-t)*s}function kr(s,e,t){let i=qt.EPSILON;t&&(qt.EPSILON=t);try{if(s===e)return!0;if(oo(s)&&oo(e)){if(s.length!==e.length)return!1;for(let n=0;n<s.length;++n)if(!kr(s[n],e[n]))return!1;return!0}return s&&s.equals?s.equals(e):e&&e.equals?e.equals(s):typeof s=="number"&&typeof e=="number"?Math.abs(s-e)<=qt.EPSILON*Math.max(1,Math.abs(s),Math.abs(e)):!1}finally{qt.EPSILON=i}}function pk(s){return Math.round(s/qt.EPSILON)*qt.EPSILON}function mk(s){return s.clone?s.clone():new Array(s.length)}function bk(s,e,t){if(oo(s)){let i=s;t=t||mk(i);for(let n=0;n<t.length&&n<i.length;++n)t[n]=e(s[n],n,t);return t}return e(s)}function Pk(s){function e(){var t=Reflect.construct(s,Array.from(arguments));return Object.setPrototypeOf(t,Object.getPrototypeOf(this)),t}return e.prototype=Object.create(s.prototype,{constructor:{value:s,enumerable:!1,writable:!0,configurable:!0}}),Object.setPrototypeOf?Object.setPrototypeOf(e,s):e.__proto__=s,e}var qs=class extends Pk(Array){clone(){return new this.constructor().copy(this)}fromArray(e,t=0){for(let i=0;i<this.ELEMENTS;++i)this[i]=e[i+t];return this.check()}toArray(e=[],t=0){for(let i=0;i<this.ELEMENTS;++i)e[t+i]=this[i];return e}from(e){return Array.isArray(e)?this.copy(e):this.fromObject(e)}to(e){return e===this?this:oo(e)?this.toArray(e):this.toObject(e)}toTarget(e){return e?this.to(e):this}toFloat32Array(){return new Float32Array(this)}toString(){return this.formatString(qt)}formatString(e){let t="";for(let i=0;i<this.ELEMENTS;++i)t+=(i>0?", ":"")+ZE(this[i],e);return"".concat(e.printTypes?this.constructor.name:"","[").concat(t,"]")}equals(e){if(!e||this.length!==e.length)return!1;for(let t=0;t<this.ELEMENTS;++t)if(!kr(this[t],e[t]))return!1;return!0}exactEquals(e){if(!e||this.length!==e.length)return!1;for(let t=0;t<this.ELEMENTS;++t)if(this[t]!==e[t])return!1;return!0}negate(){for(let e=0;e<this.ELEMENTS;++e)this[e]=-this[e];return this.check()}lerp(e,t,i){if(i===void 0)return this.lerp(this,e,t);for(let n=0;n<this.ELEMENTS;++n){let o=e[n];this[n]=o+i*(t[n]-o)}return this.check()}min(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=Math.min(e[t],this[t]);return this.check()}max(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=Math.max(e[t],this[t]);return this.check()}clamp(e,t){for(let i=0;i<this.ELEMENTS;++i)this[i]=Math.min(Math.max(this[i],e[i]),t[i]);return this.check()}add(...e){for(let t of e)for(let i=0;i<this.ELEMENTS;++i)this[i]+=t[i];return this.check()}subtract(...e){for(let t of e)for(let i=0;i<this.ELEMENTS;++i)this[i]-=t[i];return this.check()}scale(e){if(typeof e=="number")for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;else for(let t=0;t<this.ELEMENTS&&t<e.length;++t)this[t]*=e[t];return this.check()}multiplyByScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;return this.check()}check(){if(qt.debug&&!this.validate())throw new Error("math.gl: ".concat(this.constructor.name," some fields set to invalid numbers'"));return this}validate(){let e=this.length===this.ELEMENTS;for(let t=0;t<this.ELEMENTS;++t)e=e&&Number.isFinite(this[t]);return e}sub(e){return this.subtract(e)}setScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=e;return this.check()}addScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]+=e;return this.check()}subScalar(e){return this.addScalar(-e)}multiplyScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;return this.check()}divideScalar(e){return this.multiplyByScalar(1/e)}clampScalar(e,t){for(let i=0;i<this.ELEMENTS;++i)this[i]=Math.min(Math.max(this[i],e),t);return this.check()}get elements(){return this}};function yk(s,e){if(s.length!==e)return!1;for(let t=0;t<s.length;++t)if(!Number.isFinite(s[t]))return!1;return!0}function Je(s){if(!Number.isFinite(s))throw new Error("Invalid number ".concat(s));return s}function ul(s,e,t=""){if(qt.debug&&!yk(s,e))throw new Error("math.gl: ".concat(t," some fields set to invalid numbers'"));return s}var Mu=class extends qs{get x(){return this[0]}set x(e){this[0]=Je(e)}get y(){return this[1]}set y(e){this[1]=Je(e)}len(){return Math.sqrt(this.lengthSquared())}magnitude(){return this.len()}lengthSquared(){let e=0;for(let t=0;t<this.ELEMENTS;++t)e+=this[t]*this[t];return e}magnitudeSquared(){return this.lengthSquared()}distance(e){return Math.sqrt(this.distanceSquared(e))}distanceSquared(e){let t=0;for(let i=0;i<this.ELEMENTS;++i){let n=this[i]-e[i];t+=n*n}return Je(t)}dot(e){let t=0;for(let i=0;i<this.ELEMENTS;++i)t+=this[i]*e[i];return Je(t)}normalize(){let e=this.magnitude();if(e!==0)for(let t=0;t<this.ELEMENTS;++t)this[t]/=e;return this.check()}multiply(...e){for(let t of e)for(let i=0;i<this.ELEMENTS;++i)this[i]*=t[i];return this.check()}divide(...e){for(let t of e)for(let i=0;i<this.ELEMENTS;++i)this[i]/=t[i];return this.check()}lengthSq(){return this.lengthSquared()}distanceTo(e){return this.distance(e)}distanceToSquared(e){return this.distanceSquared(e)}getComponent(e){return no(e>=0&&e<this.ELEMENTS,"index is out of range"),Je(this[e])}setComponent(e,t){return no(e>=0&&e<this.ELEMENTS,"index is out of range"),this[e]=t,this.check()}addVectors(e,t){return this.copy(e).add(t)}subVectors(e,t){return this.copy(e).subtract(t)}multiplyVectors(e,t){return this.copy(e).multiply(t)}addScaledVector(e,t){return this.add(new this.constructor(e).multiplyScalar(t))}};var so=1e-6,Vr=typeof Float32Array<"u"?Float32Array:Array;var rTe=Math.PI/180;Math.hypot||(Math.hypot=function(){for(var s=0,e=arguments.length;e--;)s+=arguments[e]*arguments[e];return Math.sqrt(s)});function Sk(){var s=new Vr(2);return Vr!=Float32Array&&(s[0]=0,s[1]=0),s}function wh(s,e,t){return s[0]=e[0]+t[0],s[1]=e[1]+t[1],s}function yP(s,e){return s[0]=-e[0],s[1]=-e[1],s}function SP(s,e,t,i){var n=e[0],o=e[1];return s[0]=n+i*(t[0]-n),s[1]=o+i*(t[1]-o),s}function II(s,e,t){var i=e[0],n=e[1];return s[0]=t[0]*i+t[3]*n+t[6],s[1]=t[1]*i+t[4]*n+t[7],s}function wI(s,e,t){var i=e[0],n=e[1];return s[0]=t[0]*i+t[4]*n+t[12],s[1]=t[1]*i+t[5]*n+t[13],s}var iTe=function(){var s=Sk();return function(e,t,i,n,o,a){var l,u;for(t||(t=2),i||(i=0),n?u=Math.min(n*t+i,e.length):u=e.length,l=i;l<u;l+=t)s[0]=e[l],s[1]=e[l+1],o(s,s,a),e[l]=s[0],e[l+1]=s[1];return e}}();function LI(s,e,t){let i=e[0],n=e[1],o=t[3]*i+t[7]*n||1;return s[0]=(t[0]*i+t[4]*n)/o,s[1]=(t[1]*i+t[5]*n)/o,s}function EP(s,e,t){let i=e[0],n=e[1],o=e[2],a=t[3]*i+t[7]*n+t[11]*o||1;return s[0]=(t[0]*i+t[4]*n+t[8]*o)/a,s[1]=(t[1]*i+t[5]*n+t[9]*o)/a,s[2]=(t[2]*i+t[6]*n+t[10]*o)/a,s}function RI(s,e,t){let i=e[0],n=e[1];return s[0]=t[0]*i+t[2]*n,s[1]=t[1]*i+t[3]*n,s[2]=e[2],s}function OI(s,e,t){let i=e[0],n=e[1];return s[0]=t[0]*i+t[2]*n,s[1]=t[1]*i+t[3]*n,s[2]=e[2],s[3]=e[3],s}function xP(s,e,t){let i=e[0],n=e[1],o=e[2];return s[0]=t[0]*i+t[3]*n+t[6]*o,s[1]=t[1]*i+t[4]*n+t[7]*o,s[2]=t[2]*i+t[5]*n+t[8]*o,s[3]=e[3],s}function JE(){var s=new Vr(3);return Vr!=Float32Array&&(s[0]=0,s[1]=0,s[2]=0),s}function Ek(s){var e=s[0],t=s[1],i=s[2];return Math.hypot(e,t,i)}function $E(s,e,t){var i=new Vr(3);return i[0]=s,i[1]=e,i[2]=t,i}function xk(s,e,t){return s[0]=e[0]-t[0],s[1]=e[1]-t[1],s[2]=e[2]-t[2],s}function vk(s){var e=s[0],t=s[1],i=s[2];return e*e+t*t+i*i}function _I(s,e){return s[0]=-e[0],s[1]=-e[1],s[2]=-e[2],s}function NI(s,e){var t=e[0],i=e[1],n=e[2],o=t*t+i*i+n*n;return o>0&&(o=1/Math.sqrt(o)),s[0]=e[0]*o,s[1]=e[1]*o,s[2]=e[2]*o,s}function ex(s,e){return s[0]*e[0]+s[1]*e[1]+s[2]*e[2]}function Rh(s,e,t){var i=e[0],n=e[1],o=e[2],a=t[0],l=t[1],u=t[2];return s[0]=n*u-o*l,s[1]=o*a-i*u,s[2]=i*l-n*a,s}function MI(s,e,t,i){var n=e[0],o=e[1],a=e[2];return s[0]=n+i*(t[0]-n),s[1]=o+i*(t[1]-o),s[2]=a+i*(t[2]-a),s}function Oh(s,e,t){var i=e[0],n=e[1],o=e[2],a=t[3]*i+t[7]*n+t[11]*o+t[15];return a=a||1,s[0]=(t[0]*i+t[4]*n+t[8]*o+t[12])/a,s[1]=(t[1]*i+t[5]*n+t[9]*o+t[13])/a,s[2]=(t[2]*i+t[6]*n+t[10]*o+t[14])/a,s}function vP(s,e,t){var i=e[0],n=e[1],o=e[2];return s[0]=i*t[0]+n*t[3]+o*t[6],s[1]=i*t[1]+n*t[4]+o*t[7],s[2]=i*t[2]+n*t[5]+o*t[8],s}function CP(s,e,t){var i=t[0],n=t[1],o=t[2],a=t[3],l=e[0],u=e[1],c=e[2],h=n*c-o*u,d=o*l-i*c,f=i*u-n*l,p=n*f-o*d,S=o*h-i*f,E=i*d-n*h,C=a*2;return h*=C,d*=C,f*=C,p*=2,S*=2,E*=2,s[0]=l+h+p,s[1]=u+d+S,s[2]=c+f+E,s}function BI(s,e,t,i){var n=[],o=[];return n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],o[0]=n[0],o[1]=n[1]*Math.cos(i)-n[2]*Math.sin(i),o[2]=n[1]*Math.sin(i)+n[2]*Math.cos(i),s[0]=o[0]+t[0],s[1]=o[1]+t[1],s[2]=o[2]+t[2],s}function DI(s,e,t,i){var n=[],o=[];return n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],o[0]=n[2]*Math.sin(i)+n[0]*Math.cos(i),o[1]=n[1],o[2]=n[2]*Math.cos(i)-n[0]*Math.sin(i),s[0]=o[0]+t[0],s[1]=o[1]+t[1],s[2]=o[2]+t[2],s}function GI(s,e,t,i){var n=[],o=[];return n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],o[0]=n[0]*Math.cos(i)-n[1]*Math.sin(i),o[1]=n[0]*Math.sin(i)+n[1]*Math.cos(i),o[2]=n[2],s[0]=o[0]+t[0],s[1]=o[1]+t[1],s[2]=o[2]+t[2],s}function FI(s,e){var t=s[0],i=s[1],n=s[2],o=e[0],a=e[1],l=e[2],u=Math.sqrt(t*t+i*i+n*n),c=Math.sqrt(o*o+a*a+l*l),h=u*c,d=h&&ex(s,e)/h;return Math.acos(Math.min(Math.max(d,-1),1))}var AP=xk;var TP=Ek,IP=vk,oTe=function(){var s=JE();return function(e,t,i,n,o,a){var l,u;for(t||(t=3),i||(i=0),n?u=Math.min(n*t+i,e.length):u=e.length,l=i;l<u;l+=t)s[0]=e[l],s[1]=e[l+1],s[2]=e[l+2],o(s,s,a),e[l]=s[0],e[l+1]=s[1],e[l+2]=s[2];return e}}();var tx=[0,0,0],wP,re=class extends Mu{static get ZERO(){return wP||(wP=new re(0,0,0),Object.freeze(wP)),wP}constructor(e=0,t=0,i=0){super(-0,-0,-0),arguments.length===1&&oo(e)?this.copy(e):(qt.debug&&(Je(e),Je(t),Je(i)),this[0]=e,this[1]=t,this[2]=i)}set(e,t,i){return this[0]=e,this[1]=t,this[2]=i,this.check()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this.check()}fromObject(e){return qt.debug&&(Je(e.x),Je(e.y),Je(e.z)),this[0]=e.x,this[1]=e.y,this[2]=e.z,this.check()}toObject(e){return e.x=this[0],e.y=this[1],e.z=this[2],e}get ELEMENTS(){return 3}get z(){return this[2]}set z(e){this[2]=Je(e)}angle(e){return FI(this,e)}cross(e){return Rh(this,this,e),this.check()}rotateX({radians:e,origin:t=tx}){return BI(this,this,t,e),this.check()}rotateY({radians:e,origin:t=tx}){return DI(this,this,t,e),this.check()}rotateZ({radians:e,origin:t=tx}){return GI(this,this,t,e),this.check()}transform(e){return this.transformAsPoint(e)}transformAsPoint(e){return Oh(this,this,e),this.check()}transformAsVector(e){return EP(this,this,e),this.check()}transformByMatrix3(e){return vP(this,this,e),this.check()}transformByMatrix2(e){return RI(this,this,e),this.check()}transformByQuaternion(e){return CP(this,this,e),this.check()}};var LP,Bu=class extends Mu{static get ZERO(){return LP||(LP=new Bu(0,0,0,0),Object.freeze(LP)),LP}constructor(e=0,t=0,i=0,n=0){super(-0,-0,-0,-0),oo(e)&&arguments.length===1?this.copy(e):(qt.debug&&(Je(e),Je(t),Je(i),Je(n)),this[0]=e,this[1]=t,this[2]=i,this[3]=n)}set(e,t,i,n){return this[0]=e,this[1]=t,this[2]=i,this[3]=n,this.check()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this.check()}fromObject(e){return qt.debug&&(Je(e.x),Je(e.y),Je(e.z),Je(e.w)),this[0]=e.x,this[1]=e.y,this[2]=e.z,this[3]=e.w,this}toObject(e){return e.x=this[0],e.y=this[1],e.z=this[2],e.w=this[3],e}get ELEMENTS(){return 4}get z(){return this[2]}set z(e){this[2]=Je(e)}get w(){return this[3]}set w(e){this[3]=Je(e)}transform(e){return Oh(this,this,e),this.check()}transformByMatrix3(e){return xP(this,this,e),this.check()}transformByMatrix2(e){return OI(this,this,e),this.check()}transformByQuaternion(e){return CP(this,this,e),this.check()}applyMatrix4(e){return e.transform(this,this),this}};var Du=class extends qs{toString(){let e="[";if(qt.printRowMajor){e+="row-major:";for(let t=0;t<this.RANK;++t)for(let i=0;i<this.RANK;++i)e+=" ".concat(this[i*this.RANK+t])}else{e+="column-major:";for(let t=0;t<this.ELEMENTS;++t)e+=" ".concat(this[t])}return e+="]",e}getElementIndex(e,t){return t*this.RANK+e}getElement(e,t){return this[t*this.RANK+e]}setElement(e,t,i){return this[t*this.RANK+e]=Je(i),this}getColumn(e,t=new Array(this.RANK).fill(-0)){let i=e*this.RANK;for(let n=0;n<this.RANK;++n)t[n]=this[i+n];return t}setColumn(e,t){let i=e*this.RANK;for(let n=0;n<this.RANK;++n)this[i+n]=t[n];return this}};function kI(){var s=new Vr(9);return Vr!=Float32Array&&(s[1]=0,s[2]=0,s[3]=0,s[5]=0,s[6]=0,s[7]=0),s[0]=1,s[4]=1,s[8]=1,s}function VI(s,e){if(s===e){var t=e[1],i=e[2],n=e[5];s[1]=e[3],s[2]=e[6],s[3]=t,s[5]=e[7],s[6]=i,s[7]=n}else s[0]=e[0],s[1]=e[3],s[2]=e[6],s[3]=e[1],s[4]=e[4],s[5]=e[7],s[6]=e[2],s[7]=e[5],s[8]=e[8];return s}function UI(s,e){var t=e[0],i=e[1],n=e[2],o=e[3],a=e[4],l=e[5],u=e[6],c=e[7],h=e[8],d=h*a-l*c,f=-h*o+l*u,p=c*o-a*u,S=t*d+i*f+n*p;return S?(S=1/S,s[0]=d*S,s[1]=(-h*i+n*c)*S,s[2]=(l*i-n*a)*S,s[3]=f*S,s[4]=(h*t-n*u)*S,s[5]=(-l*t+n*o)*S,s[6]=p*S,s[7]=(-c*t+i*u)*S,s[8]=(a*t-i*o)*S,s):null}function zI(s){var e=s[0],t=s[1],i=s[2],n=s[3],o=s[4],a=s[5],l=s[6],u=s[7],c=s[8];return e*(c*o-a*u)+t*(-c*n+a*l)+i*(u*n-o*l)}function rx(s,e,t){var i=e[0],n=e[1],o=e[2],a=e[3],l=e[4],u=e[5],c=e[6],h=e[7],d=e[8],f=t[0],p=t[1],S=t[2],E=t[3],C=t[4],O=t[5],B=t[6],A=t[7],N=t[8];return s[0]=f*i+p*a+S*c,s[1]=f*n+p*l+S*h,s[2]=f*o+p*u+S*d,s[3]=E*i+C*a+O*c,s[4]=E*n+C*l+O*h,s[5]=E*o+C*u+O*d,s[6]=B*i+A*a+N*c,s[7]=B*n+A*l+N*h,s[8]=B*o+A*u+N*d,s}function WI(s,e,t){var i=e[0],n=e[1],o=e[2],a=e[3],l=e[4],u=e[5],c=e[6],h=e[7],d=e[8],f=t[0],p=t[1];return s[0]=i,s[1]=n,s[2]=o,s[3]=a,s[4]=l,s[5]=u,s[6]=f*i+p*a+c,s[7]=f*n+p*l+h,s[8]=f*o+p*u+d,s}function HI(s,e,t){var i=e[0],n=e[1],o=e[2],a=e[3],l=e[4],u=e[5],c=e[6],h=e[7],d=e[8],f=Math.sin(t),p=Math.cos(t);return s[0]=p*i+f*a,s[1]=p*n+f*l,s[2]=p*o+f*u,s[3]=p*a-f*i,s[4]=p*l-f*n,s[5]=p*u-f*o,s[6]=c,s[7]=h,s[8]=d,s}function ix(s,e,t){var i=t[0],n=t[1];return s[0]=i*e[0],s[1]=i*e[1],s[2]=i*e[2],s[3]=n*e[3],s[4]=n*e[4],s[5]=n*e[5],s[6]=e[6],s[7]=e[7],s[8]=e[8],s}function jI(s,e){var t=e[0],i=e[1],n=e[2],o=e[3],a=t+t,l=i+i,u=n+n,c=t*a,h=i*a,d=i*l,f=n*a,p=n*l,S=n*u,E=o*a,C=o*l,O=o*u;return s[0]=1-d-S,s[3]=h-O,s[6]=f+C,s[1]=h+O,s[4]=1-c-S,s[7]=p-E,s[2]=f-C,s[5]=p+E,s[8]=1-c-d,s}var nx;(function(s){s[s.COL0ROW0=0]="COL0ROW0",s[s.COL0ROW1=1]="COL0ROW1",s[s.COL0ROW2=2]="COL0ROW2",s[s.COL1ROW0=3]="COL1ROW0",s[s.COL1ROW1=4]="COL1ROW1",s[s.COL1ROW2=5]="COL1ROW2",s[s.COL2ROW0=6]="COL2ROW0",s[s.COL2ROW1=7]="COL2ROW1",s[s.COL2ROW2=8]="COL2ROW2"})(nx||(nx={}));var Ck=Object.freeze([1,0,0,0,1,0,0,0,1]),Ct=class extends Du{static get IDENTITY(){return Tk()}static get ZERO(){return Ak()}get ELEMENTS(){return 9}get RANK(){return 3}get INDICES(){return nx}constructor(e,...t){super(-0,-0,-0,-0,-0,-0,-0,-0,-0),arguments.length===1&&Array.isArray(e)?this.copy(e):t.length>0?this.copy([e,...t]):this.identity()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this[4]=e[4],this[5]=e[5],this[6]=e[6],this[7]=e[7],this[8]=e[8],this.check()}identity(){return this.copy(Ck)}fromObject(e){return this.check()}fromQuaternion(e){return jI(this,e),this.check()}set(e,t,i,n,o,a,l,u,c){return this[0]=e,this[1]=t,this[2]=i,this[3]=n,this[4]=o,this[5]=a,this[6]=l,this[7]=u,this[8]=c,this.check()}setRowMajor(e,t,i,n,o,a,l,u,c){return this[0]=e,this[1]=n,this[2]=l,this[3]=t,this[4]=o,this[5]=u,this[6]=i,this[7]=a,this[8]=c,this.check()}determinant(){return zI(this)}transpose(){return VI(this,this),this.check()}invert(){return UI(this,this),this.check()}multiplyLeft(e){return rx(this,e,this),this.check()}multiplyRight(e){return rx(this,this,e),this.check()}rotate(e){return HI(this,this,e),this.check()}scale(e){return Array.isArray(e)?ix(this,this,e):ix(this,this,[e,e]),this.check()}translate(e){return WI(this,this,e),this.check()}transform(e,t){let i;switch(e.length){case 2:i=II(t||[-0,-0],e,this);break;case 3:i=vP(t||[-0,-0,-0],e,this);break;case 4:i=xP(t||[-0,-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return ul(i,e.length),i}transformVector(e,t){return this.transform(e,t)}transformVector2(e,t){return this.transform(e,t)}transformVector3(e,t){return this.transform(e,t)}},RP,OP;function Ak(){return RP||(RP=new Ct([0,0,0,0,0,0,0,0,0]),Object.freeze(RP)),RP}function Tk(){return OP||(OP=new Ct,Object.freeze(OP)),OP}function Ik(s){return s[0]=1,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=1,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=1,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,s}function XI(s,e){if(s===e){var t=e[1],i=e[2],n=e[3],o=e[6],a=e[7],l=e[11];s[1]=e[4],s[2]=e[8],s[3]=e[12],s[4]=t,s[6]=e[9],s[7]=e[13],s[8]=i,s[9]=o,s[11]=e[14],s[12]=n,s[13]=a,s[14]=l}else s[0]=e[0],s[1]=e[4],s[2]=e[8],s[3]=e[12],s[4]=e[1],s[5]=e[5],s[6]=e[9],s[7]=e[13],s[8]=e[2],s[9]=e[6],s[10]=e[10],s[11]=e[14],s[12]=e[3],s[13]=e[7],s[14]=e[11],s[15]=e[15];return s}function rg(s,e){var t=e[0],i=e[1],n=e[2],o=e[3],a=e[4],l=e[5],u=e[6],c=e[7],h=e[8],d=e[9],f=e[10],p=e[11],S=e[12],E=e[13],C=e[14],O=e[15],B=t*l-i*a,A=t*u-n*a,N=t*c-o*a,z=i*u-n*l,Y=i*c-o*l,ie=n*c-o*u,he=h*E-d*S,ae=h*C-f*S,D=h*O-p*S,_=d*C-f*E,W=d*O-p*E,H=f*O-p*C,ee=B*H-A*W+N*_+z*D-Y*ae+ie*he;return ee?(ee=1/ee,s[0]=(l*H-u*W+c*_)*ee,s[1]=(n*W-i*H-o*_)*ee,s[2]=(E*ie-C*Y+O*z)*ee,s[3]=(f*Y-d*ie-p*z)*ee,s[4]=(u*D-a*H-c*ae)*ee,s[5]=(t*H-n*D+o*ae)*ee,s[6]=(C*N-S*ie-O*A)*ee,s[7]=(h*ie-f*N+p*A)*ee,s[8]=(a*W-l*D+c*he)*ee,s[9]=(i*D-t*W-o*he)*ee,s[10]=(S*Y-E*N+O*B)*ee,s[11]=(d*N-h*Y-p*B)*ee,s[12]=(l*ae-a*_-u*he)*ee,s[13]=(t*_-i*ae+n*he)*ee,s[14]=(E*A-S*z-C*B)*ee,s[15]=(h*z-d*A+f*B)*ee,s):null}function YI(s){var e=s[0],t=s[1],i=s[2],n=s[3],o=s[4],a=s[5],l=s[6],u=s[7],c=s[8],h=s[9],d=s[10],f=s[11],p=s[12],S=s[13],E=s[14],C=s[15],O=e*a-t*o,B=e*l-i*o,A=e*u-n*o,N=t*l-i*a,z=t*u-n*a,Y=i*u-n*l,ie=c*S-h*p,he=c*E-d*p,ae=c*C-f*p,D=h*E-d*S,_=h*C-f*S,W=d*C-f*E;return O*W-B*_+A*D+N*ae-z*he+Y*ie}function rs(s,e,t){var i=e[0],n=e[1],o=e[2],a=e[3],l=e[4],u=e[5],c=e[6],h=e[7],d=e[8],f=e[9],p=e[10],S=e[11],E=e[12],C=e[13],O=e[14],B=e[15],A=t[0],N=t[1],z=t[2],Y=t[3];return s[0]=A*i+N*l+z*d+Y*E,s[1]=A*n+N*u+z*f+Y*C,s[2]=A*o+N*c+z*p+Y*O,s[3]=A*a+N*h+z*S+Y*B,A=t[4],N=t[5],z=t[6],Y=t[7],s[4]=A*i+N*l+z*d+Y*E,s[5]=A*n+N*u+z*f+Y*C,s[6]=A*o+N*c+z*p+Y*O,s[7]=A*a+N*h+z*S+Y*B,A=t[8],N=t[9],z=t[10],Y=t[11],s[8]=A*i+N*l+z*d+Y*E,s[9]=A*n+N*u+z*f+Y*C,s[10]=A*o+N*c+z*p+Y*O,s[11]=A*a+N*h+z*S+Y*B,A=t[12],N=t[13],z=t[14],Y=t[15],s[12]=A*i+N*l+z*d+Y*E,s[13]=A*n+N*u+z*f+Y*C,s[14]=A*o+N*c+z*p+Y*O,s[15]=A*a+N*h+z*S+Y*B,s}function Gu(s,e,t){var i=t[0],n=t[1],o=t[2],a,l,u,c,h,d,f,p,S,E,C,O;return e===s?(s[12]=e[0]*i+e[4]*n+e[8]*o+e[12],s[13]=e[1]*i+e[5]*n+e[9]*o+e[13],s[14]=e[2]*i+e[6]*n+e[10]*o+e[14],s[15]=e[3]*i+e[7]*n+e[11]*o+e[15]):(a=e[0],l=e[1],u=e[2],c=e[3],h=e[4],d=e[5],f=e[6],p=e[7],S=e[8],E=e[9],C=e[10],O=e[11],s[0]=a,s[1]=l,s[2]=u,s[3]=c,s[4]=h,s[5]=d,s[6]=f,s[7]=p,s[8]=S,s[9]=E,s[10]=C,s[11]=O,s[12]=a*i+h*n+S*o+e[12],s[13]=l*i+d*n+E*o+e[13],s[14]=u*i+f*n+C*o+e[14],s[15]=c*i+p*n+O*o+e[15]),s}function _h(s,e,t){var i=t[0],n=t[1],o=t[2];return s[0]=e[0]*i,s[1]=e[1]*i,s[2]=e[2]*i,s[3]=e[3]*i,s[4]=e[4]*n,s[5]=e[5]*n,s[6]=e[6]*n,s[7]=e[7]*n,s[8]=e[8]*o,s[9]=e[9]*o,s[10]=e[10]*o,s[11]=e[11]*o,s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15],s}function KI(s,e,t,i){var n=i[0],o=i[1],a=i[2],l=Math.hypot(n,o,a),u,c,h,d,f,p,S,E,C,O,B,A,N,z,Y,ie,he,ae,D,_,W,H,ee,oe;return l<so?null:(l=1/l,n*=l,o*=l,a*=l,u=Math.sin(t),c=Math.cos(t),h=1-c,d=e[0],f=e[1],p=e[2],S=e[3],E=e[4],C=e[5],O=e[6],B=e[7],A=e[8],N=e[9],z=e[10],Y=e[11],ie=n*n*h+c,he=o*n*h+a*u,ae=a*n*h-o*u,D=n*o*h-a*u,_=o*o*h+c,W=a*o*h+n*u,H=n*a*h+o*u,ee=o*a*h-n*u,oe=a*a*h+c,s[0]=d*ie+E*he+A*ae,s[1]=f*ie+C*he+N*ae,s[2]=p*ie+O*he+z*ae,s[3]=S*ie+B*he+Y*ae,s[4]=d*D+E*_+A*W,s[5]=f*D+C*_+N*W,s[6]=p*D+O*_+z*W,s[7]=S*D+B*_+Y*W,s[8]=d*H+E*ee+A*oe,s[9]=f*H+C*ee+N*oe,s[10]=p*H+O*ee+z*oe,s[11]=S*H+B*ee+Y*oe,e!==s&&(s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15]),s)}function _P(s,e,t){var i=Math.sin(t),n=Math.cos(t),o=e[4],a=e[5],l=e[6],u=e[7],c=e[8],h=e[9],d=e[10],f=e[11];return e!==s&&(s[0]=e[0],s[1]=e[1],s[2]=e[2],s[3]=e[3],s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15]),s[4]=o*n+c*i,s[5]=a*n+h*i,s[6]=l*n+d*i,s[7]=u*n+f*i,s[8]=c*n-o*i,s[9]=h*n-a*i,s[10]=d*n-l*i,s[11]=f*n-u*i,s}function ZI(s,e,t){var i=Math.sin(t),n=Math.cos(t),o=e[0],a=e[1],l=e[2],u=e[3],c=e[8],h=e[9],d=e[10],f=e[11];return e!==s&&(s[4]=e[4],s[5]=e[5],s[6]=e[6],s[7]=e[7],s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15]),s[0]=o*n-c*i,s[1]=a*n-h*i,s[2]=l*n-d*i,s[3]=u*n-f*i,s[8]=o*i+c*n,s[9]=a*i+h*n,s[10]=l*i+d*n,s[11]=u*i+f*n,s}function NP(s,e,t){var i=Math.sin(t),n=Math.cos(t),o=e[0],a=e[1],l=e[2],u=e[3],c=e[4],h=e[5],d=e[6],f=e[7];return e!==s&&(s[8]=e[8],s[9]=e[9],s[10]=e[10],s[11]=e[11],s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15]),s[0]=o*n+c*i,s[1]=a*n+h*i,s[2]=l*n+d*i,s[3]=u*n+f*i,s[4]=c*n-o*i,s[5]=h*n-a*i,s[6]=d*n-l*i,s[7]=f*n-u*i,s}function QI(s,e){var t=e[0],i=e[1],n=e[2],o=e[4],a=e[5],l=e[6],u=e[8],c=e[9],h=e[10];return s[0]=Math.hypot(t,i,n),s[1]=Math.hypot(o,a,l),s[2]=Math.hypot(u,c,h),s}function JI(s,e){var t=e[0],i=e[1],n=e[2],o=e[3],a=t+t,l=i+i,u=n+n,c=t*a,h=i*a,d=i*l,f=n*a,p=n*l,S=n*u,E=o*a,C=o*l,O=o*u;return s[0]=1-d-S,s[1]=h+O,s[2]=f-C,s[3]=0,s[4]=h-O,s[5]=1-c-S,s[6]=p+E,s[7]=0,s[8]=f+C,s[9]=p-E,s[10]=1-c-d,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,s}function $I(s,e,t,i,n,o,a){var l=1/(t-e),u=1/(n-i),c=1/(o-a);return s[0]=o*2*l,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=o*2*u,s[6]=0,s[7]=0,s[8]=(t+e)*l,s[9]=(n+i)*u,s[10]=(a+o)*c,s[11]=-1,s[12]=0,s[13]=0,s[14]=a*o*2*c,s[15]=0,s}function wk(s,e,t,i,n){var o=1/Math.tan(e/2),a;return s[0]=o/t,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=o,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[11]=-1,s[12]=0,s[13]=0,s[15]=0,n!=null&&n!==1/0?(a=1/(i-n),s[10]=(n+i)*a,s[14]=2*n*i*a):(s[10]=-1,s[14]=-2*i),s}var ox=wk;function Lk(s,e,t,i,n,o,a){var l=1/(e-t),u=1/(i-n),c=1/(o-a);return s[0]=-2*l,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=-2*u,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=2*c,s[11]=0,s[12]=(e+t)*l,s[13]=(n+i)*u,s[14]=(a+o)*c,s[15]=1,s}var ew=Lk;function tw(s,e,t,i){var n,o,a,l,u,c,h,d,f,p,S=e[0],E=e[1],C=e[2],O=i[0],B=i[1],A=i[2],N=t[0],z=t[1],Y=t[2];return Math.abs(S-N)<so&&Math.abs(E-z)<so&&Math.abs(C-Y)<so?Ik(s):(h=S-N,d=E-z,f=C-Y,p=1/Math.hypot(h,d,f),h*=p,d*=p,f*=p,n=B*f-A*d,o=A*h-O*f,a=O*d-B*h,p=Math.hypot(n,o,a),p?(p=1/p,n*=p,o*=p,a*=p):(n=0,o=0,a=0),l=d*a-f*o,u=f*n-h*a,c=h*o-d*n,p=Math.hypot(l,u,c),p?(p=1/p,l*=p,u*=p,c*=p):(l=0,u=0,c=0),s[0]=n,s[1]=l,s[2]=h,s[3]=0,s[4]=o,s[5]=u,s[6]=d,s[7]=0,s[8]=a,s[9]=c,s[10]=f,s[11]=0,s[12]=-(n*S+o*E+a*C),s[13]=-(l*S+u*E+c*C),s[14]=-(h*S+d*E+f*C),s[15]=1,s)}function Rk(){var s=new Vr(4);return Vr!=Float32Array&&(s[0]=0,s[1]=0,s[2]=0,s[3]=0),s}function rw(s,e,t){return s[0]=e[0]+t[0],s[1]=e[1]+t[1],s[2]=e[2]+t[2],s[3]=e[3]+t[3],s}function Nh(s,e,t){return s[0]=e[0]*t,s[1]=e[1]*t,s[2]=e[2]*t,s[3]=e[3]*t,s}function iw(s){var e=s[0],t=s[1],i=s[2],n=s[3];return Math.hypot(e,t,i,n)}function nw(s){var e=s[0],t=s[1],i=s[2],n=s[3];return e*e+t*t+i*i+n*n}function ow(s,e){var t=e[0],i=e[1],n=e[2],o=e[3],a=t*t+i*i+n*n+o*o;return a>0&&(a=1/Math.sqrt(a)),s[0]=t*a,s[1]=i*a,s[2]=n*a,s[3]=o*a,s}function sw(s,e){return s[0]*e[0]+s[1]*e[1]+s[2]*e[2]+s[3]*e[3]}function aw(s,e,t,i){var n=e[0],o=e[1],a=e[2],l=e[3];return s[0]=n+i*(t[0]-n),s[1]=o+i*(t[1]-o),s[2]=a+i*(t[2]-a),s[3]=l+i*(t[3]-l),s}function ao(s,e,t){var i=e[0],n=e[1],o=e[2],a=e[3];return s[0]=t[0]*i+t[4]*n+t[8]*o+t[12]*a,s[1]=t[1]*i+t[5]*n+t[9]*o+t[13]*a,s[2]=t[2]*i+t[6]*n+t[10]*o+t[14]*a,s[3]=t[3]*i+t[7]*n+t[11]*o+t[15]*a,s}function lw(s,e,t){var i=e[0],n=e[1],o=e[2],a=t[0],l=t[1],u=t[2],c=t[3],h=c*i+l*o-u*n,d=c*n+u*i-a*o,f=c*o+a*n-l*i,p=-a*i-l*n-u*o;return s[0]=h*c+p*-a+d*-u-f*-l,s[1]=d*c+p*-l+f*-a-h*-u,s[2]=f*c+p*-u+h*-l-d*-a,s[3]=e[3],s}var CTe=function(){var s=Rk();return function(e,t,i,n,o,a){var l,u;for(t||(t=4),i||(i=0),n?u=Math.min(n*t+i,e.length):u=e.length,l=i;l<u;l+=t)s[0]=e[l],s[1]=e[l+1],s[2]=e[l+2],s[3]=e[l+3],o(s,s,a),e[l]=s[0],e[l+1]=s[1],e[l+2]=s[2],e[l+3]=s[3];return e}}();var lx;(function(s){s[s.COL0ROW0=0]="COL0ROW0",s[s.COL0ROW1=1]="COL0ROW1",s[s.COL0ROW2=2]="COL0ROW2",s[s.COL0ROW3=3]="COL0ROW3",s[s.COL1ROW0=4]="COL1ROW0",s[s.COL1ROW1=5]="COL1ROW1",s[s.COL1ROW2=6]="COL1ROW2",s[s.COL1ROW3=7]="COL1ROW3",s[s.COL2ROW0=8]="COL2ROW0",s[s.COL2ROW1=9]="COL2ROW1",s[s.COL2ROW2=10]="COL2ROW2",s[s.COL2ROW3=11]="COL2ROW3",s[s.COL3ROW0=12]="COL3ROW0",s[s.COL3ROW1=13]="COL3ROW1",s[s.COL3ROW2=14]="COL3ROW2",s[s.COL3ROW3=15]="COL3ROW3"})(lx||(lx={}));var Ok=45*Math.PI/180,_k=1,sx=.1,ax=500,Nk=Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),$e=class extends Du{static get IDENTITY(){return Bk()}static get ZERO(){return Mk()}get ELEMENTS(){return 16}get RANK(){return 4}get INDICES(){return lx}constructor(e){super(-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0),arguments.length===1&&Array.isArray(e)?this.copy(e):this.identity()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this[4]=e[4],this[5]=e[5],this[6]=e[6],this[7]=e[7],this[8]=e[8],this[9]=e[9],this[10]=e[10],this[11]=e[11],this[12]=e[12],this[13]=e[13],this[14]=e[14],this[15]=e[15],this.check()}set(e,t,i,n,o,a,l,u,c,h,d,f,p,S,E,C){return this[0]=e,this[1]=t,this[2]=i,this[3]=n,this[4]=o,this[5]=a,this[6]=l,this[7]=u,this[8]=c,this[9]=h,this[10]=d,this[11]=f,this[12]=p,this[13]=S,this[14]=E,this[15]=C,this.check()}setRowMajor(e,t,i,n,o,a,l,u,c,h,d,f,p,S,E,C){return this[0]=e,this[1]=o,this[2]=c,this[3]=p,this[4]=t,this[5]=a,this[6]=h,this[7]=S,this[8]=i,this[9]=l,this[10]=d,this[11]=E,this[12]=n,this[13]=u,this[14]=f,this[15]=C,this.check()}toRowMajor(e){return e[0]=this[0],e[1]=this[4],e[2]=this[8],e[3]=this[12],e[4]=this[1],e[5]=this[5],e[6]=this[9],e[7]=this[13],e[8]=this[2],e[9]=this[6],e[10]=this[10],e[11]=this[14],e[12]=this[3],e[13]=this[7],e[14]=this[11],e[15]=this[15],e}identity(){return this.copy(Nk)}fromObject(e){return this.check()}fromQuaternion(e){return JI(this,e),this.check()}frustum(e){let{left:t,right:i,bottom:n,top:o,near:a=sx,far:l=ax}=e;return l===1/0?Dk(this,t,i,n,o,a):$I(this,t,i,n,o,a,l),this.check()}lookAt(e){let{eye:t,center:i=[0,0,0],up:n=[0,1,0]}=e;return tw(this,t,i,n),this.check()}ortho(e){let{left:t,right:i,bottom:n,top:o,near:a=sx,far:l=ax}=e;return ew(this,t,i,n,o,a,l),this.check()}orthographic(e){let{fovy:t=Ok,aspect:i=_k,focalDistance:n=1,near:o=sx,far:a=ax}=e;uw(t);let l=t/2,u=n*Math.tan(l),c=u*i;return this.ortho({left:-c,right:c,bottom:-u,top:u,near:o,far:a})}perspective(e){let{fovy:t=45*Math.PI/180,aspect:i=1,near:n=.1,far:o=500}=e;return uw(t),ox(this,t,i,n,o),this.check()}determinant(){return YI(this)}getScale(e=[-0,-0,-0]){return e[0]=Math.sqrt(this[0]*this[0]+this[1]*this[1]+this[2]*this[2]),e[1]=Math.sqrt(this[4]*this[4]+this[5]*this[5]+this[6]*this[6]),e[2]=Math.sqrt(this[8]*this[8]+this[9]*this[9]+this[10]*this[10]),e}getTranslation(e=[-0,-0,-0]){return e[0]=this[12],e[1]=this[13],e[2]=this[14],e}getRotation(e,t){e=e||[-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0],t=t||[-0,-0,-0];let i=this.getScale(t),n=1/i[0],o=1/i[1],a=1/i[2];return e[0]=this[0]*n,e[1]=this[1]*o,e[2]=this[2]*a,e[3]=0,e[4]=this[4]*n,e[5]=this[5]*o,e[6]=this[6]*a,e[7]=0,e[8]=this[8]*n,e[9]=this[9]*o,e[10]=this[10]*a,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}getRotationMatrix3(e,t){e=e||[-0,-0,-0,-0,-0,-0,-0,-0,-0],t=t||[-0,-0,-0];let i=this.getScale(t),n=1/i[0],o=1/i[1],a=1/i[2];return e[0]=this[0]*n,e[1]=this[1]*o,e[2]=this[2]*a,e[3]=this[4]*n,e[4]=this[5]*o,e[5]=this[6]*a,e[6]=this[8]*n,e[7]=this[9]*o,e[8]=this[10]*a,e}transpose(){return XI(this,this),this.check()}invert(){return rg(this,this),this.check()}multiplyLeft(e){return rs(this,e,this),this.check()}multiplyRight(e){return rs(this,this,e),this.check()}rotateX(e){return _P(this,this,e),this.check()}rotateY(e){return ZI(this,this,e),this.check()}rotateZ(e){return NP(this,this,e),this.check()}rotateXYZ(e){return this.rotateX(e[0]).rotateY(e[1]).rotateZ(e[2])}rotateAxis(e,t){return KI(this,this,e,t),this.check()}scale(e){return _h(this,this,Array.isArray(e)?e:[e,e,e]),this.check()}translate(e){return Gu(this,this,e),this.check()}transform(e,t){return e.length===4?(t=ao(t||[-0,-0,-0,-0],e,this),ul(t,4),t):this.transformAsPoint(e,t)}transformAsPoint(e,t){let{length:i}=e,n;switch(i){case 2:n=wI(t||[-0,-0],e,this);break;case 3:n=Oh(t||[-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return ul(n,e.length),n}transformAsVector(e,t){let i;switch(e.length){case 2:i=LI(t||[-0,-0],e,this);break;case 3:i=EP(t||[-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return ul(i,e.length),i}transformPoint(e,t){return this.transformAsPoint(e,t)}transformVector(e,t){return this.transformAsPoint(e,t)}transformDirection(e,t){return this.transformAsVector(e,t)}makeRotationX(e){return this.identity().rotateX(e)}makeTranslation(e,t,i){return this.identity().translate([e,t,i])}},MP,BP;function Mk(){return MP||(MP=new $e([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),Object.freeze(MP)),MP}function Bk(){return BP||(BP=new $e,Object.freeze(BP)),BP}function uw(s){if(s>Math.PI*2)throw Error("expected radians")}function Dk(s,e,t,i,n,o){let a=2*o/(t-e),l=2*o/(n-i),u=(t+e)/(t-e),c=(n+i)/(n-i),h=-1,d=-1,f=-2*o;return s[0]=a,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=l,s[6]=0,s[7]=0,s[8]=u,s[9]=c,s[10]=h,s[11]=d,s[12]=0,s[13]=0,s[14]=f,s[15]=0,s}function cw(){var s=new Vr(4);return Vr!=Float32Array&&(s[0]=0,s[1]=0,s[2]=0),s[3]=1,s}function hw(s){return s[0]=0,s[1]=0,s[2]=0,s[3]=1,s}function ux(s,e,t){t=t*.5;var i=Math.sin(t);return s[0]=i*e[0],s[1]=i*e[1],s[2]=i*e[2],s[3]=Math.cos(t),s}function cx(s,e,t){var i=e[0],n=e[1],o=e[2],a=e[3],l=t[0],u=t[1],c=t[2],h=t[3];return s[0]=i*h+a*l+n*c-o*u,s[1]=n*h+a*u+o*l-i*c,s[2]=o*h+a*c+i*u-n*l,s[3]=a*h-i*l-n*u-o*c,s}function dw(s,e,t){t*=.5;var i=e[0],n=e[1],o=e[2],a=e[3],l=Math.sin(t),u=Math.cos(t);return s[0]=i*u+a*l,s[1]=n*u+o*l,s[2]=o*u-n*l,s[3]=a*u-i*l,s}function fw(s,e,t){t*=.5;var i=e[0],n=e[1],o=e[2],a=e[3],l=Math.sin(t),u=Math.cos(t);return s[0]=i*u-o*l,s[1]=n*u+a*l,s[2]=o*u+i*l,s[3]=a*u-n*l,s}function gw(s,e,t){t*=.5;var i=e[0],n=e[1],o=e[2],a=e[3],l=Math.sin(t),u=Math.cos(t);return s[0]=i*u+n*l,s[1]=n*u-i*l,s[2]=o*u+a*l,s[3]=a*u-o*l,s}function pw(s,e){var t=e[0],i=e[1],n=e[2];return s[0]=t,s[1]=i,s[2]=n,s[3]=Math.sqrt(Math.abs(1-t*t-i*i-n*n)),s}function ng(s,e,t,i){var n=e[0],o=e[1],a=e[2],l=e[3],u=t[0],c=t[1],h=t[2],d=t[3],f,p,S,E,C;return p=n*u+o*c+a*h+l*d,p<0&&(p=-p,u=-u,c=-c,h=-h,d=-d),1-p>so?(f=Math.acos(p),S=Math.sin(f),E=Math.sin((1-i)*f)/S,C=Math.sin(i*f)/S):(E=1-i,C=i),s[0]=E*n+C*u,s[1]=E*o+C*c,s[2]=E*a+C*h,s[3]=E*l+C*d,s}function mw(s,e){var t=e[0],i=e[1],n=e[2],o=e[3],a=t*t+i*i+n*n+o*o,l=a?1/a:0;return s[0]=-t*l,s[1]=-i*l,s[2]=-n*l,s[3]=o*l,s}function bw(s,e){return s[0]=-e[0],s[1]=-e[1],s[2]=-e[2],s[3]=e[3],s}function hx(s,e){var t=e[0]+e[4]+e[8],i;if(t>0)i=Math.sqrt(t+1),s[3]=.5*i,i=.5/i,s[0]=(e[5]-e[7])*i,s[1]=(e[6]-e[2])*i,s[2]=(e[1]-e[3])*i;else{var n=0;e[4]>e[0]&&(n=1),e[8]>e[n*3+n]&&(n=2);var o=(n+1)%3,a=(n+2)%3;i=Math.sqrt(e[n*3+n]-e[o*3+o]-e[a*3+a]+1),s[n]=.5*i,i=.5/i,s[3]=(e[o*3+a]-e[a*3+o])*i,s[o]=(e[o*3+n]+e[n*3+o])*i,s[a]=(e[a*3+n]+e[n*3+a])*i}return s}var Pw=rw;var yw=Nh,Sw=sw,Ew=aw,xw=iw;var vw=nw;var Cw=ow;var Aw=function(){var s=JE(),e=$E(1,0,0),t=$E(0,1,0);return function(i,n,o){var a=ex(n,o);return a<-.999999?(Rh(s,e,n),TP(s)<1e-6&&Rh(s,t,n),NI(s,s),ux(i,s,Math.PI),i):a>.999999?(i[0]=0,i[1]=0,i[2]=0,i[3]=1,i):(Rh(s,n,o),i[0]=s[0],i[1]=s[1],i[2]=s[2],i[3]=1+a,Cw(i,i))}}(),BTe=function(){var s=cw(),e=cw();return function(t,i,n,o,a,l){return ng(s,i,a,l),ng(e,n,o,l),ng(t,s,e,2*l*(1-l)),t}}(),DTe=function(){var s=kI();return function(e,t,i,n){return s[0]=i[0],s[3]=i[1],s[6]=i[2],s[1]=n[0],s[4]=n[1],s[7]=n[2],s[2]=-t[0],s[5]=-t[1],s[8]=-t[2],Cw(e,hx(e,s))}}();var Fk=[0,0,0,1],Fu=class extends qs{constructor(e=0,t=0,i=0,n=1){super(-0,-0,-0,-0),Array.isArray(e)&&arguments.length===1?this.copy(e):this.set(e,t,i,n)}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this.check()}set(e,t,i,n){return this[0]=e,this[1]=t,this[2]=i,this[3]=n,this.check()}fromObject(e){return this[0]=e.x,this[1]=e.y,this[2]=e.z,this[3]=e.w,this.check()}fromMatrix3(e){return hx(this,e),this.check()}fromAxisRotation(e,t){return ux(this,e,t),this.check()}identity(){return hw(this),this.check()}setAxisAngle(e,t){return this.fromAxisRotation(e,t)}get ELEMENTS(){return 4}get x(){return this[0]}set x(e){this[0]=Je(e)}get y(){return this[1]}set y(e){this[1]=Je(e)}get z(){return this[2]}set z(e){this[2]=Je(e)}get w(){return this[3]}set w(e){this[3]=Je(e)}len(){return xw(this)}lengthSquared(){return vw(this)}dot(e){return Sw(this,e)}rotationTo(e,t){return Aw(this,e,t),this.check()}add(e){return Pw(this,this,e),this.check()}calculateW(){return pw(this,this),this.check()}conjugate(){return bw(this,this),this.check()}invert(){return mw(this,this),this.check()}lerp(e,t,i){return i===void 0?this.lerp(this,e,t):(Ew(this,e,t,i),this.check())}multiplyRight(e){return cx(this,this,e),this.check()}multiplyLeft(e){return cx(this,e,this),this.check()}normalize(){let e=this.len(),t=e>0?1/e:0;return this[0]=this[0]*t,this[1]=this[1]*t,this[2]=this[2]*t,this[3]=this[3]*t,e===0&&(this[3]=1),this.check()}rotateX(e){return dw(this,this,e),this.check()}rotateY(e){return fw(this,this,e),this.check()}rotateZ(e){return gw(this,this,e),this.check()}scale(e){return yw(this,this,e),this.check()}slerp(e,t,i){let n,o,a;switch(arguments.length){case 1:({start:n=Fk,target:o,ratio:a}=e);break;case 2:n=this,o=e,a=t;break;default:n=e,o=t,a=i}return ng(this,n,o,a),this.check()}transformVector4(e,t=new Bu){return lw(t,e,this),ul(t,4)}lengthSq(){return this.lengthSquared()}setFromAxisAngle(e,t){return this.setAxisAngle(e,t)}premultiply(e){return this.multiplyLeft(e)}multiply(e){return this.multiplyRight(e)}};var DP={EPSILON1:.1,EPSILON2:.01,EPSILON3:.001,EPSILON4:1e-4,EPSILON5:1e-5,EPSILON6:1e-6,EPSILON7:1e-7,EPSILON8:1e-8,EPSILON9:1e-9,EPSILON10:1e-10,EPSILON11:1e-11,EPSILON12:1e-12,EPSILON13:1e-13,EPSILON14:1e-14,EPSILON15:1e-15,EPSILON16:1e-16,EPSILON17:1e-17,EPSILON18:1e-18,EPSILON19:1e-19,EPSILON20:1e-20,PI_OVER_TWO:Math.PI/2,PI_OVER_FOUR:Math.PI/4,PI_OVER_SIX:Math.PI/6,TWO_PI:Math.PI*2};var dx=`#if (defined(SHADER_TYPE_FRAGMENT) && defined(LIGHTING_FRAGMENT)) || (defined(SHADER_TYPE_VERTEX) && defined(LIGHTING_VERTEX))

struct AmbientLight {
 vec3 color;
};

struct PointLight {
 vec3 color;
 vec3 position;
 vec3 attenuation;
};

struct DirectionalLight {
  vec3 color;
  vec3 direction;
};

uniform AmbientLight lighting_uAmbientLight;
uniform PointLight lighting_uPointLight[MAX_LIGHTS];
uniform DirectionalLight lighting_uDirectionalLight[MAX_LIGHTS];
uniform int lighting_uPointLightCount;
uniform int lighting_uDirectionalLightCount;

uniform bool lighting_uEnabled;

float getPointLightAttenuation(PointLight pointLight, float distance) {
  return pointLight.attenuation.x
       + pointLight.attenuation.y * distance
       + pointLight.attenuation.z * distance * distance;
}

#endif
`;var kk={lightSources:{}};function fx(){let{color:s=[0,0,0],intensity:e=1}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return s.map(t=>t*e/255)}function Vk(s){let{ambientLight:e,pointLights:t=[],directionalLights:i=[]}=s,n={};return e?n["lighting_uAmbientLight.color"]=fx(e):n["lighting_uAmbientLight.color"]=[0,0,0],t.forEach((o,a)=>{n["lighting_uPointLight[".concat(a,"].color")]=fx(o),n["lighting_uPointLight[".concat(a,"].position")]=o.position,n["lighting_uPointLight[".concat(a,"].attenuation")]=o.attenuation||[1,0,0]}),n.lighting_uPointLightCount=t.length,i.forEach((o,a)=>{n["lighting_uDirectionalLight[".concat(a,"].color")]=fx(o),n["lighting_uDirectionalLight[".concat(a,"].direction")]=o.direction}),n.lighting_uDirectionalLightCount=i.length,n}function Tw(){let s=arguments.length>0&&arguments[0]!==void 0?arguments[0]:kk;if("lightSources"in s){let{ambientLight:e,pointLights:t,directionalLights:i}=s.lightSources||{};return e||t&&t.length>0||i&&i.length>0?Object.assign({},Vk({ambientLight:e,pointLights:t,directionalLights:i}),{lighting_uEnabled:!0}):{lighting_uEnabled:!1}}if("lights"in s){let e={pointLights:[],directionalLights:[]};for(let t of s.lights||[])switch(t.type){case"ambient":e.ambientLight=t;break;case"directional":e.directionalLights.push(t);break;case"point":e.pointLights.push(t);break;default:}return Tw({lightSources:e})}return{}}var Iw={name:"lights",vs:dx,fs:dx,getUniforms:Tw,defines:{MAX_LIGHTS:3}};var Uk=new Uint8Array([0,255,255,255]),zk={pickingSelectedColor:null,pickingHighlightColor:Uk,pickingActive:!1,pickingAttribute:!1};function Wk(){let s=arguments.length>0&&arguments[0]!==void 0?arguments[0]:zk,e={};if(s.pickingSelectedColor!==void 0)if(!s.pickingSelectedColor)e.picking_uSelectedColorValid=0;else{let t=s.pickingSelectedColor.slice(0,3);e.picking_uSelectedColorValid=1,e.picking_uSelectedColor=t}if(s.pickingHighlightColor){let t=Array.from(s.pickingHighlightColor,i=>i/255);Number.isFinite(t[3])||(t[3]=1),e.picking_uHighlightColor=t}return s.pickingActive!==void 0&&(e.picking_uActive=Boolean(s.pickingActive),e.picking_uAttribute=Boolean(s.pickingAttribute)),e}var Hk=`uniform bool picking_uActive;
uniform bool picking_uAttribute;
uniform vec3 picking_uSelectedColor;
uniform bool picking_uSelectedColorValid;

out vec4 picking_vRGBcolor_Avalid;

const float COLOR_SCALE = 1. / 255.;

bool picking_isColorValid(vec3 color) {
  return dot(color, vec3(1.0)) > 0.001;
}

bool isVertexPicked(vec3 vertexColor) {
  return
    picking_uSelectedColorValid &&
    !picking_isColorValid(abs(vertexColor - picking_uSelectedColor));
}

void picking_setPickingColor(vec3 pickingColor) {
  if (picking_uActive) {
    picking_vRGBcolor_Avalid.a = float(picking_isColorValid(pickingColor));

    if (!picking_uAttribute) {
      picking_vRGBcolor_Avalid.rgb = pickingColor * COLOR_SCALE;
    }
  } else {
    picking_vRGBcolor_Avalid.a = float(isVertexPicked(pickingColor));
  }
}

void picking_setPickingAttribute(float value) {
  if (picking_uAttribute) {
    picking_vRGBcolor_Avalid.r = value;
  }
}
void picking_setPickingAttribute(vec2 value) {
  if (picking_uAttribute) {
    picking_vRGBcolor_Avalid.rg = value;
  }
}
void picking_setPickingAttribute(vec3 value) {
  if (picking_uAttribute) {
    picking_vRGBcolor_Avalid.rgb = value;
  }
}
`,jk=`uniform bool picking_uActive;
uniform vec3 picking_uSelectedColor;
uniform vec4 picking_uHighlightColor;

in vec4 picking_vRGBcolor_Avalid;
vec4 picking_filterHighlightColor(vec4 color) {
  if (picking_uActive) {
    return color;
  }
  bool selected = bool(picking_vRGBcolor_Avalid.a);

  if (selected) {
    float highLightAlpha = picking_uHighlightColor.a;
    float blendedAlpha = highLightAlpha + color.a * (1.0 - highLightAlpha);
    float highLightRatio = highLightAlpha / blendedAlpha;

    vec3 blendedRGB = mix(color.rgb, picking_uHighlightColor.rgb, highLightRatio);
    return vec4(blendedRGB, blendedAlpha);
  } else {
    return color;
  }
}
vec4 picking_filterPickingColor(vec4 color) {
  if (picking_uActive) {
    if (picking_vRGBcolor_Avalid.a == 0.0) {
      discard;
    }
    return picking_vRGBcolor_Avalid;
  }
  return color;
}
vec4 picking_filterColor(vec4 color) {
  vec4 highightColor = picking_filterHighlightColor(color);
  return picking_filterPickingColor(highightColor);
}

`,hl={name:"picking",vs:Hk,fs:jk,getUniforms:Wk};var ww=`
uniform float lighting_uAmbient;
uniform float lighting_uDiffuse;
uniform float lighting_uShininess;
uniform vec3  lighting_uSpecularColor;

vec3 lighting_getLightColor(vec3 surfaceColor, vec3 light_direction, vec3 view_direction, vec3 normal_worldspace, vec3 color) {
    vec3 halfway_direction = normalize(light_direction + view_direction);
    float lambertian = dot(light_direction, normal_worldspace);
    float specular = 0.0;
    if (lambertian > 0.0) {
      float specular_angle = max(dot(normal_worldspace, halfway_direction), 0.0);
      specular = pow(specular_angle, lighting_uShininess);
    }
    lambertian = max(lambertian, 0.0);
    return (lambertian * lighting_uDiffuse * surfaceColor + specular * lighting_uSpecularColor) * color;
}

vec3 lighting_getLightColor(vec3 surfaceColor, vec3 cameraPosition, vec3 position_worldspace, vec3 normal_worldspace) {
  vec3 lightColor = surfaceColor;

  if (lighting_uEnabled) {
    vec3 view_direction = normalize(cameraPosition - position_worldspace);
    lightColor = lighting_uAmbient * surfaceColor * lighting_uAmbientLight.color;

    for (int i = 0; i < MAX_LIGHTS; i++) {
      if (i >= lighting_uPointLightCount) {
        break;
      }
      PointLight pointLight = lighting_uPointLight[i];
      vec3 light_position_worldspace = pointLight.position;
      vec3 light_direction = normalize(light_position_worldspace - position_worldspace);
      lightColor += lighting_getLightColor(surfaceColor, light_direction, view_direction, normal_worldspace, pointLight.color);
    }

    for (int i = 0; i < MAX_LIGHTS; i++) {
      if (i >= lighting_uDirectionalLightCount) {
        break;
      }
      DirectionalLight directionalLight = lighting_uDirectionalLight[i];
      lightColor += lighting_getLightColor(surfaceColor, -directionalLight.direction, view_direction, normal_worldspace, directionalLight.color);
    }
  }
  return lightColor;
}

vec3 lighting_getSpecularLightColor(vec3 cameraPosition, vec3 position_worldspace, vec3 normal_worldspace) {
  vec3 lightColor = vec3(0, 0, 0);
  vec3 surfaceColor = vec3(0, 0, 0);

  if (lighting_uEnabled) {
    vec3 view_direction = normalize(cameraPosition - position_worldspace);

    for (int i = 0; i < MAX_LIGHTS; i++) {
      if (i >= lighting_uPointLightCount) {
        break;
      }
      PointLight pointLight = lighting_uPointLight[i];
      vec3 light_position_worldspace = pointLight.position;
      vec3 light_direction = normalize(light_position_worldspace - position_worldspace);
      lightColor += lighting_getLightColor(surfaceColor, light_direction, view_direction, normal_worldspace, pointLight.color);
    }

    for (int i = 0; i < MAX_LIGHTS; i++) {
      if (i >= lighting_uDirectionalLightCount) {
        break;
      }
      DirectionalLight directionalLight = lighting_uDirectionalLight[i];
      lightColor += lighting_getLightColor(surfaceColor, -directionalLight.direction, view_direction, normal_worldspace, directionalLight.color);
    }
  }
  return lightColor;
}
`;var qk={};function Xk(s){let{ambient:e=.35,diffuse:t=.6,shininess:i=32,specularColor:n=[30,30,30]}=s;return{lighting_uAmbient:e,lighting_uDiffuse:t,lighting_uShininess:i,lighting_uSpecularColor:n.map(o=>o/255)}}function Yk(){let s=arguments.length>0&&arguments[0]!==void 0?arguments[0]:qk;if(!("material"in s))return{};let{material:e}=s;return e?Xk(e):{lighting_uEnabled:!1}}var Bh={name:"gouraud-lighting",dependencies:[Iw],vs:ww,defines:{LIGHTING_VERTEX:1},getUniforms:Yk};var Kk=`attribute float transform_elementID;
vec2 transform_getPixelSizeHalf(vec2 size) {
  return vec2(1.) / (2. * size);
}

vec2 transform_getPixelIndices(vec2 texSize, vec2 pixelSizeHalf) {
  float yIndex = floor((transform_elementID / texSize[0]) + pixelSizeHalf[1]);
  float xIndex = transform_elementID - (yIndex * texSize[0]);
  return vec2(xIndex, yIndex);
}
vec2 transform_getTexCoord(vec2 size) {
  vec2 pixelSizeHalf = transform_getPixelSizeHalf(size);
  vec2 indices = transform_getPixelIndices(size, pixelSizeHalf);
  vec2 coord = indices / size + pixelSizeHalf;
  return coord;
}
vec2 transform_getPos(vec2 size) {
  vec2 texCoord = transform_getTexCoord(size);
  vec2 pos = (texCoord * (2.0, 2.0)) - (1., 1.);
  return pos;
}
vec4 transform_getInput(sampler2D texSampler, vec2 size) {
  vec2 texCoord = transform_getTexCoord(size);
  vec4 textureColor = texture2D(texSampler, texCoord);
  return textureColor;
}
`,gx={name:"transform",vs:Kk,fs:null};var nn=class{static getDefaultProgramManager(e){return e.luma=e.luma||{},e.luma.defaultProgramManager=e.luma.defaultProgramManager||new nn(e),e.luma.defaultProgramManager}constructor(e){this.gl=e,this._programCache={},this._getUniforms={},this._registeredModules={},this._hookFunctions=[],this._defaultModules=[],this._hashes={},this._hashCounter=0,this.stateHash=0,this._useCounts={}}addDefaultModule(e){this._defaultModules.find(t=>t.name===e.name)||this._defaultModules.push(e),this.stateHash++}removeDefaultModule(e){let t=typeof e=="string"?e:e.name;this._defaultModules=this._defaultModules.filter(i=>i.name!==t),this.stateHash++}addShaderHook(e,t){t&&(e=Object.assign(t,{hook:e})),this._hookFunctions.push(e),this.stateHash++}get(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{vs:t="",fs:i="",defines:n={},inject:o={},varyings:a=[],bufferMode:l=35981,transpileToGLSL100:u=!1}=e,c=this._getModuleList(e.modules),h=this._getHash(t),d=this._getHash(i),f=c.map(A=>this._getHash(A.name)).sort(),p=a.map(A=>this._getHash(A)),S=Object.keys(n).sort(),E=Object.keys(o).sort(),C=[],O=[];for(let A of S)C.push(this._getHash(A)),C.push(this._getHash(n[A]));for(let A of E)O.push(this._getHash(A)),O.push(this._getHash(o[A]));let B="".concat(h,"/").concat(d,"D").concat(C.join("/"),"M").concat(f.join("/"),"I").concat(O.join("/"),"V").concat(p.join("/"),"H").concat(this.stateHash,"B").concat(l).concat(u?"T":"");if(!this._programCache[B]){let A=XE(this.gl,{vs:t,fs:i,modules:c,inject:o,defines:n,hookFunctions:this._hookFunctions,transpileToGLSL100:u});this._programCache[B]=new Ws(this.gl,{hash:B,vs:A.vs,fs:A.fs,varyings:a,bufferMode:l}),this._getUniforms[B]=A.getUniforms||(N=>{}),this._useCounts[B]=0}return this._useCounts[B]++,this._programCache[B]}getUniforms(e){return this._getUniforms[e.hash]||null}release(e){let t=e.hash;this._useCounts[t]--,this._useCounts[t]===0&&(this._programCache[t].delete(),delete this._programCache[t],delete this._getUniforms[t],delete this._useCounts[t])}_getHash(e){return this._hashes[e]===void 0&&(this._hashes[e]=this._hashCounter++),this._hashes[e]}_getModuleList(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[],t=new Array(this._defaultModules.length+e.length),i={},n=0;for(let o=0,a=this._defaultModules.length;o<a;++o){let l=this._defaultModules[o],u=l.name;t[n++]=l,i[u]=!0}for(let o=0,a=e.length;o<a;++o){let l=e[o],u=l.name;i[u]||(t[n++]=l,i[u]=!0)}return t.length=n,t}};var Zk={POSITION:"positions",NORMAL:"normals",COLOR_0:"colors",TEXCOORD_0:"texCoords",TEXCOORD_1:"texCoords1",TEXCOORD_2:"texCoords2"};function Lw(s,e,t){let i={},n=e.indices;for(let o in e.attributes){let a=e.attributes[o],l=Qk(o,t);if(o==="indices")n=a;else if(a.constant)i[l]=a.value;else{let u=a.value,c={...a};delete c.value,i[l]=[new ye(s,u),c],Jk(o,c)}}if(n){let o=n.value||n;J(o instanceof Uint16Array||o instanceof Uint32Array,'attribute array for "indices" must be of integer type');let a={size:1,isIndexed:n.isIndexed===void 0?!0:n.isIndexed};i.indices=[new ye(s,{data:o,target:34963}),a]}return i}function Qk(s,e){let{attributeMap:t=Zk}=e||{};return t&&t[s]||s}function Jk(s,e){let t;switch(s){case"texCoords":case"texCoord1":case"texCoord2":case"texCoord3":t="uvs";break;case"vertices":case"positions":case"normals":case"pickingColors":t="vectors";break;default:}switch(t){case"vectors":e.size=e.size||3;break;case"uvs":e.size=e.size||2;break;default:}J(Number.isFinite(e.size),"attribute ".concat(s," needs size"))}var Dh=2,$k=1e4,eV="Model needs drawMode and vertexCount",Rw=()=>{},tV={},At=class{constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},{id:i=Si("model")}=t;J(ks(e)),this.id=i,this.gl=e,this.id=t.id||Si("Model"),this.lastLogTime=0,this.animated=!1,this.initialize(t)}initialize(e){this.props={},this.programManager=e.programManager||nn.getDefaultProgramManager(this.gl),this._programManagerState=-1,this._managedProgram=!1;let{program:t=null,vs:i,fs:n,modules:o,defines:a,inject:l,varyings:u,bufferMode:c,transpileToGLSL100:h}=e;this.programProps={program:t,vs:i,fs:n,modules:o,defines:a,inject:l,varyings:u,bufferMode:c,transpileToGLSL100:h},this.program=null,this.vertexArray=null,this._programDirty=!0,this.userData={},this.needsRedraw=!0,this._attributes={},this.attributes={},this.uniforms={},this.pickable=!0,this._checkProgram(),this.setUniforms(Object.assign({},this.getModuleUniforms(e.moduleSettings))),this.drawMode=e.drawMode!==void 0?e.drawMode:4,this.vertexCount=e.vertexCount||0,this.geometryBuffers={},this.isInstanced=e.isInstanced||e.instanced||e.instanceCount>0,this._setModelProps(e),this.geometry={},J(this.drawMode!==void 0&&Number.isFinite(this.vertexCount),eV)}setProps(e){this._setModelProps(e)}delete(){for(let e in this._attributes)this._attributes[e]!==this.attributes[e]&&this._attributes[e].delete();this._managedProgram&&(this.programManager.release(this.program),this._managedProgram=!1),this.vertexArray.delete(),this._deleteGeometryBuffers()}getDrawMode(){return this.drawMode}getVertexCount(){return this.vertexCount}getInstanceCount(){return this.instanceCount}getAttributes(){return this.attributes}getProgram(){return this.program}setProgram(e){let{program:t,vs:i,fs:n,modules:o,defines:a,inject:l,varyings:u,bufferMode:c,transpileToGLSL100:h}=e;this.programProps={program:t,vs:i,fs:n,modules:o,defines:a,inject:l,varyings:u,bufferMode:c,transpileToGLSL100:h},this._programDirty=!0}getUniforms(){return this.uniforms}setDrawMode(e){return this.drawMode=e,this}setVertexCount(e){return J(Number.isFinite(e)),this.vertexCount=e,this}setInstanceCount(e){return J(Number.isFinite(e)),this.instanceCount=e,this}setGeometry(e){return this.drawMode=e.drawMode,this.vertexCount=e.getVertexCount(),this._deleteGeometryBuffers(),this.geometryBuffers=Lw(this.gl,e),this.vertexArray.setAttributes(this.geometryBuffers),this}setAttributes(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(ts(e))return this;let t={};for(let i in e){let n=e[i];t[i]=n.getValue?n.getValue():n}return this.vertexArray.setAttributes(t),this}setUniforms(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return Object.assign(this.uniforms,e),this}getModuleUniforms(e){this._checkProgram();let t=this.programManager.getUniforms(this.program);return t?t(e):{}}updateModuleSettings(e){let t=this.getModuleUniforms(e||{});return this.setUniforms(t)}clear(e){return nl(this.program.gl,e),this}draw(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this._checkProgram();let{moduleSettings:t=null,framebuffer:i,uniforms:n={},attributes:o={},transformFeedback:a=this.transformFeedback,parameters:l={},vertexArray:u=this.vertexArray}=e;this.setAttributes(o),this.updateModuleSettings(t),this.setUniforms(n);let c;se.priority>=Dh&&(c=this._logDrawCallStart(Dh));let h=this.vertexArray.getDrawParams(),{isIndexed:d=h.isIndexed,indexType:f=h.indexType,indexOffset:p=h.indexOffset,vertexArrayInstanced:S=h.isInstanced}=this.props;S&&!this.isInstanced&&se.warn("Found instanced attributes on non-instanced model",this.id)();let{isInstanced:E,instanceCount:C}=this,{onBeforeRender:O=Rw,onAfterRender:B=Rw}=this.props;O(),this.program.setUniforms(this.uniforms);let A=this.program.draw(Object.assign(tV,e,{logPriority:c,uniforms:null,framebuffer:i,parameters:l,drawMode:this.getDrawMode(),vertexCount:this.getVertexCount(),vertexArray:u,transformFeedback:a,isIndexed:d,indexType:f,isInstanced:E,instanceCount:C,offset:d?p:0}));return B(),se.priority>=Dh&&this._logDrawCallEnd(c,u,i),A}transform(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{discard:t=!0,feedbackBuffers:i,unbindModels:n=[]}=e,{parameters:o}=e;i&&this._setFeedbackBuffers(i),t&&(o=Object.assign({},o,{[35977]:t})),n.forEach(a=>a.vertexArray.unbindBuffers());try{this.draw(Object.assign({},e,{parameters:o}))}finally{n.forEach(a=>a.vertexArray.bindBuffers())}return this}render(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return se.warn("Model.render() is deprecated. Use Model.setUniforms() and Model.draw()")(),this.setUniforms(e).draw()}_setModelProps(e){Object.assign(this.props,e),"uniforms"in e&&this.setUniforms(e.uniforms),"pickable"in e&&(this.pickable=e.pickable),"instanceCount"in e&&(this.instanceCount=e.instanceCount),"geometry"in e&&this.setGeometry(e.geometry),"attributes"in e&&this.setAttributes(e.attributes),"_feedbackBuffers"in e&&this._setFeedbackBuffers(e._feedbackBuffers)}_checkProgram(){if(!(this._programDirty||this.programManager.stateHash!==this._programManagerState))return;let{program:t}=this.programProps;if(t)this._managedProgram=!1;else{let{vs:i,fs:n,modules:o,inject:a,defines:l,varyings:u,bufferMode:c,transpileToGLSL100:h}=this.programProps;t=this.programManager.get({vs:i,fs:n,modules:o,inject:a,defines:l,varyings:u,bufferMode:c,transpileToGLSL100:h}),this.program&&this._managedProgram&&this.programManager.release(this.program),this._programManagerState=this.programManager.stateHash,this._managedProgram=!0}J(t instanceof Ws,"Model needs a program"),this._programDirty=!1,t!==this.program&&(this.program=t,this.vertexArray?this.vertexArray.setProps({program:this.program,attributes:this.vertexArray.attributes}):this.vertexArray=new vh(this.gl,{program:this.program}),this.setUniforms(Object.assign({},this.getModuleUniforms())))}_deleteGeometryBuffers(){for(let e in this.geometryBuffers){let t=this.geometryBuffers[e][0]||this.geometryBuffers[e];t instanceof ye&&t.delete()}}_setAnimationProps(e){this.animated&&J(e,"Model.draw(): animated uniforms but no animationProps")}_setFeedbackBuffers(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(ts(e))return this;let{gl:t}=this.program;return this.transformFeedback=this.transformFeedback||new js(t,{program:this.program}),this.transformFeedback.setBuffers(e),this}_logDrawCallStart(e){let t=e>3?0:$k;if(!(Date.now()-this.lastLogTime<t))return this.lastLogTime=Date.now(),se.group(Dh,">>> DRAWING MODEL ".concat(this.id),{collapsed:se.level<=2})(),e}_logDrawCallEnd(e,t,i,n){if(e===void 0)return;let o=DE({vertexArray:t,header:"".concat(this.id," attributes"),attributes:this._attributes}),{table:a,unusedTable:l,unusedCount:u}=gP({header:"".concat(this.id," uniforms"),program:this.program,uniforms:Object.assign({},this.program.uniforms,i)}),{table:c,count:h}=gP({header:"".concat(this.id," uniforms"),program:this.program,uniforms:Object.assign({},this.program.uniforms,i),undefinedOnly:!0});h>0&&se.log("MISSING UNIFORMS",Object.keys(c))(),u>0&&se.log("UNUSED UNIFORMS",Object.keys(l))();let d=GE(this.vertexArray.configuration);se.table(e,o)(),se.table(e,a)(),se.table(e+1,d)(),n&&n.log({logLevel:Dh,message:"Rendered to ".concat(n.id)}),se.groupEnd(Dh)()}};var og=class{constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};this.gl=e,this.currentIndex=0,this.feedbackMap={},this.varyings=null,this.bindings=[],this.resources={},this._initialize(t),Object.seal(this)}setupResources(e){for(let t of this.bindings)this._setupTransformFeedback(t,e)}updateModelProps(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{varyings:t}=this;return t.length>0&&(e=Object.assign({},e,{varyings:t})),e}getDrawOptions(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=this.bindings[this.currentIndex],{sourceBuffers:i,transformFeedback:n}=t;return{attributes:Object.assign({},i,e.attributes),transformFeedback:n}}swap(){return this.feedbackMap?(this.currentIndex=this._getNextIndex(),!0):!1}update(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this._setupBuffers(e)}getBuffer(e){let{feedbackBuffers:t}=this.bindings[this.currentIndex],i=e?t[e]:null;return i?i instanceof ye?i:i.buffer:null}getData(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{varyingName:t}=e,i=this.getBuffer(t);return i?i.getData():null}delete(){for(let e in this.resources)this.resources[e].delete()}_initialize(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this._setupBuffers(e),this.varyings=e.varyings||Object.keys(this.bindings[this.currentIndex].feedbackBuffers),this.varyings.length>0&&J(ge(this.gl))}_getFeedbackBuffers(e){let{sourceBuffers:t={}}=e,i={};if(this.bindings[this.currentIndex]&&Object.assign(i,this.bindings[this.currentIndex].feedbackBuffers),this.feedbackMap)for(let n in this.feedbackMap){let o=this.feedbackMap[n];n in t&&(i[o]=n)}Object.assign(i,e.feedbackBuffers);for(let n in i){let o=i[n];if(typeof o=="string"){let a=t[o],{byteLength:l,usage:u,accessor:c}=a;i[n]=this._createNewBuffer(n,{byteLength:l,usage:u,accessor:c})}}return i}_setupBuffers(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{sourceBuffers:t=null}=e;Object.assign(this.feedbackMap,e.feedbackMap);let i=this._getFeedbackBuffers(e);this._updateBindings({sourceBuffers:t,feedbackBuffers:i})}_setupTransformFeedback(e,t){let{model:i}=t,{program:n}=i;e.transformFeedback=new js(this.gl,{program:n,buffers:e.feedbackBuffers})}_updateBindings(e){if(this.bindings[this.currentIndex]=this._updateBinding(this.bindings[this.currentIndex],e),this.feedbackMap){let{sourceBuffers:t,feedbackBuffers:i}=this._swapBuffers(this.bindings[this.currentIndex]),n=this._getNextIndex();this.bindings[n]=this._updateBinding(this.bindings[n],{sourceBuffers:t,feedbackBuffers:i})}}_updateBinding(e,t){return e?(Object.assign(e.sourceBuffers,t.sourceBuffers),Object.assign(e.feedbackBuffers,t.feedbackBuffers),e.transformFeedback&&e.transformFeedback.setBuffers(e.feedbackBuffers),e):{sourceBuffers:Object.assign({},t.sourceBuffers),feedbackBuffers:Object.assign({},t.feedbackBuffers)}}_swapBuffers(e){if(!this.feedbackMap)return null;let t=Object.assign({},e.sourceBuffers),i=Object.assign({},e.feedbackBuffers);for(let n in this.feedbackMap){let o=this.feedbackMap[n];t[n]=e.feedbackBuffers[o],i[o]=e.sourceBuffers[n],J(i[o]instanceof ye)}return{sourceBuffers:t,feedbackBuffers:i}}_createNewBuffer(e,t){let i=new ye(this.gl,t);return this.resources[e]&&this.resources[e].delete(),this.resources[e]=i,i}_getNextIndex(){return(this.currentIndex+1)%2}};var rV="transform_uSampler_",GP="transform_uSize_",Ow="transform_position";function _w(s){let{vs:e,sourceTextureMap:t,targetTextureVarying:i,targetTexture:n}=s,a=Object.keys(t).length,l=null,u={},c=e,h={};if(a>0||i){let d=c.split(`
`),f=d.slice();if(d.forEach((p,S,E)=>{if(a>0){let C=sV(p,t);if(C){let{updatedLine:O,inject:B}=C;f[S]=O,h=Ah([h,B]),Object.assign(u,C.samplerTextureMap),a--}}i&&!l&&(l=oV(p,i))}),i){J(n);let p="".concat(GP).concat(i),S="uniform vec2 ".concat(p,`;
`),E="     vec2 ".concat(Ow," = transform_getPos(").concat(p,`);
     gl_Position = vec4(`).concat(Ow,`, 0, 1.);
`);h=Ah([h,{"vs:#decl":S,"vs:#main-start":E}])}c=f.join(`
`)}return{vs:c,targetTextureType:l,inject:h,samplerTextureMap:u}}function Nw(s){let{sourceTextureMap:e,targetTextureVarying:t,targetTexture:i}=s,n={},o,a;t&&({width:o,height:a}=i,n["".concat(GP).concat(t)]=[o,a]);for(let l in e)({width:o,height:a}=e[l]),n["".concat(GP).concat(l)]=[o,a];return n}function iV(s){return bP(s,["attribute","in"])}function nV(s){let e="".concat(rV).concat(s),t="".concat(GP).concat(s),i="  uniform sampler2D ".concat(e,`;
  uniform vec2 `).concat(t,";");return{samplerName:e,sizeName:t,uniformDeclerations:i}}function oV(s,e){let t=bP(s,["varying","out"]);return t&&t.name===e?t.type:null}function sV(s,e){let t={},i=iV(s);if(!i)return null;let{type:n,name:o}=i;if(o&&e[o]){let a="// ".concat(s," => Replaced by Transform with a sampler"),{samplerName:l,sizeName:u,uniformDeclerations:c}=nV(o),h=YE(n),d="  ".concat(n," ").concat(o," = transform_getInput(").concat(l,", ").concat(u,").").concat(h,`;
`);return t[l]=o,{updatedLine:a,inject:{"vs:#decl":c,"vs:#main-start":d},samplerTextureMap:t}}return null}var aV={[10241]:9728,[10240]:9728,[10242]:33071,[10243]:33071},lV="transform_output",sg=class{constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};this.gl=e,this.id=this.currentIndex=0,this._swapTexture=null,this.targetTextureVarying=null,this.targetTextureType=null,this.samplerTextureMap=null,this.bindings=[],this.resources={},this._initialize(t),Object.seal(this)}updateModelProps(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=this._processVertexShader(e);return Object.assign({},e,t)}getDrawOptions(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{sourceBuffers:t,sourceTextures:i,framebuffer:n,targetTexture:o}=this.bindings[this.currentIndex],a=Object.assign({},t,e.attributes),l=Object.assign({},e.uniforms),u=Object.assign({},e.parameters),c=e.discard;if(this.hasSourceTextures||this.hasTargetTexture){a.transform_elementID=this.elementIDBuffer;for(let d in this.samplerTextureMap){let f=this.samplerTextureMap[d];l[d]=i[f]}this._setSourceTextureParameters();let h=Nw({sourceTextureMap:i,targetTextureVarying:this.targetTextureVarying,targetTexture:o});Object.assign(l,h)}return this.hasTargetTexture&&(c=!1,u.viewport=[0,0,n.width,n.height]),{attributes:a,framebuffer:n,uniforms:l,discard:c,parameters:u}}swap(){return this._swapTexture?(this.currentIndex=this._getNextIndex(),!0):!1}update(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this._setupTextures(e)}getTargetTexture(){let{targetTexture:e}=this.bindings[this.currentIndex];return e}getData(){let{packed:e=!1}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{framebuffer:t}=this.bindings[this.currentIndex],i=Us(t);if(!e)return i;let n=i.constructor,o=KE(this.targetTextureType),a=new n(i.length*o/4),l=0;for(let u=0;u<i.length;u+=4)for(let c=0;c<o;c++)a[l++]=i[u+c];return a}getFramebuffer(){return this.bindings[this.currentIndex].framebuffer}delete(){this.ownTexture&&this.ownTexture.delete(),this.elementIDBuffer&&this.elementIDBuffer.delete()}_initialize(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{_targetTextureVarying:t,_swapTexture:i}=e;this._swapTexture=i,this.targetTextureVarying=t,this.hasTargetTexture=t,this._setupTextures(e)}_createTargetTexture(e){let{sourceTextures:t,textureOrReference:i}=e;if(i instanceof Ue)return i;let n=t[i];return n?(this._targetRefTexName=i,this._createNewTexture(n)):null}_setupTextures(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{sourceBuffers:t,_sourceTextures:i={},_targetTexture:n}=e,o=this._createTargetTexture({sourceTextures:i,textureOrReference:n});this.hasSourceTextures=this.hasSourceTextures||i&&Object.keys(i).length>0,this._updateBindings({sourceBuffers:t,sourceTextures:i,targetTexture:o}),"elementCount"in e&&this._updateElementIDBuffer(e.elementCount)}_updateElementIDBuffer(e){if(typeof e!="number"||this.elementCount>=e)return;let t=new Float32Array(e);t.forEach((i,n,o)=>{o[n]=n}),this.elementIDBuffer?this.elementIDBuffer.setData({data:t}):this.elementIDBuffer=new ye(this.gl,{data:t,accessor:{size:1}}),this.elementCount=e}_updateBindings(e){if(this.bindings[this.currentIndex]=this._updateBinding(this.bindings[this.currentIndex],e),this._swapTexture){let{sourceTextures:t,targetTexture:i}=this._swapTextures(this.bindings[this.currentIndex]),n=this._getNextIndex();this.bindings[n]=this._updateBinding(this.bindings[n],{sourceTextures:t,targetTexture:i})}}_updateBinding(e,t){let{sourceBuffers:i,sourceTextures:n,targetTexture:o}=t;if(e||(e={sourceBuffers:{},sourceTextures:{},targetTexture:null}),Object.assign(e.sourceTextures,n),Object.assign(e.sourceBuffers,i),o){e.targetTexture=o;let{width:a,height:l}=o,{framebuffer:u}=e;u?(u.update({attachments:{[36064]:o},resizeAttachments:!1}),u.resize({width:a,height:l})):e.framebuffer=new De(this.gl,{id:"transform-framebuffer",width:a,height:l,attachments:{[36064]:o}})}return e}_setSourceTextureParameters(){let e=this.currentIndex,{sourceTextures:t}=this.bindings[e];for(let i in t)t[i].setParameters(aV)}_swapTextures(e){if(!this._swapTexture)return null;let t=Object.assign({},e.sourceTextures);t[this._swapTexture]=e.targetTexture;let i=e.sourceTextures[this._swapTexture];return{sourceTextures:t,targetTexture:i}}_createNewTexture(e){let t=lP(e,{parameters:{[10241]:9728,[10240]:9728,[10242]:33071,[10243]:33071},pixelStore:{[37440]:!1}});return this.ownTexture&&this.ownTexture.delete(),this.ownTexture=t,t}_getNextIndex(){return(this.currentIndex+1)%2}_processVertexShader(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{sourceTextures:t,targetTexture:i}=this.bindings[this.currentIndex],{vs:n,uniforms:o,targetTextureType:a,inject:l,samplerTextureMap:u}=_w({vs:e.vs,sourceTextureMap:t,targetTextureVarying:this.targetTextureVarying,targetTexture:i}),c=Ah([e.inject||{},l]);this.targetTextureType=a,this.samplerTextureMap=u;let h=e._fs||tg({version:xh(n),input:this.targetTextureVarying,inputType:a,output:lV}),d=this.hasSourceTextures||this.targetTextureVarying?[gx].concat(e.modules||[]):e.modules;return{vs:n,fs:h,modules:d,uniforms:o,inject:c}}};var on=class{static isSupported(e){return ge(e)}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};this.gl=e,this.model=null,this.elementCount=0,this.bufferTransform=null,this.textureTransform=null,this.elementIDBuffer=null,this._initialize(t),Object.seal(this)}delete(){let{model:e,bufferTransform:t,textureTransform:i}=this;e&&e.delete(),t&&t.delete(),i&&i.delete()}run(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{clearRenderTarget:t=!0}=e,i=this._updateDrawOptions(e);t&&i.framebuffer&&i.framebuffer.clear({color:!0}),this.model.transform(i)}swap(){let e=!1,t=[this.bufferTransform,this.textureTransform].filter(Boolean);for(let i of t)e=e||i.swap();J(e,"Nothing to swap")}getBuffer(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:null;return this.bufferTransform&&this.bufferTransform.getBuffer(e)}getData(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=[this.bufferTransform,this.textureTransform].filter(Boolean);for(let i of t){let n=i.getData(e);if(n)return n}return null}getFramebuffer(){return this.textureTransform&&this.textureTransform.getFramebuffer()}update(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};"elementCount"in e&&this.model.setVertexCount(e.elementCount);let t=[this.bufferTransform,this.textureTransform].filter(Boolean);for(let i of t)i.update(e)}_initialize(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{gl:t}=this;this._buildResourceTransforms(t,e),e=this._updateModelProps(e),this.model=new At(t,Object.assign({},e,{fs:e.fs||tg({version:xh(e.vs)}),id:e.id||"transform-model",drawMode:e.drawMode||0,vertexCount:e.elementCount})),this.bufferTransform&&this.bufferTransform.setupResources({model:this.model})}_updateModelProps(e){let t=Object.assign({},e),i=[this.bufferTransform,this.textureTransform].filter(Boolean);for(let n of i)t=n.updateModelProps(t);return t}_buildResourceTransforms(e,t){uV(t)&&(this.bufferTransform=new og(e,t)),cV(t)&&(this.textureTransform=new sg(e,t)),J(this.bufferTransform||this.textureTransform,"must provide source/feedback buffers or source/target textures")}_updateDrawOptions(e){let t=Object.assign({},e),i=[this.bufferTransform,this.textureTransform].filter(Boolean);for(let n of i)t=Object.assign(t,n.getDrawOptions(t));return t}};function uV(s){return!!(!ts(s.feedbackBuffers)||!ts(s.feedbackMap)||s.varyings&&s.varyings.length>0)}function cV(s){return!!(!ts(s._sourceTextures)||s._targetTexture||s._targetTextureVarying)}var Mw={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},pr=class{static get DRAW_MODE(){return Mw}constructor(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{id:t=Si("geometry"),drawMode:i=Mw.TRIANGLES,attributes:n={},indices:o=null,vertexCount:a=null}=e;this.id=t,this.drawMode=i|0,this.attributes={},this.userData={},this._setAttributes(n,o),this.vertexCount=a||this._calculateVertexCount(this.attributes,this.indices)}get mode(){return this.drawMode}getVertexCount(){return this.vertexCount}getAttributes(){return this.indices?{indices:this.indices,...this.attributes}:this.attributes}_print(e){return"Geometry ".concat(this.id," attribute ").concat(e)}_setAttributes(e,t){t&&(this.indices=ArrayBuffer.isView(t)?{value:t,size:1}:t);for(let i in e){let n=e[i];n=ArrayBuffer.isView(n)?{value:n}:n,J(ArrayBuffer.isView(n.value),"".concat(this._print(i),": must be typed array or object with value as typed array")),(i==="POSITION"||i==="positions")&&!n.size&&(n.size=3),i==="indices"?(J(!this.indices),this.indices=n):this.attributes[i]=n}return this.indices&&this.indices.isIndexed!==void 0&&(this.indices=Object.assign({},this.indices),delete this.indices.isIndexed),this}_calculateVertexCount(e,t){if(t)return t.value.length;let i=1/0;for(let n in e){let o=e[n],{value:a,size:l,constant:u}=o;!u&&a&&l>=1&&(i=Math.min(i,a.length/l))}return J(Number.isFinite(i)),i}};var hV=1,dV=1,dl=class{constructor(){this.time=0,this.channels=new Map,this.animations=new Map,this.playing=!1,this.lastEngineTime=-1}addChannel(e){let{delay:t=0,duration:i=Number.POSITIVE_INFINITY,rate:n=1,repeat:o=1}=e,a=hV++,l={time:0,delay:t,duration:i,rate:n,repeat:o};return this._setChannelTime(l,this.time),this.channels.set(a,l),a}removeChannel(e){this.channels.delete(e);for(let[t,i]of this.animations)i.channel===e&&this.detachAnimation(t)}isFinished(e){let t=this.channels.get(e);return t===void 0?!1:this.time>=t.delay+t.duration*t.repeat}getTime(e){if(e===void 0)return this.time;let t=this.channels.get(e);return t===void 0?-1:t.time}setTime(e){this.time=Math.max(0,e);let t=this.channels.values();for(let n of t)this._setChannelTime(n,this.time);let i=this.animations.values();for(let n of i){let{animation:o,channel:a}=n;o.setTime(this.getTime(a))}}play(){this.playing=!0}pause(){this.playing=!1,this.lastEngineTime=-1}reset(){this.setTime(0)}attachAnimation(e,t){let i=dV++;return this.animations.set(i,{animation:e,channel:t}),e.setTime(this.getTime(t)),i}detachAnimation(e){this.animations.delete(e)}update(e){this.playing&&(this.lastEngineTime===-1&&(this.lastEngineTime=e),this.setTime(this.time+(e-this.lastEngineTime)),this.lastEngineTime=e)}_setChannelTime(e,t){let i=t-e.delay,n=e.duration*e.repeat;i>=n?e.time=e.duration*e.rate:(e.time=Math.max(0,i)%e.duration,e.time*=e.rate)}};var Bw="#define SMOOTH_EDGE_RADIUS 0.5",fV=`
`.concat(Bw,`

struct VertexGeometry {
  vec4 position;
  vec3 worldPosition;
  vec3 worldPositionAlt;
  vec3 normal;
  vec2 uv;
  vec3 pickingColor;
} geometry = VertexGeometry(
  vec4(0.0, 0.0, 1.0, 0.0),
  vec3(0.0),
  vec3(0.0),
  vec3(0.0),
  vec2(0.0),
  vec3(0.0)
);
`),gV=`
`.concat(Bw,`

struct FragmentGeometry {
  vec2 uv;
} geometry;

float smoothedge(float edge, float x) {
  return smoothstep(edge - SMOOTH_EDGE_RADIUS, edge + SMOOTH_EDGE_RADIUS, x);
}
`),Dw={name:"geometry",vs:fV,fs:gV};var Ge={DEFAULT:-1,LNGLAT:1,METER_OFFSETS:2,LNGLAT_OFFSETS:3,CARTESIAN:0};Object.defineProperty(Ge,"IDENTITY",{get:()=>(fe.deprecated("COORDINATE_SYSTEM.IDENTITY","COORDINATE_SYSTEM.CARTESIAN")(),0)});var si={WEB_MERCATOR:1,GLOBE:2,WEB_MERCATOR_AUTO_OFFSET:4,IDENTITY:0},Ur={common:0,meters:1,pixels:2},mx={click:{handler:"onClick"},panstart:{handler:"onDragStart"},panmove:{handler:"onDrag"},panend:{handler:"onDragEnd"}},lo={DRAW:"draw",MASK:"mask"};var pV=Object.keys(Ge).map(s=>"const int COORDINATE_SYSTEM_".concat(s," = ").concat(Ge[s],";")).join(""),mV=Object.keys(si).map(s=>"const int PROJECTION_MODE_".concat(s," = ").concat(si[s],";")).join(""),bV=Object.keys(Ur).map(s=>"const int UNIT_".concat(s.toUpperCase()," = ").concat(Ur[s],";")).join(""),Gw="".concat(pV,`
`).concat(mV,`
`).concat(bV,`

uniform int project_uCoordinateSystem;
uniform int project_uProjectionMode;
uniform float project_uScale;
uniform bool project_uWrapLongitude;
uniform vec3 project_uCommonUnitsPerMeter;
uniform vec3 project_uCommonUnitsPerWorldUnit;
uniform vec3 project_uCommonUnitsPerWorldUnit2;
uniform vec4 project_uCenter;
uniform mat4 project_uModelMatrix;
uniform mat4 project_uViewProjectionMatrix;
uniform vec2 project_uViewportSize;
uniform float project_uDevicePixelRatio;
uniform float project_uFocalDistance;
uniform vec3 project_uCameraPosition;
uniform vec3 project_uCoordinateOrigin;
uniform vec3 project_uCommonOrigin;
uniform bool project_uPseudoMeters;

const float TILE_SIZE = 512.0;
const float PI = 3.1415926536;
const float WORLD_SCALE = TILE_SIZE / (PI * 2.0);
const vec3 ZERO_64_LOW = vec3(0.0);
const float EARTH_RADIUS = 6370972.0; // meters
const float GLOBE_RADIUS = 256.0;

// returns an adjustment factor for uCommonUnitsPerMeter
float project_size_at_latitude(float lat) {
  float y = clamp(lat, -89.9, 89.9);
  return 1.0 / cos(radians(y));
}

float project_size() {
  if (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR &&
    project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT &&
    project_uPseudoMeters == false) {

    // uCommonUnitsPerMeter in low-zoom Web Mercator is non-linear
    // Adjust by 1 / cos(latitude)
    // If geometry.position (vertex in common space) is populated, use it
    // Otherwise use geometry.worldPosition (anchor in world space)
    
    if (geometry.position.w == 0.0) {
      return project_size_at_latitude(geometry.worldPosition.y);
    }

    // latitude from common y: 2.0 * (atan(exp(y / TILE_SIZE * 2.0 * PI - PI)) - PI / 4.0)
    // Taylor series of 1 / cos(latitude)
    // Max error < 0.003
  
    float y = geometry.position.y / TILE_SIZE * 2.0 - 1.0;
    float y2 = y * y;
    float y4 = y2 * y2;
    float y6 = y4 * y2;
    return 1.0 + 4.9348 * y2 + 4.0587 * y4 + 1.5642 * y6;
  }
  return 1.0;
}

float project_size_at_latitude(float meters, float lat) {
  return meters * project_uCommonUnitsPerMeter.z * project_size_at_latitude(lat);
}

//
// Scaling offsets - scales meters to "world distance"
// Note the scalar version of project_size is for scaling the z component only
//
float project_size(float meters) {
  return meters * project_uCommonUnitsPerMeter.z * project_size();
}

vec2 project_size(vec2 meters) {
  return meters * project_uCommonUnitsPerMeter.xy * project_size();
}

vec3 project_size(vec3 meters) {
  return meters * project_uCommonUnitsPerMeter * project_size();
}

vec4 project_size(vec4 meters) {
  return vec4(meters.xyz * project_uCommonUnitsPerMeter, meters.w);
}

// Get rotation matrix that aligns the z axis with the given up vector
// Find 3 unit vectors ux, uy, uz that are perpendicular to each other and uz == up
mat3 project_get_orientation_matrix(vec3 up) {
  vec3 uz = normalize(up);
  // Tangent on XY plane
  vec3 ux = abs(uz.z) == 1.0 ? vec3(1.0, 0.0, 0.0) : normalize(vec3(uz.y, -uz.x, 0));
  vec3 uy = cross(uz, ux);
  return mat3(ux, uy, uz);
}

bool project_needs_rotation(vec3 commonPosition, out mat3 transform) {
  if (project_uProjectionMode == PROJECTION_MODE_GLOBE) {
    transform = project_get_orientation_matrix(commonPosition);
    return true;
  }
  return false;
}

//
// Projecting normal - transform deltas from current coordinate system to
// normals in the worldspace
//
vec3 project_normal(vec3 vector) {
  // Apply model matrix
  vec4 normal_modelspace = project_uModelMatrix * vec4(vector, 0.0);
  vec3 n = normalize(normal_modelspace.xyz * project_uCommonUnitsPerMeter);
  mat3 rotation;
  if (project_needs_rotation(geometry.position.xyz, rotation)) {
    n = rotation * n;
  }
  return n;
}

vec4 project_offset_(vec4 offset) {
  float dy = offset.y;
  vec3 commonUnitsPerWorldUnit = project_uCommonUnitsPerWorldUnit + project_uCommonUnitsPerWorldUnit2 * dy;
  return vec4(offset.xyz * commonUnitsPerWorldUnit, offset.w);
}

//
// Projecting positions - non-linear projection: lnglats => unit tile [0-1, 0-1]
//
vec2 project_mercator_(vec2 lnglat) {
  float x = lnglat.x;
  if (project_uWrapLongitude) {
    x = mod(x + 180., 360.0) - 180.;
  }
  float y = clamp(lnglat.y, -89.9, 89.9);
  return vec2(
    radians(x) + PI,
    PI + log(tan_fp32(PI * 0.25 + radians(y) * 0.5))
  ) * WORLD_SCALE;
}

vec3 project_globe_(vec3 lnglatz) {
  float lambda = radians(lnglatz.x);
  float phi = radians(lnglatz.y);
  float cosPhi = cos(phi);
  float D = (lnglatz.z / EARTH_RADIUS + 1.0) * GLOBE_RADIUS;

  return vec3(
    sin(lambda) * cosPhi,
    -cos(lambda) * cosPhi,
    sin(phi)
  ) * D;
}

//
// Projects positions (defined by project_uCoordinateSystem) to common space (defined by project_uProjectionMode)
//
vec4 project_position(vec4 position, vec3 position64Low) {
  vec4 position_world = project_uModelMatrix * position;

  // Work around for a Mac+NVIDIA bug https://github.com/visgl/deck.gl/issues/4145
  if (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR) {
    if (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      return vec4(
        project_mercator_(position_world.xy),
        project_size_at_latitude(position_world.z, position_world.y),
        position_world.w
      );
    }
    if (project_uCoordinateSystem == COORDINATE_SYSTEM_CARTESIAN) {
      position_world.xyz += project_uCoordinateOrigin;
    }
  }
  if (project_uProjectionMode == PROJECTION_MODE_GLOBE) {
    if (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      return vec4(
        project_globe_(position_world.xyz),
        position_world.w
      );
    }
  }
  if (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET) {
    if (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      if (abs(position_world.y - project_uCoordinateOrigin.y) > 0.25) {
        // Too far from the projection center for offset mode to be accurate
        // Only use high parts
        return vec4(
          project_mercator_(position_world.xy) - project_uCommonOrigin.xy,
          project_size(position_world.z),
          position_world.w
        );
      }
    }
  }
  if (project_uProjectionMode == PROJECTION_MODE_IDENTITY ||
    (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET &&
    (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT ||
     project_uCoordinateSystem == COORDINATE_SYSTEM_CARTESIAN))) {
    // Subtract high part of 64 bit value. Convert remainder to float32, preserving precision.
    position_world.xyz -= project_uCoordinateOrigin;
  }

  // Translation is already added to the high parts
  return project_offset_(position_world + project_uModelMatrix * vec4(position64Low, 0.0));
}

vec4 project_position(vec4 position) {
  return project_position(position, ZERO_64_LOW);
}

vec3 project_position(vec3 position, vec3 position64Low) {
  vec4 projected_position = project_position(vec4(position, 1.0), position64Low);
  return projected_position.xyz;
}

vec3 project_position(vec3 position) {
  vec4 projected_position = project_position(vec4(position, 1.0), ZERO_64_LOW);
  return projected_position.xyz;
}

vec2 project_position(vec2 position) {
  vec4 projected_position = project_position(vec4(position, 0.0, 1.0), ZERO_64_LOW);
  return projected_position.xy;
}

vec4 project_common_position_to_clipspace(vec4 position, mat4 viewProjectionMatrix, vec4 center) {
  return viewProjectionMatrix * position + center;
}

//
// Projects from common space coordinates to clip space.
// Uses project_uViewProjectionMatrix
//
vec4 project_common_position_to_clipspace(vec4 position) {
  return project_common_position_to_clipspace(position, project_uViewProjectionMatrix, project_uCenter);
}

// Returns a clip space offset that corresponds to a given number of screen pixels
vec2 project_pixel_size_to_clipspace(vec2 pixels) {
  vec2 offset = pixels / project_uViewportSize * project_uDevicePixelRatio * 2.0;
  return offset * project_uFocalDistance;
}

float project_size_to_pixel(float meters) {
  return project_size(meters) * project_uScale;
}
float project_size_to_pixel(float size, int unit) {
  if (unit == UNIT_METERS) return project_size_to_pixel(size);
  if (unit == UNIT_COMMON) return size * project_uScale;
  // UNIT_PIXELS
  return size;
}
float project_pixel_size(float pixels) {
  return pixels / project_uScale;
}
vec2 project_pixel_size(vec2 pixels) {
  return pixels / project_uScale;
}
`);function PV(s,e){if(s===e)return!0;if(Array.isArray(s)){let t=s.length;if(!e||e.length!==t)return!1;for(let i=0;i<t;i++)if(s[i]!==e[i])return!1;return!0}return!1}function uo(s){let e={},t;return i=>{for(let n in i)if(!PV(i[n],e[n])){t=s(i),e=i;break}return t}}var Fw=[0,0,0,0],yV=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0],kw=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],SV=[0,0,0],Vw=[0,0,0],EV=uo(vV);function bx(s,e,t=Vw){t.length<3&&(t=[t[0],t[1],0]);let i=t,n,o=!0;switch(e===Ge.LNGLAT_OFFSETS||e===Ge.METER_OFFSETS?n=t:n=s.isGeospatial?[Math.fround(s.longitude),Math.fround(s.latitude),0]:null,s.projectionMode){case si.WEB_MERCATOR:(e===Ge.LNGLAT||e===Ge.CARTESIAN)&&(n=[0,0,0],o=!1);break;case si.WEB_MERCATOR_AUTO_OFFSET:e===Ge.LNGLAT?i=n:e===Ge.CARTESIAN&&(i=[Math.fround(s.center[0]),Math.fround(s.center[1]),0],n=s.unprojectPosition(i),i[0]-=t[0],i[1]-=t[1],i[2]-=t[2]);break;case si.IDENTITY:i=s.position.map(Math.fround),i[2]=i[2]||0;break;case si.GLOBE:o=!1,n=null;break;default:o=!1}return{geospatialOrigin:n,shaderCoordinateOrigin:i,offsetMode:o}}function xV(s,e,t){let{viewMatrixUncentered:i,projectionMatrix:n}=s,{viewMatrix:o,viewProjectionMatrix:a}=s,l=Fw,u=Fw,c=s.cameraPosition,{geospatialOrigin:h,shaderCoordinateOrigin:d,offsetMode:f}=bx(s,e,t);return f&&(u=s.projectPosition(h||d),c=[c[0]-u[0],c[1]-u[1],c[2]-u[2]],u[3]=1,l=ao([],u,a),o=i||o,a=rs([],n,o),a=rs([],a,yV)),{viewMatrix:o,viewProjectionMatrix:a,projectionCenter:l,originCommon:u,cameraPosCommon:c,shaderCoordinateOrigin:d,geospatialOrigin:h}}function Uw({viewport:s,devicePixelRatio:e=1,modelMatrix:t=null,coordinateSystem:i=Ge.DEFAULT,coordinateOrigin:n=Vw,autoWrapLongitude:o=!1}){i===Ge.DEFAULT&&(i=s.isGeospatial?Ge.LNGLAT:Ge.CARTESIAN);let a=EV({viewport:s,devicePixelRatio:e,coordinateSystem:i,coordinateOrigin:n});return a.project_uWrapLongitude=o,a.project_uModelMatrix=t||kw,a}function vV({viewport:s,devicePixelRatio:e,coordinateSystem:t,coordinateOrigin:i}){let{projectionCenter:n,viewProjectionMatrix:o,originCommon:a,cameraPosCommon:l,shaderCoordinateOrigin:u,geospatialOrigin:c}=xV(s,t,i),h=s.getDistanceScales(),d=[s.width*e,s.height*e],f=ao([],[0,0,-s.focalDistance,1],s.projectionMatrix)[3]||1,p={project_uCoordinateSystem:t,project_uProjectionMode:s.projectionMode,project_uCoordinateOrigin:u,project_uCommonOrigin:a.slice(0,3),project_uCenter:n,project_uPseudoMeters:Boolean(s._pseudoMeters),project_uViewportSize:d,project_uDevicePixelRatio:e,project_uFocalDistance:f,project_uCommonUnitsPerMeter:h.unitsPerMeter,project_uCommonUnitsPerWorldUnit:h.unitsPerMeter,project_uCommonUnitsPerWorldUnit2:SV,project_uScale:s.scale,project_uWrapLongitude:!1,project_uViewProjectionMatrix:o,project_uModelMatrix:kw,project_uCameraPosition:l};if(c){let S=s.getDistanceScales(c);switch(t){case Ge.METER_OFFSETS:p.project_uCommonUnitsPerWorldUnit=S.unitsPerMeter,p.project_uCommonUnitsPerWorldUnit2=S.unitsPerMeter2;break;case Ge.LNGLAT:case Ge.LNGLAT_OFFSETS:s._pseudoMeters||(p.project_uCommonUnitsPerMeter=S.unitsPerMeter),p.project_uCommonUnitsPerWorldUnit=S.unitsPerDegree,p.project_uCommonUnitsPerWorldUnit2=S.unitsPerDegree2;break;case Ge.CARTESIAN:p.project_uCommonUnitsPerWorldUnit=[1,1,S.unitsPerMeter[2]],p.project_uCommonUnitsPerWorldUnit2=[0,0,S.unitsPerMeter2[2]];break;default:break}}return p}var CV={};function AV(s=CV){return"viewport"in s?Uw(s):{}}var ku={name:"project",dependencies:[PP,Dw],vs:Gw,getUniforms:AV};var TV=`
vec4 project_position_to_clipspace(
  vec3 position, vec3 position64Low, vec3 offset, out vec4 commonPosition
) {
  vec3 projectedPosition = project_position(position, position64Low);
  mat3 rotation;
  if (project_needs_rotation(projectedPosition, rotation)) {
    // offset is specified as ENU
    // when in globe projection, rotate offset so that the ground alighs with the surface of the globe
    offset = rotation * offset;
  }
  commonPosition = vec4(projectedPosition + offset, 1.0);
  return project_common_position_to_clipspace(commonPosition);
}

vec4 project_position_to_clipspace(
  vec3 position, vec3 position64Low, vec3 offset
) {
  vec4 commonPosition;
  return project_position_to_clipspace(position, position64Low, offset, commonPosition);
}
`,ai={name:"project32",dependencies:[ku],vs:TV};function Px(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function fl(s,e){let t=ao([],e,s);return Nh(t,t,1/t[3]),t}function yx(s,e){let t=s%e;return t<0?e+t:t}function ag(s,e,t){return s<e?e:s>t?t:s}function IV(s){return Math.log(s)*Math.LOG2E}var Gh=Math.log2||IV;function Nn(s,e){if(!s)throw new Error(e||"@math.gl/web-mercator: assertion failed.")}var co=Math.PI,zw=co/4,ho=co/180,Sx=180/co,lg=512,Ex=4003e4,Fh=85.051129,Ww=1.5;function xx(s){return Gh(s)}function Mn(s){let[e,t]=s;Nn(Number.isFinite(e)),Nn(Number.isFinite(t)&&t>=-90&&t<=90,"invalid latitude");let i=e*ho,n=t*ho,o=lg*(i+co)/(2*co),a=lg*(co+Math.log(Math.tan(zw+n*.5)))/(2*co);return[o,a]}function sn(s){let[e,t]=s,i=e/lg*(2*co)-co,n=2*(Math.atan(Math.exp(t/lg*(2*co)-co))-zw);return[i*Sx,n*Sx]}function vx(s){let{latitude:e}=s;Nn(Number.isFinite(e));let t=Math.cos(e*ho);return xx(Ex*t)-9}function kh(s){let{latitude:e,longitude:t,highPrecision:i=!1}=s;Nn(Number.isFinite(e)&&Number.isFinite(t));let n=lg,o=Math.cos(e*ho),a=n/360,l=a/o,u=n/Ex/o,c={unitsPerMeter:[u,u,u],metersPerUnit:[1/u,1/u,1/u],unitsPerDegree:[a,l,u],degreesPerUnit:[1/a,1/l,1/u]};if(i){let h=ho*Math.tan(e*ho)/o,d=a*h/2,f=n/Ex*h,p=f/l*u;c.unitsPerDegree2=[0,d,f],c.unitsPerMeter2=[p,0,p]}return c}function ug(s,e){let[t,i,n]=s,[o,a,l]=e,{unitsPerMeter:u,unitsPerMeter2:c}=kh({longitude:t,latitude:i,highPrecision:!0}),h=Mn(s);h[0]+=o*(u[0]+c[0]*a),h[1]+=a*(u[1]+c[1]*a);let d=sn(h),f=(n||0)+(l||0);return Number.isFinite(n)||Number.isFinite(l)?[d[0],d[1],f]:d}function FP(s){let{height:e,pitch:t,bearing:i,altitude:n,scale:o,center:a}=s,l=Px();Gu(l,l,[0,0,-n]),_P(l,l,-t*ho),NP(l,l,i*ho);let u=o/e;return _h(l,l,[u,u,u]),a&&Gu(l,l,_I([],a)),l}function Cx(s){let{width:e,height:t,altitude:i,pitch:n=0,offset:o,center:a,scale:l,nearZMultiplier:u=1,farZMultiplier:c=1}=s,{fovy:h=Vu(Ww)}=s;i!==void 0&&(h=Vu(i));let d=h*ho,f=n*ho,p=cg(h),S=p;a&&(S+=a[2]*l/Math.cos(f)/t);let E=d*(.5+(o?o[1]:0)/t),C=Math.sin(E)*S/Math.sin(ag(Math.PI/2-f-E,.01,Math.PI-.01)),O=Math.sin(f)*C+S,B=S*10,A=Math.min(O*c,B);return{fov:d,aspect:e/t,focalDistance:p,near:u,far:A}}function Vu(s){return 2*Math.atan(.5/s)*Sx}function cg(s){return .5/Math.tan(.5*s*ho)}function Vh(s,e){let[t,i,n=0]=s;return Nn(Number.isFinite(t)&&Number.isFinite(i)&&Number.isFinite(n)),fl(e,[t,i,n,1])}function is(s,e,t=0){let[i,n,o]=s;if(Nn(Number.isFinite(i)&&Number.isFinite(n),"invalid pixel coordinate"),Number.isFinite(o))return fl(e,[i,n,o,1]);let a=fl(e,[i,n,0,1]),l=fl(e,[i,n,1,1]),u=a[2],c=l[2],h=u===c?0:((t||0)-u)/(c-u);return SP([],a,l,h)}function Uu(s){let{width:e,height:t,bounds:i,minExtent:n=0,maxZoom:o=24,offset:a=[0,0]}=s,[[l,u],[c,h]]=i,d=wV(s.padding),f=Mn([l,ag(h,-Fh,Fh)]),p=Mn([c,ag(u,-Fh,Fh)]),S=[Math.max(Math.abs(p[0]-f[0]),n),Math.max(Math.abs(p[1]-f[1]),n)],E=[e-d.left-d.right-Math.abs(a[0])*2,t-d.top-d.bottom-Math.abs(a[1])*2];Nn(E[0]>0&&E[1]>0);let C=E[0]/S[0],O=E[1]/S[1],B=(d.right-d.left)/2/C,A=(d.bottom-d.top)/2/O,N=[(p[0]+f[0])/2+B,(p[1]+f[1])/2+A],z=sn(N),Y=Math.min(o,Gh(Math.abs(Math.min(C,O))));return Nn(Number.isFinite(Y)),{longitude:z[0],latitude:z[1],zoom:Y}}function wV(s=0){return typeof s=="number"?{top:s,bottom:s,left:s,right:s}:(Nn(Number.isFinite(s.top)&&Number.isFinite(s.bottom)&&Number.isFinite(s.left)&&Number.isFinite(s.right)),s)}var Hw=Math.PI/180;function hg(s,e=0){let{width:t,height:i,unproject:n}=s,o={targetZ:e},a=n([0,i],o),l=n([t,i],o),u,c,h=s.fovy?.5*s.fovy*Hw:Math.atan(.5/s.altitude),d=(90-s.pitch)*Hw;return h>d-.01?(u=jw(s,0,e),c=jw(s,t,e)):(u=n([0,0],o),c=n([t,0],o)),[a,l,c,u]}function jw(s,e,t){let{pixelUnprojectionMatrix:i}=s,n=fl(i,[e,0,1,1]),o=fl(i,[e,s.height,1,1]),l=(t*s.distanceScales.unitsPerMeter[2]-n[2])/(o[2]-n[2]),u=SP([],n,o,l),c=sn(u);return c.push(t),c}var Xw=512;function kP(s){let{width:e,height:t,pitch:i=0}=s,{longitude:n,latitude:o,zoom:a,bearing:l=0}=s;(n<-180||n>180)&&(n=yx(n+180,360)-180),(l<-180||l>180)&&(l=yx(l+180,360)-180);let u=Gh(t/Xw);if(a<=u)a=u,o=0;else{let c=t/2/Math.pow(2,a),h=sn([0,c])[1];if(o<h)o=h;else{let d=sn([0,Xw-c])[1];o>d&&(o=d)}}return{width:e,height:t,longitude:n,latitude:o,zoom:a,pitch:i,bearing:l}}var OV=`
const int max_lights = 2;
uniform mat4 shadow_uViewProjectionMatrices[max_lights];
uniform vec4 shadow_uProjectCenters[max_lights];
uniform bool shadow_uDrawShadowMap;
uniform bool shadow_uUseShadowMap;
uniform int shadow_uLightId;
uniform float shadow_uLightCount;

varying vec3 shadow_vPosition[max_lights];

vec4 shadow_setVertexPosition(vec4 position_commonspace) {
  if (shadow_uDrawShadowMap) {
    return project_common_position_to_clipspace(position_commonspace, shadow_uViewProjectionMatrices[shadow_uLightId], shadow_uProjectCenters[shadow_uLightId]);
  }
  if (shadow_uUseShadowMap) {
    for (int i = 0; i < max_lights; i++) {
      if(i < int(shadow_uLightCount)) {
        vec4 shadowMap_position = project_common_position_to_clipspace(position_commonspace, shadow_uViewProjectionMatrices[i], shadow_uProjectCenters[i]);
        shadow_vPosition[i] = (shadowMap_position.xyz / shadowMap_position.w + 1.0) / 2.0;
      }
    }
  }
  return gl_Position;
}
`,_V=`
const int max_lights = 2;
uniform bool shadow_uDrawShadowMap;
uniform bool shadow_uUseShadowMap;
uniform sampler2D shadow_uShadowMap0;
uniform sampler2D shadow_uShadowMap1;
uniform vec4 shadow_uColor;
uniform float shadow_uLightCount;

varying vec3 shadow_vPosition[max_lights];

const vec4 bitPackShift = vec4(1.0, 255.0, 65025.0, 16581375.0);
const vec4 bitUnpackShift = 1.0 / bitPackShift;
const vec4 bitMask = vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0,  0.0);

float shadow_getShadowWeight(vec3 position, sampler2D shadowMap) {
  vec4 rgbaDepth = texture2D(shadowMap, position.xy);

  float z = dot(rgbaDepth, bitUnpackShift);
  return smoothstep(0.001, 0.01, position.z - z);
}

vec4 shadow_filterShadowColor(vec4 color) {
  if (shadow_uDrawShadowMap) {
    vec4 rgbaDepth = fract(gl_FragCoord.z * bitPackShift);
    rgbaDepth -= rgbaDepth.gbaa * bitMask;
    return rgbaDepth;
  }
  if (shadow_uUseShadowMap) {
    float shadowAlpha = 0.0;
    shadowAlpha += shadow_getShadowWeight(shadow_vPosition[0], shadow_uShadowMap0);
    if(shadow_uLightCount > 1.0) {
      shadowAlpha += shadow_getShadowWeight(shadow_vPosition[1], shadow_uShadowMap1);
    }
    shadowAlpha *= shadow_uColor.a / shadow_uLightCount;
    float blendedAlpha = shadowAlpha + color.a * (1.0 - shadowAlpha);

    return vec4(
      mix(color.rgb, shadow_uColor.rgb, shadowAlpha / blendedAlpha),
      blendedAlpha
    );
  }
  return color;
}
`,NV=uo(FV),MV=uo(kV),BV=[0,0,0,1],DV=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0];function GV(s,e){let[t,i,n]=s,o=is([t,i,n],e);return Number.isFinite(n)?o:[o[0],o[1],0]}function FV({viewport:s,center:e}){return new $e(s.viewProjectionMatrix).invert().transform(e)}function kV({viewport:s,shadowMatrices:e}){let t=[],i=s.pixelUnprojectionMatrix,n=s.isGeospatial?void 0:1,o=[[0,0,n],[s.width,0,n],[0,s.height,n],[s.width,s.height,n],[0,0,-1],[s.width,0,-1],[0,s.height,-1],[s.width,s.height,-1]].map(a=>GV(a,i));for(let a of e){let l=a.clone().translate(new re(s.center).negate()),u=o.map(h=>l.transform(h)),c=new $e().ortho({left:Math.min(...u.map(h=>h[0])),right:Math.max(...u.map(h=>h[0])),bottom:Math.min(...u.map(h=>h[1])),top:Math.max(...u.map(h=>h[1])),near:Math.min(...u.map(h=>-h[2])),far:Math.max(...u.map(h=>-h[2]))});t.push(c.multiplyRight(a))}return t}function VV(s,e){let{shadowEnabled:t=!0}=s;if(!t||!s.shadowMatrices||!s.shadowMatrices.length)return{shadow_uDrawShadowMap:!1,shadow_uUseShadowMap:!1};let i={shadow_uDrawShadowMap:Boolean(s.drawToShadowMap),shadow_uUseShadowMap:s.shadowMaps?s.shadowMaps.length>0:!1,shadow_uColor:s.shadowColor||BV,shadow_uLightId:s.shadowLightId||0,shadow_uLightCount:s.shadowMatrices.length},n=NV({viewport:s.viewport,center:e.project_uCenter}),o=[],a=MV({shadowMatrices:s.shadowMatrices,viewport:s.viewport}).slice();for(let l=0;l<s.shadowMatrices.length;l++){let u=a[l],c=u.clone().translate(new re(s.viewport.center).negate());e.project_uCoordinateSystem===Ge.LNGLAT&&e.project_uProjectionMode===si.WEB_MERCATOR?(a[l]=c,o[l]=n):(a[l]=u.clone().multiplyRight(DV),o[l]=c.transform(n))}for(let l=0;l<a.length;l++)i["shadow_uViewProjectionMatrices[".concat(l,"]")]=a[l],i["shadow_uProjectCenters[".concat(l,"]")]=o[l],s.shadowMaps&&s.shadowMaps.length>0?i["shadow_uShadowMap".concat(l)]=s.shadowMaps[l]:i["shadow_uShadowMap".concat(l)]=s.dummyShadowMap;return i}var dg={name:"shadow",dependencies:[ku],vs:OV,fs:_V,inject:{"vs:DECKGL_FILTER_GL_POSITION":`
    position = shadow_setVertexPosition(geometry.position);
    `,"fs:DECKGL_FILTER_COLOR":`
    color = shadow_filterShadowColor(color);
    `},getUniforms:(s={},e={})=>"viewport"in s&&(s.drawToShadowMap||s.shadowMaps&&s.shadowMaps.length>0)?VV(s,e):{}};var Bn={inject:{"vs:DECKGL_FILTER_GL_POSITION":`
    // for picking depth values
    picking_setPickingAttribute(position.z / position.w);
  `,"vs:DECKGL_FILTER_COLOR":`
  picking_setPickingColor(geometry.pickingColor);
  `,"fs:DECKGL_FILTER_COLOR":{order:99,injection:`
  // use highlight color if this fragment belongs to the selected object.
  color = picking_filterHighlightColor(color);

  // use picking color if rendering to picking FBO.
  color = picking_filterPickingColor(color);
    `}},...hl};var UV=[ku],zV=["vs:DECKGL_FILTER_SIZE(inout vec3 size, VertexGeometry geometry)","vs:DECKGL_FILTER_GL_POSITION(inout vec4 position, VertexGeometry geometry)","vs:DECKGL_FILTER_COLOR(inout vec4 color, VertexGeometry geometry)","fs:DECKGL_FILTER_COLOR(inout vec4 color, FragmentGeometry geometry)"];function Yw(s){let e=nn.getDefaultProgramManager(s);for(let t of UV)e.addDefaultModule(t);for(let t of zV)e.addShaderHook(t);return e}var WV=[255,255,255],HV=1,jV=0,VP=class{constructor(e={}){y(this,"id",void 0),y(this,"color",void 0),y(this,"intensity",void 0),y(this,"type","ambient");let{color:t=WV}=e,{intensity:i=HV}=e;this.id=e.id||"ambient-".concat(jV++),this.color=t,this.intensity=i}};var qV=[255,255,255],XV=1,YV=[0,0,-1],KV=0,fg=class{constructor(e={}){y(this,"id",void 0),y(this,"color",void 0),y(this,"intensity",void 0),y(this,"type","directional"),y(this,"direction",void 0),y(this,"shadow",void 0);let{color:t=qV}=e,{intensity:i=XV}=e,{direction:n=YV}=e,{_shadow:o=!1}=e;this.id=e.id||"directional-".concat(KV++),this.color=t,this.intensity=i,this.type="directional",this.direction=new re(n).normalize().toArray(),this.shadow=o}getProjectedLight(e){return this}};var gg=class{constructor(e,t={id:"pass"}){y(this,"id",void 0),y(this,"gl",void 0),y(this,"props",void 0);let{id:i}=t;this.id=i,this.gl=e,this.props={...t}}setProps(e){Object.assign(this.props,e)}render(e){}cleanup(){}};var fo=class extends gg{constructor(...e){super(...e),y(this,"_lastRenderIndex",-1)}render(e){let t=this.gl;return yi(t,{framebuffer:e.target}),this._drawLayers(e)}_drawLayers(e){let{target:t,moduleParameters:i,viewports:n,views:o,onViewportActive:a,clearStack:l=!0,clearCanvas:u=!0}=e;e.pass=e.pass||"unknown";let c=this.gl;u&&QV(c),l&&(this._lastRenderIndex=-1);let h=[];for(let d of n){let f=o&&o[d.id];a(d);let p=this._getDrawLayerParams(d,e),S=d.subViewports||[d];for(let E of S){let C=this._drawLayersInViewport(c,{target:t,moduleParameters:i,viewport:E,view:f,pass:e.pass,layers:e.layers},p);h.push(C)}}return h}_getDrawLayerParams(e,{layers:t,pass:i,layerFilter:n,cullRect:o,effects:a,moduleParameters:l}){let u=[],c=Kw(this._lastRenderIndex+1),h={layer:t[0],viewport:e,isPicking:i.startsWith("picking"),renderPass:i,cullRect:o},d={};for(let f=0;f<t.length;f++){let p=t[f],S=this._shouldDrawLayer(p,h,n,d),E={shouldDrawLayer:S};S&&(E.layerRenderIndex=c(p,S),E.moduleParameters=this._getModuleParameters(p,a,i,l),E.layerParameters=this.getLayerParameters(p,f,e)),u[f]=E}return u}_drawLayersInViewport(e,{layers:t,moduleParameters:i,pass:n,target:o,viewport:a,view:l},u){let c=ZV(e,{moduleParameters:i,target:o,viewport:a});if(l&&l.props.clear){let d=l.props.clear===!0?{color:!0,depth:!0}:l.props.clear;pt(e,{scissorTest:!0,scissor:c},()=>nl(e,d))}let h={totalCount:t.length,visibleCount:0,compositeCount:0,pickableCount:0};yi(e,{viewport:c});for(let d=0;d<t.length;d++){let f=t[d],{shouldDrawLayer:p,layerRenderIndex:S,moduleParameters:E,layerParameters:C}=u[d];if(p&&f.props.pickable&&h.pickableCount++,f.isComposite)h.compositeCount++;else if(p){h.visibleCount++,this._lastRenderIndex=Math.max(this._lastRenderIndex,S),E.viewport=a;try{f._drawLayer({moduleParameters:E,uniforms:{layerIndex:S},parameters:C})}catch(O){f.raiseError(O,"drawing ".concat(f," to ").concat(n))}}}return h}shouldDrawLayer(e){return!0}getModuleParameters(e,t){return null}getLayerParameters(e,t,i){return e.props.parameters}_shouldDrawLayer(e,t,i,n){if(!(e.props.visible&&this.shouldDrawLayer(e)))return!1;t.layer=e;let a=e.parent;for(;a;){if(!a.props.visible||!a.filterSubLayer(t))return!1;t.layer=a,a=a.parent}if(i){let l=t.layer.id;if(l in n||(n[l]=i(t)),!n[l])return!1}return e.activateViewport(t.viewport),!0}_getModuleParameters(e,t,i,n){var o;let a=Object.assign(Object.create(((o=e.internalState)===null||o===void 0?void 0:o.propsInTransition)||e.props),{autoWrapLongitude:e.wrapLongitude,viewport:e.context.viewport,mousePosition:e.context.mousePosition,pickingActive:0,devicePixelRatio:io(this.gl)});if(t)for(let u of t){var l;Object.assign(a,(l=u.getModuleParameters)===null||l===void 0?void 0:l.call(u,e))}return Object.assign(a,this.getModuleParameters(e,t),n)}};function Kw(s=0,e={}){let t={},i=(n,o)=>{let a=n.props._offset,l=n.id,u=n.parent&&n.parent.id,c;if(u&&!(u in e)&&i(n.parent,!1),u in t){let h=t[u]=t[u]||Kw(e[u],e);c=h(n,o),t[l]=h}else Number.isFinite(a)?(c=a+(e[u]||0),t[l]=null):c=s;return o&&c>=s&&(s=c+1),e[l]=c,c};return i}function ZV(s,{moduleParameters:e,target:t,viewport:i}){let n=t&&t.id!=="default-framebuffer",o=e&&e.devicePixelRatio||io(s),a=n?t.height:s.drawingBufferHeight,l=i;return[l.x*o,a-(l.y+l.height)*o,l.width*o,l.height*o]}function QV(s){let e=s.drawingBufferWidth,t=s.drawingBufferHeight;yi(s,{viewport:[0,0,e,t]}),s.clear(16640)}var pg=class extends fo{constructor(e,t){super(e,t),y(this,"shadowMap",void 0),y(this,"depthBuffer",void 0),y(this,"fbo",void 0),this.shadowMap=new Ue(e,{width:1,height:1,parameters:{[10241]:9729,[10240]:9729,[10242]:33071,[10243]:33071}}),this.depthBuffer=new Ni(e,{format:33189,width:1,height:1}),this.fbo=new De(e,{id:"shadowmap",width:1,height:1,attachments:{[36064]:this.shadowMap,[36096]:this.depthBuffer}})}render(e){let t=this.fbo;pt(this.gl,{depthRange:[0,1],depthTest:!0,blend:!1,clearColor:[1,1,1,1]},()=>{let i=e.viewports[0],n=io(this.gl),o=i.width*n,a=i.height*n;(o!==t.width||a!==t.height)&&t.resize({width:o,height:a}),super.render({...e,target:t,pass:"shadow"})})}shouldDrawLayer(e){return e.props.shadowEnabled!==!1}getModuleParameters(){return{drawToShadowMap:!0}}delete(){this.fbo&&(this.fbo.delete(),this.fbo=null),this.shadowMap&&(this.shadowMap.delete(),this.shadowMap=null),this.depthBuffer&&(this.depthBuffer.delete(),this.depthBuffer=null)}};var JV={color:[255,255,255],intensity:1},Zw=[{color:[255,255,255],intensity:1,direction:[-1,3,-1]},{color:[255,255,255],intensity:.9,direction:[1,-8,-2.5]}],$V=[0,0,0,200/255],Uh=class{constructor(e={}){y(this,"id","lighting-effect"),y(this,"props",null),y(this,"shadowColor",$V),y(this,"shadow",void 0),y(this,"ambientLight",null),y(this,"directionalLights",[]),y(this,"pointLights",[]),y(this,"shadowPasses",[]),y(this,"shadowMaps",[]),y(this,"dummyShadowMap",null),y(this,"programManager",void 0),y(this,"shadowMatrices",void 0);for(let t in e){let i=e[t];switch(i.type){case"ambient":this.ambientLight=i;break;case"directional":this.directionalLights.push(i);break;case"point":this.pointLights.push(i);break;default:}}this._applyDefaultLights(),this.shadow=this.directionalLights.some(t=>t.shadow)}preRender(e,{layers:t,layerFilter:i,viewports:n,onViewportActive:o,views:a}){if(!!this.shadow){this.shadowMatrices=this._calculateMatrices(),this.shadowPasses.length===0&&this._createShadowPasses(e),this.programManager||(this.programManager=nn.getDefaultProgramManager(e),dg&&this.programManager.addDefaultModule(dg)),this.dummyShadowMap||(this.dummyShadowMap=new Ue(e,{width:1,height:1}));for(let l=0;l<this.shadowPasses.length;l++)this.shadowPasses[l].render({layers:t,layerFilter:i,viewports:n,onViewportActive:o,views:a,moduleParameters:{shadowLightId:l,dummyShadowMap:this.dummyShadowMap,shadowMatrices:this.shadowMatrices}})}}getModuleParameters(e){let t=this.shadow?{shadowMaps:this.shadowMaps,dummyShadowMap:this.dummyShadowMap,shadowColor:this.shadowColor,shadowMatrices:this.shadowMatrices}:{};return t.lightSources={ambientLight:this.ambientLight,directionalLights:this.directionalLights.map(i=>i.getProjectedLight({layer:e})),pointLights:this.pointLights.map(i=>i.getProjectedLight({layer:e}))},t}cleanup(){for(let e of this.shadowPasses)e.delete();this.shadowPasses.length=0,this.shadowMaps.length=0,this.dummyShadowMap&&(this.dummyShadowMap.delete(),this.dummyShadowMap=null),this.shadow&&this.programManager&&(this.programManager.removeDefaultModule(dg),this.programManager=null)}_calculateMatrices(){let e=[];for(let t of this.directionalLights){let i=new $e().lookAt({eye:new re(t.direction).negate()});e.push(i)}return e}_createShadowPasses(e){for(let t=0;t<this.directionalLights.length;t++){let i=new pg(e);this.shadowPasses[t]=i,this.shadowMaps[t]=i.shadowMap}}_applyDefaultLights(){let{ambientLight:e,pointLights:t,directionalLights:i}=this;!e&&t.length===0&&i.length===0&&(this.ambientLight=new VP(JV),this.directionalLights.push(new fg(Zw[0]),new fg(Zw[1])))}};var Ax=class{constructor(e={}){y(this,"_pool",[]),y(this,"opts",{overAlloc:2,poolSize:100}),this.setOptions(e)}setOptions(e){Object.assign(this.opts,e)}allocate(e,t,{size:i=1,type:n,padding:o=0,copy:a=!1,initialize:l=!1,maxCount:u}){let c=n||e&&e.constructor||Float32Array,h=t*i+o;if(ArrayBuffer.isView(e)){if(h<=e.length)return e;if(h*e.BYTES_PER_ELEMENT<=e.buffer.byteLength)return new c(e.buffer,0,h)}let d=1/0;u&&(d=u*i+o);let f=this._allocate(c,h,l,d);return e&&a?f.set(e):l||f.fill(0,0,4),this._release(e),f}release(e){this._release(e)}_allocate(e,t,i,n){let o=Math.max(Math.ceil(t*this.opts.overAlloc),1);o>n&&(o=n);let a=this._pool,l=e.BYTES_PER_ELEMENT*o,u=a.findIndex(c=>c.byteLength>=l);if(u>=0){let c=new e(a.splice(u,1)[0],0,o);return i&&c.fill(0),c}return new e(o)}_release(e){if(!ArrayBuffer.isView(e))return;let t=this._pool,{buffer:i}=e,{byteLength:n}=i,o=t.findIndex(a=>a.byteLength>=n);o<0?t.push(i):(o>0||t.length<this.opts.poolSize)&&t.splice(o,0,i),t.length>this.opts.poolSize&&t.shift()}},go=new Ax;function Wh(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function Jw(s,e){let t=s%e;return t<0?e+t:t}function $w(s){return[s[12],s[13],s[14]]}function eL(s){return{left:zh(s[3]+s[0],s[7]+s[4],s[11]+s[8],s[15]+s[12]),right:zh(s[3]-s[0],s[7]-s[4],s[11]-s[8],s[15]-s[12]),bottom:zh(s[3]+s[1],s[7]+s[5],s[11]+s[9],s[15]+s[13]),top:zh(s[3]-s[1],s[7]-s[5],s[11]-s[9],s[15]-s[13]),near:zh(s[3]+s[2],s[7]+s[6],s[11]+s[10],s[15]+s[14]),far:zh(s[3]-s[2],s[7]-s[6],s[11]-s[10],s[15]-s[14])}}var Qw=new re;function zh(s,e,t,i){Qw.set(s,e,t);let n=Qw.len();return{distance:i/n,normal:new re(-s/n,-e/n,-t/n)}}function e3(s){return s-Math.fround(s)}var mg;function UP(s,e){let{size:t=1,startIndex:i=0}=e,n=e.endIndex!==void 0?e.endIndex:s.length,o=(n-i)/t;mg=go.allocate(mg,o,{type:Float32Array,size:t*2});let a=i,l=0;for(;a<n;){for(let u=0;u<t;u++){let c=s[a++];mg[l+u]=c,mg[l+u+t]=e3(c)}l+=t*2}return mg.subarray(0,o*t*2)}var t3=Math.PI/180,r3=Wh(),tL=[0,0,0],i3={unitsPerMeter:[1,1,1],metersPerUnit:[1,1,1]};function n3({width:s,height:e,orthographic:t,fovyRadians:i,focalDistance:n,padding:o,near:a,far:l}){let u=s/e,c=t?new $e().orthographic({fovy:i,aspect:u,focalDistance:n,near:a,far:l}):new $e().perspective({fovy:i,aspect:u,near:a,far:l});if(o){let{left:h=0,right:d=0,top:f=0,bottom:p=0}=o,S=Rt((h+s-d)/2,0,s)-s/2,E=Rt((f+e-p)/2,0,e)-e/2;c[8]-=S*2/s,c[9]+=E*2/e}return c}var li=class{constructor(e={}){y(this,"id",void 0),y(this,"x",void 0),y(this,"y",void 0),y(this,"width",void 0),y(this,"height",void 0),y(this,"padding",void 0),y(this,"isGeospatial",void 0),y(this,"zoom",void 0),y(this,"focalDistance",void 0),y(this,"position",void 0),y(this,"modelMatrix",void 0),y(this,"distanceScales",void 0),y(this,"scale",void 0),y(this,"center",void 0),y(this,"cameraPosition",void 0),y(this,"projectionMatrix",void 0),y(this,"viewMatrix",void 0),y(this,"viewMatrixUncentered",void 0),y(this,"viewMatrixInverse",void 0),y(this,"viewProjectionMatrix",void 0),y(this,"pixelProjectionMatrix",void 0),y(this,"pixelUnprojectionMatrix",void 0),y(this,"resolution",void 0),y(this,"_frustumPlanes",{}),this.id=e.id||this.constructor.displayName||"viewport",this.x=e.x||0,this.y=e.y||0,this.width=e.width||1,this.height=e.height||1,this.zoom=e.zoom||0,this.padding=e.padding,this.distanceScales=e.distanceScales||i3,this.focalDistance=e.focalDistance||1,this.position=e.position||tL,this.modelMatrix=e.modelMatrix||null;let{longitude:t,latitude:i}=e;this.isGeospatial=Number.isFinite(i)&&Number.isFinite(t),this._initProps(e),this._initMatrices(e),this.equals=this.equals.bind(this),this.project=this.project.bind(this),this.unproject=this.unproject.bind(this),this.projectPosition=this.projectPosition.bind(this),this.unprojectPosition=this.unprojectPosition.bind(this),this.projectFlat=this.projectFlat.bind(this),this.unprojectFlat=this.unprojectFlat.bind(this)}get metersPerPixel(){return this.distanceScales.metersPerUnit[2]/this.scale}get projectionMode(){return this.isGeospatial?this.zoom<12?si.WEB_MERCATOR:si.WEB_MERCATOR_AUTO_OFFSET:si.IDENTITY}equals(e){return e instanceof li?this===e?!0:e.width===this.width&&e.height===this.height&&e.scale===this.scale&&kr(e.projectionMatrix,this.projectionMatrix)&&kr(e.viewMatrix,this.viewMatrix):!1}project(e,{topLeft:t=!0}={}){let i=this.projectPosition(e),n=Vh(i,this.pixelProjectionMatrix),[o,a]=n,l=t?a:this.height-a;return e.length===2?[o,l]:[o,l,n[2]]}unproject(e,{topLeft:t=!0,targetZ:i}={}){let[n,o,a]=e,l=t?o:this.height-o,u=i&&i*this.distanceScales.unitsPerMeter[2],c=is([n,l,a],this.pixelUnprojectionMatrix,u),[h,d,f]=this.unprojectPosition(c);return Number.isFinite(a)?[h,d,f]:Number.isFinite(i)?[h,d,i]:[h,d]}projectPosition(e){let[t,i]=this.projectFlat(e),n=(e[2]||0)*this.distanceScales.unitsPerMeter[2];return[t,i,n]}unprojectPosition(e){let[t,i]=this.unprojectFlat(e),n=(e[2]||0)*this.distanceScales.metersPerUnit[2];return[t,i,n]}projectFlat(e){if(this.isGeospatial){let t=Mn(e);return t[1]=Rt(t[1],-318,830),t}return e}unprojectFlat(e){return this.isGeospatial?sn(e):e}getBounds(e={}){let t={targetZ:e.z||0},i=this.unproject([0,0],t),n=this.unproject([this.width,0],t),o=this.unproject([0,this.height],t),a=this.unproject([this.width,this.height],t);return[Math.min(i[0],n[0],o[0],a[0]),Math.min(i[1],n[1],o[1],a[1]),Math.max(i[0],n[0],o[0],a[0]),Math.max(i[1],n[1],o[1],a[1])]}getDistanceScales(e){return e?kh({longitude:e[0],latitude:e[1],highPrecision:!0}):this.distanceScales}containsPixel({x:e,y:t,width:i=1,height:n=1}){return e<this.x+this.width&&this.x<e+i&&t<this.y+this.height&&this.y<t+n}getFrustumPlanes(){return this._frustumPlanes.near?this._frustumPlanes:(Object.assign(this._frustumPlanes,eL(this.viewProjectionMatrix)),this._frustumPlanes)}panByPosition(e,t){return null}_initProps(e){let t=e.longitude,i=e.latitude;this.isGeospatial&&(Number.isFinite(e.zoom)||(this.zoom=vx({latitude:i})+Math.log2(this.focalDistance)),this.distanceScales=e.distanceScales||kh({latitude:i,longitude:t}));let n=Math.pow(2,this.zoom);this.scale=n;let{position:o,modelMatrix:a}=e,l=tL;if(o&&(l=a?new $e(a).transformAsVector(o,[]):o),this.isGeospatial){let u=this.projectPosition([t,i,0]);this.center=new re(l).scale(this.distanceScales.unitsPerMeter).add(u)}else this.center=this.projectPosition(l)}_initMatrices(e){let{viewMatrix:t=r3,projectionMatrix:i=null,orthographic:n=!1,fovyRadians:o,fovy:a=75,near:l=.1,far:u=1e3,padding:c=null,focalDistance:h=1}=e;this.viewMatrixUncentered=t,this.viewMatrix=new $e().multiplyRight(t).translate(new re(this.center).negate()),this.projectionMatrix=i||n3({width:this.width,height:this.height,orthographic:n,fovyRadians:o||a*t3,focalDistance:h,padding:c,near:l,far:u});let d=Wh();rs(d,d,this.projectionMatrix),rs(d,d,this.viewMatrix),this.viewProjectionMatrix=d,this.viewMatrixInverse=rg([],this.viewMatrix)||this.viewMatrix,this.cameraPosition=$w(this.viewMatrixInverse);let f=Wh(),p=Wh();_h(f,f,[this.width/2,-this.height/2,1]),Gu(f,f,[1,-1,0]),rs(p,f,this.viewProjectionMatrix),this.pixelProjectionMatrix=p,this.pixelUnprojectionMatrix=rg(Wh(),this.pixelProjectionMatrix),this.pixelUnprojectionMatrix||fe.warn("Pixel project matrix not invertible")()}};y(li,"displayName","Viewport");var o3=512,s3=4003e4,a3=Math.PI/180;function rL(s){let e=Math.cos(s*a3);return o3/s3/e}var Lr=class extends li{constructor(e={}){let{latitude:t=0,longitude:i=0,zoom:n=0,pitch:o=0,bearing:a=0,nearZMultiplier:l=.1,farZMultiplier:u=1.01,orthographic:c=!1,projectionMatrix:h,repeat:d=!1,worldOffset:f=0,legacyMeterSizes:p=!1}=e,{width:S,height:E,altitude:C=1.5}=e,O=Math.pow(2,n);S=S||1,E=E||1;let B,A=null;h?(C=h[5]/2,B=Vu(C)):(e.fovy?(B=e.fovy,C=cg(B)):B=Vu(C),A=Cx({width:S,height:E,pitch:o,fovy:B,nearZMultiplier:l,farZMultiplier:u}));let N=FP({height:E,pitch:o,bearing:a,scale:O,altitude:C});f&&(N=new $e().translate([512*f,0,0]).multiplyLeft(N)),super({...e,width:S,height:E,viewMatrix:N,longitude:i,latitude:t,zoom:n,...A,fovy:B,focalDistance:C}),y(this,"longitude",void 0),y(this,"latitude",void 0),y(this,"pitch",void 0),y(this,"bearing",void 0),y(this,"altitude",void 0),y(this,"fovy",void 0),y(this,"orthographic",void 0),y(this,"_subViewports",void 0),y(this,"_pseudoMeters",void 0),this.latitude=t,this.longitude=i,this.zoom=n,this.pitch=o,this.bearing=a,this.altitude=C,this.fovy=B,this.orthographic=c,this._subViewports=d?[]:null,this._pseudoMeters=p,Object.freeze(this)}get subViewports(){if(this._subViewports&&!this._subViewports.length){let e=this.getBounds(),t=Math.floor((e[0]+180)/360),i=Math.ceil((e[2]-180)/360);for(let n=t;n<=i;n++){let o=n?new Lr({...this,worldOffset:n}):this;this._subViewports.push(o)}}return this._subViewports}projectPosition(e){if(this._pseudoMeters)return super.projectPosition(e);let[t,i]=this.projectFlat(e),n=(e[2]||0)*rL(e[1]);return[t,i,n]}unprojectPosition(e){if(this._pseudoMeters)return super.unprojectPosition(e);let[t,i]=this.unprojectFlat(e),n=(e[2]||0)/rL(i);return[t,i,n]}addMetersToLngLat(e,t){return ug(e,t)}panByPosition(e,t){let i=is(t,this.pixelUnprojectionMatrix),n=this.projectFlat(e),o=wh([],n,yP([],i)),a=wh([],this.center,o),[l,u]=this.unprojectFlat(a);return{longitude:l,latitude:u}}getBounds(e={}){let t=hg(this,e.z||0);return[Math.min(t[0][0],t[1][0],t[2][0],t[3][0]),Math.min(t[0][1],t[1][1],t[2][1],t[3][1]),Math.max(t[0][0],t[1][0],t[2][0],t[3][0]),Math.max(t[0][1],t[1][1],t[2][1],t[3][1])]}fitBounds(e,t={}){let{width:i,height:n}=this,{longitude:o,latitude:a,zoom:l}=Uu({width:i,height:n,bounds:e,...t});return new Lr({width:i,height:n,longitude:o,latitude:a,zoom:l})}};y(Lr,"displayName","WebMercatorViewport");function Tx(s,e,t=!1){let i=e.projectPosition(s);if(t&&e instanceof Lr){let[n,o,a=0]=s,l=e.getDistanceScales([n,o]);i[2]=a*l.unitsPerMeter[2]}return i}function l3(s){let{viewport:e,modelMatrix:t,coordinateOrigin:i}=s,{coordinateSystem:n,fromCoordinateSystem:o,fromCoordinateOrigin:a}=s;return n===Ge.DEFAULT&&(n=e.isGeospatial?Ge.LNGLAT:Ge.CARTESIAN),o===void 0&&(o=n),a===void 0&&(a=i),{viewport:e,coordinateSystem:n,coordinateOrigin:i,modelMatrix:t,fromCoordinateSystem:o,fromCoordinateOrigin:a}}function Ix(s,{viewport:e,modelMatrix:t,coordinateSystem:i,coordinateOrigin:n,offsetMode:o}){let[a,l,u=0]=s;switch(t&&([a,l,u]=ao([],[a,l,u,1],t)),i){case Ge.LNGLAT:return Tx([a,l,u],e,o);case Ge.LNGLAT_OFFSETS:return Tx([a+n[0],l+n[1],u+(n[2]||0)],e,o);case Ge.METER_OFFSETS:return Tx(ug(n,[a,l,u]),e,o);case Ge.CARTESIAN:default:return e.isGeospatial?[a+n[0],l+n[1],u+n[2]]:e.projectPosition([a,l,u])}}function iL(s,e){let{viewport:t,coordinateSystem:i,coordinateOrigin:n,modelMatrix:o,fromCoordinateSystem:a,fromCoordinateOrigin:l}=l3(e),{geospatialOrigin:u,shaderCoordinateOrigin:c,offsetMode:h}=bx(t,i,n),d=Ix(s,{viewport:t,modelMatrix:o,coordinateSystem:a,coordinateOrigin:l,offsetMode:h});if(h){let f=t.projectPosition(u||c);AP(d,d,f)}return d}var gl={NO_STATE:"Awaiting state",MATCHED:"Matched. State transferred from previous layer",INITIALIZED:"Initialized",AWAITING_GC:"Discarded. Awaiting garbage collection",AWAITING_FINALIZATION:"No longer matched. Awaiting garbage collection",FINALIZED:"Finalized! Awaiting garbage collection"},Hh=Symbol.for("component"),Xs=Symbol.for("asyncPropDefaults"),ns=Symbol.for("asyncPropOriginal"),po=Symbol.for("asyncPropResolved");function Ys(s,e=()=>!0){return Array.isArray(s)?nL(s,e,[]):e(s)?[s]:[]}function nL(s,e,t){let i=-1;for(;++i<s.length;){let n=s[i];Array.isArray(n)?nL(n,e,t):e(n)&&t.push(n)}return t}function wx({target:s,source:e,start:t=0,count:i=1}){let n=e.length,o=i*n,a=0;for(let l=t;a<n;a++)s[l++]=e[a];for(;a<o;)a<o-a?(s.copyWithin(t+a,t,t+a),a*=2):(s.copyWithin(t+a,t,t+o-a),a=o);return s}var bg=class{constructor(e,t,i){y(this,"id",void 0),y(this,"context",void 0),y(this,"isLoaded",void 0),y(this,"persistent",void 0),y(this,"_loadCount",0),y(this,"_subscribers",new Set),y(this,"_data",void 0),y(this,"_loader",void 0),y(this,"_error",void 0),y(this,"_content",void 0),this.id=e,this.context=i,this.setData(t)}subscribe(e){this._subscribers.add(e)}unsubscribe(e){this._subscribers.delete(e)}inUse(){return this._subscribers.size>0}delete(){}getData(){return this.isLoaded?this._error?Promise.reject(this._error):this._content:this._loader.then(()=>this.getData())}setData(e,t){if(e===this._data&&!t)return;this._data=e;let i=++this._loadCount,n=e;typeof e=="string"&&(n=$o(e)),n instanceof Promise?(this.isLoaded=!1,this._loader=n.then(o=>{this._loadCount===i&&(this.isLoaded=!0,this._error=void 0,this._content=o)}).catch(o=>{this._loadCount===i&&(this.isLoaded=!0,this._error=o||!0)})):(this.isLoaded=!0,this._error=void 0,this._content=e);for(let o of this._subscribers)o.onChange(this.getData())}};var Pg=class{constructor({gl:e,protocol:t}){y(this,"protocol",void 0),y(this,"_context",void 0),y(this,"_resources",void 0),y(this,"_consumers",void 0),y(this,"_pruneRequest",void 0),this.protocol=t||"resource://",this._context={gl:e,resourceManager:this},this._resources={},this._consumers={},this._pruneRequest=null}contains(e){return e.startsWith(this.protocol)?!0:e in this._resources}add({resourceId:e,data:t,forceUpdate:i=!1,persistent:n=!0}){let o=this._resources[e];o?o.setData(t,i):(o=new bg(e,t,this._context),this._resources[e]=o),o.persistent=n}remove(e){let t=this._resources[e];t&&(t.delete(),delete this._resources[e])}unsubscribe({consumerId:e}){let t=this._consumers[e];if(t){for(let i in t){let n=t[i],o=this._resources[n.resourceId];o&&o.unsubscribe(n)}delete this._consumers[e],this.prune()}}subscribe({resourceId:e,onChange:t,consumerId:i,requestId:n="default"}){let{_resources:o,protocol:a}=this;e.startsWith(a)&&(e=e.replace(a,""),o[e]||this.add({resourceId:e,data:null,persistent:!1}));let l=o[e];if(this._track(i,n,l,t),l)return l.getData()}prune(){this._pruneRequest||(this._pruneRequest=setTimeout(()=>this._prune(),0))}finalize(){for(let e in this._resources)this._resources[e].delete()}_track(e,t,i,n){let o=this._consumers,a=o[e]=o[e]||{},l=a[t]||{},u=l.resourceId&&this._resources[l.resourceId];u&&(u.unsubscribe(l),this.prune()),i&&(a[t]=l,l.onChange=n,l.resourceId=i.id,i.subscribe(l))}_prune(){this._pruneRequest=null;for(let e of Object.keys(this._resources)){let t=this._resources[e];!t.persistent&&!t.inUse()&&(t.delete(),delete this._resources[e])}}};var u3="layerManager.setLayers",c3="layerManager.activateViewport",yg=class{constructor(e,{deck:t,stats:i,viewport:n,timeline:o}={}){y(this,"layers",void 0),y(this,"context",void 0),y(this,"resourceManager",void 0),y(this,"_lastRenderedLayers",[]),y(this,"_needsRedraw",!1),y(this,"_needsUpdate",!1),y(this,"_nextLayers",null),y(this,"_debug",!1),y(this,"activateViewport",a=>{Gt(c3,this,a),a&&(this.context.viewport=a)}),this.layers=[],this.resourceManager=new Pg({gl:e,protocol:"deck://"}),this.context={mousePosition:null,userData:{},layerManager:this,gl:e,deck:t,programManager:e&&Yw(e),stats:i||new en({id:"deck.gl"}),viewport:n||new li({id:"DEFAULT-INITIAL-VIEWPORT"}),timeline:o||new dl,resourceManager:this.resourceManager,onError:void 0},Object.seal(this)}finalize(){this.resourceManager.finalize();for(let e of this.layers)this._finalizeLayer(e)}needsRedraw(e={clearRedrawFlags:!1}){let t=this._needsRedraw;e.clearRedrawFlags&&(this._needsRedraw=!1);for(let i of this.layers){let n=i.getNeedsRedraw(e);t=t||n}return t}needsUpdate(){return this._nextLayers&&this._nextLayers!==this._lastRenderedLayers?"layers changed":this._needsUpdate}setNeedsRedraw(e){this._needsRedraw=this._needsRedraw||e}setNeedsUpdate(e){this._needsUpdate=this._needsUpdate||e}getLayers({layerIds:e}={}){return e?this.layers.filter(t=>e.find(i=>t.id.indexOf(i)===0)):this.layers}setProps(e){"debug"in e&&(this._debug=e.debug),"userData"in e&&(this.context.userData=e.userData),"layers"in e&&(this._nextLayers=e.layers),"onError"in e&&(this.context.onError=e.onError)}setLayers(e,t){Gt(u3,this,t,e),this._lastRenderedLayers=e;let i=Ys(e,Boolean);for(let n of i)n.context=this.context;this._updateLayers(this.layers,i)}updateLayers(){let e=this.needsUpdate();e&&(this.setNeedsRedraw("updating layers: ".concat(e)),this.setLayers(this._nextLayers||this._lastRenderedLayers,e)),this._nextLayers=null}_handleError(e,t,i){i.raiseError(t,"".concat(e," of ").concat(i))}_updateLayers(e,t){let i={};for(let a of e)i[a.id]?fe.warn("Multiple old layers with same id ".concat(a.id))():i[a.id]=a;let n=[];this._updateSublayersRecursively(t,i,n),this._finalizeOldLayers(i);let o=!1;for(let a of n)if(a.hasUniformTransition()){o="Uniform transition in ".concat(a);break}this._needsUpdate=o,this.layers=n}_updateSublayersRecursively(e,t,i){for(let n of e){n.context=this.context;let o=t[n.id];o===null&&fe.warn("Multiple new layers with same id ".concat(n.id))(),t[n.id]=null;let a=null;try{this._debug&&o!==n&&n.validateProps(),o?(this._transferLayerState(o,n),this._updateLayer(n)):this._initializeLayer(n),i.push(n),a=n.isComposite?n.getSubLayers():null}catch(l){this._handleError("matching",l,n)}a&&this._updateSublayersRecursively(a,t,i)}}_finalizeOldLayers(e){for(let t in e){let i=e[t];i&&this._finalizeLayer(i)}}_initializeLayer(e){try{e._initialize(),e.lifecycle=gl.INITIALIZED}catch(t){this._handleError("initialization",t,e)}}_transferLayerState(e,t){t._transferState(e),t.lifecycle=gl.MATCHED,t!==e&&(e.lifecycle=gl.AWAITING_GC)}_updateLayer(e){try{e._update()}catch(t){this._handleError("update",t,e)}}_finalizeLayer(e){this._needsRedraw=this._needsRedraw||"finalized ".concat(e),e.lifecycle=gl.AWAITING_FINALIZATION;try{e._finalize(),e.lifecycle=gl.FINALIZED}catch(t){this._handleError("finalization",t,e)}}};function an(s,e){if(s===e)return!0;if(!s||!e)return!1;for(let t in s){let i=s[t],n=e[t];if(!(i===n||Array.isArray(i)&&Array.isArray(n)&&an(i,n)))return!1}return!0}var Sg=class{constructor(e){y(this,"width",void 0),y(this,"height",void 0),y(this,"views",void 0),y(this,"viewState",void 0),y(this,"controllers",void 0),y(this,"timeline",void 0),y(this,"_viewports",void 0),y(this,"_viewportMap",void 0),y(this,"_isUpdating",void 0),y(this,"_needsRedraw",void 0),y(this,"_needsUpdate",void 0),y(this,"_eventManager",void 0),y(this,"_eventCallbacks",void 0),this.views=[],this.width=100,this.height=100,this.viewState={},this.controllers={},this.timeline=e.timeline,this._viewports=[],this._viewportMap={},this._isUpdating=!1,this._needsRedraw="First render",this._needsUpdate="Initialize",this._eventManager=e.eventManager,this._eventCallbacks={onViewStateChange:e.onViewStateChange,onInteractionStateChange:e.onInteractionStateChange},Object.seal(this),this.setProps(e)}finalize(){for(let e in this.controllers){let t=this.controllers[e];t&&t.finalize()}this.controllers={}}needsRedraw(e={clearRedrawFlags:!1}){let t=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),t}setNeedsUpdate(e){this._needsUpdate=this._needsUpdate||e,this._needsRedraw=this._needsRedraw||e}updateViewStates(){for(let e in this.controllers){let t=this.controllers[e];t&&t.updateTransition()}}getViewports(e){return e?this._viewports.filter(t=>t.containsPixel(e)):this._viewports}getViews(){let e={};return this.views.forEach(t=>{e[t.id]=t}),e}getView(e){return this.views.find(t=>t.id===e)}getViewState(e){let t=typeof e=="string"?this.getView(e):e,i=t&&this.viewState[t.getViewStateId()]||this.viewState;return t?t.filterViewState(i):i}getViewport(e){return this._viewportMap[e]}unproject(e,t){let i=this.getViewports(),n={x:e[0],y:e[1]};for(let o=i.length-1;o>=0;--o){let a=i[o];if(a.containsPixel(n)){let l=e.slice();return l[0]-=a.x,l[1]-=a.y,a.unproject(l,t)}}return null}setProps(e){e.views&&this._setViews(e.views),e.viewState&&this._setViewState(e.viewState),("width"in e||"height"in e)&&this._setSize(e.width,e.height),this._isUpdating||this._update()}_update(){this._isUpdating=!0,this._needsUpdate&&(this._needsUpdate=!1,this._rebuildViewports()),this._needsUpdate&&(this._needsUpdate=!1,this._rebuildViewports()),this._isUpdating=!1}_setSize(e,t){(e!==this.width||t!==this.height)&&(this.width=e,this.height=t,this.setNeedsUpdate("Size changed"))}_setViews(e){e=Ys(e,Boolean),this._diffViews(e,this.views)&&this.setNeedsUpdate("views changed"),this.views=e}_setViewState(e){e?(!an(e,this.viewState)&&this.setNeedsUpdate("viewState changed"),this.viewState=e):fe.warn("missing `viewState` or `initialViewState`")()}_onViewStateChange(e,t){this._eventCallbacks.onViewStateChange&&this._eventCallbacks.onViewStateChange({...t,viewId:e})}_createController(e,t){let i=t.type;return new i({timeline:this.timeline,eventManager:this._eventManager,onViewStateChange:this._onViewStateChange.bind(this,t.id),onStateChange:this._eventCallbacks.onInteractionStateChange,makeViewport:o=>{var a;return(a=this.getView(e.id))===null||a===void 0?void 0:a.makeViewport({viewState:o,width:this.width,height:this.height})}})}_updateController(e,t,i,n){let o=e.controller;if(o){let a={...t,...o,id:e.id,x:i.x,y:i.y,width:i.width,height:i.height};return n||(n=this._createController(e,a)),n&&n.setProps(a),n}return null}_rebuildViewports(){let{views:e}=this,t=this.controllers;this._viewports=[],this.controllers={};let i=!1;for(let n=e.length;n--;){let o=e[n],a=this.getViewState(o),l=o.makeViewport({viewState:a,width:this.width,height:this.height}),u=t[o.id],c=Boolean(o.controller);c&&!u&&(i=!0),(i||!c)&&u&&(u.finalize(),u=null),this.controllers[o.id]=this._updateController(o,a,l,u),this._viewports.unshift(l)}for(let n in t){let o=t[n];o&&!this.controllers[n]&&o.finalize()}this._buildViewportMap()}_buildViewportMap(){this._viewportMap={},this._viewports.forEach(e=>{e.id&&(this._viewportMap[e.id]=this._viewportMap[e.id]||e)})}_diffViews(e,t){return e.length!==t.length?!0:e.some((i,n)=>!e[n].equals(t[n]))}};var h3=/([0-9]+\.?[0-9]*)(%|px)/;function Ks(s){switch(typeof s){case"number":return{position:s,relative:!1};case"string":let e=h3.exec(s);if(e&&e.length>=3){let t=e[2]==="%",i=parseFloat(e[1]);return{position:t?i/100:i,relative:t}}default:throw new Error("Could not parse position string ".concat(s))}}function Zs(s,e){return s.relative?Math.round(s.position*e):s.position}function mt(s,e){if(!s)throw new Error(e||"deck.gl: assertion failed.")}var zu=class{constructor(e){y(this,"id",void 0),y(this,"viewportInstance",void 0),y(this,"_x",void 0),y(this,"_y",void 0),y(this,"_width",void 0),y(this,"_height",void 0),y(this,"_padding",void 0),y(this,"props",void 0);let{id:t,x:i=0,y:n=0,width:o="100%",height:a="100%",padding:l=null,viewportInstance:u}=e||{};mt(!u||u instanceof li),this.viewportInstance=u,this.id=t||this.constructor.displayName||"view",this.props={...e,id:this.id},this._x=Ks(i),this._y=Ks(n),this._width=Ks(o),this._height=Ks(a),this._padding=l&&{left:Ks(l.left||0),right:Ks(l.right||0),top:Ks(l.top||0),bottom:Ks(l.bottom||0)},this.equals=this.equals.bind(this),Object.seal(this)}equals(e){return this===e?!0:this.viewportInstance?e.viewportInstance?this.viewportInstance.equals(e.viewportInstance):!1:this.ViewportType===e.ViewportType&&an(this.props,e.props)}makeViewport({width:e,height:t,viewState:i}){if(this.viewportInstance)return this.viewportInstance;i=this.filterViewState(i);let n=this.getDimensions({width:e,height:t});return new this.ViewportType({...i,...this.props,...n})}getViewStateId(){let{viewState:e}=this.props;return typeof e=="string"?e:e?.id||this.id}filterViewState(e){if(this.props.viewState&&typeof this.props.viewState=="object"){if(!this.props.viewState.id)return this.props.viewState;let t={...e};for(let i in this.props.viewState)i!=="id"&&(t[i]=this.props.viewState[i]);return t}return e}getDimensions({width:e,height:t}){let i={x:Zs(this._x,e),y:Zs(this._y,t),width:Zs(this._width,e),height:Zs(this._height,t)};return this._padding&&(i.padding={left:Zs(this._padding.left,e),top:Zs(this._padding.top,t),right:Zs(this._padding.right,e),bottom:Zs(this._padding.bottom,t)}),i}get controller(){let e=this.props.controller;return e?e===!0?{type:this.ControllerType}:typeof e=="function"?{type:e}:{type:this.ControllerType,...e}:null}};var ln=class{constructor(e){y(this,"_inProgress",void 0),y(this,"_handle",void 0),y(this,"_timeline",void 0),y(this,"time",void 0),y(this,"settings",void 0),this._inProgress=!1,this._handle=null,this._timeline=e,this.time=0,this.settings={duration:0}}get inProgress(){return this._inProgress}start(e){var t,i;this.cancel(),this.settings=e,this._inProgress=!0,(t=(i=this.settings).onStart)===null||t===void 0||t.call(i,this)}end(){if(this._inProgress){var e,t;this._timeline.removeChannel(this._handle),this._handle=null,this._inProgress=!1,(e=(t=this.settings).onEnd)===null||e===void 0||e.call(t,this)}}cancel(){if(this._inProgress){var e,t;(e=(t=this.settings).onInterrupt)===null||e===void 0||e.call(t,this),this._timeline.removeChannel(this._handle),this._handle=null,this._inProgress=!1}}update(){var e,t;if(!this._inProgress)return!1;if(this._handle===null){let{_timeline:i,settings:n}=this;this._handle=i.addChannel({delay:i.getTime(),duration:n.duration})}return this.time=this._timeline.getTime(this._handle),this._onUpdate(),(e=(t=this.settings).onUpdate)===null||e===void 0||e.call(t,this),this._timeline.isFinished(this._handle)&&this.end(),!0}_onUpdate(){}};var oL=()=>{},Lx={BREAK:1,SNAP_TO_END:2,IGNORE:3},d3=s=>s,f3=Lx.BREAK,Eg=class{constructor(e){y(this,"getControllerState",void 0),y(this,"props",void 0),y(this,"propsInTransition",void 0),y(this,"transition",void 0),y(this,"onViewStateChange",void 0),y(this,"onStateChange",void 0),y(this,"_onTransitionUpdate",t=>{let{time:i,settings:{interpolator:n,startProps:o,endProps:a,duration:l,easing:u}}=t,c=u(i/l),h=n.interpolateProps(o,a,c);this.propsInTransition=this.getControllerState({...this.props,...h}).getViewportProps(),this.onViewStateChange({viewState:this.propsInTransition,oldViewState:this.props})}),this.getControllerState=e.getControllerState,this.propsInTransition=null,this.transition=new ln(e.timeline),this.onViewStateChange=e.onViewStateChange||oL,this.onStateChange=e.onStateChange||oL}finalize(){this.transition.cancel()}getViewportInTransition(){return this.propsInTransition}processViewStateChange(e){let t=!1,i=this.props;if(this.props=e,!i||this._shouldIgnoreViewportChange(i,e))return!1;if(this._isTransitionEnabled(e)){let n=i;if(this.transition.inProgress){let{interruption:o,endProps:a}=this.transition.settings;n={...i,...o===Lx.SNAP_TO_END?a:this.propsInTransition||i}}this._triggerTransition(n,e),t=!0}else this.transition.cancel();return t}updateTransition(){this.transition.update()}_isTransitionEnabled(e){let{transitionDuration:t,transitionInterpolator:i}=e;return(t>0||t==="auto")&&Boolean(i)}_isUpdateDueToCurrentTransition(e){return this.transition.inProgress&&this.propsInTransition?this.transition.settings.interpolator.arePropsEqual(e,this.propsInTransition):!1}_shouldIgnoreViewportChange(e,t){return this.transition.inProgress?this.transition.settings.interruption===Lx.IGNORE||this._isUpdateDueToCurrentTransition(t):this._isTransitionEnabled(t)?t.transitionInterpolator.arePropsEqual(e,t):!0}_triggerTransition(e,t){let i=this.getControllerState(e),n=this.getControllerState(t).shortestPathFrom(i),o=t.transitionInterpolator,a=o.getDuration?o.getDuration(e,t):t.transitionDuration;if(a===0)return;let l=o.initializeProps(e,n);this.propsInTransition={};let u={duration:a,easing:t.transitionEasing||d3,interpolator:o,interruption:t.transitionInterruption||f3,startProps:l.start,endProps:l.end,onStart:t.onTransitionStart,onUpdate:this._onTransitionUpdate,onInterrupt:this._onTransitionEnd(t.onTransitionInterrupt),onEnd:this._onTransitionEnd(t.onTransitionEnd)};this.transition.start(u),this.onStateChange({inTransition:!0}),this.updateTransition()}_onTransitionEnd(e){return t=>{this.propsInTransition=null,this.onStateChange({inTransition:!1,isZooming:!1,isPanning:!1,isRotating:!1}),e?.(t)}}};var xg=class{constructor(e){y(this,"_propsToCompare",void 0),y(this,"_propsToExtract",void 0),y(this,"_requiredProps",void 0);let{compare:t,extract:i,required:n}=e;this._propsToCompare=t,this._propsToExtract=i||t,this._requiredProps=n}arePropsEqual(e,t){for(let i of this._propsToCompare)if(!(i in e)||!(i in t)||!kr(e[i],t[i]))return!1;return!0}initializeProps(e,t){let i={},n={};for(let o of this._propsToExtract)(o in e||o in t)&&(i[o]=e[o],n[o]=t[o]);return this._checkRequiredProps(i),this._checkRequiredProps(n),{start:i,end:n}}getDuration(e,t){return t.transitionDuration}_checkRequiredProps(e){!this._requiredProps||this._requiredProps.forEach(t=>{let i=e[t];mt(Number.isFinite(i)||Array.isArray(i),"".concat(t," is required for transition"))})}};var g3=["longitude","latitude","zoom","bearing","pitch"],p3=["longitude","latitude","zoom"],Dn=class extends xg{constructor(e={}){let t=Array.isArray(e)?e:e.transitionProps,i=Array.isArray(e)?{}:e;i.transitionProps=Array.isArray(t)?{compare:t,required:t}:t||{compare:g3,required:p3},super(i.transitionProps),y(this,"opts",void 0),this.opts=i}initializeProps(e,t){let i=super.initializeProps(e,t),{makeViewport:n,around:o}=this.opts;if(n&&o){let a=n(e),l=n(t),u=a.unproject(o);i.start.around=o,Object.assign(i.end,{around:l.project(u),aroundPosition:u,width:t.width,height:t.height})}return i}interpolateProps(e,t,i){let n={};for(let o of this._propsToExtract)n[o]=Nu(e[o]||0,t[o]||0,i);if(t.aroundPosition&&this.opts.makeViewport){let o=this.opts.makeViewport({...t,...n});Object.assign(n,o.panByPosition(t.aroundPosition,Nu(e.around,t.around,i)))}return n}};var pl={transitionDuration:0},m3=300,zP=s=>1-(1-s)*(1-s),jh={WHEEL:["wheel"],PAN:["panstart","panmove","panend"],PINCH:["pinchstart","pinchmove","pinchend"],TRIPLE_PAN:["tripanstart","tripanmove","tripanend"],DOUBLE_TAP:["doubletap"],KEYBOARD:["keydown"]},Wu={},Hu=class{constructor(e){y(this,"props",void 0),y(this,"state",{}),y(this,"transitionManager",void 0),y(this,"eventManager",void 0),y(this,"onViewStateChange",void 0),y(this,"onStateChange",void 0),y(this,"makeViewport",void 0),y(this,"_controllerState",void 0),y(this,"_events",{}),y(this,"_interactionState",{isDragging:!1}),y(this,"_customEvents",[]),y(this,"_eventStartBlocked",null),y(this,"_panMove",!1),y(this,"invertPan",!1),y(this,"dragMode","rotate"),y(this,"inertia",0),y(this,"scrollZoom",!0),y(this,"dragPan",!0),y(this,"dragRotate",!0),y(this,"doubleClickZoom",!0),y(this,"touchZoom",!0),y(this,"touchRotate",!1),y(this,"keyboard",!0),this.transitionManager=new Eg({...e,getControllerState:t=>new this.ControllerState(t),onViewStateChange:this._onTransition.bind(this),onStateChange:this._setInteractionState.bind(this)}),this.handleEvent=this.handleEvent.bind(this),this.eventManager=e.eventManager,this.onViewStateChange=e.onViewStateChange||(()=>{}),this.onStateChange=e.onStateChange||(()=>{}),this.makeViewport=e.makeViewport}set events(e){this.toggleEvents(this._customEvents,!1),this.toggleEvents(e,!0),this._customEvents=e,this.props&&this.setProps(this.props)}finalize(){for(let t in this._events)if(this._events[t]){var e;(e=this.eventManager)===null||e===void 0||e.off(t,this.handleEvent)}this.transitionManager.finalize()}handleEvent(e){this._controllerState=void 0;let t=this._eventStartBlocked;switch(e.type){case"panstart":return t?!1:this._onPanStart(e);case"panmove":return this._onPan(e);case"panend":return this._onPanEnd(e);case"pinchstart":return t?!1:this._onPinchStart(e);case"pinchmove":return this._onPinch(e);case"pinchend":return this._onPinchEnd(e);case"tripanstart":return t?!1:this._onTriplePanStart(e);case"tripanmove":return this._onTriplePan(e);case"tripanend":return this._onTriplePanEnd(e);case"doubletap":return this._onDoubleTap(e);case"wheel":return this._onWheel(e);case"keydown":return this._onKeyDown(e);default:return!1}}get controllerState(){return this._controllerState=this._controllerState||new this.ControllerState({makeViewport:this.makeViewport,...this.props,...this.state}),this._controllerState}getCenter(e){let{x:t,y:i}=this.props,{offsetCenter:n}=e;return[n.x-t,n.y-i]}isPointInBounds(e,t){let{width:i,height:n}=this.props;if(t&&t.handled)return!1;let o=e[0]>=0&&e[0]<=i&&e[1]>=0&&e[1]<=n;return o&&t&&t.stopPropagation(),o}isFunctionKeyPressed(e){let{srcEvent:t}=e;return Boolean(t.metaKey||t.altKey||t.ctrlKey||t.shiftKey)}isDragging(){return this._interactionState.isDragging||!1}blockEvents(e){let t=setTimeout(()=>{this._eventStartBlocked===t&&(this._eventStartBlocked=null)},e);this._eventStartBlocked=t}setProps(e){e.dragMode&&(this.dragMode=e.dragMode),this.props=e,"transitionInterpolator"in e||(e.transitionInterpolator=this._getTransitionProps().transitionInterpolator),this.transitionManager.processViewStateChange(e);let{inertia:t}=e;this.inertia=Number.isFinite(t)?t:t===!0?m3:0;let{scrollZoom:i=!0,dragPan:n=!0,dragRotate:o=!0,doubleClickZoom:a=!0,touchZoom:l=!0,touchRotate:u=!1,keyboard:c=!0}=e,h=Boolean(this.onViewStateChange);this.toggleEvents(jh.WHEEL,h&&i),this.toggleEvents(jh.PAN,h&&(n||o)),this.toggleEvents(jh.PINCH,h&&(l||u)),this.toggleEvents(jh.TRIPLE_PAN,h&&u),this.toggleEvents(jh.DOUBLE_TAP,h&&a),this.toggleEvents(jh.KEYBOARD,h&&c),this.scrollZoom=i,this.dragPan=n,this.dragRotate=o,this.doubleClickZoom=a,this.touchZoom=l,this.touchRotate=u,this.keyboard=c}updateTransition(){this.transitionManager.updateTransition()}toggleEvents(e,t){this.eventManager&&e.forEach(i=>{this._events[i]!==t&&(this._events[i]=t,t?this.eventManager.on(i,this.handleEvent):this.eventManager.off(i,this.handleEvent))})}updateViewport(e,t=null,i={}){let n={...e.getViewportProps(),...t},o=this.controllerState!==e;if(this.state=e.getState(),this._setInteractionState(i),o){let a=this.controllerState&&this.controllerState.getViewportProps();this.onViewStateChange&&this.onViewStateChange({viewState:n,interactionState:this._interactionState,oldViewState:a})}}_onTransition(e){this.onViewStateChange({...e,interactionState:this._interactionState})}_setInteractionState(e){Object.assign(this._interactionState,e),this.onStateChange(this._interactionState)}_onPanStart(e){let t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;let i=this.isFunctionKeyPressed(e)||e.rightButton||!1;(this.invertPan||this.dragMode==="pan")&&(i=!i);let n=this.controllerState[i?"panStart":"rotateStart"]({pos:t});return this._panMove=i,this.updateViewport(n,pl,{isDragging:!0}),!0}_onPan(e){return this.isDragging()?this._panMove?this._onPanMove(e):this._onPanRotate(e):!1}_onPanEnd(e){return this.isDragging()?this._panMove?this._onPanMoveEnd(e):this._onPanRotateEnd(e):!1}_onPanMove(e){if(!this.dragPan)return!1;let t=this.getCenter(e),i=this.controllerState.pan({pos:t});return this.updateViewport(i,pl,{isDragging:!0,isPanning:!0}),!0}_onPanMoveEnd(e){let{inertia:t}=this;if(this.dragPan&&t&&e.velocity){let i=this.getCenter(e),n=[i[0]+e.velocityX*t/2,i[1]+e.velocityY*t/2],o=this.controllerState.pan({pos:n}).panEnd();this.updateViewport(o,{...this._getTransitionProps(),transitionDuration:t,transitionEasing:zP},{isDragging:!1,isPanning:!0})}else{let i=this.controllerState.panEnd();this.updateViewport(i,null,{isDragging:!1,isPanning:!1})}return!0}_onPanRotate(e){if(!this.dragRotate)return!1;let t=this.getCenter(e),i=this.controllerState.rotate({pos:t});return this.updateViewport(i,pl,{isDragging:!0,isRotating:!0}),!0}_onPanRotateEnd(e){let{inertia:t}=this;if(this.dragRotate&&t&&e.velocity){let i=this.getCenter(e),n=[i[0]+e.velocityX*t/2,i[1]+e.velocityY*t/2],o=this.controllerState.rotate({pos:n}).rotateEnd();this.updateViewport(o,{...this._getTransitionProps(),transitionDuration:t,transitionEasing:zP},{isDragging:!1,isRotating:!0})}else{let i=this.controllerState.rotateEnd();this.updateViewport(i,null,{isDragging:!1,isRotating:!1})}return!0}_onWheel(e){if(!this.scrollZoom)return!1;e.srcEvent.preventDefault();let t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;let{speed:i=.01,smooth:n=!1}=this.scrollZoom===!0?{}:this.scrollZoom,{delta:o}=e,a=2/(1+Math.exp(-Math.abs(o*i)));o<0&&a!==0&&(a=1/a);let l=this.controllerState.zoom({pos:t,scale:a});return this.updateViewport(l,{...this._getTransitionProps({around:t}),transitionDuration:n?250:1},{isZooming:!0,isPanning:!0}),!0}_onTriplePanStart(e){let t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;let i=this.controllerState.rotateStart({pos:t});return this.updateViewport(i,pl,{isDragging:!0}),!0}_onTriplePan(e){if(!this.touchRotate||!this.isDragging())return!1;let t=this.getCenter(e);t[0]-=e.deltaX;let i=this.controllerState.rotate({pos:t});return this.updateViewport(i,pl,{isDragging:!0,isRotating:!0}),!0}_onTriplePanEnd(e){if(!this.isDragging())return!1;let{inertia:t}=this;if(this.touchRotate&&t&&e.velocityY){let i=this.getCenter(e),n=[i[0],i[1]+=e.velocityY*t/2],o=this.controllerState.rotate({pos:n});this.updateViewport(o,{...this._getTransitionProps(),transitionDuration:t,transitionEasing:zP},{isDragging:!1,isRotating:!0}),this.blockEvents(t)}else{let i=this.controllerState.rotateEnd();this.updateViewport(i,null,{isDragging:!1,isRotating:!1})}return!0}_onPinchStart(e){let t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;let i=this.controllerState.zoomStart({pos:t}).rotateStart({pos:t});return Wu._startPinchRotation=e.rotation,Wu._lastPinchEvent=e,this.updateViewport(i,pl,{isDragging:!0}),!0}_onPinch(e){if(!this.touchZoom&&!this.touchRotate||!this.isDragging())return!1;let t=this.controllerState;if(this.touchZoom){let{scale:i}=e,n=this.getCenter(e);t=t.zoom({pos:n,scale:i})}if(this.touchRotate){let{rotation:i}=e;t=t.rotate({deltaAngleX:Wu._startPinchRotation-i})}return this.updateViewport(t,pl,{isDragging:!0,isPanning:this.touchZoom,isZooming:this.touchZoom,isRotating:this.touchRotate}),Wu._lastPinchEvent=e,!0}_onPinchEnd(e){if(!this.isDragging())return!1;let{inertia:t}=this,{_lastPinchEvent:i}=Wu;if(this.touchZoom&&t&&i&&e.scale!==i.scale){let n=this.getCenter(e),o=this.controllerState.rotateEnd(),a=Math.log2(e.scale),l=(a-Math.log2(i.scale))/(e.deltaTime-i.deltaTime),u=Math.pow(2,a+l*t/2);o=o.zoom({pos:n,scale:u}).zoomEnd(),this.updateViewport(o,{...this._getTransitionProps({around:n}),transitionDuration:t,transitionEasing:zP},{isDragging:!1,isPanning:this.touchZoom,isZooming:this.touchZoom,isRotating:!1}),this.blockEvents(t)}else{let n=this.controllerState.zoomEnd().rotateEnd();this.updateViewport(n,null,{isDragging:!1,isPanning:!1,isZooming:!1,isRotating:!1})}return Wu._startPinchRotation=null,Wu._lastPinchEvent=null,!0}_onDoubleTap(e){if(!this.doubleClickZoom)return!1;let t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;let i=this.isFunctionKeyPressed(e),n=this.controllerState.zoom({pos:t,scale:i?.5:2});return this.updateViewport(n,this._getTransitionProps({around:t}),{isZooming:!0,isPanning:!0}),this.blockEvents(100),!0}_onKeyDown(e){if(!this.keyboard)return!1;let t=this.isFunctionKeyPressed(e),{zoomSpeed:i,moveSpeed:n,rotateSpeedX:o,rotateSpeedY:a}=this.keyboard===!0?{}:this.keyboard,{controllerState:l}=this,u,c={};switch(e.srcEvent.code){case"Minus":u=t?l.zoomOut(i).zoomOut(i):l.zoomOut(i),c.isZooming=!0;break;case"Equal":u=t?l.zoomIn(i).zoomIn(i):l.zoomIn(i),c.isZooming=!0;break;case"ArrowLeft":t?(u=l.rotateLeft(o),c.isRotating=!0):(u=l.moveLeft(n),c.isPanning=!0);break;case"ArrowRight":t?(u=l.rotateRight(o),c.isRotating=!0):(u=l.moveRight(n),c.isPanning=!0);break;case"ArrowUp":t?(u=l.rotateUp(a),c.isRotating=!0):(u=l.moveUp(n),c.isPanning=!0);break;case"ArrowDown":t?(u=l.rotateDown(a),c.isRotating=!0):(u=l.moveDown(n),c.isPanning=!0);break;default:return!1}return this.updateViewport(u,this._getTransitionProps(),c),!0}_getTransitionProps(e){let{transition:t}=this;return!t||!t.transitionInterpolator?pl:e?{...t,transitionInterpolator:new Dn({...e,...t.transitionInterpolator.opts,makeViewport:this.controllerState.makeViewport})}:t}};var ju=class{constructor(e,t){y(this,"_viewportProps",void 0),y(this,"_state",void 0),this._viewportProps=this.applyConstraints(e),this._state=t}getViewportProps(){return this._viewportProps}getState(){return this._state}};var sL=5,b3=1.2,Rx=class extends ju{constructor(e){let{width:t,height:i,latitude:n,longitude:o,zoom:a,bearing:l=0,pitch:u=0,altitude:c=1.5,position:h=[0,0,0],maxZoom:d=20,minZoom:f=0,maxPitch:p=60,minPitch:S=0,startPanLngLat:E,startZoomLngLat:C,startRotatePos:O,startBearing:B,startPitch:A,startZoom:N,normalize:z=!0}=e;mt(Number.isFinite(o)),mt(Number.isFinite(n)),mt(Number.isFinite(a)),super({width:t,height:i,latitude:n,longitude:o,zoom:a,bearing:l,pitch:u,altitude:c,maxZoom:d,minZoom:f,maxPitch:p,minPitch:S,normalize:z,position:h},{startPanLngLat:E,startZoomLngLat:C,startRotatePos:O,startBearing:B,startPitch:A,startZoom:N}),y(this,"makeViewport",void 0),this.makeViewport=e.makeViewport}panStart({pos:e}){return this._getUpdatedState({startPanLngLat:this._unproject(e)})}pan({pos:e,startPos:t}){let i=this.getState().startPanLngLat||this._unproject(t);if(!i)return this;let o=this.makeViewport(this.getViewportProps()).panByPosition(i,e);return this._getUpdatedState(o)}panEnd(){return this._getUpdatedState({startPanLngLat:null})}rotateStart({pos:e}){return this._getUpdatedState({startRotatePos:e,startBearing:this.getViewportProps().bearing,startPitch:this.getViewportProps().pitch})}rotate({pos:e,deltaAngleX:t=0,deltaAngleY:i=0}){let{startRotatePos:n,startBearing:o,startPitch:a}=this.getState();if(!n||o===void 0||a===void 0)return this;let l;return e?l=this._getNewRotation(e,n,a,o):l={bearing:o+t,pitch:a+i},this._getUpdatedState(l)}rotateEnd(){return this._getUpdatedState({startBearing:null,startPitch:null})}zoomStart({pos:e}){return this._getUpdatedState({startZoomLngLat:this._unproject(e),startZoom:this.getViewportProps().zoom})}zoom({pos:e,startPos:t,scale:i}){let{startZoom:n,startZoomLngLat:o}=this.getState();if(o||(n=this.getViewportProps().zoom,o=this._unproject(t)||this._unproject(e)),!o)return this;let{maxZoom:a,minZoom:l}=this.getViewportProps(),u=n+Math.log2(i);u=Rt(u,l,a);let c=this.makeViewport({...this.getViewportProps(),zoom:u});return this._getUpdatedState({zoom:u,...c.panByPosition(o,e)})}zoomEnd(){return this._getUpdatedState({startZoomLngLat:null,startZoom:null})}zoomIn(e=2){return this._zoomFromCenter(e)}zoomOut(e=2){return this._zoomFromCenter(1/e)}moveLeft(e=100){return this._panFromCenter([e,0])}moveRight(e=100){return this._panFromCenter([-e,0])}moveUp(e=100){return this._panFromCenter([0,e])}moveDown(e=100){return this._panFromCenter([0,-e])}rotateLeft(e=15){return this._getUpdatedState({bearing:this.getViewportProps().bearing-e})}rotateRight(e=15){return this._getUpdatedState({bearing:this.getViewportProps().bearing+e})}rotateUp(e=10){return this._getUpdatedState({pitch:this.getViewportProps().pitch+e})}rotateDown(e=10){return this._getUpdatedState({pitch:this.getViewportProps().pitch-e})}shortestPathFrom(e){let t=e.getViewportProps(),i={...this.getViewportProps()},{bearing:n,longitude:o}=i;return Math.abs(n-t.bearing)>180&&(i.bearing=n<0?n+360:n-360),Math.abs(o-t.longitude)>180&&(i.longitude=o<0?o+360:o-360),i}applyConstraints(e){let{maxZoom:t,minZoom:i,zoom:n}=e;e.zoom=Rt(n,i,t);let{maxPitch:o,minPitch:a,pitch:l}=e;e.pitch=Rt(l,a,o);let{normalize:u=!0}=e;return u&&Object.assign(e,kP(e)),e}_zoomFromCenter(e){let{width:t,height:i}=this.getViewportProps();return this.zoom({pos:[t/2,i/2],scale:e})}_panFromCenter(e){let{width:t,height:i}=this.getViewportProps();return this.pan({startPos:[t/2,i/2],pos:[t/2+e[0],i/2+e[1]]})}_getUpdatedState(e){return new this.constructor({makeViewport:this.makeViewport,...this.getViewportProps(),...this.getState(),...e})}_unproject(e){let t=this.makeViewport(this.getViewportProps());return e&&t.unproject(e)}_getNewRotation(e,t,i,n){let o=e[0]-t[0],a=e[1]-t[1],l=e[1],u=t[1],{width:c,height:h}=this.getViewportProps(),d=o/c,f=0;a>0?Math.abs(h-u)>sL&&(f=a/(u-h)*b3):a<0&&u>sL&&(f=1-l/u),f=Rt(f,-1,1);let{minPitch:p,maxPitch:S}=this.getViewportProps(),E=n+180*d,C=i;return f>0?C=i+f*(S-i):f<0&&(C=i-f*(p-i)),{pitch:C,bearing:E}}},vg=class extends Hu{constructor(...e){super(...e),y(this,"ControllerState",Rx),y(this,"transition",{transitionDuration:300,transitionInterpolator:new Dn({transitionProps:{compare:["longitude","latitude","zoom","bearing","pitch","position"],required:["longitude","latitude","zoom"]}})}),y(this,"dragMode","pan")}setProps(e){e.position=e.position||[0,0,0];let t=this.props;super.setProps(e),(!t||t.height!==e.height)&&this.updateViewport(new this.ControllerState({makeViewport:this.makeViewport,...e,...this.state}))}};var qh=class extends zu{get ViewportType(){return Lr}get ControllerType(){return vg}};y(qh,"displayName","MapView");var Cg=class extends fo{constructor(e,t){super(e,t),y(this,"maskMap",void 0),y(this,"fbo",void 0);let{mapSize:i=2048}=t;this.maskMap=new Ue(e,{width:i,height:i,parameters:{[10241]:9729,[10240]:9729,[10242]:33071,[10243]:33071}}),this.fbo=new De(e,{id:"maskmap",width:i,height:i,attachments:{[36064]:this.maskMap}})}render(e){let t=this.gl,i=[!1,!1,!1,!1];return i[e.channel]=!0,pt(t,{clearColor:[255,255,255,255],blend:!0,blendFunc:[0,1],blendEquation:32778,colorMask:i,depthTest:!1},()=>super.render({...e,target:this.fbo,pass:"mask"}))}shouldDrawLayer(e){return e.props.operation===lo.MASK}delete(){this.fbo.delete(),this.maskMap.delete()}};var P3=new $e().lookAt({eye:[0,0,1]});function y3({width:s,height:e,near:t,far:i,padding:n}){let o=-s/2,a=s/2,l=-e/2,u=e/2;if(n){let{left:c=0,right:h=0,top:d=0,bottom:f=0}=n,p=Rt((c+s-h)/2,0,s)-s/2,S=Rt((d+e-f)/2,0,e)-e/2;o-=p,a-=p,l+=S,u+=S}return new $e().ortho({left:o,right:a,bottom:l,top:u,near:t,far:i})}var Ag=class extends li{constructor(e){let{width:t,height:i,near:n=.1,far:o=1e3,zoom:a=0,target:l=[0,0,0],padding:u=null,flipY:c=!0}=e,h=Array.isArray(a)?a[0]:a,d=Array.isArray(a)?a[1]:a,f=Math.min(h,d),p=Math.pow(2,f),S;if(h!==d){let E=Math.pow(2,h),C=Math.pow(2,d);S={unitsPerMeter:[E/p,C/p,1],metersPerUnit:[p/E,p/C,1]}}super({...e,longitude:void 0,position:l,viewMatrix:P3.clone().scale([p,p*(c?-1:1),p]),projectionMatrix:y3({width:t||1,height:i||1,padding:u,near:n,far:o}),zoom:f,distanceScales:S})}projectFlat([e,t]){let{unitsPerMeter:i}=this.distanceScales;return[e*i[0],t*i[1]]}unprojectFlat([e,t]){let{metersPerUnit:i}=this.distanceScales;return[e*i[0],t*i[1]]}panByPosition(e,t){let i=is(t,this.pixelUnprojectionMatrix),n=this.projectFlat(e),o=wh([],n,yP([],i)),a=wh([],this.center,o);return{target:this.unprojectFlat(a)}}};var WP=class extends ju{constructor(e){let{width:t,height:i,rotationX:n=0,rotationOrbit:o=0,target:a=[0,0,0],zoom:l=0,minRotationX:u=-90,maxRotationX:c=90,minZoom:h=-1/0,maxZoom:d=1/0,startPanPosition:f,startRotatePos:p,startRotationX:S,startRotationOrbit:E,startZoomPosition:C,startZoom:O}=e;super({width:t,height:i,rotationX:n,rotationOrbit:o,target:a,zoom:l,minRotationX:u,maxRotationX:c,minZoom:h,maxZoom:d},{startPanPosition:f,startRotatePos:p,startRotationX:S,startRotationOrbit:E,startZoomPosition:C,startZoom:O}),y(this,"makeViewport",void 0),this.makeViewport=e.makeViewport}panStart({pos:e}){return this._getUpdatedState({startPanPosition:this._unproject(e)})}pan({pos:e,startPosition:t}){let i=this.getState().startPanPosition||t;if(!i)return this;let o=this.makeViewport(this.getViewportProps()).panByPosition(i,e);return this._getUpdatedState(o)}panEnd(){return this._getUpdatedState({startPanPosition:null})}rotateStart({pos:e}){return this._getUpdatedState({startRotatePos:e,startRotationX:this.getViewportProps().rotationX,startRotationOrbit:this.getViewportProps().rotationOrbit})}rotate({pos:e,deltaAngleX:t=0,deltaAngleY:i=0}){let{startRotatePos:n,startRotationX:o,startRotationOrbit:a}=this.getState(),{width:l,height:u}=this.getViewportProps();if(!n||o===void 0||a===void 0)return this;let c;if(e){let h=(e[0]-n[0])/l,d=(e[1]-n[1])/u;(o<-90||o>90)&&(h*=-1),c={rotationX:o+d*180,rotationOrbit:a+h*180}}else c={rotationX:o+i,rotationOrbit:a+t};return this._getUpdatedState(c)}rotateEnd(){return this._getUpdatedState({startRotationX:null,startRotationOrbit:null})}shortestPathFrom(e){let t=e.getViewportProps(),i={...this.getViewportProps()},{rotationOrbit:n}=i;return Math.abs(n-t.rotationOrbit)>180&&(i.rotationOrbit=n<0?n+360:n-360),i}zoomStart({pos:e}){return this._getUpdatedState({startZoomPosition:this._unproject(e),startZoom:this.getViewportProps().zoom})}zoom({pos:e,startPos:t,scale:i}){let{startZoom:n,startZoomPosition:o}=this.getState();if(o||(n=this.getViewportProps().zoom,o=this._unproject(t)||this._unproject(e)),!o)return this;let a=this._calculateNewZoom({scale:i,startZoom:n}),l=this.makeViewport({...this.getViewportProps(),zoom:a});return this._getUpdatedState({zoom:a,...l.panByPosition(o,e)})}zoomEnd(){return this._getUpdatedState({startZoomPosition:null,startZoom:null})}zoomIn(e=2){return this._getUpdatedState({zoom:this._calculateNewZoom({scale:e})})}zoomOut(e=2){return this._getUpdatedState({zoom:this._calculateNewZoom({scale:1/e})})}moveLeft(e=50){return this._panFromCenter([-e,0])}moveRight(e=50){return this._panFromCenter([e,0])}moveUp(e=50){return this._panFromCenter([0,-e])}moveDown(e=50){return this._panFromCenter([0,e])}rotateLeft(e=15){return this._getUpdatedState({rotationOrbit:this.getViewportProps().rotationOrbit-e})}rotateRight(e=15){return this._getUpdatedState({rotationOrbit:this.getViewportProps().rotationOrbit+e})}rotateUp(e=10){return this._getUpdatedState({rotationX:this.getViewportProps().rotationX-e})}rotateDown(e=10){return this._getUpdatedState({rotationX:this.getViewportProps().rotationX+e})}_unproject(e){let t=this.makeViewport(this.getViewportProps());return e&&t.unproject(e)}_calculateNewZoom({scale:e,startZoom:t}){let{maxZoom:i,minZoom:n}=this.getViewportProps();t===void 0&&(t=this.getViewportProps().zoom);let o=t+Math.log2(e);return Rt(o,n,i)}_panFromCenter(e){let{width:t,height:i,target:n}=this.getViewportProps();return this.pan({startPosition:n,pos:[t/2+e[0],i/2+e[1]]})}_getUpdatedState(e){return new this.constructor({makeViewport:this.makeViewport,...this.getViewportProps(),...this.getState(),...e})}applyConstraints(e){let{maxZoom:t,minZoom:i,zoom:n,maxRotationX:o,minRotationX:a,rotationOrbit:l}=e;return e.zoom=Array.isArray(n)?[Rt(n[0],i,t),Rt(n[1],i,t)]:Rt(n,i,t),e.rotationX=Rt(e.rotationX,a,o),(l<-180||l>180)&&(e.rotationOrbit=Jw(l+180,360)-180),e}};var Ox=class extends WP{constructor(e){super(e),y(this,"zoomAxis",void 0),this.zoomAxis=e.zoomAxis||"all"}_calculateNewZoom({scale:e,startZoom:t}){let{maxZoom:i,minZoom:n}=this.getViewportProps();t===void 0&&(t=this.getViewportProps().zoom);let o=Math.log2(e);if(Array.isArray(t)){let[a,l]=t;switch(this.zoomAxis){case"X":a=Rt(a+o,n,i);break;case"Y":l=Rt(l+o,n,i);break;default:let u=Math.min(a+o,l+o);u<n&&(o+=n-u),u=Math.max(a+o,l+o),u>i&&(o+=i-u),a+=o,l+=o}return[a,l]}return Rt(t+o,n,i)}},Tg=class extends Hu{constructor(...e){super(...e),y(this,"ControllerState",Ox),y(this,"transition",{transitionDuration:300,transitionInterpolator:new Dn(["target","zoom"])}),y(this,"dragMode","pan")}_onPanRotate(){return!1}};var Qs=class extends zu{get ViewportType(){return Ag}get ControllerType(){return Tg}};y(Qs,"displayName","OrthographicView");function aL({layers:s,viewport:e}){let t=null;for(let o of s){let a=o.getBounds();a&&(t?(t[0]=Math.min(t[0],a[0][0]),t[1]=Math.min(t[1],a[0][1]),t[2]=Math.max(t[2],a[1][0]),t[3]=Math.max(t[3],a[1][1])):t=[a[0][0],a[0][1],a[1][0],a[1][1]])}let i=e.getBounds();if(!t)return i;let n=S3(i);return t[2]-t[0]<n[2]-n[0]||t[3]-t[1]<n[3]-n[1]||(t[0]=Math.max(t[0],n[0]),t[1]=Math.max(t[1],n[1]),t[2]=Math.min(t[2],n[2]),t[3]=Math.min(t[3],n[3])),t}function lL({bounds:s,viewport:e,width:t,height:i}){if(s[2]<=s[0]||s[3]<=s[1])return null;let n=1;if(t-=n*2,i-=n*2,e instanceof Lr){let{longitude:l,latitude:u,zoom:c}=Uu({width:t,height:i,bounds:[[s[0],s[1]],[s[2],s[3]]],maxZoom:20});return new Lr({longitude:l,latitude:u,zoom:c,x:n,y:n,width:t,height:i})}let o=[(s[0]+s[2])/2,(s[1]+s[3])/2,0],a=Math.min(20,t/(s[2]-s[0]),i/(s[3]-s[1]));return new Qs({x:n,y:n}).makeViewport({width:t,height:i,viewState:{target:o,zoom:Math.log2(a)}})}function S3(s){let e={x:s[2]-s[0],y:s[3]-s[1]},t={x:s[0]+.5*e.x,y:s[1]+.5*e.y};return[t.x-e.x,t.y-e.y,t.x+e.x,t.y+e.y]}var Ig=class{constructor(){y(this,"id","mask-effect"),y(this,"props",null),y(this,"useInPicking",!0),y(this,"dummyMaskMap",void 0),y(this,"channels",[]),y(this,"masks",null),y(this,"maskPass",void 0),y(this,"maskMap",void 0),y(this,"lastViewport",void 0)}preRender(e,{layers:t,layerFilter:i,viewports:n,onViewportActive:o,views:a}){this.dummyMaskMap||(this.dummyMaskMap=new Ue(e,{width:1,height:1}));let l=t.filter(d=>d.props.visible&&d.props.operation===lo.MASK);if(l.length===0){this.masks=null,this.channels.length=0;return}this.masks={},this.maskPass||(this.maskPass=new Cg(e,{id:"default-mask"}),this.maskMap=this.maskPass.maskMap);let u=this._sortMaskChannels(l),c=n[0],h=!this.lastViewport||!this.lastViewport.equals(c);for(let d in u)this._renderChannel(u[d],{layerFilter:i,onViewportActive:o,views:a,viewport:c,viewportChanged:h})}_renderChannel(e,{layerFilter:t,onViewportActive:i,views:n,viewport:o,viewportChanged:a}){let l=this.channels[e.index];if(!l)return;let u=e===l||l.layers.length!==e.layers.length||e.layerBounds.some((c,h)=>c!==l.layerBounds[h]);if(e.bounds=l.bounds,e.maskBounds=l.maskBounds,this.channels[e.index]=e,(u||a)&&(this.lastViewport=o,e.bounds=aL({layers:e.layers,viewport:o}),u||!kr(e.bounds,l.bounds))){let{maskPass:c,maskMap:h}=this,d=lL({bounds:e.bounds,viewport:o,width:h.width,height:h.height});e.maskBounds=d?d.getBounds():[0,0,1,1],c.render({pass:"mask",channel:e.index,layers:e.layers,layerFilter:t,viewports:d?[d]:[],onViewportActive:i,views:n,moduleParameters:{devicePixelRatio:1}})}this.masks[e.id]={index:e.index,bounds:e.maskBounds,coordinateOrigin:e.coordinateOrigin,coordinateSystem:e.coordinateSystem}}_sortMaskChannels(e){let t={},i=0;for(let n of e){let{id:o}=n.root,a=t[o];if(!a){if(++i>4){fe.warn("Too many mask layers. The max supported is 4")();continue}a={id:o,index:this.channels.findIndex(l=>l?.id===o),layers:[],layerBounds:[],coordinateOrigin:n.root.props.coordinateOrigin,coordinateSystem:n.root.props.coordinateSystem},t[o]=a}a.layers.push(n),a.layerBounds.push(n.getBounds())}for(let n=0;n<4;n++){let o=this.channels[n];(!o||!(o.id in t))&&(this.channels[n]=null)}for(let n in t){let o=t[n];o.index<0&&(o.index=this.channels.findIndex(a=>!a),this.channels[o.index]=o)}return t}getModuleParameters(){return{maskMap:this.masks?this.maskMap:this.dummyMaskMap,maskChannels:this.masks}}cleanup(){this.dummyMaskMap&&(this.dummyMaskMap.delete(),this.dummyMaskMap=void 0),this.maskPass&&(this.maskPass.delete(),this.maskPass=void 0,this.maskMap=void 0),this.lastViewport=void 0,this.masks=null,this.channels.length=0}};var E3=new Uh,wg=class{constructor(){y(this,"effects",void 0),y(this,"_internalEffects",void 0),y(this,"_needsRedraw",void 0),this.effects=[],this._internalEffects=[],this._needsRedraw="Initial render",this.setEffects()}setProps(e){"effects"in e&&(e.effects.length!==this.effects.length||!an(e.effects,this.effects))&&(this.setEffects(e.effects),this._needsRedraw="effects changed")}needsRedraw(e={clearRedrawFlags:!1}){let t=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),t}getEffects(){return this._internalEffects}finalize(){this.cleanup()}setEffects(e=[]){this.cleanup(),this.effects=e,this._internalEffects=e.slice(),this._internalEffects.push(new Ig),e.some(t=>t instanceof Uh)||this._internalEffects.push(E3)}cleanup(){for(let e of this.effects)e.cleanup();for(let e of this._internalEffects)e.cleanup();this.effects.length=0,this._internalEffects.length=0}};var Lg=class extends fo{shouldDrawLayer(e){return e.props.operation===lo.DRAW}};var uL={blendFunc:[1,0,32771,0],blendEquation:32774},qu=class extends fo{constructor(...e){super(...e),y(this,"pickZ",void 0),y(this,"_colors",null)}render(e){return e.pickingFBO?this._drawPickingBuffer(e):super.render(e)}_drawPickingBuffer({layers:e,layerFilter:t,views:i,viewports:n,onViewportActive:o,pickingFBO:a,deviceRect:{x:l,y:u,width:c,height:h},cullRect:d,effects:f,pass:p="picking",pickZ:S}){let E=this.gl;this.pickZ=S;let C=S?null:{byLayer:new Map,byAlpha:[]};this._colors=C;let O=pt(E,{scissorTest:!0,scissor:[l,u,c,h],clearColor:[0,0,0,0],depthMask:!0,depthTest:!0,depthRange:[0,1],colorMask:[!0,!0,!0,!0],...uL,blend:!S},()=>super.render({target:a,layers:e,layerFilter:t,views:i,viewports:n,onViewportActive:o,cullRect:d,effects:f?.filter(A=>A.useInPicking),pass:p}));return this._colors=null,{decodePickingColor:C&&v3.bind(null,C),stats:O}}shouldDrawLayer(e){return e.props.pickable&&e.props.operation===lo.DRAW}getModuleParameters(){return{pickingActive:1,pickingAttribute:this.pickZ,lightSources:{}}}getLayerParameters(e,t,i){let n={...e.props.parameters};return this._colors?(Object.assign(n,uL),n.blend=!0,n.blendColor=x3(this._colors,e,i)):n.blend=!1,n}};function x3(s,e,t){let{byLayer:i,byAlpha:n}=s,o,a=i.get(e);return a?(a.viewports.push(t),o=a.a):(o=i.size+1,o<=255?(a={a:o,layer:e,viewports:[t]},i.set(e,a),n[o]=a):(fe.warn("Too many pickable layers, only picking the first 255")(),o=0)),[0,0,0,o/255]}function v3(s,e){let t=s.byAlpha[e[3]];return t&&{pickedLayer:t.layer,pickedViewports:t.viewports,pickedObjectIndex:t.layer.decodePickingColor(e)}}var C3="deckRenderer.renderLayers",Rg=class{constructor(e){this.gl=e,this.layerFilter=null,this.drawPickingColors=!1,this.drawLayersPass=new Lg(e),this.pickLayersPass=new qu(e),this.renderCount=0,this._needsRedraw="Initial render",this.renderBuffers=[],this.lastPostProcessEffect=null}setProps(e){"layerFilter"in e&&this.layerFilter!==e.layerFilter&&(this.layerFilter=e.layerFilter,this._needsRedraw="layerFilter changed"),"drawPickingColors"in e&&this.drawPickingColors!==e.drawPickingColors&&(this.drawPickingColors=e.drawPickingColors,this._needsRedraw="drawPickingColors changed")}renderLayers(e){let t=this.drawPickingColors?this.pickLayersPass:this.drawLayersPass;e.layerFilter=e.layerFilter||this.layerFilter,e.effects=e.effects||[],e.target=e.target||De.getDefaultFramebuffer(this.gl),this._preRender(e.effects,e);let i=this.lastPostProcessEffect?this.renderBuffers[0]:e.target,n=t.render({...e,target:i});this._postRender(e.effects,e),this.renderCount++,Gt(C3,this,n,e)}needsRedraw(e={clearRedrawFlags:!1}){let t=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),t}finalize(){let{renderBuffers:e}=this;for(let t of e)t.delete();e.length=0}_preRender(e,t){let i=null;for(let n of e)n.preRender(this.gl,t),n.postRender&&(i=n);i&&this._resizeRenderBuffers(),this.lastPostProcessEffect=i}_resizeRenderBuffers(){let{renderBuffers:e}=this;e.length===0&&e.push(new De(this.gl),new De(this.gl));for(let t of e)t.resize()}_postRender(e,t){let{renderBuffers:i}=this,n={inputBuffer:i[0],swapBuffer:i[1],target:null};for(let o of e)if(o.postRender){if(o===this.lastPostProcessEffect){n.target=t.target,o.postRender(this.gl,n);break}let a=o.postRender(this.gl,n);n.inputBuffer=a,n.swapBuffer=a===i[0]?i[1]:i[0]}}};var A3={pickedColor:null,pickedObjectIndex:-1};function cL({pickedColors:s,decodePickingColor:e,deviceX:t,deviceY:i,deviceRadius:n,deviceRect:o}){let{x:a,y:l,width:u,height:c}=o,h=n*n,d=-1,f=0;for(let p=0;p<c;p++){let S=p+l-i,E=S*S;if(E>h)f+=4*u;else for(let C=0;C<u;C++){if(s[f+3]-1>=0){let B=C+a-t,A=B*B+E;A<=h&&(h=A,d=f)}f+=4}}if(d>=0){let p=s.slice(d,d+4),S=e(p);if(S){let E=Math.floor(d/4/u),C=d/4-E*u;return{...S,pickedColor:p,pickedX:a+C,pickedY:l+E}}fe.error("Picked non-existent layer. Is picking buffer corrupt?")()}return A3}function hL({pickedColors:s,decodePickingColor:e}){let t=new Map;if(s){for(let i=0;i<s.length;i+=4)if(s[i+3]-1>=0){let o=s.slice(i,i+4),a=o.join(",");if(!t.has(a)){let l=e(o);l?t.set(a,{...l,color:o}):fe.error("Picked non-existent layer. Is picking buffer corrupt?")()}}}return Array.from(t.values())}function _x({pickInfo:s,viewports:e,pixelRatio:t,x:i,y:n,z:o}){let a=e[0];e.length>1&&(a=T3(s?.pickedViewports||e,{x:i,y:n}));let l;if(a){let u=[i-a.x,n-a.y];o!==void 0&&(u[2]=o),l=a.unproject(u)}return{color:null,layer:null,viewport:a,index:-1,picked:!1,x:i,y:n,pixel:[i,n],coordinate:l,devicePixel:s&&"pickedX"in s?[s.pickedX,s.pickedY]:void 0,pixelRatio:t}}function dL(s){let{pickInfo:e,lastPickedInfo:t,mode:i,layers:n}=s,{pickedColor:o,pickedLayer:a,pickedObjectIndex:l}=e,u=a?[a]:[];if(i==="hover"){let d=t.index,f=t.layerId,p=a?a.props.id:null;if(p!==f||l!==d){if(p!==f){let S=n.find(E=>E.props.id===f);S&&u.unshift(S)}t.layerId=p,t.index=l,t.info=null}}let c=_x(s),h=new Map;return h.set(null,c),u.forEach(d=>{let f={...c};d===a&&(f.color=o,f.index=l,f.picked=!0),f=Nx({layer:d,info:f,mode:i});let p=f.layer;d===a&&i==="hover"&&(t.info=f),h.set(p.id,f),i==="hover"&&p.updateAutoHighlight(f)}),h}function Nx({layer:s,info:e,mode:t}){for(;s&&e;){let i=e.layer||null;e.sourceLayer=i,e.layer=s,e=s.getPickingInfo({info:e,mode:t,sourceLayer:i}),s=s.parent}return e}function T3(s,e){for(let t=s.length-1;t>=0;t--){let i=s[t];if(i.containsPixel(e))return i}return s[0]}var Og=class{constructor(e){y(this,"gl",void 0),y(this,"pickingFBO",void 0),y(this,"depthFBO",void 0),y(this,"pickLayersPass",void 0),y(this,"layerFilter",void 0),y(this,"lastPickedInfo",void 0),y(this,"_pickable",!0),this.gl=e,this.pickLayersPass=new qu(e),this.lastPickedInfo={index:-1,layerId:null,info:null}}setProps(e){"layerFilter"in e&&(this.layerFilter=e.layerFilter),"_pickable"in e&&(this._pickable=e._pickable)}finalize(){this.pickingFBO&&this.pickingFBO.delete(),this.depthFBO&&(this.depthFBO.color.delete(),this.depthFBO.delete())}pickObject(e){return this._pickClosestObject(e)}pickObjects(e){return this._pickVisibleObjects(e)}getLastPickedObject({x:e,y:t,layers:i,viewports:n},o=this.lastPickedInfo.info){let a=o&&o.layer&&o.layer.id,l=o&&o.viewport&&o.viewport.id,u=a?i.find(f=>f.id===a):null,c=l&&n.find(f=>f.id===l)||n[0],h=c&&c.unproject([e-c.x,t-c.y]);return{...o,...{x:e,y:t,viewport:c,coordinate:h,layer:u}}}_resizeBuffer(){var e,t;let{gl:i}=this;if(!this.pickingFBO&&(this.pickingFBO=new De(i),De.isSupported(i,{colorBufferFloat:!0}))){let n=new De(i);n.attach({[36064]:new Ue(i,{format:ge(i)?34836:6408,type:5126})}),this.depthFBO=n}(e=this.pickingFBO)===null||e===void 0||e.resize({width:i.canvas.width,height:i.canvas.height}),(t=this.depthFBO)===null||t===void 0||t.resize({width:i.canvas.width,height:i.canvas.height})}_getPickable(e){if(this._pickable===!1)return null;let t=e.filter(i=>i.isPickable()&&!i.isComposite);return t.length?t:null}_pickClosestObject({layers:e,views:t,viewports:i,x:n,y:o,radius:a=0,depth:l=1,mode:u="query",unproject3D:c,onViewportActive:h,effects:d}){let f=this._getPickable(e),p=io(this.gl);if(!f)return{result:[],emptyInfo:_x({viewports:i,x:n,y:o,pixelRatio:p})};this._resizeBuffer();let S=Ph(this.gl,[n,o],!0),E=[S.x+Math.floor(S.width/2),S.y+Math.floor(S.height/2)],C=Math.round(a*p),{width:O,height:B}=this.pickingFBO,A=this._getPickingRect({deviceX:E[0],deviceY:E[1],deviceRadius:C,deviceWidth:O,deviceHeight:B}),N={x:n-a,y:o-a,width:a*2+1,height:a*2+1},z,Y=[],ie=new Set;for(let he=0;he<l;he++){let ae;if(A){let _=this._drawAndSample({layers:f,views:t,viewports:i,onViewportActive:h,deviceRect:A,cullRect:N,effects:d,pass:"picking:".concat(u)});ae=cL({..._,deviceX:E[0],deviceY:E[1],deviceRadius:C,deviceRect:A})}else ae={pickedColor:null,pickedObjectIndex:-1};let D;ae.pickedLayer&&c&&this.depthFBO&&(D=this._drawAndSample({layers:[ae.pickedLayer],views:t,viewports:i,onViewportActive:h,deviceRect:{x:ae.pickedX,y:ae.pickedY,width:1,height:1},cullRect:N,effects:d,pass:"picking:".concat(u,":z")},!0).pickedColors[0]),ae.pickedLayer&&he+1<l&&(ie.add(ae.pickedLayer),ae.pickedLayer.disablePickingIndex(ae.pickedObjectIndex)),z=dL({pickInfo:ae,lastPickedInfo:this.lastPickedInfo,mode:u,layers:f,viewports:i,x:n,y:o,z:D,pixelRatio:p});for(let _ of z.values())_.layer&&Y.push(_);if(!ae.pickedColor)break}for(let he of ie)he.restorePickingColors();return{result:Y,emptyInfo:z.get(null)}}_pickVisibleObjects({layers:e,views:t,viewports:i,x:n,y:o,width:a=1,height:l=1,mode:u="query",maxObjects:c=null,onViewportActive:h,effects:d}){let f=this._getPickable(e);if(!f)return[];this._resizeBuffer();let p=io(this.gl),S=Ph(this.gl,[n,o],!0),E=S.x,C=S.y+S.height,O=Ph(this.gl,[n+a,o+l],!0),B=O.x+O.width,A=O.y,N={x:E,y:A,width:B-E,height:C-A},z=this._drawAndSample({layers:f,views:t,viewports:i,onViewportActive:h,deviceRect:N,cullRect:{x:n,y:o,width:a,height:l},effects:d,pass:"picking:".concat(u)}),Y=hL(z),ie=new Map,he=Number.isFinite(c);for(let ae=0;ae<Y.length&&!(he&&c&&ie.size>=c);ae++){let D=Y[ae],_={color:D.pickedColor,layer:null,index:D.pickedObjectIndex,picked:!0,x:n,y:o,pixelRatio:p};_=Nx({layer:D.pickedLayer,info:_,mode:u}),ie.has(_.object)||ie.set(_.object,_)}return Array.from(ie.values())}_drawAndSample({layers:e,views:t,viewports:i,onViewportActive:n,deviceRect:o,cullRect:a,effects:l,pass:u},c=!1){let h=c?this.depthFBO:this.pickingFBO,{decodePickingColor:d}=this.pickLayersPass.render({layers:e,layerFilter:this.layerFilter,views:t,viewports:i,onViewportActive:n,pickingFBO:h,deviceRect:o,cullRect:a,effects:l,pass:u,pickZ:c}),{x:f,y:p,width:S,height:E}=o,C=new(c?Float32Array:Uint8Array)(S*E*4);return Us(h,{sourceX:f,sourceY:p,sourceWidth:S,sourceHeight:E,target:C}),{pickedColors:C,decodePickingColor:d}}_getPickingRect({deviceX:e,deviceY:t,deviceRadius:i,deviceWidth:n,deviceHeight:o}){let a=Math.max(0,e-i),l=Math.max(0,t-i),u=Math.min(n,e+i+1)-a,c=Math.min(o,t+i+1)-l;return u<=0||c<=0?null:{x:a,y:l,width:u,height:c}}};var I3={zIndex:"1",position:"absolute",pointerEvents:"none",color:"#a0a7b4",backgroundColor:"#29323c",padding:"10px",top:"0",left:"0",display:"none"},_g=class{constructor(e){y(this,"el",null),y(this,"isVisible",!1);let t=e.parentElement;t&&(this.el=document.createElement("div"),this.el.className="deck-tooltip",Object.assign(this.el.style,I3),t.appendChild(this.el))}setTooltip(e,t,i){let n=this.el;if(!!n){if(typeof e=="string")n.innerText=e;else if(e)e.text&&(n.innerText=e.text),e.html&&(n.innerHTML=e.html),e.className&&(n.className=e.className),Object.assign(n.style,e.style);else{this.isVisible=!1,n.style.display="none";return}this.isVisible=!0,n.style.display="block",n.style.transform="translate(".concat(t,"px, ").concat(i,"px)")}}remove(){this.el&&(this.el.remove(),this.el=null)}};var Xu=Ae(fL());var w3={mousedown:1,mousemove:2,mouseup:4};function L3(s,e){for(let t=0;t<s.length;t++)if(e(s[t]))return!0;return!1}function gL(s){let e=s.prototype.handler;s.prototype.handler=function(i){let n=this.store;i.button>0&&i.type==="pointerdown"&&(L3(n,o=>o.pointerId===i.pointerId)||n.push(i)),e.call(this,i)}}function pL(s){s.prototype.handler=function(t){let i=w3[t.type];i&1&&t.button>=0&&(this.pressed=!0),i&2&&t.which===0&&(i=4),this.pressed&&(i&4&&(this.pressed=!1),this.callback(this.manager,i,{pointers:[t],changedPointers:[t],pointerType:"mouse",srcEvent:t}))}}gL(Xu.PointerEventInput);pL(Xu.MouseInput);var mL=Xu.Manager,mo=Xu;var bo=class{constructor(e,t,i){this.element=e,this.callback=t,this.options={enable:!0,...i}}};var bL=mo?[[mo.Pan,{event:"tripan",pointers:3,threshold:0,enable:!1}],[mo.Rotate,{enable:!1}],[mo.Pinch,{enable:!1}],[mo.Swipe,{enable:!1}],[mo.Pan,{threshold:0,enable:!1}],[mo.Press,{enable:!1}],[mo.Tap,{event:"doubletap",taps:2,enable:!1}],[mo.Tap,{event:"anytap",enable:!1}],[mo.Tap,{enable:!1}]]:null,Mx={tripan:["rotate","pinch","pan"],rotate:["pinch"],pinch:["pan"],pan:["press","doubletap","anytap","tap"],doubletap:["anytap"],anytap:["tap"]},PL={doubletap:["tap"]},yL={pointerdown:"pointerdown",pointermove:"pointermove",pointerup:"pointerup",touchstart:"pointerdown",touchmove:"pointermove",touchend:"pointerup",mousedown:"pointerdown",mousemove:"pointermove",mouseup:"pointerup"},Xh={KEY_EVENTS:["keydown","keyup"],MOUSE_EVENTS:["mousedown","mousemove","mouseup","mouseover","mouseout","mouseleave"],WHEEL_EVENTS:["wheel","mousewheel"]},SL={tap:"tap",anytap:"anytap",doubletap:"doubletap",press:"press",pinch:"pinch",pinchin:"pinch",pinchout:"pinch",pinchstart:"pinch",pinchmove:"pinch",pinchend:"pinch",pinchcancel:"pinch",rotate:"rotate",rotatestart:"rotate",rotatemove:"rotate",rotateend:"rotate",rotatecancel:"rotate",tripan:"tripan",tripanstart:"tripan",tripanmove:"tripan",tripanup:"tripan",tripandown:"tripan",tripanleft:"tripan",tripanright:"tripan",tripanend:"tripan",tripancancel:"tripan",pan:"pan",panstart:"pan",panmove:"pan",panup:"pan",pandown:"pan",panleft:"pan",panright:"pan",panend:"pan",pancancel:"pan",swipe:"swipe",swipeleft:"swipe",swiperight:"swipe",swipeup:"swipe",swipedown:"swipe"},Bx={click:"tap",anyclick:"anytap",dblclick:"doubletap",mousedown:"pointerdown",mousemove:"pointermove",mouseup:"pointerup",mouseover:"pointerover",mouseout:"pointerout",mouseleave:"pointerleave"};var EL=typeof navigator<"u"&&navigator.userAgent?navigator.userAgent.toLowerCase():"",Yu=typeof window<"u"?window:global;var jP=!1;try{let s={get passive(){return jP=!0,!0}};Yu.addEventListener("test",null,s),Yu.removeEventListener("test",null)}catch{jP=!1}var R3=EL.indexOf("firefox")!==-1,{WHEEL_EVENTS:O3}=Xh,xL="wheel",vL=4.000244140625,_3=40,N3=.25,Ng=class extends bo{constructor(e,t,i){super(e,t,i),this.handleEvent=n=>{if(!this.options.enable)return;let o=n.deltaY;Yu.WheelEvent&&(R3&&n.deltaMode===Yu.WheelEvent.DOM_DELTA_PIXEL&&(o/=Yu.devicePixelRatio),n.deltaMode===Yu.WheelEvent.DOM_DELTA_LINE&&(o*=_3)),o!==0&&o%vL===0&&(o=Math.floor(o/vL)),n.shiftKey&&o&&(o=o*N3),this.callback({type:xL,center:{x:n.clientX,y:n.clientY},delta:-o,srcEvent:n,pointerType:"mouse",target:n.target})},this.events=(this.options.events||[]).concat(O3),this.events.forEach(n=>e.addEventListener(n,this.handleEvent,jP?{passive:!1}:!1))}destroy(){this.events.forEach(e=>this.element.removeEventListener(e,this.handleEvent))}enableEventType(e,t){e===xL&&(this.options.enable=t)}};var{MOUSE_EVENTS:M3}=Xh,CL="pointermove",AL="pointerover",TL="pointerout",IL="pointerenter",wL="pointerleave",Mg=class extends bo{constructor(e,t,i){super(e,t,i),this.handleEvent=o=>{this.handleOverEvent(o),this.handleOutEvent(o),this.handleEnterEvent(o),this.handleLeaveEvent(o),this.handleMoveEvent(o)},this.pressed=!1;let{enable:n}=this.options;this.enableMoveEvent=n,this.enableLeaveEvent=n,this.enableEnterEvent=n,this.enableOutEvent=n,this.enableOverEvent=n,this.events=(this.options.events||[]).concat(M3),this.events.forEach(o=>e.addEventListener(o,this.handleEvent))}destroy(){this.events.forEach(e=>this.element.removeEventListener(e,this.handleEvent))}enableEventType(e,t){e===CL&&(this.enableMoveEvent=t),e===AL&&(this.enableOverEvent=t),e===TL&&(this.enableOutEvent=t),e===IL&&(this.enableEnterEvent=t),e===wL&&(this.enableLeaveEvent=t)}handleOverEvent(e){this.enableOverEvent&&e.type==="mouseover"&&this._emit(AL,e)}handleOutEvent(e){this.enableOutEvent&&e.type==="mouseout"&&this._emit(TL,e)}handleEnterEvent(e){this.enableEnterEvent&&e.type==="mouseenter"&&this._emit(IL,e)}handleLeaveEvent(e){this.enableLeaveEvent&&e.type==="mouseleave"&&this._emit(wL,e)}handleMoveEvent(e){if(this.enableMoveEvent)switch(e.type){case"mousedown":e.button>=0&&(this.pressed=!0);break;case"mousemove":e.which===0&&(this.pressed=!1),this.pressed||this._emit(CL,e);break;case"mouseup":this.pressed=!1;break;default:}}_emit(e,t){this.callback({type:e,center:{x:t.clientX,y:t.clientY},srcEvent:t,pointerType:"mouse",target:t.target})}};var{KEY_EVENTS:B3}=Xh,LL="keydown",RL="keyup",Bg=class extends bo{constructor(e,t,i){super(e,t,i),this.handleEvent=n=>{let o=n.target||n.srcElement;o.tagName==="INPUT"&&o.type==="text"||o.tagName==="TEXTAREA"||(this.enableDownEvent&&n.type==="keydown"&&this.callback({type:LL,srcEvent:n,key:n.key,target:n.target}),this.enableUpEvent&&n.type==="keyup"&&this.callback({type:RL,srcEvent:n,key:n.key,target:n.target}))},this.enableDownEvent=this.options.enable,this.enableUpEvent=this.options.enable,this.events=(this.options.events||[]).concat(B3),e.tabIndex=this.options.tabIndex||0,e.style.outline="none",this.events.forEach(n=>e.addEventListener(n,this.handleEvent))}destroy(){this.events.forEach(e=>this.element.removeEventListener(e,this.handleEvent))}enableEventType(e,t){e===LL&&(this.enableDownEvent=t),e===RL&&(this.enableUpEvent=t)}};var OL="contextmenu",Dg=class extends bo{constructor(e,t,i){super(e,t,i),this.handleEvent=n=>{!this.options.enable||this.callback({type:OL,center:{x:n.clientX,y:n.clientY},srcEvent:n,pointerType:"mouse",target:n.target})},e.addEventListener("contextmenu",this.handleEvent)}destroy(){this.element.removeEventListener("contextmenu",this.handleEvent)}enableEventType(e,t){e===OL&&(this.options.enable=t)}};var D3={pointerdown:1,pointermove:2,pointerup:4,mousedown:1,mousemove:2,mouseup:4},G3=1,F3=2,k3=3,V3=0,U3=1,z3=2,W3=1,H3=2,j3=4;function _L(s){let e=D3[s.srcEvent.type];if(!e)return null;let{buttons:t,button:i,which:n}=s.srcEvent,o=!1,a=!1,l=!1;return e===4||e===2&&!Number.isFinite(t)?(o=n===G3,a=n===F3,l=n===k3):e===2?(o=Boolean(t&W3),a=Boolean(t&j3),l=Boolean(t&H3)):e===1&&(o=i===V3,a=i===U3,l=i===z3),{leftButton:o,middleButton:a,rightButton:l}}function NL(s,e){let t=s.center;if(!t)return null;let i=e.getBoundingClientRect(),n=i.width/e.offsetWidth||1,o=i.height/e.offsetHeight||1,a={x:(t.x-i.left-e.clientLeft)/n,y:(t.y-i.top-e.clientTop)/o};return{center:t,offsetCenter:a}}var Dx={srcElement:"root",priority:0},Gg=class{constructor(e){this.handleEvent=t=>{if(this.isEmpty())return;let i=this._normalizeEvent(t),n=t.srcEvent.target;for(;n&&n!==i.rootElement;){if(this._emit(i,n),i.handled)return;n=n.parentNode}this._emit(i,"root")},this.eventManager=e,this.handlers=[],this.handlersByElement=new Map,this._active=!1}isEmpty(){return!this._active}add(e,t,i,n=!1,o=!1){let{handlers:a,handlersByElement:l}=this,u=Dx;typeof i=="string"||i&&i.addEventListener?u={...Dx,srcElement:i}:i&&(u={...Dx,...i});let c=l.get(u.srcElement);c||(c=[],l.set(u.srcElement,c));let h={type:e,handler:t,srcElement:u.srcElement,priority:u.priority};n&&(h.once=!0),o&&(h.passive=!0),a.push(h),this._active=this._active||!h.passive;let d=c.length-1;for(;d>=0&&!(c[d].priority>=h.priority);)d--;c.splice(d+1,0,h)}remove(e,t){let{handlers:i,handlersByElement:n}=this;for(let o=i.length-1;o>=0;o--){let a=i[o];if(a.type===e&&a.handler===t){i.splice(o,1);let l=n.get(a.srcElement);l.splice(l.indexOf(a),1),l.length===0&&n.delete(a.srcElement)}}this._active=i.some(o=>!o.passive)}_emit(e,t){let i=this.handlersByElement.get(t);if(i){let n=!1,o=()=>{e.handled=!0},a=()=>{e.handled=!0,n=!0},l=[];for(let u=0;u<i.length;u++){let{type:c,handler:h,once:d}=i[u];if(h({...e,type:c,stopPropagation:o,stopImmediatePropagation:a}),d&&l.push(i[u]),n)break}for(let u=0;u<l.length;u++){let{type:c,handler:h}=l[u];this.remove(c,h)}}}_normalizeEvent(e){let t=this.eventManager.getElement();return{...e,..._L(e),...NL(e,t),preventDefault:()=>{e.srcEvent.preventDefault()},stopImmediatePropagation:null,stopPropagation:null,handled:!1,rootElement:t}}};var q3={events:null,recognizers:null,recognizerOptions:{},Manager:mL,touchAction:"none",tabIndex:0},Yh=class{constructor(e=null,t){this._onBasicInput=n=>{let{srcEvent:o}=n,a=yL[o.type];a&&this.manager.emit(a,n)},this._onOtherEvent=n=>{this.manager.emit(n.type,n)},this.options={...q3,...t},this.events=new Map,this.setElement(e);let{events:i}=this.options;i&&this.on(i)}getElement(){return this.element}setElement(e){if(this.element&&this.destroy(),this.element=e,!e)return;let{options:t}=this,i=t.Manager;this.manager=new i(e,{touchAction:t.touchAction,recognizers:t.recognizers||bL}).on("hammer.input",this._onBasicInput),t.recognizers||Object.keys(Mx).forEach(n=>{let o=this.manager.get(n);o&&Mx[n].forEach(a=>{o.recognizeWith(a)})});for(let n in t.recognizerOptions){let o=this.manager.get(n);if(o){let a=t.recognizerOptions[n];delete a.enable,o.set(a)}}this.wheelInput=new Ng(e,this._onOtherEvent,{enable:!1}),this.moveInput=new Mg(e,this._onOtherEvent,{enable:!1}),this.keyInput=new Bg(e,this._onOtherEvent,{enable:!1,tabIndex:t.tabIndex}),this.contextmenuInput=new Dg(e,this._onOtherEvent,{enable:!1});for(let[n,o]of this.events)o.isEmpty()||(this._toggleRecognizer(o.recognizerName,!0),this.manager.on(n,o.handleEvent))}destroy(){this.element&&(this.wheelInput.destroy(),this.moveInput.destroy(),this.keyInput.destroy(),this.contextmenuInput.destroy(),this.manager.destroy(),this.wheelInput=null,this.moveInput=null,this.keyInput=null,this.contextmenuInput=null,this.manager=null,this.element=null)}on(e,t,i){this._addEventHandler(e,t,i,!1)}once(e,t,i){this._addEventHandler(e,t,i,!0)}watch(e,t,i){this._addEventHandler(e,t,i,!1,!0)}off(e,t){this._removeEventHandler(e,t)}_toggleRecognizer(e,t){let{manager:i}=this;if(!i)return;let n=i.get(e);if(n&&n.options.enable!==t){n.set({enable:t});let o=PL[e];o&&!this.options.recognizers&&o.forEach(a=>{let l=i.get(a);t?(l.requireFailure(e),n.dropRequireFailure(a)):l.dropRequireFailure(e)})}this.wheelInput.enableEventType(e,t),this.moveInput.enableEventType(e,t),this.keyInput.enableEventType(e,t),this.contextmenuInput.enableEventType(e,t)}_addEventHandler(e,t,i,n,o){if(typeof e!="string"){i=t;for(let h in e)this._addEventHandler(h,e[h],i,n,o);return}let{manager:a,events:l}=this,u=Bx[e]||e,c=l.get(u);c||(c=new Gg(this),l.set(u,c),c.recognizerName=SL[u]||u,a&&a.on(u,c.handleEvent)),c.add(e,t,i,n,o),c.isEmpty()||this._toggleRecognizer(c.recognizerName,!0)}_removeEventHandler(e,t){if(typeof e!="string"){for(let a in e)this._removeEventHandler(a,e[a]);return}let{events:i}=this,n=Bx[e]||e,o=i.get(n);if(!!o&&(o.remove(e,t),o.isEmpty())){let{recognizerName:a}=o,l=!1;for(let u of i.values())if(u.recognizerName===a&&!u.isEmpty()){l=!0;break}l||this._toggleRecognizer(a,!1)}}};function Ku(){}var X3=({isDragging:s})=>s?"grabbing":"grab",ML={id:"",width:"100%",height:"100%",style:null,viewState:null,initialViewState:null,pickingRadius:0,layerFilter:null,glOptions:{},parameters:{},parent:null,gl:null,canvas:null,layers:[],effects:[],views:null,controller:null,useDevicePixels:!0,touchAction:"none",eventRecognizerOptions:{},_framebuffer:null,_animate:!1,_pickable:!0,_typedArrayManagerProps:{},_customRender:null,onWebGLInitialized:Ku,onResize:Ku,onViewStateChange:Ku,onInteractionStateChange:Ku,onBeforeRender:Ku,onAfterRender:Ku,onLoad:Ku,onError:s=>fe.error(s.message)(),onHover:null,onClick:null,onDragStart:null,onDrag:null,onDragEnd:null,_onMetrics:null,getCursor:X3,getTooltip:null,debug:!1,drawPickingColors:!1},ml=class{constructor(e){y(this,"props",void 0),y(this,"width",0),y(this,"height",0),y(this,"userData",{}),y(this,"canvas",null),y(this,"viewManager",null),y(this,"layerManager",null),y(this,"effectManager",null),y(this,"deckRenderer",null),y(this,"deckPicker",null),y(this,"eventManager",null),y(this,"tooltip",null),y(this,"metrics",void 0),y(this,"animationLoop",void 0),y(this,"stats",void 0),y(this,"viewState",void 0),y(this,"cursorState",void 0),y(this,"_needsRedraw",void 0),y(this,"_pickRequest",void 0),y(this,"_lastPointerDownInfo",null),y(this,"_metricsCounter",void 0),y(this,"_onPointerMove",t=>{let{_pickRequest:i}=this;if(t.type==="pointerleave")i.x=-1,i.y=-1,i.radius=0;else{if(t.leftButton||t.rightButton)return;{let n=t.offsetCenter;if(!n)return;i.x=n.x,i.y=n.y,i.radius=this.props.pickingRadius}}this.layerManager&&(this.layerManager.context.mousePosition={x:i.x,y:i.y}),i.event=t}),y(this,"_onEvent",t=>{let i=mx[t.type],n=t.offsetCenter;if(!i||!n||!this.layerManager)return;let o=this.layerManager.getLayers(),a=this.deckPicker.getLastPickedObject({x:n.x,y:n.y,layers:o,viewports:this.getViewports(n)},this._lastPointerDownInfo),{layer:l}=a,u=l&&(l[i.handler]||l.props[i.handler]),c=this.props[i.handler],h=!1;u&&(h=u.call(l,a,t)),!h&&c&&c(a,t)}),y(this,"_onPointerDown",t=>{let i=t.offsetCenter,n=this._pick("pickObject","pickObject Time",{x:i.x,y:i.y,radius:this.props.pickingRadius});this._lastPointerDownInfo=n.result[0]||n.emptyInfo}),this.props={...ML,...e},e=this.props,this._needsRedraw="Initial render",this._pickRequest={mode:"hover",x:-1,y:-1,radius:0,event:null},this.cursorState={isHovering:!1,isDragging:!1},e.viewState&&e.initialViewState&&fe.warn("View state tracking is disabled. Use either `initialViewState` for auto update or `viewState` for manual update.")(),ph()==="IE"&&fe.warn("IE 11 is not supported")(),this.viewState=e.initialViewState,e.gl||typeof document<"u"&&(this.canvas=this._createCanvas(e)),this.animationLoop=this._createAnimationLoop(e),this.stats=new en({id:"deck.gl"}),this.metrics={fps:0,setPropsTime:0,updateAttributesTime:0,framesRedrawn:0,pickTime:0,pickCount:0,gpuTime:0,gpuTimePerFrame:0,cpuTime:0,cpuTimePerFrame:0,bufferMemory:0,textureMemory:0,renderbufferMemory:0,gpuMemory:0},this._metricsCounter=0,this.setProps(e),e._typedArrayManagerProps&&go.setOptions(e._typedArrayManagerProps),this.animationLoop.start()}finalize(){var e,t,i,n,o,a,l;if(this.animationLoop.stop(),this.animationLoop=null,this._lastPointerDownInfo=null,(e=this.layerManager)===null||e===void 0||e.finalize(),this.layerManager=null,(t=this.viewManager)===null||t===void 0||t.finalize(),this.viewManager=null,(i=this.effectManager)===null||i===void 0||i.finalize(),this.effectManager=null,(n=this.deckRenderer)===null||n===void 0||n.finalize(),this.deckRenderer=null,(o=this.deckPicker)===null||o===void 0||o.finalize(),this.deckPicker=null,(a=this.eventManager)===null||a===void 0||a.destroy(),this.eventManager=null,(l=this.tooltip)===null||l===void 0||l.remove(),this.tooltip=null,!this.props.canvas&&!this.props.gl&&this.canvas){var u;(u=this.canvas.parentElement)===null||u===void 0||u.removeChild(this.canvas),this.canvas=null}}setProps(e){this.stats.get("setProps Time").timeStart(),"onLayerHover"in e&&fe.removed("onLayerHover","onHover")(),"onLayerClick"in e&&fe.removed("onLayerClick","onClick")(),e.initialViewState&&!an(this.props.initialViewState,e.initialViewState)&&(this.viewState=e.initialViewState),Object.assign(this.props,e),this._setCanvasSize(this.props);let t=Object.create(this.props);Object.assign(t,{views:this._getViews(),width:this.width,height:this.height,viewState:this._getViewState()}),this.animationLoop.setProps(t),this.layerManager&&(this.viewManager.setProps(t),this.layerManager.activateViewport(this.getViewports()[0]),this.layerManager.setProps(t),this.effectManager.setProps(t),this.deckRenderer.setProps(t),this.deckPicker.setProps(t)),this.stats.get("setProps Time").timeEnd()}needsRedraw(e={clearRedrawFlags:!1}){if(!this.layerManager)return!1;if(this.props._animate)return"Deck._animate";let t=this._needsRedraw;e.clearRedrawFlags&&(this._needsRedraw=!1);let i=this.viewManager.needsRedraw(e),n=this.layerManager.needsRedraw(e),o=this.effectManager.needsRedraw(e),a=this.deckRenderer.needsRedraw(e);return t=t||i||n||o||a,t}redraw(e){if(!this.layerManager)return;let t=this.needsRedraw({clearRedrawFlags:!0});t=e||t,t&&(this.stats.get("Redraw Count").incrementCount(),this.props._customRender?this.props._customRender(t):this._drawLayers(t))}get isInitialized(){return this.viewManager!==null}getViews(){return mt(this.viewManager),this.viewManager.views}getViewports(e){return mt(this.viewManager),this.viewManager.getViewports(e)}pickObject(e){let t=this._pick("pickObject","pickObject Time",e).result;return t.length?t[0]:null}pickMultipleObjects(e){return e.depth=e.depth||10,this._pick("pickObject","pickMultipleObjects Time",e).result}pickObjects(e){return this._pick("pickObjects","pickObjects Time",e)}_addResources(e,t=!1){for(let i in e)this.layerManager.resourceManager.add({resourceId:i,data:e[i],forceUpdate:t})}_removeResources(e){for(let t of e)this.layerManager.resourceManager.remove(t)}_pick(e,t,i){mt(this.deckPicker);let{stats:n}=this;n.get("Pick Count").incrementCount(),n.get(t).timeStart();let o=this.deckPicker[e]({layers:this.layerManager.getLayers(i),views:this.viewManager.getViews(),viewports:this.getViewports(i),onViewportActive:this.layerManager.activateViewport,effects:this.effectManager.getEffects(),...i});return n.get(t).timeEnd(),o}_createCanvas(e){let t=e.canvas;return typeof t=="string"&&(t=document.getElementById(t),mt(t)),t||(t=document.createElement("canvas"),t.id=e.id||"deckgl-overlay",(e.parent||document.body).appendChild(t)),Object.assign(t.style,e.style),t}_setCanvasSize(e){if(!this.canvas)return;let{width:t,height:i}=e;if(t||t===0){let o=Number.isFinite(t)?"".concat(t,"px"):t;this.canvas.style.width=o}if(i||i===0){var n;let o=Number.isFinite(i)?"".concat(i,"px"):i;this.canvas.style.position=((n=e.style)===null||n===void 0?void 0:n.position)||"absolute",this.canvas.style.height=o}}_updateCanvasSize(){let{canvas:e}=this;if(!e)return;let t=e.clientWidth||e.width,i=e.clientHeight||e.height;if(t!==this.width||i!==this.height){var n;this.width=t,this.height=i,(n=this.viewManager)===null||n===void 0||n.setProps({width:t,height:i}),this.props.onResize({width:t,height:i})}}_createAnimationLoop(e){let{width:t,height:i,gl:n,glOptions:o,debug:a,onError:l,onBeforeRender:u,onAfterRender:c,useDevicePixels:h}=e;return new Ou({width:t,height:i,useDevicePixels:h,autoResizeViewport:!1,gl:n,onCreateContext:d=>yh({...o,...d,canvas:this.canvas,debug:a,onContextLost:()=>this._onContextLost()}),onInitialize:d=>this._setGLContext(d.gl),onRender:this._onRenderFrame.bind(this),onBeforeRender:u,onAfterRender:c,onError:l})}_getViewState(){return this.props.viewState||this.viewState}_getViews(){let e=this.props.views||[new qh({id:"default-view"})];return e=Array.isArray(e)?e:[e],e.length&&this.props.controller&&(e[0].props.controller=this.props.controller),e}_onContextLost(){let{onError:e}=this.props;this.animationLoop&&e&&e(new Error("WebGL context is lost"))}_pickAndCallback(){let{_pickRequest:e}=this;if(e.event){let{result:i,emptyInfo:n}=this._pick("pickObject","pickObject Time",e);this.cursorState.isHovering=i.length>0;let o=n,a=!1;for(let l of i){var t;o=l,a=((t=l.layer)===null||t===void 0?void 0:t.onHover(l,e.event))||a}if(!a&&this.props.onHover&&this.props.onHover(o,e.event),this.props.getTooltip&&this.tooltip){let l=this.props.getTooltip(o);this.tooltip.setTooltip(l,o.x,o.y)}e.event=null}}_updateCursor(){let e=this.props.parent||this.canvas;e&&(e.style.cursor=this.props.getCursor(this.cursorState))}_setGLContext(e){if(this.layerManager)return;this.canvas||(this.canvas=e.canvas,Cu(e,{enable:!0,copyState:!0})),this.tooltip=new _g(this.canvas),yi(e,{blend:!0,blendFunc:[770,771,1,771],polygonOffsetFill:!0,depthTest:!0,depthFunc:515}),this.props.onWebGLInitialized(e);let t=new dl;t.play(),this.animationLoop.attachTimeline(t),this.eventManager=new Yh(this.props.parent||e.canvas,{touchAction:this.props.touchAction,recognizerOptions:this.props.eventRecognizerOptions,events:{pointerdown:this._onPointerDown,pointermove:this._onPointerMove,pointerleave:this._onPointerMove}});for(let n in mx)this.eventManager.on(n,this._onEvent);this.viewManager=new Sg({timeline:t,eventManager:this.eventManager,onViewStateChange:this._onViewStateChange.bind(this),onInteractionStateChange:this._onInteractionStateChange.bind(this),views:this._getViews(),viewState:this._getViewState(),width:this.width,height:this.height});let i=this.viewManager.getViewports()[0];this.layerManager=new yg(e,{deck:this,stats:this.stats,viewport:i,timeline:t}),this.effectManager=new wg,this.deckRenderer=new Rg(e),this.deckPicker=new Og(e),this.setProps(this.props),this._updateCanvasSize(),this.props.onLoad()}_drawLayers(e,t){let{gl:i}=this.layerManager.context;yi(i,this.props.parameters),this.props.onBeforeRender({gl:i}),this.deckRenderer.renderLayers({target:this.props._framebuffer,layers:this.layerManager.getLayers(),viewports:this.viewManager.getViewports(),onViewportActive:this.layerManager.activateViewport,views:this.viewManager.getViews(),pass:"screen",redrawReason:e,effects:this.effectManager.getEffects(),...t}),this.props.onAfterRender({gl:i})}_onRenderFrame(e){this._getFrameStats(),this._metricsCounter++%60===0&&(this._getMetrics(),this.stats.reset(),fe.table(4,this.metrics)(),this.props._onMetrics&&this.props._onMetrics(this.metrics)),this._updateCanvasSize(),this._updateCursor(),this.tooltip.isVisible&&this.viewManager.needsRedraw()&&this.tooltip.setTooltip(null),this.layerManager.updateLayers(),this._pickAndCallback(),this.redraw(),this.viewManager&&this.viewManager.updateViewStates()}_onViewStateChange(e){let t=this.props.onViewStateChange(e)||e.viewState;this.viewState&&(this.viewState={...this.viewState,[e.viewId]:t},this.props.viewState||this.viewManager&&this.viewManager.setProps({viewState:this.viewState}))}_onInteractionStateChange(e){this.cursorState.isDragging=e.isDragging||!1,this.props.onInteractionStateChange(e)}_getFrameStats(){let{stats:e}=this;e.get("frameRate").timeEnd(),e.get("frameRate").timeStart();let t=this.animationLoop.stats;e.get("GPU Time").addTime(t.get("GPU Time").lastTiming),e.get("CPU Time").addTime(t.get("CPU Time").lastTiming)}_getMetrics(){let{metrics:e,stats:t}=this;e.fps=t.get("frameRate").getHz(),e.setPropsTime=t.get("setProps Time").time,e.updateAttributesTime=t.get("Update Attributes").time,e.framesRedrawn=t.get("Redraw Count").count,e.pickTime=t.get("pickObject Time").time+t.get("pickMultipleObjects Time").time+t.get("pickObjects Time").time,e.pickCount=t.get("Pick Count").count,e.gpuTime=t.get("GPU Time").time,e.cpuTime=t.get("CPU Time").time,e.gpuTimePerFrame=t.get("GPU Time").getAverageTime(),e.cpuTimePerFrame=t.get("CPU Time").getAverageTime();let i=On.get("Memory Usage");e.bufferMemory=i.get("Buffer Memory").count,e.textureMemory=i.get("Texture Memory").count,e.renderbufferMemory=i.get("Renderbuffer Memory").count,e.gpuMemory=i.get("GPU Memory").count}};y(ml,"defaultProps",ML);y(ml,"VERSION",fT.VERSION);var Zu=class{constructor(e,t){y(this,"opts",void 0),y(this,"source",void 0),this.opts=t,this.source=e}get value(){return this.source.value}getValue(){let e=this.source.getBuffer(),t=this.getAccessor();if(e)return[e,t];let{value:i}=this.source,{size:n}=t,o=i;if(i&&i.length!==n){o=new Float32Array(n);let a=t.elementOffset||0;for(let l=0;l<n;++l)o[l]=i[a+l]}return o}getAccessor(){return{...this.source.getAccessor(),...this.opts}}};function BL(s){switch(s){case 5126:return Float32Array;case 5130:return Float64Array;case 5123:case 33635:case 32819:case 32820:return Uint16Array;case 5125:return Uint32Array;case 5121:return Uint8ClampedArray;case 5120:return Int8Array;case 5122:return Int16Array;case 5124:return Int32Array;default:throw new Error("Unknown GL type")}}function qP(s){return s.stride||s.size*s.bytesPerElement}function DL(s,e){e.offset&&fe.removed("shaderAttribute.offset","vertexOffset, elementOffset")();let t=qP(s),i=e.vertexOffset!==void 0?e.vertexOffset:s.vertexOffset||0,n=e.elementOffset||0,o=i*t+n*s.bytesPerElement+(s.offset||0);return{...e,offset:o,stride:t}}function Y3(s,e){let t=DL(s,e);return{high:t,low:{...t,offset:t.offset+s.size*4}}}var Fg=class{constructor(e,t,i){y(this,"gl",void 0),y(this,"id",void 0),y(this,"size",void 0),y(this,"settings",void 0),y(this,"value",void 0),y(this,"doublePrecision",void 0),y(this,"_buffer",void 0),y(this,"state",void 0),this.gl=e,this.id=t.id||"",this.size=t.size||1;let n=t.logicalType||t.type,o=n===5130,{defaultValue:a}=t;a=Number.isFinite(a)?[a]:a||new Array(this.size).fill(0);let l;o?l=5126:!n&&t.isIndexed?l=e&&Yf(e,et.ELEMENT_INDEX_UINT32)?5125:5123:l=n||5126;let u=BL(n||l||5126);this.doublePrecision=o,o&&t.fp64===!1&&(u=Float32Array),this.value=null,this.settings={...t,defaultType:u,defaultValue:a,logicalType:n,type:l,size:this.size,bytesPerElement:u.BYTES_PER_ELEMENT},this.state={...i,externalBuffer:null,bufferAccessor:this.settings,allocatedValue:null,numInstances:0,bounds:null,constant:!1},this._buffer=null}get isConstant(){return this.state.constant}get buffer(){if(!this._buffer){let{isIndexed:e,type:t}=this.settings;this._buffer=new ye(this.gl,{id:this.id,target:e?34963:34962,accessor:{type:t}})}return this._buffer}get byteOffset(){let e=this.getAccessor();return e.vertexOffset?e.vertexOffset*qP(e):0}get numInstances(){return this.state.numInstances}set numInstances(e){this.state.numInstances=e}delete(){this._buffer&&(this._buffer.delete(),this._buffer=null),go.release(this.state.allocatedValue)}getShaderAttributes(e,t){if(this.doublePrecision){let i={},n=this.value instanceof Float64Array,o=Y3(this.getAccessor(),t||{});return i[e]=new Zu(this,o.high),i["".concat(e,"64Low")]=n?new Zu(this,o.low):new Float32Array(this.size),i}if(t){let i=DL(this.getAccessor(),t);return{[e]:new Zu(this,i)}}return{[e]:this}}getBuffer(){return this.state.constant?null:this.state.externalBuffer||this._buffer}getValue(){return this.state.constant?this.value:[this.getBuffer(),this.getAccessor()]}getAccessor(){return this.state.bufferAccessor}getBounds(){if(this.state.bounds)return this.state.bounds;let e=null;if(this.state.constant&&this.value){let t=Array.from(this.value);e=[t,t]}else{let{value:t,numInstances:i,size:n}=this,o=i*n;if(t&&o&&t.length>=o){let a=new Array(n).fill(1/0),l=new Array(n).fill(-1/0);for(let u=0;u<o;)for(let c=0;c<n;c++){let h=t[u++];h<a[c]&&(a[c]=h),h>l[c]&&(l[c]=h)}e=[a,l]}}return this.state.bounds=e,e}setData(e){let{state:t}=this,i;ArrayBuffer.isView(e)?i={value:e}:e instanceof ye?i={buffer:e}:i=e;let n={...this.settings,...i};if(t.bufferAccessor=n,t.bounds=null,i.constant){let o=i.value;if(o=this._normalizeValue(o,[],0),this.settings.normalized&&(o=this.normalizeConstant(o)),!(!t.constant||!this._areValuesEqual(o,this.value)))return!1;t.externalBuffer=null,t.constant=!0,this.value=o}else if(i.buffer){let o=i.buffer;t.externalBuffer=o,t.constant=!1,this.value=i.value||null;let a=i.value instanceof Float64Array;n.type=i.type||o.accessor.type,n.bytesPerElement=o.accessor.BYTES_PER_ELEMENT*(a?2:1),n.stride=qP(n)}else if(i.value){this._checkExternalBuffer(i);let o=i.value;t.externalBuffer=null,t.constant=!1,this.value=o,n.bytesPerElement=o.BYTES_PER_ELEMENT,n.stride=qP(n);let{buffer:a,byteOffset:l}=this;this.doublePrecision&&o instanceof Float64Array&&(o=UP(o,n));let u=o.byteLength+l+n.stride*2;a.byteLength<u&&a.reallocate(u),a.setAccessor(null),a.subData({data:o,offset:l}),n.type=i.type||a.accessor.type}return!0}updateSubBuffer(e={}){this.state.bounds=null;let t=this.value,{startOffset:i=0,endOffset:n}=e;this.buffer.subData({data:this.doublePrecision&&t instanceof Float64Array?UP(t,{size:this.size,startIndex:i,endIndex:n}):t.subarray(i,n),offset:i*t.BYTES_PER_ELEMENT+this.byteOffset})}allocate(e,t=!1){let{state:i}=this,n=i.allocatedValue,o=go.allocate(n,e+1,{size:this.size,type:this.settings.defaultType,copy:t});this.value=o;let{buffer:a,byteOffset:l}=this;return a.byteLength<o.byteLength+l&&(a.reallocate(o.byteLength+l),t&&n&&a.subData({data:n instanceof Float64Array?UP(n,this):n,offset:l})),i.allocatedValue=o,i.constant=!1,i.externalBuffer=null,i.bufferAccessor=this.settings,!0}_checkExternalBuffer(e){let{value:t}=e;if(!ArrayBuffer.isView(t))throw new Error("Attribute ".concat(this.id," value is not TypedArray"));let i=this.settings.defaultType,n=!1;if(this.doublePrecision&&(n=t.BYTES_PER_ELEMENT<4),n)throw new Error("Attribute ".concat(this.id," does not support ").concat(t.constructor.name));!(t instanceof i)&&this.settings.normalized&&!("normalized"in e)&&fe.warn("Attribute ".concat(this.id," is normalized"))()}normalizeConstant(e){switch(this.settings.type){case 5120:return new Float32Array(e).map(t=>(t+128)/255*2-1);case 5122:return new Float32Array(e).map(t=>(t+32768)/65535*2-1);case 5121:return new Float32Array(e).map(t=>t/255);case 5123:return new Float32Array(e).map(t=>t/65535);default:return e}}_normalizeValue(e,t,i){let{defaultValue:n,size:o}=this.settings;if(Number.isFinite(e))return t[i]=e,t;if(!e)return t[i]=n[0],t;switch(o){case 4:t[i+3]=Number.isFinite(e[3])?e[3]:n[3];case 3:t[i+2]=Number.isFinite(e[2])?e[2]:n[2];case 2:t[i+1]=Number.isFinite(e[1])?e[1]:n[1];case 1:t[i+0]=Number.isFinite(e[0])?e[0]:n[0];break;default:let a=o;for(;--a>=0;)t[i+a]=Number.isFinite(e[a])?e[a]:n[a]}return t}_areValuesEqual(e,t){if(!e||!t)return!1;let{size:i}=this;for(let n=0;n<i;n++)if(e[n]!==t[n])return!1;return!0}};var GL=[],FL=[];function Po(s,e=0,t=1/0){let i=GL,n={index:-1,data:s,target:[]};return s?typeof s[Symbol.iterator]=="function"?i=s:s.length>0&&(FL.length=s.length,i=FL):i=GL,(e>0||Number.isFinite(t))&&(i=(Array.isArray(i)?i:Array.from(i)).slice(e,t),n.index=e-1),{iterable:i,objectInfo:n}}function XP(s){return s&&s[Symbol.asyncIterator]}function YP(s,e){let{size:t,stride:i,offset:n,startIndices:o,nested:a}=e,l=s.BYTES_PER_ELEMENT,u=i?i/l:t,c=n?n/l:0,h=Math.floor((s.length-c)/u);return(d,{index:f,target:p})=>{if(!o){let O=f*u+c;for(let B=0;B<t;B++)p[B]=s[O+B];return p}let S=o[f],E=o[f+1]||h,C;if(a){C=new Array(E-S);for(let O=S;O<E;O++){let B=O*u+c;p=new Array(t);for(let A=0;A<t;A++)p[A]=s[B+A];C[O-S]=p}}else if(u===t)C=s.subarray(S*t+c,E*t+c);else{C=new s.constructor((E-S)*t);let O=0;for(let B=S;B<E;B++){let A=B*u+c;for(let N=0;N<t;N++)C[O++]=s[A+N]}}return C}}var kL=[],kg=[[0,1/0]];function VL(s,e){if(s===kg||(e[0]<0&&(e[0]=0),e[0]>=e[1]))return s;let t=[],i=s.length,n=0;for(let o=0;o<i;o++){let a=s[o];a[1]<e[0]?(t.push(a),n=o+1):a[0]>e[1]?t.push(a):e=[Math.min(a[0],e[0]),Math.max(a[1],e[1])]}return t.splice(n,0,e),t}function Gx(s){let{source:e,target:t,start:i=0,size:n,getData:o}=s,a=s.end||t.length,l=e.length,u=a-i;if(l>u){t.set(e.subarray(0,u),i);return}if(t.set(e,i),!o)return;let c=l;for(;c<u;){let h=o(c,e);for(let d=0;d<n;d++)t[i+c]=h[d]||0,c++}}function UL({source:s,target:e,size:t,getData:i,sourceStartIndices:n,targetStartIndices:o}){if(!Array.isArray(o))return Gx({source:s,target:e,size:t,getData:i}),e;let a=0,l=0,u=i&&((h,d)=>i(h+l,d)),c=Math.min(n.length,o.length);for(let h=1;h<c;h++){let d=n[h]*t,f=o[h]*t;Gx({source:s.subarray(a,d),target:e,start:l,end:f,size:t,getData:u}),a=d,l=f}return l<e.length&&Gx({source:[],target:e,start:l,size:t,getData:u}),e}var Z3={interpolation:{duration:0,easing:s=>s},spring:{stiffness:.05,damping:.5}};function KP(s,e){if(!s)return null;Number.isFinite(s)&&(s={type:"interpolation",duration:s});let t=s.type||"interpolation";return{...Z3[t],...e,...s,type:t}}function ZP(s,e){let t=e.getBuffer();return t?[t,{divisor:0,size:e.size,normalized:e.settings.normalized}]:e.value}function QP(s){switch(s){case 1:return"float";case 2:return"vec2";case 3:return"vec3";case 4:return"vec4";default:throw new Error('No defined attribute type for size "'.concat(s,'"'))}}function JP(s){s.push(s.shift())}function Vg(s,e){let{doublePrecision:t,settings:i,value:n,size:o}=s,a=t&&n instanceof Float64Array?2:1;return(i.noAlloc?n.length:e*o)*a}function $P({buffer:s,numInstances:e,attribute:t,fromLength:i,fromStartIndices:n,getData:o=a=>a}){let a=t.doublePrecision&&t.value instanceof Float64Array?2:1,l=t.size*a,u=t.byteOffset,c=t.startIndices,h=n&&c,d=Vg(t,e),f=t.isConstant;if(!h&&i>=d)return;let p=f?t.value:t.getBuffer().getData({srcByteOffset:u});if(t.settings.normalized&&!f){let O=o;o=(B,A)=>t.normalizeConstant(O(B,A))}let S=f?(O,B)=>o(p,B):(O,B)=>o(p.subarray(O,O+l),B),E=s.getData({length:i}),C=new Float32Array(d);UL({source:E,target:C,sourceStartIndices:n,targetStartIndices:c,size:l,getData:S}),s.byteLength<C.byteLength+u&&s.reallocate(C.byteLength+u),s.subData({data:C,offset:u})}var Js=class extends Fg{constructor(e,t){super(e,t,{startIndices:null,lastExternalBuffer:null,binaryValue:null,binaryAccessor:null,needsUpdate:!0,needsRedraw:!1,updateRanges:kg}),y(this,"constant",!1),this.settings.update=t.update||(t.accessor?this._autoUpdater:void 0),Object.seal(this.settings),Object.seal(this.state),this._validateAttributeUpdaters()}get startIndices(){return this.state.startIndices}set startIndices(e){this.state.startIndices=e}needsUpdate(){return this.state.needsUpdate}needsRedraw({clearChangedFlags:e=!1}={}){let t=this.state.needsRedraw;return this.state.needsRedraw=t&&!e,t}getUpdateTriggers(){let{accessor:e}=this.settings;return[this.id].concat(typeof e!="function"&&e||[])}supportsTransition(){return Boolean(this.settings.transition)}getTransitionSetting(e){if(!e||!this.supportsTransition())return null;let{accessor:t}=this.settings,i=this.settings.transition,n=Array.isArray(t)?e[t.find(o=>e[o])]:e[t];return KP(n,i)}setNeedsUpdate(e=this.id,t){if(this.state.needsUpdate=this.state.needsUpdate||e,this.setNeedsRedraw(e),t){let{startRow:i=0,endRow:n=1/0}=t;this.state.updateRanges=VL(this.state.updateRanges,[i,n])}else this.state.updateRanges=kg}clearNeedsUpdate(){this.state.needsUpdate=!1,this.state.updateRanges=kL}setNeedsRedraw(e=this.id){this.state.needsRedraw=this.state.needsRedraw||e}allocate(e){let{state:t,settings:i}=this;return i.noAlloc?!1:i.update?(super.allocate(e,t.updateRanges!==kg),!0):!1}updateBuffer({numInstances:e,data:t,props:i,context:n}){if(!this.needsUpdate())return!1;let{state:{updateRanges:o},settings:{update:a,noAlloc:l}}=this,u=!0;if(a){for(let[c,h]of o)a.call(n,this,{data:t,startRow:c,endRow:h,props:i,numInstances:e});if(this.value)if(this.constant||this.buffer.byteLength<this.value.byteLength+this.byteOffset)this.setData({value:this.value,constant:this.constant}),this.constant=!1;else for(let[c,h]of o){let d=Number.isFinite(c)?this.getVertexOffset(c):0,f=Number.isFinite(h)?this.getVertexOffset(h):l||!Number.isFinite(e)?this.value.length:e*this.size;super.updateSubBuffer({startOffset:d,endOffset:f})}this._checkAttributeArray()}else u=!1;return this.clearNeedsUpdate(),this.setNeedsRedraw(),u}setConstantValue(e){return e===void 0||typeof e=="function"?!1:(this.setData({constant:!0,value:e})&&this.setNeedsRedraw(),this.clearNeedsUpdate(),!0)}setExternalBuffer(e){let{state:t}=this;return e?(this.clearNeedsUpdate(),t.lastExternalBuffer===e||(t.lastExternalBuffer=e,this.setNeedsRedraw(),this.setData(e)),!0):(t.lastExternalBuffer=null,!1)}setBinaryValue(e,t=null){let{state:i,settings:n}=this;if(!e)return i.binaryValue=null,i.binaryAccessor=null,!1;if(n.noAlloc)return!1;if(i.binaryValue===e)return this.clearNeedsUpdate(),!0;if(i.binaryValue=e,this.setNeedsRedraw(),n.transform||t!==this.startIndices){ArrayBuffer.isView(e)&&(e={value:e});let a=e;mt(ArrayBuffer.isView(a.value),"invalid ".concat(n.accessor));let l=Boolean(a.size)&&a.size!==this.size;return i.binaryAccessor=YP(a.value,{size:a.size||this.size,stride:a.stride,offset:a.offset,startIndices:t,nested:l}),!1}return this.clearNeedsUpdate(),this.setData(e),!0}getVertexOffset(e){let{startIndices:t}=this;return(t?t[e]:e)*this.size}getShaderAttributes(){let e=this.settings.shaderAttributes||{[this.id]:null},t={};for(let i in e)Object.assign(t,super.getShaderAttributes(i,e[i]));return t}_autoUpdater(e,{data:t,startRow:i,endRow:n,props:o,numInstances:a}){if(e.constant)return;let{settings:l,state:u,value:c,size:h,startIndices:d}=e,{accessor:f,transform:p}=l,S=u.binaryAccessor||(typeof f=="function"?f:o[f]);mt(typeof S=="function",'accessor "'.concat(f,'" is not a function'));let E=e.getVertexOffset(i),{iterable:C,objectInfo:O}=Po(t,i,n);for(let B of C){O.index++;let A=S(B,O);if(p&&(A=p.call(this,A)),d){let N=(O.index<d.length-1?d[O.index+1]:a)-d[O.index];if(A&&Array.isArray(A[0])){let z=E;for(let Y of A)e._normalizeValue(Y,c,z),z+=h}else A&&A.length>h?c.set(A,E):(e._normalizeValue(A,O.target,0),wx({target:c,source:O.target,start:E,count:N}));E+=N*h}else e._normalizeValue(A,c,E),E+=h}}_validateAttributeUpdaters(){let{settings:e}=this;if(!(e.noAlloc||typeof e.update=="function"))throw new Error("Attribute ".concat(this.id," missing update or accessor"))}_checkAttributeArray(){let{value:e}=this,t=Math.min(4,this.size);if(e&&e.length>=t){let i=!0;switch(t){case 4:i=i&&Number.isFinite(e[3]);case 3:i=i&&Number.isFinite(e[2]);case 2:i=i&&Number.isFinite(e[1]);case 1:i=i&&Number.isFinite(e[0]);break;default:i=!1}if(!i)throw new Error("Illegal attribute generated for ".concat(this.id))}}};var Ug=class{constructor({gl:e,attribute:t,timeline:i}){y(this,"gl",void 0),y(this,"type","interpolation"),y(this,"attributeInTransition",void 0),y(this,"settings",void 0),y(this,"attribute",void 0),y(this,"transition",void 0),y(this,"currentStartIndices",void 0),y(this,"currentLength",void 0),y(this,"transform",void 0),y(this,"buffers",void 0),this.gl=e,this.transition=new ln(i),this.attribute=t,this.attributeInTransition=new Js(e,t.settings),this.currentStartIndices=t.startIndices,this.currentLength=0,this.transform=J3(e,t);let n={byteLength:0,usage:35050};this.buffers=[new ye(e,n),new ye(e,n)]}get inProgress(){return this.transition.inProgress}start(e,t){if(e.duration<=0){this.transition.cancel();return}this.settings=e;let{gl:i,buffers:n,attribute:o}=this;JP(n);let a={numInstances:t,attribute:o,fromLength:this.currentLength,fromStartIndices:this.currentStartIndices,getData:e.enter};for(let l of n)$P({buffer:l,...a});this.currentStartIndices=o.startIndices,this.currentLength=Vg(o,t),this.attributeInTransition.setData({buffer:n[1],value:o.value}),this.transition.start(e),this.transform.update({elementCount:Math.floor(this.currentLength/o.size),sourceBuffers:{aFrom:n[0],aTo:ZP(i,o)},feedbackBuffers:{vCurrent:n[1]}})}update(){let e=this.transition.update();if(e){let{duration:t,easing:i}=this.settings,{time:n}=this.transition,o=n/t;i&&(o=i(o)),this.transform.run({uniforms:{time:o}})}return e}cancel(){this.transition.cancel(),this.transform.delete();for(let e of this.buffers)e.delete();this.buffers.length=0}},Q3=`
#define SHADER_NAME interpolation-transition-vertex-shader

uniform float time;
attribute ATTRIBUTE_TYPE aFrom;
attribute ATTRIBUTE_TYPE aTo;
varying ATTRIBUTE_TYPE vCurrent;

void main(void) {
  vCurrent = mix(aFrom, aTo, time);
  gl_Position = vec4(0.0);
}
`;function J3(s,e){let t=QP(e.size);return new on(s,{vs:Q3,defines:{ATTRIBUTE_TYPE:t},varyings:["vCurrent"]})}var zg=class{constructor({gl:e,attribute:t,timeline:i}){y(this,"gl",void 0),y(this,"type","spring"),y(this,"attributeInTransition",void 0),y(this,"settings",void 0),y(this,"attribute",void 0),y(this,"transition",void 0),y(this,"currentStartIndices",void 0),y(this,"currentLength",void 0),y(this,"texture",void 0),y(this,"framebuffer",void 0),y(this,"transform",void 0),y(this,"buffers",void 0),this.gl=e,this.type="spring",this.transition=new ln(i),this.attribute=t,this.attributeInTransition=new Js(e,{...t.settings,normalized:!1}),this.currentStartIndices=t.startIndices,this.currentLength=0,this.texture=e5(e),this.framebuffer=t5(e,this.texture),this.transform=$3(e,t,this.framebuffer);let n={byteLength:0,usage:35050};this.buffers=[new ye(e,n),new ye(e,n),new ye(e,n)]}get inProgress(){return this.transition.inProgress}start(e,t){let{gl:i,buffers:n,attribute:o}=this,a={numInstances:t,attribute:o,fromLength:this.currentLength,fromStartIndices:this.currentStartIndices,getData:e.enter};for(let l of n)$P({buffer:l,...a});this.settings=e,this.currentStartIndices=o.startIndices,this.currentLength=Vg(o,t),this.attributeInTransition.setData({buffer:n[1],value:o.value}),this.transition.start({...e,duration:1/0}),this.transform.update({elementCount:Math.floor(this.currentLength/o.size),sourceBuffers:{aTo:ZP(i,o)}})}update(){let{buffers:e,transform:t,framebuffer:i,transition:n}=this;if(!n.update())return!1;let a=this.settings;return t.update({sourceBuffers:{aPrev:e[0],aCur:e[1]},feedbackBuffers:{vNext:e[2]}}),t.run({framebuffer:i,discard:!1,clearRenderTarget:!0,uniforms:{stiffness:a.stiffness,damping:a.damping},parameters:{depthTest:!1,blend:!0,viewport:[0,0,1,1],blendFunc:[1,1],blendEquation:[32776,32776]}}),JP(e),this.attributeInTransition.setData({buffer:e[1],value:this.attribute.value}),Us(i)[0]>0||n.end(),!0}cancel(){this.transition.cancel(),this.transform.delete();for(let e of this.buffers)e.delete();this.buffers.length=0,this.texture.delete(),this.framebuffer.delete()}};function $3(s,e,t){let i=QP(e.size);return new on(s,{framebuffer:t,vs:`
#define SHADER_NAME spring-transition-vertex-shader

#define EPSILON 0.00001

uniform float stiffness;
uniform float damping;
attribute ATTRIBUTE_TYPE aPrev;
attribute ATTRIBUTE_TYPE aCur;
attribute ATTRIBUTE_TYPE aTo;
varying ATTRIBUTE_TYPE vNext;
varying float vIsTransitioningFlag;

ATTRIBUTE_TYPE getNextValue(ATTRIBUTE_TYPE cur, ATTRIBUTE_TYPE prev, ATTRIBUTE_TYPE dest) {
  ATTRIBUTE_TYPE velocity = cur - prev;
  ATTRIBUTE_TYPE delta = dest - cur;
  ATTRIBUTE_TYPE spring = delta * stiffness;
  ATTRIBUTE_TYPE damper = velocity * -1.0 * damping;
  return spring + damper + velocity + cur;
}

void main(void) {
  bool isTransitioning = length(aCur - aPrev) > EPSILON || length(aTo - aCur) > EPSILON;
  vIsTransitioningFlag = isTransitioning ? 1.0 : 0.0;

  vNext = getNextValue(aCur, aPrev, aTo);
  gl_Position = vec4(0, 0, 0, 1);
  gl_PointSize = 100.0;
}
`,fs:`
#define SHADER_NAME spring-transition-is-transitioning-fragment-shader

varying float vIsTransitioningFlag;

void main(void) {
  if (vIsTransitioningFlag == 0.0) {
    discard;
  }
  gl_FragColor = vec4(1.0);
}`,defines:{ATTRIBUTE_TYPE:i},varyings:["vNext"]})}function e5(s){return new Ue(s,{data:new Uint8Array(4),format:6408,type:5121,border:0,mipmaps:!1,dataFormat:6408,width:1,height:1})}function t5(s,e){return new De(s,{id:"spring-transition-is-transitioning-framebuffer",width:1,height:1,attachments:{[36064]:e}})}var r5={interpolation:Ug,spring:zg},Wg=class{constructor(e,{id:t,timeline:i}){y(this,"id",void 0),y(this,"isSupported",void 0),y(this,"gl",void 0),y(this,"timeline",void 0),y(this,"transitions",void 0),y(this,"needsRedraw",void 0),y(this,"numInstances",void 0),this.id=t,this.gl=e,this.timeline=i,this.transitions={},this.needsRedraw=!1,this.numInstances=1,this.isSupported=on.isSupported(e)}finalize(){for(let e in this.transitions)this._removeTransition(e)}update({attributes:e,transitions:t,numInstances:i}){this.numInstances=i||1;for(let n in e){let o=e[n],a=o.getTransitionSetting(t);!a||this._updateAttribute(n,o,a)}for(let n in this.transitions){let o=e[n];(!o||!o.getTransitionSetting(t))&&this._removeTransition(n)}}hasAttribute(e){let t=this.transitions[e];return t&&t.inProgress}getAttributes(){let e={};for(let t in this.transitions){let i=this.transitions[t];i.inProgress&&(e[t]=i.attributeInTransition)}return e}run(){if(!this.isSupported||this.numInstances===0)return!1;for(let t in this.transitions)this.transitions[t].update()&&(this.needsRedraw=!0);let e=this.needsRedraw;return this.needsRedraw=!1,e}_removeTransition(e){this.transitions[e].cancel(),delete this.transitions[e]}_updateAttribute(e,t,i){let n=this.transitions[e],o=!n||n.type!==i.type;if(o){if(!this.isSupported){fe.warn("WebGL2 not supported by this browser. Transition for ".concat(e," is disabled."))();return}n&&this._removeTransition(e);let a=r5[i.type];a?this.transitions[e]=new a({attribute:t,timeline:this.timeline,gl:this.gl}):(fe.error("unsupported transition type '".concat(i.type,"'"))(),o=!1)}(o||t.needsRedraw())&&(this.needsRedraw=!0,this.transitions[e].start(i,this.numInstances))}};var zL="attributeManager.invalidate",i5="attributeManager.updateStart",n5="attributeManager.updateEnd",o5="attribute.updateStart",s5="attribute.allocate",a5="attribute.updateEnd",Hg=class{constructor(e,{id:t="attribute-manager",stats:i,timeline:n}={}){y(this,"id",void 0),y(this,"gl",void 0),y(this,"attributes",void 0),y(this,"updateTriggers",void 0),y(this,"needsRedraw",void 0),y(this,"userData",void 0),y(this,"stats",void 0),y(this,"attributeTransitionManager",void 0),this.id=t,this.gl=e,this.attributes={},this.updateTriggers={},this.needsRedraw=!0,this.userData={},this.stats=i,this.attributeTransitionManager=new Wg(e,{id:"".concat(t,"-transitions"),timeline:n}),Object.seal(this)}finalize(){for(let e in this.attributes)this.attributes[e].delete();this.attributeTransitionManager.finalize()}getNeedsRedraw(e={clearRedrawFlags:!1}){let t=this.needsRedraw;return this.needsRedraw=this.needsRedraw&&!e.clearRedrawFlags,t&&this.id}setNeedsRedraw(){this.needsRedraw=!0}add(e){this._add(e)}addInstanced(e){this._add(e,{instanced:1})}remove(e){for(let t of e)this.attributes[t]!==void 0&&(this.attributes[t].delete(),delete this.attributes[t])}invalidate(e,t){let i=this._invalidateTrigger(e,t);Gt(zL,this,e,i)}invalidateAll(e){for(let t in this.attributes)this.attributes[t].setNeedsUpdate(t,e);Gt(zL,this,"all")}update({data:e,numInstances:t,startIndices:i=null,transitions:n,props:o={},buffers:a={},context:l={}}){let u=!1;Gt(i5,this),this.stats&&this.stats.get("Update Attributes").timeStart();for(let c in this.attributes){let h=this.attributes[c],d=h.settings.accessor;h.startIndices=i,h.numInstances=t,o[c]&&fe.removed("props.".concat(c),"data.attributes.".concat(c))(),h.setExternalBuffer(a[c])||h.setBinaryValue(typeof d=="string"?a[d]:void 0,e.startIndices)||typeof d=="string"&&!a[d]&&h.setConstantValue(o[d])||h.needsUpdate()&&(u=!0,this._updateAttribute({attribute:h,numInstances:t,data:e,props:o,context:l})),this.needsRedraw=this.needsRedraw||h.needsRedraw()}u&&Gt(n5,this,t),this.stats&&this.stats.get("Update Attributes").timeEnd(),this.attributeTransitionManager.update({attributes:this.attributes,numInstances:t,transitions:n})}updateTransition(){let{attributeTransitionManager:e}=this,t=e.run();return this.needsRedraw=this.needsRedraw||t,t}getAttributes(){return this.attributes}getChangedAttributes(e={clearChangedFlags:!1}){let{attributes:t,attributeTransitionManager:i}=this,n={...i.getAttributes()};for(let o in t){let a=t[o];a.needsRedraw(e)&&!i.hasAttribute(o)&&(n[o]=a)}return n}getShaderAttributes(e,t={}){e||(e=this.getAttributes());let i={};for(let n in e)t[n]||Object.assign(i,e[n].getShaderAttributes());return i}_add(e,t={}){for(let i in e){let n=e[i];this.attributes[i]=this._createAttribute(i,n,t)}this._mapUpdateTriggersToAttributes()}_createAttribute(e,t,i){let n={...t,id:e,size:t.isIndexed&&1||t.size||1,divisor:i.instanced?1:t.divisor||0};return new Js(this.gl,n)}_mapUpdateTriggersToAttributes(){let e={};for(let t in this.attributes)this.attributes[t].getUpdateTriggers().forEach(n=>{e[n]||(e[n]=[]),e[n].push(t)});this.updateTriggers=e}_invalidateTrigger(e,t){let{attributes:i,updateTriggers:n}=this,o=n[e];return o&&o.forEach(a=>{let l=i[a];l&&l.setNeedsUpdate(l.id,t)}),o}_updateAttribute(e){let{attribute:t,numInstances:i}=e;if(Gt(o5,t),t.constant){t.setConstantValue(t.value);return}t.allocate(i)&&Gt(s5,t,i),t.updateBuffer(e)&&(this.needsRedraw=!0,Gt(a5,t,i))}};var jg=class extends ln{get value(){return this._value}_onUpdate(){let{time:e,settings:{fromValue:t,toValue:i,duration:n,easing:o}}=this,a=o(e/n);this._value=Nu(t,i,a)}};var WL=1e-5;function HL(s,e,t,i,n){let o=e-s,l=(t-e)*n,u=-o*i;return l+u+o+e}function l5(s,e,t,i,n){if(Array.isArray(t)){let o=[];for(let a=0;a<t.length;a++)o[a]=HL(s[a],e[a],t[a],i,n);return o}return HL(s,e,t,i,n)}function jL(s,e){if(Array.isArray(s)){let t=0;for(let i=0;i<s.length;i++){let n=s[i]-e[i];t+=n*n}return Math.sqrt(t)}return Math.abs(s-e)}var qg=class extends ln{get value(){return this._currValue}_onUpdate(){let{fromValue:e,toValue:t,damping:i,stiffness:n}=this.settings,{_prevValue:o=e,_currValue:a=e}=this,l=l5(o,a,t,i,n),u=jL(l,t),c=jL(l,a);u<WL&&c<WL&&(l=t,this.end()),this._prevValue=a,this._currValue=l}};var u5={interpolation:jg,spring:qg},Xg=class{constructor(e){this.transitions=new Map,this.timeline=e}get active(){return this.transitions.size>0}add(e,t,i,n){let{transitions:o}=this;if(o.has(e)){let u=o.get(e),{value:c=u.settings.fromValue}=u;t=c,this.remove(e)}if(n=KP(n),!n)return;let a=u5[n.type];if(!a){fe.error("unsupported transition type '".concat(n.type,"'"))();return}let l=new a(this.timeline);l.start({...n,fromValue:t,toValue:i}),o.set(e,l)}remove(e){let{transitions:t}=this;t.has(e)&&(t.get(e).cancel(),t.delete(e))}update(){let e={};for(let[t,i]of this.transitions)i.update(),e[t]=i.value,i.inProgress||this.remove(t);return e}clear(){for(let e of this.transitions.keys())this.remove(e)}};function XL(s){let e=kx(s);for(let t in e){let i=e[t],{validate:n}=i;if(n&&!n(s[t],i))throw new Error("Invalid prop ".concat(t,": ").concat(s[t]))}}function YL(s,e){let t=KL({newProps:s,oldProps:e,propTypes:kx(s),ignoreProps:{data:null,updateTriggers:null,extensions:null,transitions:null}}),i=h5(s,e),n=!1;return i||(n=d5(s,e)),{dataChanged:i,propsChanged:t,updateTriggersChanged:n,extensionsChanged:f5(s,e),transitionsChanged:c5(s,e)}}function c5(s,e){if(!s.transitions)return!1;let t={},i=kx(s),n=!1;for(let o in s.transitions){let a=i[o],l=a&&a.type;(l==="number"||l==="color"||l==="array")&&Fx(s[o],e[o],a)&&(t[o]=!0,n=!0)}return n?t:!1}function KL({newProps:s,oldProps:e,ignoreProps:t={},propTypes:i={},triggerName:n="props"}){if(e===s)return!1;if(typeof s!="object"||s===null||typeof e!="object"||e===null)return"".concat(n," changed shallowly");for(let o of Object.keys(s))if(!(o in t)){if(!(o in e))return"".concat(n,".").concat(o," added");let a=Fx(s[o],e[o],i[o]);if(a)return"".concat(n,".").concat(o," ").concat(a)}for(let o of Object.keys(e))if(!(o in t)){if(!(o in s))return"".concat(n,".").concat(o," dropped");if(!Object.hasOwnProperty.call(s,o)){let a=Fx(s[o],e[o],i[o]);if(a)return"".concat(n,".").concat(o," ").concat(a)}}return!1}function Fx(s,e,t){let i=t&&t.equal;return i&&!i(s,e,t)||!i&&(i=s&&e&&s.equals,i&&!i.call(s,e))?"changed deeply":!i&&e!==s?"changed shallowly":null}function h5(s,e){if(e===null)return"oldProps is null, initial diff";let t=!1,{dataComparator:i,_dataDiff:n}=s;return i?i(s.data,e.data)||(t="Data comparator detected a change"):s.data!==e.data&&(t="A new data container was supplied"),t&&n&&(t=n(s.data,e.data)||t),t}function d5(s,e){if(e===null)return{all:!0};if("all"in s.updateTriggers&&qL(s,e,"all"))return{all:!0};let t={},i=!1;for(let n in s.updateTriggers)n!=="all"&&qL(s,e,n)&&(t[n]=!0,i=!0);return i?t:!1}function f5(s,e){if(e===null)return!0;let t=e.extensions,{extensions:i}=s;if(i===t)return!1;if(!t||!i||i.length!==t.length)return!0;for(let n=0;n<i.length;n++)if(!i[n].equals(t[n]))return!0;return!1}function qL(s,e,t){let i=s.updateTriggers[t];i=i??{};let n=e.updateTriggers[t];return n=n??{},KL({oldProps:n,newProps:i,triggerName:t})}function kx(s){let e=s[Hh],t=e&&e.constructor;return t?t._propTypes:{}}var g5="count(): argument not an object",p5="count(): argument not a container";function ZL(s){if(!b5(s))throw new Error(g5);if(typeof s.count=="function")return s.count();if(Number.isFinite(s.size))return s.size;if(Number.isFinite(s.length))return s.length;if(m5(s))return Object.keys(s).length;throw new Error(p5)}function m5(s){return s!==null&&typeof s=="object"&&s.constructor===Object}function b5(s){return s!==null&&typeof s=="object"}function QL(s,e){if(!e)return s;let t={...s,...e};if("defines"in e&&(t.defines={...s.defines,...e.defines}),"modules"in e&&(t.modules=(s.modules||[]).concat(e.modules),e.modules.some(i=>i.name==="project64"))){let i=t.modules.findIndex(n=>n.name==="project32");i>=0&&t.modules.splice(i,1)}if("inject"in e)if(!s.inject)t.inject=e.inject;else{let i={...s.inject};for(let n in e.inject)i[n]=(i[n]||"")+e.inject[n];t.inject=i}return t}var P5={[10241]:9987,[10240]:9729,[10242]:33071,[10243]:33071},Vx={};function JL(s,e){let t=s.context&&s.context.gl;if(!t||!e)return null;if(e instanceof Ue)return e;e.constructor&&e.constructor.name!=="Object"&&(e={data:e});let i=null;e.compressed&&(i={[10241]:e.data.length>1?9985:9729});let n=new Ue(t,{...e,parameters:{...P5,...i,...s.props.textureParameters}});return Vx[n.id]=!0,n}function $L(s){!s||!(s instanceof Ue)||Vx[s.id]&&(s.delete(),delete Vx[s.id])}var y5={boolean:{validate(s,e){return!0},equal(s,e,t){return Boolean(s)===Boolean(e)}},number:{validate(s,e){return Number.isFinite(s)&&(!("max"in e)||s<=e.max)&&(!("min"in e)||s>=e.min)}},color:{validate(s,e){return e.optional&&!s||Kg(s)&&(s.length===3||s.length===4)},equal(s,e,t){return Ux(s,e)}},accessor:{validate(s,e){let t=ey(s);return t==="function"||t===ey(e.value)},equal(s,e,t){return typeof e=="function"?!0:Ux(s,e)}},array:{validate(s,e){return e.optional&&!s||Kg(s)},equal(s,e,t){return t.compare?Ux(s,e):s===e}},object:{equal(s,e,t){return t.compare?an(s,e):s===e}},function:{validate(s,e){return e.optional&&!s||typeof s=="function"},equal(s,e,t){return!t.compare||s===e}},data:{transform:(s,e,t)=>{let{dataTransform:i}=t.props;return i&&s?i(s):s}},image:{transform:(s,e,t)=>JL(t,s),release:s=>{$L(s)}}};function Ux(s,e){if(s===e)return!0;if(!Kg(s)||!Kg(e))return!1;let t=s.length;if(t!==e.length)return!1;for(let i=0;i<t;i++)if(s[i]!==e[i])return!1;return!0}function eR(s){let e={},t={},i={};for(let[n,o]of Object.entries(s)){let a=o?.deprecatedFor;if(a)i[n]=Array.isArray(a)?a:[a];else{let l=S5(n,o);e[n]=l,t[n]=l.value}}return{propTypes:e,defaultProps:t,deprecatedProps:i}}function S5(s,e){switch(ey(e)){case"object":return Yg(s,e);case"array":return Yg(s,{type:"array",value:e,compare:!1});case"boolean":return Yg(s,{type:"boolean",value:e});case"number":return Yg(s,{type:"number",value:e});case"function":return Yg(s,{type:"function",value:e,compare:!0});default:return{name:s,type:"unknown",value:e}}}function Yg(s,e){return"type"in e?{name:s,...y5[e.type],...e}:"value"in e?{name:s,type:ey(e.value),...e}:{name:s,type:"object",value:e}}function Kg(s){return Array.isArray(s)||ArrayBuffer.isView(s)}function ey(s){return Kg(s)?"array":s===null?"null":typeof s}function tR(s,e){let t=rR(s.constructor),i=Object.create(t);i[Hh]=s,i[ns]={},i[po]={};for(let n=0;n<e.length;++n){let o=e[n];for(let a in o)i[a]=o[a]}return Object.freeze(i),i}function rR(s){let e=ty(s,"_mergedDefaultProps");return e||(E5(s),s._mergedDefaultProps)}function E5(s){if(!s.prototype)return;let t=Object.getPrototypeOf(s),i=rR(t),n=ty(s,"defaultProps")||{},o=eR(n),a=x5(o.defaultProps,i,s),l={...t._propTypes,...o.propTypes};C5(a,l);let u={...t._deprecatedProps,...o.deprecatedProps};v5(a,u),s._mergedDefaultProps=a,s._propTypes=l,s._deprecatedProps=u}function x5(s,e,t){let i=Object.create(null);Object.assign(i,e,s);let n=T5(t);return delete s.id,Object.defineProperties(i,{id:{writable:!0,value:n}}),i}function v5(s,e){for(let t in e)Object.defineProperty(s,t,{enumerable:!1,set(i){let n="".concat(this.id,": ").concat(t);for(let o of e[t])iR(this,o)||(this[o]=i);fe.deprecated(n,e[t].join("/"))()}})}function C5(s,e){let t={},i={};for(let n in e){let o=e[n],{name:a,value:l}=o;o.async&&(t[a]=l,i[a]=A5(a))}s[Xs]=t,s[ns]={},Object.defineProperties(s,i)}function A5(s){return{enumerable:!0,set(e){typeof e=="string"||e instanceof Promise||XP(e)?this[ns][s]=e:this[po][s]=e},get(){if(this[po]){if(s in this[po])return this[po][s]||this[Xs][s];if(s in this[ns]){let e=this[Hh]&&this[Hh].internalState;if(e&&e.hasAsyncProp(s))return e.getAsyncProp(s)||this[Xs][s]}}return this[Xs][s]}}}function iR(s,e){return Object.prototype.hasOwnProperty.call(s,e)}function ty(s,e){return iR(s,e)&&s[e]}function T5(s){let e=ty(s,"layerName")||ty(s,"componentName");return e||fe.once(0,"".concat(s.name,".componentName not specified"))(),e||s.name}var I5=0,Qu=class{constructor(...e){y(this,"id",void 0),y(this,"props",void 0),y(this,"count",void 0),this.props=tR(this,e),this.id=this.props.id,this.count=I5++}clone(e){let{props:t}=this,i={};for(let n in t[Xs])n in t[po]?i[n]=t[po][n]:n in t[ns]&&(i[n]=t[ns][n]);return new this.constructor({...t,...i,...e})}};y(Qu,"componentName","Component");y(Qu,"defaultProps",{});var w5=Object.freeze({}),Zg=class{constructor(e){y(this,"component",void 0),y(this,"onAsyncPropUpdated",void 0),y(this,"asyncProps",void 0),y(this,"oldProps",void 0),y(this,"oldAsyncProps",void 0),this.component=e,this.asyncProps={},this.onAsyncPropUpdated=()=>{},this.oldProps=null,this.oldAsyncProps=null}finalize(){for(let e in this.asyncProps){let t=this.asyncProps[e];t&&t.type&&t.type.release&&t.type.release(t.resolvedValue,t.type,this.component)}}getOldProps(){return this.oldAsyncProps||this.oldProps||w5}resetOldProps(){this.oldAsyncProps=null,this.oldProps=this.component.props}hasAsyncProp(e){return e in this.asyncProps}getAsyncProp(e){let t=this.asyncProps[e];return t&&t.resolvedValue}isAsyncPropLoading(e){if(e){let t=this.asyncProps[e];return Boolean(t&&t.pendingLoadCount>0&&t.pendingLoadCount!==t.resolvedLoadCount)}for(let t in this.asyncProps)if(this.isAsyncPropLoading(t))return!0;return!1}reloadAsyncProp(e,t){this._watchPromise(e,Promise.resolve(t))}setAsyncProps(e){let t=e[po]||{},i=e[ns]||e,n=e[Xs]||{};for(let o in t){let a=t[o];this._createAsyncPropData(o,n[o]),this._updateAsyncProp(o,a),t[o]=this.getAsyncProp(o)}for(let o in i){let a=i[o];this._createAsyncPropData(o,n[o]),this._updateAsyncProp(o,a)}}_fetch(e,t){return null}_onResolve(e,t){}_onError(e,t){}_updateAsyncProp(e,t){if(!!this._didAsyncInputValueChange(e,t)){if(typeof t=="string"&&(t=this._fetch(e,t)),t instanceof Promise){this._watchPromise(e,t);return}if(XP(t)){this._resolveAsyncIterable(e,t);return}this._setPropValue(e,t)}}_freezeAsyncOldProps(){if(!this.oldAsyncProps&&this.oldProps){this.oldAsyncProps=Object.create(this.oldProps);for(let e in this.asyncProps)Object.defineProperty(this.oldAsyncProps,e,{enumerable:!0,value:this.oldProps[e]})}}_didAsyncInputValueChange(e,t){let i=this.asyncProps[e];return t===i.resolvedValue||t===i.lastValue?!1:(i.lastValue=t,!0)}_setPropValue(e,t){this._freezeAsyncOldProps();let i=this.asyncProps[e];i&&(t=this._postProcessValue(i,t),i.resolvedValue=t,i.pendingLoadCount++,i.resolvedLoadCount=i.pendingLoadCount)}_setAsyncPropValue(e,t,i){let n=this.asyncProps[e];n&&i>=n.resolvedLoadCount&&t!==void 0&&(this._freezeAsyncOldProps(),n.resolvedValue=t,n.resolvedLoadCount=i,this.onAsyncPropUpdated(e,t))}_watchPromise(e,t){let i=this.asyncProps[e];if(i){i.pendingLoadCount++;let n=i.pendingLoadCount;t.then(o=>{o=this._postProcessValue(i,o),this._setAsyncPropValue(e,o,n),this._onResolve(e,o)}).catch(o=>{this._onError(e,o)})}}async _resolveAsyncIterable(e,t){if(e!=="data"){this._setPropValue(e,t);return}let i=this.asyncProps[e];if(!i)return;i.pendingLoadCount++;let n=i.pendingLoadCount,o=[],a=0;for await(let l of t){let{dataTransform:u}=this.component.props;u?o=u(l,o):o=o.concat(l),Object.defineProperty(o,"__diff",{enumerable:!1,value:[{startRow:a,endRow:o.length}]}),a=o.length,this._setAsyncPropValue(e,o,n)}this._onResolve(e,o)}_postProcessValue(e,t){let i=e.type;return i&&(i.release&&i.release(e.resolvedValue,i,this.component),i.transform)?i.transform(t,i,this.component):t}_createAsyncPropData(e,t){if(!this.asyncProps[e]){let n=this.component&&this.component.constructor._propTypes;this.asyncProps[e]={type:n&&n[e],lastValue:null,resolvedValue:t,pendingLoadCount:0,resolvedLoadCount:0}}}};var Qg=class extends Zg{constructor({attributeManager:e,layer:t}){super(t),y(this,"attributeManager",void 0),y(this,"needsRedraw",void 0),y(this,"needsUpdate",void 0),y(this,"subLayers",void 0),y(this,"usesPickingColorCache",void 0),y(this,"changeFlags",void 0),y(this,"viewport",void 0),y(this,"uniformTransitions",void 0),y(this,"propsInTransition",void 0),this.attributeManager=e,this.needsRedraw=!0,this.needsUpdate=!0,this.subLayers=null,this.usesPickingColorCache=!1}get layer(){return this.component}set layer(e){this.component=e}_fetch(e,t){let i=this.component.props.fetch;return i?i(t,{propName:e,layer:this.layer}):super._fetch(e,t)}_onResolve(e,t){let i=this.component.props.onDataLoad;e==="data"&&i&&i(t,{propName:e,layer:this.layer})}_onError(e,t){this.layer.raiseError(t,"loading ".concat(e," of ").concat(this.layer))}};var L5="layer.changeFlag",R5="layer.initialize",O5="layer.update",_5="layer.finalize",N5="layer.matched",nR=2**24-1,M5=Object.freeze([]),B5=uo(({oldViewport:s,viewport:e})=>s.equals(e)),os=new Uint8ClampedArray(0),D5={data:{type:"data",value:M5,async:!0},dataComparator:{type:"function",value:null,compare:!1,optional:!0},_dataDiff:{type:"function",value:s=>s&&s.__diff,compare:!1,optional:!0},dataTransform:{type:"function",value:null,compare:!1,optional:!0},onDataLoad:{type:"function",value:null,compare:!1,optional:!0},onError:{type:"function",value:null,compare:!1,optional:!0},fetch:{type:"function",value:(s,{propName:e,layer:t,loaders:i,loadOptions:n,signal:o})=>{let{resourceManager:a}=t.context;if(n=n||t.getLoadOptions(),i=i||t.props.loaders,o){var l;n={...n,fetch:{...(l=n)===null||l===void 0?void 0:l.fetch,signal:o}}}let u=a.contains(s);return!u&&!n&&(a.add({resourceId:s,data:$o(s,i),persistent:!1}),u=!0),u?a.subscribe({resourceId:s,onChange:c=>{var h;return(h=t.internalState)===null||h===void 0?void 0:h.reloadAsyncProp(e,c)},consumerId:t.id,requestId:e}):$o(s,i,n)},compare:!1},updateTriggers:{},visible:!0,pickable:!1,opacity:{type:"number",min:0,max:1,value:1},operation:lo.DRAW,onHover:{type:"function",value:null,compare:!1,optional:!0},onClick:{type:"function",value:null,compare:!1,optional:!0},onDragStart:{type:"function",value:null,compare:!1,optional:!0},onDrag:{type:"function",value:null,compare:!1,optional:!0},onDragEnd:{type:"function",value:null,compare:!1,optional:!0},coordinateSystem:Ge.DEFAULT,coordinateOrigin:{type:"array",value:[0,0,0],compare:!0},modelMatrix:{type:"array",value:null,compare:!0,optional:!0},wrapLongitude:!1,positionFormat:"XYZ",colorFormat:"RGBA",parameters:{type:"object",value:{},optional:!0,compare:!0},transitions:null,extensions:[],loaders:{type:"array",value:[],optional:!0,compare:!0},getPolygonOffset:{type:"function",value:({layerIndex:s})=>[0,-s*100],compare:!1},highlightedObjectIndex:null,autoHighlight:!1,highlightColor:{type:"accessor",value:[0,0,128,128]}},kt=class extends Qu{constructor(...e){super(...e),y(this,"internalState",null),y(this,"lifecycle",gl.NO_STATE),y(this,"context",void 0),y(this,"state",void 0),y(this,"parent",null)}get root(){let e=this;for(;e.parent;)e=e.parent;return e}toString(){let e=this.constructor.layerName||this.constructor.name;return"".concat(e,"({id: '").concat(this.props.id,"'})")}project(e){mt(this.internalState);let t=this.internalState.viewport||this.context.viewport,i=Ix(e,{viewport:t,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem}),[n,o,a]=Vh(i,t.pixelProjectionMatrix);return e.length===2?[n,o]:[n,o,a]}unproject(e){return mt(this.internalState),(this.internalState.viewport||this.context.viewport).unproject(e)}projectPosition(e,t){mt(this.internalState);let i=this.internalState.viewport||this.context.viewport;return iL(e,{viewport:i,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem,...t})}get isComposite(){return!1}setState(e){this.setChangeFlags({stateChanged:!0}),Object.assign(this.state,e),this.setNeedsRedraw()}setNeedsRedraw(){this.internalState&&(this.internalState.needsRedraw=!0)}setNeedsUpdate(){this.internalState&&(this.context.layerManager.setNeedsUpdate(String(this)),this.internalState.needsUpdate=!0)}get isLoaded(){return this.internalState?!this.internalState.isAsyncPropLoading():!1}get wrapLongitude(){return this.props.wrapLongitude}isPickable(){return this.props.pickable&&this.props.visible}getModels(){return this.state&&(this.state.models||this.state.model&&[this.state.model])||[]}setModuleParameters(e){for(let t of this.getModels())t.updateModuleSettings(e)}getAttributeManager(){return this.internalState&&this.internalState.attributeManager}getCurrentLayer(){return this.internalState&&this.internalState.layer}getLoadOptions(){return this.props.loadOptions}use64bitPositions(){let{coordinateSystem:e}=this.props;return e===Ge.DEFAULT||e===Ge.LNGLAT||e===Ge.CARTESIAN}onHover(e,t){return this.props.onHover&&this.props.onHover(e,t)||!1}onClick(e,t){return this.props.onClick&&this.props.onClick(e,t)||!1}nullPickingColor(){return[0,0,0]}encodePickingColor(e,t=[]){return t[0]=e+1&255,t[1]=e+1>>8&255,t[2]=e+1>>8>>8&255,t}decodePickingColor(e){mt(e instanceof Uint8Array);let[t,i,n]=e;return t+i*256+n*65536-1}getNumInstances(){return Number.isFinite(this.props.numInstances)?this.props.numInstances:this.state&&this.state.numInstances!==void 0?this.state.numInstances:ZL(this.props.data)}getStartIndices(){return this.props.startIndices?this.props.startIndices:this.state&&this.state.startIndices?this.state.startIndices:null}getBounds(){var e;let t=this.getAttributeManager();if(!t)return null;let{positions:i,instancePositions:n}=t.attributes;return(e=i||n)===null||e===void 0?void 0:e.getBounds()}getShaders(e){for(let t of this.props.extensions)e=QL(e,t.getShaders.call(this,t));return e}shouldUpdateState(e){return e.changeFlags.propsOrDataChanged}updateState(e){let t=this.getAttributeManager(),{dataChanged:i}=e.changeFlags;if(i&&t)if(Array.isArray(i))for(let u of i)t.invalidateAll(u);else t.invalidateAll();let{props:n,oldProps:o}=e,a=Number.isInteger(o.highlightedObjectIndex)||o.pickable,l=Number.isInteger(n.highlightedObjectIndex)||n.pickable;if(a!==l&&t){let{pickingColors:u,instancePickingColors:c}=t.attributes,h=u||c;h&&(l&&h.constant&&(h.constant=!1,t.invalidate(h.id)),!h.value&&!l&&(h.constant=!0,h.value=[0,0,0]))}}finalizeState(e){for(let i of this.getModels())i.delete();let t=this.getAttributeManager();t&&t.finalize(),this.context&&this.context.resourceManager.unsubscribe({consumerId:this.id}),this.internalState&&(this.internalState.uniformTransitions.clear(),this.internalState.finalize())}draw(e){for(let t of this.getModels())t.draw(e)}getPickingInfo({info:e,mode:t,sourceLayer:i}){let{index:n}=e;return n>=0&&Array.isArray(this.props.data)&&(e.object=this.props.data[n]),e}raiseError(e,t){var i,n;if(t&&(e.message="".concat(t,": ").concat(e.message)),!((i=(n=this.props).onError)!==null&&i!==void 0&&i.call(n,e))){var o,a;(o=this.context)===null||o===void 0||(a=o.onError)===null||a===void 0||a.call(o,e,this)}}getNeedsRedraw(e={clearRedrawFlags:!1}){return this._getNeedsRedraw(e)}needsUpdate(){return this.internalState?this.internalState.needsUpdate||this.hasUniformTransition()||this.shouldUpdateState(this._getUpdateParams()):!1}hasUniformTransition(){var e;return((e=this.internalState)===null||e===void 0?void 0:e.uniformTransitions.active)||!1}activateViewport(e){if(!this.internalState)return;let t=this.internalState.viewport;this.internalState.viewport=e,(!t||!B5({oldViewport:t,viewport:e}))&&(this.setChangeFlags({viewportChanged:!0}),this.isComposite?this.needsUpdate()&&this.setNeedsUpdate():this._update())}invalidateAttribute(e="all"){let t=this.getAttributeManager();!t||(e==="all"?t.invalidateAll():t.invalidate(e))}updateAttributes(e){for(let t of this.getModels())this._setModelAttributes(t,e)}_updateAttributes(){let e=this.getAttributeManager();if(!e)return;let t=this.props,i=this.getNumInstances(),n=this.getStartIndices();e.update({data:t.data,numInstances:i,startIndices:n,props:t,transitions:t.transitions,buffers:t.data.attributes,context:this});let o=e.getChangedAttributes({clearChangedFlags:!0});this.updateAttributes(o)}_updateAttributeTransition(){let e=this.getAttributeManager();e&&e.updateTransition()}_updateUniformTransition(){let{uniformTransitions:e}=this.internalState;if(e.active){let t=e.update(),i=Object.create(this.props);for(let n in t)Object.defineProperty(i,n,{value:t[n]});return i}return this.props}calculateInstancePickingColors(e,{numInstances:t}){if(e.constant)return;let i=Math.floor(os.length/3);if(this.internalState.usesPickingColorCache=!0,i<t){t>nR&&fe.warn("Layer has too many data objects. Picking might not be able to distinguish all objects.")(),os=go.allocate(os,t,{size:3,copy:!0,maxCount:Math.max(t,nR)});let n=Math.floor(os.length/3),o=[];for(let a=i;a<n;a++)this.encodePickingColor(a,o),os[a*3+0]=o[0],os[a*3+1]=o[1],os[a*3+2]=o[2]}e.value=os.subarray(0,t*3)}_setModelAttributes(e,t){let i=this.getAttributeManager(),n=e.userData.excludeAttributes||{},o=i.getShaderAttributes(t,n);e.setAttributes(o)}disablePickingIndex(e){this._disablePickingIndex(e)}_disablePickingIndex(e){let{pickingColors:t,instancePickingColors:i}=this.getAttributeManager().attributes,n=t||i;if(!n)return;let o=n.getVertexOffset(e),a=n.getVertexOffset(e+1);n.buffer.subData({data:new Uint8Array(a-o),offset:o})}restorePickingColors(){let{pickingColors:e,instancePickingColors:t}=this.getAttributeManager().attributes,i=e||t;!i||(this.internalState.usesPickingColorCache&&i.value.buffer!==os.buffer&&(i.value=os.subarray(0,i.value.length)),i.updateSubBuffer({startOffset:0}))}_initialize(){mt(!this.internalState),mt(Number.isFinite(this.props.coordinateSystem)),Gt(R5,this);let e=this._getAttributeManager();e&&e.addInstanced({instancePickingColors:{type:5121,size:3,noAlloc:!0,update:this.calculateInstancePickingColors}}),this.internalState=new Qg({attributeManager:e,layer:this}),this._clearChangeFlags(),this.state={},Object.defineProperty(this.state,"attributeManager",{get:()=>(fe.deprecated("layer.state.attributeManager","layer.getAttributeManager()")(),e)}),this.internalState.layer=this,this.internalState.uniformTransitions=new Xg(this.context.timeline),this.internalState.onAsyncPropUpdated=this._onAsyncPropUpdated.bind(this),this.internalState.setAsyncProps(this.props),this.initializeState(this.context);for(let t of this.props.extensions)t.initializeState.call(this,this.context,t);this.setChangeFlags({dataChanged:"init",propsChanged:"init",viewportChanged:!0,extensionsChanged:!0}),this._update()}_transferState(e){Gt(N5,this,this===e);let{state:t,internalState:i}=e;this!==e&&(this.internalState=i,this.internalState.layer=this,this.state=t,this.internalState.setAsyncProps(this.props),this._diffProps(this.props,this.internalState.getOldProps()))}_update(){let e=this.needsUpdate();if(Gt(O5,this,e),!e)return;let t=this.props,i=this.context,n=this.internalState,o=i.viewport,a=this._updateUniformTransition();n.propsInTransition=a,i.viewport=n.viewport||o,this.props=a;try{let l=this._getUpdateParams(),u=this.getModels();if(i.gl)this.updateState(l);else try{this.updateState(l)}catch{}for(let h of this.props.extensions)h.updateState.call(this,l,h);let c=this.getModels()[0]!==u[0];this._postUpdate(l,c)}finally{i.viewport=o,this.props=t,this._clearChangeFlags(),n.needsUpdate=!1,n.resetOldProps()}}_finalize(){Gt(_5,this),this.finalizeState(this.context);for(let e of this.props.extensions)e.finalizeState.call(this,e)}_drawLayer({moduleParameters:e=null,uniforms:t={},parameters:i={}}){this._updateAttributeTransition();let n=this.props,o=this.context;this.props=this.internalState.propsInTransition||n;let a=this.props.opacity;t.opacity=Math.pow(a,1/2.2);try{e&&this.setModuleParameters(e);let{getPolygonOffset:l}=this.props,u=l&&l(t)||[0,0];yi(o.gl,{polygonOffset:u}),pt(o.gl,i,()=>{let c={moduleParameters:e,uniforms:t,parameters:i,context:o};for(let h of this.props.extensions)h.draw.call(this,c,h);this.draw(c)})}finally{this.props=n}}getChangeFlags(){var e;return(e=this.internalState)===null||e===void 0?void 0:e.changeFlags}setChangeFlags(e){if(!this.internalState)return;let{changeFlags:t}=this.internalState;for(let n in e)if(e[n]){let o=!1;switch(n){case"dataChanged":let a=e[n],l=t[n];a&&Array.isArray(l)&&(t.dataChanged=Array.isArray(a)?l.concat(a):a,o=!0);default:t[n]||(t[n]=e[n],o=!0)}o&&Gt(L5,this,n,e)}let i=Boolean(t.dataChanged||t.updateTriggersChanged||t.propsChanged||t.extensionsChanged);t.propsOrDataChanged=i,t.somethingChanged=i||t.viewportChanged||t.stateChanged}_clearChangeFlags(){this.internalState.changeFlags={dataChanged:!1,propsChanged:!1,updateTriggersChanged:!1,viewportChanged:!1,stateChanged:!1,extensionsChanged:!1,propsOrDataChanged:!1,somethingChanged:!1}}_diffProps(e,t){let i=YL(e,t);if(i.updateTriggersChanged)for(let o in i.updateTriggersChanged)i.updateTriggersChanged[o]&&this.invalidateAttribute(o);if(i.transitionsChanged)for(let o in i.transitionsChanged){var n;this.internalState.uniformTransitions.add(o,t[o],e[o],(n=e.transitions)===null||n===void 0?void 0:n[o])}return this.setChangeFlags(i)}validateProps(){XL(this.props)}updateAutoHighlight(e){this.props.autoHighlight&&!Number.isInteger(this.props.highlightedObjectIndex)&&this._updateAutoHighlight(e)}_updateAutoHighlight(e){let t={pickingSelectedColor:e.picked?e.color:null},{highlightColor:i}=this.props;e.picked&&typeof i=="function"&&(t.pickingHighlightColor=i(e)),this.setModuleParameters(t),this.setNeedsRedraw()}_getAttributeManager(){let e=this.context;return new Hg(e.gl,{id:this.props.id,stats:e.stats,timeline:e.timeline})}_postUpdate(e,t){let{props:i,oldProps:n}=e;this.setNeedsRedraw(),this._updateAttributes();let{model:o}=this.state;o?.setInstanceCount(this.getNumInstances());let{autoHighlight:a,highlightedObjectIndex:l,highlightColor:u}=i;if(t||n.autoHighlight!==a||n.highlightedObjectIndex!==l||n.highlightColor!==u){let c={};a||(c.pickingSelectedColor=null),Array.isArray(u)&&(c.pickingHighlightColor=u),Number.isInteger(l)&&(c.pickingSelectedColor=Number.isFinite(l)&&l>=0?this.encodePickingColor(l):null),this.setModuleParameters(c)}}_getUpdateParams(){return{props:this.props,oldProps:this.internalState.getOldProps(),context:this.context,changeFlags:this.internalState.changeFlags}}_getNeedsRedraw(e){if(!this.internalState)return!1;let t=!1;t=t||this.internalState.needsRedraw&&this.id,this.internalState.needsRedraw=this.internalState.needsRedraw&&!e.clearRedrawFlags;let i=this.getAttributeManager(),n=i?i.getNeedsRedraw(e):!1;return t=t||n,t}_onAsyncPropUpdated(){this._diffProps(this.props,this.internalState.getOldProps()),this.setNeedsUpdate()}};y(kt,"defaultProps",D5);y(kt,"layerName","Layer");var G5="compositeLayer.renderLayers",un=class extends kt{get isComposite(){return!0}get isLoaded(){return super.isLoaded&&this.getSubLayers().every(e=>e.isLoaded)}getSubLayers(){return this.internalState&&this.internalState.subLayers||[]}initializeState(e){}setState(e){super.setState(e),this.setNeedsUpdate()}getPickingInfo({info:e}){let{object:t}=e;return t&&t.__source&&t.__source.parent&&t.__source.parent.id===this.id&&(e.object=t.__source.object,e.index=t.__source.index),e}filterSubLayer(e){return!0}shouldRenderSubLayer(e,t){return t&&t.length}getSubLayerClass(e,t){let{_subLayerProps:i}=this.props;return i&&i[e]&&i[e].type||t}getSubLayerRow(e,t,i){return e.__source={parent:this,object:t,index:i},e}getSubLayerAccessor(e){if(typeof e=="function"){let t={index:-1,data:this.props.data,target:[]};return(i,n)=>i&&i.__source?(t.index=i.__source.index,e(i.__source.object,t)):e(i,n)}return e}getSubLayerProps(e={}){var t;let{opacity:i,pickable:n,visible:o,parameters:a,getPolygonOffset:l,highlightedObjectIndex:u,autoHighlight:c,highlightColor:h,coordinateSystem:d,coordinateOrigin:f,wrapLongitude:p,positionFormat:S,modelMatrix:E,extensions:C,fetch:O,operation:B,_subLayerProps:A}=this.props,N={id:"",updateTriggers:{},opacity:i,pickable:n,visible:o,parameters:a,getPolygonOffset:l,highlightedObjectIndex:u,autoHighlight:c,highlightColor:h,coordinateSystem:d,coordinateOrigin:f,wrapLongitude:p,positionFormat:S,modelMatrix:E,extensions:C,fetch:O,operation:B},z=A&&e.id&&A[e.id],Y=z&&z.updateTriggers,ie=e.id||"sublayer";if(z){let he=this.constructor._propTypes,ae=e.type?e.type._propTypes:{};for(let D in z){let _=ae[D]||he[D];_&&_.type==="accessor"&&(z[D]=this.getSubLayerAccessor(z[D]))}}Object.assign(N,e,z),N.id="".concat(this.props.id,"-").concat(ie),N.updateTriggers={all:(t=this.props.updateTriggers)===null||t===void 0?void 0:t.all,...e.updateTriggers,...Y};for(let he of C){let ae=he.getSubLayerProps.call(this,he);ae&&Object.assign(N,ae,{updateTriggers:Object.assign(N.updateTriggers,ae.updateTriggers)})}return N}_updateAutoHighlight(e){for(let t of this.getSubLayers())t.updateAutoHighlight(e)}_getAttributeManager(){return null}_postUpdate(e,t){let i=this.internalState.subLayers,n=!i||this.needsUpdate();if(n){let o=this.renderLayers();i=Ys(o,Boolean),this.internalState.subLayers=i}Gt(G5,this,n,i);for(let o of i)o.parent=this}};y(un,"layerName","CompositeLayer");var ry=Math.PI/180,oR=180/Math.PI,iy=6370972,Kh=256;function F5(){let s=Kh/iy,e=Math.PI/180*Kh;return{unitsPerMeter:[s,s,s],unitsPerMeter2:[0,0,0],metersPerUnit:[1/s,1/s,1/s],unitsPerDegree:[e,e,s],unitsPerDegree2:[0,0,0],degreesPerUnit:[1/e,1/e,1/s]}}var Zh=class extends li{constructor(e={}){let{latitude:t=0,longitude:i=0,zoom:n=0,nearZMultiplier:o=.1,farZMultiplier:a=2,resolution:l=10}=e,{height:u,altitude:c=1.5}=e;u=u||1,c=Math.max(.75,c);let h=new $e().lookAt({eye:[0,-c,0],up:[0,0,1]}),d=Math.pow(2,n);h.rotateX(t*ry),h.rotateZ(-i*ry),h.scale(d/u);let f=Math.atan(.5/c),p=Kh*2*d/u;super({...e,height:u,viewMatrix:h,longitude:i,latitude:t,zoom:n,distanceScales:F5(),fovyRadians:f*2,focalDistance:c,near:o,far:Math.min(2,1/p+1)*c*a}),y(this,"longitude",void 0),y(this,"latitude",void 0),y(this,"resolution",void 0),this.latitude=t,this.longitude=i,this.resolution=l}get projectionMode(){return si.GLOBE}getDistanceScales(){return this.distanceScales}getBounds(e={}){let t={targetZ:e.z||0},i=this.unproject([0,this.height/2],t),n=this.unproject([this.width/2,0],t),o=this.unproject([this.width,this.height/2],t),a=this.unproject([this.width/2,this.height],t);return o[0]<this.longitude&&(o[0]+=360),i[0]>this.longitude&&(i[0]-=360),[Math.min(i[0],o[0],n[0],a[0]),Math.min(i[1],o[1],n[1],a[1]),Math.max(i[0],o[0],n[0],a[0]),Math.max(i[1],o[1],n[1],a[1])]}unproject(e,{topLeft:t=!0,targetZ:i}={}){let[n,o,a]=e,l=t?o:this.height-o,{pixelUnprojectionMatrix:u}=this,c;if(Number.isFinite(a))c=zx(u,[n,l,a,1]);else{let p=zx(u,[n,l,-1,1]),S=zx(u,[n,l,1,1]),E=((i||0)/iy+1)*Kh,C=IP(AP([],p,S)),O=IP(p),B=IP(S),A=(4*O*B-(C-O-B)**2)/16,N=4*A/C,z=Math.sqrt(O-N),Y=Math.sqrt(Math.max(0,E*E-N)),ie=(z-Y)/Math.sqrt(C);c=MI([],p,S,ie)}let[h,d,f]=this.unprojectPosition(c);return Number.isFinite(a)?[h,d,f]:Number.isFinite(i)?[h,d,i]:[h,d]}projectPosition(e){let[t,i,n=0]=e,o=t*ry,a=i*ry,l=Math.cos(a),u=(n/iy+1)*Kh;return[Math.sin(o)*l*u,-Math.cos(o)*l*u,Math.sin(a)*u]}unprojectPosition(e){let[t,i,n]=e,o=TP(e),a=Math.asin(n/o),u=Math.atan2(t,-i)*oR,c=a*oR,h=(o/Kh-1)*iy;return[u,c,h]}projectFlat(e){return e}unprojectFlat(e){return e}panByPosition(e,t){let i=this.unproject(t);return{longitude:e[0]-i[0]+this.longitude,latitude:e[1]-i[1]+this.latitude}}};function zx(s,e){let t=ao([],e,s);return Nh(t,t,1/t[3]),t}var $s=class{constructor(e){y(this,"opts",void 0),e&&(this.opts=e)}equals(e){return this===e?!0:this.constructor===e.constructor&&an(this.opts,e.opts)}getShaders(e){return null}getSubLayerProps(e){let{defaultProps:t}=e.constructor,i={updateTriggers:{}};for(let n in t)if(n in this.props){let o=t[n],a=this.props[n];i[n]=a,o&&o.type==="accessor"&&(i.updateTriggers[n]=this.props.updateTriggers[n],typeof a=="function"&&(i[n]=this.getSubLayerAccessor(a)))}return i}initializeState(e,t){}updateState(e,t){}draw(e,t){}finalizeState(e,t){}};y($s,"defaultProps",{});var bl=class{constructor(e){y(this,"opts",void 0),y(this,"typedArrayManager",void 0),y(this,"indexStarts",[0]),y(this,"vertexStarts",[0]),y(this,"vertexCount",0),y(this,"instanceCount",0),y(this,"attributes",void 0),y(this,"_attributeDefs",void 0),y(this,"data",void 0),y(this,"getGeometry",void 0),y(this,"geometryBuffer",void 0),y(this,"buffers",void 0),y(this,"positionSize",void 0),y(this,"normalize",void 0);let{attributes:t={}}=e;this.typedArrayManager=go,this.attributes={},this._attributeDefs=t,this.opts=e,this.updateGeometry(e)}updateGeometry(e){Object.assign(this.opts,e);let{data:t,buffers:i={},getGeometry:n,geometryBuffer:o,positionFormat:a,dataChanged:l,normalize:u=!0}=this.opts;if(this.data=t,this.getGeometry=n,this.positionSize=o&&o.size||(a==="XY"?2:3),this.buffers=i,this.normalize=u,o&&(mt(t.startIndices),this.getGeometry=this.getGeometryFromBuffer(o),u||(i.positions=o)),this.geometryBuffer=i.positions,Array.isArray(l))for(let c of l)this._rebuildGeometry(c);else this._rebuildGeometry()}updatePartialGeometry({startRow:e,endRow:t}){this._rebuildGeometry({startRow:e,endRow:t})}getGeometryFromBuffer(e){let t=e.value||e;return ArrayBuffer.isView(t)?YP(t,{size:this.positionSize,offset:e.offset,stride:e.stride,startIndices:this.data.startIndices}):null}_allocate(e,t){let{attributes:i,buffers:n,_attributeDefs:o,typedArrayManager:a}=this;for(let l in o)if(l in n)a.release(i[l]),i[l]=null;else{let u=o[l];u.copy=t,i[l]=a.allocate(i[l],e,u)}}_forEachGeometry(e,t,i){let{data:n,getGeometry:o}=this,{iterable:a,objectInfo:l}=Po(n,t,i);for(let u of a){l.index++;let c=o?o(u,l):null;e(c,l.index)}}_rebuildGeometry(e){if(!this.data)return;let{indexStarts:t,vertexStarts:i,instanceCount:n}=this,{data:o,geometryBuffer:a}=this,{startRow:l=0,endRow:u=1/0}=e||{},c={};if(e||(t=[0],i=[0]),this.normalize||!a)this._forEachGeometry((d,f)=>{let p=d&&this.normalizeGeometry(d);c[f]=p,i[f+1]=i[f]+(p?this.getGeometrySize(p):0)},l,u),n=i[i.length-1];else if(i=o.startIndices,n=i[o.length]||0,ArrayBuffer.isView(a))n=n||a.length/this.positionSize;else if(a instanceof ye){let d=a.accessor.stride||this.positionSize*4;n=n||a.byteLength/d}else if(a.buffer){let d=a.stride||this.positionSize*4;n=n||a.buffer.byteLength/d}else if(a.value){let d=a.value,f=a.stride/d.BYTES_PER_ELEMENT||this.positionSize;n=n||d.length/f}this._allocate(n,Boolean(e)),this.indexStarts=t,this.vertexStarts=i,this.instanceCount=n;let h={};this._forEachGeometry((d,f)=>{let p=c[f]||d;h.vertexStart=i[f],h.indexStart=t[f];let S=f<i.length-1?i[f+1]:n;h.geometrySize=S-i[f],h.geometryIndex=f,this.updateGeometryAttributes(p,h)},l,u),this.vertexCount=t[t.length-1]}};var sR=`#define SHADER_NAME icon-layer-vertex-shader

attribute vec2 positions;

attribute vec3 instancePositions;
attribute vec3 instancePositions64Low;
attribute float instanceSizes;
attribute float instanceAngles;
attribute vec4 instanceColors;
attribute vec3 instancePickingColors;
attribute vec4 instanceIconFrames;
attribute float instanceColorModes;
attribute vec2 instanceOffsets;
attribute vec2 instancePixelOffset;

uniform float sizeScale;
uniform vec2 iconsTextureDim;
uniform float sizeMinPixels;
uniform float sizeMaxPixels;
uniform bool billboard;
uniform int sizeUnits;

varying float vColorMode;
varying vec4 vColor;
varying vec2 vTextureCoords;
varying vec2 uv;

vec2 rotate_by_angle(vec2 vertex, float angle) {
  float angle_radian = angle * PI / 180.0;
  float cos_angle = cos(angle_radian);
  float sin_angle = sin(angle_radian);
  mat2 rotationMatrix = mat2(cos_angle, -sin_angle, sin_angle, cos_angle);
  return rotationMatrix * vertex;
}

void main(void) {
  geometry.worldPosition = instancePositions;
  geometry.uv = positions;
  geometry.pickingColor = instancePickingColors;
  uv = positions;

  vec2 iconSize = instanceIconFrames.zw;
  // convert size in meters to pixels, then scaled and clamp
 
  // project meters to pixels and clamp to limits 
  float sizePixels = clamp(
    project_size_to_pixel(instanceSizes * sizeScale, sizeUnits), 
    sizeMinPixels, sizeMaxPixels
  );

  // scale icon height to match instanceSize
  float instanceScale = iconSize.y == 0.0 ? 0.0 : sizePixels / iconSize.y;

  // scale and rotate vertex in "pixel" value and convert back to fraction in clipspace
  vec2 pixelOffset = positions / 2.0 * iconSize + instanceOffsets;
  pixelOffset = rotate_by_angle(pixelOffset, instanceAngles) * instanceScale;
  pixelOffset += instancePixelOffset;
  pixelOffset.y *= -1.0;

  if (billboard)  {
    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);
    vec3 offset = vec3(pixelOffset, 0.0);
    DECKGL_FILTER_SIZE(offset, geometry);
    gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);

  } else {
    vec3 offset_common = vec3(project_pixel_size(pixelOffset), 0.0);
    DECKGL_FILTER_SIZE(offset_common, geometry);
    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset_common, geometry.position); 
  }
  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);

  vTextureCoords = mix(
    instanceIconFrames.xy,
    instanceIconFrames.xy + iconSize,
    (positions.xy + 1.0) / 2.0
  ) / iconsTextureDim;

  vColor = instanceColors;
  DECKGL_FILTER_COLOR(vColor, geometry);

  vColorMode = instanceColorModes;
}
`;var aR=`#define SHADER_NAME icon-layer-fragment-shader

precision highp float;

uniform float opacity;
uniform sampler2D iconsTexture;
uniform float alphaCutoff;

varying float vColorMode;
varying vec4 vColor;
varying vec2 vTextureCoords;
varying vec2 uv;

void main(void) {
  geometry.uv = uv;

  vec4 texColor = texture2D(iconsTexture, vTextureCoords);

  // if colorMode == 0, use pixel color from the texture
  // if colorMode == 1 or rendering picking buffer, use texture as transparency mask
  vec3 color = mix(texColor.rgb, vColor.rgb, vColorMode);
  // Take the global opacity and the alpha from vColor into account for the alpha component
  float a = texColor.a * opacity * vColor.a;

  if (a < alphaCutoff) {
    discard;
  }

  gl_FragColor = vec4(color, a);
  DECKGL_FILTER_COLOR(gl_FragColor, geometry);
}
`;var k5=1024,V5=4,lR=()=>{},uR={[10241]:9987,[10240]:9729,[10242]:33071,[10243]:33071};function U5(s){return Math.pow(2,Math.ceil(Math.log2(s)))}function z5(s,e,t,i){return t===e.width&&i===e.height?e:(s.canvas.height=i,s.canvas.width=t,s.clearRect(0,0,s.canvas.width,s.canvas.height),s.drawImage(e,0,0,e.width,e.height,0,0,t,i),s.canvas)}function Jg(s){return s&&(s.id||s.url)}function W5(s,e,t,i){let n=s.width,o=s.height,a=new Ue(s.gl,{width:e,height:t,parameters:i});return sP(s,a,{targetY:0,width:n,height:o}),s.delete(),a}function cR(s,e,t){for(let i=0;i<e.length;i++){let{icon:n,xOffset:o}=e[i],a=Jg(n);s[a]={...n,x:o,y:t}}}function H5({icons:s,buffer:e,mapping:t={},xOffset:i=0,yOffset:n=0,rowHeight:o=0,canvasWidth:a}){let l=[];for(let u=0;u<s.length;u++){let c=s[u],h=Jg(c);if(!t[h]){let{height:d,width:f}=c;i+f+e>a&&(cR(t,l,n),i=0,n=o+n+e,o=0,l=[]),l.push({icon:c,xOffset:i}),i=i+f+e,o=Math.max(o,d)}}return l.length>0&&cR(t,l,n),{mapping:t,rowHeight:o,xOffset:i,yOffset:n,canvasWidth:a,canvasHeight:U5(o+n+e)}}function j5(s,e,t){if(!s||!e)return null;t=t||{};let i={},{iterable:n,objectInfo:o}=Po(s);for(let a of n){o.index++;let l=e(a,o),u=Jg(l);if(!l)throw new Error("Icon is missing.");if(!l.url)throw new Error("Icon url is missing.");!i[u]&&(!t[u]||l.url!==t[u].url)&&(i[u]={...l,source:a,sourceIndex:o.index})}return i}var $g=class{constructor(e,{onUpdate:t=lR,onError:i=lR}){y(this,"gl",void 0),y(this,"onUpdate",void 0),y(this,"onError",void 0),y(this,"_loadOptions",null),y(this,"_texture",null),y(this,"_externalTexture",null),y(this,"_mapping",{}),y(this,"_textureParameters",null),y(this,"_pendingCount",0),y(this,"_autoPacking",!1),y(this,"_xOffset",0),y(this,"_yOffset",0),y(this,"_rowHeight",0),y(this,"_buffer",V5),y(this,"_canvasWidth",k5),y(this,"_canvasHeight",0),y(this,"_canvas",null),this.gl=e,this.onUpdate=t,this.onError=i}finalize(){var e;(e=this._texture)===null||e===void 0||e.delete()}getTexture(){return this._texture||this._externalTexture}getIconMapping(e){let t=this._autoPacking?Jg(e):e;return this._mapping[t]||{}}setProps({loadOptions:e,autoPacking:t,iconAtlas:i,iconMapping:n,textureParameters:o}){if(e&&(this._loadOptions=e),t!==void 0&&(this._autoPacking=t),n&&(this._mapping=n),i){var a;(a=this._texture)===null||a===void 0||a.delete(),this._texture=null,this._externalTexture=i}o&&(this._textureParameters=o)}get isLoaded(){return this._pendingCount===0}packIcons(e,t){if(!this._autoPacking||typeof document>"u")return;let i=Object.values(j5(e,t,this._mapping)||{});if(i.length>0){let{mapping:n,xOffset:o,yOffset:a,rowHeight:l,canvasHeight:u}=H5({icons:i,buffer:this._buffer,canvasWidth:this._canvasWidth,mapping:this._mapping,rowHeight:this._rowHeight,xOffset:this._xOffset,yOffset:this._yOffset});this._rowHeight=l,this._mapping=n,this._xOffset=o,this._yOffset=a,this._canvasHeight=u,this._texture||(this._texture=new Ue(this.gl,{width:this._canvasWidth,height:this._canvasHeight,parameters:this._textureParameters||uR})),this._texture.height!==this._canvasHeight&&(this._texture=W5(this._texture,this._canvasWidth,this._canvasHeight,this._textureParameters||uR)),this.onUpdate(),this._canvas=this._canvas||document.createElement("canvas"),this._loadIcons(i)}}_loadIcons(e){let t=this._canvas.getContext("2d");for(let i of e)this._pendingCount++,$o(i.url,xu,this._loadOptions).then(n=>{let o=Jg(i),{x:a,y:l,width:u,height:c}=this._mapping[o],h=z5(t,n,u,c);this._texture.setSubImageData({data:h,x:a,y:l,width:u,height:c}),this._texture.generateMipmap(),this.onUpdate()}).catch(n=>{this.onError({url:i.url,source:i.source,sourceIndex:i.sourceIndex,loadOptions:this._loadOptions,error:n})}).finally(()=>{this._pendingCount--})}};var hR=[0,0,0,255],q5={iconAtlas:{type:"image",value:null,async:!0},iconMapping:{type:"object",value:{},async:!0},sizeScale:{type:"number",value:1,min:0},billboard:!0,sizeUnits:"pixels",sizeMinPixels:{type:"number",min:0,value:0},sizeMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},alphaCutoff:{type:"number",value:.05,min:0,max:1},getPosition:{type:"accessor",value:s=>s.position},getIcon:{type:"accessor",value:s=>s.icon},getColor:{type:"accessor",value:hR},getSize:{type:"accessor",value:1},getAngle:{type:"accessor",value:0},getPixelOffset:{type:"accessor",value:[0,0]},onIconError:{type:"function",value:null,compare:!1,optional:!0}},Gn=class extends kt{constructor(...e){super(...e),y(this,"state",void 0)}getShaders(){return super.getShaders({vs:sR,fs:aR,modules:[ai,Bn]})}initializeState(){this.state={iconManager:new $g(this.context.gl,{onUpdate:this._onUpdate.bind(this),onError:this._onError.bind(this)})},this.getAttributeManager().addInstanced({instancePositions:{size:3,type:5130,fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceSizes:{size:1,transition:!0,accessor:"getSize",defaultValue:1},instanceOffsets:{size:2,accessor:"getIcon",transform:this.getInstanceOffset},instanceIconFrames:{size:4,accessor:"getIcon",transform:this.getInstanceIconFrame},instanceColorModes:{size:1,type:5121,accessor:"getIcon",transform:this.getInstanceColorMode},instanceColors:{size:this.props.colorFormat.length,type:5121,normalized:!0,transition:!0,accessor:"getColor",defaultValue:hR},instanceAngles:{size:1,transition:!0,accessor:"getAngle"},instancePixelOffset:{size:2,transition:!0,accessor:"getPixelOffset"}})}updateState(e){super.updateState(e);let{props:t,oldProps:i,changeFlags:n}=e,o=this.getAttributeManager(),{iconAtlas:a,iconMapping:l,data:u,getIcon:c,textureParameters:h}=t,{iconManager:d}=this.state,f=a||this.internalState.isAsyncPropLoading("iconAtlas");if(d.setProps({loadOptions:t.loadOptions,autoPacking:!f,iconAtlas:a,iconMapping:f?l:null,textureParameters:h}),f?i.iconMapping!==t.iconMapping&&o.invalidate("getIcon"):(n.dataChanged||n.updateTriggersChanged&&(n.updateTriggersChanged.all||n.updateTriggersChanged.getIcon))&&d.packIcons(u,c),n.extensionsChanged){var p;let{gl:S}=this.context;(p=this.state.model)===null||p===void 0||p.delete(),this.state.model=this._getModel(S),o.invalidateAll()}}get isLoaded(){return super.isLoaded&&this.state.iconManager.isLoaded}finalizeState(e){super.finalizeState(e),this.state.iconManager.finalize()}draw({uniforms:e}){let{sizeScale:t,sizeMinPixels:i,sizeMaxPixels:n,sizeUnits:o,billboard:a,alphaCutoff:l}=this.props,{iconManager:u}=this.state,c=u.getTexture();c&&this.state.model.setUniforms(e).setUniforms({iconsTexture:c,iconsTextureDim:[c.width,c.height],sizeUnits:Ur[o],sizeScale:t,sizeMinPixels:i,sizeMaxPixels:n,billboard:a,alphaCutoff:l}).draw()}_getModel(e){let t=[-1,-1,-1,1,1,1,1,-1];return new At(e,{...this.getShaders(),id:this.props.id,geometry:new pr({drawMode:6,attributes:{positions:{size:2,value:new Float32Array(t)}}}),isInstanced:!0})}_onUpdate(){this.setNeedsRedraw()}_onError(e){var t;let i=(t=this.getCurrentLayer())===null||t===void 0?void 0:t.props.onIconError;i?i(e):fe.error(e.error.message)()}getInstanceOffset(e){let{width:t,height:i,anchorX:n=t/2,anchorY:o=i/2}=this.state.iconManager.getIconMapping(e);return[t/2-n,i/2-o]}getInstanceColorMode(e){return this.state.iconManager.getIconMapping(e).mask?1:0}getInstanceIconFrame(e){let{x:t,y:i,width:n,height:o}=this.state.iconManager.getIconMapping(e);return[t,i,n,o]}};y(Gn,"defaultProps",q5);y(Gn,"layerName","IconLayer");var dR=`#define SHADER_NAME scatterplot-layer-vertex-shader

attribute vec3 positions;

attribute vec3 instancePositions;
attribute vec3 instancePositions64Low;
attribute float instanceRadius;
attribute float instanceLineWidths;
attribute vec4 instanceFillColors;
attribute vec4 instanceLineColors;
attribute vec3 instancePickingColors;

uniform float opacity;
uniform float radiusScale;
uniform float radiusMinPixels;
uniform float radiusMaxPixels;
uniform float lineWidthScale;
uniform float lineWidthMinPixels;
uniform float lineWidthMaxPixels;
uniform float stroked;
uniform bool filled;
uniform bool antialiasing;
uniform bool billboard;
uniform int radiusUnits;
uniform int lineWidthUnits;

varying vec4 vFillColor;
varying vec4 vLineColor;
varying vec2 unitPosition;
varying float innerUnitRadius;
varying float outerRadiusPixels;


void main(void) {
  geometry.worldPosition = instancePositions;

  // Multiply out radius and clamp to limits
  outerRadiusPixels = clamp(
    project_size_to_pixel(radiusScale * instanceRadius, radiusUnits),
    radiusMinPixels, radiusMaxPixels
  );
  
  // Multiply out line width and clamp to limits
  float lineWidthPixels = clamp(
    project_size_to_pixel(lineWidthScale * instanceLineWidths, lineWidthUnits),
    lineWidthMinPixels, lineWidthMaxPixels
  );

  // outer radius needs to offset by half stroke width
  outerRadiusPixels += stroked * lineWidthPixels / 2.0;

  // Expand geometry to accomodate edge smoothing
  float edgePadding = antialiasing ? (outerRadiusPixels + SMOOTH_EDGE_RADIUS) / outerRadiusPixels : 1.0;

  // position on the containing square in [-1, 1] space
  unitPosition = edgePadding * positions.xy;
  geometry.uv = unitPosition;
  geometry.pickingColor = instancePickingColors;

  innerUnitRadius = 1.0 - stroked * lineWidthPixels / outerRadiusPixels;
  
  if (billboard) {
    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);
    vec3 offset = edgePadding * positions * outerRadiusPixels;
    DECKGL_FILTER_SIZE(offset, geometry);
    gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);
  } else {
    vec3 offset = edgePadding * positions * project_pixel_size(outerRadiusPixels);
    DECKGL_FILTER_SIZE(offset, geometry);
    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset, geometry.position);
  }

  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);

  // Apply opacity to instance color, or return instance picking color
  vFillColor = vec4(instanceFillColors.rgb, instanceFillColors.a * opacity);
  DECKGL_FILTER_COLOR(vFillColor, geometry);
  vLineColor = vec4(instanceLineColors.rgb, instanceLineColors.a * opacity);
  DECKGL_FILTER_COLOR(vLineColor, geometry);
}
`;var fR=`#define SHADER_NAME scatterplot-layer-fragment-shader

precision highp float;

uniform bool filled;
uniform float stroked;
uniform bool antialiasing;

varying vec4 vFillColor;
varying vec4 vLineColor;
varying vec2 unitPosition;
varying float innerUnitRadius;
varying float outerRadiusPixels;

void main(void) {
  geometry.uv = unitPosition;

  float distToCenter = length(unitPosition) * outerRadiusPixels;
  float inCircle = antialiasing ? 
    smoothedge(distToCenter, outerRadiusPixels) : 
    step(distToCenter, outerRadiusPixels);

  if (inCircle == 0.0) {
    discard;
  }

  if (stroked > 0.5) {
    float isLine = antialiasing ? 
      smoothedge(innerUnitRadius * outerRadiusPixels, distToCenter) :
      step(innerUnitRadius * outerRadiusPixels, distToCenter);

    if (filled) {
      gl_FragColor = mix(vFillColor, vLineColor, isLine);
    } else {
      if (isLine == 0.0) {
        discard;
      }
      gl_FragColor = vec4(vLineColor.rgb, vLineColor.a * isLine);
    }
  } else if (filled) {
    gl_FragColor = vFillColor;
  } else {
    discard;
  }

  gl_FragColor.a *= inCircle;
  DECKGL_FILTER_COLOR(gl_FragColor, geometry);
}
`;var gR=[0,0,0,255],X5={radiusUnits:"meters",radiusScale:{type:"number",min:0,value:1},radiusMinPixels:{type:"number",min:0,value:0},radiusMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},lineWidthUnits:"meters",lineWidthScale:{type:"number",min:0,value:1},lineWidthMinPixels:{type:"number",min:0,value:0},lineWidthMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},stroked:!1,filled:!0,billboard:!1,antialiasing:!0,getPosition:{type:"accessor",value:s=>s.position},getRadius:{type:"accessor",value:1},getFillColor:{type:"accessor",value:gR},getLineColor:{type:"accessor",value:gR},getLineWidth:{type:"accessor",value:1},strokeWidth:{deprecatedFor:"getLineWidth"},outline:{deprecatedFor:"stroked"},getColor:{deprecatedFor:["getFillColor","getLineColor"]}},Ju=class extends kt{getShaders(){return super.getShaders({vs:dR,fs:fR,modules:[ai,Bn]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:5130,fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceRadius:{size:1,transition:!0,accessor:"getRadius",defaultValue:1},instanceFillColors:{size:this.props.colorFormat.length,transition:!0,normalized:!0,type:5121,accessor:"getFillColor",defaultValue:[0,0,0,255]},instanceLineColors:{size:this.props.colorFormat.length,transition:!0,normalized:!0,type:5121,accessor:"getLineColor",defaultValue:[0,0,0,255]},instanceLineWidths:{size:1,transition:!0,accessor:"getLineWidth",defaultValue:1}})}updateState(e){if(super.updateState(e),e.changeFlags.extensionsChanged){var t;let{gl:i}=this.context;(t=this.state.model)===null||t===void 0||t.delete(),this.state.model=this._getModel(i),this.getAttributeManager().invalidateAll()}}draw({uniforms:e}){let{radiusUnits:t,radiusScale:i,radiusMinPixels:n,radiusMaxPixels:o,stroked:a,filled:l,billboard:u,antialiasing:c,lineWidthUnits:h,lineWidthScale:d,lineWidthMinPixels:f,lineWidthMaxPixels:p}=this.props;this.state.model.setUniforms(e).setUniforms({stroked:a?1:0,filled:l,billboard:u,antialiasing:c,radiusUnits:Ur[t],radiusScale:i,radiusMinPixels:n,radiusMaxPixels:o,lineWidthUnits:Ur[h],lineWidthScale:d,lineWidthMinPixels:f,lineWidthMaxPixels:p}).draw()}_getModel(e){let t=[-1,-1,0,1,-1,0,1,1,0,-1,1,0];return new At(e,{...this.getShaders(),id:this.props.id,geometry:new pr({drawMode:6,vertexCount:4,attributes:{positions:{size:3,value:new Float32Array(t)}}}),isInstanced:!0})}};y(Ju,"defaultProps",X5);y(Ju,"layerName","ScatterplotLayer");var ny={CLOCKWISE:1,COUNTER_CLOCKWISE:-1};function ep(s,e,t={}){return pR(s,t)!==e?(Y5(s,t),!0):!1}function pR(s,e={}){return Math.sign(oy(s,e))}function oy(s,e={}){let{start:t=0,end:i=s.length}=e,n=e.size||2,o=0;for(let a=t,l=i-n;a<i;a+=n)o+=(s[a]-s[l])*(s[a+1]+s[l+1]),l=a;return o/2}function Y5(s,e){let{start:t=0,end:i=s.length,size:n=2}=e,o=(i-t)/n,a=Math.floor(o/2);for(let l=0;l<a;++l){let u=t+l*n,c=t+(o-1-l)*n;for(let h=0;h<n;++h){let d=s[u+h];s[u+h]=s[c+h],s[c+h]=d}}}function Mi(s,e){let t=e.length,i=s.length;if(i>0){let n=!0;for(let o=0;o<t;o++)if(s[i-t+o]!==e[o]){n=!1;break}if(n)return!1}for(let n=0;n<t;n++)s[i+n]=e[n];return!0}function tp(s,e){let t=e.length;for(let i=0;i<t;i++)s[i]=e[i]}function Pl(s,e,t,i,n=[]){let o=i+e*t;for(let a=0;a<t;a++)n[a]=s[o+a];return n}function sy(s,e,t,i,n=[]){let o,a;if(t&8)o=(i[3]-s[1])/(e[1]-s[1]),a=3;else if(t&4)o=(i[1]-s[1])/(e[1]-s[1]),a=1;else if(t&2)o=(i[2]-s[0])/(e[0]-s[0]),a=2;else if(t&1)o=(i[0]-s[0])/(e[0]-s[0]),a=0;else return null;for(let l=0;l<s.length;l++)n[l]=(a&1)===l?i[a]:o*(e[l]-s[l])+s[l];return n}function rp(s,e){let t=0;return s[0]<e[0]?t|=1:s[0]>e[2]&&(t|=2),s[1]<e[1]?t|=4:s[1]>e[3]&&(t|=8),t}function ip(s,e){let{size:t=2,broken:i=!1,gridResolution:n=10,gridOffset:o=[0,0],startIndex:a=0,endIndex:l=s.length}=e||{},u=(l-a)/t,c=[],h=[c],d=Pl(s,0,t,a),f,p,S=PR(d,n,o,[]),E=[];Mi(c,d);for(let C=1;C<u;C++){for(f=Pl(s,C,t,a,f),p=rp(f,S);p;){sy(d,f,p,S,E);let O=rp(E,S);O&&(sy(d,E,O,S,E),p=O),Mi(c,E),tp(d,E),Q5(S,n,p),i&&c.length>t&&(c=[],h.push(c),Mi(c,d)),p=rp(f,S)}Mi(c,f),tp(d,f)}return i?h:h[0]}var mR=0,Z5=1;function ay(s,e){for(let t=0;t<e.length;t++)s.push(e[t]);return s}function np(s,e=null,t){if(!s.length)return[];let{size:i=2,gridResolution:n=10,gridOffset:o=[0,0],edgeTypes:a=!1}=t||{},l=[],u=[{pos:s,types:a?new Array(s.length/i).fill(Z5):null,holes:e||[]}],c=[[],[]],h=[];for(;u.length;){let{pos:d,types:f,holes:p}=u.shift();J5(d,i,p[0]||d.length,c),h=PR(c[0],n,o,h);let S=rp(c[1],h);if(S){let E=bR(d,f,i,0,p[0]||d.length,h,S),C={pos:E[0].pos,types:E[0].types,holes:[]},O={pos:E[1].pos,types:E[1].types,holes:[]};u.push(C,O);for(let B=0;B<p.length;B++)E=bR(d,f,i,p[B],p[B+1]||d.length,h,S),E[0]&&(C.holes.push(C.pos.length),C.pos=ay(C.pos,E[0].pos),a&&(C.types=ay(C.types,E[0].types))),E[1]&&(O.holes.push(O.pos.length),O.pos=ay(O.pos,E[1].pos),a&&(O.types=ay(O.types,E[1].types)))}else{let E={positions:d};a&&(E.edgeTypes=f),p.length&&(E.holeIndices=p),l.push(E)}}return l}function bR(s,e,t,i,n,o,a){let l=(n-i)/t,u=[],c=[],h=[],d=[],f=[],p,S,E,C=Pl(s,l-1,t,i),O=Math.sign(a&8?C[1]-o[3]:C[0]-o[2]),B=e&&e[l-1],A=0,N=0;for(let z=0;z<l;z++)p=Pl(s,z,t,i,p),S=Math.sign(a&8?p[1]-o[3]:p[0]-o[2]),E=e&&e[i/t+z],S&&O&&O!==S&&(sy(C,p,a,o,f),Mi(u,f)&&h.push(B),Mi(c,f)&&d.push(B)),S<=0?(Mi(u,p)&&h.push(E),A-=S):h.length&&(h[h.length-1]=mR),S>=0?(Mi(c,p)&&d.push(E),N+=S):d.length&&(d[d.length-1]=mR),tp(C,p),O=S,B=E;return[A?{pos:u,types:e&&h}:null,N?{pos:c,types:e&&d}:null]}function PR(s,e,t,i){let n=Math.floor((s[0]-t[0])/e)*e+t[0],o=Math.floor((s[1]-t[1])/e)*e+t[1];return i[0]=n,i[1]=o,i[2]=n+e,i[3]=o+e,i}function Q5(s,e,t){t&8?(s[1]+=e,s[3]+=e):t&4?(s[1]-=e,s[3]-=e):t&2?(s[0]+=e,s[2]+=e):t&1&&(s[0]-=e,s[2]-=e)}function J5(s,e,t,i){let n=1/0,o=-1/0,a=1/0,l=-1/0;for(let u=0;u<t;u+=e){let c=s[u],h=s[u+1];n=c<n?c:n,o=c>o?c:o,a=h<a?h:a,l=h>l?h:l}return i[0][0]=n,i[0][1]=a,i[1][0]=o,i[1][1]=l,i}var $5=85.051129;function Wx(s,e){let{size:t=2,startIndex:i=0,endIndex:n=s.length,normalize:o=!0}=e||{},a=s.slice(i,n);yR(a,t,0,n-i);let l=ip(a,{size:t,broken:!0,gridResolution:360,gridOffset:[-180,-180]});if(o)for(let u of l)SR(u,t);return l}function Hx(s,e=null,t){let{size:i=2,normalize:n=!0,edgeTypes:o=!1}=t||{};e=e||[];let a=[],l=[],u=0,c=0;for(let d=0;d<=e.length;d++){let f=e[d]||s.length,p=c,S=e4(s,i,u,f);for(let E=S;E<f;E++)a[c++]=s[E];for(let E=u;E<S;E++)a[c++]=s[E];yR(a,i,p,c),t4(a,i,p,c,t?.maxLatitude),u=f,l[d]=c}l.pop();let h=np(a,l,{size:i,gridResolution:360,gridOffset:[-180,-180],edgeTypes:o});if(n)for(let d of h)SR(d.positions,i);return h}function e4(s,e,t,i){let n=-1,o=-1;for(let a=t+1;a<i;a+=e){let l=Math.abs(s[a]);l>n&&(n=l,o=a-1)}return o}function t4(s,e,t,i,n=$5){let o=s[t],a=s[i-e];if(Math.abs(o-a)>180){let l=Pl(s,0,e,t);l[0]+=Math.round((a-o)/360)*360,Mi(s,l),l[1]=Math.sign(l[1])*n,Mi(s,l),l[0]=o,Mi(s,l)}}function yR(s,e,t,i){let n=s[0],o;for(let a=t;a<i;a+=e){o=s[a];let l=o-n;(l>180||l<-180)&&(o-=Math.round(l/360)*360),s[a]=n=o}}function SR(s,e){let t,i=s.length/e;for(let o=0;o<i&&(t=s[o*e],(t+180)%360===0);o++);let n=-Math.round(t/360)*360;if(n!==0)for(let o=0;o<i;o++)s[o*e]+=n}function ER(s,e,t,i){let n;if(Array.isArray(s[0])){let o=s.length*e;n=new Array(o);for(let a=0;a<s.length;a++)for(let l=0;l<e;l++)n[a*e+l]=s[a][l]||0}else n=s;return t?ip(n,{size:e,gridResolution:t}):i?Wx(n,{size:e}):n}var i4=1,n4=2,jx=4,op=class extends bl{constructor(e){super({...e,attributes:{positions:{size:3,padding:18,initialize:!0,type:e.fp64?Float64Array:Float32Array},segmentTypes:{size:1,type:Uint8ClampedArray}}})}get(e){return this.attributes[e]}getGeometryFromBuffer(e){return this.normalize?super.getGeometryFromBuffer(e):null}normalizeGeometry(e){return this.normalize?ER(e,this.positionSize,this.opts.resolution,this.opts.wrapLongitude):e}getGeometrySize(e){if(xR(e)){let i=0;for(let n of e)i+=this.getGeometrySize(n);return i}let t=this.getPathLength(e);return t<2?0:this.isClosed(e)?t<3?0:t+2:t}updateGeometryAttributes(e,t){if(t.geometrySize!==0)if(e&&xR(e))for(let i of e){let n=this.getGeometrySize(i);t.geometrySize=n,this.updateGeometryAttributes(i,t),t.vertexStart+=n}else this._updateSegmentTypes(e,t),this._updatePositions(e,t)}_updateSegmentTypes(e,t){let i=this.attributes.segmentTypes,n=e?this.isClosed(e):!1,{vertexStart:o,geometrySize:a}=t;i.fill(0,o,o+a),n?(i[o]=jx,i[o+a-2]=jx):(i[o]+=i4,i[o+a-2]+=n4),i[o+a-1]=jx}_updatePositions(e,t){let{positions:i}=this.attributes;if(!i||!e)return;let{vertexStart:n,geometrySize:o}=t,a=new Array(3);for(let l=n,u=0;u<o;l++,u++)this.getPointOnPath(e,u,a),i[l*3]=a[0],i[l*3+1]=a[1],i[l*3+2]=a[2]}getPathLength(e){return e.length/this.positionSize}getPointOnPath(e,t,i=[]){let{positionSize:n}=this;t*n>=e.length&&(t+=1-e.length/n);let o=t*n;return i[0]=e[o],i[1]=e[o+1],i[2]=n===3&&e[o+2]||0,i}isClosed(e){if(!this.normalize)return Boolean(this.opts.loop);let{positionSize:t}=this,i=e.length-t;return e[0]===e[i]&&e[1]===e[i+1]&&(t===2||e[2]===e[i+2])}};function xR(s){return Array.isArray(s[0])}var vR=`#define SHADER_NAME path-layer-vertex-shader

attribute vec2 positions;

attribute float instanceTypes;
attribute vec3 instanceStartPositions;
attribute vec3 instanceEndPositions;
attribute vec3 instanceLeftPositions;
attribute vec3 instanceRightPositions;
attribute vec3 instanceLeftPositions64Low;
attribute vec3 instanceStartPositions64Low;
attribute vec3 instanceEndPositions64Low;
attribute vec3 instanceRightPositions64Low;
attribute float instanceStrokeWidths;
attribute vec4 instanceColors;
attribute vec3 instancePickingColors;

uniform float widthScale;
uniform float widthMinPixels;
uniform float widthMaxPixels;
uniform float jointType;
uniform float capType;
uniform float miterLimit;
uniform bool billboard;
uniform int widthUnits;

uniform float opacity;

varying vec4 vColor;
varying vec2 vCornerOffset;
varying float vMiterLength;
varying vec2 vPathPosition;
varying float vPathLength;
varying float vJointType;

const float EPSILON = 0.001;
const vec3 ZERO_OFFSET = vec3(0.0);

float flipIfTrue(bool flag) {
  return -(float(flag) * 2. - 1.);
}

// calculate line join positions
vec3 lineJoin(
  vec3 prevPoint, vec3 currPoint, vec3 nextPoint,
  vec2 width
) {
  bool isEnd = positions.x > 0.0;
  // side of the segment - -1: left, 0: center, 1: right
  float sideOfPath = positions.y;
  float isJoint = float(sideOfPath == 0.0);

  vec3 deltaA3 = (currPoint - prevPoint);
  vec3 deltaB3 = (nextPoint - currPoint);

  mat3 rotationMatrix;
  bool needsRotation = !billboard && project_needs_rotation(currPoint, rotationMatrix);
  if (needsRotation) {
    deltaA3 = deltaA3 * rotationMatrix;
    deltaB3 = deltaB3 * rotationMatrix;
  }
  vec2 deltaA = deltaA3.xy / width;
  vec2 deltaB = deltaB3.xy / width;

  float lenA = length(deltaA);
  float lenB = length(deltaB);

  vec2 dirA = lenA > 0. ? normalize(deltaA) : vec2(0.0, 0.0);
  vec2 dirB = lenB > 0. ? normalize(deltaB) : vec2(0.0, 0.0);

  vec2 perpA = vec2(-dirA.y, dirA.x);
  vec2 perpB = vec2(-dirB.y, dirB.x);

  // tangent of the corner
  vec2 tangent = dirA + dirB;
  tangent = length(tangent) > 0. ? normalize(tangent) : perpA;
  // direction of the corner
  vec2 miterVec = vec2(-tangent.y, tangent.x);
  // direction of the segment
  vec2 dir = isEnd ? dirA : dirB;
  // direction of the extrusion
  vec2 perp = isEnd ? perpA : perpB;
  // length of the segment
  float L = isEnd ? lenA : lenB;

  // A = angle of the corner
  float sinHalfA = abs(dot(miterVec, perp));
  float cosHalfA = abs(dot(dirA, miterVec));

  // -1: right, 1: left
  float turnDirection = flipIfTrue(dirA.x * dirB.y >= dirA.y * dirB.x);

  // relative position to the corner:
  // -1: inside (smaller side of the angle)
  // 0: center
  // 1: outside (bigger side of the angle)
  float cornerPosition = sideOfPath * turnDirection;

  float miterSize = 1.0 / max(sinHalfA, EPSILON);
  // trim if inside corner extends further than the line segment
  miterSize = mix(
    min(miterSize, max(lenA, lenB) / max(cosHalfA, EPSILON)),
    miterSize,
    step(0.0, cornerPosition)
  );

  vec2 offsetVec = mix(miterVec * miterSize, perp, step(0.5, cornerPosition))
    * (sideOfPath + isJoint * turnDirection);

  // special treatment for start cap and end cap
  bool isStartCap = lenA == 0.0 || (!isEnd && (instanceTypes == 1.0 || instanceTypes == 3.0));
  bool isEndCap = lenB == 0.0 || (isEnd && (instanceTypes == 2.0 || instanceTypes == 3.0));
  bool isCap = isStartCap || isEndCap;

  // extend out a triangle to envelope the round cap
  if (isCap) {
    offsetVec = mix(perp * sideOfPath, dir * capType * 4.0 * flipIfTrue(isStartCap), isJoint);
    vJointType = capType;
  } else {
    vJointType = jointType;
  }

  // Generate variables for fragment shader
  vPathLength = L;
  vCornerOffset = offsetVec;
  vMiterLength = dot(vCornerOffset, miterVec * turnDirection);
  vMiterLength = isCap ? isJoint : vMiterLength;

  vec2 offsetFromStartOfPath = vCornerOffset + deltaA * float(isEnd);
  vPathPosition = vec2(
    dot(offsetFromStartOfPath, perp),
    dot(offsetFromStartOfPath, dir)
  );
  geometry.uv = vPathPosition;

  float isValid = step(instanceTypes, 3.5);
  vec3 offset = vec3(offsetVec * width * isValid, 0.0);

  if (needsRotation) {
    offset = rotationMatrix * offset;
  }
  return currPoint + offset;
}

// In clipspace extrusion, if a line extends behind the camera, clip it to avoid visual artifacts
void clipLine(inout vec4 position, vec4 refPosition) {
  if (position.w < EPSILON) {
    float r = (EPSILON - refPosition.w) / (position.w - refPosition.w);
    position = refPosition + (position - refPosition) * r;
  }
}

void main() {
  geometry.pickingColor = instancePickingColors;

  vColor = vec4(instanceColors.rgb, instanceColors.a * opacity);

  float isEnd = positions.x;

  vec3 prevPosition = mix(instanceLeftPositions, instanceStartPositions, isEnd);
  vec3 prevPosition64Low = mix(instanceLeftPositions64Low, instanceStartPositions64Low, isEnd);

  vec3 currPosition = mix(instanceStartPositions, instanceEndPositions, isEnd);
  vec3 currPosition64Low = mix(instanceStartPositions64Low, instanceEndPositions64Low, isEnd);

  vec3 nextPosition = mix(instanceEndPositions, instanceRightPositions, isEnd);
  vec3 nextPosition64Low = mix(instanceEndPositions64Low, instanceRightPositions64Low, isEnd);

  geometry.worldPosition = currPosition;
  vec2 widthPixels = vec2(clamp(
    project_size_to_pixel(instanceStrokeWidths * widthScale, widthUnits),
    widthMinPixels, widthMaxPixels) / 2.0);
  vec3 width;

  if (billboard) {
    // Extrude in clipspace
    vec4 prevPositionScreen = project_position_to_clipspace(prevPosition, prevPosition64Low, ZERO_OFFSET);
    vec4 currPositionScreen = project_position_to_clipspace(currPosition, currPosition64Low, ZERO_OFFSET, geometry.position);
    vec4 nextPositionScreen = project_position_to_clipspace(nextPosition, nextPosition64Low, ZERO_OFFSET);

    clipLine(prevPositionScreen, currPositionScreen);
    clipLine(nextPositionScreen, currPositionScreen);
    clipLine(currPositionScreen, mix(nextPositionScreen, prevPositionScreen, isEnd));

    width = vec3(widthPixels, 0.0);
    DECKGL_FILTER_SIZE(width, geometry);

    vec3 pos = lineJoin(
      prevPositionScreen.xyz / prevPositionScreen.w,
      currPositionScreen.xyz / currPositionScreen.w,
      nextPositionScreen.xyz / nextPositionScreen.w,
      project_pixel_size_to_clipspace(width.xy)
    );

    gl_Position = vec4(pos * currPositionScreen.w, currPositionScreen.w);
  } else {
    // Extrude in commonspace
    prevPosition = project_position(prevPosition, prevPosition64Low);
    currPosition = project_position(currPosition, currPosition64Low);
    nextPosition = project_position(nextPosition, nextPosition64Low);

    width = vec3(project_pixel_size(widthPixels), 0.0);
    DECKGL_FILTER_SIZE(width, geometry);

    vec4 pos = vec4(
      lineJoin(prevPosition, currPosition, nextPosition, width.xy),
      1.0);
    geometry.position = pos;
    gl_Position = project_common_position_to_clipspace(pos);
  }
  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
  DECKGL_FILTER_COLOR(vColor, geometry);
}
`;var CR=`#define SHADER_NAME path-layer-fragment-shader

precision highp float;

uniform float miterLimit;

varying vec4 vColor;
varying vec2 vCornerOffset;
varying float vMiterLength;
/*
 * vPathPosition represents the relative coordinates of the current fragment on the path segment.
 * vPathPosition.x - position along the width of the path, between [-1, 1]. 0 is the center line.
 * vPathPosition.y - position along the length of the path, between [0, L / width].
 */
varying vec2 vPathPosition;
varying float vPathLength;
varying float vJointType;

void main(void) {
  geometry.uv = vPathPosition;

  if (vPathPosition.y < 0.0 || vPathPosition.y > vPathLength) {
    // if joint is rounded, test distance from the corner
    if (vJointType > 0.5 && length(vCornerOffset) > 1.0) {
      discard;
    }
    // trim miter
    if (vJointType < 0.5 && vMiterLength > miterLimit + 1.0) {
      discard;
    }
  }
  gl_FragColor = vColor;

  DECKGL_FILTER_COLOR(gl_FragColor, geometry);
}
`;var AR=[0,0,0,255],o4={widthUnits:"meters",widthScale:{type:"number",min:0,value:1},widthMinPixels:{type:"number",min:0,value:0},widthMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},jointRounded:!1,capRounded:!1,miterLimit:{type:"number",min:0,value:4},billboard:!1,_pathType:null,getPath:{type:"accessor",value:s=>s.path},getColor:{type:"accessor",value:AR},getWidth:{type:"accessor",value:1},rounded:{deprecatedFor:["jointRounded","capRounded"]}},qx={enter:(s,e)=>e.length?e.subarray(e.length-s.length):s},$u=class extends kt{constructor(...e){super(...e),y(this,"state",void 0)}getShaders(){return super.getShaders({vs:vR,fs:CR,modules:[ai,Bn]})}get wrapLongitude(){return!1}initializeState(){this.getAttributeManager().addInstanced({positions:{size:3,vertexOffset:1,type:5130,fp64:this.use64bitPositions(),transition:qx,accessor:"getPath",update:this.calculatePositions,noAlloc:!0,shaderAttributes:{instanceLeftPositions:{vertexOffset:0},instanceStartPositions:{vertexOffset:1},instanceEndPositions:{vertexOffset:2},instanceRightPositions:{vertexOffset:3}}},instanceTypes:{size:1,type:5121,update:this.calculateSegmentTypes,noAlloc:!0},instanceStrokeWidths:{size:1,accessor:"getWidth",transition:qx,defaultValue:1},instanceColors:{size:this.props.colorFormat.length,type:5121,normalized:!0,accessor:"getColor",transition:qx,defaultValue:AR},instancePickingColors:{size:3,type:5121,accessor:(i,{index:n,target:o})=>this.encodePickingColor(i&&i.__source?i.__source.index:n,o)}}),this.setState({pathTesselator:new op({fp64:this.use64bitPositions()})})}updateState(e){super.updateState(e);let{props:t,changeFlags:i}=e,n=this.getAttributeManager();if(i.dataChanged||i.updateTriggersChanged&&(i.updateTriggersChanged.all||i.updateTriggersChanged.getPath)){let{pathTesselator:l}=this.state,u=t.data.attributes||{};l.updateGeometry({data:t.data,geometryBuffer:u.getPath,buffers:u,normalize:!t._pathType,loop:t._pathType==="loop",getGeometry:t.getPath,positionFormat:t.positionFormat,wrapLongitude:t.wrapLongitude,resolution:this.context.viewport.resolution,dataChanged:i.dataChanged}),this.setState({numInstances:l.instanceCount,startIndices:l.vertexStarts}),i.dataChanged||n.invalidateAll()}if(i.extensionsChanged){var a;let{gl:l}=this.context;(a=this.state.model)===null||a===void 0||a.delete(),this.state.model=this._getModel(l),n.invalidateAll()}}getPickingInfo(e){let t=super.getPickingInfo(e),{index:i}=t,{data:n}=this.props;return n[0]&&n[0].__source&&(t.object=n.find(o=>o.__source.index===i)),t}disablePickingIndex(e){let{data:t}=this.props;if(t[0]&&t[0].__source)for(let i=0;i<t.length;i++)t[i].__source.index===e&&this._disablePickingIndex(i);else this._disablePickingIndex(e)}draw({uniforms:e}){let{jointRounded:t,capRounded:i,billboard:n,miterLimit:o,widthUnits:a,widthScale:l,widthMinPixels:u,widthMaxPixels:c}=this.props;this.state.model.setUniforms(e).setUniforms({jointType:Number(t),capType:Number(i),billboard:n,widthUnits:Ur[a],widthScale:l,miterLimit:o,widthMinPixels:u,widthMaxPixels:c}).draw()}_getModel(e){let t=[0,1,2,1,4,2,1,3,4,3,5,4],i=[0,0,0,-1,0,1,1,-1,1,1,1,0];return new At(e,{...this.getShaders(),id:this.props.id,geometry:new pr({drawMode:4,attributes:{indices:new Uint16Array(t),positions:{value:new Float32Array(i),size:2}}}),isInstanced:!0})}calculatePositions(e){let{pathTesselator:t}=this.state;e.startIndices=t.vertexStarts,e.value=t.get("positions")}calculateSegmentTypes(e){let{pathTesselator:t}=this.state;e.startIndices=t.vertexStarts,e.value=t.get("segmentTypes")}};y($u,"defaultProps",o4);y($u,"layerName","PathLayer");var MR=Ae(RR());var dy=ny.CLOCKWISE,OR=ny.COUNTER_CLOCKWISE,yl={isClosed:!0};function E4(s){if(s=s&&s.positions||s,!Array.isArray(s)&&!ArrayBuffer.isView(s))throw new Error("invalid polygon")}function Jh(s){return"positions"in s?s.positions:s}function up(s){return"holeIndices"in s?s.holeIndices:null}function x4(s){return Array.isArray(s[0])}function v4(s){return s.length>=1&&s[0].length>=2&&Number.isFinite(s[0][0])}function C4(s){let e=s[0],t=s[s.length-1];return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}function A4(s,e,t,i){for(let n=0;n<e;n++)if(s[t+n]!==s[i-e+n])return!1;return!0}function _R(s,e,t,i,n){let o=e,a=t.length;for(let l=0;l<a;l++)for(let u=0;u<i;u++)s[o++]=t[l][u]||0;if(!C4(t))for(let l=0;l<i;l++)s[o++]=t[0][l]||0;return yl.start=e,yl.end=o,yl.size=i,ep(s,n,yl),o}function NR(s,e,t,i,n=0,o,a){o=o||t.length;let l=o-n;if(l<=0)return e;let u=e;for(let c=0;c<l;c++)s[u++]=t[n+c];if(!A4(t,i,n,o))for(let c=0;c<i;c++)s[u++]=t[n+c];return yl.start=e,yl.end=u,yl.size=i,ep(s,a,yl),u}function BR(s,e){E4(s);let t=[],i=[];if("positions"in s){let{positions:n,holeIndices:o}=s;if(o){let a=0;for(let l=0;l<=o.length;l++)a=NR(t,a,n,e,o[l-1],o[l],l===0?dy:OR),i.push(a);return i.pop(),{positions:t,holeIndices:i}}s=n}if(!x4(s))return NR(t,0,s,e,0,t.length,dy),t;if(!v4(s)){let n=0;for(let[o,a]of s.entries())n=_R(t,n,a,e,o===0?dy:OR),i.push(n);return i.pop(),{positions:t,holeIndices:i}}return _R(t,0,s,e,dy),t}function DR(s,e,t){let i=up(s);i&&(i=i.map(o=>o/e));let n=Jh(s);if(t){let o=n.length;n=n.slice();let a=[];for(let l=0;l<o;l+=e){a[0]=n[l],a[1]=n[l+1];let u=t(a);n[l]=u[0],n[l+1]=u[1]}}return(0,MR.default)(n,i,e)}var cp=class extends bl{constructor(e){let{fp64:t,IndexType:i=Uint32Array}=e;super({...e,attributes:{positions:{size:3,type:t?Float64Array:Float32Array},vertexValid:{type:Uint8ClampedArray,size:1},indices:{type:i,size:1}}})}get(e){let{attributes:t}=this;return e==="indices"?t.indices&&t.indices.subarray(0,this.vertexCount):t[e]}updateGeometry(e){super.updateGeometry(e);let t=this.buffers.indices;if(t)this.vertexCount=(t.value||t).length;else if(this.data&&!this.getGeometry)throw new Error("missing indices buffer")}normalizeGeometry(e){if(this.normalize){let t=BR(e,this.positionSize);return this.opts.resolution?np(Jh(t),up(t),{size:this.positionSize,gridResolution:this.opts.resolution,edgeTypes:!0}):this.opts.wrapLongitude?Hx(Jh(t),up(t),{size:this.positionSize,maxLatitude:86,edgeTypes:!0}):t}return e}getGeometrySize(e){if(GR(e)){let t=0;for(let i of e)t+=this.getGeometrySize(i);return t}return Jh(e).length/this.positionSize}getGeometryFromBuffer(e){return this.normalize||!this.buffers.indices?super.getGeometryFromBuffer(e):null}updateGeometryAttributes(e,t){if(e&&GR(e))for(let i of e){let n=this.getGeometrySize(i);t.geometrySize=n,this.updateGeometryAttributes(i,t),t.vertexStart+=n,t.indexStart=this.indexStarts[t.geometryIndex+1]}else this._updateIndices(e,t),this._updatePositions(e,t),this._updateVertexValid(e,t)}_updateIndices(e,{geometryIndex:t,vertexStart:i,indexStart:n}){let{attributes:o,indexStarts:a,typedArrayManager:l}=this,u=o.indices;if(!u||!e)return;let c=n,h=DR(e,this.positionSize,this.opts.preproject);u=l.allocate(u,n+h.length,{copy:!0});for(let d=0;d<h.length;d++)u[c++]=h[d]+i;a[t+1]=n+h.length,o.indices=u}_updatePositions(e,{vertexStart:t,geometrySize:i}){let{attributes:{positions:n},positionSize:o}=this;if(!n||!e)return;let a=Jh(e);for(let l=t,u=0;u<i;l++,u++){let c=a[u*o],h=a[u*o+1],d=o>2?a[u*o+2]:0;n[l*3]=c,n[l*3+1]=h,n[l*3+2]=d}}_updateVertexValid(e,{vertexStart:t,geometrySize:i}){let{positionSize:n}=this,o=this.attributes.vertexValid,a=e&&up(e);if(e&&e.edgeTypes?o.set(e.edgeTypes,t):o.fill(1,t,t+i),a)for(let l=0;l<a.length;l++)o[t+a[l]/n-1]=0;o[t+i-1]=0}};function GR(s){return Array.isArray(s)&&s.length>0&&!Number.isFinite(s[0])}var fy=`
attribute vec2 vertexPositions;
attribute float vertexValid;

uniform bool extruded;
uniform bool isWireframe;
uniform float elevationScale;
uniform float opacity;

varying vec4 vColor;

struct PolygonProps {
  vec4 fillColors;
  vec4 lineColors;
  vec3 positions;
  vec3 nextPositions;
  vec3 pickingColors;
  vec3 positions64Low;
  vec3 nextPositions64Low;
  float elevations;
};

vec3 project_offset_normal(vec3 vector) {
  if (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT ||
    project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT_OFFSETS) {
    // normals generated by the polygon tesselator are in lnglat offsets instead of meters
    return normalize(vector * project_uCommonUnitsPerWorldUnit);
  }
  return project_normal(vector);
}

void calculatePosition(PolygonProps props) {
#ifdef IS_SIDE_VERTEX
  if(vertexValid < 0.5){
    gl_Position = vec4(0.);
    return;
  }
#endif

  vec3 pos;
  vec3 pos64Low;
  vec3 normal;
  vec4 colors = isWireframe ? props.lineColors : props.fillColors;

  geometry.worldPosition = props.positions;
  geometry.worldPositionAlt = props.nextPositions;
  geometry.pickingColor = props.pickingColors;

#ifdef IS_SIDE_VERTEX
  pos = mix(props.positions, props.nextPositions, vertexPositions.x);
  pos64Low = mix(props.positions64Low, props.nextPositions64Low, vertexPositions.x);
#else
  pos = props.positions;
  pos64Low = props.positions64Low;
#endif

  if (extruded) {
    pos.z += props.elevations * vertexPositions.y * elevationScale;
  }
  gl_Position = project_position_to_clipspace(pos, pos64Low, vec3(0.), geometry.position);

  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);

  if (extruded) {
  #ifdef IS_SIDE_VERTEX
    normal = vec3(
      props.positions.y - props.nextPositions.y + (props.positions64Low.y - props.nextPositions64Low.y),
      props.nextPositions.x - props.positions.x + (props.nextPositions64Low.x - props.positions64Low.x),
      0.0);
    normal = project_offset_normal(normal);
  #else
    normal = project_normal(vec3(0.0, 0.0, 1.0));
  #endif
    geometry.normal = normal;
    vec3 lightColor = lighting_getLightColor(colors.rgb, project_uCameraPosition, geometry.position.xyz, normal);
    vColor = vec4(lightColor, colors.a * opacity);
  } else {
    vColor = vec4(colors.rgb, colors.a * opacity);
  }
  DECKGL_FILTER_COLOR(vColor, geometry);
}
`;var FR=`#define SHADER_NAME solid-polygon-layer-vertex-shader

attribute vec3 positions;
attribute vec3 positions64Low;
attribute float elevations;
attribute vec4 fillColors;
attribute vec4 lineColors;
attribute vec3 pickingColors;

`.concat(fy,`

void main(void) {
  PolygonProps props;

  props.positions = positions;
  props.positions64Low = positions64Low;
  props.elevations = elevations;
  props.fillColors = fillColors;
  props.lineColors = lineColors;
  props.pickingColors = pickingColors;

  calculatePosition(props);
}
`);var kR=`#define SHADER_NAME solid-polygon-layer-vertex-shader-side
#define IS_SIDE_VERTEX


attribute vec3 instancePositions;
attribute vec3 nextPositions;
attribute vec3 instancePositions64Low;
attribute vec3 nextPositions64Low;
attribute float instanceElevations;
attribute vec4 instanceFillColors;
attribute vec4 instanceLineColors;
attribute vec3 instancePickingColors;

`.concat(fy,`

void main(void) {
  PolygonProps props;

  #if RING_WINDING_ORDER_CW == 1
    props.positions = instancePositions;
    props.positions64Low = instancePositions64Low;
    props.nextPositions = nextPositions;
    props.nextPositions64Low = nextPositions64Low;
  #else
    props.positions = nextPositions;
    props.positions64Low = nextPositions64Low;
    props.nextPositions = instancePositions;
    props.nextPositions64Low = instancePositions64Low;
  #endif
  props.elevations = instanceElevations;
  props.fillColors = instanceFillColors;
  props.lineColors = instanceLineColors;
  props.pickingColors = instancePickingColors;

  calculatePosition(props);
}
`);var VR=`#define SHADER_NAME solid-polygon-layer-fragment-shader

precision highp float;

varying vec4 vColor;

void main(void) {
  gl_FragColor = vColor;

  DECKGL_FILTER_COLOR(gl_FragColor, geometry);
}
`;var py=[0,0,0,255],I4={filled:!0,extruded:!1,wireframe:!1,_normalize:!0,_windingOrder:"CW",elevationScale:{type:"number",min:0,value:1},getPolygon:{type:"accessor",value:s=>s.polygon},getElevation:{type:"accessor",value:1e3},getFillColor:{type:"accessor",value:py},getLineColor:{type:"accessor",value:py},material:!0},gy={enter:(s,e)=>e.length?e.subarray(e.length-s.length):s},tc=class extends kt{constructor(...e){super(...e),y(this,"state",void 0)}getShaders(e){return super.getShaders({vs:e==="top"?FR:kR,fs:VR,defines:{RING_WINDING_ORDER_CW:!this.props._normalize&&this.props._windingOrder==="CCW"?0:1},modules:[ai,Bh,Bn]})}get wrapLongitude(){return!1}initializeState(){let{gl:e,viewport:t}=this.context,{coordinateSystem:i}=this.props;t.isGeospatial&&i===Ge.DEFAULT&&(i=Ge.LNGLAT),this.setState({numInstances:0,polygonTesselator:new cp({preproject:i===Ge.LNGLAT&&t.projectFlat.bind(t),fp64:this.use64bitPositions(),IndexType:!e||ol(e,et.ELEMENT_INDEX_UINT32)?Uint32Array:Uint16Array})});let n=this.getAttributeManager(),o=!0;n.remove(["instancePickingColors"]),n.add({indices:{size:1,isIndexed:!0,update:this.calculateIndices,noAlloc:o},positions:{size:3,type:5130,fp64:this.use64bitPositions(),transition:gy,accessor:"getPolygon",update:this.calculatePositions,noAlloc:o,shaderAttributes:{positions:{vertexOffset:0,divisor:0},instancePositions:{vertexOffset:0,divisor:1},nextPositions:{vertexOffset:1,divisor:1}}},vertexValid:{size:1,divisor:1,type:5121,update:this.calculateVertexValid,noAlloc:o},elevations:{size:1,transition:gy,accessor:"getElevation",shaderAttributes:{elevations:{divisor:0},instanceElevations:{divisor:1}}},fillColors:{size:this.props.colorFormat.length,type:5121,normalized:!0,transition:gy,accessor:"getFillColor",defaultValue:py,shaderAttributes:{fillColors:{divisor:0},instanceFillColors:{divisor:1}}},lineColors:{size:this.props.colorFormat.length,type:5121,normalized:!0,transition:gy,accessor:"getLineColor",defaultValue:py,shaderAttributes:{lineColors:{divisor:0},instanceLineColors:{divisor:1}}},pickingColors:{size:3,type:5121,accessor:(a,{index:l,target:u})=>this.encodePickingColor(a&&a.__source?a.__source.index:l,u),shaderAttributes:{pickingColors:{divisor:0},instancePickingColors:{divisor:1}}}})}getPickingInfo(e){let t=super.getPickingInfo(e),{index:i}=t,{data:n}=this.props;return n[0]&&n[0].__source&&(t.object=n.find(o=>o.__source.index===i)),t}disablePickingIndex(e){let{data:t}=this.props;if(t[0]&&t[0].__source)for(let i=0;i<t.length;i++)t[i].__source.index===e&&this._disablePickingIndex(i);else this._disablePickingIndex(e)}draw({uniforms:e}){let{extruded:t,filled:i,wireframe:n,elevationScale:o}=this.props,{topModel:a,sideModel:l,polygonTesselator:u}=this.state,c={...e,extruded:Boolean(t),elevationScale:o};l&&(l.setInstanceCount(u.instanceCount-1),l.setUniforms(c),n&&(l.setDrawMode(3),l.setUniforms({isWireframe:!0}).draw()),i&&(l.setDrawMode(6),l.setUniforms({isWireframe:!1}).draw())),a&&(a.setVertexCount(u.vertexCount),a.setUniforms(c).draw())}updateState(e){super.updateState(e),this.updateGeometry(e);let{props:t,oldProps:i,changeFlags:n}=e,o=this.getAttributeManager();if(n.extensionsChanged||t.filled!==i.filled||t.extruded!==i.extruded){var l;(l=this.state.models)===null||l===void 0||l.forEach(u=>u.delete()),this.setState(this._getModels(this.context.gl)),o.invalidateAll()}}updateGeometry({props:e,oldProps:t,changeFlags:i}){if(i.dataChanged||i.updateTriggersChanged&&(i.updateTriggersChanged.all||i.updateTriggersChanged.getPolygon)){let{polygonTesselator:o}=this.state,a=e.data.attributes||{};o.updateGeometry({data:e.data,normalize:e._normalize,geometryBuffer:a.getPolygon,buffers:a,getGeometry:e.getPolygon,positionFormat:e.positionFormat,wrapLongitude:e.wrapLongitude,resolution:this.context.viewport.resolution,fp64:this.use64bitPositions(),dataChanged:i.dataChanged}),this.setState({numInstances:o.instanceCount,startIndices:o.vertexStarts}),i.dataChanged||this.getAttributeManager().invalidateAll()}}_getModels(e){let{id:t,filled:i,extruded:n}=this.props,o,a;if(i){let l=this.getShaders("top");l.defines.NON_INSTANCED_MODEL=1,o=new At(e,{...l,id:"".concat(t,"-top"),drawMode:4,attributes:{vertexPositions:new Float32Array([0,1])},uniforms:{isWireframe:!1,isSideVertex:!1},vertexCount:0,isIndexed:!0})}return n&&(a=new At(e,{...this.getShaders("side"),id:"".concat(t,"-side"),geometry:new pr({drawMode:1,vertexCount:4,attributes:{vertexPositions:{size:2,value:new Float32Array([1,0,0,0,0,1,1,1])}}}),instanceCount:0,isInstanced:1}),a.userData.excludeAttributes={indices:!0}),{models:[a,o].filter(Boolean),topModel:o,sideModel:a}}calculateIndices(e){let{polygonTesselator:t}=this.state;e.startIndices=t.indexStarts,e.value=t.get("indices")}calculatePositions(e){let{polygonTesselator:t}=this.state;e.startIndices=t.vertexStarts,e.value=t.get("positions")}calculateVertexValid(e){e.value=this.state.polygonTesselator.get("vertexValid")}};y(tc,"defaultProps",I4);y(tc,"layerName","SolidPolygonLayer");function UR({data:s,getIndex:e,dataRange:t,replace:i}){let{startRow:n=0,endRow:o=1/0}=t,a=s.length,l=a,u=a;for(let f=0;f<a;f++){let p=e(s[f]);if(l>f&&p>=n&&(l=f),p>=o){u=f;break}}let c=l,d=u-l!==i.length?s.slice(u):void 0;for(let f=0;f<i.length;f++)s[c++]=i[f];if(d){for(let f=0;f<d.length;f++)s[c++]=d[f];s.length=c}return{startRow:l,endRow:l+i.length}}function zR(s,e){if(!s)return null;let t="startIndices"in s?s.startIndices[e]:e,i=s.featureIds.value[t];return t!==-1?w4(s,i,t):null}function w4(s,e,t){let i={properties:{...s.properties[e]}};for(let n in s.numericProps)i.properties[n]=s.numericProps[n].value[t];return i}function WR(s,e){let t={points:null,lines:null,polygons:null};for(let i in t){let n=s[i].globalFeatureIds.value;t[i]=new Uint8ClampedArray(n.length*3);let o=[];for(let a=0;a<n.length;a++)e(n[a],o),t[i][a*3+0]=o[0],t[i][a*3+1]=o[1],t[i][a*3+2]=o[2]}return t}var HR=`#define SHADER_NAME multi-icon-layer-fragment-shader

precision highp float;

uniform float opacity;
uniform sampler2D iconsTexture;
uniform float gamma;
uniform bool sdf;
uniform float alphaCutoff;
uniform float buffer;
uniform float outlineBuffer;
uniform vec4 outlineColor;

varying vec4 vColor;
varying vec2 vTextureCoords;
varying vec2 uv;

void main(void) {
  geometry.uv = uv;

  if (!picking_uActive) {
    float alpha = texture2D(iconsTexture, vTextureCoords).a;
    vec4 color = vColor;

    // if enable sdf (signed distance fields)
    if (sdf) {
      float distance = alpha;
      alpha = smoothstep(buffer - gamma, buffer + gamma, distance);

      if (outlineBuffer > 0.0) {
        float inFill = alpha;
        float inBorder = smoothstep(outlineBuffer - gamma, outlineBuffer + gamma, distance);
        color = mix(outlineColor, vColor, inFill);
        alpha = inBorder;
      }
    }

    // Take the global opacity and the alpha from color into account for the alpha component
    float a = alpha * color.a;
    
    if (a < alphaCutoff) {
      discard;
    }

    gl_FragColor = vec4(color.rgb, a * opacity);
  }

  DECKGL_FILTER_COLOR(gl_FragColor, geometry);
}
`;var jR=192/256,qR=[],L4={getIconOffsets:{type:"accessor",value:s=>s.offsets},alphaCutoff:.001,smoothing:.1,outlineWidth:0,outlineColor:{type:"color",value:[0,0,0,255]}},rc=class extends Gn{constructor(...e){super(...e),y(this,"state",void 0)}getShaders(){return{...super.getShaders(),fs:HR}}initializeState(){super.initializeState(),this.getAttributeManager().addInstanced({instanceOffsets:{size:2,accessor:"getIconOffsets"},instancePickingColors:{type:5121,size:3,accessor:(t,{index:i,target:n})=>this.encodePickingColor(i,n)}})}updateState(e){super.updateState(e);let{props:t,oldProps:i}=e,{outlineColor:n}=t;n!==i.outlineColor&&(n=n.map(o=>o/255),n[3]=Number.isFinite(n[3])?n[3]:1,this.setState({outlineColor:n})),!t.sdf&&t.outlineWidth&&fe.warn("".concat(this.id,": fontSettings.sdf is required to render outline"))()}draw(e){let{sdf:t,smoothing:i,outlineWidth:n}=this.props,{outlineColor:o}=this.state;e.uniforms={...e.uniforms,buffer:jR,outlineBuffer:n?Math.max(i,jR*(1-n)):-1,gamma:i,sdf:Boolean(t),outlineColor:o},super.draw(e)}getInstanceOffset(e){return e?Array.from(e).flatMap(t=>super.getInstanceOffset(t)):qR}getInstanceColorMode(e){return 1}getInstanceIconFrame(e){return e?Array.from(e).flatMap(t=>super.getInstanceIconFrame(t)):qR}};y(rc,"defaultProps",L4);y(rc,"layerName","MultiIconLayer");var iO=Ae(KR());var _4=32,N4=[];function M4(s){return Math.pow(2,Math.ceil(Math.log2(s)))}function ZR({characterSet:s,getFontWidth:e,fontHeight:t,buffer:i,maxCanvasWidth:n,mapping:o={},xOffset:a=0,yOffset:l=0}){let u=0,c=a;for(let d of s)if(!o[d]){let f=e(d);c+f+i*2>n&&(c=0,u++),o[d]={x:c+i,y:l+u*(t+i*2)+i,width:f,height:t},c+=f+i*2}let h=t+i*2;return{mapping:o,xOffset:c,yOffset:l+u*h,canvasHeight:M4(l+(u+1)*h)}}function QR(s,e,t,i){let n=0;for(let a=e;a<t;a++){var o;let l=s[a];n+=((o=i[l])===null||o===void 0?void 0:o.width)||0}return n}function JR(s,e,t,i,n,o){let a=e,l=0;for(let u=e;u<t;u++){let c=QR(s,u,u+1,n);l+c>i&&(a<u&&o.push(u),a=u,l=0),l+=c}return l}function B4(s,e,t,i,n,o){let a=e,l=e,u=e,c=0;for(let h=e;h<t;h++)if((s[h]===" "||s[h+1]===" "||h+1===t)&&(u=h+1),u>l){let d=QR(s,l,u,n);c+d>i&&(a<l&&(o.push(l),a=l,c=0),d>i&&(d=JR(s,l,u,i,n,o),a=o[o.length-1])),l=u,c+=d}return c}function D4(s,e,t,i,n=0,o){o===void 0&&(o=s.length);let a=[];return e==="break-all"?JR(s,n,o,t,i,a):B4(s,n,o,t,i,a),a}function G4(s,e,t,i,n,o){let a=0,l=0;for(let u=e;u<t;u++){let c=s[u],h=i[c];h?(l||(l=h.height),n[u]=a+h.width/2,a+=h.width):(fe.warn("Missing character: ".concat(c," (").concat(c.codePointAt(0),")"))(),n[u]=a,a+=_4)}o[0]=a,o[1]=l}function Jx(s,e,t,i,n){let o=Array.from(s),a=o.length,l=new Array(a),u=new Array(a),c=new Array(a),h=(t==="break-word"||t==="break-all")&&isFinite(i)&&i>0,d=[0,0],f=[0,0],p=0,S=0,E=0;for(let C=0;C<=a;C++){let O=o[C];if((O===`
`||C===a)&&(E=C),E>S){let B=h?D4(o,t,i,n,S,E):N4;for(let A=0;A<=B.length;A++){let N=A===0?S:B[A-1],z=A<B.length?B[A]:E;G4(o,N,z,n,l,f);for(let Y=N;Y<z;Y++)u[Y]=p+f[1]/2,c[Y]=f[0];p=p+f[1]*e,d[0]=Math.max(d[0],f[0])}S=E}O===`
`&&(l[S]=0,u[S]=0,c[S]=0,S++)}return d[1]=p,{x:l,y:u,rowWidth:c,size:d}}function $R({value:s,length:e,stride:t,offset:i,startIndices:n,characterSet:o}){let a=s.BYTES_PER_ELEMENT,l=t?t/a:1,u=i?i/a:0,c=n[e]||Math.ceil((s.length-u)/l),h=o&&new Set,d=new Array(e),f=s;if(l>1||u>0){let p=s.constructor;f=new p(c);for(let S=0;S<c;S++)f[S]=s[S*l+u]}for(let p=0;p<e;p++){let S=n[p],E=n[p+1]||c,C=f.subarray(S,E);d[p]=String.fromCodePoint.apply(null,C),h&&C.forEach(h.add,h)}if(h)for(let p of h)o.add(String.fromCodePoint(p));return{texts:d,characterCount:c}}var ed=class{constructor(e=5){y(this,"limit",void 0),y(this,"_cache",{}),y(this,"_order",[]),this.limit=e}get(e){let t=this._cache[e];return t&&(this._deleteOrder(e),this._appendOrder(e)),t}set(e,t){this._cache[e]?(this.delete(e),this._cache[e]=t,this._appendOrder(e)):(Object.keys(this._cache).length===this.limit&&this.delete(this._order[0]),this._cache[e]=t,this._appendOrder(e))}delete(e){this._cache[e]&&(delete this._cache[e],this._deleteOrder(e))}_deleteOrder(e){let t=this._order.indexOf(e);t>=0&&this._order.splice(t,1)}_appendOrder(e){this._order.push(e)}};function F4(){let s=[];for(let e=32;e<128;e++)s.push(String.fromCharCode(e));return s}var td={fontFamily:"Monaco, monospace",fontWeight:"normal",characterSet:F4(),fontSize:64,buffer:4,sdf:!1,cutoff:.25,radius:12,smoothing:.1},eO=1024,k4=.9,tO=1.2,nO=3,my=new ed(nO);function V4(s,e){let t;typeof e=="string"?t=new Set(Array.from(e)):t=new Set(e);let i=my.get(s);if(!i)return t;for(let n in i.mapping)t.has(n)&&t.delete(n);return t}function U4(s,e){for(let t=0;t<s.length;t++)e.data[4*t+3]=s[t]}function rO(s,e,t,i){s.font="".concat(i," ").concat(t,"px ").concat(e),s.fillStyle="#000",s.textBaseline="alphabetic",s.textAlign="left"}function oO(s){fe.assert(Number.isFinite(s)&&s>=nO,"Invalid cache limit"),my=new ed(s)}var dp=class{constructor(){y(this,"props",{...td}),y(this,"_key",void 0),y(this,"_atlas",void 0)}get texture(){return this._atlas}get mapping(){return this._atlas&&this._atlas.mapping}get scale(){return tO}setProps(e={}){Object.assign(this.props,e);let t=this._key;this._key=this._getKey();let i=V4(this._key,this.props.characterSet),n=my.get(this._key);if(n&&i.size===0){this._key!==t&&(this._atlas=n);return}let o=this._generateFontAtlas(this._key,i,n);this._atlas=o,my.set(this._key,o)}_generateFontAtlas(e,t,i){let{fontFamily:n,fontWeight:o,fontSize:a,buffer:l,sdf:u,radius:c,cutoff:h}=this.props,d=i&&i.data;d||(d=document.createElement("canvas"),d.width=eO);let f=d.getContext("2d");rO(f,n,a,o);let{mapping:p,canvasHeight:S,xOffset:E,yOffset:C}=ZR({getFontWidth:O=>f.measureText(O).width,fontHeight:a*tO,buffer:l,characterSet:t,maxCanvasWidth:eO,...i&&{mapping:i.mapping,xOffset:i.xOffset,yOffset:i.yOffset}});if(d.height!==S){let O=f.getImageData(0,0,d.width,d.height);d.height=S,f.putImageData(O,0,0)}if(rO(f,n,a,o),u){let O=new iO.default(a,l,c,h,n,o),B=f.getImageData(0,0,O.size,O.size);for(let A of t)U4(O.draw(A),B),f.putImageData(B,p[A].x-l,p[A].y+l)}else for(let O of t)f.fillText(O,p[O].x,p[O].y+a*k4);return{xOffset:E,yOffset:C,mapping:p,data:d,width:d.width,height:d.height}}_getKey(){let{fontFamily:e,fontWeight:t,fontSize:i,buffer:n,sdf:o,radius:a,cutoff:l}=this.props;return o?"".concat(e," ").concat(t," ").concat(i," ").concat(n," ").concat(a," ").concat(l):"".concat(e," ").concat(t," ").concat(i," ").concat(n)}};var sO=`#define SHADER_NAME text-background-layer-vertex-shader

attribute vec2 positions;

attribute vec3 instancePositions;
attribute vec3 instancePositions64Low;
attribute vec4 instanceRects;
attribute float instanceSizes;
attribute float instanceAngles;
attribute vec2 instancePixelOffsets;
attribute float instanceLineWidths;
attribute vec4 instanceFillColors;
attribute vec4 instanceLineColors;
attribute vec3 instancePickingColors;

uniform bool billboard;
uniform float opacity;
uniform float sizeScale;
uniform float sizeMinPixels;
uniform float sizeMaxPixels;
uniform vec4 padding;
uniform int sizeUnits;

varying vec4 vFillColor;
varying vec4 vLineColor;
varying float vLineWidth;
varying vec2 uv;
varying vec2 dimensions;

vec2 rotate_by_angle(vec2 vertex, float angle) {
  float angle_radian = radians(angle);
  float cos_angle = cos(angle_radian);
  float sin_angle = sin(angle_radian);
  mat2 rotationMatrix = mat2(cos_angle, -sin_angle, sin_angle, cos_angle);
  return rotationMatrix * vertex;
}

void main(void) {
  geometry.worldPosition = instancePositions;
  geometry.uv = positions;
  geometry.pickingColor = instancePickingColors;
  uv = positions;
  vLineWidth = instanceLineWidths;

  // convert size in meters to pixels, then scaled and clamp

  // project meters to pixels and clamp to limits
  float sizePixels = clamp(
    project_size_to_pixel(instanceSizes * sizeScale, sizeUnits),
    sizeMinPixels, sizeMaxPixels
  );

  dimensions = instanceRects.zw * sizePixels + padding.xy + padding.zw;

  vec2 pixelOffset = (positions * instanceRects.zw + instanceRects.xy) * sizePixels + mix(-padding.xy, padding.zw, positions);
  pixelOffset = rotate_by_angle(pixelOffset, instanceAngles);
  pixelOffset += instancePixelOffsets;
  pixelOffset.y *= -1.0;

  if (billboard)  {
    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);
    vec3 offset = vec3(pixelOffset, 0.0);
    DECKGL_FILTER_SIZE(offset, geometry);
    gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);
  } else {
    vec3 offset_common = vec3(project_pixel_size(pixelOffset), 0.0);
    DECKGL_FILTER_SIZE(offset_common, geometry);
    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset_common, geometry.position);
  }
  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);

  // Apply opacity to instance color, or return instance picking color
  vFillColor = vec4(instanceFillColors.rgb, instanceFillColors.a * opacity);
  DECKGL_FILTER_COLOR(vFillColor, geometry);
  vLineColor = vec4(instanceLineColors.rgb, instanceLineColors.a * opacity);
  DECKGL_FILTER_COLOR(vLineColor, geometry);
}
`;var aO=`#define SHADER_NAME text-background-layer-fragment-shader

precision highp float;

uniform bool stroked;

varying vec4 vFillColor;
varying vec4 vLineColor;
varying float vLineWidth;
varying vec2 uv;
varying vec2 dimensions;

void main(void) {
  geometry.uv = uv;

  vec2 pixelPosition = uv * dimensions;
  if (stroked) {
    float distToEdge = min(
      min(pixelPosition.x, dimensions.x - pixelPosition.x),
      min(pixelPosition.y, dimensions.y - pixelPosition.y)
    );
    float isBorder = smoothedge(distToEdge, vLineWidth);
    gl_FragColor = mix(vFillColor, vLineColor, isBorder);
  } else {
    gl_FragColor = vFillColor;
  }

  DECKGL_FILTER_COLOR(gl_FragColor, geometry);
}
`;var z4={billboard:!0,sizeScale:1,sizeUnits:"pixels",sizeMinPixels:0,sizeMaxPixels:Number.MAX_SAFE_INTEGER,padding:{type:"array",value:[0,0,0,0]},getPosition:{type:"accessor",value:s=>s.position},getSize:{type:"accessor",value:1},getAngle:{type:"accessor",value:0},getPixelOffset:{type:"accessor",value:[0,0]},getBoundingRect:{type:"accessor",value:[0,0,0,0]},getFillColor:{type:"accessor",value:[0,0,0,255]},getLineColor:{type:"accessor",value:[0,0,0,255]},getLineWidth:{type:"accessor",value:1}},ic=class extends kt{constructor(...e){super(...e),y(this,"state",void 0)}getShaders(){return super.getShaders({vs:sO,fs:aO,modules:[ai,Bn]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:5130,fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceSizes:{size:1,transition:!0,accessor:"getSize",defaultValue:1},instanceAngles:{size:1,transition:!0,accessor:"getAngle"},instanceRects:{size:4,accessor:"getBoundingRect"},instancePixelOffsets:{size:2,transition:!0,accessor:"getPixelOffset"},instanceFillColors:{size:4,transition:!0,normalized:!0,type:5121,accessor:"getFillColor",defaultValue:[0,0,0,255]},instanceLineColors:{size:4,transition:!0,normalized:!0,type:5121,accessor:"getLineColor",defaultValue:[0,0,0,255]},instanceLineWidths:{size:1,transition:!0,accessor:"getLineWidth",defaultValue:1}})}updateState(e){super.updateState(e);let{changeFlags:t}=e;if(t.extensionsChanged){var i;let{gl:n}=this.context;(i=this.state.model)===null||i===void 0||i.delete(),this.state.model=this._getModel(n),this.getAttributeManager().invalidateAll()}}draw({uniforms:e}){let{billboard:t,sizeScale:i,sizeUnits:n,sizeMinPixels:o,sizeMaxPixels:a,getLineWidth:l}=this.props,{padding:u}=this.props;u.length<4&&(u=[u[0],u[1],u[0],u[1]]),this.state.model.setUniforms(e).setUniforms({billboard:t,stroked:Boolean(l),padding:u,sizeUnits:Ur[n],sizeScale:i,sizeMinPixels:o,sizeMaxPixels:a}).draw()}_getModel(e){let t=[0,0,1,0,1,1,0,1];return new At(e,{...this.getShaders(),id:this.props.id,geometry:new pr({drawMode:6,vertexCount:4,attributes:{positions:{size:2,value:new Float32Array(t)}}}),isInstanced:!0})}};y(ic,"defaultProps",z4);y(ic,"layerName","TextBackgroundLayer");var lO={start:1,middle:0,end:-1},uO={top:1,center:0,bottom:-1},$x=[0,0,0,255],W4=1,H4={billboard:!0,sizeScale:1,sizeUnits:"pixels",sizeMinPixels:0,sizeMaxPixels:Number.MAX_SAFE_INTEGER,background:!1,getBackgroundColor:{type:"accessor",value:[255,255,255,255]},getBorderColor:{type:"accessor",value:$x},getBorderWidth:{type:"accessor",value:0},backgroundPadding:{type:"array",value:[0,0,0,0]},characterSet:{type:"object",value:td.characterSet},fontFamily:td.fontFamily,fontWeight:td.fontWeight,lineHeight:W4,outlineWidth:{type:"number",value:0,min:0},outlineColor:{type:"color",value:$x},fontSettings:{},wordBreak:"break-word",maxWidth:{type:"number",value:-1},getText:{type:"accessor",value:s=>s.text},getPosition:{type:"accessor",value:s=>s.position},getColor:{type:"accessor",value:$x},getSize:{type:"accessor",value:32},getAngle:{type:"accessor",value:0},getTextAnchor:{type:"accessor",value:"middle"},getAlignmentBaseline:{type:"accessor",value:"center"},getPixelOffset:{type:"accessor",value:[0,0]},backgroundColor:{deprecatedFor:["background","getBackgroundColor"]}},Bi=class extends un{constructor(...e){super(...e),y(this,"state",void 0),y(this,"getBoundingRect",(t,i)=>{let n=this.state.fontAtlasManager.mapping,o=this.state.getText,{wordBreak:a,maxWidth:l,lineHeight:u,getTextAnchor:c,getAlignmentBaseline:h}=this.props,d=o(t,i)||"",{size:[f,p]}=Jx(d,u,a,l,n),S=lO[typeof c=="function"?c(t,i):c],E=uO[typeof h=="function"?h(t,i):h];return[(S-1)*f/2,(E-1)*p/2,f,p]}),y(this,"getIconOffsets",(t,i)=>{let n=this.state.fontAtlasManager.mapping,o=this.state.getText,{wordBreak:a,maxWidth:l,lineHeight:u,getTextAnchor:c,getAlignmentBaseline:h}=this.props,d=o(t,i)||"",{x:f,y:p,rowWidth:S,size:[E,C]}=Jx(d,u,a,l,n),O=lO[typeof c=="function"?c(t,i):c],B=uO[typeof h=="function"?h(t,i):h],A=f.length,N=new Array(A*2),z=0;for(let Y=0;Y<A;Y++){let ie=(1-O)*(E-S[Y])/2;N[z++]=(O-1)*E/2+ie+f[Y],N[z++]=(B-1)*C/2+p[Y]}return N})}initializeState(){this.state={styleVersion:0,fontAtlasManager:new dp}}updateState(e){let{props:t,oldProps:i,changeFlags:n}=e;(n.dataChanged||n.updateTriggersChanged&&(n.updateTriggersChanged.all||n.updateTriggersChanged.getText))&&this._updateText(),(this._updateFontAtlas()||t.lineHeight!==i.lineHeight||t.wordBreak!==i.wordBreak||t.maxWidth!==i.maxWidth)&&this.setState({styleVersion:this.state.styleVersion+1})}getPickingInfo({info:e}){return e.object=e.index>=0?this.props.data[e.index]:null,e}_updateFontAtlas(){let{fontSettings:e,fontFamily:t,fontWeight:i}=this.props,{fontAtlasManager:n,characterSet:o}=this.state,a={...e,characterSet:o,fontFamily:t,fontWeight:i};if(!n.mapping)return n.setProps(a),!0;for(let l in a)if(a[l]!==n.props[l])return n.setProps(a),!0;return!1}_updateText(){var e;let{data:t,characterSet:i}=this.props,n=(e=t.attributes)===null||e===void 0?void 0:e.getText,{getText:o}=this.props,a=t.startIndices,l,u=i==="auto"&&new Set;if(n&&a){let{texts:c,characterCount:h}=$R({...ArrayBuffer.isView(n)?{value:n}:n,length:t.length,startIndices:a,characterSet:u});l=h,o=(d,{index:f})=>c[f]}else{let{iterable:c,objectInfo:h}=Po(t);a=[0],l=0;for(let d of c){h.index++;let f=Array.from(o(d,h)||"");u&&f.forEach(u.add,u),l+=f.length,a.push(l)}}this.setState({getText:o,startIndices:a,numInstances:l,characterSet:u||i})}renderLayers(){let{startIndices:e,numInstances:t,getText:i,fontAtlasManager:{scale:n,texture:o,mapping:a},styleVersion:l}=this.state,{data:u,_dataDiff:c,getPosition:h,getColor:d,getSize:f,getAngle:p,getPixelOffset:S,getBackgroundColor:E,getBorderColor:C,getBorderWidth:O,backgroundPadding:B,background:A,billboard:N,fontSettings:z,outlineWidth:Y,outlineColor:ie,sizeScale:he,sizeUnits:ae,sizeMinPixels:D,sizeMaxPixels:_,transitions:W,updateTriggers:H}=this.props,ee=this.getSubLayerClass("characters",rc),oe=this.getSubLayerClass("background",ic);return[A&&new oe({getFillColor:E,getLineColor:C,getLineWidth:O,padding:B,getPosition:h,getSize:f,getAngle:p,getPixelOffset:S,billboard:N,sizeScale:he/this.state.fontAtlasManager.props.fontSize,sizeUnits:ae,sizeMinPixels:D,sizeMaxPixels:_,transitions:W&&{getPosition:W.getPosition,getAngle:W.getAngle,getSize:W.getSize,getFillColor:W.getBackgroundColor,getLineColor:W.getBorderColor,getLineWidth:W.getBorderWidth,getPixelOffset:W.getPixelOffset}},this.getSubLayerProps({id:"background",updateTriggers:{getPosition:H.getPosition,getAngle:H.getAngle,getSize:H.getSize,getFillColor:H.getBackgroundColor,getLineColor:H.getBorderColor,getLineWidth:H.getBorderWidth,getPixelOffset:H.getPixelOffset,getBoundingRect:{getText:H.getText,getTextAnchor:H.getTextAnchor,getAlignmentBaseline:H.getAlignmentBaseline,styleVersion:l}}}),{data:u.attributes&&u.attributes.background?{length:u.length,attributes:u.attributes.background}:u,_dataDiff:c,autoHighlight:!1,getBoundingRect:this.getBoundingRect}),new ee({sdf:z.sdf,smoothing:Number.isFinite(z.smoothing)?z.smoothing:td.smoothing,outlineWidth:Y,outlineColor:ie,iconAtlas:o,iconMapping:a,getPosition:h,getColor:d,getSize:f,getAngle:p,getPixelOffset:S,billboard:N,sizeScale:he*n,sizeUnits:ae,sizeMinPixels:D*n,sizeMaxPixels:_*n,transitions:W&&{getPosition:W.getPosition,getAngle:W.getAngle,getColor:W.getColor,getSize:W.getSize,getPixelOffset:W.getPixelOffset}},this.getSubLayerProps({id:"characters",updateTriggers:{getIcon:H.getText,getPosition:H.getPosition,getAngle:H.getAngle,getColor:H.getColor,getSize:H.getSize,getPixelOffset:H.getPixelOffset,getIconOffsets:{getText:H.getText,getTextAnchor:H.getTextAnchor,getAlignmentBaseline:H.getAlignmentBaseline,styleVersion:l}}}),{data:u,_dataDiff:c,startIndices:e,numInstances:t,getIconOffsets:this.getIconOffsets,getIcon:i})]}static set fontAtlasCacheLimit(e){oO(e)}};y(Bi,"defaultProps",H4);y(Bi,"layerName","TextLayer");var fp={circle:{type:Ju,props:{filled:"filled",stroked:"stroked",lineWidthMaxPixels:"lineWidthMaxPixels",lineWidthMinPixels:"lineWidthMinPixels",lineWidthScale:"lineWidthScale",lineWidthUnits:"lineWidthUnits",pointRadiusMaxPixels:"radiusMaxPixels",pointRadiusMinPixels:"radiusMinPixels",pointRadiusScale:"radiusScale",pointRadiusUnits:"radiusUnits",pointAntialiasing:"antialiasing",pointBillboard:"billboard",getFillColor:"getFillColor",getLineColor:"getLineColor",getLineWidth:"getLineWidth",getPointRadius:"getRadius"}},icon:{type:Gn,props:{iconAtlas:"iconAtlas",iconMapping:"iconMapping",iconSizeMaxPixels:"sizeMaxPixels",iconSizeMinPixels:"sizeMinPixels",iconSizeScale:"sizeScale",iconSizeUnits:"sizeUnits",iconAlphaCutoff:"alphaCutoff",iconBillboard:"billboard",getIcon:"getIcon",getIconAngle:"getAngle",getIconColor:"getColor",getIconPixelOffset:"getPixelOffset",getIconSize:"getSize"}},text:{type:Bi,props:{textSizeMaxPixels:"sizeMaxPixels",textSizeMinPixels:"sizeMinPixels",textSizeScale:"sizeScale",textSizeUnits:"sizeUnits",textBackground:"background",textBackgroundPadding:"backgroundPadding",textFontFamily:"fontFamily",textFontWeight:"fontWeight",textLineHeight:"lineHeight",textMaxWidth:"maxWidth",textOutlineColor:"outlineColor",textOutlineWidth:"outlineWidth",textWordBreak:"wordBreak",textCharacterSet:"characterSet",textBillboard:"billboard",textFontSettings:"fontSettings",getText:"getText",getTextAngle:"getAngle",getTextColor:"getColor",getTextPixelOffset:"getPixelOffset",getTextSize:"getSize",getTextAnchor:"getTextAnchor",getTextAlignmentBaseline:"getAlignmentBaseline",getTextBackgroundColor:"getBackgroundColor",getTextBorderColor:"getBorderColor",getTextBorderWidth:"getBorderWidth"}}},gp={type:$u,props:{lineWidthUnits:"widthUnits",lineWidthScale:"widthScale",lineWidthMinPixels:"widthMinPixels",lineWidthMaxPixels:"widthMaxPixels",lineJointRounded:"jointRounded",lineCapRounded:"capRounded",lineMiterLimit:"miterLimit",lineBillboard:"billboard",getLineColor:"getColor",getLineWidth:"getWidth"}},by={type:tc,props:{extruded:"extruded",filled:"filled",wireframe:"wireframe",elevationScale:"elevationScale",material:"material",getElevation:"getElevation",getFillColor:"getFillColor",getLineColor:"getLineColor"}};function rd({type:s,props:e}){let t={};for(let i in e)t[i]=s.defaultProps[e[i]];return t}function Py(s,e){let{transitions:t,updateTriggers:i}=s.props,n={updateTriggers:{},transitions:t&&{getPosition:t.geometry}};for(let o in e){let a=e[o],l=s.props[o];o.startsWith("get")&&(l=s.getSubLayerAccessor(l),n.updateTriggers[a]=i[o],t&&(n.transitions[a]=t[o])),n[a]=l}return n}function hO(s){if(Array.isArray(s))return s;switch(fe.assert(s.type,"GeoJSON does not have type"),s.type){case"Feature":return[s];case"FeatureCollection":return fe.assert(Array.isArray(s.features),"GeoJSON does not have features array"),s.features;default:return[{geometry:s}]}}function ev(s,e,t={}){let i={pointFeatures:[],lineFeatures:[],polygonFeatures:[],polygonOutlineFeatures:[]},{startRow:n=0,endRow:o=s.length}=t;for(let a=n;a<o;a++){let l=s[a],{geometry:u}=l;if(!!u)if(u.type==="GeometryCollection"){fe.assert(Array.isArray(u.geometries),"GeoJSON does not have geometries array");let{geometries:c}=u;for(let h=0;h<c.length;h++){let d=c[h];cO(d,i,e,l,a)}}else cO(u,i,e,l,a)}return i}function cO(s,e,t,i,n){let{type:o,coordinates:a}=s,{pointFeatures:l,lineFeatures:u,polygonFeatures:c,polygonOutlineFeatures:h}=e;if(!q4(o,a)){fe.warn("".concat(o," coordinates are malformed"))();return}switch(o){case"Point":l.push(t({geometry:s},i,n));break;case"MultiPoint":a.forEach(d=>{l.push(t({geometry:{type:"Point",coordinates:d}},i,n))});break;case"LineString":u.push(t({geometry:s},i,n));break;case"MultiLineString":a.forEach(d=>{u.push(t({geometry:{type:"LineString",coordinates:d}},i,n))});break;case"Polygon":c.push(t({geometry:s},i,n)),a.forEach(d=>{h.push(t({geometry:{type:"LineString",coordinates:d}},i,n))});break;case"MultiPolygon":a.forEach(d=>{c.push(t({geometry:{type:"Polygon",coordinates:d}},i,n)),d.forEach(f=>{h.push(t({geometry:{type:"LineString",coordinates:f}},i,n))})});break;default:}}var j4={Point:1,MultiPoint:2,LineString:2,MultiLineString:3,Polygon:3,MultiPolygon:4};function q4(s,e){let t=j4[s];for(fe.assert(t,"Unknown GeoJSON type ".concat(s));e&&--t>0;)e=e[0];return e&&Number.isFinite(e[0])}function dO(){return{points:{},lines:{},polygons:{},polygonsOutline:{}}}function yy(s){return s.geometry.coordinates}function fO(s,e){let t=dO(),{pointFeatures:i,lineFeatures:n,polygonFeatures:o,polygonOutlineFeatures:a}=s;return t.points.data=i,t.points._dataDiff=e.pointFeatures&&(()=>e.pointFeatures),t.points.getPosition=yy,t.lines.data=n,t.lines._dataDiff=e.lineFeatures&&(()=>e.lineFeatures),t.lines.getPath=yy,t.polygons.data=o,t.polygons._dataDiff=e.polygonFeatures&&(()=>e.polygonFeatures),t.polygons.getPolygon=yy,t.polygonsOutline.data=a,t.polygonsOutline._dataDiff=e.polygonOutlineFeatures&&(()=>e.polygonOutlineFeatures),t.polygonsOutline.getPath=yy,t}function gO(s,e){let t=dO(),{points:i,lines:n,polygons:o}=s,a=WR(s,e);return t.points.data={length:i.positions.value.length/i.positions.size,attributes:{...i.attributes,getPosition:i.positions,instancePickingColors:{size:3,value:a.points}},properties:i.properties,numericProps:i.numericProps,featureIds:i.featureIds},t.lines.data={length:n.pathIndices.value.length-1,startIndices:n.pathIndices.value,attributes:{...n.attributes,getPath:n.positions,instancePickingColors:{size:3,value:a.lines}},properties:n.properties,numericProps:n.numericProps,featureIds:n.featureIds},t.lines._pathType="open",t.polygons.data={length:o.polygonIndices.value.length-1,startIndices:o.polygonIndices.value,attributes:{...o.attributes,getPolygon:o.positions,pickingColors:{size:3,value:a.polygons}},properties:o.properties,numericProps:o.numericProps,featureIds:o.featureIds},t.polygons._normalize=!1,o.triangles&&(t.polygons.data.attributes.indices=o.triangles.value),t.polygonsOutline.data={length:o.primitivePolygonIndices.value.length-1,startIndices:o.primitivePolygonIndices.value,attributes:{...o.attributes,getPath:o.positions,instancePickingColors:{size:3,value:a.polygons}},properties:o.properties,numericProps:o.numericProps,featureIds:o.featureIds},t.polygonsOutline._pathType="open",t}var X4=["points","linestrings","polygons"],Y4={...rd(fp.circle),...rd(fp.icon),...rd(fp.text),...rd(gp),...rd(by),stroked:!0,filled:!0,extruded:!1,wireframe:!1,iconAtlas:{type:"object",value:null},iconMapping:{type:"object",value:{}},getIcon:{type:"accessor",value:s=>s.properties.icon},getText:{type:"accessor",value:s=>s.properties.text},pointType:"circle",getRadius:{deprecatedFor:"getPointRadius"}},Sl=class extends un{initializeState(){this.state={layerProps:{},features:{}}}updateState({props:e,changeFlags:t}){if(!t.dataChanged)return;let{data:i}=this.props,n=i&&"points"in i&&"polygons"in i&&"lines"in i;this.setState({binary:n}),n?this._updateStateBinary({props:e,changeFlags:t}):this._updateStateJSON({props:e,changeFlags:t})}_updateStateBinary({props:e,changeFlags:t}){let i=gO(e.data,this.encodePickingColor);this.setState({layerProps:i})}_updateStateJSON({props:e,changeFlags:t}){let i=hO(e.data),n=this.getSubLayerRow.bind(this),o={},a={};if(Array.isArray(t.dataChanged)){let u=this.state.features;for(let c in u)o[c]=u[c].slice(),a[c]=[];for(let c of t.dataChanged){let h=ev(i,n,c);for(let d in u)a[d].push(UR({data:o[d],getIndex:f=>f.__source.index,dataRange:c,replace:h[d]}))}}else o=ev(i,n);let l=fO(o,a);this.setState({features:o,featuresDiff:a,layerProps:l})}getPickingInfo(e){let t=super.getPickingInfo(e),{index:i,sourceLayer:n}=t;return t.featureType=X4.find(o=>n.id.startsWith("".concat(this.id,"-").concat(o,"-"))),i>=0&&n.id.startsWith("".concat(this.id,"-points-text"))&&this.state.binary&&(t.index=this.props.data.points.globalFeatureIds.value[i]),t}_updateAutoHighlight(e){let t="".concat(this.id,"-points-"),i=e.featureType==="points";for(let n of this.getSubLayers())n.id.startsWith(t)===i&&n.updateAutoHighlight(e)}_renderPolygonLayer(){let{extruded:e,wireframe:t}=this.props,{layerProps:i}=this.state,n="polygons-fill",o=this.shouldRenderSubLayer(n,i.polygons.data)&&this.getSubLayerClass(n,by.type);if(o){let a=Py(this,by.props),l=e&&t;return l||delete a.getLineColor,a.updateTriggers.lineColors=l,new o(a,this.getSubLayerProps({id:n,updateTriggers:a.updateTriggers}),i.polygons)}return null}_renderLineLayers(){let{extruded:e,stroked:t}=this.props,{layerProps:i}=this.state,n="polygons-stroke",o="linestrings",a=!e&&t&&this.shouldRenderSubLayer(n,i.polygonsOutline.data)&&this.getSubLayerClass(n,gp.type),l=this.shouldRenderSubLayer(o,i.lines.data)&&this.getSubLayerClass(o,gp.type);if(a||l){let u=Py(this,gp.props);return[a&&new a(u,this.getSubLayerProps({id:n,updateTriggers:u.updateTriggers}),i.polygonsOutline),l&&new l(u,this.getSubLayerProps({id:o,updateTriggers:u.updateTriggers}),i.lines)]}return null}_renderPointLayers(){let{pointType:e}=this.props,{layerProps:t,binary:i}=this.state,{highlightedObjectIndex:n}=this.props;!i&&Number.isFinite(n)&&(n=t.points.data.findIndex(l=>l.__source.index===n));let o=new Set(e.split("+")),a=[];for(let l of o){let u="points-".concat(l),c=fp[l],h=c&&this.shouldRenderSubLayer(u,t.points.data)&&this.getSubLayerClass(u,c.type);if(h){let d=Py(this,c.props),f=t.points;if(l==="text"&&i){let{instancePickingColors:p,...S}=f.data.attributes;f={...f,data:{...f.data,attributes:S}}}a.push(new h(d,this.getSubLayerProps({id:u,updateTriggers:d.updateTriggers,highlightedObjectIndex:n}),f))}}return a}renderLayers(){let{extruded:e}=this.props,t=this._renderPolygonLayer(),i=this._renderLineLayers(),n=this._renderPointLayers();return[!e&&t,i,n,e&&t]}getSubLayerAccessor(e){let{binary:t}=this.state;return!t||typeof e!="function"?super.getSubLayerAccessor(e):(i,n)=>{let{data:o,index:a}=n,l=zR(o,a);return e(l,n)}}};y(Sl,"layerName","GeoJsonLayer");y(Sl,"defaultProps",Y4);var pp=class{constructor(e){y(this,"index",void 0),y(this,"isVisible",void 0),y(this,"isSelected",void 0),y(this,"parent",void 0),y(this,"children",void 0),y(this,"content",void 0),y(this,"state",void 0),y(this,"layers",void 0),y(this,"id",void 0),y(this,"bbox",void 0),y(this,"zoom",void 0),y(this,"userData",void 0),y(this,"_abortController",void 0),y(this,"_loader",void 0),y(this,"_loaderId",void 0),y(this,"_isLoaded",void 0),y(this,"_isCancelled",void 0),y(this,"_needsReload",void 0),this.index=e,this.isVisible=!1,this.isSelected=!1,this.parent=null,this.children=[],this.content=null,this._loader=void 0,this._abortController=null,this._loaderId=0,this._isLoaded=!1,this._isCancelled=!1,this._needsReload=!1}get data(){return this.isLoading&&this._loader?this._loader.then(()=>this.data):this.content}get isLoaded(){return this._isLoaded&&!this._needsReload}get isLoading(){return Boolean(this._loader)&&!this._isCancelled}get needsReload(){return this._needsReload||this._isCancelled}get byteLength(){let e=this.content?this.content.byteLength:0;return Number.isFinite(e)||fe.error("byteLength not defined in tile data")(),e}async _loadData({getData:e,requestScheduler:t,onLoad:i,onError:n}){let{index:o,id:a,bbox:l,userData:u,zoom:c}=this,h=this._loaderId;this._abortController=new AbortController;let{signal:d}=this._abortController,f=await t.scheduleRequest(this,E=>E.isSelected?1:-1);if(!f){this._isCancelled=!0;return}if(this._isCancelled){f.done();return}let p=null,S;try{p=await e({index:o,id:a,bbox:l,userData:u,zoom:c,signal:d})}catch(E){S=E||!0}finally{f.done()}if(h===this._loaderId){if(this._loader=void 0,this.content=p,this._isCancelled&&!p){this._isLoaded=!1;return}this._isLoaded=!0,this._isCancelled=!1,S?n(S,this):i(this)}}loadData(e){return this._isLoaded=!1,this._isCancelled=!1,this._needsReload=!1,this._loaderId++,this._loader=this._loadData(e),this._loader}setNeedsReload(){this.isLoading&&(this.abort(),this._loader=void 0),this._needsReload=!0}abort(){var e;this.isLoaded||(this._isCancelled=!0,(e=this._abortController)===null||e===void 0||e.abort())}};var Xt={OUTSIDE:-1,INTERSECTING:0,INSIDE:1};var pO=new re,K4=new re,ea=class{constructor(e=[0,0,0],t=[0,0,0],i){y(this,"center",void 0),y(this,"halfDiagonal",void 0),y(this,"minimum",void 0),y(this,"maximum",void 0),i=i||pO.copy(e).add(t).scale(.5),this.center=new re(i),this.halfDiagonal=new re(t).subtract(this.center),this.minimum=new re(e),this.maximum=new re(t)}clone(){return new ea(this.minimum,this.maximum,this.center)}equals(e){return this===e||Boolean(e)&&this.minimum.equals(e.minimum)&&this.maximum.equals(e.maximum)}transform(e){return this.center.transformAsPoint(e),this.halfDiagonal.transform(e),this.minimum.transform(e),this.maximum.transform(e),this}intersectPlane(e){let{halfDiagonal:t}=this,i=K4.from(e.normal),n=t.x*Math.abs(i.x)+t.y*Math.abs(i.y)+t.z*Math.abs(i.z),o=this.center.dot(i)+e.distance;return o-n>0?Xt.INSIDE:o+n<0?Xt.OUTSIDE:Xt.INTERSECTING}distanceTo(e){return Math.sqrt(this.distanceSquaredTo(e))}distanceSquaredTo(e){let t=pO.from(e).subtract(this.center),{halfDiagonal:i}=this,n=0,o;return o=Math.abs(t.x)-i.x,o>0&&(n+=o*o),o=Math.abs(t.y)-i.y,o>0&&(n+=o*o),o=Math.abs(t.z)-i.z,o>0&&(n+=o*o),n}};var mp=new re,mO=new re,ta=class{constructor(e=[0,0,0],t=0){y(this,"center",void 0),y(this,"radius",void 0),this.radius=-0,this.center=new re,this.fromCenterRadius(e,t)}fromCenterRadius(e,t){return this.center.from(e),this.radius=t,this}fromCornerPoints(e,t){return t=mp.from(t),this.center=new re().from(e).add(t).scale(.5),this.radius=this.center.distance(t),this}equals(e){return this===e||Boolean(e)&&this.center.equals(e.center)&&this.radius===e.radius}clone(){return new ta(this.center,this.radius)}union(e){let t=this.center,i=this.radius,n=e.center,o=e.radius,a=mp.copy(n).subtract(t),l=a.magnitude();if(i>=l+o)return this.clone();if(o>=l+i)return e.clone();let u=(i+l+o)*.5;return mO.copy(a).scale((-i+u)/l).add(t),this.center.copy(mO),this.radius=u,this}expand(e){let i=mp.from(e).subtract(this.center).magnitude();return i>this.radius&&(this.radius=i),this}transform(e){this.center.transform(e);let t=QI(mp,e);return this.radius=Math.max(t[0],Math.max(t[1],t[2]))*this.radius,this}distanceSquaredTo(e){let t=this.distanceTo(e);return t*t}distanceTo(e){let i=mp.from(e).subtract(this.center);return Math.max(0,i.len()-this.radius)}intersectPlane(e){let t=this.center,i=this.radius,o=e.normal.dot(t)+e.distance;return o<-i?Xt.OUTSIDE:o<i?Xt.INTERSECTING:Xt.INSIDE}};var Z4=new re,Q4=new re,Sy=new re,Ey=new re,xy=new re,J4=new re,$4=new re,ra={COLUMN0ROW0:0,COLUMN0ROW1:1,COLUMN0ROW2:2,COLUMN1ROW0:3,COLUMN1ROW1:4,COLUMN1ROW2:5,COLUMN2ROW0:6,COLUMN2ROW1:7,COLUMN2ROW2:8},El=class{constructor(e=[0,0,0],t=[0,0,0,0,0,0,0,0,0]){y(this,"center",void 0),y(this,"halfAxes",void 0),this.center=new re().from(e),this.halfAxes=new Ct(t)}get halfSize(){let e=this.halfAxes.getColumn(0),t=this.halfAxes.getColumn(1),i=this.halfAxes.getColumn(2);return[new re(e).len(),new re(t).len(),new re(i).len()]}get quaternion(){let e=this.halfAxes.getColumn(0),t=this.halfAxes.getColumn(1),i=this.halfAxes.getColumn(2),n=new re(e).normalize(),o=new re(t).normalize(),a=new re(i).normalize();return new Fu().fromMatrix3(new Ct([...n,...o,...a]))}fromCenterHalfSizeQuaternion(e,t,i){let n=new Fu(i),o=new Ct().fromQuaternion(n);return o[0]=o[0]*t[0],o[1]=o[1]*t[0],o[2]=o[2]*t[0],o[3]=o[3]*t[1],o[4]=o[4]*t[1],o[5]=o[5]*t[1],o[6]=o[6]*t[2],o[7]=o[7]*t[2],o[8]=o[8]*t[2],this.center=new re().from(e),this.halfAxes=o,this}clone(){return new El(this.center,this.halfAxes)}equals(e){return this===e||Boolean(e)&&this.center.equals(e.center)&&this.halfAxes.equals(e.halfAxes)}getBoundingSphere(e=new ta){let t=this.halfAxes,i=t.getColumn(0,Sy),n=t.getColumn(1,Ey),o=t.getColumn(2,xy),a=Z4.copy(i).add(n).add(o);return e.center.copy(this.center),e.radius=a.magnitude(),e}intersectPlane(e){let t=this.center,i=e.normal,n=this.halfAxes,o=i.x,a=i.y,l=i.z,u=Math.abs(o*n[ra.COLUMN0ROW0]+a*n[ra.COLUMN0ROW1]+l*n[ra.COLUMN0ROW2])+Math.abs(o*n[ra.COLUMN1ROW0]+a*n[ra.COLUMN1ROW1]+l*n[ra.COLUMN1ROW2])+Math.abs(o*n[ra.COLUMN2ROW0]+a*n[ra.COLUMN2ROW1]+l*n[ra.COLUMN2ROW2]),c=i.dot(t)+e.distance;return c<=-u?Xt.OUTSIDE:c>=u?Xt.INSIDE:Xt.INTERSECTING}distanceTo(e){return Math.sqrt(this.distanceSquaredTo(e))}distanceSquaredTo(e){let t=Q4.from(e).subtract(this.center),i=this.halfAxes,n=i.getColumn(0,Sy),o=i.getColumn(1,Ey),a=i.getColumn(2,xy),l=n.magnitude(),u=o.magnitude(),c=a.magnitude();n.normalize(),o.normalize(),a.normalize();let h=0,d;return d=Math.abs(t.dot(n))-l,d>0&&(h+=d*d),d=Math.abs(t.dot(o))-u,d>0&&(h+=d*d),d=Math.abs(t.dot(a))-c,d>0&&(h+=d*d),h}computePlaneDistances(e,t,i=[-0,-0]){let n=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY,a=this.center,l=this.halfAxes,u=l.getColumn(0,Sy),c=l.getColumn(1,Ey),h=l.getColumn(2,xy),d=J4.copy(u).add(c).add(h).add(a),f=$4.copy(d).subtract(e),p=t.dot(f);return n=Math.min(p,n),o=Math.max(p,o),d.copy(a).add(u).add(c).subtract(h),f.copy(d).subtract(e),p=t.dot(f),n=Math.min(p,n),o=Math.max(p,o),d.copy(a).add(u).subtract(c).add(h),f.copy(d).subtract(e),p=t.dot(f),n=Math.min(p,n),o=Math.max(p,o),d.copy(a).add(u).subtract(c).subtract(h),f.copy(d).subtract(e),p=t.dot(f),n=Math.min(p,n),o=Math.max(p,o),a.copy(d).subtract(u).add(c).add(h),f.copy(d).subtract(e),p=t.dot(f),n=Math.min(p,n),o=Math.max(p,o),a.copy(d).subtract(u).add(c).subtract(h),f.copy(d).subtract(e),p=t.dot(f),n=Math.min(p,n),o=Math.max(p,o),a.copy(d).subtract(u).subtract(c).add(h),f.copy(d).subtract(e),p=t.dot(f),n=Math.min(p,n),o=Math.max(p,o),a.copy(d).subtract(u).subtract(c).subtract(h),f.copy(d).subtract(e),p=t.dot(f),n=Math.min(p,n),o=Math.max(p,o),i[0]=n,i[1]=o,i}transform(e){this.center.transformAsPoint(e);let t=this.halfAxes.getColumn(0,Sy);t.transformAsPoint(e);let i=this.halfAxes.getColumn(1,Ey);i.transformAsPoint(e);let n=this.halfAxes.getColumn(2,xy);return n.transformAsPoint(e),this.halfAxes=new Ct([...t,...i,...n]),this}getTransform(){throw new Error("not implemented")}};var bO=new re,PO=new re,cn=class{constructor(e=[0,0,1],t=0){y(this,"normal",void 0),y(this,"distance",void 0),this.normal=new re,this.distance=-0,this.fromNormalDistance(e,t)}fromNormalDistance(e,t){return no(Number.isFinite(t)),this.normal.from(e).normalize(),this.distance=t,this}fromPointNormal(e,t){e=bO.from(e),this.normal.from(t).normalize();let i=-this.normal.dot(e);return this.distance=i,this}fromCoefficients(e,t,i,n){return this.normal.set(e,t,i),no(kr(this.normal.len(),1)),this.distance=n,this}clone(){return new cn(this.normal,this.distance)}equals(e){return kr(this.distance,e.distance)&&kr(this.normal,e.normal)}getPointDistance(e){return this.normal.dot(e)+this.distance}transform(e){let t=PO.copy(this.normal).transformAsVector(e).normalize(),i=this.normal.scale(-this.distance).transform(e);return this.fromPointNormal(i,t)}projectPointOntoPlane(e,t=[0,0,0]){e=bO.from(e);let i=this.getPointDistance(e),n=PO.copy(this.normal).scale(i);return e.subtract(n).to(t)}};var yO=[new re([1,0,0]),new re([0,1,0]),new re([0,0,1])],SO=new re,e6=new re,BFe=new cn(new re(1,0,0),0),Ei=class{constructor(e=[]){y(this,"planes",void 0),this.planes=e}fromBoundingSphere(e){this.planes.length=2*yO.length;let t=e.center,i=e.radius,n=0;for(let o of yO){let a=this.planes[n],l=this.planes[n+1];a||(a=this.planes[n]=new cn),l||(l=this.planes[n+1]=new cn);let u=SO.copy(o).scale(-i).add(t),c=-o.dot(u);a.fromPointNormal(u,o);let h=SO.copy(o).scale(i).add(t),d=e6.copy(o).negate(),f=-d.dot(h);l.fromPointNormal(h,d),n+=2}return this}computeVisibility(e){let t=Xt.INSIDE;for(let i of this.planes)switch(e.intersectPlane(i)){case Xt.OUTSIDE:return Xt.OUTSIDE;case Xt.INTERSECTING:t=Xt.INTERSECTING;break;default:}return t}computeVisibilityWithPlaneMask(e,t){if(no(Number.isFinite(t),"parentPlaneMask is required."),t===Ei.MASK_OUTSIDE||t===Ei.MASK_INSIDE)return t;let i=Ei.MASK_INSIDE,n=this.planes;for(let o=0;o<this.planes.length;++o){let a=o<31?1<<o:0;if(o<31&&(t&a)===0)continue;let l=n[o],u=e.intersectPlane(l);if(u===Xt.OUTSIDE)return Ei.MASK_OUTSIDE;u===Xt.INTERSECTING&&(i|=a)}return i}};y(Ei,"MASK_OUTSIDE",4294967295);y(Ei,"MASK_INSIDE",0);y(Ei,"MASK_INDETERMINATE",2147483647);var UFe=new re,zFe=new re,WFe=new re,HFe=new re,jFe=new re;var JFe=new re,$Fe=new re,eke=new re,tke=new re,rke=new re,ike=new re,nke=new re,oke=new re,ske=new re,ake=new re,lke=new re,uke=new re,cke=4/3*Math.PI;var ss=new Ct,r6=new Ct,i6=new Ct,vy=new Ct,EO=new Ct;function Cy(s,e={}){let t=DP.EPSILON20,i=10,n=0,o=0,a=r6,l=i6;a.identity(),l.copy(s);let u=t*n6(l);for(;o<i&&o6(l)>u;)s6(l,vy),EO.copy(vy).transpose(),l.multiplyRight(vy),l.multiplyLeft(EO),a.multiplyRight(vy),++n>2&&(++o,n=0);return e.unitary=a.toTarget(e.unitary),e.diagonal=l.toTarget(e.diagonal),e}function n6(s){let e=0;for(let t=0;t<9;++t){let i=s[t];e+=i*i}return Math.sqrt(e)}var tv=[1,0,0],rv=[2,2,1];function o6(s){let e=0;for(let t=0;t<3;++t){let i=s[ss.getElementIndex(rv[t],tv[t])];e+=2*i*i}return Math.sqrt(e)}function s6(s,e){let t=DP.EPSILON15,i=0,n=1;for(let c=0;c<3;++c){let h=Math.abs(s[ss.getElementIndex(rv[c],tv[c])]);h>i&&(n=c,i=h)}let o=tv[n],a=rv[n],l=1,u=0;if(Math.abs(s[ss.getElementIndex(a,o)])>t){let c=s[ss.getElementIndex(a,a)],h=s[ss.getElementIndex(o,o)],d=s[ss.getElementIndex(a,o)],f=(c-h)/2/d,p;f<0?p=-1/(-f+Math.sqrt(1+f*f)):p=1/(f+Math.sqrt(1+f*f)),l=1/Math.sqrt(1+p*p),u=p*l}return Ct.IDENTITY.to(e),e[ss.getElementIndex(o,o)]=e[ss.getElementIndex(a,a)]=l,e[ss.getElementIndex(a,o)]=u,e[ss.getElementIndex(o,a)]=-u,e}var xl=new re,a6=new re,l6=new re,u6=new re,c6=new re,h6=new Ct,d6={diagonal:new Ct,unitary:new Ct};function iv(s,e=new El){if(!s||s.length===0)return e.halfAxes=new Ct([0,0,0,0,0,0,0,0,0]),e.center=new re,e;let t=s.length,i=new re(0,0,0);for(let ae of s)i.add(ae);let n=1/t;i.multiplyByScalar(n);let o=0,a=0,l=0,u=0,c=0,h=0;for(let ae of s){let D=xl.copy(ae).subtract(i);o+=D.x*D.x,a+=D.x*D.y,l+=D.x*D.z,u+=D.y*D.y,c+=D.y*D.z,h+=D.z*D.z}o*=n,a*=n,l*=n,u*=n,c*=n,h*=n;let d=h6;d[0]=o,d[1]=a,d[2]=l,d[3]=a,d[4]=u,d[5]=c,d[6]=l,d[7]=c,d[8]=h;let{unitary:f}=Cy(d,d6),p=e.halfAxes.copy(f),S=p.getColumn(0,l6),E=p.getColumn(1,u6),C=p.getColumn(2,c6),O=-Number.MAX_VALUE,B=-Number.MAX_VALUE,A=-Number.MAX_VALUE,N=Number.MAX_VALUE,z=Number.MAX_VALUE,Y=Number.MAX_VALUE;for(let ae of s)xl.copy(ae),O=Math.max(xl.dot(S),O),B=Math.max(xl.dot(E),B),A=Math.max(xl.dot(C),A),N=Math.min(xl.dot(S),N),z=Math.min(xl.dot(E),z),Y=Math.min(xl.dot(C),Y);S=S.multiplyByScalar(.5*(N+O)),E=E.multiplyByScalar(.5*(z+B)),C=C.multiplyByScalar(.5*(Y+A)),e.center.copy(S).add(E).add(C);let ie=a6.set(O-N,B-z,A-Y).multiplyByScalar(.5),he=new Ct([ie[0],0,0,0,ie[1],0,0,0,ie[2]]);return e.halfAxes.multiplyRight(he),e}var id=512,xO=3,vO=[[.5,.5],[0,0],[0,1],[1,0],[1,1]],CO=vO.concat([[0,.5],[.5,0],[1,.5],[.5,1]]),f6=CO.concat([[.25,.5],[.75,.5]]),vl=class{constructor(e,t,i){y(this,"x",void 0),y(this,"y",void 0),y(this,"z",void 0),y(this,"childVisible",void 0),y(this,"selected",void 0),y(this,"_children",void 0),this.x=e,this.y=t,this.z=i}get children(){if(!this._children){let e=this.x*2,t=this.y*2,i=this.z+1;this._children=[new vl(e,t,i),new vl(e,t+1,i),new vl(e+1,t,i),new vl(e+1,t+1,i)]}return this._children}update(e){let{viewport:t,cullingVolume:i,elevationBounds:n,minZ:o,maxZ:a,bounds:l,offset:u,project:c}=e,h=this.getBoundingVolume(n,u,c);if(l&&!this.insideBounds(l)||i.computeVisibility(h)<0)return!1;if(!this.childVisible){let{z:f}=this;if(f<a&&f>=o){let p=h.distanceTo(t.cameraPosition)*t.scale/t.height;f+=Math.floor(Math.log2(p))}if(f>=a)return this.selected=!0,!0}this.selected=!1,this.childVisible=!0;for(let f of this.children)f.update(e);return!0}getSelected(e=[]){if(this.selected&&e.push(this),this._children)for(let t of this._children)t.getSelected(e);return e}insideBounds([e,t,i,n]){let o=Math.pow(2,this.z),a=id/o;return this.x*a<i&&this.y*a<n&&(this.x+1)*a>e&&(this.y+1)*a>t}getBoundingVolume(e,t,i){if(i){let u=this.z<1?f6:this.z<2?CO:vO,c=[];for(let h of u){let d=Ay(this.x+h[0],this.y+h[1],this.z);d[2]=e[0],c.push(i(d)),e[0]!==e[1]&&(d[2]=e[1],c.push(i(d)))}return iv(c)}let n=Math.pow(2,this.z),o=id/n,a=this.x*o+t*id,l=id-(this.y+1)*o;return new ea([a,l,e[0]],[a+o,l+o,e[1]])}};function AO(s,e,t,i){let n=s instanceof Zh&&s.resolution?s.projectPosition:null,o=Object.values(s.getFrustumPlanes()).map(({normal:p,distance:S})=>new cn(p.clone().negate(),S)),a=new Ei(o),l=s.distanceScales.unitsPerMeter[2],u=t&&t[0]*l||0,c=t&&t[1]*l||0,h=s instanceof Lr&&s.pitch<=60?e:0;if(i){let[p,S,E,C]=i,O=Mn([p,C]),B=Mn([E,S]);i=[O[0],id-O[1],B[0],id-B[1]]}let d=new vl(0,0,0),f={viewport:s,project:n,cullingVolume:a,elevationBounds:[u,c],minZ:h,maxZ:e,bounds:i,offset:0};if(d.update(f),s instanceof Lr&&s.subViewports&&s.subViewports.length>1){for(f.offset=-1;d.update(f)&&!(--f.offset<-xO););for(f.offset=1;d.update(f)&&!(++f.offset>xO););}return d.getSelected()}var ia=512,g6=[-1/0,-1/0,1/0,1/0],IO={type:"url",value:null,validate:(s,e)=>e.optional&&s===null||typeof s=="string"||Array.isArray(s)&&s.every(t=>typeof t=="string"),equals:(s,e)=>{if(s===e)return!0;if(!Array.isArray(s)||!Array.isArray(e))return!1;let t=s.length;if(t!==e.length)return!1;for(let i=0;i<t;i++)if(s[i]!==e[i])return!1;return!0}};function wO(s,e){let t=[e.transformAsPoint([s[0],s[1]]),e.transformAsPoint([s[2],s[1]]),e.transformAsPoint([s[0],s[3]]),e.transformAsPoint([s[2],s[3]])];return[Math.min(...t.map(n=>n[0])),Math.min(...t.map(n=>n[1])),Math.max(...t.map(n=>n[0])),Math.max(...t.map(n=>n[1]))]}function p6(s){return Math.abs(s.split("").reduce((e,t)=>(e<<5)-e+t.charCodeAt(0)|0,0))}function LO(s,e){if(!s||!s.length)return null;let{index:t,id:i}=e;if(Array.isArray(s)){let o=p6(i)%s.length;s=s[o]}let n=s;for(let o of Object.keys(t)){let a=new RegExp("{".concat(o,"}"),"g");n=n.replace(a,String(t[o]))}return Number.isInteger(t.y)&&Number.isInteger(t.z)&&(n=n.replace(/\{-y\}/g,String(Math.pow(2,t.z)-t.y-1))),n}function m6(s,e,t){let i;if(e&&e.length===2){let[n,o]=e,a=s.getBounds({z:n}),l=s.getBounds({z:o});i=[Math.min(a[0],l[0]),Math.min(a[1],l[1]),Math.max(a[2],l[2]),Math.max(a[3],l[3])]}else i=s.getBounds();return s.isGeospatial?[Math.max(i[0],t[0]),Math.max(i[1],t[1]),Math.min(i[2],t[2]),Math.min(i[3],t[3])]:[Math.max(Math.min(i[0],t[2]),t[0]),Math.max(Math.min(i[1],t[3]),t[1]),Math.min(Math.max(i[2],t[0]),t[2]),Math.min(Math.max(i[3],t[1]),t[3])]}function bp({viewport:s,z:e,cullRect:t}){let i=t.x-s.x,n=t.y-s.y,{width:o,height:a}=t;if(!Array.isArray(e)){let c={targetZ:e||0},h=s.unproject([i,n],c),d=s.unproject([i+o,n],c),f=s.unproject([i,n+a],c),p=s.unproject([i+o,n+a],c);return[Math.min(h[0],d[0],f[0],p[0]),Math.min(h[1],d[1],f[1],p[1]),Math.max(h[0],d[0],f[0],p[0]),Math.max(h[1],d[1],f[1],p[1])]}let l=bp({viewport:s,z:e[0],cullRect:t}),u=bp({viewport:s,z:e[1],cullRect:t});return[Math.min(l[0],u[0]),Math.min(l[1],u[1]),Math.max(l[2],u[2]),Math.max(l[3],u[3])]}function b6(s,e,t){return t?wO(s,t).map(n=>n*e/ia):s.map(i=>i*e/ia)}function nv(s,e){return Math.pow(2,s)*ia/e}function Ay(s,e,t){let i=nv(t,ia),n=s/i*360-180,o=Math.PI-2*Math.PI*e/i,a=180/Math.PI*Math.atan(.5*(Math.exp(o)-Math.exp(-o)));return[n,a]}function TO(s,e,t,i){let n=nv(t,i);return[s/n*ia,e/n*ia]}function RO(s,e,t,i,n=ia){if(s.isGeospatial){let[c,h]=Ay(e,t,i),[d,f]=Ay(e+1,t+1,i);return{west:c,north:h,east:d,south:f}}let[o,a]=TO(e,t,i,n),[l,u]=TO(e+1,t+1,i,n);return{left:o,top:a,right:l,bottom:u}}function P6(s,e,t,i,n){let o=m6(s,null,i),a=nv(e,t),[l,u,c,h]=b6(o,a,n),d=[];for(let f=Math.floor(l);f<c;f++)for(let p=Math.floor(u);p<h;p++)d.push({x:f,y:p,z:e});return d}function OO({viewport:s,maxZoom:e,minZoom:t,zRange:i,extent:n,tileSize:o=ia,modelMatrix:a,modelMatrixInverse:l,zoomOffset:u=0}){let c=s.isGeospatial?Math.round(s.zoom+Math.log2(ia/o))+u:Math.ceil(s.zoom)+u;if(typeof t=="number"&&Number.isFinite(t)&&c<t){if(!n)return[];c=t}typeof e=="number"&&Number.isFinite(e)&&c>e&&(c=e);let h=n;return a&&l&&n&&!s.isGeospatial&&(h=wO(n,a)),s.isGeospatial?AO(s,c,i,n):P6(s,c,o,h||g6,l)}var _O=1,Ty=2,y6="never",S6="no-overlap",Iy="best-available",E6=5,x6={[Iy]:v6,[S6]:C6,[y6]:()=>{}},Pp=class{constructor(e){y(this,"opts",void 0),y(this,"_requestScheduler",void 0),y(this,"_cache",void 0),y(this,"_dirty",void 0),y(this,"_tiles",void 0),y(this,"_cacheByteSize",void 0),y(this,"_viewport",void 0),y(this,"_zRange",void 0),y(this,"_selectedTiles",void 0),y(this,"_frameNumber",void 0),y(this,"_modelMatrix",void 0),y(this,"_modelMatrixInverse",void 0),y(this,"_maxZoom",void 0),y(this,"_minZoom",void 0),y(this,"onTileLoad",void 0),y(this,"_getCullBounds",uo(bp)),this.opts=e,this.onTileLoad=t=>{this.opts.onTileLoad(t),this.opts.maxCacheByteSize&&(this._cacheByteSize+=t.byteLength,this._resizeCache())},this._requestScheduler=new dh({maxRequests:e.maxRequests,throttleRequests:e.maxRequests>0}),this._cache=new Map,this._tiles=[],this._dirty=!1,this._cacheByteSize=0,this._viewport=null,this._selectedTiles=null,this._frameNumber=0,this._modelMatrix=new $e,this._modelMatrixInverse=new $e,this.setOptions(e)}get tiles(){return this._tiles}get selectedTiles(){return this._selectedTiles}get isLoaded(){return this._selectedTiles!==null&&this._selectedTiles.every(e=>e.isLoaded)}get needsReload(){return this._selectedTiles!==null&&this._selectedTiles.some(e=>e.needsReload)}setOptions(e){Object.assign(this.opts,e),Number.isFinite(e.maxZoom)&&(this._maxZoom=Math.floor(e.maxZoom)),Number.isFinite(e.minZoom)&&(this._minZoom=Math.ceil(e.minZoom))}finalize(){for(let e of this._cache.values())e.isLoading&&e.abort();this._cache.clear(),this._tiles=[],this._selectedTiles=null}reloadAll(){for(let e of this._cache.keys()){let t=this._cache.get(e);!this._selectedTiles||!this._selectedTiles.includes(t)?this._cache.delete(e):t.setNeedsReload()}}update(e,{zRange:t,modelMatrix:i}={}){let n=new $e(i),o=!n.equals(this._modelMatrix);if(!this._viewport||!e.equals(this._viewport)||!kr(this._zRange,t)||o){o&&(this._modelMatrixInverse=n.clone().invert(),this._modelMatrix=n),this._viewport=e,this._zRange=t;let l=this.getTileIndices({viewport:e,maxZoom:this._maxZoom,minZoom:this._minZoom,zRange:t,modelMatrix:this._modelMatrix,modelMatrixInverse:this._modelMatrixInverse});this._selectedTiles=l.map(u=>this._getTile(u,!0)),this._dirty&&this._rebuildTree()}else this.needsReload&&(this._selectedTiles=this._selectedTiles.map(l=>this._getTile(l.index,!0)));let a=this.updateTileStates();return this._pruneRequests(),this._dirty&&this._resizeCache(),a&&this._frameNumber++,this._frameNumber}isTileVisible(e,t){if(!e.isVisible)return!1;if(t&&this._viewport){let[i,n,o,a]=bp({viewport:this._viewport,z:this._zRange,cullRect:t}),{bbox:l}=e;if("west"in l)return l.west<o&&l.east>i&&l.south<a&&l.north>n;let u=Math.min(l.top,l.bottom),c=Math.max(l.top,l.bottom);return l.left<o&&l.right>i&&u<a&&c>n}return!0}getTileIndices({viewport:e,maxZoom:t,minZoom:i,zRange:n,modelMatrix:o,modelMatrixInverse:a}){let{tileSize:l,extent:u,zoomOffset:c}=this.opts;return OO({viewport:e,maxZoom:t,minZoom:i,zRange:n,tileSize:l,extent:u,modelMatrix:o,modelMatrixInverse:a,zoomOffset:c})}getTileId(e){return"".concat(e.x,"-").concat(e.y,"-").concat(e.z)}getTileZoom(e){return e.z}getTileMetadata(e){let{tileSize:t}=this.opts;return{bbox:RO(this._viewport,e.x,e.y,e.z,t)}}getParentIndex(e){let t=Math.floor(e.x/2),i=Math.floor(e.y/2),n=e.z-1;return{x:t,y:i,z:n}}updateTileStates(){let e=this.opts.refinementStrategy||Iy,t=new Array(this._cache.size),i=0;for(let n of this._cache.values())t[i++]=n.isVisible,n.isSelected=!1,n.isVisible=!1;for(let n of this._selectedTiles)n.isSelected=!0,n.isVisible=!0;(typeof e=="function"?e:x6[e])(Array.from(this._cache.values())),i=0;for(let n of this._cache.values())if(t[i++]!==n.isVisible)return!0;return!1}_pruneRequests(){let{maxRequests:e}=this.opts,t=[],i=0;for(let n of this._cache.values())n.isLoading&&(i++,!n.isSelected&&!n.isVisible&&t.push(n));for(;e>0&&i>e&&t.length>0;)t.shift().abort(),i--}_rebuildTree(){let{_cache:e}=this;for(let t of e.values())t.parent=null,t.children&&(t.children.length=0);for(let t of e.values()){let i=this._getNearestAncestor(t);t.parent=i,i!=null&&i.children&&i.children.push(t)}}_resizeCache(){let{_cache:e,opts:t}=this,i=t.maxCacheSize||(t.maxCacheByteSize?1/0:E6*this.selectedTiles.length),n=t.maxCacheByteSize||1/0;if(e.size>i||this._cacheByteSize>n){for(let[a,l]of e)if(!l.isVisible&&!l.isSelected&&(this._cacheByteSize-=t.maxCacheByteSize?l.byteLength:0,e.delete(a),this.opts.onTileUnload(l)),e.size<=i&&this._cacheByteSize<=n)break;this._rebuildTree(),this._dirty=!0}this._dirty&&(this._tiles=Array.from(this._cache.values()).sort((a,l)=>a.zoom-l.zoom),this._dirty=!1)}_getTile(e,t){let i=this.getTileId(e),n=this._cache.get(i),o=!1;return!n&&t?(n=new pp(e),Object.assign(n,this.getTileMetadata(n.index)),Object.assign(n,{id:i,zoom:this.getTileZoom(n.index)}),o=!0,this._cache.set(i,n),this._dirty=!0):n&&n.needsReload&&(o=!0),n&&o&&n.loadData({getData:this.opts.getTileData,requestScheduler:this._requestScheduler,onLoad:this.onTileLoad,onError:this.opts.onTileError}),n}_getNearestAncestor(e){let{_minZoom:t=0}=this,i=e.index;for(;this.getTileZoom(i)>t;){i=this.getParentIndex(i);let n=this._getTile(i);if(n)return n}return null}};function v6(s){for(let e of s)e.state=0;for(let e of s)e.isSelected&&!NO(e)&&ov(e);for(let e of s)e.isVisible=Boolean(e.state&Ty)}function C6(s){for(let t of s)t.state=0;for(let t of s)t.isSelected&&NO(t);let e=Array.from(s).sort((t,i)=>t.zoom-i.zoom);for(let t of e)if(t.isVisible=Boolean(t.state&Ty),t.children&&(t.isVisible||t.state&_O))for(let i of t.children)i.state=_O;else t.isSelected&&ov(t)}function NO(s){let e=s;for(;e;){if(e.isLoaded||e.content)return e.state|=Ty,!0;e=e.parent}return!1}function ov(s){for(let e of s.children)e.isLoaded||e.content?e.state|=Ty:ov(e)}var A6={TilesetClass:Pp,data:{type:"data",value:[]},dataComparator:IO.equals,renderSubLayers:{type:"function",value:s=>new Sl(s),compare:!1},getTileData:{type:"function",optional:!0,value:null,compare:!1},onViewportLoad:{type:"function",optional:!0,value:null,compare:!1},onTileLoad:{type:"function",value:s=>{},compare:!1},onTileUnload:{type:"function",value:s=>{},compare:!1},onTileError:{type:"function",value:s=>console.error(s),compare:!1},extent:{type:"array",optional:!0,value:null,compare:!0},tileSize:512,maxZoom:null,minZoom:0,maxCacheSize:null,maxCacheByteSize:null,refinementStrategy:Iy,zRange:null,maxRequests:6,zoomOffset:0},Cl=class extends un{initializeState(){this.state={tileset:null,isLoaded:!1}}finalizeState(){var e,t;(e=this.state)===null||e===void 0||(t=e.tileset)===null||t===void 0||t.finalize()}get isLoaded(){var e,t;return(e=this.state)===null||e===void 0||(t=e.tileset)===null||t===void 0?void 0:t.selectedTiles.every(i=>i.isLoaded&&i.layers&&i.layers.every(n=>n.isLoaded))}shouldUpdateState({changeFlags:e}){return e.somethingChanged}updateState({changeFlags:e}){let{tileset:t}=this.state,i=e.propsOrDataChanged||e.updateTriggersChanged,n=e.dataChanged||e.updateTriggersChanged&&(e.updateTriggersChanged.all||e.updateTriggersChanged.getTileData);t?i&&(t.setOptions(this._getTilesetOptions()),n?t.reloadAll():this.state.tileset.tiles.forEach(o=>{o.layers=null})):(t=new this.props.TilesetClass(this._getTilesetOptions()),this.setState({tileset:t})),this._updateTileset()}_getTilesetOptions(){let{tileSize:e,maxCacheSize:t,maxCacheByteSize:i,refinementStrategy:n,extent:o,maxZoom:a,minZoom:l,maxRequests:u,zoomOffset:c}=this.props;return{maxCacheSize:t,maxCacheByteSize:i,maxZoom:a,minZoom:l,tileSize:e,refinementStrategy:n,extent:o,maxRequests:u,zoomOffset:c,getTileData:this.getTileData.bind(this),onTileLoad:this._onTileLoad.bind(this),onTileError:this._onTileError.bind(this),onTileUnload:this._onTileUnload.bind(this)}}_updateTileset(){let{tileset:e}=this.state,{zRange:t,modelMatrix:i}=this.props,n=e.update(this.context.viewport,{zRange:t,modelMatrix:i}),{isLoaded:o}=e,a=this.state.isLoaded!==o,l=this.state.frameNumber!==n;o&&(a||l)&&this._onViewportLoad(),l&&this.setState({frameNumber:n}),this.state.isLoaded=o}_onViewportLoad(){let{tileset:e}=this.state,{onViewportLoad:t}=this.props;t&&t(e.selectedTiles)}_onTileLoad(e){this.props.onTileLoad(e),e.layers=null,this.setNeedsUpdate()}_onTileError(e,t){this.props.onTileError(e),t.layers=null,this.setNeedsUpdate()}_onTileUnload(e){this.props.onTileUnload(e)}getTileData(e){let{data:t,getTileData:i,fetch:n}=this.props,{signal:o}=e;return e.url=typeof t=="string"||Array.isArray(t)?LO(t,e):null,i?i(e):n&&e.url?n(e.url,{propName:"data",layer:this,signal:o}):null}renderSubLayers(e){return this.props.renderSubLayers(e)}getSubLayerPropsByTile(e){return null}getPickingInfo({info:e,sourceLayer:t}){return e.picked&&(e.tile=t.props.tile),e}_updateAutoHighlight(e){e.sourceLayer&&e.sourceLayer.updateAutoHighlight(e)}renderLayers(){return this.state.tileset.tiles.map(e=>{let t=this.getSubLayerPropsByTile(e);if(!(!e.isLoaded&&!e.content))if(e.layers)t&&e.layers[0]&&Object.keys(t).some(i=>e.layers[0].props[i]!==t[i])&&(e.layers=e.layers.map(i=>i.clone(t)));else{let i=this.renderSubLayers({...this.props,id:"".concat(this.id,"-").concat(e.id),data:e.content,_offset:0,tile:e});e.layers=Ys(i,Boolean).map(n=>n.clone({tile:e,...t}))}return e.layers})}filterSubLayer({layer:e,cullRect:t}){let{tile:i}=e.props;return this.state.tileset.isTileVisible(i,t)}};y(Cl,"defaultProps",A6);y(Cl,"layerName","TileLayer");var MO={clipBounds:[0,0,1,1]},BO=`
uniform vec4 clip_bounds;

bool clip_isInBounds(vec2 position) {
  return position.x >= clip_bounds[0] && position.y >= clip_bounds[1] && position.x < clip_bounds[2] && position.y < clip_bounds[3];
}
`,T6={name:"clip-vs",vs:BO},I6={"vs:#decl":`
varying float clip_isVisible;
`,"vs:DECKGL_FILTER_GL_POSITION":`
  clip_isVisible = float(clip_isInBounds(geometry.worldPosition.xy));
`,"fs:#decl":`
varying float clip_isVisible;
`,"fs:DECKGL_FILTER_COLOR":`
  if (clip_isVisible < 0.5) discard;
`},w6={name:"clip-fs",fs:BO},L6={"vs:#decl":`
varying vec2 clip_commonPosition;
`,"vs:DECKGL_FILTER_GL_POSITION":`
  clip_commonPosition = geometry.position.xy;
`,"fs:#decl":`
varying vec2 clip_commonPosition;
`,"fs:DECKGL_FILTER_COLOR":`
  if (!clip_isInBounds(clip_commonPosition)) discard;
`},Al=class extends $s{getShaders(){let e="instancePositions"in this.getAttributeManager().attributes;return"clipByInstance"in this.props&&(e=this.props.clipByInstance),this.state.clipByInstance=e,e?{modules:[T6],inject:I6}:{modules:[w6],inject:L6}}draw({uniforms:e}){let{clipBounds:t=MO.clipBounds}=this.props;if(this.state.clipByInstance)e.clip_bounds=t;else{let i=this.projectPosition([t[0],t[1],0]),n=this.projectPosition([t[2],t[3],0]);e.clip_bounds=[Math.min(i[0],n[0]),Math.min(i[1],n[1]),Math.max(i[0],n[0]),Math.max(i[1],n[1])]}}};y(Al,"defaultProps",MO);y(Al,"extensionName","ClipExtension");var Ne={DEPTH_BUFFER_BIT:256,STENCIL_BUFFER_BIT:1024,COLOR_BUFFER_BIT:16384,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,ZERO:0,ONE:1,SRC_COLOR:768,ONE_MINUS_SRC_COLOR:769,SRC_ALPHA:770,ONE_MINUS_SRC_ALPHA:771,DST_ALPHA:772,ONE_MINUS_DST_ALPHA:773,DST_COLOR:774,ONE_MINUS_DST_COLOR:775,SRC_ALPHA_SATURATE:776,CONSTANT_COLOR:32769,ONE_MINUS_CONSTANT_COLOR:32770,CONSTANT_ALPHA:32771,ONE_MINUS_CONSTANT_ALPHA:32772,FUNC_ADD:32774,FUNC_SUBTRACT:32778,FUNC_REVERSE_SUBTRACT:32779,BLEND_EQUATION:32777,BLEND_EQUATION_RGB:32777,BLEND_EQUATION_ALPHA:34877,BLEND_DST_RGB:32968,BLEND_SRC_RGB:32969,BLEND_DST_ALPHA:32970,BLEND_SRC_ALPHA:32971,BLEND_COLOR:32773,ARRAY_BUFFER_BINDING:34964,ELEMENT_ARRAY_BUFFER_BINDING:34965,LINE_WIDTH:2849,ALIASED_POINT_SIZE_RANGE:33901,ALIASED_LINE_WIDTH_RANGE:33902,CULL_FACE_MODE:2885,FRONT_FACE:2886,DEPTH_RANGE:2928,DEPTH_WRITEMASK:2930,DEPTH_CLEAR_VALUE:2931,DEPTH_FUNC:2932,STENCIL_CLEAR_VALUE:2961,STENCIL_FUNC:2962,STENCIL_FAIL:2964,STENCIL_PASS_DEPTH_FAIL:2965,STENCIL_PASS_DEPTH_PASS:2966,STENCIL_REF:2967,STENCIL_VALUE_MASK:2963,STENCIL_WRITEMASK:2968,STENCIL_BACK_FUNC:34816,STENCIL_BACK_FAIL:34817,STENCIL_BACK_PASS_DEPTH_FAIL:34818,STENCIL_BACK_PASS_DEPTH_PASS:34819,STENCIL_BACK_REF:36003,STENCIL_BACK_VALUE_MASK:36004,STENCIL_BACK_WRITEMASK:36005,VIEWPORT:2978,SCISSOR_BOX:3088,COLOR_CLEAR_VALUE:3106,COLOR_WRITEMASK:3107,UNPACK_ALIGNMENT:3317,PACK_ALIGNMENT:3333,MAX_TEXTURE_SIZE:3379,MAX_VIEWPORT_DIMS:3386,SUBPIXEL_BITS:3408,RED_BITS:3410,GREEN_BITS:3411,BLUE_BITS:3412,ALPHA_BITS:3413,DEPTH_BITS:3414,STENCIL_BITS:3415,POLYGON_OFFSET_UNITS:10752,POLYGON_OFFSET_FACTOR:32824,TEXTURE_BINDING_2D:32873,SAMPLE_BUFFERS:32936,SAMPLES:32937,SAMPLE_COVERAGE_VALUE:32938,SAMPLE_COVERAGE_INVERT:32939,COMPRESSED_TEXTURE_FORMATS:34467,VENDOR:7936,RENDERER:7937,VERSION:7938,IMPLEMENTATION_COLOR_READ_TYPE:35738,IMPLEMENTATION_COLOR_READ_FORMAT:35739,BROWSER_DEFAULT_WEBGL:37444,STATIC_DRAW:35044,STREAM_DRAW:35040,DYNAMIC_DRAW:35048,ARRAY_BUFFER:34962,ELEMENT_ARRAY_BUFFER:34963,BUFFER_SIZE:34660,BUFFER_USAGE:34661,CURRENT_VERTEX_ATTRIB:34342,VERTEX_ATTRIB_ARRAY_ENABLED:34338,VERTEX_ATTRIB_ARRAY_SIZE:34339,VERTEX_ATTRIB_ARRAY_STRIDE:34340,VERTEX_ATTRIB_ARRAY_TYPE:34341,VERTEX_ATTRIB_ARRAY_NORMALIZED:34922,VERTEX_ATTRIB_ARRAY_POINTER:34373,VERTEX_ATTRIB_ARRAY_BUFFER_BINDING:34975,CULL_FACE:2884,FRONT:1028,BACK:1029,FRONT_AND_BACK:1032,BLEND:3042,DEPTH_TEST:2929,DITHER:3024,POLYGON_OFFSET_FILL:32823,SAMPLE_ALPHA_TO_COVERAGE:32926,SAMPLE_COVERAGE:32928,SCISSOR_TEST:3089,STENCIL_TEST:2960,NO_ERROR:0,INVALID_ENUM:1280,INVALID_VALUE:1281,INVALID_OPERATION:1282,OUT_OF_MEMORY:1285,CONTEXT_LOST_WEBGL:37442,CW:2304,CCW:2305,DONT_CARE:4352,FASTEST:4353,NICEST:4354,GENERATE_MIPMAP_HINT:33170,BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,INT:5124,UNSIGNED_INT:5125,FLOAT:5126,DOUBLE:5130,DEPTH_COMPONENT:6402,ALPHA:6406,RGB:6407,RGBA:6408,LUMINANCE:6409,LUMINANCE_ALPHA:6410,UNSIGNED_SHORT_4_4_4_4:32819,UNSIGNED_SHORT_5_5_5_1:32820,UNSIGNED_SHORT_5_6_5:33635,FRAGMENT_SHADER:35632,VERTEX_SHADER:35633,COMPILE_STATUS:35713,DELETE_STATUS:35712,LINK_STATUS:35714,VALIDATE_STATUS:35715,ATTACHED_SHADERS:35717,ACTIVE_ATTRIBUTES:35721,ACTIVE_UNIFORMS:35718,MAX_VERTEX_ATTRIBS:34921,MAX_VERTEX_UNIFORM_VECTORS:36347,MAX_VARYING_VECTORS:36348,MAX_COMBINED_TEXTURE_IMAGE_UNITS:35661,MAX_VERTEX_TEXTURE_IMAGE_UNITS:35660,MAX_TEXTURE_IMAGE_UNITS:34930,MAX_FRAGMENT_UNIFORM_VECTORS:36349,SHADER_TYPE:35663,SHADING_LANGUAGE_VERSION:35724,CURRENT_PROGRAM:35725,NEVER:512,ALWAYS:519,LESS:513,EQUAL:514,LEQUAL:515,GREATER:516,GEQUAL:518,NOTEQUAL:517,KEEP:7680,REPLACE:7681,INCR:7682,DECR:7683,INVERT:5386,INCR_WRAP:34055,DECR_WRAP:34056,NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987,TEXTURE_MAG_FILTER:10240,TEXTURE_MIN_FILTER:10241,TEXTURE_WRAP_S:10242,TEXTURE_WRAP_T:10243,TEXTURE_2D:3553,TEXTURE:5890,TEXTURE_CUBE_MAP:34067,TEXTURE_BINDING_CUBE_MAP:34068,TEXTURE_CUBE_MAP_POSITIVE_X:34069,TEXTURE_CUBE_MAP_NEGATIVE_X:34070,TEXTURE_CUBE_MAP_POSITIVE_Y:34071,TEXTURE_CUBE_MAP_NEGATIVE_Y:34072,TEXTURE_CUBE_MAP_POSITIVE_Z:34073,TEXTURE_CUBE_MAP_NEGATIVE_Z:34074,MAX_CUBE_MAP_TEXTURE_SIZE:34076,TEXTURE0:33984,ACTIVE_TEXTURE:34016,REPEAT:10497,CLAMP_TO_EDGE:33071,MIRRORED_REPEAT:33648,TEXTURE_WIDTH:4096,TEXTURE_HEIGHT:4097,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,INT_VEC2:35667,INT_VEC3:35668,INT_VEC4:35669,BOOL:35670,BOOL_VEC2:35671,BOOL_VEC3:35672,BOOL_VEC4:35673,FLOAT_MAT2:35674,FLOAT_MAT3:35675,FLOAT_MAT4:35676,SAMPLER_2D:35678,SAMPLER_CUBE:35680,LOW_FLOAT:36336,MEDIUM_FLOAT:36337,HIGH_FLOAT:36338,LOW_INT:36339,MEDIUM_INT:36340,HIGH_INT:36341,FRAMEBUFFER:36160,RENDERBUFFER:36161,RGBA4:32854,RGB5_A1:32855,RGB565:36194,DEPTH_COMPONENT16:33189,STENCIL_INDEX:6401,STENCIL_INDEX8:36168,DEPTH_STENCIL:34041,RENDERBUFFER_WIDTH:36162,RENDERBUFFER_HEIGHT:36163,RENDERBUFFER_INTERNAL_FORMAT:36164,RENDERBUFFER_RED_SIZE:36176,RENDERBUFFER_GREEN_SIZE:36177,RENDERBUFFER_BLUE_SIZE:36178,RENDERBUFFER_ALPHA_SIZE:36179,RENDERBUFFER_DEPTH_SIZE:36180,RENDERBUFFER_STENCIL_SIZE:36181,FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE:36048,FRAMEBUFFER_ATTACHMENT_OBJECT_NAME:36049,FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL:36050,FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE:36051,COLOR_ATTACHMENT0:36064,DEPTH_ATTACHMENT:36096,STENCIL_ATTACHMENT:36128,DEPTH_STENCIL_ATTACHMENT:33306,NONE:0,FRAMEBUFFER_COMPLETE:36053,FRAMEBUFFER_INCOMPLETE_ATTACHMENT:36054,FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:36055,FRAMEBUFFER_INCOMPLETE_DIMENSIONS:36057,FRAMEBUFFER_UNSUPPORTED:36061,FRAMEBUFFER_BINDING:36006,RENDERBUFFER_BINDING:36007,READ_FRAMEBUFFER:36008,DRAW_FRAMEBUFFER:36009,MAX_RENDERBUFFER_SIZE:34024,INVALID_FRAMEBUFFER_OPERATION:1286,UNPACK_FLIP_Y_WEBGL:37440,UNPACK_PREMULTIPLY_ALPHA_WEBGL:37441,UNPACK_COLORSPACE_CONVERSION_WEBGL:37443,READ_BUFFER:3074,UNPACK_ROW_LENGTH:3314,UNPACK_SKIP_ROWS:3315,UNPACK_SKIP_PIXELS:3316,PACK_ROW_LENGTH:3330,PACK_SKIP_ROWS:3331,PACK_SKIP_PIXELS:3332,TEXTURE_BINDING_3D:32874,UNPACK_SKIP_IMAGES:32877,UNPACK_IMAGE_HEIGHT:32878,MAX_3D_TEXTURE_SIZE:32883,MAX_ELEMENTS_VERTICES:33e3,MAX_ELEMENTS_INDICES:33001,MAX_TEXTURE_LOD_BIAS:34045,MAX_FRAGMENT_UNIFORM_COMPONENTS:35657,MAX_VERTEX_UNIFORM_COMPONENTS:35658,MAX_ARRAY_TEXTURE_LAYERS:35071,MIN_PROGRAM_TEXEL_OFFSET:35076,MAX_PROGRAM_TEXEL_OFFSET:35077,MAX_VARYING_COMPONENTS:35659,FRAGMENT_SHADER_DERIVATIVE_HINT:35723,RASTERIZER_DISCARD:35977,VERTEX_ARRAY_BINDING:34229,MAX_VERTEX_OUTPUT_COMPONENTS:37154,MAX_FRAGMENT_INPUT_COMPONENTS:37157,MAX_SERVER_WAIT_TIMEOUT:37137,MAX_ELEMENT_INDEX:36203,RED:6403,RGB8:32849,RGBA8:32856,RGB10_A2:32857,TEXTURE_3D:32879,TEXTURE_WRAP_R:32882,TEXTURE_MIN_LOD:33082,TEXTURE_MAX_LOD:33083,TEXTURE_BASE_LEVEL:33084,TEXTURE_MAX_LEVEL:33085,TEXTURE_COMPARE_MODE:34892,TEXTURE_COMPARE_FUNC:34893,SRGB:35904,SRGB8:35905,SRGB8_ALPHA8:35907,COMPARE_REF_TO_TEXTURE:34894,RGBA32F:34836,RGB32F:34837,RGBA16F:34842,RGB16F:34843,TEXTURE_2D_ARRAY:35866,TEXTURE_BINDING_2D_ARRAY:35869,R11F_G11F_B10F:35898,RGB9_E5:35901,RGBA32UI:36208,RGB32UI:36209,RGBA16UI:36214,RGB16UI:36215,RGBA8UI:36220,RGB8UI:36221,RGBA32I:36226,RGB32I:36227,RGBA16I:36232,RGB16I:36233,RGBA8I:36238,RGB8I:36239,RED_INTEGER:36244,RGB_INTEGER:36248,RGBA_INTEGER:36249,R8:33321,RG8:33323,R16F:33325,R32F:33326,RG16F:33327,RG32F:33328,R8I:33329,R8UI:33330,R16I:33331,R16UI:33332,R32I:33333,R32UI:33334,RG8I:33335,RG8UI:33336,RG16I:33337,RG16UI:33338,RG32I:33339,RG32UI:33340,R8_SNORM:36756,RG8_SNORM:36757,RGB8_SNORM:36758,RGBA8_SNORM:36759,RGB10_A2UI:36975,TEXTURE_IMMUTABLE_FORMAT:37167,TEXTURE_IMMUTABLE_LEVELS:33503,UNSIGNED_INT_2_10_10_10_REV:33640,UNSIGNED_INT_10F_11F_11F_REV:35899,UNSIGNED_INT_5_9_9_9_REV:35902,FLOAT_32_UNSIGNED_INT_24_8_REV:36269,UNSIGNED_INT_24_8:34042,HALF_FLOAT:5131,RG:33319,RG_INTEGER:33320,INT_2_10_10_10_REV:36255,CURRENT_QUERY:34917,QUERY_RESULT:34918,QUERY_RESULT_AVAILABLE:34919,ANY_SAMPLES_PASSED:35887,ANY_SAMPLES_PASSED_CONSERVATIVE:36202,MAX_DRAW_BUFFERS:34852,DRAW_BUFFER0:34853,DRAW_BUFFER1:34854,DRAW_BUFFER2:34855,DRAW_BUFFER3:34856,DRAW_BUFFER4:34857,DRAW_BUFFER5:34858,DRAW_BUFFER6:34859,DRAW_BUFFER7:34860,DRAW_BUFFER8:34861,DRAW_BUFFER9:34862,DRAW_BUFFER10:34863,DRAW_BUFFER11:34864,DRAW_BUFFER12:34865,DRAW_BUFFER13:34866,DRAW_BUFFER14:34867,DRAW_BUFFER15:34868,MAX_COLOR_ATTACHMENTS:36063,COLOR_ATTACHMENT1:36065,COLOR_ATTACHMENT2:36066,COLOR_ATTACHMENT3:36067,COLOR_ATTACHMENT4:36068,COLOR_ATTACHMENT5:36069,COLOR_ATTACHMENT6:36070,COLOR_ATTACHMENT7:36071,COLOR_ATTACHMENT8:36072,COLOR_ATTACHMENT9:36073,COLOR_ATTACHMENT10:36074,COLOR_ATTACHMENT11:36075,COLOR_ATTACHMENT12:36076,COLOR_ATTACHMENT13:36077,COLOR_ATTACHMENT14:36078,COLOR_ATTACHMENT15:36079,SAMPLER_3D:35679,SAMPLER_2D_SHADOW:35682,SAMPLER_2D_ARRAY:36289,SAMPLER_2D_ARRAY_SHADOW:36292,SAMPLER_CUBE_SHADOW:36293,INT_SAMPLER_2D:36298,INT_SAMPLER_3D:36299,INT_SAMPLER_CUBE:36300,INT_SAMPLER_2D_ARRAY:36303,UNSIGNED_INT_SAMPLER_2D:36306,UNSIGNED_INT_SAMPLER_3D:36307,UNSIGNED_INT_SAMPLER_CUBE:36308,UNSIGNED_INT_SAMPLER_2D_ARRAY:36311,MAX_SAMPLES:36183,SAMPLER_BINDING:35097,PIXEL_PACK_BUFFER:35051,PIXEL_UNPACK_BUFFER:35052,PIXEL_PACK_BUFFER_BINDING:35053,PIXEL_UNPACK_BUFFER_BINDING:35055,COPY_READ_BUFFER:36662,COPY_WRITE_BUFFER:36663,COPY_READ_BUFFER_BINDING:36662,COPY_WRITE_BUFFER_BINDING:36663,FLOAT_MAT2x3:35685,FLOAT_MAT2x4:35686,FLOAT_MAT3x2:35687,FLOAT_MAT3x4:35688,FLOAT_MAT4x2:35689,FLOAT_MAT4x3:35690,UNSIGNED_INT_VEC2:36294,UNSIGNED_INT_VEC3:36295,UNSIGNED_INT_VEC4:36296,UNSIGNED_NORMALIZED:35863,SIGNED_NORMALIZED:36764,VERTEX_ATTRIB_ARRAY_INTEGER:35069,VERTEX_ATTRIB_ARRAY_DIVISOR:35070,TRANSFORM_FEEDBACK_BUFFER_MODE:35967,MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS:35968,TRANSFORM_FEEDBACK_VARYINGS:35971,TRANSFORM_FEEDBACK_BUFFER_START:35972,TRANSFORM_FEEDBACK_BUFFER_SIZE:35973,TRANSFORM_FEEDBACK_PRIMITIVES_WRITTEN:35976,MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS:35978,MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS:35979,INTERLEAVED_ATTRIBS:35980,SEPARATE_ATTRIBS:35981,TRANSFORM_FEEDBACK_BUFFER:35982,TRANSFORM_FEEDBACK_BUFFER_BINDING:35983,TRANSFORM_FEEDBACK:36386,TRANSFORM_FEEDBACK_PAUSED:36387,TRANSFORM_FEEDBACK_ACTIVE:36388,TRANSFORM_FEEDBACK_BINDING:36389,FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING:33296,FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE:33297,FRAMEBUFFER_ATTACHMENT_RED_SIZE:33298,FRAMEBUFFER_ATTACHMENT_GREEN_SIZE:33299,FRAMEBUFFER_ATTACHMENT_BLUE_SIZE:33300,FRAMEBUFFER_ATTACHMENT_ALPHA_SIZE:33301,FRAMEBUFFER_ATTACHMENT_DEPTH_SIZE:33302,FRAMEBUFFER_ATTACHMENT_STENCIL_SIZE:33303,FRAMEBUFFER_DEFAULT:33304,DEPTH24_STENCIL8:35056,DRAW_FRAMEBUFFER_BINDING:36006,READ_FRAMEBUFFER_BINDING:36010,RENDERBUFFER_SAMPLES:36011,FRAMEBUFFER_ATTACHMENT_TEXTURE_LAYER:36052,FRAMEBUFFER_INCOMPLETE_MULTISAMPLE:36182,UNIFORM_BUFFER:35345,UNIFORM_BUFFER_BINDING:35368,UNIFORM_BUFFER_START:35369,UNIFORM_BUFFER_SIZE:35370,MAX_VERTEX_UNIFORM_BLOCKS:35371,MAX_FRAGMENT_UNIFORM_BLOCKS:35373,MAX_COMBINED_UNIFORM_BLOCKS:35374,MAX_UNIFORM_BUFFER_BINDINGS:35375,MAX_UNIFORM_BLOCK_SIZE:35376,MAX_COMBINED_VERTEX_UNIFORM_COMPONENTS:35377,MAX_COMBINED_FRAGMENT_UNIFORM_COMPONENTS:35379,UNIFORM_BUFFER_OFFSET_ALIGNMENT:35380,ACTIVE_UNIFORM_BLOCKS:35382,UNIFORM_TYPE:35383,UNIFORM_SIZE:35384,UNIFORM_BLOCK_INDEX:35386,UNIFORM_OFFSET:35387,UNIFORM_ARRAY_STRIDE:35388,UNIFORM_MATRIX_STRIDE:35389,UNIFORM_IS_ROW_MAJOR:35390,UNIFORM_BLOCK_BINDING:35391,UNIFORM_BLOCK_DATA_SIZE:35392,UNIFORM_BLOCK_ACTIVE_UNIFORMS:35394,UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES:35395,UNIFORM_BLOCK_REFERENCED_BY_VERTEX_SHADER:35396,UNIFORM_BLOCK_REFERENCED_BY_FRAGMENT_SHADER:35398,OBJECT_TYPE:37138,SYNC_CONDITION:37139,SYNC_STATUS:37140,SYNC_FLAGS:37141,SYNC_FENCE:37142,SYNC_GPU_COMMANDS_COMPLETE:37143,UNSIGNALED:37144,SIGNALED:37145,ALREADY_SIGNALED:37146,TIMEOUT_EXPIRED:37147,CONDITION_SATISFIED:37148,WAIT_FAILED:37149,SYNC_FLUSH_COMMANDS_BIT:1,COLOR:6144,DEPTH:6145,STENCIL:6146,MIN:32775,MAX:32776,DEPTH_COMPONENT24:33190,STREAM_READ:35041,STREAM_COPY:35042,STATIC_READ:35045,STATIC_COPY:35046,DYNAMIC_READ:35049,DYNAMIC_COPY:35050,DEPTH_COMPONENT32F:36012,DEPTH32F_STENCIL8:36013,INVALID_INDEX:4294967295,TIMEOUT_IGNORED:-1,MAX_CLIENT_WAIT_TIMEOUT_WEBGL:37447,VERTEX_ATTRIB_ARRAY_DIVISOR_ANGLE:35070,UNMASKED_VENDOR_WEBGL:37445,UNMASKED_RENDERER_WEBGL:37446,MAX_TEXTURE_MAX_ANISOTROPY_EXT:34047,TEXTURE_MAX_ANISOTROPY_EXT:34046,COMPRESSED_RGB_S3TC_DXT1_EXT:33776,COMPRESSED_RGBA_S3TC_DXT1_EXT:33777,COMPRESSED_RGBA_S3TC_DXT3_EXT:33778,COMPRESSED_RGBA_S3TC_DXT5_EXT:33779,COMPRESSED_R11_EAC:37488,COMPRESSED_SIGNED_R11_EAC:37489,COMPRESSED_RG11_EAC:37490,COMPRESSED_SIGNED_RG11_EAC:37491,COMPRESSED_RGB8_ETC2:37492,COMPRESSED_RGBA8_ETC2_EAC:37493,COMPRESSED_SRGB8_ETC2:37494,COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:37495,COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2:37496,COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2:37497,COMPRESSED_RGB_PVRTC_4BPPV1_IMG:35840,COMPRESSED_RGBA_PVRTC_4BPPV1_IMG:35842,COMPRESSED_RGB_PVRTC_2BPPV1_IMG:35841,COMPRESSED_RGBA_PVRTC_2BPPV1_IMG:35843,COMPRESSED_RGB_ETC1_WEBGL:36196,COMPRESSED_RGB_ATC_WEBGL:35986,COMPRESSED_RGBA_ATC_EXPLICIT_ALPHA_WEBGL:35986,COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL:34798,UNSIGNED_INT_24_8_WEBGL:34042,HALF_FLOAT_OES:36193,RGBA32F_EXT:34836,RGB32F_EXT:34837,FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT:33297,UNSIGNED_NORMALIZED_EXT:35863,MIN_EXT:32775,MAX_EXT:32776,SRGB_EXT:35904,SRGB_ALPHA_EXT:35906,SRGB8_ALPHA8_EXT:35907,FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING_EXT:33296,FRAGMENT_SHADER_DERIVATIVE_HINT_OES:35723,COLOR_ATTACHMENT0_WEBGL:36064,COLOR_ATTACHMENT1_WEBGL:36065,COLOR_ATTACHMENT2_WEBGL:36066,COLOR_ATTACHMENT3_WEBGL:36067,COLOR_ATTACHMENT4_WEBGL:36068,COLOR_ATTACHMENT5_WEBGL:36069,COLOR_ATTACHMENT6_WEBGL:36070,COLOR_ATTACHMENT7_WEBGL:36071,COLOR_ATTACHMENT8_WEBGL:36072,COLOR_ATTACHMENT9_WEBGL:36073,COLOR_ATTACHMENT10_WEBGL:36074,COLOR_ATTACHMENT11_WEBGL:36075,COLOR_ATTACHMENT12_WEBGL:36076,COLOR_ATTACHMENT13_WEBGL:36077,COLOR_ATTACHMENT14_WEBGL:36078,COLOR_ATTACHMENT15_WEBGL:36079,DRAW_BUFFER0_WEBGL:34853,DRAW_BUFFER1_WEBGL:34854,DRAW_BUFFER2_WEBGL:34855,DRAW_BUFFER3_WEBGL:34856,DRAW_BUFFER4_WEBGL:34857,DRAW_BUFFER5_WEBGL:34858,DRAW_BUFFER6_WEBGL:34859,DRAW_BUFFER7_WEBGL:34860,DRAW_BUFFER8_WEBGL:34861,DRAW_BUFFER9_WEBGL:34862,DRAW_BUFFER10_WEBGL:34863,DRAW_BUFFER11_WEBGL:34864,DRAW_BUFFER12_WEBGL:34865,DRAW_BUFFER13_WEBGL:34866,DRAW_BUFFER14_WEBGL:34867,DRAW_BUFFER15_WEBGL:34868,MAX_COLOR_ATTACHMENTS_WEBGL:36063,MAX_DRAW_BUFFERS_WEBGL:34852,VERTEX_ARRAY_BINDING_OES:34229,QUERY_COUNTER_BITS_EXT:34916,CURRENT_QUERY_EXT:34917,QUERY_RESULT_EXT:34918,QUERY_RESULT_AVAILABLE_EXT:34919,TIME_ELAPSED_EXT:35007,TIMESTAMP_EXT:36392,GPU_DISJOINT_EXT:36795};var Ly=`
uniform sampler2D nodeDepth;
uniform vec2 textureDim;

vec2 getCoordinate(vec3 nodeIdx) {
  // index = r + g * 256 + b * 65536
  // textureDim.x is always power of 2 and <= 65536
  // avoid making big integers (float32 precision)
  float x = nodeIdx.r + nodeIdx.g * 256.0;
  float y = floor(x / textureDim.x);
  x -= y * textureDim.x;
  y += 65536.0 / textureDim.x * nodeIdx.b;
  return vec2(x + 0.5, y + 0.5) / textureDim;
}

bool getDepth(vec3 nodeIdx, out float depth) {
  vec2 coord = getCoordinate(nodeIdx);
  vec4 c = texture2D(nodeDepth, coord);
  depth = c.r * 255.0;
  return c.a == 0.0;
}
`,R6=new Uint8Array(4),yp=class{constructor(e){this._gl=e,this._nodeDepthTextures=[DO(e),DO(e)],this._nodeDepth=this._nodeDepthTextures[0],this._nodeDepthFB=new De(e,{id:"graph-highlighter-framebuffer",width:this._nodeDepthTextures[0].width,height:1,attachments:{[Ne.COLOR_ATTACHMENT0]:this._nodeDepthTextures[0]}}),this._model=O6(e),this._transform=_6(e)}delete(){var e,t,i,n;(e=this._edgeSourceBuffer)==null||e.delete(),(t=this._edgeTargetBuffer)==null||t.delete(),(i=this._edgeDirectionBuffer)==null||i.delete(),(n=this._edgeDepthBuffer)==null||n.delete(),this._nodeDepthTextures.forEach(o=>o.delete()),this._nodeDepthFB.delete(),this._model.delete(),this._transform.delete()}get nodeDepth(){return this._nodeDepth}get edgeDepth(){return this._edgeDepthBuffer}encodeNodeIndex(e,t){return sv(this._nodeMap.get(e.id),t)}getNode(e){return this._nodeList[e]}setGraph(e){if(this._graph===e.graph)return;this._graph=e.graph;let t=this._graph.deepEdgesCount;this._nodeMap=new Map,this._nodeList=[],this._hasBidirectionalEdge=!1,this._lastSourceId=void 0;let i=this._gl;this._edgeSourceBuffer=wy(i,this._edgeSourceBuffer,{size:3,type:Ne.UNSIGNED_BYTE},t),this._edgeTargetBuffer=wy(i,this._edgeTargetBuffer,{size:3,type:Ne.UNSIGNED_BYTE},t),this._edgeDirectionBuffer=wy(i,this._edgeDirectionBuffer,{size:1,type:Ne.UNSIGNED_BYTE},t),this._edgeDepthBuffer=wy(i,this._edgeDepthBuffer,{size:1,type:Ne.FLOAT},t);let n=0,o=0;for(let f of e.nodesBreadthFirst)this._nodeList[n]=f,this._nodeMap.set(f.id,n),n++;let a=new Uint8Array(t*3),l=new Uint8Array(t*3),u=new Uint8Array(t),c=[0,0,0];for(let f of e.deepEdges){let p=this._nodeMap.get(f.source.id);sv(p,c),a.set(c,o*3);let S=this._nodeMap.get(f.target.id);sv(S,c),l.set(c,o*3);let E=Ve.getDrawingObj(f.edge);this._hasBidirectionalEdge=this._hasBidirectionalEdge||!E.directed,u[o]=E.directed?1:0,o++}this._edgeSourceBuffer.subData(a),this._edgeTargetBuffer.subData(l),this._edgeDirectionBuffer.subData(u),this._nodeCount=this._nodeMap.size;let h=this._nodeDepthTextures[0].width,d=Math.ceil((this._nodeCount+1)/h);this._nodeDepthFB.resize({width:h,height:d}),this._transform.update({elementCount:t,sourceBuffers:{source:this._edgeSourceBuffer,target:this._edgeTargetBuffer,direction:this._edgeDirectionBuffer},feedbackBuffers:{nextDepth:this._edgeDepthBuffer}}),this._model.setAttributes({source:this._edgeSourceBuffer,target:this._edgeTargetBuffer,direction:this._edgeDirectionBuffer}),this._model.setVertexCount(t),this.update({sourceId:null})}update(e){let{sourceId:t,edgeDepth:i=!1,maxDepth:n=1}=e;if(t===this._lastSourceId)return;this._lastSourceId=t;let o=[this._nodeDepthFB.width,this._nodeDepthFB.height],a=this._nodeDepthTextures[1],l=this._nodeDepthTextures[0];if(t){let u=this._nodeMap.get(t);this._resetNodeDepth(a,u),this._resetNodeDepth(l,u);for(let c=0;c<n;c++){[a,l]=[l,a],this._nodeDepthFB.attach({[Ne.COLOR_ATTACHMENT0]:l});let h={nodeDepth:a,textureDim:o,testForward:!0};this._updateNodeDepth(h),this._hasBidirectionalEdge&&(h.testForward=!1,this._updateNodeDepth(h))}}else this._resetNodeDepth(l),this._nodeDepthFB.attach({[Ne.COLOR_ATTACHMENT0]:l});this._nodeDepth=l,i&&(this._nodeDepthFB.attach({[Ne.COLOR_ATTACHMENT0]:a}),this._transform.run({framebuffer:this._nodeDepthFB,clearRenderTarget:!1,discard:!0,uniforms:{nodeDepth:l,textureDim:o}}))}_resetNodeDepth(e,t){this._nodeDepthFB.attach({[Ne.COLOR_ATTACHMENT0]:e});let i=this._gl;if(pt(i,{framebuffer:this._nodeDepthFB,viewport:[0,0,e.width,e.height],clearColor:[1,1,1,1]},()=>{i.clear(Ne.COLOR_BUFFER_BIT)}),t!==void 0){let n=(t+1)%e.width,o=Math.floor((t+1)/e.width);e.setSubImageData({data:R6,x:n,y:o,width:1,height:1})}}_updateNodeDepth(e){this._model.draw({framebuffer:this._nodeDepthFB,uniforms:e,parameters:{depthTest:!1,blend:!0,viewport:[0,0,this._nodeDepthFB.width,this._nodeDepthFB.height],blendFunc:[Ne.ONE,Ne.ONE,Ne.ONE,Ne.ONE],blendEquation:[Ne.MIN,Ne.MIN]}})}};function wy(s,e,t,i){e||(e=new ye(s,{target:s.ARRAY_BUFFER,accessor:t}));let n=i*t.size*(t.type===Ne.UNSIGNED_BYTE?1:4);return e.byteLength<n&&e.reallocate(n),e}function DO(s){let e=s.getParameter(s.MAX_TEXTURE_SIZE);return e=Math.min(1024,2**Math.floor(Math.log2(e))),new Ue(s,{format:Ne.RGBA,type:Ne.UNSIGNED_BYTE,border:0,mipmaps:!1,dataFormat:Ne.RGBA,width:e,height:1,parameters:{[Ne.TEXTURE_MIN_FILTER]:Ne.NEAREST,[Ne.TEXTURE_MAG_FILTER]:Ne.NEAREST,[Ne.TEXTURE_WRAP_S]:Ne.CLAMP_TO_EDGE,[Ne.TEXTURE_WRAP_T]:Ne.CLAMP_TO_EDGE}})}function O6(s){return new At(s,{id:"graph-highlighter-nodes",vs:`
#define SHADER_NAME graph-highlighter-nodes-vertex-shader

uniform bool testForward;

attribute vec3 source;
attribute vec3 target;
attribute float direction;

varying float targetDepth;

${Ly}

void main(void) {
  vec3 sourceIdx = source;
  vec3 targetIdx = target;
  if (!testForward && direction == 0.0) {
    sourceIdx = target;
    targetIdx = source;
  }
  float sourceDepth;
  bool sourceDepthValid = getDepth(sourceIdx, sourceDepth);
  vec2 targetCoord = getCoordinate(targetIdx);

  gl_Position = vec4(targetCoord * 2.0 - 1.0, sourceDepthValid ? 0.0 : 2.0, 1.0);
  gl_PointSize = 1.0;

  targetDepth = sourceDepth + 1.0;
}
`,fs:`
#define SHADER_NAME graph-highlighter-nodes-fragment-shader
varying float targetDepth;

void main(void) {
  gl_FragColor = vec4(targetDepth / 255.0, 0.0, 0.0, 0.0);
}`,isInstanced:!1,drawMode:Ne.POINTS})}function _6(s){return new on(s,{vs:`
#define SHADER_NAME graph-highlighter-edges-vertex-shader

attribute vec3 source;
attribute vec3 target;
attribute float direction;

varying float nextDepth;

${Ly}

float getDepth(vec3 sourceIdx) {
  float sourceDepth;
  if (getDepth(sourceIdx, sourceDepth)) {
    return sourceDepth + 1.0;
  }
  return 255.0;
}

void main(void) {
  nextDepth = getDepth(source);
  if (direction == 0.0) {
    nextDepth = min(nextDepth, getDepth(target));
  }

  gl_Position = vec4(0.0);
}
`,varyings:["nextDepth"]})}function sv(s,e){return e[0]=s+1&255,e[1]=s+1>>8&255,e[2]=s+1>>8>>8&255,e}var N6={lineWidthUnits:"common",lineWidthScale:{type:"number",min:0,value:1},lineWidthMinPixels:{type:"number",min:0,value:0},lineWidthMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},sizeScale:{type:"number",min:0,value:1},stroked:!0,filled:!0,cornerRadius:{type:"number",min:0,value:0},highlightColors:{type:"array",compare:!0,value:[[255,100,0],[255,200,80],[255,255,200]]},getPickingColor:{type:"accessor",value:[0,0,0]},getPosition:{type:"accessor",value:s=>s.position},getSize:{type:"accessor",value:s=>s.size},getFillColor:{type:"accessor",value:[255,255,255,255]},getLineColor:{type:"accessor",value:[0,0,0,255]},getLineWidth:{type:"accessor",value:1},getShape:{type:"accessor",value:0}},M6=`#define SHADER_NAME geometry-layer-vertex-shader
attribute vec2 positions;
attribute vec3 instancePositions;
attribute vec3 instancePositions64Low;
attribute vec2 instanceSizes;
attribute float instanceShapes;
attribute float instanceLineWidths;
attribute vec4 instanceFillColors;
attribute vec4 instanceLineColors;
attribute vec3 instancePickingColors;

uniform mat4 depthHighlightColors;
uniform float opacity;
uniform float sizeScale;
uniform float lineWidthScale;
uniform float lineWidthMinPixels;
uniform float lineWidthMaxPixels;
uniform bool stroked;
uniform bool filled;
uniform int lineWidthUnits;

varying vec4 vFillColor;
varying vec4 vLineColor;
varying vec2 vPosition;
varying vec4 shape; // [width, height, lineWidth, SHAPE]

${Ly}

void applyHighlight(int i) {
  if (i >= 3) return;
  vFillColor.rgb = mix(vFillColor.rgb, depthHighlightColors[i].rgb, depthHighlightColors[i].a);
}

void main(void) {
  geometry.worldPosition = instancePositions;

  // Multiply out line width and clamp to limits
  float lineWidthPixels = clamp(
    project_size_to_pixel(lineWidthScale * instanceLineWidths, lineWidthUnits),
    lineWidthMinPixels, lineWidthMaxPixels
  );
  float lineWidthCommon = project_pixel_size(lineWidthPixels);

  geometry.uv = positions.xy;

  vec3 offset = vec3((instanceSizes * sizeScale + 1.0) / 2.0 * positions.xy, 0.0);
  DECKGL_FILTER_SIZE(offset, geometry);
  
  vPosition = offset.xy;
  shape = vec4(instanceSizes * sizeScale, lineWidthCommon, instanceShapes);

  gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset, geometry.position);

  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
  // Apply opacity to instance color, or return instance picking color
  vFillColor = vec4(instanceFillColors.rgb, instanceFillColors.a * opacity);
  DECKGL_FILTER_COLOR(vFillColor, geometry);
  vLineColor = vec4(instanceLineColors.rgb, instanceLineColors.a * opacity);
  DECKGL_FILTER_COLOR(vLineColor, geometry);

  picking_setPickingColor(instancePickingColors);

  float depth;
  if (getDepth(instancePickingColors, depth)) {
    applyHighlight(int(depth));
  }
}
`,B6=`#define SHADER_NAME geometry-layer-fragment-shader
#define RECTANGLE 0.0
#define OVAL      1.0
#define DIAMOND   2.0

#define SIN_60 0.8660254

precision highp float;

uniform bool filled;
uniform bool stroked;
uniform float cornerRadius;
uniform float project_uScale;

varying vec4 vFillColor;
varying vec4 vLineColor;
varying vec2 vPosition;
varying vec4 shape; // [width, height, lineWidth, SHAPE]

float smoothedgeCommon(float edge, float x) {
  float radius = 0.5 / project_uScale;
  return smoothstep(edge - radius, edge + radius, x);
}

float smoothedgeCommon(float edge, float x, float maxRadius) {
  float radius = min(0.5 / project_uScale, maxRadius);
  return smoothstep(edge - radius, edge + radius, x);
}

float inRectangle(vec2 halfSize, float radius) {
  vec2 edgeVec = halfSize - abs(vPosition);
  float edgeDistance = min(edgeVec.x, edgeVec.y);
  float inside = smoothedgeCommon(0.0, edgeDistance);
  if (radius == 0.0) {
    return inside;
  }
  vec2 cornerVec = radius - edgeVec;
  cornerVec *= float(cornerVec.x > 0.0 && cornerVec.y > 0.0);
  float outCorner = smoothedgeCommon(radius, length(cornerVec), radius / 2.0);
  return inside * (1.0 - outCorner);
}

float inOval(vec2 halfSize) {
  float aspect = halfSize.x / halfSize.y;
  return smoothedgeCommon(length(vec2(vPosition.x, vPosition.y * aspect)), halfSize.x);
}

float inDiamond(vec2 halfSize) {
  float aspect = halfSize.x / halfSize.y;
  vec2 edgeVec = abs(vPosition);
  return smoothedgeCommon(edgeVec.x, halfSize.x - edgeVec.y * aspect);
}

void main(void) {
  float inShape;
  float inFill;
  float lineWidth = shape.z;
  float type = shape.w;
  vec2 halfSize = shape.xy / 2.0;

  if (type == RECTANGLE)
  {
    inShape = inRectangle(halfSize, cornerRadius);
    inFill = inRectangle(halfSize - lineWidth, max(cornerRadius - lineWidth, 0.0));
  }
  else if (type == OVAL)
  {
    inShape = inOval(halfSize);
    inFill = inOval(halfSize - lineWidth);
  }
  else if (type == DIAMOND)
  {
    inShape = inDiamond(halfSize);
    float c = length(halfSize);
    float cscA = c / halfSize.y;
    float secA = c / halfSize.x;
    inFill = inDiamond(halfSize - lineWidth * vec2(cscA, secA));
  }

  if (inShape == 0.0) {
    discard;
  }
  if (picking_uActive) {
    gl_FragColor = picking_filterPickingColor(vFillColor);
    return;
  }

  if (stroked) {
    if (filled) {
      gl_FragColor = mix(vLineColor, vFillColor, inFill);
    } else {
      if (inFill == 1.0) {
        discard;
      }
      gl_FragColor = vec4(vLineColor.rgb, vLineColor.a * (1.0 - inFill));
    }
  } else if (filled) {
    gl_FragColor = vFillColor;
  } else {
    discard;
  }

  gl_FragColor.a *= inShape;
  DECKGL_FILTER_COLOR(gl_FragColor, geometry);
}
`,nc=class extends kt{getShaders(){return super.getShaders({vs:M6,fs:B6,modules:[ai,hl]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:Ne.DOUBLE,fp64:!0,transition:!0,accessor:"getPosition"},instanceSizes:{size:2,transition:!0,accessor:"getSize"},instanceFillColors:{size:4,transition:!0,normalized:!0,type:Ne.UNSIGNED_BYTE,accessor:"getFillColor",defaultValue:[0,0,0,255]},instanceLineColors:{size:4,transition:!0,normalized:!0,type:Ne.UNSIGNED_BYTE,accessor:"getLineColor",defaultValue:[0,0,0,255]},instanceLineWidths:{size:1,transition:!0,accessor:"getLineWidth",defaultValue:1},instanceShapes:{size:1,type:Ne.UNSIGNED_BYTE,accessor:"getShape"},instancePickingColors:{size:3,type:Ne.UNSIGNED_BYTE,accessor:"getPickingColor"}})}updateState(t){var l;super.updateState(t);let{props:i,oldProps:n,changeFlags:o}=t,a=!1;if(o.extensionsChanged){let{gl:u}=this.context;(l=this.state.model)==null||l.delete(),this.state.model=this._getModel(u),this.getAttributeManager().invalidateAll(),a=!0}if(a||i.highlightColors!==n.highlightColors){let u=new Float32Array(16);for(let c=0;c<4;c++){let h=i.highlightColors[c];h&&(u[c*4]=h[0]/255,u[c*4+1]=h[1]/255,u[c*4+2]=h[2]/255,u[c*4+3]=Number.isFinite(h[3])?h[3]/255:1)}this.state.model.setUniforms({depthHighlightColors:u})}}draw({uniforms:t}){let{stroked:i,filled:n,cornerRadius:o,sizeScale:a,lineWidthUnits:l,lineWidthScale:u,lineWidthMinPixels:c,lineWidthMaxPixels:h,nodeDepth:d}=this.props;this.state.model.setUniforms(t).setUniforms({stroked:i,filled:n,cornerRadius:o,sizeScale:a,lineWidthUnits:Ur[l],lineWidthScale:u,lineWidthMinPixels:c,lineWidthMaxPixels:h,nodeDepth:d,textureDim:[d.width,d.height]}).draw()}_getModel(t){let i=[-1,-1,1,-1,1,1,-1,1];return new At(t,{...this.getShaders(),id:this.props.id,geometry:new pr({drawMode:Ne.TRIANGLE_FAN,vertexCount:4,attributes:{positions:{size:2,value:new Float32Array(i)}}}),isInstanced:!0})}};nc.defaultProps=N6,nc.layerName="GeometryLayer";var as=class extends $s{constructor(t){let i={},n=!1,o=!1;for(let a in t.overrideProps){let l=t.overrideProps[a];l!==null&&(i[a]=l,n=!0,typeof l=="function"&&(o=!0))}super({overrideProps:i});this.isEnabled=!1;this.isDynamic=!1;this.isEnabled=n,this.isDynamic=o}updateState(t,i){if(!i.isEnabled)return;let n=this.getAttributeManager();if(!!n&&Object.isFrozen(this.props)){let o=this.props,a={},l=Object.create(this.props),{overrideProps:u}=i.opts;for(let c in u)if(Object.defineProperty(l,c,{get:()=>G6(c,u[c],D6(this),o[c])}),typeof u[c]=="function"&&c.startsWith("get")){let h=n.updateTriggers[c][0];a[c]=n.attributes[h]}this.setState({modifiedProps:l,dynamicAttributes:a}),this.props=l}}draw(t,i){if(!i.isEnabled)return;let{modifiedProps:n,dynamicAttributes:o}=this.state;if(this.props=n,"opacity"in i.opts.overrideProps&&(t.uniforms.opacity=Math.pow(n.opacity,1/2.2)),!!i.isDynamic)for(let a in o)o[a].setConstantValue(n[a])}};function D6(s){return{zoom:s.context.viewport.zoom}}function G6(s,e,t,i){let n;return typeof e=="function"?n=e(t):n=e,typeof n=="number"&&s.endsWith("Scale")&&(n*=i),n}function FO(s,e){return[new nc(s,{id:`${s.id}-node-boundary`,lineWidthUnits:"pixels",getPosition:kO,getSize:t=>[t.boundingBox.width,t.boundingBox.height],getShape:t=>W6(t.node),cornerRadius:U6(s.data[0]),getLineColor:GO,getFillColor:z6,extensions:[new as({overrideProps:{opacity:e.opacity,sizeScale:e.size,getFillColor:e.fillColor,getLineWidth:e.strokeWidth,getLineColor:e.strokeColor}})]}),new Bi(s,{id:`${s.id}-node-label`,getPosition:F6,getText:k6,getSize:V6,getColor:GO,billboard:!1,sizeUnits:"common",characterSet:"auto",extensions:[new as({overrideProps:{opacity:e.opacity,getColor:e.labelColor,sizeScale:e.labelSize}})]})]}function kO(s,{index:e,data:t}){return[s.center.x,s.center.y,1-e/t.length]}function F6(s,e){if(s instanceof be){let t=s.boundingBox;return[t.center.x,t.bottom+s.labelSize.height/2+2]}return kO(s,e)}function k6(s){return nd(s.node).labelText}function V6(s){return nd(s.node).fontsize}function U6(s){return s?nd(s.node).xRad:0}function GO(s){let e=nd(s.node);if(e){let t=e.pencolor;if(t)return[t.R,t.G,t.B,t.A]}return[0,0,0,255]}function z6(s){let e=nd(s.node);if(e){let t=e.fillColor;if(t)return[t.R,t.G,t.B,t.A]}return[255,255,255,255]}function W6(s){let e=nd(s);if(e==null)return 0;switch(e.shape){case 0:return 2;case 1:return 1;case 2:return 0;case 3:return 1;case 4:return 0;case 5:return 1;case 6:return 1;case 10:return 1;case 14:return 1;case 18:return 0;case 11:return 0;case 12:return 0;default:return 0}}function nd(s){return Ve.getDrawingObj(s)}var H6="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4KPHN2ZyB2ZXJzaW9uPSIxLjEiIGJhc2VQcm9maWxlPSJ0aW55IiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB2aWV3Qm94PSIwIDAgNjQgMzIiIG92ZXJmbG93PSJ2aXNpYmxlIiB4bWw6c3BhY2U9InByZXNlcnZlIj4KPGc+IDxyZWN0IGZpbGw9Im5vbmUiIHdpZHRoPSI4IiBoZWlnaHQ9IjE2Ii8+IDxwb2x5Z29uIHBvaW50cz0iMS42NSwxNC4zNSAwLjk0LDEzLjY1IDYuNTksOCAwLjk0LDIuMzUgMS42NSwxLjY1IDgsOCAJIi8+CjwvZz4KPGc+IDxyZWN0IHg9IjgiIGZpbGw9Im5vbmUiIHdpZHRoPSI4IiBoZWlnaHQ9IjgiLz4gPHBvbHlnb24gcG9pbnRzPSIxMi42NSw3LjM1IDExLjk0LDYuNjUgMTQuNTksNCAxMS45NCwxLjM1IDEyLjY1LDAuNjUgMTYsNCAJIi8+CjwvZz4KPGc+IDxyZWN0IHg9IjgiIHk9IjgiIGZpbGw9Im5vbmUiIHdpZHRoPSI4IiBoZWlnaHQ9IjgiLz4gPHBvbHlsaW5lIHBvaW50cz0iMTQuNTksMTIgMTEuOTQsOS4zNSAxMi42NSw4LjY1IDE2LDEyIAkiLz4KPC9nPgo8Zz4gPHJlY3QgeD0iMTYiIGZpbGw9Im5vbmUiIHdpZHRoPSI4IiBoZWlnaHQ9IjgiLz4gPHBvbHlsaW5lIHBvaW50cz0iMjAsMSAyNCw0IDIwLDcgCSIvPgo8L2c+CjxnPiA8cmVjdCB4PSI0OCIgZmlsbD0ibm9uZSIgd2lkdGg9IjgiIGhlaWdodD0iOCIvPiA8cGF0aCBkPSJNNTAsM2MwLjU1LDAsMSwwLjQ1LDEsMXMtMC40NSwxLTEsMXMtMS0wLjQ1LTEtMVM0OS40NSwzLDUwLDMgTTUwLDJjLTEuMSwwLTIsMC45LTIsMnMwLjksMiwyLDJzMi0wLjksMi0yUzUxLjEsMiw1MCwyIEw1MCwyeiIvPgo8L2c+CjxnPiA8cmVjdCB4PSI0OCIgeT0iOCIgZmlsbD0ibm9uZSIgd2lkdGg9IjgiIGhlaWdodD0iOCIvPiA8cGF0aCBkPSJNNTEsMTBjMS4xLDAsMiwwLjksMiwycy0wLjksMi0yLDJzLTItMC45LTItMlM0OS45LDEwLDUxLDEwIE01MSw5Yy0xLjY2LDAtMywxLjM0LTMsM3MxLjM0LDMsMywzczMtMS4zNCwzLTNTNTIuNjYsOSw1MSw5IEw1MSw5eiIvPgo8L2c+CjxnPiA8cmVjdCB4PSIzMiIgZmlsbD0ibm9uZSIgd2lkdGg9IjgiIGhlaWdodD0iMTYiLz4gPHBvbHlsaW5lIHBvaW50cz0iMzYsMyA0MCw4IDM2LDEzIAkiLz4KPC9nPgo8Zz4gPHJlY3QgeD0iMjQiIGZpbGw9Im5vbmUiIHdpZHRoPSI4IiBoZWlnaHQ9IjgiLz4gPHBvbHlsaW5lIHBvaW50cz0iMjYsMiAzMiw0IDI2LDYgCSIvPgo8L2c+CjxnPiA8cmVjdCB4PSIxNiIgeT0iOCIgZmlsbD0ibm9uZSIgd2lkdGg9IjgiIGhlaWdodD0iOCIvPiA8cG9seWxpbmUgcG9pbnRzPSIyMCw5IDI0LDEyIDIwLDEyIAkiLz4KPC9nPgo8Zz4gPHJlY3QgeD0iMjQiIHk9IjgiIGZpbGw9Im5vbmUiIHdpZHRoPSI4IiBoZWlnaHQ9IjgiLz4gPHBvbHlsaW5lIHBvaW50cz0iMjYsMTAgMzIsMTIgMjYsMTIgCSIvPgo8L2c+CjxnPiA8cmVjdCB4PSI1NiIgZmlsbD0ibm9uZSIgd2lkdGg9IjgiIGhlaWdodD0iOCIvPiA8Y2lyY2xlIGN4PSI1OCIgY3k9IjQiIHI9IjIiLz4KPC9nPgo8Zz4gPHJlY3QgeD0iNTYiIHk9IjgiIGZpbGw9Im5vbmUiIHdpZHRoPSI4IiBoZWlnaHQ9IjgiLz4gPGNpcmNsZSBjeD0iNTkiIGN5PSIxMiIgcj0iMyIvPgo8L2c+Cjwvc3ZnPgo=",av=4,Ry;function VO(s){return Ry||(Ry=typeof Image!="undefined"&&$o(H6,xu,{imagebitmap:{resizeWidth:256*av,resizeHeight:128*av}}).then(e=>{let t=new Ue(s,{data:e,parameters:{[s.TEXTURE_MIN_FILTER]:s.LINEAR_MIPMAP_LINEAR,[s.TEXTURE_MAG_FILTER]:s.LINEAR,[s.TEXTURE_WRAP_S]:s.CLAMP_TO_EDGE,[s.TEXTURE_WRAP_T]:s.CLAMP_TO_EDGE}});return Ry=t,t})),Ry}var UO=j6({caret:{mask:!0,x:32,y:0,width:32,height:32,anchorX:32},"half-caret":{mask:!0,x:32,y:32,width:32,height:32,anchorX:32},"caret-lg":{mask:!0,x:0,y:0,width:32,height:64,anchorX:32},triangle:{mask:!0,x:64,y:0,width:32,height:32,anchorX:32},"triangle-ex":{mask:!0,x:64,y:0,width:32,height:32},"half-triangle":{mask:!0,x:64,y:32,width:32,height:32,anchorX:32},"half-triangle-ex":{mask:!0,x:64,y:32,width:32,height:32},"triangle-n":{mask:!0,x:104,y:4,width:24,height:24,anchorX:24},"triangle-n-ex":{mask:!0,x:96,y:0,width:32,height:32,anchorX:8},"half-triangle-n":{mask:!0,x:96,y:32,width:32,height:32,anchorX:32},"half-triangle-n-ex":{mask:!0,x:96,y:32,width:32,height:32,anchorX:8},"triangle-w":{mask:!0,x:128,y:0,width:32,height:64,anchorX:32},"triangle-w-ex":{mask:!0,x:128,y:0,width:32,height:64},"circle-ex":{mask:!0,x:192,y:0,width:32,height:32,anchorX:0},"circle-lg-ex":{mask:!0,x:192,y:32,width:32,height:32,anchorX:0},dot:{mask:!0,x:224,y:0,width:32,height:32,anchorX:8},"dot-ex":{mask:!0,x:224,y:0,width:32,height:32,anchorX:0},"dot-lg":{mask:!0,x:224,y:32,width:32,height:32,anchorX:12},"dot-lg-ex":{mask:!0,x:224,y:32,width:32,height:32,anchorX:0}},av);function j6(s,e){for(let t in s){let i=s[t];i.x*=e,i.y*=e,i.width*=e,i.height*=e,i.anchorX&&(i.anchorX*=e),i.anchorY&&(i.anchorY*=e)}return s}var q6={widthUnits:"common",widthScale:{type:"number",min:0,value:1},widthMinPixels:{type:"number",min:0,value:0},widthMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},getControlPoints:{type:"accessor",value:s=>s.points},getCurveType:{type:"accessor",value:0},getResolution:{type:"accessor",value:4},getRange:{type:"accessor",value:[0,1]},getWidth:{type:"accessor",value:1},getColor:{type:"accessor",value:[0,0,0,255]}},X6=`#define SHADER_NAME curve-layer-vertex-shader
#define LINE    0.0
#define BEZIER  1.0
#define ARC     2.0

attribute vec2 positions;
attribute vec2 instanceSegments;
attribute vec4 instancePositions1;
attribute vec4 instancePositions2;
attribute float instanceTypes;
attribute float instanceWidths;
attribute vec4 instanceColors;

uniform float opacity;
uniform float widthScale;
uniform float widthMinPixels;
uniform float widthMaxPixels;
uniform int widthUnits;

varying vec4 vColor;

void interpolateLine(float t, vec2 start, vec2 end, out vec2 point) {
  point = mix(start, end, t);
}

void interpolateBezierCurve(float t, vec2 start, vec2 c1, vec2 c2, vec2 end, out vec2 point) {
  vec2 c = (c1 - start) * 3.0;
  vec2 e = (c2 - c1) * 3.0 - c;
  vec2 l = end - start - c - e;

  float t2 = t * t;
  float t3 = t2 * t;
  
  point = l * t3 + e * t2 + c * t + start;
}

void interpolateArc(float t, vec2 center, vec2 aAxis, vec2 bAxis, out vec2 point) {
  point = center + cos(t) * aAxis + sin(t) * bAxis;
}

vec2 getExtrusionOffset(vec2 line, float offset_direction, float width) {
  // normalized direction of the line
  vec2 dir = normalize(line);
  // rotate by 90 degrees
  dir = vec2(-dir.y, dir.x);
  return dir * offset_direction * width / 2.0;
}

void main(void) {
  // Multiply out line width and clamp to limits
  float widthPixels = clamp(
    project_size_to_pixel(widthScale * instanceWidths, widthUnits),
    widthMinPixels, widthMaxPixels
  );
  float widthCommon = project_pixel_size(widthPixels);

  geometry.uv = positions.xy;

  vec2 pointOnCurve;
  vec2 nextPointOnCurve;
  vec2 pointOnCurve64Low = vec2(0.0);
  float r = instanceSegments.x + positions.x * instanceSegments.y;
  float rNext = r + instanceSegments.y;

  if (instanceTypes == BEZIER) {
    interpolateBezierCurve(r, instancePositions1.xy, instancePositions1.zw, instancePositions2.xy, instancePositions2.zw, pointOnCurve);
    interpolateBezierCurve(rNext, instancePositions1.xy, instancePositions1.zw, instancePositions2.xy, instancePositions2.zw, nextPointOnCurve);
  }
  else if (instanceTypes == ARC) {
    interpolateArc(r, instancePositions1.xy, instancePositions1.zw, instancePositions2.xy, pointOnCurve);
    interpolateArc(rNext, instancePositions1.xy, instancePositions1.zw, instancePositions2.xy, nextPointOnCurve);
  }
  else {
    interpolateLine(r, instancePositions1.xy, instancePositions1.zw, pointOnCurve);
    interpolateLine(rNext, instancePositions1.xy, instancePositions1.zw, nextPointOnCurve);
  }
  
  vec3 offset = vec3(getExtrusionOffset(
    nextPointOnCurve - pointOnCurve,
    positions.y,
    widthCommon), 0.0);

  gl_Position = project_position_to_clipspace(
    vec3(pointOnCurve, 0.0),
    vec3(pointOnCurve64Low, 0.0),
    offset,
    geometry.position);

  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
  // Apply opacity to instance color, or return instance picking color
  vColor = vec4(instanceColors.rgb, instanceColors.a * opacity);
  DECKGL_FILTER_COLOR(vColor, geometry);
}
`,Y6=`#define SHADER_NAME curve-layer-fragment-shader
varying vec4 vColor;

void main(void) {
  gl_FragColor = vColor;
  DECKGL_FILTER_COLOR(gl_FragColor, geometry);
}
`,oc=class extends kt{getShaders(){return super.getShaders({vs:X6,fs:Y6,modules:[ai,hl]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:8,transition:!0,accessor:"getControlPoints",shaderAttributes:{instancePositions1:{size:4},instancePositions2:{size:4,elementOffset:4}}},instanceSegments:{size:2,update:this._getSegments},instanceTypes:{size:1,type:Ne.UNSIGNED_BYTE,accessor:"getCurveType"},instanceWidths:{size:1,transition:!0,accessor:"getWidth",defaultValue:1},instanceColors:{size:4,transition:!0,normalized:!0,type:Ne.UNSIGNED_BYTE,accessor:"getColor",defaultValue:[0,0,0,255]}})}updateState(t){var o;super.updateState(t);let{props:i,changeFlags:n}=t;if(n.dataChanged&&this.updateGeometry(),n.extensionsChanged){let{gl:a}=this.context;(o=this.state.model)==null||o.delete(),this.state.model=this._getModel(a),this.getAttributeManager().invalidateAll()}}updateGeometry(){let{data:t,getResolution:i,getCurveType:n,getRange:o}=this.props,{iterable:a,objectInfo:l}=Po(t),u=[0],c=0,h=[];for(let d of a){l.index++;let f=typeof n=="function"?n(d,l):n,p=typeof o=="function"?o(d,l):o,S=f===0?1:Math.ceil(typeof i=="function"?i(d,l):i);c+=S;let E=(p[1]-p[0])/S;u.push(c);for(let C=0;C<S;C++)h.push(p[0]+E*C,E)}this.setState({startIndices:u,numInstances:c,segments:new Float32Array(h)})}draw({uniforms:t}){let{widthUnits:i,widthScale:n,widthMinPixels:o,widthMaxPixels:a}=this.props;this.state.model.setUniforms(t).setUniforms({widthUnits:Ur[i],widthScale:n,widthMinPixels:o,widthMaxPixels:a}).draw()}_getModel(t){let i=[0,-1,1,-1,1,1,0,1];return new At(t,{...this.getShaders(),id:this.props.id,geometry:new pr({drawMode:Ne.TRIANGLE_FAN,vertexCount:4,attributes:{positions:{size:2,value:new Float32Array(i)}}}),isInstanced:!0})}_getSegments(t){t.value=this.state.segments}};oc.layerName="CurveLayer",oc.defaultProps=q6;function zO(s,e){return new oc(s,{id:`${s.id}-edge`,data:s.data,getCurveType:K6,getControlPoints:Z6,getRange:t=>[t.startPar,t.endPar],widthUnits:"pixels",getResolution:t=>t.curve.length*s.resolution,clipByInstance:!1,extensions:[new as({overrideProps:{opacity:e.opacity,getWidth:e.strokeWidth,getColor:e.strokeColor}})]})}function WO(s,e){return new Gn(s,{id:`${s.id}-arrowhead`,iconAtlas:"deck://arrowAtlas",iconMapping:UO,getPosition:t=>[t.tip.x,t.tip.y],getColor:t=>Q6(t.edge),getIcon:t=>J6(t.edge),getSize:t=>$6(t.tip,t.base),getAngle:t=>e8(t.tip,t.base),billboard:!1,sizeUnits:"common",extensions:[new as({overrideProps:{opacity:e.opacity,sizeScale:e.arrowSize,getColor:e.arrowColor}})]})}function HO(s,e){return new Bi(s,{id:`${s.id}-edge-label`,getText:t8,getSize:r8,getColor:i8,getPosition:t=>[t.center.x,t.center.y],sizeUnits:"common",characterSet:"auto",extensions:[new as({overrideProps:{opacity:e.opacity,sizeScale:e.labelSize,getColor:e.labelColor}})]})}function K6(s){return s.curve instanceof pe?2:s.curve instanceof Me?1:0}function Z6(s){let e=s.curve;return e instanceof pe?[e.center,e.aAxis,e.bAxis].flatMap(lv):e instanceof Me?e.b.flatMap(lv):[e.start,e.end].flatMap(lv)}function lv(s){return[s.x,s.y]}function Q6(s){let e=Oy(s);if(e){let t=e.color;if(t)return[t.R,t.G,t.B]}return[0,0,0]}function J6(s){return"triangle-n"}function $6(s,e){let t=s.x-e.x,i=s.y-e.y;return Math.sqrt(t*t+i*i)}function e8(s,e){let t=s.x-e.x,i=s.y-e.y;return Math.atan2(i,t)/Math.PI*180}function t8(s){return Oy(s.parent.entity).labelText}function r8(s){return Oy(s.parent.entity).fontsize}function i8(s){let e=Oy(s.parent.entity).labelfontcolor;return e?[e.R,e.G,e.B]:[0,0,0]}function Oy(s){return Ve.getDrawingObj(s)}var sc=class extends un{updateState({props:t,oldProps:i,changeFlags:n}){let{graphStyle:o}=t;if(n.dataChanged||o!==i.graphStyle){let a=t.data,l={tileMap:t.tileMap},u={};for(let c of o.layers){let h=new Ro(null);u[c.id]=h,c.type==="node"&&(h.nodes=c.filter?a.nodes.filter(d=>c.filter(d.node,l)):a.nodes),c.type==="edge"&&(h.curveClips=c.filter?a.curveClips.filter(d=>c.filter(d.edge,l)):a.curveClips,h.arrowheads=c.filter?a.arrowheads.filter(d=>c.filter(d.edge,l)):a.arrowheads,h.labels=c.filter?a.labels.filter(d=>c.filter(d.parent.entity,l)):a.labels)}this.setState({layerMap:u})}}getPickingInfo({sourceLayer:t,info:i}){return t.id.endsWith("node-boundary")&&i.picked&&(i.object=this.props.highlighter.getNode(i.index)),i}filterSubLayer({layer:t,viewport:i}){let n=t.props.layerStyle,{zoom:o}=i;return n.minZoom<=o&&n.maxZoom>=o}renderLayers(){let{layerMap:t}=this.state,{graphStyle:i,highlighter:n,resolution:o,fontFamily:a,fontWeight:l,lineHeight:u,tile:c,modelMatrix:h}=this.props,d=i.layers.length,f=c.bbox.right-c.bbox.left;return i.layers.map((p,S)=>{var B,A,N,z;let E=t[p.id],C=[],O=this.getSubLayerProps({id:p.id});return Object.assign(O,{layerStyle:p,modelMatrix:new $e(h).scale([1,1,-f/16]),parameters:{depthRange:[1-(S+1)/d,1-S/d]}}),((B=E.nodes)==null?void 0:B.length)>0&&C.push(FO({...O,data:E.nodes,getPickingColor:(Y,{target:ie})=>n.encodeNodeIndex(Y,ie),nodeDepth:n.nodeDepth,fontFamily:a,fontWeight:l,lineHeight:u},p)),((A=E.curveClips)==null?void 0:A.length)>0&&C.push(zO({...O,data:E.curveClips,getDepth:n.edgeDepth,resolution:o},p)),((N=E.arrowheads)==null?void 0:N.length)>0&&C.push(WO({...O,data:E.arrowheads},p)),((z=E.labels)==null?void 0:z.length)>0&&C.push(HO({...O,data:E.labels,fontFamily:a,fontWeight:l,lineHeight:u},p)),C})}};sc.defaultProps={...Bi.defaultProps,resolution:{type:"number",value:1},highlighter:{type:"object"},fontSize:{type:"number",value:16}},sc.layerName="Graphayer";function jO(s,e,t){t[s]=t[s]||[],t[s].indexOf(e)<0&&t[s].push(e)}function uv(s,e,t){if(t[s]){let i=t[s].indexOf(e);i>=0&&t[s].splice(i,1)}}var Sp=class{constructor(){this._listeners={};this._onceListeners={}}on(e,t){jO(e,t,this._listeners)}once(e,t){jO(e,t,this._onceListeners)}off(e,t){uv(e,t,this._listeners),uv(e,t,this._onceListeners)}emit(e){var a,l;let t;typeof e=="string"?t={type:e}:t=e;let i=t.type;if(!this._listens(i))return;t.target=this;let n=((a=this._listeners[i])==null?void 0:a.slice())||[];for(let u of n)u.call(this,t);let o=((l=this._onceListeners[i])==null?void 0:l.slice())||[];for(let u of o)uv(i,u,this._onceListeners),u.call(this,t)}_listens(e){return this._listeners[e]&&this._listeners[e].length>0||this._onceListeners[e]&&this._onceListeners[e].length>0}};var qO={version:1,layers:[{type:"node"},{type:"edge"}]};function ac(s,e){return s==null||e==null?NaN:s<e?-1:s>e?1:s>=e?0:NaN}function cv(s,e){return s==null||e==null?NaN:e<s?-1:e>s?1:e>=s?0:NaN}function _y(s){let e,t,i;s.length!==2?(e=ac,t=(l,u)=>ac(s(l),u),i=(l,u)=>s(l)-u):(e=s===ac||s===cv?s:n8,t=s,i=s);function n(l,u,c=0,h=l.length){if(c<h){if(e(u,u)!==0)return h;do{let d=c+h>>>1;t(l[d],u)<0?c=d+1:h=d}while(c<h)}return c}function o(l,u,c=0,h=l.length){if(c<h){if(e(u,u)!==0)return h;do{let d=c+h>>>1;t(l[d],u)<=0?c=d+1:h=d}while(c<h)}return c}function a(l,u,c=0,h=l.length){let d=n(l,u,c,h-1);return d>c&&i(l[d-1],u)>-i(l[d],u)?d-1:d}return{left:n,center:a,right:o}}function n8(){return 0}function hv(s){return s===null?NaN:+s}var XO=_y(ac),YO=XO.right,o8=XO.left,s8=_y(hv).center,dv=YO;var fv=Math.sqrt(50),gv=Math.sqrt(10),pv=Math.sqrt(2);function Ny(s,e,t){var i,n=-1,o,a,l;if(e=+e,s=+s,t=+t,s===e&&t>0)return[s];if((i=e<s)&&(o=s,s=e,e=o),(l=My(s,e,t))===0||!isFinite(l))return[];if(l>0){let u=Math.round(s/l),c=Math.round(e/l);for(u*l<s&&++u,c*l>e&&--c,a=new Array(o=c-u+1);++n<o;)a[n]=(u+n)*l}else{l=-l;let u=Math.round(s*l),c=Math.round(e*l);for(u/l<s&&++u,c/l>e&&--c,a=new Array(o=c-u+1);++n<o;)a[n]=(u+n)/l}return i&&a.reverse(),a}function My(s,e,t){var i=(e-s)/Math.max(0,t),n=Math.floor(Math.log(i)/Math.LN10),o=i/Math.pow(10,n);return n>=0?(o>=fv?10:o>=gv?5:o>=pv?2:1)*Math.pow(10,n):-Math.pow(10,-n)/(o>=fv?10:o>=gv?5:o>=pv?2:1)}function mv(s,e,t){var i=Math.abs(e-s)/Math.max(0,t),n=Math.pow(10,Math.floor(Math.log(i)/Math.LN10)),o=i/n;return o>=fv?n*=10:o>=gv?n*=5:o>=pv&&(n*=2),e<s?-n:n}function KO(s,e){switch(arguments.length){case 0:break;case 1:this.range(s);break;default:this.range(e).domain(s);break}return this}function By(s,e,t){s.prototype=e.prototype=t,t.constructor=s}function bv(s,e){var t=Object.create(s.prototype);for(var i in e)t[i]=e[i];return t}function vp(){}var Ep=.7,Fy=1/Ep,od="\\s*([+-]?\\d+)\\s*",xp="\\s*([+-]?(?:\\d*\\.)?\\d+(?:[eE][+-]?\\d+)?)\\s*",ls="\\s*([+-]?(?:\\d*\\.)?\\d+(?:[eE][+-]?\\d+)?)%\\s*",a8=/^#([0-9a-f]{3,8})$/,l8=new RegExp(`^rgb\\(${od},${od},${od}\\)$`),u8=new RegExp(`^rgb\\(${ls},${ls},${ls}\\)$`),c8=new RegExp(`^rgba\\(${od},${od},${od},${xp}\\)$`),h8=new RegExp(`^rgba\\(${ls},${ls},${ls},${xp}\\)$`),d8=new RegExp(`^hsl\\(${xp},${ls},${ls}\\)$`),f8=new RegExp(`^hsla\\(${xp},${ls},${ls},${xp}\\)$`),ZO={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074};By(vp,Tl,{copy(s){return Object.assign(new this.constructor,this,s)},displayable(){return this.rgb().displayable()},hex:QO,formatHex:QO,formatHex8:g8,formatHsl:p8,formatRgb:JO,toString:JO});function QO(){return this.rgb().formatHex()}function g8(){return this.rgb().formatHex8()}function p8(){return n2(this).formatHsl()}function JO(){return this.rgb().formatRgb()}function Tl(s){var e,t;return s=(s+"").trim().toLowerCase(),(e=a8.exec(s))?(t=e[1].length,e=parseInt(e[1],16),t===6?$O(e):t===3?new Di(e>>8&15|e>>4&240,e>>4&15|e&240,(e&15)<<4|e&15,1):t===8?Dy(e>>24&255,e>>16&255,e>>8&255,(e&255)/255):t===4?Dy(e>>12&15|e>>8&240,e>>8&15|e>>4&240,e>>4&15|e&240,((e&15)<<4|e&15)/255):null):(e=l8.exec(s))?new Di(e[1],e[2],e[3],1):(e=u8.exec(s))?new Di(e[1]*255/100,e[2]*255/100,e[3]*255/100,1):(e=c8.exec(s))?Dy(e[1],e[2],e[3],e[4]):(e=h8.exec(s))?Dy(e[1]*255/100,e[2]*255/100,e[3]*255/100,e[4]):(e=d8.exec(s))?r2(e[1],e[2]/100,e[3]/100,1):(e=f8.exec(s))?r2(e[1],e[2]/100,e[3]/100,e[4]):ZO.hasOwnProperty(s)?$O(ZO[s]):s==="transparent"?new Di(NaN,NaN,NaN,0):null}function $O(s){return new Di(s>>16&255,s>>8&255,s&255,1)}function Dy(s,e,t,i){return i<=0&&(s=e=t=NaN),new Di(s,e,t,i)}function m8(s){return s instanceof vp||(s=Tl(s)),s?(s=s.rgb(),new Di(s.r,s.g,s.b,s.opacity)):new Di}function Il(s,e,t,i){return arguments.length===1?m8(s):new Di(s,e,t,i??1)}function Di(s,e,t,i){this.r=+s,this.g=+e,this.b=+t,this.opacity=+i}By(Di,Il,bv(vp,{brighter(s){return s=s==null?Fy:Math.pow(Fy,s),new Di(this.r*s,this.g*s,this.b*s,this.opacity)},darker(s){return s=s==null?Ep:Math.pow(Ep,s),new Di(this.r*s,this.g*s,this.b*s,this.opacity)},rgb(){return this},clamp(){return new Di(uc(this.r),uc(this.g),uc(this.b),ky(this.opacity))},displayable(){return-.5<=this.r&&this.r<255.5&&-.5<=this.g&&this.g<255.5&&-.5<=this.b&&this.b<255.5&&0<=this.opacity&&this.opacity<=1},hex:e2,formatHex:e2,formatHex8:b8,formatRgb:t2,toString:t2}));function e2(){return`#${lc(this.r)}${lc(this.g)}${lc(this.b)}`}function b8(){return`#${lc(this.r)}${lc(this.g)}${lc(this.b)}${lc((isNaN(this.opacity)?1:this.opacity)*255)}`}function t2(){let s=ky(this.opacity);return`${s===1?"rgb(":"rgba("}${uc(this.r)}, ${uc(this.g)}, ${uc(this.b)}${s===1?")":`, ${s})`}`}function ky(s){return isNaN(s)?1:Math.max(0,Math.min(1,s))}function uc(s){return Math.max(0,Math.min(255,Math.round(s)||0))}function lc(s){return s=uc(s),(s<16?"0":"")+s.toString(16)}function r2(s,e,t,i){return i<=0?s=e=t=NaN:t<=0||t>=1?s=e=NaN:e<=0&&(s=NaN),new yo(s,e,t,i)}function n2(s){if(s instanceof yo)return new yo(s.h,s.s,s.l,s.opacity);if(s instanceof vp||(s=Tl(s)),!s)return new yo;if(s instanceof yo)return s;s=s.rgb();var e=s.r/255,t=s.g/255,i=s.b/255,n=Math.min(e,t,i),o=Math.max(e,t,i),a=NaN,l=o-n,u=(o+n)/2;return l?(e===o?a=(t-i)/l+(t<i)*6:t===o?a=(i-e)/l+2:a=(e-t)/l+4,l/=u<.5?o+n:2-o-n,a*=60):l=u>0&&u<1?0:a,new yo(a,l,u,s.opacity)}function o2(s,e,t,i){return arguments.length===1?n2(s):new yo(s,e,t,i??1)}function yo(s,e,t,i){this.h=+s,this.s=+e,this.l=+t,this.opacity=+i}By(yo,o2,bv(vp,{brighter(s){return s=s==null?Fy:Math.pow(Fy,s),new yo(this.h,this.s,this.l*s,this.opacity)},darker(s){return s=s==null?Ep:Math.pow(Ep,s),new yo(this.h,this.s,this.l*s,this.opacity)},rgb(){var s=this.h%360+(this.h<0)*360,e=isNaN(s)||isNaN(this.s)?0:this.s,t=this.l,i=t+(t<.5?t:1-t)*e,n=2*t-i;return new Di(Pv(s>=240?s-240:s+120,n,i),Pv(s,n,i),Pv(s<120?s+240:s-120,n,i),this.opacity)},clamp(){return new yo(i2(this.h),Gy(this.s),Gy(this.l),ky(this.opacity))},displayable(){return(0<=this.s&&this.s<=1||isNaN(this.s))&&0<=this.l&&this.l<=1&&0<=this.opacity&&this.opacity<=1},formatHsl(){let s=ky(this.opacity);return`${s===1?"hsl(":"hsla("}${i2(this.h)}, ${Gy(this.s)*100}%, ${Gy(this.l)*100}%${s===1?")":`, ${s})`}`}}));function i2(s){return s=(s||0)%360,s<0?s+360:s}function Gy(s){return Math.max(0,Math.min(1,s||0))}function Pv(s,e,t){return(s<60?e+(t-e)*s/60:s<180?t:s<240?e+(t-e)*(240-s)/60:e)*255}function yv(s,e,t,i,n){var o=s*s,a=o*s;return((1-3*s+3*o-a)*e+(4-6*o+3*a)*t+(1+3*s+3*o-3*a)*i+a*n)/6}function s2(s){var e=s.length-1;return function(t){var i=t<=0?t=0:t>=1?(t=1,e-1):Math.floor(t*e),n=s[i],o=s[i+1],a=i>0?s[i-1]:2*n-o,l=i<e-1?s[i+2]:2*o-n;return yv((t-i/e)*e,a,n,o,l)}}function a2(s){var e=s.length;return function(t){var i=Math.floor(((t%=1)<0?++t:t)*e),n=s[(i+e-1)%e],o=s[i%e],a=s[(i+1)%e],l=s[(i+2)%e];return yv((t-i/e)*e,n,o,a,l)}}var Cp=s=>()=>s;function P8(s,e){return function(t){return s+t*e}}function y8(s,e,t){return s=Math.pow(s,t),e=Math.pow(e,t)-s,t=1/t,function(i){return Math.pow(s+i*e,t)}}function l2(s){return(s=+s)==1?Vy:function(e,t){return t-e?y8(e,t,s):Cp(isNaN(e)?t:e)}}function Vy(s,e){var t=e-s;return t?P8(s,t):Cp(isNaN(s)?e:s)}var Sv=function s(e){var t=l2(e);function i(n,o){var a=t((n=Il(n)).r,(o=Il(o)).r),l=t(n.g,o.g),u=t(n.b,o.b),c=Vy(n.opacity,o.opacity);return function(h){return n.r=a(h),n.g=l(h),n.b=u(h),n.opacity=c(h),n+""}}return i.gamma=s,i}(1);function u2(s){return function(e){var t=e.length,i=new Array(t),n=new Array(t),o=new Array(t),a,l;for(a=0;a<t;++a)l=Il(e[a]),i[a]=l.r||0,n[a]=l.g||0,o[a]=l.b||0;return i=s(i),n=s(n),o=s(o),l.opacity=1,function(u){return l.r=i(u),l.g=n(u),l.b=o(u),l+""}}}var b5e=u2(s2),P5e=u2(a2);function c2(s,e){e||(e=[]);var t=s?Math.min(e.length,s.length):0,i=e.slice(),n;return function(o){for(n=0;n<t;++n)i[n]=s[n]*(1-o)+e[n]*o;return i}}function h2(s){return ArrayBuffer.isView(s)&&!(s instanceof DataView)}function d2(s,e){var t=e?e.length:0,i=s?Math.min(t,s.length):0,n=new Array(i),o=new Array(t),a;for(a=0;a<i;++a)n[a]=cc(s[a],e[a]);for(;a<t;++a)o[a]=e[a];return function(l){for(a=0;a<i;++a)o[a]=n[a](l);return o}}function f2(s,e){var t=new Date;return s=+s,e=+e,function(i){return t.setTime(s*(1-i)+e*i),t}}function wl(s,e){return s=+s,e=+e,function(t){return s*(1-t)+e*t}}function g2(s,e){var t={},i={},n;(s===null||typeof s!="object")&&(s={}),(e===null||typeof e!="object")&&(e={});for(n in e)n in s?t[n]=cc(s[n],e[n]):i[n]=e[n];return function(o){for(n in t)i[n]=t[n](o);return i}}var xv=/[-+]?(?:\d+\.?\d*|\.?\d+)(?:[eE][-+]?\d+)?/g,Ev=new RegExp(xv.source,"g");function S8(s){return function(){return s}}function E8(s){return function(e){return s(e)+""}}function p2(s,e){var t=xv.lastIndex=Ev.lastIndex=0,i,n,o,a=-1,l=[],u=[];for(s=s+"",e=e+"";(i=xv.exec(s))&&(n=Ev.exec(e));)(o=n.index)>t&&(o=e.slice(t,o),l[a]?l[a]+=o:l[++a]=o),(i=i[0])===(n=n[0])?l[a]?l[a]+=n:l[++a]=n:(l[++a]=null,u.push({i:a,x:wl(i,n)})),t=Ev.lastIndex;return t<e.length&&(o=e.slice(t),l[a]?l[a]+=o:l[++a]=o),l.length<2?u[0]?E8(u[0].x):S8(e):(e=u.length,function(c){for(var h=0,d;h<e;++h)l[(d=u[h]).i]=d.x(c);return l.join("")})}function cc(s,e){var t=typeof e,i;return e==null||t==="boolean"?Cp(e):(t==="number"?wl:t==="string"?(i=Tl(e))?(e=i,Sv):p2:e instanceof Tl?Sv:e instanceof Date?f2:h2(e)?c2:Array.isArray(e)?d2:typeof e.valueOf!="function"&&typeof e.toString!="function"||isNaN(e)?g2:wl)(s,e)}function vv(s,e){return s=+s,e=+e,function(t){return Math.round(s*(1-t)+e*t)}}function Cv(s){return function(){return s}}function Av(s){return+s}var m2=[0,1];function sd(s){return s}function Tv(s,e){return(e-=s=+s)?function(t){return(t-s)/e}:Cv(isNaN(e)?NaN:.5)}function x8(s,e){var t;return s>e&&(t=s,s=e,e=t),function(i){return Math.max(s,Math.min(e,i))}}function v8(s,e,t){var i=s[0],n=s[1],o=e[0],a=e[1];return n<i?(i=Tv(n,i),o=t(a,o)):(i=Tv(i,n),o=t(o,a)),function(l){return o(i(l))}}function C8(s,e,t){var i=Math.min(s.length,e.length)-1,n=new Array(i),o=new Array(i),a=-1;for(s[i]<s[0]&&(s=s.slice().reverse(),e=e.slice().reverse());++a<i;)n[a]=Tv(s[a],s[a+1]),o[a]=t(e[a],e[a+1]);return function(l){var u=dv(s,l,1,i)-1;return o[u](n[u](l))}}function b2(s,e){return e.domain(s.domain()).range(s.range()).interpolate(s.interpolate()).clamp(s.clamp()).unknown(s.unknown())}function A8(){var s=m2,e=m2,t=cc,i,n,o,a=sd,l,u,c;function h(){var f=Math.min(s.length,e.length);return a!==sd&&(a=x8(s[0],s[f-1])),l=f>2?C8:v8,u=c=null,d}function d(f){return f==null||isNaN(f=+f)?o:(u||(u=l(s.map(i),e,t)))(i(a(f)))}return d.invert=function(f){return a(n((c||(c=l(e,s.map(i),wl)))(f)))},d.domain=function(f){return arguments.length?(s=Array.from(f,Av),h()):s.slice()},d.range=function(f){return arguments.length?(e=Array.from(f),h()):e.slice()},d.rangeRound=function(f){return e=Array.from(f),t=vv,h()},d.clamp=function(f){return arguments.length?(a=f?!0:sd,h()):a!==sd},d.interpolate=function(f){return arguments.length?(t=f,h()):t},d.unknown=function(f){return arguments.length?(o=f,d):o},function(f,p){return i=f,n=p,h()}}function Iv(){return A8()(sd,sd)}function P2(s){return Math.abs(s=Math.round(s))>=1e21?s.toLocaleString("en").replace(/,/g,""):s.toString(10)}function hc(s,e){if((t=(s=e?s.toExponential(e-1):s.toExponential()).indexOf("e"))<0)return null;var t,i=s.slice(0,t);return[i.length>1?i[0]+i.slice(2):i,+s.slice(t+1)]}function us(s){return s=hc(Math.abs(s)),s?s[1]:NaN}function y2(s,e){return function(t,i){for(var n=t.length,o=[],a=0,l=s[0],u=0;n>0&&l>0&&(u+l+1>i&&(l=Math.max(1,i-u)),o.push(t.substring(n-=l,n+l)),!((u+=l+1)>i));)l=s[a=(a+1)%s.length];return o.reverse().join(e)}}function S2(s){return function(e){return e.replace(/[0-9]/g,function(t){return s[+t]})}}var T8=/^(?:(.)?([<>=^]))?([+\-( ])?([$#])?(0)?(\d+)?(,)?(\.\d+)?(~)?([a-z%])?$/i;function Ll(s){if(!(e=T8.exec(s)))throw new Error("invalid format: "+s);var e;return new Uy({fill:e[1],align:e[2],sign:e[3],symbol:e[4],zero:e[5],width:e[6],comma:e[7],precision:e[8]&&e[8].slice(1),trim:e[9],type:e[10]})}Ll.prototype=Uy.prototype;function Uy(s){this.fill=s.fill===void 0?" ":s.fill+"",this.align=s.align===void 0?">":s.align+"",this.sign=s.sign===void 0?"-":s.sign+"",this.symbol=s.symbol===void 0?"":s.symbol+"",this.zero=!!s.zero,this.width=s.width===void 0?void 0:+s.width,this.comma=!!s.comma,this.precision=s.precision===void 0?void 0:+s.precision,this.trim=!!s.trim,this.type=s.type===void 0?"":s.type+""}Uy.prototype.toString=function(){return this.fill+this.align+this.sign+this.symbol+(this.zero?"0":"")+(this.width===void 0?"":Math.max(1,this.width|0))+(this.comma?",":"")+(this.precision===void 0?"":"."+Math.max(0,this.precision|0))+(this.trim?"~":"")+this.type};function E2(s){e:for(var e=s.length,t=1,i=-1,n;t<e;++t)switch(s[t]){case".":i=n=t;break;case"0":i===0&&(i=t),n=t;break;default:if(!+s[t])break e;i>0&&(i=0);break}return i>0?s.slice(0,i)+s.slice(n+1):s}var wv;function x2(s,e){var t=hc(s,e);if(!t)return s+"";var i=t[0],n=t[1],o=n-(wv=Math.max(-8,Math.min(8,Math.floor(n/3)))*3)+1,a=i.length;return o===a?i:o>a?i+new Array(o-a+1).join("0"):o>0?i.slice(0,o)+"."+i.slice(o):"0."+new Array(1-o).join("0")+hc(s,Math.max(0,e+o-1))[0]}function Lv(s,e){var t=hc(s,e);if(!t)return s+"";var i=t[0],n=t[1];return n<0?"0."+new Array(-n).join("0")+i:i.length>n+1?i.slice(0,n+1)+"."+i.slice(n+1):i+new Array(n-i.length+2).join("0")}var Rv={"%":(s,e)=>(s*100).toFixed(e),b:s=>Math.round(s).toString(2),c:s=>s+"",d:P2,e:(s,e)=>s.toExponential(e),f:(s,e)=>s.toFixed(e),g:(s,e)=>s.toPrecision(e),o:s=>Math.round(s).toString(8),p:(s,e)=>Lv(s*100,e),r:Lv,s:x2,X:s=>Math.round(s).toString(16).toUpperCase(),x:s=>Math.round(s).toString(16)};function Ov(s){return s}var v2=Array.prototype.map,C2=["y","z","a","f","p","n","\xB5","m","","k","M","G","T","P","E","Z","Y"];function A2(s){var e=s.grouping===void 0||s.thousands===void 0?Ov:y2(v2.call(s.grouping,Number),s.thousands+""),t=s.currency===void 0?"":s.currency[0]+"",i=s.currency===void 0?"":s.currency[1]+"",n=s.decimal===void 0?".":s.decimal+"",o=s.numerals===void 0?Ov:S2(v2.call(s.numerals,String)),a=s.percent===void 0?"%":s.percent+"",l=s.minus===void 0?"\u2212":s.minus+"",u=s.nan===void 0?"NaN":s.nan+"";function c(d){d=Ll(d);var f=d.fill,p=d.align,S=d.sign,E=d.symbol,C=d.zero,O=d.width,B=d.comma,A=d.precision,N=d.trim,z=d.type;z==="n"?(B=!0,z="g"):Rv[z]||(A===void 0&&(A=12),N=!0,z="g"),(C||f==="0"&&p==="=")&&(C=!0,f="0",p="=");var Y=E==="$"?t:E==="#"&&/[boxX]/.test(z)?"0"+z.toLowerCase():"",ie=E==="$"?i:/[%p]/.test(z)?a:"",he=Rv[z],ae=/[defgprs%]/.test(z);A=A===void 0?6:/[gprs]/.test(z)?Math.max(1,Math.min(21,A)):Math.max(0,Math.min(20,A));function D(_){var W=Y,H=ie,ee,oe,ce;if(z==="c")H=he(_)+H,_="";else{_=+_;var Ee=_<0||1/_<0;if(_=isNaN(_)?u:he(Math.abs(_),A),N&&(_=E2(_)),Ee&&+_==0&&S!=="+"&&(Ee=!1),W=(Ee?S==="("?S:l:S==="-"||S==="("?"":S)+W,H=(z==="s"?C2[8+wv/3]:"")+H+(Ee&&S==="("?")":""),ae){for(ee=-1,oe=_.length;++ee<oe;)if(ce=_.charCodeAt(ee),48>ce||ce>57){H=(ce===46?n+_.slice(ee+1):_.slice(ee))+H,_=_.slice(0,ee);break}}}B&&!C&&(_=e(_,1/0));var Oe=W.length+_.length+H.length,nt=Oe<O?new Array(O-Oe+1).join(f):"";switch(B&&C&&(_=e(nt+_,nt.length?O-H.length:1/0),nt=""),p){case"<":_=W+_+H+nt;break;case"=":_=W+nt+_+H;break;case"^":_=nt.slice(0,Oe=nt.length>>1)+W+_+H+nt.slice(Oe);break;default:_=nt+W+_+H;break}return o(_)}return D.toString=function(){return d+""},D}function h(d,f){var p=c((d=Ll(d),d.type="f",d)),S=Math.max(-8,Math.min(8,Math.floor(us(f)/3)))*3,E=Math.pow(10,-S),C=C2[8+S/3];return function(O){return p(E*O)+C}}return{format:c,formatPrefix:h}}var zy,Wy,Hy;_v({thousands:",",grouping:[3],currency:["$",""]});function _v(s){return zy=A2(s),Wy=zy.format,Hy=zy.formatPrefix,zy}function Nv(s){return Math.max(0,-us(Math.abs(s)))}function Mv(s,e){return Math.max(0,Math.max(-8,Math.min(8,Math.floor(us(e)/3)))*3-us(Math.abs(s)))}function Bv(s,e){return s=Math.abs(s),e=Math.abs(e)-s,Math.max(0,us(e)-us(s))+1}function Dv(s,e,t,i){var n=mv(s,e,t),o;switch(i=Ll(i??",f"),i.type){case"s":{var a=Math.max(Math.abs(s),Math.abs(e));return i.precision==null&&!isNaN(o=Mv(n,a))&&(i.precision=o),Hy(i,a)}case"":case"e":case"g":case"p":case"r":{i.precision==null&&!isNaN(o=Bv(n,Math.max(Math.abs(s),Math.abs(e))))&&(i.precision=o-(i.type==="e"));break}case"f":case"%":{i.precision==null&&!isNaN(o=Nv(n))&&(i.precision=o-(i.type==="%")*2);break}}return Wy(i)}function I8(s){var e=s.domain;return s.ticks=function(t){var i=e();return Ny(i[0],i[i.length-1],t??10)},s.tickFormat=function(t,i){var n=e();return Dv(n[0],n[n.length-1],t??10,i)},s.nice=function(t){t==null&&(t=10);var i=e(),n=0,o=i.length-1,a=i[n],l=i[o],u,c,h=10;for(l<a&&(c=a,a=l,l=c,c=n,n=o,o=c);h-- >0;){if(c=My(a,l,t),c===u)return i[n]=a,i[o]=l,e(i);if(c>0)a=Math.floor(a/c)*c,l=Math.ceil(l/c)*c;else if(c<0)a=Math.ceil(a*c)/c,l=Math.floor(l*c)/c;else break;u=c}return s},s}function ad(){var s=Iv();return s.copy=function(){return b2(s,ad())},KO.apply(s,arguments),I8(s)}function Gv(s){let e=s.layers.map(w8),t=new Set;for(let i of e){if(t.has(i.id))throw new Error(`Duplicate layer id: ${i.id}`);t.add(i.id)}return{layers:e}}function w8(s,e){var c;let{type:t,id:i=`layer-${e}`,filter:n,visible:o=!0,minZoom:a=-1/0,maxZoom:l=1/0}=s,u;if(t==="node")u={opacity:Gi(s.opacity),size:Gi(s.size),fillColor:Gi(s.fillColor,ld),strokeWidth:Gi(s.strokeWidth),strokeColor:Gi(s.strokeColor,ld),labelSize:Gi((c=s.labelSize)!=null?c:s.size),labelColor:Gi(s.labelColor,ld)};else if(s.type==="edge")u={opacity:Gi(s.opacity),strokeWidth:Gi(s.strokeWidth),strokeColor:Gi(s.strokeColor,ld),arrowSize:Gi(s.arrowSize),arrowColor:Gi(s.arrowColor,ld),labelSize:Gi(s.labelSize),labelColor:Gi(s.labelColor,ld)};else throw new Error(`Unknown layer type: ${t}`);return{type:t,id:i,filter:I2(n),visible:o,minZoom:a,maxZoom:l,...u}}function Gi(s,e){if(!s)return null;if(s.interpolation){let{interpolation:t,interpolationParameters:i=[],input:n,inputStops:o,outputStops:a}=s;switch(t){case"linear":{let l=ad(o,a);return l.clamp(!0),u=>{let c=u[n],h=l(c);return e?e(h):h}}case"power":{let l=i[0]||2,u=ad(o.map(c=>Math.pow(l,c)),a);return u.clamp(!0),c=>{let h=c[n],d=u(Math.pow(l,h));return e?e(d):d}}case"step":return l=>{let u=l[n],c=o.findIndex(d=>d>u),h;return c<0?h=a[a.length-1]:h=a[c],e?e(h):h};default:throw new Error(`Unknown interpolation ${t}`)}}return e?e(s):s}function ld(s){let e=Il(s);return[e.r,e.g,e.b,e.opacity*255]}function I2(s){if(!s)return null;if(Array.isArray(s)){let t=s.map(I2);return(i,n)=>{for(let o of t)if(!o(i,n))return!1;return!0}}let e;switch(s.property){case"id":e=t=>t.id;break;case"source-id":e=t=>t.source.id;break;case"target-id":e=t=>t.target.id;break;case"shape":e=t=>Zo[T2(t).shape];break;case"label":e=t=>T2(t).labelText;break;case"rank":e=(t,i)=>{var n,o,a;return i.tileMap&&i.tileMap.nodeRank?"source"in t?Math.min((n=i.tileMap)==null?void 0:n.nodeRank.get(t.source),(o=i.tileMap)==null?void 0:o.nodeRank.get(t.target)):(a=i.tileMap)==null?void 0:a.nodeRank.get(t):1};break;default:throw new Error(`Unknown filter property ${s.property}`)}switch(s.operator){case"=":return(t,i)=>e(t,i)===s.value;case"<":return(t,i)=>e(t,i)<s.value;case">":return(t,i)=>e(t,i)>s.value;case"<=":return(t,i)=>e(t,i)<=s.value;case">=":return(t,i)=>e(t,i)>=s.value;case"!=":return(t,i)=>e(t,i)!=s.value;case"*=":return(t,i)=>String(e(t,i)).includes(String(s.value));case"^=":return(t,i)=>String(e(t,i)).startsWith(String(s.value));case"$=":return(t,i)=>String(e(t,i)).endsWith(String(s.value));default:throw new Error(`Unknown filter operator ${s.operator}`)}}function T2(s){return Ve.getDrawingObj(s)}var Ap=2,ud=class extends Sp{constructor(t=document.body,i){super();this._layoutOptions={};this._controls=[];this._style=Gv(qO);this._layoutWorkerUrl=i,this._textMeasurer=new ch,window.getComputedStyle(t).position==="static"&&(t.style.position="relative");let n=Array.from({length:2},()=>{let o=document.createElement("div");return Object.assign(o.style,{position:"absolute",top:0,bottom:0,left:0,right:0}),t.appendChild(o)});this._deck=new ml({parent:n[0],views:[new Qs({flipY:!1})],initialViewState:{target:[0,0,0],zoom:0,maxZoom:Ap},controller:!0,onLoad:()=>{this.emit("load");let{gl:o}=this._deck.deckRenderer;this._deck._addResources({arrowAtlas:VO(o)}),this._update()},onClick:({object:o})=>{!o&&this._highlightedNodeId&&this.highlight(null)}}),n[1].style.pointerEvents="none",this._controlsContainer=n[1]}addControl(t){if(this._controls.indexOf(t)<0){this._controls.push(t),t.onAdd(this);let i=t.getElement();i&&this._controlsContainer.appendChild(i)}}removeControl(t){let i=this._controls.indexOf(t);if(i>=0){let n=t.getElement();n&&n.remove(),t.onRemove(this),this._controls.splice(i,1)}}get graph(){return this._graph}setStyle(t){this._style=Gv(t);let i=this._deck.props.layers[0];if(i){let n=i.clone({graphStyle:this._style});this._deck.setProps({layers:[n]})}}async setGraph(t,i=this._layoutOptions){this._graph===t?i&&await this.setOptions(i):(this._graph=t,i&&!Qc(t)?(this._layoutOptions=i,this._textMeasurer.setOptions(i.label||{}),this._highlightedNodeId=null,(zt.getDrawingObj(t)||new zt(t)).createGeometry(this._textMeasurer.measure),await this._layoutGraph(!0)):this._deck.layerManager&&this._update())}async setOptions(t){let i=this._layoutOptions.label,n=t.label,o=!wf(i,n);if(this._layoutOptions=t,!this._graph)return;let a=zt.getDrawingObj(this._graph);o&&(this._textMeasurer.setOptions(t.label||{}),a.createGeometry(this._textMeasurer.measure));let l=o;await this._layoutGraph(l)}zoomTo(t){let i=Math.min(this._deck.width/t.width,this._deck.height/t.height),n=Math.min(Math.log2(i),Ap);this._deck.setProps({initialViewState:{target:[t.center.x,t.center.y,0],zoom:n,transitionInterpolator:new Dn(["target","zoom"]),transitionDuration:1e3,maxZoom:Ap}})}highlight(t){this._highlightedNodeId=t,this._highlight(t)}_highlight(t,i=2){this._graph&&this._deck.layerManager&&(this._graphHighlighter.update({sourceId:t,maxDepth:i,edgeDepth:!1}),this._deck.layerManager.setNeedsRedraw("hightlight changed"))}async _layoutGraph(t){this._layoutWorkerUrl?(console.log("layout on worker"),this._graph=await NS(this._layoutWorkerUrl,this._graph,this._layoutOptions,t)):Mb(this._graph,this._layoutOptions,t),this._deck.layerManager&&this._update()}_update(){if(!this._graph)return;let t=this._textMeasurer.opts,i=be.getGeom(this._graph);if(!i)return;this._graphHighlighter=this._graphHighlighter||new yp(this._deck.deckRenderer.gl),this._graphHighlighter.setGraph(i);let n=i.boundingBox;console.time("Generate tiles");let o=2**Math.ceil(Math.log2(Math.max(n.width,n.height))),a=Math.min(Ap,Math.round(9-Math.log2(o))),l=new X({left:n.left-(o-n.width)/2,bottom:n.bottom-(o-n.height)/2,right:n.right+(o-n.width)/2,top:n.top+(o-n.height)/2}),u=new mf(i,l),c=u.buildUpToLevel(8);console.timeEnd("Generate tiles"),console.time("initial render");let h=new $e().translate([o/2-l.center.x,o/2-l.center.y,0]),d=new Cl({extent:[0,0,o,o],refinementStrategy:"no-overlap",minZoom:a,maxZoom:c-1+a,tileSize:512,getTileData:f=>{let{x:p,y:S,z:E}=f.index;return f.bbox,u.getTileData(p,S,E-a)},autoHighlight:!0,onHover:({object:f,sourceLayer:p})=>{this._highlightedNodeId||(f instanceof lt?this._highlight(f.id):this._highlight(null))},graphStyle:this._style,renderSubLayers:({data:f,graphStyle:p,id:S,tile:E})=>{if(!f)return null;let C=f.rect;return[new sc({id:S,data:f,modelMatrix:h,highlighter:this._graphHighlighter,fontFamily:t.fontFamily,fontWeight:t.fontWeight,lineHeight:t.lineHeight,resolution:2**(E.index.z-2),pickable:!0,graphStyle:p,tileMap:u,clipBounds:[C.left,C.bottom,C.right,C.top],clipByInstance:!1,extensions:[new Al]})]},updateTriggers:{getTileData:Date.now()}});this._deck.setProps({layers:[d],initialViewState:{target:[o/2,o/2,0],zoom:a,minZoom:a,maxZoom:Ap},onAfterRender:()=>{d.isLoaded&&(console.timeEnd("initial render"),this._deck.setProps({onAfterRender:L8}))}}),this.emit({type:"graphload",data:this._graph})}};function L8(){}var R8=`
  .search-control { pointer-events: all; font-family: "Segoe UI", Helvetica, Arial, sans-serif; font-size: 14px; position: absolute; top: 0; right: 0; margin: 20px; width: 200px; }
  .search-control-input { font-family: "Segoe UI", Helvetica, Arial, sans-serif; font-size: 14px; padding: 8px; width: 100%; }
  .search-control-options { background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.3); padding: 12px 0; margin-top: 4px; overflow-x: hidden; overflow-y: auto; }
  .search-control-option { padding: 0 12px; line-height: 32px; white-space: nowrap; color: #000; cursor: pointer; }
  .search-control-option:hover { background: #f8f8f8; }
  .search-control-option.focus { color: #08f; background: #f8f8f8; }
`,cd=class{constructor(){this._nodes=[];this._onGraphLoad=e=>{this._updateNodeList(e.data)}}onAdd(e){e.on("graphload",this._onGraphLoad),this._dropdown=new Fv({getLabel:t=>rr.getDrawingObj(t).labelText,onSelect:t=>{e.highlight(t.id);let i=lt.getGeom(t);e.zoomTo(i.boundingBox)}}),this._updateNodeList(e.graph)}onRemove(e){e.off("graphload",this._onGraphLoad),this._dropdown.delete(),this._dropdown=null}getElement(){return this._dropdown.element}_updateNodeList(e){this._nodes=e?Array.from(e.nodesBreadthFirst):[],this._dropdown.update(this._nodes)}},Fv=class{constructor(e){this.focus=-1;this.items=[];this.options={getLabel:e=>e.toString(),renderItem:(e,t)=>{if(!t)return e;let i=e.toLowerCase().indexOf(t);return`${e.slice(0,i)}<b>${e.slice(i,i+t.length)}</b>${e.slice(i+t.length)}`},filterItem:(e,t)=>{if(!t)return 1;let i=e.toLowerCase().indexOf(t);return i===0?2:i>0?1:0},onSelect:()=>{},buffer:2,itemHeight:32,maxHeight:240};this._active=!1;this._topOffset=0;this._keyword="";this._filteredItems=[];this._items=[];this._onScroll=()=>{let{itemHeight:e,buffer:t,getLabel:i,renderItem:n}=this.options,o=this._flyout.scrollTop;this._topOffset=Math.max(0,Math.floor(o/e)-t),this._scroller.style.paddingTop=this._topOffset*e+"px";for(let a=0;a<this._items.length;a++){let l=this._items[a],u=a+this._topOffset;u===this.focus?l.classList.add("focus"):l.classList.remove("focus");let c=this._filteredItems[u];if(c){let h=i(c);l.innerHTML=n(h,this._keyword,c)}}};let t=document.createElement("style");t.innerText=R8,document.head.appendChild(t),this._stylesheet=t;let i=document.createElement("div");i.className="search-control";let n=document.createElement("input");n.placeholder="Search...",n.className="search-control-input",i.appendChild(n),n.addEventListener("focus",()=>{n.value="",this._keyword="",this._active=!0,this._updateFilter()}),n.addEventListener("blur",()=>{setTimeout(()=>{this._active=!1,this._updateUI()},200)}),n.addEventListener("input",l=>{this._keyword=n.value.toLowerCase(),this._updateFilter()}),n.addEventListener("keydown",l=>{switch(l.key){case"ArrowDown":l.preventDefault(),this.focus=Math.min(this._filteredItems.length-1,this.focus+1),this._updateUI();break;case"ArrowUp":l.preventDefault(),this.focus=Math.max(0,this.focus-1),this._updateUI();break;case"Enter":this._select(this.focus);break}}),this._textbox=n;let o=document.createElement("div");o.className="search-control-options",o.addEventListener("scroll",this._onScroll),i.appendChild(o);let a=document.createElement("div");a.style.boxSizing="border-box",a.style.overflow="hidden",o.appendChild(a),this._flyout=o,this._scroller=a,this.element=i,this.setOptions(e)}delete(){this.items=null,this._stylesheet.remove(),this._stylesheet=null,this.element.remove(),this.element=null,this._scroller=null,this._flyout=null}setOptions(e){Object.assign(this.options,e);let t=Math.ceil(this.options.maxHeight/this.options.itemHeight)+this.options.buffer*2,i=this._items;if(i.length!==t){for(let n=i.length;n<t;n++){let o=this._makeItem(n);i.push(o)}for(let n=i.length;n>t;n--)i[n-1].remove()}this._updateFilter()}update(e){this.items=e,this._textbox.value="",this._keyword="",this._updateFilter()}_updateFilter(){let{getLabel:e,filterItem:t}=this.options,i=this.items.map(o=>{let a=e(o);return t(a,this._keyword,o)}),n=Array.from(i,(o,a)=>a).filter(o=>i[o]);n.sort((o,a)=>i[a]-i[o]),this._filteredItems=n.map(o=>this.items[o]),this.focus=0,this._updateUI()}_select(e){let t=this._filteredItems[e];t&&(this.options.onSelect(t),this._textbox.value=this.options.getLabel(t),this._textbox.blur())}_updateUI(){if(!this._active){this._flyout.style.display="none";return}this._flyout.style.display="block",this._flyout.style.maxHeight=this.options.maxHeight+"px";let{itemHeight:e,maxHeight:t}=this.options,i=this._filteredItems.length,n=Math.floor(t/e),o=Math.max(0,(this.focus+2-n)*e),a=Math.min(Math.max(0,i*e-t),Math.max(0,this.focus-1)*e),l=this._flyout.scrollTop;l<o&&(l=o),l>a&&(l=a),this._scroller.style.height=i*e+"px";for(let u=0;u<this._items.length;u++){let c=this._items[u];c.style.display=u<i?"block":"none"}this._flyout.scrollTo({left:0,top:l,behavior:"smooth"}),this._onScroll()}_makeItem(e){let t=document.createElement("div");return t.className="search-control-option",t.style.height=this.options.itemHeight+"px",this._scroller.appendChild(t),t.addEventListener("click",()=>{this._select(e+this._topOffset)}),t}};var w2="abstract.gv a.gv alf.gv arrows.gv arrowsize.gv AvantGarde.gv awilliams.gv b100.gv b102.gv b103.gv b104.gv b106.gv b117.gv b123.gv b124.gv b135.gv b143.gv b145.gv b146.gv b155.gv b15.gv b22.gv b29.gv b33.gv b34.gv b36.gv b3.gv b491.gv b51.gv b53.gv b545.gv b56.gv b57.gv b58.gv b60.gv b62.gv b68.gv b69.gv b71.gv b73a.gv b73.gv b76.gv b77.gv b786.gv b79.gv b7.gv b80a.gv b80.gv b81.gv b85.gv b94.gv b993.gv bad.gv badvoro.gv b.gv big.gv biglabel.gv Bookman.gv cairo.gv center.gv channel.gv clover.gv clust1.gv clust2.gv clust3.gv clust4.gv clust5.gv clusters.gv clust.gv clustlabel.gv color.gv colorscheme.gv colors.gv compound.gv Courier.gv crazy.gv ctext.gv dd.gv decorate.gv dfa.gv d.gv dir.gv dpd.gv edgeclip.gv ER.gv fdp.gv fig6.gv flatedge.gv fsm.gv grammar.gv grdangles.gv grdcluster.gv grdcolors.gv grdfillcolor.gv grdlinear_angle.gv grdlinear.gv grdlinear_node.gv grdradial_angle.gv grdradial.gv grdradial_node.gv grdshapes.gv hashtable.gv Heawood.gv Helvetica.gv honda-tokoro.gv html2.gv html.gv in.gv inv_inv.gv inv_nul.gv inv_val.gv japanese.gv jcctree.gv jsort.gv KW91.gv labelclust-fbc.gv labelclust-fbd.gv labelclust-fbl.gv labelclust-fbr.gv labelclust-fdc.gv labelclust-fdd.gv labelclust-fdl.gv labelclust-fdr.gv labelclust-ftc.gv labelclust-ftd.gv labelclust-ftl.gv labelclust-ftr.gv labelclust-nbc.gv labelclust-nbd.gv labelclust-nbl.gv labelclust-nbr.gv labelclust-ndc.gv labelclust-ndd.gv labelclust-ndl.gv labelclust-ndr.gv labelclust-ntc.gv labelclust-ntd.gv labelclust-ntl.gv labelclust-ntr.gv labelroot-fbc.gv labelroot-fbd.gv labelroot-fbl.gv labelroot-fbr.gv labelroot-fdc.gv labelroot-fdd.gv labelroot-fdl.gv labelroot-fdr.gv labelroot-ftc.gv labelroot-ftd.gv labelroot-ftl.gv labelroot-ftr.gv labelroot-nbc.gv labelroot-nbd.gv labelroot-nbl.gv labelroot-nbr.gv labelroot-ndc.gv labelroot-ndd.gv labelroot-ndl.gv labelroot-ndr.gv labelroot-ntc.gv labelroot-ntd.gv labelroot-ntl.gv labelroot-ntr.gv Latin1.gv layer2.gv layer.gv layers.gv ldbxtried.gv longflat.gv lsunix1.gv lsunix2.gv lsunix3.gv mike.gv mode.gv multi.gv NaN.gv nestedclust.gv newarrows.gv NewCenturySchlbk.gv ngk10_4.gv nhg.gv nojustify.gv nul_inv.gv nul_nul.gv nul_val.gv ordering.gv overlap.gv p2.gv p3.gv p4.gv pack.gv Palatino.gv Petersen.gv pgram.gv p.gv pm2way.gv pmpipe.gv polypoly.gv ports.gv proc3d.gv process.gv ps.gv pslib.gv ps_user_shapes.gv rd_rules.gv record2.gv record.gv records.gv root.gv rootlabel.gv rowcolsep.gv rowe.gv russian.gv sb_box_dbl.gv sb_box.gv sb_circle_dbl.gv sb_circle.gv shapes.gv shells.gv sides.gv size.gv sl_box_dbl.gv sl_box.gv sl_circle_dbl.gv sl_circle.gv smlred.gv sq_rules.gv sr_box_dbl.gv sr_box.gv sr_circle_dbl.gv sr_circle.gv states.gv st_box_dbl.gv st_box.gv st_circle_dbl.gv st_circle.gv structs.gv style.gv Symbol.gv Times.gv train11.gv trapeziumlr.gv tree.gv triedds.gv try.gv unix2.gv unix2k.gv unix.gv url.gv user_shapes.gv val_inv.gv val_nul.gv val_val.gv viewfile.gv viewport.gv weight.gv world.gv xlabels.gv xx.gv ZapfChancery.gv ZapfDingbats ../JSONfiles/composers.json".split(" "),kv={default:"Default",splines:"Splines",rectilinear:"Rectilinear",bundles:"Bundles",straight:"Straight"},Vv={default:"Default",tb:"Layered Top-Bottom",lr:"Layered Left-Right",bt:"Layered Bottom-Top",rl:"Layered Right-Left",ipsepCola:"IPSepCola",mds:"Pivot MDS"},L2=["Times New Roman","Arial","Georgia","Courier New","Verdana"];var O8="https://raw.githubusercontent.com/microsoft/msagljs/main/examples/data/gameofthrones.json",Uv=new ud(document.getElementById("viewer"),"https://unpkg.com/@msagl/renderer-webgl@latest/dist/worker.min.js");Uv.addControl(new cd);async function hd(s,e){let t=document.getElementById("settings");t.classList.add("disabled"),s instanceof Te?await Uv.setGraph(s,e):await Uv.setOptions(s),t.classList.remove("disabled")}var jy=document.getElementById("gv");for(let s of w2){let e=document.createElement("option");e.value=s,e.innerText=s,jy.appendChild(e)}jy.selectedIndex=-1;jy.onchange=()=>{let s="https://raw.githubusercontent.com/microsoft/msagljs/main/modules/core/test/data/graphvis/"+jy.value;Nb(s).then(e=>{hd(e),document.getElementById("graph-name").innerText=e.id+"("+e.nodeCountDeep+","+e.deepEdgesCount+")"})};var zv=document.getElementById("routings");for(let s in kv){let e=document.createElement("option");e.value=s,e.innerText=kv[s],zv.appendChild(e)}zv.onchange=()=>{hd(qy())};var Wv=document.getElementById("layouts");for(let s in Vv){let e=document.createElement("option");e.value=s,e.innerText=Vv[s],Wv.appendChild(e)}Wv.onchange=()=>{hd(qy())};var Hv=document.getElementById("fonts");for(let s of L2){let e=document.createElement("option");e.value=s,e.innerText=s,e.style.fontFamily=s,Hv.appendChild(e)}Hv.onchange=()=>{hd(qy())};dC("drop-target",async s=>{let e=await _S(s);hd(e),document.getElementById("graph-name").innerText=e.id+"("+e.nodeCountDeep+","+e.deepEdgesCount+")"});(async()=>{let s=await Nb(O8),e=Qc(s);hd(s,e?null:qy()),document.getElementById("graph-name").innerText=s.id+"("+s.nodeCountDeep+","+s.deepEdgesCount+")"})();function qy(){let s={label:{fontFamily:Hv.value}};switch(Ve.defaultLabelFontName=s.label.fontFamily,Wv.value){case"lr":s.layoutType="Sugiyama LR";break;case"rl":s.layoutType="Sugiyama RL";break;case"tb":s.layoutType="Sugiyama TB";break;case"bt":s.layoutType="Sugiyama BT";break;case"mds":s.layoutType="MDS";break;case"ipsepCola":s.layoutType="IPsepCola";break;default:break}switch(zv.value){case"rectilinear":s.edgeRoutingMode=4;break;case"splines":{s.edgeRoutingMode=0;break}case"bundles":{s.edgeRoutingMode=1;break}case"straight":{s.edgeRoutingMode=2;break}case"default":{s.edgeRoutingMode=null;break}}return s}})();
/*!
   Copyright 2019 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.

   THIRD PARTY LICENSE NOTICE:

   HashMap is derived from the implementation of Dictionary<T> in .NET Core.
   HashSet is derived from the implementation of HashSet<T> in .NET Core.
   "getPrime", "expandPrime", and "isPrime" are derived from the implementation
   of "HashHelpers" in .NET Core.

   .NET Core is licensed under the MIT License:

   The MIT License (MIT)

   Copyright (c) .NET Foundation and Contributors

   All rights reserved.

   Permission is hereby granted, free of charge, to any person obtaining a copy
   of this software and associated documentation files (the "Software"), to deal
   in the Software without restriction, including without limitation the rights
   to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
   copies of the Software, and to permit persons to whom the Software is
   furnished to do so, subject to the following conditions:

   The above copyright notice and this permission notice shall be included in all
   copies or substantial portions of the Software.

   THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
   IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
   FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
   AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
   LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
   OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
   SOFTWARE.
*/
/*!
   Copyright 2019 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.

   THIRD PARTY LICENSE NOTICE:

   HashSet is derived from the implementation of HashSet<T> in .NET Core.

   .NET Core is licensed under the MIT License:

   The MIT License (MIT)

   Copyright (c) .NET Foundation and Contributors

   All rights reserved.

   Permission is hereby granted, free of charge, to any person obtaining a copy
   of this software and associated documentation files (the "Software"), to deal
   in the Software without restriction, including without limitation the rights
   to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
   copies of the Software, and to permit persons to whom the Software is
   furnished to do so, subject to the following conditions:

   The above copyright notice and this permission notice shall be included in all
   copies or substantial portions of the Software.

   THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
   IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
   FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
   AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
   LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
   OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
   SOFTWARE.
*/
/*!
   Copyright 2019 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.

   THIRD PARTY LICENSE NOTICE:

   LinkedList is derived from the implementation of LinkedList in
   Promise Extensions for Javascript: https://github.com/rbuckton/prex

   Promise Extensions is licensed under the Apache 2.0 License:

   Promise Extensions for JavaScript
   Copyright (c) Microsoft Corporation

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
*/
/*!
   Copyright 2019 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.

*/
/*!
   Copyright 2019 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
*/
/*!
   Copyright 2021 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
*/
/*!
   Copyright 2022 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.

   THIRD PARTY LICENSE NOTICE:

   xxHash Library
   Copyright (c) 2012-2021 Yann Collet
   All rights reserved.

   BSD 2-Clause License (https://www.opensource.org/licenses/bsd-license.php)

   Redistribution and use in source and binary forms, with or without modification,
   are permitted provided that the following conditions are met:

   * Redistributions of source code must retain the above copyright notice, this
     list of conditions and the following disclaimer.

   * Redistributions in binary form must reproduce the above copyright notice, this
     list of conditions and the following disclaimer in the documentation and/or
     other materials provided with the distribution.

   THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
   ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
   WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
   DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR
   ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
   (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
   LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
   ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
   (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
   SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
*/
/*!
   Copyright 2022 Ron Buckton

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
*/
/*! Hammer.JS - v2.0.7 - 2016-04-22
 * http://hammerjs.github.io/
 *
 * Copyright (c) 2016 Jorik Tangelder;
 * Licensed under the MIT license */
/*! The following comments were added due to code inlined from "@esfx/internal-binarysearch": */
/*! The following comments were added due to code inlined from "@esfx/internal-collections-hash": */
